<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exen-E | Videos</title>

    <meta property="og:title" content="exen-E | Galer√≠a de Videos" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://files.catbox.moe/4ubhtv.jpg" />
    <meta property="og:image:alt" content="Logo de exen-E Galer√≠a de Videos" />

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --accent: #f97316; /* orange-500 */
            --accent-neon: #fb923c; /* orange-400 */
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212; /* Negro m√°s oscuro */
            background-image: radial-gradient(circle at 15% 50%, rgba(251, 146, 60, 0.1), transparent 40%),
                              radial-gradient(circle at 85% 30%, rgba(249, 115, 22, 0.1), transparent 40%);
            color: #f3f4f6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        header {
            border-bottom: 1px solid rgba(251, 146, 60, 0.2);
            box-shadow: 0 5px 20px rgba(249, 115, 22, 0.05);
        }

        .nav-link {
            background-color: transparent;
            border: 2px solid transparent;
        }
        .nav-link:hover {
            background-color: rgba(251, 146, 60, 0.1);
            color: #fff;
        }
        .nav-link-active {
            background-color: var(--accent);
            color: #fff !important;
            box-shadow: 0 0 15px rgba(251, 146, 60, 0.4);
        }

        main h3 {
            font-weight: 900; letter-spacing: 0.025em;
            background: linear-gradient(90deg, var(--accent-neon), var(--accent) 80%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; text-fill-color: transparent;
            position: relative; padding-bottom: 0.75rem;
        }
        main h3 i { -webkit-text-fill-color: var(--accent-neon); text-shadow: 0 0 8px var(--accent-neon); }
        main h3::after {
            content: ''; position: absolute; bottom: 0; left: 50%;
            transform: translateX(-50%); width: 60px; height: 3px;
            background: var(--accent); border-radius: 2px; box-shadow: 0 0 10px var(--accent-neon);
        }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .skeleton {
            background-color: #374151;
            background-image: linear-gradient(to right, #374151 0%, #4b5563 20%, #374151 40%, #374151 100%);
            background-repeat: no-repeat; background-size: 2000px 100%;
            animation: shimmer 1.5s linear infinite; border-radius: 0.75rem;
        }
        .skeleton-video { aspect-ratio: 16 / 9; }
        @keyframes loadItem { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .video-item-animation { animation: loadItem 0.5s ease-out forwards; }

        #video-player-container {
            position: relative; width: 100%; padding-bottom: 56.25%;
            height: 0; background-color: #000; border-radius: 0.75rem; overflow: hidden;
        }
        #video-player-container iframe,
        #video-player-container video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-neon); }

        #scrollToTopBtn {
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
            opacity: 0; visibility: hidden; transform: translateY(20px);
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
        }
        #scrollToTopBtn.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        @keyframes punch { 0% { opacity: 1; transform: translate(-50%,-50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%,-50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%,-50%) scale(1.5); } }
        .punch-animation { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 5rem; text-shadow: 0 4px 15px rgba(0,0,0,0.4); animation: punch 0.5s ease-out forwards; pointer-events: none; z-index: 50; }
    </style>
</head>
<body class="antialiased">

    <header class="sticky top-0 z-[100] bg-gray-900/80 p-4 backdrop-blur-lg">
        <div class="container mx-auto flex items-center justify-between">
            <div class="w-1/3"></div>
            <nav class="w-1/3 flex justify-center">
                <ul class="flex items-center gap-2 sm:gap-4 text-sm sm:text-base">
                    <li>
                        <a href="index.html" id="nav-index" class="nav-link font-semibold text-gray-300 transition-all duration-300 px-4 py-2 rounded-lg">
                           Galer√≠a
                        </a>
                    </li>
                    <li>
                        <a href="videos.html" id="nav-videos" class="nav-link font-semibold text-gray-300 transition-all duration-300 px-4 py-2 rounded-lg">
                           Videos
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="w-1/3 flex justify-end">
                <a href="index.html">
                    <img src="https://files.catbox.moe/ap1lh0.png" alt="exen-E Logo" class="h-12 w-auto transition-transform duration-300 hover:scale-105">
                </a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-2 sm:px-4">

        <div class="my-8 text-center">
            <h3 class="inline-block text-3xl md:text-4xl font-extrabold tracking-tight"><i class="fas fa-film"></i> Galer√≠a de Videos</h3>
        </div>

        <section id="youtube-search-section" class="mb-8">
            <form id="youtube-search-form" class="flex justify-center">
                <div class="relative w-full max-w-xl">
                    <input type="text" id="youtube-search-input" placeholder="Buscar videos de YouTube en el canal de exen-E..." class="w-full rounded-full border-2 border-gray-700 bg-gray-800 py-3 pl-5 pr-12 text-white transition placeholder:text-gray-500 focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500/50">
                    <button type="submit" class="absolute inset-y-0 right-0 flex items-center justify-center w-12 text-gray-400 hover:text-orange-500 transition-colors" aria-label="Buscar videos de YouTube">
                        <i class="fas fa-search text-xl"></i>
                    </button>
                </div>
            </form>
            <div id="youtube-search-results" class="mt-8 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-8"></div>
            <div id="youtube-search-loader" class="py-12" style="display: none;"><div class="skeleton skeleton-video"></div></div>
            <div id="youtube-load-more-trigger" class="h-10"></div>
        </section>

        <section id="video-gallery">
            <div id="error-message" class="rounded-lg bg-red-900/50 p-4 text-center text-red-300" style="display: none;"></div>
            <div id="video-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-8"></div>
            <div id="loader" class="py-12" style="display: none;"><div class="skeleton skeleton-video"></div></div>
            <div id="load-more-trigger" class="h-10"></div>
        </section>
    </main>

    <div id="modal" class="fixed inset-0 z-[1000] bg-gray-950/90 backdrop-blur-md" style="display: none;">
        <div id="modal-content" class="h-full w-full overflow-y-auto">
            <div class="container mx-auto flex max-w-4xl flex-col gap-4 p-2 sm:p-4">
                <header id="modal-header" class="flex items-center justify-between">
                    <h2 id="title" class="bg-gradient-to-r from-orange-400 to-orange-500 bg-clip-text text-2xl sm:text-4xl font-black text-transparent"></h2>
                    <button id="close-modal" class="flex h-12 w-12 items-center justify-center rounded-full bg-gray-800/80 text-gray-400 transition hover:bg-gray-700 hover:text-white hover:rotate-90">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </header>

                <div id="video-player-container"></div>

                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div id="reaction-counts-container" class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2 rounded-full bg-gray-800/80 px-4 py-2 text-lg"></div>
                    <div class="flex items-center gap-2">
                         <span class="reaction-btn cursor-pointer text-3xl transition hover:scale-125" data-type="like">‚ù§Ô∏è</span>
                         <span class="reaction-btn cursor-pointer text-3xl transition hover:scale-125" data-type="hot">üî•</span>
                         <span class="reaction-btn cursor-pointer text-3xl transition hover:scale-125" data-type="wow">üòØ</span>
                         <span class="reaction-btn cursor-pointer text-3xl transition hover:scale-125" data-type="laugh">üòÇ</span>
                    </div>
                </div>

                <p id="desc" class="rounded-xl border-2 border-orange-500/30 bg-gray-800/50 p-4 text-gray-300"></p>

                <section id="comments-section" class="mt-4 w-full">
                    <form id="comment-form" class="mb-6 flex flex-col gap-3 rounded-xl bg-gray-800/50 p-4 sm:flex-row">
                        <input type="text" id="name-input" placeholder="Nombre (opcional)" class="w-full rounded-lg border-2 border-gray-700 bg-gray-900 px-4 py-2 text-white transition focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500/50 sm:w-1/4">
                        <input type="text" id="comment-input" placeholder="Escribe un comentario..." class="flex-grow rounded-lg border-2 border-gray-700 bg-gray-900 px-4 py-2 text-white transition focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500/50">
                        <button type="submit" id="comment-btn" class="group flex-shrink-0 rounded-lg bg-orange-600 px-5 py-2 font-semibold text-white transition hover:bg-orange-500">
                            <i class="fas fa-paper-plane transition group-hover:rotate-12"></i> Enviar
                        </button>
                    </form>
                    <div id="comments" class="flex flex-col gap-4"></div>
                </section>
            </div>
        </div>
    </div>

    <button id="scrollToTopBtn" title="Ir arriba" class="h-12 w-12 rounded-full bg-orange-600/80 text-white shadow-lg backdrop-blur-sm transition hover:bg-orange-500 hover:scale-110">
        <i class="fas fa-arrow-up"></i>
    </button>

    <footer class="mt-12 py-8 text-center text-gray-500">
        <p class="mt-2 text-sm">&copy; 2025 exen-E. Todos los derechos reservados.</p>
    </footer>

    <script>
        "use strict";
        const firebaseConfig = {
            apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8",
            authDomain: "exene-53e6b.firebaseapp.com",
            databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com",
            projectId: "exene-53e6b",
            storageBucket: "exene-53e6b.appspot.com",
            messagingSenderId: "481369419867",
            appId: "1:481369419867:web:ac5db24c436344262c8f7e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        firebase.auth().signInAnonymously().catch(error => console.error('Error en autenticaci√≥n an√≥nima:', error));

        const videosPerLoad = 12;
        let allVideos = [];
        let lastVideoTimestamp = null;
        let lastVideoKey = null;
        let isLoading = false;
        let noMoreVideos = false;
        let currentVideoId = '';
        let deviceID = localStorage.getItem('deviceID');
        if (!deviceID) {
            deviceID = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            localStorage.setItem('deviceID', deviceID);
        }

        const YOUTUBE_API_KEY = "AIzaSyDzzUPT_wjVxjeI7F4xBq0XFjSxzTv90hI";
        const YOUTUBE_CHANNEL_ID = "UCSyib0gZBbepb9wZ7PPfP9A";
        let youtubeNextPageToken = null;
        let youtubeIsLoading = false;
        let youtubeNoMoreVideos = false;
        let youtubeSearchQuery = '';

        function setActiveNavLink() {
            const path = window.location.pathname.split("/").pop();
            const galleryLink = document.getElementById('nav-index');
            const videosLink = document.getElementById('nav-videos');
            if (!galleryLink || !videosLink) return;
            galleryLink.classList.remove('nav-link-active');
            videosLink.classList.remove('nav-link-active');
            if (path === 'index.html' || path === '' || path.startsWith('index.html')) {
                galleryLink.classList.add('nav-link-active');
            } else if (path === 'videos.html' || path.startsWith('videos.html')) {
                videosLink.classList.add('nav-link-active');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const videoIdFromUrl = urlParams.get('id');
            if (videoIdFromUrl) { openModal(videoIdFromUrl); }
            loadInitialVideos();
            setupIntersectionObserver();
            setupEventListeners();
            setActiveNavLink();
        });

        function generateSkeletons(container, count, isVideo = true) {
            container.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const skeleton = document.createElement('div');
                let classList = 'w-full';
                if (isVideo) { classList += ' skeleton skeleton-video mb-2'; } else { classList += ' skeleton'; }
                skeleton.innerHTML = `<div class="${classList}"></div><div class="h-5 w-3/4 skeleton mt-2"></div>`;
                container.appendChild(skeleton);
            }
        }

        function loadInitialVideos(query = '') {
            if (isLoading) return;
            isLoading = true;
            const grid = document.getElementById('video-grid');
            generateSkeletons(grid, videosPerLoad);
            db.ref('videos').orderByChild('timestamp').limitToLast(videosPerLoad).once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    showError('No se encontraron videos. Agrega contenido desde el panel de administraci√≥n.');
                    grid.innerHTML = ''; isLoading = false; noMoreVideos = true; return;
                }
                const videos = [];
                snapshot.forEach(child => { videos.push({ id: child.key, ...child.val() }); });
                if (videos.length > 0) { lastVideoTimestamp = videos[0].timestamp; lastVideoKey = videos[0].id; }
                videos.reverse();
                allVideos = videos;
                displayVideos(allVideos, 'video-grid');
                isLoading = false;
            }).catch(error => { showError('Error al conectar con Firebase: ' + error.message); grid.innerHTML = ''; isLoading = false; });
        }

        function loadMoreVideos() {
            if (isLoading || noMoreVideos) return;
            isLoading = true;
            const loaderContainer = document.getElementById('loader');
            loaderContainer.style.display = 'block';
            generateSkeletons(loaderContainer, 4);
            db.ref('videos').orderByChild('timestamp').endBefore(lastVideoTimestamp, lastVideoKey).limitToLast(videosPerLoad).once('value').then(snapshot => {
                loaderContainer.style.display = 'none';
                if (!snapshot.exists() || snapshot.numChildren() === 0) { noMoreVideos = true; isLoading = false; return; }
                const newVideos = [];
                snapshot.forEach(child => { newVideos.push({ id: child.key, ...child.val() }); });
                if (newVideos.length < videosPerLoad) { noMoreVideos = true; }
                if (newVideos.length > 0) {
                    lastVideoTimestamp = newVideos[0].timestamp;
                    lastVideoKey = newVideos[0].id;
                    newVideos.reverse();
                    allVideos = allVideos.concat(newVideos);
                    displayVideos(newVideos, 'video-grid', true);
                }
                isLoading = false;
            }).catch(error => { console.error("Error cargando m√°s videos:", error); isLoading = false; loaderContainer.style.display = 'none'; });
        }

        function displayVideos(videos, containerId, append = false) {
            const grid = document.getElementById(containerId);
            if (!append) grid.innerHTML = '';
            videos.forEach((video, index) => {
                if (!video || !video.thumbnailUrl || !video.title) return;
                const div = document.createElement('div');
                div.className = 'video-item-animation group cursor-pointer';
                div.style.animationDelay = `${(index * 0.05)}s`;
                div.setAttribute('onclick', `openModal('${video.id}')`);
                div.innerHTML = `
                    <div class="relative overflow-hidden rounded-xl shadow-lg transition-transform duration-300 group-hover:scale-105">
                        <img src="${video.thumbnailUrl}" alt="${video.title}" loading="lazy" class="w-full aspect-video object-cover" onerror="this.src='https://placehold.co/1280x720/1f2937/374151?text=Error'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i class="fas fa-play-circle text-5xl text-white/80 opacity-0 transition duration-300 group-hover:opacity-100 group-hover:scale-110"></i>
                        </div>
                        <div class="absolute bottom-2 right-2 flex items-center gap-1 rounded-full bg-black/50 px-2 py-1 text-xs text-white"><i class="fas fa-heart text-red-500"></i><span id="reaction-total-${video.id}">0</span></div>
                    </div>
                    <div class="mt-3">
                        <h4 class="font-bold text-white truncate">${video.title}</h4>
                        <p class="text-sm text-gray-400">Exen-E Channel</p>
                    </div>
                `;
                grid.appendChild(div);
                db.ref(`video_reactions/${video.id}`).once('value').then(snap => {
                    const reactionCountEl = document.getElementById(`reaction-total-${video.id}`);
                    if (reactionCountEl) reactionCountEl.textContent = snap.numChildren();
                });
            });
        }

        async function openModal(id) {
            let video = allVideos.find(v => v && v.id === id);
            if (!video) {
                const snapshot = await db.ref(`videos/${id}`).once('value');
                if(snapshot.exists()) video = { id: snapshot.key, ...snapshot.val() };
                else { console.error("Video no encontrado"); return; }
            }
            currentVideoId = id;
            document.getElementById('title').textContent = video.title;
            document.getElementById('desc').textContent = video.desc;
            const playerContainer = document.getElementById('video-player-container');
            playerContainer.innerHTML = '';
            if (video.type === 'youtube') {
                const youtubeId = getYoutubeId(video.url);
                if (youtubeId) { playerContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${youtubeId}?autoplay=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`; }
            } else if (video.type === 'mp4') {
                playerContainer.innerHTML = `<video src="${video.url}" controls autoplay playsinline></video>`;
            }
            loadReactions(id);
            loadComments(id);
            document.getElementById('scrollToTopBtn').classList.remove('visible');
            document.getElementById('modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => document.getElementById('modal-content').scrollTop = 0, 50);
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('video-player-container').innerHTML = '';
            currentVideoId = '';
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                document.getElementById('scrollToTopBtn').classList.add('visible');
            }
        }

        function setupEventListeners() {
            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.addEventListener('keydown', e => { if (document.getElementById('modal').style.display === 'block' && e.key === 'Escape') { closeModal(); } });
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');
            window.addEventListener('scroll', () => { (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) ? scrollToTopBtn.classList.add('visible') : scrollToTopBtn.classList.remove('visible'); });
            scrollToTopBtn.addEventListener('click', () => window.scrollTo({top: 0, behavior: 'smooth'}));
             document.querySelectorAll('.reaction-btn').forEach(reaction => {
                reaction.addEventListener('click', e => {
                    e.stopPropagation(); if (!currentVideoId) return;
                    const type = e.currentTarget.dataset.type;
                    animateReactionOnPlayer(type);
                    const reactionsRef = db.ref(`video_reactions/${currentVideoId}/${deviceID}`);
                    reactionsRef.once('value', snap => { (snap.val() === type) ? reactionsRef.remove() : reactionsRef.set(type); });
                });
            });
            document.getElementById('comment-form').addEventListener('submit', e => {
                e.preventDefault();
                const name = document.getElementById('name-input').value.trim();
                const comment = document.getElementById('comment-input').value.trim();
                if (!comment || !currentVideoId) return;
                const commentData = { name: name || 'An√≥nimo', text: comment, timestamp: Date.now() };
                db.ref(`video_comments/${currentVideoId}`).push(commentData).then(() => document.getElementById('comment-input').value = '');
            });
            document.getElementById('youtube-search-form').addEventListener('submit', e => {
                e.preventDefault();
                youtubeSearchQuery = document.getElementById('youtube-search-input').value.trim();
                youtubeNextPageToken = null; youtubeNoMoreVideos = false;
                searchYouTubeVideos(youtubeSearchQuery, true);
            });
        }

        function setupIntersectionObserver() {
            const trigger = document.getElementById('load-more-trigger');
            const observer = new IntersectionObserver((entries) => { if (entries[0].isIntersecting) { loadMoreVideos(); } }, { rootMargin: '0px 0px 500px 0px' });
            observer.observe(trigger);
            const youtubeTrigger = document.getElementById('youtube-load-more-trigger');
            const youtubeObserver = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && youtubeSearchQuery && !youtubeNoMoreVideos) { searchYouTubeVideos(youtubeSearchQuery, false); }
            }, { rootMargin: '0px 0px 500px 0px' });
            youtubeObserver.observe(youtubeTrigger);
        }

        function getYoutubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function loadReactions(id) {
            db.ref(`video_reactions/${id}`).on('value', snap => {
                const reactions = snap.val() || {};
                const counts = { hot: 0, like: 0, wow: 0, laugh: 0 };
                Object.values(reactions).forEach(type => { if(counts[type] !== undefined) counts[type]++; });
                document.getElementById('reaction-counts-container').innerHTML = Object.entries(counts).map(([type, count]) => `<span class="flex items-center gap-1">${{like:'‚ù§Ô∏è',hot:'üî•',wow:'üòØ',laugh:'üòÇ'}[type]} <span class="font-bold">${count}</span></span>`).join('');
                const total = snap.numChildren();
                const mainGridEl = document.getElementById(`reaction-total-${id}`);
                if (mainGridEl) mainGridEl.textContent = total;
            });
        }

        function loadComments(id) {
             db.ref(`video_comments/${id}`).orderByChild('timestamp').on('value', snap => {
                const commentsContainer = document.getElementById('comments');
                commentsContainer.innerHTML = !snap.exists() ? '<p class="text-center text-gray-500">A√∫n no hay comentarios. ¬°S√© el primero!</p>' : '';
                const comments = []; snap.forEach(child => { comments.push(child.val()); });
                comments.reverse().forEach(comment => {
                    const div = document.createElement('div');
                    const initial = comment.name ? comment.name.charAt(0).toUpperCase() : 'A';
                    const avatarBg = 'bg-gradient-to-br from-orange-500 to-orange-400 text-white';
                    div.innerHTML = `
                        <div class="flex gap-3">
                            <div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full ${avatarBg} font-bold">${initial}</div>
                            <div class="flex-grow min-w-0">
                                <div class="rounded-lg rounded-tl-none bg-gray-800 p-3">
                                    <p class="font-bold text-orange-400">${comment.name || 'An√≥nimo'}</p>
                                    <p class="text-gray-300 whitespace-pre-wrap break-words">${comment.text || ''}</p>
                                </div>
                                <small class="pl-2 pt-1 text-xs text-gray-500">${new Date(comment.timestamp).toLocaleString()}</small>
                            </div>
                        </div>`;
                    commentsContainer.appendChild(div);
                });
            });
        }

        function animateReactionOnPlayer(type) {
            const icons = { hot: 'üî•', like: '‚ù§Ô∏è', wow: 'üòØ', laugh: 'üòÇ' };
            const icon = icons[type]; if (!icon) return;
            const container = document.getElementById('video-player-container');
            const existingAnimation = container.querySelector('.punch-animation');
            if (existingAnimation) existingAnimation.remove();
            const animationEl = document.createElement('div');
            animationEl.className = 'punch-animation'; animationEl.textContent = icon;
            container.appendChild(animationEl);
            setTimeout(() => animationEl.remove(), 500);
        }

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message; errorEl.style.display = 'block';
        }

        async function searchYouTubeVideos(query, isNewSearch = true) {
            if (!YOUTUBE_API_KEY || YOUTUBE_API_KEY === "YOUR_YOUTUBE_API_KEY") {
                console.warn("API Key de YouTube no configurada.");
                document.getElementById('youtube-search-results').innerHTML = '<p class="text-center text-red-400 col-span-full">Por favor, configura tu API Key de YouTube para habilitar la b√∫squeda.</p>';
                return;
            }
            if (youtubeIsLoading) return;
            youtubeIsLoading = true;
            const youtubeResultsContainer = document.getElementById('youtube-search-results');
            const youtubeLoader = document.getElementById('youtube-search-loader');
            if (isNewSearch) {
                youtubeResultsContainer.innerHTML = ''; youtubeNoMoreVideos = false; youtubeNextPageToken = null;
                generateSkeletons(youtubeResultsContainer, 8);
            }
            youtubeLoader.style.display = 'block';
            let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${YOUTUBE_CHANNEL_ID}&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}&maxResults=8`;
            if (youtubeNextPageToken) { url += `&pageToken=${youtubeNextPageToken}`; }
            try {
                const response = await fetch(url);
                const data = await response.json();
                youtubeLoader.style.display = 'none';
                if (data.items && data.items.length > 0) {
                    const videos = data.items.map(item => ({ id: item.id.videoId, title: item.snippet.title, thumbnailUrl: item.snippet.thumbnails.high.url, url: `https://www.youtube.com/watch?v=${item.id.videoId}`, type: 'youtube' }));
                    displayYouTubeVideos(videos, youtubeResultsContainer, !isNewSearch);
                    youtubeNextPageToken = data.nextPageToken;
                    if (!data.nextPageToken) youtubeNoMoreVideos = true;
                } else {
                    if (isNewSearch) youtubeResultsContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">No se encontraron videos de YouTube para esta b√∫squeda.</p>';
                    youtubeNoMoreVideos = true;
                }
            } catch (error) {
                console.error("Error al buscar videos de YouTube:", error);
                youtubeResultsContainer.innerHTML = '<p class="text-center text-red-400 col-span-full">Error al cargar videos de YouTube.</p>';
            } finally {
                youtubeIsLoading = false;
                youtubeLoader.style.display = 'none';
            }
        }

        function displayYouTubeVideos(videos, container, append = false) {
            if (!append) container.innerHTML = '';
            videos.forEach((video, index) => {
                const div = document.createElement('div');
                div.className = 'video-item-animation group cursor-pointer';
                div.style.animationDelay = `${(index * 0.05)}s`;
                div.setAttribute('onclick', `openModalFromYouTubeSearch('${video.id}', '${video.title}', '${video.thumbnailUrl}', '${video.url}')`);
                div.innerHTML = `
                    <div class="relative overflow-hidden rounded-xl shadow-lg transition-transform duration-300 group-hover:scale-105">
                        <img src="${video.thumbnailUrl}" alt="${video.title}" loading="lazy" class="w-full aspect-video object-cover" onerror="this.src='https://placehold.co/1280x720/1f2937/374151?text=Error'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i class="fas fa-play-circle text-5xl text-white/80 opacity-0 transition duration-300 group-hover:opacity-100 group-hover:scale-110"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h4 class="font-bold text-white truncate">${video.title}</h4>
                        <p class="text-sm text-gray-400">YouTube Channel</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function openModalFromYouTubeSearch(videoId, title, thumbnailUrl, videoUrl) {
            currentVideoId = videoId;
            document.getElementById('title').textContent = title;
            document.getElementById('desc').textContent = 'Video de YouTube.';
            const playerContainer = document.getElementById('video-player-container');
            playerContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            document.getElementById('reaction-counts-container').innerHTML = '';
            document.getElementById('comments').innerHTML = '<p class="text-center text-gray-500">Los comentarios y reacciones no est√°n disponibles para videos externos de YouTube.</p>';
            document.getElementById('scrollToTopBtn').classList.remove('visible');
            document.getElementById('modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => document.getElementById('modal-content').scrollTop = 0, 50);
        }
    </script>
</body>
</html>

