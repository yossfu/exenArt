<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>exen-E | Comunidad</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --accent: #f97316; 
            --accent-hover: #ea580c;
            --accent-light: #ff8c42; 
            --accent-gradient-start: #f97316; 
            --accent-gradient-end: #ea580c;
            --bg-dark: #09090b;
            --bg-card: #121214;
            --border-color: rgba(255, 255, 255, 0.08);
            --body-font: 'Inter', sans-serif;
            --heading-font: 'Poppins', sans-serif;
        }

        html, body {
            overflow-x: hidden; width: 100%; background-color: var(--bg-dark);
            overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent;
        }
        body { 
            font-family: var(--body-font); 
            background-image: radial-gradient(circle at 50% 0%, rgba(249, 115, 22, 0.06) 0%, transparent 50%), 
                              url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIj48ZmlsdGVyIGlkPSJhIj48ZmVDb2xvck1hdHJpeCBpbiA9ICJTb3VyY2VHcmFwaGljIiB0eXBlPSJtYXRyaXgiIHZhbHVlcz0iLjMzMzMgLjMzMzMgLjMzMzMgMCAwIC4zMzMzIC4zMzMzIC4zMzMzIDAgMCAuMzMzMyAuMzMzMyAuMzMzMyAwIDAgMCAwIDAgMSAwIi8+PGZlQ29sb3JNYXRyaXggaW4gPSAiU291cmNlR3JhcGhpYyIgdHlwZT0ibWF0cml4IiB2YWx1ZXM9IjAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIC4wNSAwIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIGZpbGw9IiMwOTAwMGIiLz48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0idXJsKCNncmFkKSIvPjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSJ1cmwoI25vaXNlKSIvPjwvc3ZnPg==');
            background-size: cover, 100px 100px; 
            background-blend-mode: overlay;
            color: #f3f4f6; padding-bottom: 90px; min-height: 100vh;
        }

        /* Scrollbars */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Similar Slider Styles */
        .similar-card {
            min-width: 90px; width: 90px; aspect-ratio: 1/1;
            border-radius: 0.5rem; overflow: hidden; position: relative;
            flex-shrink: 0; scroll-snap-align: start;
            border: 1px solid rgba(255,255,255,0.1); 
            transition: transform 0.2s ease-out, border-color 0.2s ease-out, box-shadow 0.2s ease-out;
            background-color: #1a1a1c;
        }
        .similar-card:hover { transform: scale(1.03); border-color: var(--accent-light); box-shadow: 0 0 15px rgba(249, 115, 22, 0.3); }
        .similar-card:active { transform: scale(0.95); border-color: var(--accent); box-shadow: 0 0 5px rgba(249, 115, 22, 0.2); }
        .similar-card img { width: 100%; height: 100%; object-fit: cover; }

        /* Loaders */
        #initial-loader { position: fixed; inset: 0; z-index: 10000; background-color: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .loader-logo { width: 80px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 15px rgba(249, 115, 22, 0.4)); animation: pulse 2s infinite cubic-bezier(0.4, 0, 0.6, 1); box-shadow: 0 0 20px rgba(249, 115, 22, 0.3); border-radius: 50%; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; box-shadow: 0 0 20px rgba(249, 115, 22, 0.3); } 50% { transform: scale(1.08); opacity: 0.85; box-shadow: 0 0 35px rgba(249, 115, 22, 0.6); } }
        
        .feed-card { background-color: #18181b; border: 1px solid var(--border-color); border-radius: 1rem; margin-bottom: 1.5rem; position: relative; width: 100%; box-shadow: 0 6px 25px rgba(0,0,0,0.3), 0 2px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .feed-card:hover { transform: translateY(-3px); box-shadow: 0 10px 35px rgba(0,0,0,0.4), 0 4px 12px rgba(0,0,0,0.2); }
        .upload-card { overflow: visible !important; background: linear-gradient(145deg, var(--bg-card), #0f0f10); border: 1px solid rgba(249, 115, 22, 0.15); z-index: 50; box-shadow: 0 8px 30px rgba(249, 115, 22, 0.15); }
        
        .animate-enter { animation: slideUpFade 0.3s ease-out forwards; } 
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* Upload Area */
        #extra-fields { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease; }
        #extra-fields.expanded { max-height: 1000px; opacity: 1; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); overflow: visible !important; }
        .custom-input { background: rgba(0,0,0,0.25); border: 1px solid var(--border-color); color: white; padding: 12px 14px; border-radius: 10px; font-size: 0.95rem; width: 100%; transition: all 0.3s; box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); }
        .custom-input:focus { outline: none; border-color: var(--accent); background: rgba(0,0,0,0.4); box-shadow: inset 0 1px 3px rgba(0,0,0,0.4), 0 0 0 2px rgba(249, 115, 22, 0.3); }

        /* Dropdowns */
        .custom-select-container { position: relative; width: 100%; }
        .custom-select-trigger { background: rgba(0, 0, 0, 0.25); border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 12px 14px; border-radius: 10px; color: #9ca3af; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; min-height: 44px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); }
        .custom-select-trigger:active, .custom-select-trigger.active { border-color: var(--accent); color: white; background: rgba(0,0,0,0.4); box-shadow: inset 0 1px 3px rgba(0,0,0,0.4), 0 0 0 2px rgba(249, 115, 22, 0.3); }
        .custom-select-options { position: absolute; top: calc(100% + 8px); left: 0; right: 0; background: #1c1c1f; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; z-index: 1000; max-height: 0; overflow: hidden; opacity: 0; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 20px 35px -5px rgba(0, 0, 0, 0.8); transform-origin: top center; transform: scaleY(0.95); }
        .custom-select-options.show { max-height: 300px; opacity: 1; overflow-y: auto; transform: scaleY(1); }
        .option-item { padding: 14px 16px; cursor: pointer; color: #d1d5db; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.03); display: flex; align-items: center; gap: 10px; }
        .option-item:active { background: rgba(249, 115, 22, 0.2); color: white; }
        .special-option { color: var(--accent); font-weight: 600; background: rgba(249, 115, 22, 0.05); }

        /* Filter Select */
        .filter-select .custom-select-trigger { background: rgba(9, 9, 11, 0.8); padding: 8px 12px; min-height: 36px; font-size: 0.8rem; border-radius: 8px; color: #d1d5db; }
        .filter-select .custom-select-trigger.active { border-color: var(--accent); color: var(--accent); }
        .filter-select .custom-select-options { top: calc(100% + 4px); }

        /* Suggestions */
        .suggestions-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: rgba(24, 24, 27, 0.95); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 10px 10px; z-index: 50; max-height: 200px; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); display: none; }
        .suggestions-dropdown.visible { display: block; animation: fadeIn 0.2s ease-out; }
        .suggestion-item { padding: 10px 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .suggestion-item:active { background: rgba(249, 115, 22, 0.1); }

        /* Grid & Layouts */
        .grid-mode-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; width: 100%; }
        .grid-item { aspect-ratio: 1/1; overflow: hidden; position: relative; background-color: #222; cursor: pointer; }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        .grid-item:hover img { transform: scale(1.05); opacity: 0.9; }
        .grid-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 50%); display: flex; align-items: flex-end; padding: 4px; opacity: 0; transition: opacity 0.3s ease-out; }
        .grid-item:hover .grid-overlay { opacity: 1; }

        /* Multi-Image */
        .multi-image-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; width: 100%; aspect-ratio: 3/1.3; margin-top: 0.5rem; border-radius: 0.5rem; overflow: hidden; }
        .multi-image-row img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: opacity 0.2s; }
        .multi-image-row img:active { opacity: 0.8; }
        .single-image-container { width: 100%; margin-top: 0.5rem; border-radius: 0.5rem; overflow: hidden; background: #000; display: flex; justify-content: center; }
        .single-image-container img { max-height: 500px; width: auto; max-width: 100%; object-fit: contain; }
        .two-image-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; margin-top: 0.5rem; border-radius: 0.5rem; overflow: hidden; aspect-ratio: 2/1; }
        .two-image-grid img { width: 100%; height: 100%; object-fit: cover; }

        /* Preview Stack */
        #preview-stack { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-top: 12px; margin-bottom: 8px; width: 100%; min-height: 0; }
        .preview-thumb { position: relative; width: 70px; height: 70px; flex-shrink: 0; border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); animation: fadeIn 0.3s ease; background-color: #222; }
        .preview-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .remove-thumb-btn { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; z-index: 10; backdrop-filter: blur(2px); }

        /* Navbar & Botones */
        .bottom-nav { background-color: rgba(9, 9, 11, 0.95); backdrop-filter: blur(16px); border-top: 1px solid var(--border-color); z-index: 3000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { color: #71717a; transition: all 0.3s ease-out; position: relative; }
        .nav-item.active { color: var(--accent); transform: translateY(-2px); }
        .nav-item:hover:not(.active) { color: #a1a1aa; transform: translateY(-1px); }
        .nav-item::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 0; height: 2px; background-color: var(--accent); transition: width 0.3s ease-out; }
        .nav-item.active::after, .nav-item:hover::after { width: 70%; }

        .toggle-btn { background: transparent; border: 1px solid #333; color: #666; transition: all 0.2s ease-out; }
        .toggle-btn.active { background: var(--accent); border-color: var(--accent); color: white; box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3); }
        .toggle-btn:hover:not(.active) { background: rgba(255,255,255,0.05); color: #999; }

        .notif-btn { position: relative; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: #ccc; transition: all 0.2s; }
        .notif-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .notif-badge { position: absolute; top: 0px; right: 0px; width: 10px; height: 10px; background-color: var(--accent); border-radius: 50%; border: 2px solid var(--bg-dark); box-shadow: 0 0 5px rgba(249, 115, 22, 0.8); animation: badgePulse 1.5s infinite ease-out; }
        @keyframes badgePulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        
        .notification-dropdown { position: fixed; top: 60px; right: 10px; left: 10px; max-width: 400px; margin: 0 auto; background: #1c1c1f; border: 1px solid var(--border-color); border-radius: 16px; z-index: 5000; box-shadow: 0 15px 50px rgba(0,0,0,0.9); max-height: 0; overflow: hidden; opacity: 0; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); transform-origin: top right; transform: scale(0.95); }
        .notification-dropdown.visible { max-height: 400px; opacity: 1; transform: scale(1); }
        
        .notif-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; cursor: pointer; transition: background 0.2s; background: transparent; }
        .notif-item.unread { background: rgba(249, 115, 22, 0.08); border-left: 3px solid var(--accent); }
        .notif-item.read { opacity: 0.7; }

        .follow-btn { padding: 4px 12px; border-radius: 99px; font-size: 11px; font-weight: 700; transition: all 0.2s; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid transparent; }
        .follow-btn.not-following { background: var(--accent); color: white; box-shadow: 0 2px 10px rgba(249, 115, 22, 0.3); }
        .follow-btn.following { background: transparent; border-color: #444; color: #888; }

        /* Visor */
        .modal-backdrop { display: none; position: fixed; inset: 0; background-color: #000; z-index: 7000; } 
        .modal-backdrop.visible { display: block; animation: fadeIn 0.3s ease-out forwards; }
        #modal-inner-container { transition: all 0.3s ease-out; }
        .fullscreen-mode .info-panel { display: none !important; }
        .fullscreen-mode .image-area { width: 100% !important; height: 100vh !important; flex: none !important; transition: all 0.3s ease-out; }
        .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); z-index: 20; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); border-radius: 50%; color: white; border: 1px solid rgba(255,255,255,0.15); cursor: pointer; transition: all 0.2s ease-out, background 0.2s ease-out; font-size: 1.2rem; }
        .nav-arrow:hover { background: rgba(0,0,0,0.7); transform: translateY(-50%) scale(1.05); }
        .nav-arrow:active { background: var(--accent); transform: translateY(-50%) scale(0.95); }
        .nav-prev { left: 15px; } .nav-next { right: 15px; }
        
        .options-menu { display: none; position: absolute; top: 40px; right: 10px; background: #1c1c1f; border: 1px solid #333; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.9); z-index: 50; min-width: 150px; }
        .options-menu.show { display: block; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .options-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: #ccc; font-size: 0.95rem; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .options-item:last-child { border-bottom: none; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        
        .like-anim { animation: likeBounce 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes likeBounce { 0% { transform: scale(1); } 30% { transform: scale(1.4); color: #ef4444; } 70% { transform: scale(0.9); } 100% { transform: scale(1); } }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); pointer-events: none; }

        button { transition: all 0.2s ease-out; }
        button:hover:not(.btn-disabled) { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        button:active:not(.btn-disabled) { transform: translateY(0); box-shadow: none; }
        #publish-btn { background: linear-gradient(to right, var(--accent-gradient-start), var(--accent-gradient-end)); box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4); transition: all 0.3s ease-out; }
        #publish-btn:hover:not(.btn-disabled) { transform: translateY(-2px) scale(1.01); box-shadow: 0 8px 20px rgba(249, 115, 22, 0.6); }
        #publish-btn:active:not(.btn-disabled) { transform: translateY(0) scale(0.98); box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3); }

        #scroll-spinner { animation: spinFadeIn 1s infinite linear; }
        @keyframes spinFadeIn { 0% { transform: rotate(0deg) scale(0.8); opacity: 0.7; } 50% { transform: rotate(180deg) scale(1.1); opacity: 1; } 100% { transform: rotate(360deg) scale(0.8); opacity: 0.7; } }

        #toast-container { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #custom-alert > div, #custom-confirm > div { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="antialiased select-none">

    <!-- LOADER -->
    <div id="initial-loader">
        <img src="https://files.catbox.moe/ap1lh0.png" class="loader-logo">
        <i class="fas fa-circle-notch fa-spin text-orange-500 text-3xl"></i>
        <p id="loader-status" class="text-gray-500 text-xs mt-4 animate-pulse">Cargando comunidad...</p>
    </div>

    <!-- TOAST -->
    <div id="toast-container" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[9000] pointer-events-none transition-all duration-300 opacity-0 translate-y-4">
        <div class="bg-zinc-900/95 backdrop-blur-md border border-zinc-700 px-6 py-3 rounded-full text-white font-medium shadow-2xl flex items-center gap-3">
            <i class="fas fa-check-circle text-green-500 text-lg"></i>
            <span id="toast-message">Acci√≥n completada</span>
        </div>
    </div>

    <!-- APP CONTENT -->
    <div id="app-content" style="display: none;">
        <!-- Header -->
        <header class="sticky top-0 z-[100] bg-[#09090b]/90 backdrop-blur-md border-b border-white/5 px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <img src="https://files.catbox.moe/ap1lh0.png" alt="Logo" class="h-8 w-auto">
                <span class="font-bold text-lg tracking-tight font-[Poppins] text-orange-500">Social</span>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="relative">
                    <button onclick="toggleNotifications()" class="notif-btn">
                        <i class="far fa-bell text-lg"></i>
                        <div id="notif-badge" class="notif-badge hidden"></div>
                    </button>
                    <div id="notification-dropdown" class="notification-dropdown custom-scrollbar">
                        <div class="p-3 border-b border-white/5 flex justify-between items-center bg-[#18181b]">
                            <span class="text-sm font-bold text-white">Notificaciones</span>
                            <span class="text-[10px] text-gray-500">Recientes</span>
                        </div>
                        <div id="notif-list" class="flex flex-col max-h-[300px] overflow-y-auto">
                            <div class="p-8 text-center text-gray-500 text-xs italic"><i class="fas fa-spinner fa-spin mr-2"></i> Cargando...</div>
                        </div>
                    </div>
                </div>

                <a href="profile.html" onclick="return requireLogin(event)" class="w-9 h-9 rounded-full overflow-hidden border border-zinc-600 block relative active:scale-90 transition">
                    <img id="current-user-avatar" src="https://placehold.co/100x100/333/fff?text=U" class="w-full h-full object-cover">
                </a>
            </div>
        </header>

        <main class="container mx-auto max-w-lg px-0 sm:px-4 py-2 overflow-x-hidden">
            
            <!-- UPLOAD CARD -->
            <div class="px-2 sm:px-0">
                <div class="feed-card upload-card p-4 rounded-2xl mb-4">
                    <div class="flex gap-3 items-center mb-2">
                        <div class="w-10 h-10 rounded-full overflow-hidden bg-zinc-700 flex-shrink-0 self-start mt-1 border border-zinc-600">
                            <img id="post-avatar" src="https://placehold.co/100x100/333/fff?text=U" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 relative">
                            <textarea id="post-text" rows="1" maxlength="500" class="w-full bg-transparent text-white placeholder-gray-500 resize-none focus:outline-none text-sm py-2 min-h-[40px]" placeholder="¬øQu√© quieres compartir?" onfocus="if(requireLogin(event)) expandPostArea()" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                        </div>
                        <label class="flex items-center justify-center text-orange-500 cursor-pointer active:scale-90 transition p-2 rounded-full bg-zinc-800 hover:bg-zinc-700 border border-zinc-700" title="A√±adir imagen (Max 3)">
                            <i class="fas fa-image text-lg"></i>
                            <input type="file" id="file-input" accept="image/*" class="hidden" multiple onchange="if(requireLogin(event)) handleFileSelect(event)">
                        </label>
                    </div>
                    
                    <div id="preview-stack" style="display: none;"></div>
                    
                    <div id="extra-fields">
                        <div class="flex flex-col gap-3">
                            <input type="text" id="post-title" maxlength="30" placeholder="T√≠tulo (Opcional)" class="custom-input font-bold bg-black/20 border-zinc-700">
                            
                            <div class="relative w-full">
                                <input type="text" id="post-character" maxlength="30" placeholder="Nombre del personaje (Opcional)" class="custom-input bg-black/20 border-zinc-700" autocomplete="off">
                                <div id="character-suggestions" class="suggestions-dropdown custom-scrollbar"></div>
                            </div>
                            
                            <!-- Campo de Tags Generales (DeepDanbooru) -->
                            <div class="hidden"><input type="text" id="post-tags" placeholder="Auto-tagging..." readonly></div>
                            
                            <!-- NUEVO CAMPO: Descripci√≥n / Etiquetas Detalladas (WD Tagger) -->
                            <div class="hidden">
                                <input type="text" id="post-description" placeholder="Etiquetas detalladas (WD)..." class="custom-input bg-black/40 border-zinc-700 text-xs pl-8 tags-readonly" readonly>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row gap-3">
                                <div class="custom-select-container w-full" id="dropdown-category">
                                    <input type="hidden" id="post-category" value="">
                                    <button type="button" class="custom-select-trigger" onclick="toggleCustomSelect('dropdown-category')">
                                        <span id="display-category"><i class="fas fa-tag mr-2 text-xs text-orange-500"></i> Categor√≠a</span><i class="fas fa-chevron-down text-xs"></i>
                                    </button>
                                    <div class="custom-select-options custom-scrollbar">
                                        <div class="option-item" onclick="selectCustomOption('dropdown-category', 'anime', 'Anime')">Anime</div>
                                        <div class="option-item" onclick="selectCustomOption('dropdown-category', 'furry', 'Furry')">Furry</div>
                                        <div class="option-item" onclick="selectCustomOption('dropdown-category', 'realismo', 'Realismo')">Realismo</div>
                                        <div class="option-item" onclick="selectCustomOption('dropdown-category', 'mecas', 'Mecas')">Mecas</div>
                                        <div class="option-item" onclick="selectCustomOption('dropdown-category', 'devils', 'Devils')">Devils</div>
                                        <div class="option-item" onclick="selectCustomOption('dropdown-category', 'colors', 'ColorFull')">ColorFull</div>
                                        <div class="option-item" onclick="selectCustomOption('dropdown-category', 'amateur', 'Amateur')">Amateur</div>
                                        <div class="option-item" onclick="selectCustomOption('dropdown-category', 'tvgames', 'TV/Games')">TV/Games</div>
                                    </div>
                                </div>
                                <div class="custom-select-container w-full" id="dropdown-collection">
                                    <input type="hidden" id="post-collection" value="">
                                    <button type="button" class="custom-select-trigger" onclick="toggleCustomSelect('dropdown-collection')">
                                        <span id="display-collection"><i class="fas fa-folder mr-2 text-xs text-orange-500"></i> √Ålbum</span><i class="fas fa-chevron-down text-xs"></i>
                                    </button>
                                    <div id="collection-options-list" class="custom-select-options custom-scrollbar"></div>
                                </div>
                            </div>
                            
                            <div id="new-collection-container" class="hidden animate-enter">
                                <input type="text" id="new-collection-name" maxlength="15" placeholder="Nombre de la nueva colecci√≥n..." class="custom-input bg-orange-900/10 border-orange-500/30 text-sm">
                            </div>
                            
                            <div class="flex gap-3 mt-2 pt-3 border-t border-white/5">
                                <button onclick="collapsePostArea()" class="flex-1 py-3 rounded-xl text-gray-400 text-sm font-semibold hover:bg-zinc-800 transition active:scale-95">Cancelar</button>
                                <button id="publish-btn" onclick="uploadPost()" class="bg-gradient-to-r from-orange-600 to-orange-500 text-white px-6 py-3 rounded-xl text-sm font-bold shadow-lg active:scale-95 transition flex-[2]">Publicar</button>
                            </div>
                        </div>
                    </div>
                    <div id="upload-progress" class="hidden w-full bg-zinc-800 rounded-full h-1 mt-3 overflow-hidden"><div class="bg-orange-500 h-1 rounded-full w-1/3 animate-pulse"></div></div>
                </div>
            </div>

            <!-- FILTRO -->
            <div id="filter-bar" class="px-2 sm:px-0 mb-4 hidden animate-fade-in">
                <div class="bg-orange-900/20 border border-orange-500/30 rounded-xl p-3 flex justify-between items-center">
                    <span class="text-xs text-orange-200 font-bold flex items-center gap-2"><i class="fas fa-filter"></i> Filtrando: <span id="active-filter-tag" class="bg-orange-500 text-white px-2 py-0.5 rounded">#tag</span></span>
                    <button onclick="clearTagFilter()" class="text-xs text-gray-400 hover:text-white underline">Borrar</button>
                </div>
            </div>

            <!-- CONTROLES -->
            <div class="flex justify-between items-center gap-2 mb-4 px-2 sm:px-0">
                <div class="flex bg-zinc-900/80 p-1 rounded-xl border border-zinc-800">
                    <button onclick="switchView('feed')" id="btn-view-feed" class="toggle-btn active px-3 py-1.5 rounded-lg text-xs font-semibold flex items-center gap-2"><i class="fas fa-stream"></i></button>
                    <button onclick="switchView('grid')" id="btn-view-grid" class="toggle-btn px-3 py-1.5 rounded-lg text-xs font-semibold flex items-center gap-2"><i class="fas fa-th"></i></button>
                </div>
                
                <div class="relative w-40 filter-select">
                    <div class="custom-select-container" id="dropdown-sort">
                        <button type="button" class="custom-select-trigger" onclick="toggleCustomSelect('dropdown-sort')">
                            <span id="display-sort">‚ú® Recientes</span>
                            <i class="fas fa-chevron-down text-[10px] ml-2"></i>
                        </button>
                        <div class="custom-select-options custom-scrollbar">
                            <div class="option-item" onclick="changeSortOrder('newest', '‚ú® Recientes')">‚ú® Recientes</div>
                            <div class="option-item" onclick="changeSortOrder('oldest', 'üìÖ Antiguos')">üìÖ Antiguos</div>
                            <div class="option-item" onclick="changeSortOrder('likes', 'üî• Populares')">üî• Populares</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FEED -->
            <div id="feed-list-container" class="flex flex-col gap-4 pb-10 px-2 sm:px-0 min-h-[300px]"></div>
            <div id="grid-view-container" class="grid-mode-container hidden pb-20 px-0"></div>
            
            <div id="load-more-trigger" class="h-16 w-full flex justify-center items-center my-4">
                <div id="scroll-spinner" class="flex flex-col items-center gap-2 opacity-0 transition-opacity duration-300"><i class="fas fa-circle-notch fa-spin text-orange-500 text-2xl"></i></div>
            </div>
        </main>

        <!-- VISOR -->
        <div id="modal" class="modal-backdrop overflow-hidden">
            <button id="close-modal" class="fixed top-4 right-4 z-[8000] h-10 w-10 flex items-center justify-center rounded-full bg-black/60 text-white backdrop-blur-md border border-white/10 active:scale-90 transition shadow-lg"><i class="fas fa-times text-lg"></i></button>
            <div id="modal-inner-container" class="w-full h-full flex flex-col lg:flex-row bg-black transition-all duration-300">
                <div class="image-area relative flex-1 bg-black flex items-center justify-center overflow-hidden h-[55vh] lg:h-full" id="modal-image-area">
                    <img id="modal-image" src="" class="max-w-full max-h-full object-contain w-auto h-auto transition-transform duration-300" alt="Visor">
                    <button id="modal-prev" class="nav-arrow nav-prev" onclick="navigateModal(-1)"><i class="fas fa-chevron-left"></i></button>
                    <button id="modal-next" class="nav-arrow nav-next" onclick="navigateModal(1)"><i class="fas fa-chevron-right"></i></button>
                    <button onclick="toggleFullScreen()" class="absolute bottom-6 right-6 z-20 bg-zinc-800/80 text-white p-2.5 rounded-xl backdrop-blur-md border border-white/10 active:scale-90 transition shadow-lg"><i class="fas fa-expand text-sm"></i></button>
                </div>
                <div class="info-panel w-full lg:w-[420px] lg:h-full bg-[#121214] border-l border-zinc-800 flex flex-col h-[45vh] z-30 relative shadow-[-10px_0_30px_rgba(0,0,0,0.5)]">
                    <div class="p-4 border-b border-zinc-800 flex items-center justify-between bg-[#18181b] flex-shrink-0">
                        <div class="flex items-center gap-3 cursor-pointer" onclick="visitProfileFromModal()">
                            <img id="modal-user-pic" src="" class="w-10 h-10 rounded-full object-cover border border-zinc-600 bg-zinc-700">
                            <div class="leading-tight"><h4 id="modal-user-name" class="font-bold text-white text-sm">Usuario</h4><span class="text-[10px] text-gray-500 font-medium">Autor</span></div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="modal-delete-btn" class="hidden text-red-400 hover:text-red-300 bg-red-500/10 hover:bg-red-500/20 w-9 h-9 flex items-center justify-center rounded-full active:scale-90 transition" title="Eliminar"><i class="fas fa-trash-alt text-sm"></i></button>
                            <button id="modal-like-btn" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-zinc-800 border border-zinc-700 active:scale-95 transition group"><i class="far fa-heart text-lg group-active:scale-125 transition-transform text-gray-400"></i><span id="modal-likes-count" class="text-xs font-bold text-white">0</span></button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-5 custom-scrollbar bg-[#121214]">
                        <div class="mb-5">
                            <h3 id="modal-title" class="text-xl font-bold text-white mb-2 font-[Poppins] leading-snug"></h3>
                            <div id="modal-character-tag" onclick="filterByCharacterFromModal()" class="hidden inline-flex items-center gap-1.5 bg-orange-500/10 border border-orange-500/20 text-orange-400 px-2.5 py-1 rounded-md text-[11px] font-bold uppercase tracking-wider mb-2 cursor-pointer hover:bg-orange-500/20 transition">
                                <i class="fas fa-user-tag text-[10px]"></i> <span id="modal-character-name"></span>
                            </div>
                            <p id="modal-desc" class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap font-light"></p>
                        </div>
                        
                        <div class="mb-8 border-b border-zinc-800 pb-5">
                            <button onclick="toggleTags()" id="tags-toggle-btn" class="text-[11px] font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2 hover:text-orange-500 transition-colors mb-2">
                                <span>Ver etiquetas</span> <i class="fas fa-chevron-down"></i>
                            </button>
                            <div id="modal-tags" class="hidden flex flex-wrap gap-2 mt-3"></div>
                        </div>

                        <div class="mb-6 border-b border-zinc-800 pb-4">
                            <h4 class="text-[11px] font-bold text-gray-500 uppercase mb-3 tracking-widest flex items-center gap-2"><i class="fas fa-th-large"></i> Similares</h4>
                            <div id="similar-grid" class="flex gap-3 overflow-x-auto pb-3 snap-x no-scrollbar"></div>
                        </div>

                        <div><h4 class="text-[11px] font-bold text-gray-500 uppercase mb-4 tracking-widest flex items-center gap-2"><i class="fas fa-comments"></i> Comentarios</h4><div id="modal-comments-list" class="flex flex-col gap-4 pb-4"></div></div>
                    </div>
                    <div class="p-3 bg-[#18181b] border-t border-zinc-800 flex-shrink-0 safe-bottom">
                        <form onsubmit="postCommentInModal(event)" class="flex gap-2 relative">
                            <input type="text" id="modal-comment-input" maxlength="200" class="w-full bg-zinc-900 border border-zinc-700 rounded-full pl-5 pr-12 py-3 text-sm text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="A√±ade un comentario..." autocomplete="off">
                            <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-orange-500 p-2 active:scale-90 transition"><i class="fas fa-paper-plane text-lg"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <nav class="bottom-nav fixed bottom-0 left-0 right-0 z-[100] flex h-[70px] justify-around items-center px-2 pb-2">
            <a href="index.html" class="nav-item flex flex-col items-center justify-center w-1/3 p-2 active:scale-95"><i class="fas fa-home text-xl mb-1.5"></i><span class="text-[10px] font-bold tracking-wide">Galer√≠a</span></a>
            <a href="feed.html" class="nav-item active flex flex-col items-center justify-center w-1/3 p-2 active:scale-95"><i class="fas fa-globe-americas text-xl mb-1.5"></i><span class="text-[10px] font-bold tracking-wide">Social</span></a>
            <a href="profile.html" onclick="return requireLogin(event)" class="nav-item flex flex-col items-center justify-center w-1/3 p-2 active:scale-95"><i class="fas fa-user text-xl mb-1.5"></i><span class="text-[10px] font-bold tracking-wide">Perfil</span></a>
        </nav>
    </div>

    <!-- ALERTAS -->
    <div id="custom-alert" class="hidden fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-[#18181b] border border-zinc-800 rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl">
            <div class="w-14 h-14 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4 border border-red-500/20"><i class="fas fa-exclamation text-red-500 text-2xl"></i></div>
            <h3 class="text-white font-bold text-xl mb-2">Atenci√≥n</h3>
            <p id="custom-alert-msg" class="text-gray-400 text-sm mb-6 leading-relaxed">Mensaje</p>
            <button onclick="closeCustomAlert()" class="w-full bg-zinc-800 hover:bg-zinc-700 text-white py-3.5 rounded-xl font-bold transition active:scale-95">Entendido</button>
        </div>
    </div>

    <div id="custom-confirm" class="hidden fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-[#18181b] border border-zinc-800 rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl">
            <div class="w-14 h-14 rounded-full bg-orange-500/10 flex items-center justify-center mx-auto mb-4 border border-orange-500/20"><i class="fas fa-question text-orange-500 text-2xl"></i></div>
            <h3 id="custom-confirm-title" class="text-white font-bold text-xl mb-2">¬øEst√°s seguro?</h3>
            <p id="custom-confirm-msg" class="text-gray-400 text-sm mb-6 leading-relaxed">¬øContinuar?</p>
            <div class="flex gap-3">
                <button onclick="closeCustomConfirm(false)" class="flex-1 bg-zinc-800 text-gray-300 py-3 rounded-xl font-bold border border-zinc-700 active:scale-95 transition">Cancelar</button>
                <button onclick="closeCustomConfirm(true)" class="flex-1 bg-orange-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT DE IA (ACTUALIZADO CON WD TAGGER) -->
    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/+esm";
        
        // Configuraci√≥n DeepDanbooru (Original)
        const TAGGER_CONFIG = { threshold: 0.5, useSpace: false, useEscape: true, keepConfidences: false, descend: true };
        
        // Configuraci√≥n WD Tagger (Nuevo)
        // El espacio suele usar: [imagen, umbral_general, umbral_personaje]
        const WD_CONFIG = { gen_threshold: 0.35, char_threshold: 1.85 };

        async function resizeImageForApi(file) {
            if (file.size <= 1024 * 1024) return file;
            return new Promise((resolve) => {
                const img = new Image(); const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX_SIZE = 800;
                img.onload = () => {
                    let w=img.width, h=img.height; if(w>h){if(w>MAX_SIZE){h*=MAX_SIZE/w;w=MAX_SIZE;}}else{if(h>MAX_SIZE){w*=MAX_SIZE/h;h=MAX_SIZE;}}
                    canvas.width=w;canvas.height=h; ctx.drawImage(img,0,0,w,h); canvas.toBlob(resolve,'image/jpeg',0.85);
                }; img.src = URL.createObjectURL(file);
            });
        }

        window.runAutoTagging = async function(originalFile) {
            const tagInput = document.getElementById('post-tags'); 
            const descInput = document.getElementById('post-description'); // Nuevo campo
            const publishBtn = document.getElementById('publish-btn');
            
            tagInput.value = ""; 
            descInput.value = "";
            publishBtn.disabled = true; publishBtn.classList.add('btn-disabled');
            publishBtn.innerHTML = '<i class="fas fa-cog fa-spin"></i> Analizando...';

            try {
                const processedFile = await resizeImageForApi(originalFile);

                // Ejecutamos ambos modelos en paralelo usando Promise.all
                const [resultDeep, resultWD] = await Promise.allSettled([
                    // Tagger 1: DeepDanbooru
                    Client.connect("Jossle/deepdanbooru_online_Exen").then(client => 
                        client.predict(0, [processedFile, TAGGER_CONFIG.threshold, TAGGER_CONFIG.useSpace, TAGGER_CONFIG.useEscape, TAGGER_CONFIG.keepConfidences, TAGGER_CONFIG.descend])
                    ),
                    // Tagger 2: SmilingWolf WD Tagger (v1.4 vit v2 es el est√°ndar para esto)
                    Client.connect("SmilingWolf/wd-v1-4-vit-tagger-v2").then(client => 
                        client.predict(0, [processedFile, WD_CONFIG.gen_threshold, WD_CONFIG.char_threshold])
                    )
                ]);

                // Procesar resultado DeepDanbooru (Tags simples)
                if (resultDeep.status === 'fulfilled' && resultDeep.value && resultDeep.value.data && resultDeep.value.data[0]) {
                    tagInput.value = resultDeep.value.data[0];
                }

                // Procesar resultado WD Tagger (Descriptivo/Detallado)
                if (resultWD.status === 'fulfilled' && resultWD.value && resultWD.value.data) {
                    const labelData = resultWD.value.data[0]; // Suele ser un objeto {tag: conf, tag2: conf}
                    if (labelData && typeof labelData === 'object') {
                        // Filtramos y ordenamos las etiquetas por confianza
                        const sortedTags = Object.entries(labelData)
                            .filter(([tag, conf]) => conf > WD_CONFIG.gen_threshold) // Filtrar por umbral
                            .sort((a, b) => b[1] - a[1]) // Ordenar descendente por confianza
                            .map(([tag, conf]) => tag.replaceAll('_', ' ')); // Reemplazar _ con espacios para que sea m√°s natural/descriptivo
                        
                        // Unimos para crear una "descripci√≥n" basada en tags
                        if (sortedTags.length > 0) {
                            descInput.value = sortedTags.join(", ");
                        }
                    }
                }

            } catch (error) {
                console.error("Error Tagging:", error); 
            } finally {
                publishBtn.disabled = false; 
                publishBtn.classList.remove('btn-disabled');
                publishBtn.innerHTML = 'Publicar';
            }
        }
    </script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8", authDomain: "exene-53e6b.firebaseapp.com", databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com", projectId: "exene-53e6b", storageBucket: "exene-53e6b.appspot.com", messagingSenderId: "481369419867", appId: "1:481369419867:web:ac5db24c436344262c8f7e" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const CATBOX_USERHASH = "341adb9d3c2d09d0485aa908c";

        let currentUser = null;
        let currentUserData = null;
        let selectedFiles = []; 
        let deviceID = localStorage.getItem('deviceID');
        if (!deviceID) { deviceID = Math.random().toString(36).substring(2) + Date.now().toString(36); localStorage.setItem('deviceID', deviceID); }

        let allPostsCache = [];
        let displayedPosts = [];
        let currentRenderIndex = 0;
        const POSTS_PER_PAGE = 10;
        let characterStatsCache = {};
        let followingCache = {};
        let currentViewPosts = [];
        let currentPostIndex = -1;
        let touchStartX = 0;
        let touchEndX = 0;
        let currentFilterTag = null;
        let currentFilterType = null;
        let currentSortOrder = 'newest';
        let confirmCallback = null;
        const userProfileCache = {};

        auth.onAuthStateChanged(user => {
            const loader = document.getElementById('initial-loader');
            if (user && !user.isAnonymous) {
                currentUser = user;
                document.getElementById('app-content').style.display = 'block'; 
                db.ref('users/' + user.uid).on('value', snap => { 
                    const d = snap.val(); if(d) {
                        currentUserData = d; 
                        if(d.profilePic) { document.getElementById('current-user-avatar').src = d.profilePic; document.getElementById('post-avatar').src = d.profilePic; }
                    }
                });
                db.ref('follows/' + user.uid).once('value', snap => {
                    followingCache = snap.val() || {};
                    initFeedOnce(); 
                });
                initNotificationSystem(user.uid);
                loadUserCollectionsSelect();
                initCharacterStatsListener();
                loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500);
            } else {
                window.location.href = 'login.html';
            }
        });

        function initNotificationSystem(uid) {
            const badge = document.getElementById('notif-badge');
            db.ref('notifications/' + uid).orderByKey().limitToLast(1).on('child_added', snap => {
                if(!snap.exists()) return;
                const lastNotif = snap.val();
                const lastSeenTimestamp = localStorage.getItem('lastSeenNotif_' + uid) || 0;
                if (lastNotif.timestamp > lastSeenTimestamp) badge.classList.remove('hidden'); else badge.classList.add('hidden');
            });
        }
        function toggleNotifications() {
            const dd = document.getElementById('notification-dropdown');
            const badge = document.getElementById('notif-badge');
            if (dd.classList.contains('visible')) { dd.classList.remove('visible'); } else { dd.classList.add('visible'); badge.classList.add('hidden'); if(currentUser) localStorage.setItem('lastSeenNotif_' + currentUser.uid, Date.now()); loadNotifications(); }
        }
        function loadNotifications() {
            const list = document.getElementById('notif-list');
            db.ref(`notifications/${currentUser.uid}`).orderByChild('timestamp').limitToLast(20).once('value', snap => {
                list.innerHTML = '';
                if (!snap.exists()) { list.innerHTML = '<div class="p-6 text-center text-gray-500 text-xs">No tienes notificaciones recientes.</div>'; return; }
                const notifs = []; snap.forEach(c => notifs.push({key: c.key, ...c.val()}));
                notifs.reverse().forEach(n => {
                    const item = document.createElement('div'); const isUnread = !n.read; item.className = `notif-item ${isUnread ? 'unread' : 'read'}`; item.id = `notif-item-${n.key}`;
                    let icon = 'fas fa-bell', text = 'Nueva interacci√≥n', linkFn = '';
                    if (n.type === 'like') { icon = 'fas fa-heart text-red-500'; text = `A <b>${n.fromUserName}</b> le gusta tu publicaci√≥n.`; linkFn = `openMainViewerById('${n.postId}')`; }
                    else if (n.type === 'comment') { icon = 'fas fa-comment text-blue-400'; text = `<b>${n.fromUserName}</b> coment√≥ tu publicaci√≥n.`; linkFn = `openMainViewerById('${n.postId}')`; }
                    else if (n.type === 'follow') { icon = 'fas fa-user-plus text-green-400'; text = `<b>${n.fromUserName}</b> empez√≥ a seguirte.`; linkFn = `goToProfile('${n.fromUserId}')`; }
                    item.innerHTML = `<div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center border border-zinc-700 flex-shrink-0"><i class="${icon}"></i></div><div class="flex-1 text-sm text-gray-300 leading-tight">${text} <br><span class="text-[10px] text-gray-500">${timeAgo(n.timestamp)}</span></div>${isUnread ? '<div class="w-2 h-2 rounded-full bg-orange-500"></div>' : ''}`;
                    item.onclick = () => { markAsRead(n.key, item); eval(linkFn); document.getElementById('notification-dropdown').classList.remove('visible'); };
                    list.appendChild(item);
                });
            });
        }
        function markAsRead(key, element) { db.ref(`notifications/${currentUser.uid}/${key}/read`).set(true); element.classList.remove('unread'); element.classList.add('read'); const dot = element.querySelector('.bg-orange-500'); if(dot) dot.remove(); }
        function sendNotification(targetUid, type, postId = null) {
            if (targetUid === currentUser.uid) return;
            const notifRef = db.ref(`notifications/${targetUid}`).push();
            notifRef.set({ type: type, fromUserId: currentUser.uid, fromUserName: (currentUserData && currentUserData.username) ? currentUserData.username : 'Alguien', postId: postId, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false });
        }

        function showToast(msg) { const t = document.getElementById('toast-container'); document.getElementById('toast-message').innerText = msg; t.classList.remove('opacity-0', 'translate-y-4'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-4'), 3000); }
        function showAlert(msg) { document.getElementById('custom-alert-msg').innerText = msg; document.getElementById('custom-alert').classList.remove('hidden'); document.getElementById('custom-alert').classList.add('flex'); }
        function closeCustomAlert() { document.getElementById('custom-alert').classList.add('hidden'); document.getElementById('custom-alert').classList.remove('flex'); }
        function showConfirm(msg, callback, title="¬øEst√°s seguro?") { confirmCallback = callback; document.getElementById('custom-confirm-title').innerText = title; document.getElementById('custom-confirm-msg').innerText = msg; document.getElementById('custom-confirm').classList.remove('hidden'); document.getElementById('custom-confirm').classList.add('flex'); }
        function closeCustomConfirm(res) { document.getElementById('custom-confirm').classList.add('hidden'); document.getElementById('custom-confirm').classList.remove('flex'); if(res && confirmCallback) confirmCallback(); confirmCallback = null; }
        function requireLogin(event) { if (!currentUser) { if(event) { event.preventDefault(); event.stopPropagation(); } window.location.href = 'login.html'; return false; } return true; }

        // --- COMPRESI√ìN MEJORADA (150KB L√çMITE ESTRICTO) ---
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const maxSizeKB = 150; 
                if (file.size / 1024 <= maxSizeKB && file.type !== 'image/png') { resolve(file); return; }

                const img = new Image();
                const url = URL.createObjectURL(file);
                
                img.onload = () => {
                    URL.revokeObjectURL(url);
                    let width = img.width, height = img.height;
                    const maxDim = 1920; 

                    // Resize inicial si es gigante
                    if (width > maxDim || height > maxDim) {
                        if (width > height) { height = Math.round((height * maxDim) / width); width = maxDim; } 
                        else { width = Math.round((width * maxDim) / height); height = maxDim; }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    let quality = 0.9;
                    
                    const tryCompression = () => {
                        canvas.toBlob(blob => {
                            if (!blob) { reject(new Error("Error procesando imagen.")); return; }
                            
                            // √âxito: Tama√±o correcto o calidad m√≠nima alcanzada
                            if (blob.size / 1024 <= maxSizeKB || quality <= 0.3) {
                                resolve(new File([blob], file.name.replace(/\.[^/.]+$/, ".webp"), { type: "image/webp", lastModified: Date.now() }));
                            } else {
                                // Fallo: Reducir calidad
                                quality -= 0.1;
                                // Si la calidad baja mucho, reducir dimensiones dr√°sticamente para asegurar <150kb
                                if (quality < 0.5) {
                                    canvas.width *= 0.8; canvas.height *= 0.8;
                                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                }
                                tryCompression();
                            }
                        }, 'image/webp', quality);
                    };
                    tryCompression();
                };
                img.onerror = () => { URL.revokeObjectURL(url); reject(new Error("Imagen corrupta.")); };
                img.src = url;
            });
        }
        
        function expandPostArea() { document.getElementById('extra-fields').classList.add('expanded'); document.getElementById('post-text').rows = 3; }
        function collapsePostArea(force=false) { 
            const reset = () => {
                document.getElementById('extra-fields').classList.remove('expanded'); document.getElementById('post-text').rows = 1;
                selectedFiles = []; renderPreviewStack(); 
                document.getElementById('post-text').value = ''; document.getElementById('post-title').value = '';
                document.getElementById('post-character').value = ''; document.getElementById('post-tags').value = ''; document.getElementById('post-description').value = '';
                selectCustomOption('dropdown-collection', '', '<i class="fas fa-folder mr-2 text-xs text-orange-500"></i> √Ålbum');
                selectCustomOption('dropdown-category', '', '<i class="fas fa-tag mr-2 text-xs text-orange-500"></i> Categor√≠a');
                document.getElementById('new-collection-name').value = '';
                document.getElementById('character-suggestions').classList.remove('visible'); 
                document.getElementById('publish-btn').disabled = false; document.getElementById('publish-btn').classList.remove('btn-disabled');
                document.getElementById('publish-btn').innerHTML = 'Publicar';
            };
            if(force || (selectedFiles.length === 0 && !document.getElementById('post-text').value)) reset();
            else showConfirm("¬øDescartar publicaci√≥n?", reset);
        }
        
        function handleFileSelect(e) {
            expandPostArea();
            const newFiles = Array.from(e.target.files);
            if (!newFiles.length) return;
            newFiles.forEach(file => { if (selectedFiles.length < 3) selectedFiles.push(file); });
            if (selectedFiles.length === 3) showToast("M√°ximo 3 im√°genes alcanzado");
            renderPreviewStack();
            if (selectedFiles.length > 0 && window.runAutoTagging) { try { window.runAutoTagging(selectedFiles[selectedFiles.length - 1]); } catch(e) {} }
            e.target.value = ""; 
        }

        function renderPreviewStack() {
            const container = document.getElementById('preview-stack'); container.innerHTML = '';
            if (selectedFiles.length === 0) { container.style.display = 'none'; return; }
            container.style.display = 'flex';
            selectedFiles.forEach((file, index) => {
                const url = URL.createObjectURL(file);
                const thumb = document.createElement('div'); thumb.className = 'preview-thumb';
                thumb.innerHTML = `<img src="${url}"><div class="remove-thumb-btn" onclick="removeFile(${index})"><i class="fas fa-times"></i></div>`;
                container.appendChild(thumb);
            });
        }
        function removeFile(index) { selectedFiles.splice(index, 1); renderPreviewStack(); }

        async function uploadToCatboxWithFallback(file) {
            const formData = new FormData(); formData.append('reqtype', 'fileupload'); formData.append('userhash', CATBOX_USERHASH); formData.append('fileToUpload', file);
            try {
                const r = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", { method: 'POST', body: formData });
                if (r.ok) { const txt = await r.text(); if (txt.includes('catbox.moe')) return txt.trim(); }
            } catch (e) { console.warn("Fallo Proxy 1", e); }
            try {
                const fd2 = new FormData(); fd2.append('reqtype', 'fileupload'); fd2.append('userhash', CATBOX_USERHASH); fd2.append('fileToUpload', file);
                const r = await fetch("https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent("https://catbox.moe/user/api.php"), { method: 'POST', body: fd2 });
                if (r.ok) { const txt = await r.text(); if (txt.includes('catbox.moe')) return txt.trim(); }
            } catch (e) { console.warn("Fallo Proxy 2", e); }
            throw new Error("Error de conexi√≥n. Intenta m√°s tarde.");
        }

        // --- SUBIDA DE POST CORREGIDA (ANTI-GHOST) ---
        async function uploadPost() {
            if(!requireLogin()) return;

            const text = document.getElementById('post-text').value.trim();
            const title = document.getElementById('post-title').value.trim();
            const characterName = document.getElementById('post-character').value.trim();
            const tags = document.getElementById('post-tags').value.trim();
            const description = document.getElementById('post-description').value.trim(); // Nuevo campo descriptivo
            const category = document.getElementById('post-category').value;
            let colId = document.getElementById('post-collection').value;
            const newColName = document.getElementById('new-collection-name').value.trim();

            if (!text && selectedFiles.length === 0) return showAlert("Escribe algo o sube una imagen.");
            if (selectedFiles.length > 0 && (!title || !category)) return showAlert("T√≠tulo y Categor√≠a son requeridos con imagen.");
            if (colId === 'new' && !newColName) return showAlert("Nombre de colecci√≥n requerido.");

            const btn = document.getElementById('publish-btn');
            const progress = document.getElementById('upload-progress');
            btn.disabled = true; btn.classList.add('btn-disabled'); 
            
            // Indicador de "Procesando" antes de subir
            btn.innerHTML = '<i class="fas fa-cog fa-spin"></i> Procesando im√°genes...';
            progress.classList.remove('hidden');
            
            try {
                let colName = null;
                if (colId === 'new') {
                    const ref = db.ref('collections/' + currentUser.uid).push();
                    colId = ref.key; colName = newColName;
                    await ref.set({ name: newColName, createdAt: firebase.database.ServerValue.TIMESTAMP, cover: 'pending', previews: [] });
                } else if (colId) {
                    const snap = await db.ref(`collections/${currentUser.uid}/${colId}/name`).once('value'); colName = snap.val();
                }

                let uploadedUrls = [];
                if (selectedFiles.length > 0) {
                    for (const file of selectedFiles) {
                        // 1. Comprimir
                        let processedFile = await compressImage(file);
                        // 2. Subir
                        btn.innerHTML = '<i class="fas fa-cloud-upload-alt fa-bounce"></i> Subiendo...';
                        const url = await uploadToCatboxWithFallback(processedFile);
                        uploadedUrls.push(url);
                    }
                    
                    // SEGURIDAD ANTI-GHOST: Si seleccion√≥ archivos pero no hay URLs, ABORTAR.
                    if (uploadedUrls.length === 0) {
                        throw new Error("La subida de im√°genes fall√≥. No se cre√≥ la publicaci√≥n.");
                    }
                }
                
                const finalUserName = (currentUserData && currentUserData.username) ? currentUserData.username : (currentUser?.displayName || 'Usuario');
                const finalUserAvatar = (currentUserData && currentUserData.profilePic) ? currentUserData.profilePic : 'https://placehold.co/100x100/333/fff?text=U';

                const newPostRef = db.ref('feed_posts').push();
                const newPostId = newPostRef.key;
                
                // Concatenamos las tags descriptivas al texto principal si se desea, o las guardamos en el objeto
                // Aqu√≠ las guardamos en el objeto 'postData' como 'descriptionTags'
                const postData = {
                    text, 
                    imageUrl: uploadedUrls.length > 0 ? uploadedUrls[0] : null,
                    imageUrls: uploadedUrls,
                    title, 
                    tags: tags,
                    descriptionTags: description, // Guardamos la descripci√≥n generada
                    category, characterName,
                    userId: currentUser.uid, userName: finalUserName, userAvatar: finalUserAvatar,
                    timestamp: firebase.database.ServerValue.TIMESTAMP, likes: 0,
                    collectionId: colId || null, collectionName: colName || null
                };
                
                await newPostRef.set(postData);

                const localPost = { ...postData, id: newPostId, timestamp: Date.now() }; 
                allPostsCache.unshift(localPost);
                applyFiltersAndRender(); 
                
                if (characterName) {
                    const normalizedChar = characterName.toLowerCase().replace(/[.#$\[\]]/g, ""); 
                    const charRef = db.ref(`stats/characters/${normalizedChar}`);
                    charRef.transaction((currentData) => { return { count: (currentData ? currentData.count : 0) + 1, displayName: characterName }; });
                }

                if (colId && uploadedUrls.length > 0) { await updateCollectionPreviews(currentUser.uid, colId, uploadedUrls[0]); }

                collapsePostArea(true); showToast("¬°Publicado!");

            } catch(e) { 
                console.error(e);
                showAlert("Error: " + (e.message || e || "Error desconocido")); 
            }
            finally { 
                btn.disabled = false; btn.classList.remove('btn-disabled'); btn.innerHTML = 'Publicar'; 
                progress.classList.add('hidden'); 
            }
        }

        function initFeedOnce() {
            db.ref('feed_posts').limitToLast(200).once('value').then(snapshot => {
                if(!snapshot.exists()) { allPostsCache = []; applyFiltersAndRender(); return; }
                const tempPosts = [];
                snapshot.forEach(child => { 
                    const val = child.val();
                    // Limpieza preventiva de datos corruptos al cargar
                    if(val.text || (val.imageUrls && val.imageUrls.length > 0) || val.imageUrl) {
                        tempPosts.push({ id: child.key, ...val }); 
                    }
                });
                allPostsCache = tempPosts.sort((a,b) => b.timestamp - a.timestamp);
                applyFiltersAndRender();
            });
        }

        function initCharacterStatsListener() {
            db.ref('stats/characters').on('value', snapshot => {
                if (snapshot.exists()) { characterStatsCache = snapshot.val(); } else { characterStatsCache = {}; }
            });
        }
        
        // --- ORDENAMIENTO DE FEED CORREGIDO (MIX INTELIGENTE) ---
        function applyFiltersAndRender() {
            let filtered = [...allPostsCache];
            const filterBar = document.getElementById('filter-bar');
            
            if (currentFilterTag) {
                const term = currentFilterTag.toLowerCase();
                if (currentFilterType === 'character') {
                    filtered = filtered.filter(p => p.characterName && p.characterName.toLowerCase() === term);
                    document.getElementById('active-filter-tag').innerHTML = `<i class="fas fa-user-tag"></i> ${currentFilterTag}`;
                } else {
                    filtered = filtered.filter(p => (p.tags||'').toLowerCase().includes(term) || (p.text||'').toLowerCase().includes('#'+term));
                    document.getElementById('active-filter-tag').innerText = '#' + currentFilterTag;
                }
                filterBar.classList.remove('hidden');
            } else {
                filterBar.classList.add('hidden');
            }

            if (currentSortOrder === 'newest') {
                const myPosts = [];
                const followedPosts = [];
                const otherPosts = [];

                filtered.forEach(post => {
                    // Limpieza: Ignorar posts sin contenido
                    if (!post.text && (!post.imageUrls || post.imageUrls.length === 0)) return;

                    if (post.userId === currentUser.uid) {
                        myPosts.push(post);
                    } else if (followingCache[post.userId]) {
                        followedPosts.push(post);
                    } else {
                        otherPosts.push(post);
                    }
                });

                myPosts.sort((a, b) => b.timestamp - a.timestamp);
                followedPosts.sort((a, b) => b.timestamp - a.timestamp);
                otherPosts.sort((a, b) => b.timestamp - a.timestamp);

                // Algoritmo de Mezcla: Priorizar Seguidos pero no ocultar el resto
                // Ratio aproximado: 3 Seguidos - 1 Descubrimiento
                const mixed = [];
                let fIndex = 0;
                let oIndex = 0;
                
                while(fIndex < followedPosts.length || oIndex < otherPosts.length) {
                    // A√±adir hasta 3 de seguidos
                    for(let i=0; i<3 && fIndex < followedPosts.length; i++) mixed.push(followedPosts[fIndex++]);
                    // A√±adir 1 de descubrimiento
                    if(oIndex < otherPosts.length) mixed.push(otherPosts[oIndex++]);
                    
                    // Relleno final
                    if(fIndex >= followedPosts.length && oIndex < otherPosts.length) 
                        while(oIndex < otherPosts.length) mixed.push(otherPosts[oIndex++]);
                    if(oIndex >= otherPosts.length && fIndex < followedPosts.length) 
                        while(fIndex < followedPosts.length) mixed.push(followedPosts[fIndex++]);
                }

                // Insertar mis posts en la mezcla por fecha natural o al principio si son muy recientes
                // Para simplificar, mostramos mis posts recientes primero, luego el mix
                displayedPosts = [...myPosts.slice(0, 1), ...mixed, ...myPosts.slice(1)];

            } else if (currentSortOrder === 'oldest') {
                displayedPosts = filtered.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
            } else if (currentSortOrder === 'likes') {
                displayedPosts = filtered.sort((a, b) => (b.likes || 0) - (a.likes || 0));
            }

            resetFeedView();
        }
        
        function resetFeedView() {
            const feedContainer = document.getElementById('feed-list-container');
            const gridContainer = document.getElementById('grid-view-container');
            feedContainer.innerHTML = ''; gridContainer.innerHTML = ''; currentRenderIndex = 0;
            if (displayedPosts.length === 0) {
                feedContainer.innerHTML = `<div class="text-center text-gray-500 py-10 flex flex-col items-center"><i class="fas fa-ghost text-4xl mb-2 opacity-50"></i><p>No hay publicaciones a√∫n.</p></div>`;
                document.getElementById('scroll-spinner').style.opacity = '0'; return;
            }
            loadMorePosts();
        }
        
        function loadMorePosts() {
            if (currentRenderIndex >= displayedPosts.length) { document.getElementById('scroll-spinner').style.opacity = '0'; return; }
            document.getElementById('scroll-spinner').style.opacity = '1';
            const nextIndex = currentRenderIndex + POSTS_PER_PAGE;
            const chunk = displayedPosts.slice(currentRenderIndex, nextIndex);
            const feedContainer = document.getElementById('feed-list-container');
            const gridContainer = document.getElementById('grid-view-container');
            
            chunk.forEach(post => {
                // Doble chequeo anti-ghost
                if((post.text || (post.imageUrls && post.imageUrls.length > 0)) && !document.getElementById(`post-card-${post.id}`)) {
                    feedContainer.appendChild(createPostCard(post));
                }
                const imgs = post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);
                if (imgs.length > 0) {
                     gridContainer.appendChild(createGridItem(post, imgs[0]));
                }
                updateUserAvatarInUI(post.userId);
            });
            currentRenderIndex = nextIndex;
            if (currentRenderIndex >= displayedPosts.length) document.getElementById('scroll-spinner').style.opacity = '0';
        }
        
        const scrollObserver = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && currentRenderIndex < displayedPosts.length) setTimeout(() => loadMorePosts(), 500);
        }, { rootMargin: '100px' });
        document.addEventListener('DOMContentLoaded', () => { const t = document.getElementById('load-more-trigger'); if(t) scrollObserver.observe(t); });

        function toggleFollow(targetUid, btn) {
            if (!requireLogin()) return;
            if (targetUid === currentUser.uid) return;

            const isFollowing = followingCache[targetUid];
            
            if (isFollowing) {
                delete followingCache[targetUid]; 
                db.ref(`follows/${currentUser.uid}/${targetUid}`).remove();
                db.ref(`followers/${targetUid}/${currentUser.uid}`).remove();
                if(btn) { btn.classList.remove('following'); btn.classList.add('not-following'); btn.innerHTML = 'Seguir'; }
            } else {
                followingCache[targetUid] = true; 
                db.ref(`follows/${currentUser.uid}/${targetUid}`).set(true);
                db.ref(`followers/${targetUid}/${currentUser.uid}`).set(true);
                sendNotification(targetUid, 'follow');
                if(btn) { btn.classList.remove('not-following'); btn.classList.add('following'); btn.innerHTML = 'Siguiendo'; }
            }
        }

        function createPostCard(post) {
            const div = document.createElement('div'); div.className = "feed-card opacity-0 animate-enter";
            div.id = `post-card-${post.id}`;
            
            let textHtml = '';
            // Mostrar texto y descripci√≥n generada
            if (post.text || post.descriptionTags) {
                const fullText = (post.text || "") + (post.descriptionTags ? "\n\n" + post.descriptionTags : "");
                if (fullText.length > 150) {
                    textHtml = `<div class="mt-2"><p class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap font-light" id="text-short-${post.id}">${fullText.substring(0, 150)}... <button onclick="expandText('${post.id}')" class="text-orange-500 font-bold hover:underline text-xs ml-1">Ver m√°s</button></p><p class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap font-light hidden" id="text-full-${post.id}">${fullText}</p></div>`;
                } else { textHtml = `<p class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap mt-2 font-light">${fullText}</p>`; }
            }
            
            let metaHtml = '<div class="mt-3 flex flex-wrap items-center gap-2">';
            if (post.characterName) metaHtml += `<button onclick="filterByCharacter('${post.characterName}')" class="text-[10px] bg-indigo-900/40 text-indigo-300 px-2.5 py-1 rounded-full border border-indigo-500/30 uppercase font-bold tracking-wide hover:bg-indigo-500/20 active:scale-95 transition flex items-center gap-1"><i class="fas fa-user-circle"></i> ${post.characterName}</button>`;
            
            if (post.collectionName) {
                metaHtml += `<button onclick="window.location.href='profile.html?uid=${post.userId}&collection=${post.collectionId}'" class="text-[10px] bg-zinc-800 text-gray-400 px-2 py-0.5 rounded border border-zinc-700 font-medium hover:text-white hover:border-orange-500 transition"><i class="fas fa-folder text-orange-500 mr-1"></i> ${post.collectionName}</button>`;
            }

            if (post.category) metaHtml += `<span class="text-[10px] bg-orange-900/40 text-orange-300 px-2 py-0.5 rounded border border-orange-500/30 uppercase font-bold tracking-wide">${post.category}</span>`;
            metaHtml += '</div>';
            
            const isOwner = currentUser && currentUser.uid === post.userId;
            let optionsBtn = isOwner ? `<button onclick="toggleOptionsMenu('${post.id}')" class="options-trigger text-gray-400 p-2 hover:text-white"><i class="fas fa-ellipsis-v"></i></button><div id="options-menu-${post.id}" class="options-menu"><div class="options-item text-red-400 hover:bg-red-900/20" onclick="deletePost('${post.id}')"><i class="fas fa-trash"></i> Eliminar</div></div>` : '';

            let followBtnHtml = '';
            if (!isOwner) {
                const isFollowing = followingCache[post.userId];
                const btnClass = isFollowing ? 'following' : 'not-following';
                const btnText = isFollowing ? 'Siguiendo' : 'Seguir';
                followBtnHtml = `<button onclick="toggleFollow('${post.userId}', this)" class="follow-btn ${btnClass} ml-2">${btnText}</button>`;
            }

            let imagesHtml = '';
            const images = post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);
            if (images.length > 0) {
                if (images.length === 1) imagesHtml = `<div class="single-image-container" onclick="openMainViewerById('${post.id}', 0)"><img src="${images[0]}" loading="lazy"></div>`;
                else if (images.length === 2) imagesHtml = `<div class="two-image-grid"><img src="${images[0]}" onclick="openMainViewerById('${post.id}', 0)" loading="lazy"><img src="${images[1]}" onclick="openMainViewerById('${post.id}', 1)" loading="lazy"></div>`;
                else imagesHtml = `<div class="multi-image-row"><img src="${images[0]}" onclick="openMainViewerById('${post.id}', 0)" loading="lazy"><img src="${images[1]}" onclick="openMainViewerById('${post.id}', 1)" loading="lazy"><img src="${images[2]}" onclick="openMainViewerById('${post.id}', 2)" loading="lazy"></div>`;
            }

            div.innerHTML = `
                <div class="p-4 pb-2">
                    <div class="flex justify-between items-start relative">
                        <div class="flex items-center gap-2">
                            <div class="flex gap-3 items-center" onclick="goToProfile('${post.userId}')" style="cursor:pointer;">
                                <img src="${post.userAvatar || 'https://placehold.co/100x100/333/fff?text=U'}" class="w-10 h-10 rounded-full object-cover border border-zinc-700 user-avatar-${post.userId} bg-zinc-800">
                                <div class="flex flex-col">
                                    <span class="font-bold text-gray-200 text-sm hover:text-orange-400 transition flex items-center gap-2">${post.userName}</span>
                                    <span class="text-[10px] text-gray-500 font-medium">${timeAgo(post.timestamp)}</span>
                                </div>
                            </div>
                            ${followBtnHtml}
                        </div>
                        ${optionsBtn}
                    </div>
                    ${post.title ? `<h4 class="font-bold text-white mt-3 text-sm tracking-wide">${post.title}</h4>` : ''}
                    ${textHtml}
                    ${metaHtml}
                </div>
                ${imagesHtml}
                <div class="px-4 py-3 flex items-center gap-6 border-t border-white/5 mt-1 bg-[#1a1a1c]">
                    <button id="like-btn-${post.id}" onclick="toggleLike('${post.id}', '${post.userId}')" class="flex items-center gap-2 text-gray-400 active:text-red-500 hover:text-red-400 transition group active:scale-95"><i class="far fa-heart text-lg group-active:scale-125 transition-transform"></i><span class="text-xs font-bold" id="likes-count-${post.id}">${post.likes || 0}</span></button>
                    <button onclick="toggleComments('${post.id}')" class="flex items-center gap-2 text-gray-400 hover:text-white transition active:scale-95"><i class="far fa-comment text-lg"></i><span class="text-xs font-bold" id="comments-count-${post.id}">0</span></button>
                </div>
                <div id="comments-${post.id}" class="hidden px-4 py-3 bg-[#0f0f10] border-t border-white/5"><div id="comments-list-${post.id}" class="flex flex-col gap-3 mb-3 max-h-60 overflow-y-auto custom-scrollbar"></div><form onsubmit="postComment(event, '${post.id}', '${post.userId}')" class="flex gap-2 relative"><input type="text" id="comment-input-${post.id}" maxlength="200" class="w-full bg-zinc-800 border border-zinc-700 rounded-full px-4 py-2.5 text-sm text-white focus:border-orange-500 focus:outline-none pr-10" placeholder="Escribe..." autocomplete="off"><button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-orange-500 hover:text-orange-400 p-2 active:scale-90 transition"><i class="fas fa-paper-plane"></i></button></form></div>`;
            checkLikeStatus(post.id); checkCommentStatus(post.id);
            return div;
        }

        function createGridItem(post, imgUrl) { 
            const div = document.createElement('div'); div.className = 'grid-item group'; 
            div.onclick = () => openMainViewerById(post.id, 0); 
            const multipleIcon = (post.imageUrls && post.imageUrls.length > 1) ? '<i class="fas fa-clone absolute top-2 right-2 text-white drop-shadow-md text-xs"></i>' : '';
            div.innerHTML = `<img src="${imgUrl}" loading="lazy">${multipleIcon}<div class="grid-overlay opacity-0 group-hover:opacity-100 transition-opacity"><span class="text-white text-[10px] font-bold drop-shadow-md"><i class="fas fa-heart text-white text-[9px]"></i> ${post.likes || 0}</span></div>`; return div; 
        }

        function expandText(id) { document.getElementById(`text-short-${id}`).classList.add('hidden'); document.getElementById(`text-full-${id}`).classList.remove('hidden'); }

        // --- VIEWER ---
        function normalize(text) { return text ? text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim() : ''; }

        function openMainViewerById(postId, imgIndex = 0) {
            let index = displayedPosts.findIndex(p => p.id === postId);
            let sourceList = displayedPosts;
            if (index === -1) { index = allPostsCache.findIndex(p => p.id === postId); if (index !== -1) sourceList = allPostsCache; else return; }
            currentViewPosts = sourceList; currentPostIndex = index; window.currentInternalIndex = imgIndex;
            updateViewerContent();
            const modal = document.getElementById('modal'); modal.classList.add('visible'); modal.classList.remove('fullscreen-mode'); document.body.style.overflow = 'hidden';
        }

        function updateViewerContent() {
            if (currentPostIndex < 0 || currentPostIndex >= currentViewPosts.length) return;
            const post = currentViewPosts[currentPostIndex];
            const images = post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);
            let imgToShow = "";
            if (images.length > 0) {
                if (typeof window.currentInternalIndex === 'undefined' || window.currentInternalIndex >= images.length) window.currentInternalIndex = 0;
                imgToShow = images[window.currentInternalIndex];
            }
            document.getElementById('modal-image').src = imgToShow;
            document.getElementById('modal-title').textContent = post.title || 'Sin t√≠tulo';
            
            // Mostrar tambi√©n la descripci√≥n autom√°tica en el visor
            const fullDesc = (post.text || '') + (post.descriptionTags ? '\n\n' + post.descriptionTags : '');
            document.getElementById('modal-desc').innerHTML = fullDesc.replace(/#(\w+)/g, '<span class="text-orange-400 font-bold cursor-pointer hover:underline" onclick="filterByTagFromModal(\'$1\')">#$1</span>');
            
            document.getElementById('modal-user-name').textContent = post.userName || 'Usuario';
            document.getElementById('modal-user-pic').src = post.userAvatar || 'https://placehold.co/100x100/333/fff?text=U';
            
            const charTag = document.getElementById('modal-character-tag');
            if(post.characterName) { charTag.classList.remove('hidden'); document.getElementById('modal-character-name').textContent = post.characterName; } else { charTag.classList.add('hidden'); }
            
            const delBtn = document.getElementById('modal-delete-btn');
            if (currentUser && currentUser.uid === post.userId) { delBtn.classList.remove('hidden'); delBtn.onclick = () => deletePost(post.id); } else { delBtn.classList.add('hidden'); }

            const tagsDiv = document.getElementById('modal-tags'); const tagsBtn = document.getElementById('tags-toggle-btn');
            tagsDiv.classList.add('hidden'); tagsDiv.innerHTML = '';
            if (post.tags && post.tags.trim().length > 0) { tagsBtn.style.display = 'flex'; post.tags.split(',').forEach(t => { if(t.trim()) tagsDiv.innerHTML += `<span class="text-[10px] bg-zinc-800 text-gray-300 px-2.5 py-1 rounded-full border border-zinc-700 font-medium cursor-pointer hover:border-orange-500" onclick="filterByTagFromModal('${t.trim()}')">#${t.trim()}</span>`; }); } else { tagsBtn.style.display = 'none'; }

            const likeBtn = document.getElementById('modal-like-btn'); const likesCount = document.getElementById('modal-likes-count');
            likeBtn.onclick = () => toggleLike(post.id, post.userId);
            const uid = currentUser ? currentUser.uid : deviceID;
            
            db.ref(`feed_likes/${post.id}`).off(); db.ref(`feed_posts/${post.id}/likes`).off();
            db.ref(`feed_likes/${post.id}/${uid}`).on('value', s => { if(s.exists()) { likeBtn.classList.add('text-red-500', 'bg-red-500/10', 'border-red-500/30'); likeBtn.querySelector('i').className = "fas fa-heart text-lg text-red-500 like-anim"; } else { likeBtn.classList.remove('text-red-500', 'bg-red-500/10', 'border-red-500/30'); likeBtn.querySelector('i').className = "far fa-heart text-lg text-gray-400"; } });
            db.ref(`feed_posts/${post.id}/likes`).on('value', s => likesCount.innerText = s.val() || 0);
            
            loadSimilarImagesInSlider(post.tags, post.id, post.characterName, post.userId);

            const commentsList = document.getElementById('modal-comments-list'); commentsList.innerHTML = '';
            db.ref(`feed_comments/${post.id}`).off();
            db.ref(`feed_comments/${post.id}`).on('child_added', s => { const c = s.val(); const div = document.createElement('div'); div.className = "flex gap-3 items-start text-sm animate-enter"; div.innerHTML = `<img src="${c.userAvatar}" class="w-8 h-8 rounded-full mt-1 border border-zinc-700 object-cover flex-shrink-0 cursor-pointer" onclick="goToProfile('${c.userId}')"><div class="bg-zinc-800/50 p-3 rounded-2xl rounded-tl-none border border-zinc-700/50 w-full"><span class="font-bold text-gray-300 block text-xs mb-1 hover:text-orange-400 cursor-pointer" onclick="goToProfile('${c.userId}')">${c.userName}</span><span class="text-gray-200 leading-snug block break-words font-light">${c.text}</span></div>`; commentsList.appendChild(div); });

            document.getElementById('modal-prev').style.display = (currentPostIndex > 0 || window.currentInternalIndex > 0) ? 'flex' : 'none';
            const isLastImg = window.currentInternalIndex === images.length - 1; const isLastPost = currentPostIndex === currentViewPosts.length - 1;
            document.getElementById('modal-next').style.display = (!isLastImg || !isLastPost) ? 'flex' : 'none';
        }
        
        function loadSimilarImagesInSlider(tagsStr, currentId, currentCharacterName, currentUserId) {
            const container = document.getElementById('similar-grid'); container.innerHTML = '';
            const candidates = allPostsCache.filter(p => p.id !== currentId && (p.imageUrls || p.imageUrl));
            if (candidates.length === 0) { container.innerHTML = '<span class="text-xs text-gray-500 italic px-2 self-center">No hay similares.</span>'; return; }

            const currentTags = tagsStr ? tagsStr.split(',').map(t => normalize(t)) : [];
            const normCharName = normalize(currentCharacterName);

            const scoredCandidates = candidates.map(p => {
                let score = 0;
                if (normCharName && p.characterName && normalize(p.characterName) === normCharName) { score += 100; if (p.userId !== currentUserId) score += 50; }
                if (p.tags) { const pTags = p.tags.split(',').map(t => normalize(t)); const common = pTags.filter(t => currentTags.includes(t)); score += common.length; }
                return { post: p, score: score };
            });

            const finalResults = scoredCandidates.filter(item => item.score > 0).sort((a, b) => b.score - a.score).map(item => item.post).slice(0, 15);
            if (finalResults.length === 0) { container.innerHTML = '<span class="text-xs text-gray-500 italic px-2 self-center">No hay similares.</span>'; return; }
            container.closest('.mb-6').style.display = 'block';

            finalResults.forEach(post => {
                const div = document.createElement('div'); div.className = "similar-card cursor-pointer group"; div.onclick = () => openMainViewerById(post.id, 0); 
                const imgUrl = (post.imageUrls && post.imageUrls.length > 0) ? post.imageUrls[0] : post.imageUrl;
                div.innerHTML = `<img src="${imgUrl}" loading="lazy" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition"></div>`;
                container.appendChild(div);
            });
        }

        function navigateModal(dir) {
            const post = currentViewPosts[currentPostIndex]; const images = post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);
            if (dir === 1) {
                if (window.currentInternalIndex < images.length - 1) window.currentInternalIndex++;
                else { if (currentPostIndex < currentViewPosts.length - 1) { currentPostIndex++; window.currentInternalIndex = 0; } }
            } else {
                if (window.currentInternalIndex > 0) window.currentInternalIndex--;
                else { if (currentPostIndex > 0) { currentPostIndex--; window.currentInternalIndex = 0; } }
            }
            updateViewerContent();
        }

        function toggleFullScreen() { document.getElementById('modal').classList.toggle('fullscreen-mode'); }
        function toggleTags() { const div = document.getElementById('modal-tags'); const btn = document.getElementById('tags-toggle-btn'); div.classList.toggle('hidden'); btn.innerHTML = div.classList.contains('hidden') ? '<span>Ver etiquetas</span> <i class="fas fa-chevron-down"></i>' : '<span>Ocultar etiquetas</span> <i class="fas fa-chevron-up"></i>'; }

        const modalEl = document.getElementById('modal-image-area');
        modalEl.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX, {passive:true});
        modalEl.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; if (Math.abs(touchEndX - touchStartX) > 50) { if (touchEndX < touchStartX) navigateModal(1); else navigateModal(-1); } }, {passive:true});
        document.getElementById('close-modal').onclick = () => { document.getElementById('modal').classList.remove('visible'); document.body.style.overflow = 'auto'; };

        function toggleCustomSelect(id) { const el = document.getElementById(id); const list = el.querySelector('.custom-select-options'); const trigger = el.querySelector('.custom-select-trigger'); document.querySelectorAll('.custom-select-options.show').forEach(opt => { if(opt !== list) { opt.classList.remove('show'); opt.parentElement.querySelector('.custom-select-trigger').classList.remove('active'); } }); list.classList.toggle('show'); trigger.classList.toggle('active'); }
        function selectCustomOption(containerId, value, displayText) { const container = document.getElementById(containerId); container.querySelector('input[type="hidden"]').value = value; container.querySelector('.custom-select-trigger span').innerHTML = displayText; container.querySelector('.custom-select-trigger').classList.remove('active'); container.querySelector('.custom-select-options').classList.remove('show'); if (containerId === 'dropdown-collection') toggleCollectionInput(); }
        function changeSortOrder(value, displayText) { currentSortOrder = value; const container = document.getElementById('dropdown-sort'); container.querySelector('#display-sort').innerText = displayText; toggleCustomSelect('dropdown-sort'); applyFiltersAndRender(); }
        window.addEventListener('click', function(e) { if (!e.target.closest('.custom-select-container')) { document.querySelectorAll('.custom-select-options.show').forEach(el => { el.classList.remove('show'); el.parentElement.querySelector('.custom-select-trigger').classList.remove('active'); }); } });
        window.addEventListener('click', function(e) { if (!e.target.closest('.relative') || e.target.closest('.notif-item')) { const d = document.getElementById('notification-dropdown'); if(d && !e.target.closest('.notif-btn')) d.classList.remove('visible'); } });

        function loadUserCollectionsSelect() { if (!currentUser) return; db.ref('collections/' + currentUser.uid).on('value', snap => { let html = `<div class="option-item" onclick="selectCustomOption('dropdown-collection', '', '<i class=\\'fas fa-folder mr-2 text-xs text-orange-500\\'></i> √Ålbum')">Ning√∫n √Ålbum</div><div class="option-item special-option" onclick="selectCustomOption('dropdown-collection', 'new', '‚ûï Crear Nueva Colecci√≥n...')">‚ûï Crear Nueva Colecci√≥n...</div>`; snap.forEach(child => { html += `<div class="option-item" onclick="selectCustomOption('dropdown-collection', '${child.key}', 'üìÅ ${child.val().name}')">üìÅ ${child.val().name}</div>`; }); const el = document.getElementById('collection-options-list'); if(el) el.innerHTML = html; }); }
        function toggleCollectionInput() { const v = document.getElementById('post-collection').value; const c = document.getElementById('new-collection-container'); if(v==='new') c.classList.remove('hidden'); else c.classList.add('hidden'); }
        async function updateCollectionPreviews(uid, cid, url) { if(!cid||cid==='new'||!url)return; const r=db.ref(`collections/${uid}/${cid}/previews`); await r.transaction(l=>{ l=l||[]; if(!Array.isArray(l))l=[]; l.unshift(url); return l.slice(0,4); }); db.ref(`collections/${uid}/${cid}/cover`).set(url); }

        function switchView(mode) { const f=document.getElementById('feed-list-container'), g=document.getElementById('grid-view-container'), bf=document.getElementById('btn-view-feed'), bg=document.getElementById('btn-view-grid'); if(mode==='feed'){f.classList.remove('hidden');g.classList.add('hidden');bf.classList.add('active');bg.classList.remove('active');}else{f.classList.add('hidden');g.classList.remove('hidden');bf.classList.remove('active');bg.classList.add('active');} }
        function filterByTagFromModal(t) { document.getElementById('close-modal').click(); currentFilterTag=t.replace('#','').trim(); currentFilterType='tag'; applyFiltersAndRender(); window.scrollTo({top:0,behavior:'smooth'}); }
        function filterByCharacterFromModal() { const name = document.getElementById('modal-character-name').innerText; document.getElementById('close-modal').click(); filterByCharacter(name); }
        function filterByCharacter(name) { currentFilterTag=name; currentFilterType='character'; applyFiltersAndRender(); document.getElementById('modal').classList.remove('visible'); document.body.style.overflow = 'auto'; window.scrollTo({top:0,behavior:'smooth'}); }
        function clearTagFilter() { currentFilterTag=null; applyFiltersAndRender(); }
        function goToProfile(uid) { window.location.href=`profile.html?uid=${uid}`; }
        function visitProfileFromModal() { const p = currentViewPosts[currentPostIndex]; if(p) goToProfile(p.userId); }
        function toggleOptionsMenu(id) { const m = document.getElementById(`options-menu-${id}`); document.querySelectorAll('.options-menu').forEach(x=>{if(x!==m)x.classList.remove('show')}); m.classList.toggle('show'); }
        window.onclick = e => { if(!e.target.closest('.options-trigger')) document.querySelectorAll('.options-menu').forEach(m=>m.classList.remove('show')); };
        function deletePost(id) { showConfirm("¬øEliminar publicaci√≥n?", () => { db.ref('feed_posts/'+id).remove().then(()=>{ showToast("Eliminado"); document.getElementById('modal').classList.remove('visible'); document.body.style.overflow='auto'; initFeedOnce(); }); }); }
        
        function toggleLike(id, postOwnerId) { 
            if(!requireLogin()) return; 
            const uid = currentUser.uid; 
            const ref = db.ref(`feed_likes/${id}/${uid}`); 
            ref.once('value', s => { 
                if(s.exists()) { ref.remove(); db.ref(`feed_posts/${id}/likes`).transaction(c => (c||1)-1); } 
                else { ref.set(true); db.ref(`feed_posts/${id}/likes`).transaction(c => (c||0)+1); sendNotification(postOwnerId, 'like', id); } 
            }); 
        }
        function checkLikeStatus(id) { const uid = currentUser ? currentUser.uid : deviceID; db.ref(`feed_likes/${id}/${uid}`).on('value', s => { const btn = document.getElementById(`like-btn-${id}`); if(btn) { if(s.exists()) { btn.classList.add('text-red-500'); btn.querySelector('i').className = 'fas fa-heart text-lg like-anim'; } else { btn.classList.remove('text-red-500'); btn.querySelector('i').className = 'far fa-heart text-lg'; } } }); db.ref(`feed_posts/${id}/likes`).on('value', s => { const el = document.getElementById(`likes-count-${id}`); if(el) el.innerText = s.val() || 0; }); }
        function checkCommentStatus(id) { db.ref(`feed_comments/${id}`).on('value', s => { const c = s.numChildren(); const el = document.getElementById(`comments-count-${id}`); if(el) { el.innerText = c || 0; if(c>0) el.classList.add('text-white'); else el.classList.remove('text-white'); } }); }
        function toggleComments(id) { const el = document.getElementById(`comments-${id}`); if(el.classList.contains('hidden')) { el.classList.remove('hidden'); db.ref(`feed_comments/${id}`).off(); document.getElementById(`comments-list-${id}`).innerHTML = ''; db.ref(`feed_comments/${id}`).on('child_added', s => { const c = s.val(); const div = document.createElement('div'); div.className = "flex gap-2 items-start text-sm animate-enter"; div.innerHTML = `<img src="${c.userAvatar}" class="w-6 h-6 rounded-full mt-1 border border-zinc-700 object-cover cursor-pointer" onclick="goToProfile('${c.userId}')"><div class="bg-zinc-800 p-2.5 rounded-2xl rounded-tl-none"><span class="font-bold text-gray-300 block text-xs mb-0.5 cursor-pointer hover:text-orange-400" onclick="goToProfile('${c.userId}')">${c.userName}</span><span class="text-gray-200 font-light">${c.text}</span></div>`; document.getElementById(`comments-list-${id}`).appendChild(div); }); } else el.classList.add('hidden'); }
        
        function postComment(e, id, postOwnerId) { 
            e.preventDefault(); if(!requireLogin()) return; 
            const input = document.getElementById(`comment-input-${id}`); if(!input.value.trim()) return; 
            const uN = (currentUserData&&currentUserData.username)?currentUserData.username:(currentUser?.displayName||'An√≥nimo'); 
            const uA = (currentUserData&&currentUserData.profilePic)?currentUserData.profilePic:'https://placehold.co/100x100/333/fff?text=U'; 
            db.ref(`feed_comments/${id}`).push({ text:input.value, userId:currentUser.uid, userName:uN, userAvatar:uA, timestamp:Date.now() }); 
            sendNotification(postOwnerId, 'comment', id); input.value=''; 
        }
        function postCommentInModal(e) { 
            e.preventDefault(); if(!requireLogin()) return; 
            const input = document.getElementById('modal-comment-input'); const post = currentViewPosts[currentPostIndex]; if(!input.value.trim() || !post) return; 
            const uN = (currentUserData&&currentUserData.username)?currentUserData.username:(currentUser?.displayName||'An√≥nimo'); 
            const uA = (currentUserData&&currentUserData.profilePic)?currentUserData.profilePic:'https://placehold.co/100x100/333/fff?text=U'; 
            db.ref(`feed_comments/${post.id}`).push({ text:input.value, userId:currentUser.uid, userName:uN, userAvatar:uA, timestamp:Date.now() }); 
            sendNotification(post.userId, 'comment', post.id); input.value=''; 
        }
        function updateUserAvatarInUI(uid) { if(!userProfileCache[uid]) db.ref(`users/${uid}/profilePic`).once('value', s => { const url = s.val()||'https://placehold.co/100x100/333/fff?text=U'; userProfileCache[uid]=url; document.querySelectorAll(`.user-avatar-${uid}`).forEach(i => i.src = url); }); else document.querySelectorAll(`.user-avatar-${uid}`).forEach(i => i.src = userProfileCache[uid]); }
        function timeAgo(ts) { if(!ts) return ''; const s = Math.floor((Date.now()-ts)/1000); if(s<60) return 'Hace un momento'; if(s<3600) return Math.floor(s/60)+'m'; if(s<86400) return Math.floor(s/3600)+'h'; return Math.floor(s/86400)+'d'; }

        // --- SUGGESTIONS ---
        const charInput = document.getElementById('post-character');
        const suggestionsBox = document.getElementById('character-suggestions');
        charInput.addEventListener('input', (e) => {
            const val = e.target.value.trim().toLowerCase();
            if (!val) { suggestionsBox.classList.remove('visible'); return; }
            const allChars = Object.entries(characterStatsCache).map(([key, data]) => ({ id: key, name: data.displayName, count: data.count || 0 }));
            const matches = allChars.filter(c => c.name.toLowerCase().includes(val)).sort((a, b) => b.count - a.count).slice(0, 3);
            if (matches.length > 0) { renderSuggestions(matches); suggestionsBox.classList.add('visible'); } else { suggestionsBox.classList.remove('visible'); }
        });
        document.addEventListener('click', (e) => { if (!charInput.contains(e.target) && !suggestionsBox.contains(e.target)) { suggestionsBox.classList.remove('visible'); } });
        function renderSuggestions(matches) {
            suggestionsBox.innerHTML = '';
            matches.forEach((match, index) => {
                const isTop = index === 0; const countDisplay = formatCount(match.count);
                const div = document.createElement('div'); div.className = 'suggestion-item'; div.onclick = () => selectSuggestion(match.name);
                div.innerHTML = `<span class="suggestion-name flex items-center gap-2 text-white">${match.name}${isTop && match.count > 0 ? '<i class="fas fa-check-circle verified-badge text-green-400 text-xs"></i>' : ''}</span><span class="text-xs text-gray-500">${countDisplay} usos</span>`;
                suggestionsBox.appendChild(div);
            });
        }
        function formatCount(num) { if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M...'; if (num >= 1000) return (num / 1000).toFixed(1) + 'k...'; return num; }
        function selectSuggestion(name) { charInput.value = name; suggestionsBox.classList.remove('visible'); }
    </script>
</body>
</html>