<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>exen-E | Comunidad</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --accent: #f97316; 
            --accent-glow: rgba(251, 146, 60, 0.4);
            --bg-dark: #09090b;
            --border-color: rgba(255, 255, 255, 0.08);
            --title-font: 'Poppins', sans-serif;
            --body-font: 'Inter', sans-serif;
        }
        /* Ajustes Globales */
        html, body {
            overflow-x: hidden;
            width: 100%;
            background-color: var(--bg-dark);
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        body { 
            font-family: var(--body-font); 
            background-image: radial-gradient(circle at 50% 0%, rgba(249, 115, 22, 0.06) 0%, transparent 50%);
            color: #f3f4f6;
            padding-bottom: 90px; /* Espacio para navbar */
            min-height: 100vh;
        }

        /* Scrollbars */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Loaders & Auth */
        #initial-loader {
            position: fixed; inset: 0; z-index: 10000;
            background-color: var(--bg-dark);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .loader-logo { width: 80px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 15px rgba(249, 115, 22, 0.4)); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        
        #auth-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background-color: rgba(9, 9, 11, 0.98);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center; justify-content: center;
            padding: 1.5rem;
            overflow-y: auto;
        }
        .form-card {
            background: #18181b;
            border: 1px solid var(--border-color);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            width: 100%; max-width: 400px;
        }
        .input-field {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease; color: white;
        }
        .input-field:focus { border-color: var(--accent); outline: none; background: rgba(0,0,0,0.6); }
        .btn-primary { background: linear-gradient(135deg, #f97316, #ea580c); transition: transform 0.2s; box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3); }
        .btn-primary:active { transform: scale(0.97); }
        .hidden-step { display: none; }

        /* Feed Cards */
        .feed-card {
            background-color: #18181b;
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            position: relative;
            width: 100%;
        }
        .animate-enter { animation: slideUpFade 0.4s ease-out forwards; }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Upload Area Mejorado */
        .upload-card {
            background: linear-gradient(145deg, #18181b, #121212);
            border: 1px solid rgba(249, 115, 22, 0.15);
        }
        #extra-fields {
            max-height: 0; opacity: 0; overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
        }
        #extra-fields.expanded {
            max-height: 800px; opacity: 1; margin-top: 12px; padding-top: 12px;
            border-top: 1px solid var(--border-color);
            overflow: visible !important;
        }
        .custom-input { background: rgba(0,0,0,0.25); border: 1px solid var(--border-color); color: white; padding: 12px 14px; border-radius: 10px; font-size: 0.95rem; width: 100%; transition: all 0.3s; }
        .custom-input:focus { outline: none; border-color: var(--accent); background: rgba(0,0,0,0.4); }

        /* Estilos de Auto-Tagging */
        .tags-readonly { background: rgba(0,0,0,0.4); cursor: not-allowed; border-style: dashed; opacity: 0.8; }
        .tags-readonly:focus { border-color: var(--border-color); }
        .tag-status-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); z-index: 10; font-size: 14px; }
        .status-loading { color: #fb923c; animation: spin 1s linear infinite; }
        .status-success { color: #4ade80; }
        .status-error { color: #ef4444; }
        .status-lock { color: #6b7280; }
        @keyframes spin { 100% { transform: translateY(-50%) rotate(360deg); } }
        @keyframes glowText { 0% { opacity: 0.5; } 50% { opacity: 1; color: #fb923c; } 100% { opacity: 0.5; } }
        .analyzing-text { animation: glowText 1.5s infinite; font-style: italic; }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); pointer-events: none; }

        /* Grid Mode */
        .grid-mode-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; width: 100%; }
        .grid-item { aspect-ratio: 1/1; overflow: hidden; position: relative; background-color: #222; cursor: pointer; }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .grid-item:active img { transform: scale(0.96); opacity: 0.8; }
        .grid-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 50%); display: flex; align-items: flex-end; padding: 4px; opacity: 1; }

        /* Navbar & Botones */
        .bottom-nav { background-color: rgba(9, 9, 11, 0.95); backdrop-filter: blur(16px); border-top: 1px solid var(--border-color); z-index: 3000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { color: #71717a; transition: all 0.3s ease; }
        .nav-item.active { color: var(--accent); }
        .toggle-btn { background: transparent; border: 1px solid #333; color: #666; transition: all 0.2s; }
        .toggle-btn.active { background: var(--accent); border-color: var(--accent); color: white; }

        /* Animaciones Feed */
        .like-anim { animation: likeBounce 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes likeBounce { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        /* Visor Modal */
        .modal-backdrop { display: none; position: fixed; inset: 0; background-color: #000; z-index: 7000; } 
        .modal-backdrop.visible { display: block; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
        
        .fullscreen-mode .info-panel { display: none !important; }
        .fullscreen-mode .image-area { width: 100% !important; height: 100vh !important; flex: none !important; }

        .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%); z-index: 20;
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); border-radius: 50%;
            color: white; border: 1px solid rgba(255,255,255,0.15); cursor: pointer; transition: all 0.2s;
        }
        .nav-arrow:active { background: var(--accent); }
        .nav-prev { left: 15px; } .nav-next { right: 15px; }

        /* Similar Cards (Visor) */
        .similar-card {
            min-width: 90px; width: 90px; aspect-ratio: 1/1;
            border-radius: 0.5rem; overflow: hidden; position: relative;
            flex-shrink: 0; scroll-snap-align: start;
            border: 1px solid rgba(255,255,255,0.1); transition: transform 0.2s;
            background-color: #1a1a1c;
        }
        .similar-card:active { transform: scale(0.95); border-color: var(--accent); }
        .similar-card img { width: 100%; height: 100%; object-fit: cover; }

        /* Options Menu */
        .options-menu { display: none; position: absolute; top: 40px; right: 10px; background: #1c1c1f; border: 1px solid #333; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 50; min-width: 150px; }
        .options-menu.show { display: block; animation: popIn 0.2s; }
        .options-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: #ccc; font-size: 0.95rem; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .options-item:last-child { border-bottom: none; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* Select Personalizado en Feed */
        select.custom-input { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
    </style>
</head>
<body class="antialiased select-none">

    <!-- PANTALLA DE CARGA -->
    <div id="initial-loader">
        <img src="https://files.catbox.moe/ap1lh0.png" class="loader-logo">
        <i class="fas fa-circle-notch fa-spin text-orange-500 text-2xl"></i>
        <p id="loader-status" class="text-gray-500 text-xs mt-4 animate-pulse">Cargando comunidad...</p>
    </div>

    <!-- TOAST (Notificaciones) -->
    <div id="toast-container" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[9000] pointer-events-none transition-all duration-300 opacity-0 translate-y-4">
        <div class="bg-zinc-900/95 backdrop-blur-md border border-zinc-700 px-6 py-3 rounded-full text-white font-medium shadow-2xl flex items-center gap-3">
            <i class="fas fa-check-circle text-green-500 text-lg"></i>
            <span id="toast-message">AcciÃ³n completada</span>
        </div>
    </div>

    <!-- ALERTAS PERSONALIZADAS -->
    <div id="custom-alert" class="hidden fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-[#18181b] border border-zinc-800 rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl">
            <div class="w-14 h-14 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4 border border-red-500/20"><i class="fas fa-exclamation text-red-500 text-2xl"></i></div>
            <h3 class="text-white font-bold text-xl mb-2">AtenciÃ³n</h3>
            <p id="custom-alert-msg" class="text-gray-400 text-sm mb-6 leading-relaxed">Mensaje</p>
            <button onclick="closeCustomAlert()" class="w-full bg-zinc-800 hover:bg-zinc-700 text-white py-3.5 rounded-xl font-bold transition active:scale-95">Entendido</button>
        </div>
    </div>

    <div id="custom-confirm" class="hidden fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-[#18181b] border border-zinc-800 rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl">
            <div class="w-14 h-14 rounded-full bg-orange-500/10 flex items-center justify-center mx-auto mb-4 border border-orange-500/20"><i class="fas fa-question text-orange-500 text-2xl"></i></div>
            <h3 id="custom-confirm-title" class="text-white font-bold text-xl mb-2">Â¿EstÃ¡s seguro?</h3>
            <p id="custom-confirm-msg" class="text-gray-400 text-sm mb-6 leading-relaxed">Â¿Continuar?</p>
            <div class="flex gap-3">
                <button onclick="closeCustomConfirm(false)" class="flex-1 bg-zinc-800 text-gray-300 py-3 rounded-xl font-bold border border-zinc-700 active:scale-95 transition">Cancelar</button>
                <button onclick="closeCustomConfirm(true)" class="flex-1 bg-orange-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- LOGIN OVERLAY -->
    <div id="auth-overlay">
        <div class="form-card rounded-2xl p-8 relative overflow-hidden">
            <div class="text-center mb-8">
                <img src="https://files.catbox.moe/ap1lh0.png" alt="Logo" class="h-14 mx-auto mb-4 drop-shadow-[0_0_15px_rgba(249,115,22,0.3)]">
                <h2 class="text-2xl font-bold font-[Poppins] text-white">Bienvenido</h2>
                <div class="flex justify-center gap-4 mt-4 text-sm font-semibold border-b border-zinc-800 pb-2">
                    <button id="tab-login" class="text-orange-500 border-b-2 border-orange-500 pb-1" onclick="switchAuthTab('login')">Iniciar SesiÃ³n</button>
                    <button id="tab-register" class="text-gray-500 pb-1 hover:text-white" onclick="switchAuthTab('register')">Registrarse</button>
                </div>
            </div>
            <form id="login-form" class="flex flex-col gap-4">
                <div class="space-y-1"><label class="text-xs text-gray-400 ml-1">Correo</label><input type="email" id="login-email" class="input-field w-full rounded-xl px-4 py-3.5 text-white" placeholder="tu@correo.com" required></div>
                <div class="space-y-1"><label class="text-xs text-gray-400 ml-1">ContraseÃ±a</label><input type="password" id="login-password" class="input-field w-full rounded-xl px-4 py-3.5 text-white" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required></div>
                <button type="submit" class="btn-primary w-full py-3.5 rounded-xl font-bold text-white mt-2 shadow-lg active:scale-95 transition">Entrar</button>
            </form>
            <form id="register-step-1" class="flex flex-col gap-4 hidden-step">
                <p class="text-sm text-gray-300 text-center mb-2">Paso 1: Identidad</p>
                <input type="text" id="reg-name" class="input-field w-full rounded-xl px-4 py-3.5 text-white" placeholder="Nombre de Usuario" required>
                <input type="number" id="reg-age" class="input-field w-full rounded-xl px-4 py-3.5 text-white" placeholder="Edad" required>
                <div class="relative w-full"><input type="file" id="file-upload-auth" accept="image/*" class="hidden" onchange="handleAuthFileUpload(event)"><label for="file-upload-auth" class="flex items-center gap-3 w-full input-field rounded-xl px-4 py-3 cursor-pointer hover:bg-zinc-800/50"><div class="w-10 h-10 rounded-full bg-gray-700 overflow-hidden border border-zinc-600"><img id="auth-preview-img" src="https://placehold.co/100x100/333/fff?text=Foto" class="w-full h-full object-cover"></div><div class="flex-1"><span class="text-sm text-gray-300 block">Subir imagen</span></div><i class="fas fa-camera text-gray-400"></i></label></div><input type="hidden" id="reg-photo-url">
                <button type="button" id="btn-step-1" onclick="validateAuthStep1()" class="btn-primary w-full py-3.5 rounded-xl font-bold text-white mt-2 active:scale-95 transition">Continuar</button>
            </form>
            <form id="register-step-2" class="flex flex-col gap-4 hidden-step">
                <input type="email" id="reg-email" class="input-field w-full rounded-xl px-4 py-3.5 text-white" placeholder="Correo" required>
                <input type="password" id="reg-password" class="input-field w-full rounded-xl px-4 py-3.5 text-white" placeholder="ContraseÃ±a" required>
                <input type="password" id="reg-confirm-password" class="input-field w-full rounded-xl px-4 py-3.5 text-white" placeholder="Confirmar ContraseÃ±a" required>
                <div class="flex gap-2 mt-2"><button type="button" onclick="authBackToStep1()" class="w-1/3 py-3.5 rounded-xl text-gray-400 border border-zinc-700 active:scale-95">AtrÃ¡s</button><button type="submit" id="btn-register-final" class="btn-primary w-2/3 py-3.5 rounded-xl font-bold text-white active:scale-95">Finalizar</button></div>
            </form>
        </div>
    </div>

    <!-- APP CONTENT -->
    <div id="app-content" style="display: none;">
        <!-- Header -->
        <header class="sticky top-0 z-40 bg-[#09090b]/90 backdrop-blur-md border-b border-white/5 px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <img src="https://files.catbox.moe/ap1lh0.png" alt="Logo" class="h-8 w-auto">
                <span class="font-bold text-lg tracking-tight font-[Poppins] text-orange-500">Social</span>
            </div>
            <a href="profile.html" class="w-9 h-9 rounded-full overflow-hidden border border-zinc-600 block relative active:scale-90 transition">
                <img id="current-user-avatar" src="https://placehold.co/100x100/333/fff?text=U" class="w-full h-full object-cover">
            </a>
        </header>

        <main class="container mx-auto max-w-lg px-0 sm:px-4 py-2 overflow-x-hidden">
            
            <!-- Upload Section -->
            <div class="px-2 sm:px-0">
                <div class="feed-card upload-card p-4 rounded-2xl mb-4">
                    <div class="flex gap-3 items-center mb-2">
                        <div class="w-10 h-10 rounded-full overflow-hidden bg-zinc-700 flex-shrink-0 self-start mt-1 border border-zinc-600">
                            <img id="post-avatar" src="https://placehold.co/100x100/333/fff?text=U" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 relative">
                            <textarea id="post-text" rows="1" maxlength="500" class="w-full bg-transparent text-white placeholder-gray-500 resize-none focus:outline-none text-sm py-2 min-h-[40px]" placeholder="Â¿QuÃ© quieres compartir?" onfocus="expandPostArea()" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                        </div>
                        <label class="flex items-center justify-center text-orange-500 cursor-pointer active:scale-90 transition p-2 rounded-full bg-zinc-800 hover:bg-zinc-700 border border-zinc-700">
                            <i class="fas fa-image text-lg"></i>
                            <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileSelect(event); expandPostArea()">
                        </label>
                    </div>
                    
                    <div id="preview-container" class="relative hidden mt-3 rounded-xl overflow-hidden border border-zinc-700 group bg-black/40">
                        <img id="image-preview" src="" class="w-full h-auto max-h-64 object-contain bg-black">
                        <button onclick="clearSelection()" class="absolute top-2 right-2 bg-black/60 text-white rounded-full p-2 w-8 h-8 flex items-center justify-center active:scale-90 transition z-10 backdrop-blur-sm"><i class="fas fa-times"></i></button>
                    </div>
                    
                    <div id="extra-fields">
                        <div class="flex flex-col gap-3">
                            <input type="text" id="post-title" maxlength="30" placeholder="TÃ­tulo (Opcional)" class="custom-input font-bold bg-black/20 border-zinc-700">
                            
                            <!-- Input de Personaje -->
                            <input type="text" id="post-character" maxlength="30" placeholder="Nombre del personaje (Opcional)" class="custom-input bg-black/20 border-zinc-700">
                            
                            <!-- Tags OCULTOS visualmente pero funcionales -->
                            <div class="hidden">
                                <input type="text" id="post-tags" placeholder="Auto-tagging..." readonly>
                                <i id="tag-status-icon"></i>
                            </div>
                            
                            <!-- CategorÃ­a (Full Width) -->
                            <div class="relative w-full">
                                <select id="post-category" class="custom-input bg-black/40 border-zinc-700 appearance-none pl-3 pr-8 text-xs h-full w-full">
                                    <option value="" disabled selected>CategorÃ­a</option>
                                    <option value="anime">Anime</option><option value="furry">Furry</option><option value="realismo">Realismo</option>
                                    <option value="mecas">Mecas</option><option value="devils">Devils</option><option value="colors">ColorFull</option>
                                    <option value="amateur">Amateur</option><option value="tvgames">TV/Games</option>
                                </select>
                            </div>
                            
                            <div class="flex gap-3 mt-2 pt-3 border-t border-white/5">
                                <button onclick="collapsePostArea()" class="flex-1 py-2 rounded-xl text-gray-400 text-sm font-semibold hover:bg-zinc-800 transition active:scale-95">Cancelar</button>
                                <button id="publish-btn" onclick="uploadPost()" class="bg-gradient-to-r from-orange-600 to-orange-500 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg active:scale-95 transition flex-[2]">Publicar</button>
                            </div>
                        </div>
                    </div>
                    <div id="upload-progress" class="hidden w-full bg-zinc-800 rounded-full h-1 mt-3 overflow-hidden"><div class="bg-orange-500 h-1 rounded-full w-1/3 animate-pulse"></div></div>
                </div>
            </div>

            <!-- Barra de Filtrado -->
            <div id="filter-bar" class="px-2 sm:px-0 mb-4 hidden animate-fade-in">
                <div class="bg-orange-900/20 border border-orange-500/30 rounded-xl p-3 flex justify-between items-center">
                    <span class="text-xs text-orange-200 font-bold flex items-center gap-2">
                        <i class="fas fa-filter"></i> Filtrando: <span id="active-filter-tag" class="bg-orange-500 text-white px-2 py-0.5 rounded">#tag</span>
                    </span>
                    <button onclick="clearTagFilter()" class="text-xs text-gray-400 hover:text-white underline">Borrar</button>
                </div>
            </div>

            <!-- Controles -->
            <div class="flex justify-between items-center gap-2 mb-4 px-2 sm:px-0">
                <div class="flex bg-zinc-900/80 p-1 rounded-xl border border-zinc-800">
                    <button onclick="switchView('feed')" id="btn-view-feed" class="toggle-btn active px-3 py-1.5 rounded-lg text-xs font-semibold flex items-center gap-2"><i class="fas fa-stream"></i></button>
                    <button onclick="switchView('grid')" id="btn-view-grid" class="toggle-btn px-3 py-1.5 rounded-lg text-xs font-semibold flex items-center gap-2"><i class="fas fa-th"></i></button>
                </div>
                
                <div class="relative">
                    <select id="sort-select" onchange="changeSortOrder(this.value)" class="bg-zinc-900/80 text-xs text-gray-300 border border-zinc-800 rounded-xl px-3 py-2 focus:outline-none focus:border-orange-500 appearance-none pr-8">
                        <option value="newest">âœ¨ Recientes</option>
                        <option value="oldest">ðŸ“… Antiguos</option>
                        <option value="likes">ðŸ”¥ Populares</option>
                    </select>
                    <i class="fas fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-gray-500 pointer-events-none"></i>
                </div>
            </div>

            <!-- FEED & GRID -->
            <div id="feed-list-container" class="flex flex-col gap-4 pb-10 px-2 sm:px-0 min-h-[300px]"></div>
            <div id="grid-view-container" class="grid-mode-container hidden pb-20 px-0"></div>
            
            <div id="load-more-trigger" class="h-16 w-full flex justify-center items-center my-4">
                <div id="scroll-spinner" class="flex flex-col items-center gap-2 opacity-0 transition-opacity duration-300">
                    <i class="fas fa-circle-notch fa-spin text-orange-500 text-2xl"></i>
                </div>
            </div>

        </main>

        <!-- VISOR MODAL MEJORADO -->
        <div id="modal" class="modal-backdrop overflow-hidden">
            <button id="close-modal" class="fixed top-4 right-4 z-[8000] h-10 w-10 flex items-center justify-center rounded-full bg-black/60 text-white backdrop-blur-md border border-white/10 active:scale-90 transition shadow-lg"><i class="fas fa-times text-lg"></i></button>

            <div id="modal-inner-container" class="w-full h-full flex flex-col lg:flex-row bg-black transition-all duration-300">
                <div class="image-area relative flex-1 bg-black flex items-center justify-center overflow-hidden h-[55vh] lg:h-full" id="modal-image-area">
                    <img id="modal-image" src="" class="max-w-full max-h-full object-contain w-auto h-auto transition-transform duration-300">
                    <button id="modal-prev" class="nav-arrow nav-prev" onclick="navigateModal(-1)"><i class="fas fa-chevron-left"></i></button>
                    <button id="modal-next" class="nav-arrow nav-next" onclick="navigateModal(1)"><i class="fas fa-chevron-right"></i></button>
                    <button onclick="toggleFullScreen()" class="absolute bottom-4 right-4 z-20 bg-zinc-800/80 text-white p-2.5 rounded-xl backdrop-blur-md border border-white/10 active:scale-90 transition shadow-lg"><i class="fas fa-expand text-sm"></i></button>
                </div>

                <div class="info-panel w-full lg:w-[400px] lg:h-full bg-[#121214] border-l border-zinc-800 flex flex-col h-[45vh] z-30 relative shadow-[-10px_0_30px_rgba(0,0,0,0.5)]">
                    <div class="p-4 border-b border-zinc-800 flex items-center justify-between bg-[#18181b] flex-shrink-0">
                        <div class="flex items-center gap-3 cursor-pointer hover:opacity-80" onclick="visitProfileFromModal()">
                            <img id="modal-user-pic" src="" class="w-10 h-10 rounded-full object-cover border border-zinc-600 bg-zinc-700">
                            <div class="leading-tight"><h4 id="modal-user-name" class="font-bold text-white text-sm">Usuario</h4><span class="text-[10px] text-gray-500 font-medium">Autor</span></div>
                        </div>
                        <button id="modal-like-btn" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-zinc-800 border border-zinc-700 hover:bg-zinc-700 transition group active:scale-95">
                            <i class="far fa-heart text-lg group-active:scale-125 transition-transform text-gray-400"></i><span id="modal-likes-count" class="text-xs font-bold text-white">0</span>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-5 custom-scrollbar bg-[#121214]">
                        <div class="mb-5">
                            <h3 id="modal-title" class="text-xl font-bold text-white mb-2 font-[Poppins] leading-snug"></h3>
                            <!-- Etiqueta de Personaje en el Visor -->
                            <div id="modal-character-tag" class="hidden inline-flex items-center gap-1.5 bg-orange-500/10 border border-orange-500/20 text-orange-400 px-2.5 py-1 rounded-md text-[11px] font-bold uppercase tracking-wider mb-2">
                                <i class="fas fa-user-tag text-[10px]"></i> <span id="modal-character-name"></span>
                            </div>
                            <p id="modal-desc" class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap font-light"></p>
                        </div>
                        
                        <!-- Tags RetrÃ¡ctiles -->
                        <div class="mb-6 border-b border-zinc-800 pb-4">
                            <button onclick="toggleTags()" id="tags-toggle-btn" class="text-[11px] font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2 hover:text-orange-500 transition-colors mb-2">
                                <span>Ver etiquetas</span> <i class="fas fa-chevron-down"></i>
                            </button>
                            <div id="modal-tags" class="hidden flex flex-wrap gap-2 mt-3"></div>
                        </div>

                        <!-- ImÃ¡genes Similares -->
                        <div class="mb-6 border-b border-zinc-800 pb-4">
                            <h4 class="text-[11px] font-bold text-gray-500 uppercase mb-3 tracking-widest flex items-center gap-2"><i class="fas fa-th-large"></i> Similares</h4>
                            <div id="similar-grid" class="flex gap-3 overflow-x-auto pb-3 snap-x no-scrollbar">
                                <span class="text-xs text-gray-600 italic px-2">Buscando...</span>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-[11px] font-bold text-gray-500 uppercase mb-4 tracking-widest flex items-center gap-2"><i class="fas fa-comments"></i> Comentarios</h4>
                            <div id="modal-comments-list" class="flex flex-col gap-4 pb-4"></div>
                        </div>
                    </div>

                    <div class="p-3 bg-[#18181b] border-t border-zinc-800 flex-shrink-0 safe-bottom">
                        <form onsubmit="postCommentInModal(event)" class="flex gap-2 relative">
                            <input type="text" id="modal-comment-input" maxlength="200" class="w-full bg-zinc-900 border border-zinc-700 rounded-full pl-5 pr-12 py-3 text-sm text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="Comentario..." autocomplete="off">
                            <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-orange-500 p-2 active:scale-90 transition"><i class="fas fa-paper-plane text-lg"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <nav class="bottom-nav fixed bottom-0 left-0 right-0 z-[100] flex h-[70px] justify-around items-center px-2 pb-2">
            <a href="index.html" class="nav-item flex flex-col items-center justify-center w-1/3 p-2 active:scale-95"><i class="fas fa-home text-xl mb-1.5"></i><span class="text-[10px] font-bold tracking-wide">GalerÃ­a</span></a>
            <a href="feed.html" class="nav-item active flex flex-col items-center justify-center w-1/3 p-2 active:scale-95"><i class="fas fa-globe-americas text-xl mb-1.5"></i><span class="text-[10px] font-bold tracking-wide">Social</span></a>
            <a href="profile.html" class="nav-item flex flex-col items-center justify-center w-1/3 p-2 active:scale-95"><i class="fas fa-user text-xl mb-1.5"></i><span class="text-[10px] font-bold tracking-wide">Perfil</span></a>
        </nav>
    </div>

    <!-- SCRIPT DE GRADIO PARA AUTO-TAGGING -->
    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/+esm";
        const TAGGER_CONFIG = { threshold: 0.5, useSpace: false, useEscape: true, keepConfidences: false, descend: true };
        async function resizeImageForApi(file) {
            if (file.size <= 1024 * 1024) return file;
            return new Promise((resolve) => {
                const img = new Image(); const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX_SIZE = 800;
                img.onload = () => {
                    let w=img.width, h=img.height; if(w>h){if(w>MAX_SIZE){h*=MAX_SIZE/w;w=MAX_SIZE;}}else{if(h>MAX_SIZE){w*=MAX_SIZE/h;h=MAX_SIZE;}}
                    canvas.width=w;canvas.height=h; ctx.drawImage(img,0,0,w,h); canvas.toBlob(resolve,'image/jpeg',0.85);
                }; img.src = URL.createObjectURL(file);
            });
        }
        window.runAutoTagging = async function(originalFile) {
            const tagInput = document.getElementById('post-tags'); const icon = document.getElementById('tag-status-icon'); const publishBtn = document.getElementById('publish-btn');
            // Tags visualmente ocultos, pero se llenan en el value
            tagInput.value = ""; 
            publishBtn.disabled = true; publishBtn.classList.add('btn-disabled');
            showToast("IA: Analizando imagen...");
            
            try {
                const processedFile = await resizeImageForApi(originalFile);
                const client = await Client.connect("Jossle/deepdanbooru_online_Exen");
                const result = await client.predict(0, [processedFile, TAGGER_CONFIG.threshold, TAGGER_CONFIG.useSpace, TAGGER_CONFIG.useEscape, TAGGER_CONFIG.keepConfidences, TAGGER_CONFIG.descend]);
                if (result && result.data && result.data[0]) {
                    tagInput.value = result.data[0];
                    showToast("Â¡Etiquetas generadas internamente!"); publishBtn.disabled = false; publishBtn.classList.remove('btn-disabled');
                } else throw new Error("Respuesta vacÃ­a");
            } catch (error) {
                console.error("Error Tagging:", error); showToast("Nota: Error IA, puedes publicar sin tags."); publishBtn.disabled = false; publishBtn.classList.remove('btn-disabled');
            }
        }
    </script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8", authDomain: "exene-53e6b.firebaseapp.com", databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com", projectId: "exene-53e6b", storageBucket: "exene-53e6b.appspot.com", messagingSenderId: "481369419867", appId: "1:481369419867:web:ac5db24c436344262c8f7e" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const CATBOX_USERHASH = "341adb9d3c2d09d0485aa908c";

        let currentUser = null;
        let currentUserData = null;
        let selectedFile = null;
        const userProfileCache = {};
        let deviceID = localStorage.getItem('deviceID');
        if (!deviceID) { deviceID = Math.random().toString(36).substring(2) + Date.now().toString(36); localStorage.setItem('deviceID', deviceID); }

        let allPostsCache = [];
        let displayedPosts = [];
        let currentRenderIndex = 0;
        const POSTS_PER_PAGE = 10;
        
        let currentFilterTag = null;
        let currentSortOrder = 'newest';
        let currentModalIndex = -1;
        let confirmCallback = null;
        let touchStartX = 0, touchEndX = 0;
        let isUploadingAuth = false;
        let authDataCache = {};

        // --- GLOBAL UTILS ---
        function showToast(msg) {
            const t = document.getElementById('toast-container');
            document.getElementById('toast-message').innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-4');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-4'), 3000);
        }
        function showAlert(msg) {
            document.getElementById('custom-alert-msg').innerText = msg;
            document.getElementById('custom-alert').classList.remove('hidden'); document.getElementById('custom-alert').classList.add('flex');
        }
        function closeCustomAlert() { document.getElementById('custom-alert').classList.add('hidden'); document.getElementById('custom-alert').classList.remove('flex'); }
        function showConfirm(msg, callback, title="Â¿EstÃ¡s seguro?") {
            confirmCallback = callback;
            document.getElementById('custom-confirm-title').innerText = title;
            document.getElementById('custom-confirm-msg').innerText = msg;
            document.getElementById('custom-confirm').classList.remove('hidden'); document.getElementById('custom-confirm').classList.add('flex');
        }
        function closeCustomConfirm(res) {
            document.getElementById('custom-confirm').classList.add('hidden'); document.getElementById('custom-confirm').classList.remove('flex');
            if(res && confirmCallback) confirmCallback(); confirmCallback = null;
        }

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            const loader = document.getElementById('initial-loader');
            if (user && !user.isAnonymous) {
                currentUser = user;
                document.getElementById('app-content').style.display = 'block'; 
                document.getElementById('auth-overlay').style.display = 'none';
                db.ref('users/' + user.uid).on('value', snap => { 
                    const d = snap.val(); if(d) {
                        currentUserData = d; 
                        if(d.profilePic) { 
                             document.getElementById('current-user-avatar').src = d.profilePic; 
                             document.getElementById('post-avatar').src = d.profilePic; 
                        }
                    }
                });
            } else {
                currentUser = null; document.getElementById('app-content').style.display = 'none'; document.getElementById('auth-overlay').style.display = 'flex';
            }
            loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500);
            initFeedListener();
        });

        // --- FEED LOGIC ---
        function initFeedListener() {
            db.ref('feed_posts').limitToLast(200).on('value', snapshot => {
                if(!snapshot.exists()) { allPostsCache = []; applyFiltersAndRender(); return; }
                const tempPosts = [];
                snapshot.forEach(child => { tempPosts.push({ id: child.key, ...child.val() }); });
                allPostsCache = tempPosts;
                applyFiltersAndRender();
            });
        }

        function applyFiltersAndRender() {
            let filtered = [...allPostsCache];
            if (currentFilterTag) {
                const tag = currentFilterTag.toLowerCase();
                filtered = filtered.filter(p => (p.tags||'').toLowerCase().includes(tag) || (p.text||'').toLowerCase().includes('#'+tag));
                document.getElementById('filter-bar').classList.remove('hidden');
                document.getElementById('active-filter-tag').innerText = '#' + currentFilterTag;
            } else {
                document.getElementById('filter-bar').classList.add('hidden');
            }

            if (currentSortOrder === 'newest') filtered.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            else if (currentSortOrder === 'oldest') filtered.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
            else if (currentSortOrder === 'likes') filtered.sort((a, b) => (b.likes || 0) - (a.likes || 0));

            displayedPosts = filtered;
            resetFeedView();
        }

        function resetFeedView() {
            const feedContainer = document.getElementById('feed-list-container');
            const gridContainer = document.getElementById('grid-view-container');
            feedContainer.innerHTML = '';
            gridContainer.innerHTML = '';
            currentRenderIndex = 0;
            if (displayedPosts.length === 0) {
                feedContainer.innerHTML = `<div class="text-center text-gray-500 py-10 flex flex-col items-center"><i class="fas fa-ghost text-4xl mb-2 opacity-50"></i><p>No hay publicaciones aÃºn.</p></div>`;
                document.getElementById('scroll-spinner').style.opacity = '0';
                return;
            }
            loadMorePosts();
        }

        function loadMorePosts() {
            if (currentRenderIndex >= displayedPosts.length) { document.getElementById('scroll-spinner').style.opacity = '0'; return; }
            document.getElementById('scroll-spinner').style.opacity = '1';
            const nextIndex = currentRenderIndex + POSTS_PER_PAGE;
            const chunk = displayedPosts.slice(currentRenderIndex, nextIndex);
            const feedContainer = document.getElementById('feed-list-container');
            const gridContainer = document.getElementById('grid-view-container');

            chunk.forEach(post => {
                feedContainer.appendChild(createPostCard(post));
                if (post.imageUrl) gridContainer.appendChild(createGridItem(post));
                updateUserAvatarInUI(post.userId);
            });
            currentRenderIndex = nextIndex;
            if (currentRenderIndex >= displayedPosts.length) document.getElementById('scroll-spinner').style.opacity = '0';
        }

        const scrollObserver = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && currentRenderIndex < displayedPosts.length) setTimeout(() => loadMorePosts(), 500);
        }, { rootMargin: '100px' });
        document.addEventListener('DOMContentLoaded', () => { const t = document.getElementById('load-more-trigger'); if(t) scrollObserver.observe(t); });

        // --- CREAR TARJETA ---
        function createPostCard(post) {
            const div = document.createElement('div'); div.className = "feed-card opacity-0 animate-enter";
            
            // Texto Colapsable
            let textHtml = '';
            if (post.text) {
                const fullText = post.text;
                if (fullText.length > 150) {
                    const shortText = fullText.substring(0, 150);
                    textHtml = `
                        <div class="mt-2">
                            <p class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap font-light" id="text-short-${post.id}">
                                ${shortText}... <button onclick="expandText('${post.id}')" class="text-orange-500 font-bold hover:underline text-xs ml-1">Ver mÃ¡s</button>
                            </p>
                            <p class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap font-light hidden" id="text-full-${post.id}">
                                ${fullText}
                            </p>
                        </div>
                    `;
                } else {
                    textHtml = `<p class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap mt-2 font-light">${fullText}</p>`;
                }
            }
            
            let metaChips = ''; 
            if (post.category) metaChips += `<span class="text-[10px] bg-orange-900/40 text-orange-300 px-2 py-0.5 rounded border border-orange-500/30 uppercase font-bold tracking-wide">${post.category}</span>`;

            const isOwner = currentUser && currentUser.uid === post.userId;
            let optionsBtn = isOwner ? `<button onclick="toggleOptionsMenu('${post.id}')" class="options-trigger text-gray-400 p-2 hover:text-white"><i class="fas fa-ellipsis-v"></i></button><div id="options-menu-${post.id}" class="options-menu"><div class="options-item text-red-400 hover:bg-red-900/20" onclick="deletePost('${post.id}')"><i class="fas fa-trash"></i> Eliminar</div></div>` : '';

            div.innerHTML = `
                <div class="p-4 pb-2">
                    <div class="flex justify-between items-start relative">
                        <div class="flex gap-3 items-center" onclick="goToProfile('${post.userId}')" style="cursor:pointer;">
                            <img src="${post.userAvatar || 'https://placehold.co/100x100/333/fff?text=U'}" class="w-10 h-10 rounded-full object-cover border border-zinc-700 user-avatar-${post.userId} bg-zinc-800">
                            <div class="flex flex-col">
                                <span class="font-bold text-gray-200 text-sm hover:text-orange-400 transition">${post.userName}</span>
                                <span class="text-[10px] text-gray-500 font-medium">${timeAgo(post.timestamp)}</span>
                            </div>
                        </div>
                        ${optionsBtn}
                    </div>
                    ${post.title ? `<h4 class="font-bold text-white mt-3 text-sm tracking-wide">${post.title}</h4>` : ''}
                    ${textHtml}
                    <div class="mt-3 flex flex-wrap items-center gap-2">${metaChips}</div>
                </div>
                ${post.imageUrl ? `<div class="mt-2 bg-black relative cursor-pointer group overflow-hidden border-t border-b border-zinc-800" onclick="openViewerById('${post.id}')"><img src="${post.imageUrl}" loading="lazy" class="w-full h-auto max-h-[500px] object-contain mx-auto"></div>` : ''}
                <div class="px-4 py-3 flex items-center gap-6 border-t border-white/5 mt-1 bg-[#1a1a1c]">
                    <button id="like-btn-${post.id}" onclick="toggleLike('${post.id}')" class="flex items-center gap-2 text-gray-400 active:text-red-500 hover:text-red-400 transition group active:scale-95">
                        <i class="far fa-heart text-lg group-active:scale-125 transition-transform"></i>
                        <span class="text-xs font-bold" id="likes-count-${post.id}">${post.likes || 0}</span>
                    </button>
                    <!-- BOTÃ“N DE COMENTARIOS CON CONTADOR -->
                    <button onclick="toggleComments('${post.id}')" class="flex items-center gap-2 text-gray-400 hover:text-white transition active:scale-95">
                        <i class="far fa-comment text-lg"></i>
                        <span class="text-xs font-bold" id="comments-count-${post.id}">0</span>
                    </button>
                </div>
                <div id="comments-${post.id}" class="hidden px-4 py-3 bg-[#0f0f10] border-t border-white/5">
                    <div id="comments-list-${post.id}" class="flex flex-col gap-3 mb-3 max-h-60 overflow-y-auto custom-scrollbar"></div>
                    <form onsubmit="postComment(event, '${post.id}')" class="flex gap-2 relative">
                        <input type="text" id="comment-input-${post.id}" maxlength="200" class="w-full bg-zinc-800 border border-zinc-700 rounded-full px-4 py-2.5 text-sm text-white focus:border-orange-500 focus:outline-none pr-10" placeholder="Escribe..." autocomplete="off">
                        <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-orange-500 hover:text-orange-400 p-2 active:scale-90 transition"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>`;
            checkLikeStatus(post.id);
            checkCommentStatus(post.id); // Nueva funciÃ³n para contador
            return div;
        }

        function expandText(id) {
            document.getElementById(`text-short-${id}`).classList.add('hidden');
            document.getElementById(`text-full-${id}`).classList.remove('hidden');
        }

        function createGridItem(post) {
            const div = document.createElement('div'); div.className = 'grid-item group'; 
            div.onclick = () => openViewerById(post.id);
            div.innerHTML = `<img src="${post.imageUrl}" loading="lazy"><div class="grid-overlay opacity-0 group-hover:opacity-100 transition-opacity"><span class="text-white text-[10px] font-bold drop-shadow-md"><i class="fas fa-heart text-white text-[9px]"></i> ${post.likes || 0}</span></div>`; 
            return div;
        }

        // --- UPLOAD LOGIC ---
        function expandPostArea() { 
            document.getElementById('extra-fields').classList.add('expanded'); 
            document.getElementById('post-text').rows = 3; 
        }
        function collapsePostArea(force=false) { 
            const reset = () => {
                document.getElementById('extra-fields').classList.remove('expanded'); 
                document.getElementById('post-text').rows = 1;
                clearSelection();
                document.getElementById('post-text').value = '';
                document.getElementById('post-title').value = '';
                document.getElementById('post-character').value = ''; // Limpiar personaje
                document.getElementById('post-tags').value = '';
                document.getElementById('publish-btn').disabled = false;
                document.getElementById('publish-btn').classList.remove('btn-disabled');
            };
            if(force || (!selectedFile && !document.getElementById('post-text').value)) reset();
            else showConfirm("Â¿Descartar publicaciÃ³n?", reset);
        }
        
        function handleFileSelect(e) { 
            selectedFile = e.target.files[0]; 
            if(selectedFile) { 
                document.getElementById('image-preview').src = URL.createObjectURL(selectedFile); 
                document.getElementById('preview-container').classList.remove('hidden');
                
                // Trigger Auto-Tagging
                if(window.runAutoTagging) window.runAutoTagging(selectedFile);
            } 
        }
        function clearSelection() { selectedFile = null; document.getElementById('file-input').value = ''; document.getElementById('preview-container').classList.add('hidden'); }

        async function uploadPost() {
            const text = document.getElementById('post-text').value.trim();
            const title = document.getElementById('post-title').value.trim();
            const characterName = document.getElementById('post-character').value.trim(); // NUEVO CAMPO
            const tags = document.getElementById('post-tags').value.trim();
            const category = document.getElementById('post-category').value;
            
            if (!text && !selectedFile) return showAlert("Escribe algo o sube una imagen.");
            if (selectedFile && (!title || !category)) return showAlert("Completa tÃ­tulo y categorÃ­a.");

            const btn = document.getElementById('publish-btn');
            btn.disabled = true; btn.classList.add('btn-disabled'); btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            document.getElementById('upload-progress').classList.remove('hidden');
            
            try {
                let imageUrl = null;
                if (selectedFile) {
                    // COMPRESIÃ“N DE IMAGEN
                    const compressedFile = await compressImage(selectedFile);
                    const formData = new FormData(); formData.append('reqtype','fileupload'); formData.append('userhash',CATBOX_USERHASH); formData.append('fileToUpload', compressedFile);
                    const r = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", { method:'POST', body: formData });
                    const txt = await r.text();
                    if(!r.ok || !txt.includes('catbox.moe')) throw new Error("Error subida imagen");
                    imageUrl = txt.trim();
                }
                
                const finalUserName = (currentUserData && currentUserData.username) ? currentUserData.username : (currentUser?.displayName || 'Usuario');
                const finalUserAvatar = (currentUserData && currentUserData.profilePic) ? currentUserData.profilePic : 'https://placehold.co/100x100/333/fff?text=U';

                const post = {
                    text, imageUrl, title, tags, category, characterName,
                    userId: currentUser.uid, userName: finalUserName, userAvatar: finalUserAvatar,
                    timestamp: firebase.database.ServerValue.TIMESTAMP, likes: 0
                };
                
                await db.ref('feed_posts').push(post);
                collapsePostArea(true); showToast("Â¡Publicado con Ã©xito!");
            } catch(e) { showAlert("Error: " + e.message); }
            finally { 
                btn.disabled = false; btn.classList.remove('btn-disabled'); btn.innerHTML = 'Publicar'; 
                document.getElementById('upload-progress').classList.add('hidden'); 
            }
        }

        // --- COMPRESS IMAGE FUNC ---
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const maxSizeKB = 150;
                if (file.size / 1024 <= maxSizeKB) { resolve(file); return; }
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = e => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width; canvas.height = img.height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,img.width,img.height);
                        let q = 0.9, attempts=0;
                        const tryC = () => {
                            canvas.toBlob(blob => {
                                if(!blob) reject("Error canvas");
                                if(blob.size/1024 <= maxSizeKB || q<=0.1 || attempts++>20) resolve(new File([blob], file.name.replace(/\.[^/.]+$/, ".jpg"), {type:"image/jpeg", lastModified:Date.now()}));
                                else { q-=0.05; tryC(); }
                            }, 'image/jpeg', q);
                        }; tryC();
                    }; img.onerror=reject;
                }; reader.onerror=reject;
            });
        }

        // --- VIEWER LOGIC MEJORADO (SIMILARES) ---
        function openViewerById(id) {
            currentModalIndex = displayedPosts.findIndex(p => p.id === id);
            if (currentModalIndex === -1) return;
            updateModalContent();
            document.getElementById('modal').classList.add('visible');
            document.getElementById('modal').classList.remove('fullscreen-mode');
            document.body.style.overflow = 'hidden'; 
        }

        function updateModalContent() {
            const post = displayedPosts[currentModalIndex];
            if (!post) return;
            document.getElementById('modal-image').src = post.imageUrl;
            document.getElementById('modal-title').textContent = post.title || 'Sin TÃ­tulo';
            
            // Mostrar etiqueta de Personaje si existe
            const charTag = document.getElementById('modal-character-tag');
            if (post.characterName) {
                charTag.classList.remove('hidden');
                document.getElementById('modal-character-name').textContent = post.characterName;
            } else {
                charTag.classList.add('hidden');
            }

            document.getElementById('modal-desc').innerHTML = (post.text || '').replace(/#(\w+)/g, '<span class="text-orange-400 font-bold cursor-pointer hover:underline" onclick="filterByTagFromModal(\'$1\')">#$1</span>');
            document.getElementById('modal-user-name').textContent = post.userName;
            document.getElementById('modal-user-pic').src = post.userAvatar;
            
            // Tags RetrÃ¡ctiles Logic
            const tagsDiv = document.getElementById('modal-tags');
            const tagsBtn = document.getElementById('tags-toggle-btn');
            tagsDiv.classList.add('hidden'); // Siempre iniciar oculto
            tagsBtn.innerHTML = '<span>Ver etiquetas</span> <i class="fas fa-chevron-down"></i>';
            tagsDiv.innerHTML = '';
            
            if (post.tags) {
                tagsBtn.style.display = 'flex';
                post.tags.split(',').forEach(t => { if(t.trim()) tagsDiv.innerHTML += `<span class="text-[10px] bg-zinc-800 border border-zinc-700 px-2 py-1 rounded-full cursor-pointer hover:border-orange-500 transition" onclick="filterByTagFromModal('${t.trim()}')">#${t.trim()}</span>`; });
            } else { 
                tagsBtn.style.display = 'none';
            }

            // CARGAR SIMILARES (LÃ³gica nueva: Prioridad personaje, luego tags)
            loadSimilarImagesInSlider(post.tags, post.id, post.characterName);

            const likeBtn = document.getElementById('modal-like-btn');
            const likesCount = document.getElementById('modal-likes-count');
            likeBtn.onclick = () => toggleLike(post.id);
            const uid = currentUser ? currentUser.uid : deviceID;
            
            db.ref(`feed_likes/${post.id}/${uid}`).on('value', s => {
                if(s.exists()) { likeBtn.classList.add('text-red-500', 'bg-red-500/10', 'border-red-500/30'); likeBtn.querySelector('i').className = "fas fa-heart text-lg text-red-500 like-anim"; } 
                else { likeBtn.classList.remove('text-red-500', 'bg-red-500/10', 'border-red-500/30'); likeBtn.querySelector('i').className = "far fa-heart text-lg text-gray-400"; }
            });
            db.ref(`feed_posts/${post.id}/likes`).on('value', s => likesCount.innerText = s.val() || 0);

            const commentsList = document.getElementById('modal-comments-list'); commentsList.innerHTML = '';
            db.ref(`feed_comments/${post.id}`).on('child_added', s => {
                const c = s.val();
                const div = document.createElement('div'); div.className = "flex gap-2 items-start text-sm animate-enter";
                div.innerHTML = `<img src="${c.userAvatar}" class="w-8 h-8 rounded-full mt-1 border border-zinc-700 object-cover flex-shrink-0 cursor-pointer" onclick="goToProfile('${c.userId}')"><div class="bg-zinc-800/50 p-3 rounded-2xl rounded-tl-none border border-zinc-700/50 w-full"><span class="font-bold text-gray-300 block text-xs mb-1 cursor-pointer hover:text-orange-400" onclick="goToProfile('${c.userId}')">${c.userName}</span><span class="text-gray-200 leading-snug font-light">${c.text}</span></div>`;
                commentsList.appendChild(div);
            });
            document.getElementById('modal-prev').style.display = currentModalIndex > 0 ? 'flex' : 'none';
            document.getElementById('modal-next').style.display = currentModalIndex < displayedPosts.length-1 ? 'flex' : 'none';
        }

        // --- LÃ“GICA DE SIMILARES ACTUALIZADA ---
        function loadSimilarImagesInSlider(tagsString, currentId, currentCharacterName) {
            const container = document.getElementById('similar-grid');
            container.innerHTML = '';
            
            const candidates = allPostsCache.filter(p => p.id !== currentId && p.imageUrl);
            let finalResults = [];
            let addedIds = new Set();

            // 1. PRIORIDAD: Mismo Personaje (Max 3)
            if (currentCharacterName) {
                const charMatches = candidates.filter(p => 
                    p.characterName && 
                    p.characterName.toLowerCase().trim() === currentCharacterName.toLowerCase().trim()
                ).slice(0, 3);
                
                charMatches.forEach(p => {
                    finalResults.push(p);
                    addedIds.add(p.id);
                });
            }

            // 2. RELLENO: Coincidencia de Tags (para dar variedad)
            if (tagsString) {
                const tags = tagsString.split(',').map(t => t.trim().toLowerCase());
                
                const tagMatches = candidates
                    .filter(p => !addedIds.has(p.id)) // Evitar duplicados si ya saliÃ³ por personaje
                    .map(p => {
                        const pTags = (p.tags || '').toLowerCase().split(',').map(t => t.trim());
                        const common = pTags.filter(t => tags.includes(t));
                        return { post: p, score: common.length };
                    })
                    .filter(item => item.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .map(item => item.post);

                // Agregar el resto hasta llenar unos 10 items en total
                finalResults = finalResults.concat(tagMatches);
            }

            if (finalResults.length === 0) {
                container.innerHTML = '<span class="text-xs text-gray-500 italic px-2">No se encontraron imÃ¡genes similares.</span>';
                return;
            }

            finalResults.slice(0, 10).forEach(post => {
                const div = document.createElement('div');
                div.className = "similar-card cursor-pointer group";
                div.onclick = () => openViewerById(post.id);
                div.innerHTML = `<img src="${post.imageUrl}" loading="lazy"><div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition"></div>`;
                container.appendChild(div);
            });
        }

        function toggleTags() {
            const div = document.getElementById('modal-tags');
            const btn = document.getElementById('tags-toggle-btn');
            if (div.classList.contains('hidden')) { div.classList.remove('hidden'); btn.innerHTML = '<span>Ocultar etiquetas</span> <i class="fas fa-chevron-up"></i>'; } 
            else { div.classList.add('hidden'); btn.innerHTML = '<span>Ver etiquetas</span> <i class="fas fa-chevron-down"></i>'; }
        }

        function navigateModal(dir) {
            const prev = displayedPosts[currentModalIndex];
            if(prev){ db.ref(`feed_likes/${prev.id}`).off(); db.ref(`feed_posts/${prev.id}/likes`).off(); db.ref(`feed_comments/${prev.id}`).off(); }
            if (dir===1 && currentModalIndex<displayedPosts.length-1) currentModalIndex++;
            else if (dir===-1 && currentModalIndex>0) currentModalIndex--;
            updateModalContent();
        }

        // Swipe Modal
        const modalArea = document.getElementById('modal-image-area');
        modalArea.addEventListener('touchstart', e => touchStartX=e.changedTouches[0].screenX, {passive:true});
        modalArea.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            if(Math.abs(touchEndX - touchStartX) > 50) { if(touchEndX < touchStartX) navigateModal(1); else navigateModal(-1); }
        }, {passive:true});

        document.getElementById('close-modal').onclick = () => {
            const p = displayedPosts[currentModalIndex]; if(p){ db.ref(`feed_likes/${p.id}`).off(); db.ref(`feed_posts/${p.id}/likes`).off(); db.ref(`feed_comments/${p.id}`).off(); }
            document.getElementById('modal').classList.remove('visible'); document.body.style.overflow='auto';
        };

        // --- HELPERS ---
        function switchView(mode) {
            const f=document.getElementById('feed-list-container'), g=document.getElementById('grid-view-container');
            const bf=document.getElementById('btn-view-feed'), bg=document.getElementById('btn-view-grid');
            if(mode==='feed'){ f.classList.remove('hidden'); g.classList.add('hidden'); bf.classList.add('active'); bg.classList.remove('active'); }
            else{ f.classList.add('hidden'); g.classList.remove('hidden'); bf.classList.remove('active'); bg.classList.add('active'); }
        }
        function changeSortOrder(o) { currentSortOrder = o; applyFiltersAndRender(); }
        function filterByTag(t) { currentFilterTag = t.replace('#','').trim(); applyFiltersAndRender(); window.scrollTo({top:0, behavior:'smooth'}); }
        function filterByTagFromModal(t) { document.getElementById('close-modal').click(); filterByTag(t); }
        function clearTagFilter() { currentFilterTag = null; applyFiltersAndRender(); }
        function goToProfile(uid) { window.location.href = `profile.html?uid=${uid}`; }
        function toggleFullScreen() { document.getElementById('modal').classList.toggle('fullscreen-mode'); }
        function toggleOptionsMenu(id) { const m = document.getElementById(`options-menu-${id}`); document.querySelectorAll('.options-menu').forEach(x => {if(x!==m)x.classList.remove('show')}); m.classList.toggle('show'); }
        window.onclick = e => { if(!e.target.closest('.options-trigger')) document.querySelectorAll('.options-menu').forEach(m=>m.classList.remove('show')); };
        
        function deletePost(id) { showConfirm("Â¿Eliminar publicaciÃ³n?", () => db.ref('feed_posts/'+id).remove().then(()=>showToast("Eliminado"))); }
        
        function toggleLike(id) {
            if(!currentUser && !deviceID) return showAlert("Inicia sesiÃ³n para dar like.");
            const uid = currentUser ? currentUser.uid : deviceID;
            const ref = db.ref(`feed_likes/${id}/${uid}`);
            ref.once('value', s => {
                if(s.exists()) { ref.remove(); db.ref(`feed_posts/${id}/likes`).transaction(c => (c||1)-1); }
                else { ref.set(true); db.ref(`feed_posts/${id}/likes`).transaction(c => (c||0)+1); }
            });
        }
        function checkLikeStatus(id) {
            const uid = currentUser ? currentUser.uid : deviceID;
            db.ref(`feed_likes/${id}/${uid}`).on('value', s => {
                const btn = document.getElementById(`like-btn-${id}`);
                if(btn) {
                    if(s.exists()) { btn.classList.add('text-red-500'); btn.querySelector('i').className = 'fas fa-heart text-lg like-anim'; } 
                    else { btn.classList.remove('text-red-500'); btn.querySelector('i').className = 'far fa-heart text-lg'; }
                }
            });
            db.ref(`feed_posts/${id}/likes`).on('value', s => { const el = document.getElementById(`likes-count-${id}`); if(el) el.innerText = s.val() || 0; });
        }
        
        // --- NUEVA FUNCIÃ“N: CONTADOR DE COMENTARIOS ---
        function checkCommentStatus(id) {
             db.ref(`feed_comments/${id}`).on('value', s => {
                 const count = s.numChildren();
                 const el = document.getElementById(`comments-count-${id}`);
                 if(el) {
                     el.innerText = count || 0;
                     if(count > 0) el.classList.add('text-white'); else el.classList.remove('text-white');
                 }
             });
        }

        function toggleComments(id) {
            const el = document.getElementById(`comments-${id}`);
            if(el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                db.ref(`feed_comments/${id}`).off(); document.getElementById(`comments-list-${id}`).innerHTML = '';
                db.ref(`feed_comments/${id}`).on('child_added', s => {
                    const c = s.val();
                    const div = document.createElement('div'); div.className = "flex gap-2 items-start text-sm animate-enter";
                    div.innerHTML = `<img src="${c.userAvatar}" class="w-6 h-6 rounded-full mt-1 border border-zinc-700 object-cover cursor-pointer" onclick="goToProfile('${c.userId}')"><div class="bg-zinc-800 p-2.5 rounded-2xl rounded-tl-none"><span class="font-bold text-gray-300 block text-xs mb-0.5 cursor-pointer hover:text-orange-400" onclick="goToProfile('${c.userId}')">${c.userName}</span><span class="text-gray-200 font-light">${c.text}</span></div>`;
                    document.getElementById(`comments-list-${id}`).appendChild(div);
                });
            } else el.classList.add('hidden');
        }
        function postComment(e, id) {
            e.preventDefault(); const input = document.getElementById(`comment-input-${id}`);
            if(!input.value.trim()) return;
            const uN = (currentUserData&&currentUserData.username)?currentUserData.username:(currentUser?.displayName||'AnÃ³nimo');
            const uA = (currentUserData&&currentUserData.profilePic)?currentUserData.profilePic:'https://placehold.co/100x100/333/fff?text=U';
            db.ref(`feed_comments/${id}`).push({ text:input.value, userId:currentUser?currentUser.uid:'anon', userName:uN, userAvatar:uA, timestamp:Date.now() });
            input.value='';
        }
        function updateUserAvatarInUI(uid) {
            if(!userProfileCache[uid]) db.ref(`users/${uid}/profilePic`).once('value', s => { const url = s.val()||'https://placehold.co/100x100/333/fff?text=U'; userProfileCache[uid]=url; document.querySelectorAll(`.user-avatar-${uid}`).forEach(i => i.src = url); });
            else document.querySelectorAll(`.user-avatar-${uid}`).forEach(i => i.src = userProfileCache[uid]);
        }
        function timeAgo(ts) {
            if(!ts) return ''; const s = Math.floor((Date.now()-ts)/1000);
            if(s<60) return 'Hace un momento'; if(s<3600) return Math.floor(s/60)+'m'; if(s<86400) return Math.floor(s/3600)+'h'; return Math.floor(s/86400)+'d';
        }

        // --- AUTH ---
        function switchAuthTab(t) { document.getElementById('login-form').style.display=t==='login'?'flex':'none'; document.getElementById('register-step-1').style.display=t==='login'?'none':'flex'; document.getElementById('register-step-2').style.display='none'; document.getElementById('tab-login').className=t==='login'?"text-orange-500 border-b-2 border-orange-500 pb-1":"text-gray-400 pb-1 hover:text-white"; document.getElementById('tab-register').className=t==='login'?"text-gray-400 pb-1 hover:text-white":"text-orange-500 border-b-2 border-orange-500 pb-1"; }
        document.getElementById('login-form').onsubmit = e => { e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err=>showAlert(err.message)); };
        function authBackToStep1() { document.getElementById('register-step-2').style.display='none'; document.getElementById('register-step-1').style.display='flex'; }
        async function handleAuthFileUpload(e) { 
            const f = e.target.files[0]; if(!f) return;
            document.getElementById('auth-preview-img').src = URL.createObjectURL(f);
            isUploadingAuth=true; document.getElementById('btn-step-1').innerText = "PROCESANDO..."; document.getElementById('btn-step-1').disabled=true;
            try {
                const cF = await compressImage(f);
                const fd = new FormData(); fd.append('reqtype','fileupload'); fd.append('userhash',CATBOX_USERHASH); fd.append('fileToUpload', cF);
                const r = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", {method:'POST', body:fd});
                const t = await r.text();
                document.getElementById('reg-photo-url').value = t.trim();
            } catch(e){ showAlert("Error imagen: "+e.message); }
            finally { isUploadingAuth=false; document.getElementById('btn-step-1').innerText="Continuar"; document.getElementById('btn-step-1').disabled=false; }
        }
        function validateAuthStep1() {
            if(isUploadingAuth) return;
            const n = document.getElementById('reg-name').value; const a = document.getElementById('reg-age').value;
            if(!n || !a) return showAlert("Completa nombre y edad.");
            authDataCache = {name:n, age:a, photo:document.getElementById('reg-photo-url').value};
            document.getElementById('register-step-1').style.display='none'; document.getElementById('register-step-2').style.display='flex';
        }
        document.getElementById('register-step-2').onsubmit = e => {
            e.preventDefault(); const p1 = document.getElementById('reg-password').value; const p2 = document.getElementById('reg-confirm-password').value;
            if(p1!==p2) return showAlert("ContraseÃ±as no coinciden.");
            auth.createUserWithEmailAndPassword(document.getElementById('reg-email').value, p1).then(c => {
                db.ref('users/'+c.user.uid).set({username:authDataCache.name, age:authDataCache.age, profilePic:authDataCache.photo||null, email:c.user.email, slogan:"..."});
            }).catch(err=>showAlert(err.message));
        };
    </script>
</body>
</html>