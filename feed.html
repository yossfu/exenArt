<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>exen-E | Comunidad</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --accent: #f97316; 
            --accent-glow: rgba(251, 146, 60, 0.4);
            --title-font: 'Poppins', sans-serif;
            --body-font: 'Inter', sans-serif;
        }
        body { 
            font-family: var(--body-font); 
            background-color: #0c0c0c;
            background-image: radial-gradient(circle at 50% 0%, rgba(249, 115, 22, 0.08) 0%, transparent 50%);
            color: #f3f4f6;
            padding-bottom: 90px;
            min-height: 100vh;
        }

        /* --- PANTALLA DE CARGA INICIAL (SOLUCIÓN AL FLASH) --- */
        #initial-loader {
            position: fixed; inset: 0; z-index: 10000;
            background-color: #0c0c0c;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .loader-logo { width: 80px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 10px var(--accent)); animation: pulse 2s infinite; }
        
        /* --- ESTILOS DE AUTENTICACIÓN --- */
        #auth-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background-color: #0c0c0c;
            background-image: radial-gradient(circle at 50% 50%, rgba(249, 115, 22, 0.1) 0%, transparent 50%);
            display: none; /* OCULTO POR DEFECTO */
            align-items: center; justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }
        .form-card {
            background: rgba(20, 20, 25, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            width: 100%; max-width: 400px;
        }
        .input-field {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #f97316, #ea580c);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); }
        .hidden-step { display: none; animation: fadeIn 0.5s forwards; }
        .upload-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- ESTILOS FEED --- */
        .feed-card {
            background-color: #161618;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            overflow: visible; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            position: relative;
        }

        .upload-card {
            background: linear-gradient(145deg, #1a1a1c, #111112);
            border: 1px solid rgba(249, 115, 22, 0.2);
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.05);
            transition: all 0.3s ease;
        }

        /* Área expandible */
        #extra-fields {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out;
        }
        #extra-fields.expanded {
            max-height: 500px; opacity: 1; margin-top: 12px; padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        /* Grid Mode */
        .grid-mode-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .grid-item { aspect-ratio: 1/1; overflow: hidden; position: relative; background-color: #222; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .grid-item:active img { transform: scale(0.98); }
        .grid-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 50%); display: flex; align-items: flex-end; padding: 6px; opacity: 1; }

        .custom-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 10px 12px; border-radius: 8px; font-size: 0.875rem; width: 100%; transition: border-color 0.3s; }
        .custom-input:focus { outline: none; border-color: var(--accent); }

        .bottom-nav { background-color: rgba(10, 10, 10, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid rgba(55, 65, 81, 0.3); }
        .nav-item { color: #9ca3af; transition: color 0.25s ease, transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .nav-item.active { color: var(--accent); transform: translateY(-4px); }
        
        .like-anim { animation: likeBounce 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes likeBounce { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        .modal-backdrop { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; }
        .modal-backdrop.visible { display: flex; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .toggle-btn { background: transparent; border: 1px solid #333; color: #666; }
        .toggle-btn.active { background: var(--accent); border-color: var(--accent); color: white; }

        .options-menu { display: none; position: absolute; top: 40px; right: 10px; background: #222; border: 1px solid #333; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 50; min-width: 150px; overflow: hidden; }
        .options-menu.show { display: block; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(-10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        .options-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: #ccc; font-size: 0.95rem; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .options-item:last-child { border-bottom: none; }
        .options-item:active { background: #333; color: white; }
        .options-item.delete:active { background: #450a0a; color: #f87171; }

        #app-content { display: none; } /* OCULTO POR DEFECTO PARA EVITAR FLASH */
    </style>
</head>
<body class="antialiased">

    <!-- 1. PANTALLA DE CARGA (Visible por defecto, cubre todo) -->
    <div id="initial-loader">
        <img src="https://files.catbox.moe/ap1lh0.png" class="loader-logo">
        <i class="fas fa-spinner fa-spin text-orange-500 text-2xl"></i>
    </div>

    <!-- 2. OVERLAY DE LOGIN (Oculto por defecto) -->
    <div id="auth-overlay">
        <div class="form-card rounded-2xl p-8 relative overflow-hidden">
            <!-- Header Auth -->
            <div class="text-center mb-8">
                <img src="https://files.catbox.moe/ap1lh0.png" alt="Logo" class="h-16 mx-auto mb-4 drop-shadow-[0_0_10px_rgba(249,115,22,0.5)]">
                <h2 class="text-2xl font-bold font-[Poppins] text-white">Bienvenido</h2>
                <div class="flex justify-center gap-4 mt-4 text-sm font-semibold">
                    <button id="tab-login" class="text-orange-500 border-b-2 border-orange-500 pb-1 transition-colors" onclick="switchAuthTab('login')">Iniciar Sesión</button>
                    <button id="tab-register" class="text-gray-400 pb-1 hover:text-white transition-colors" onclick="switchAuthTab('register')">Registrarse</button>
                </div>
            </div>

            <!-- LOGIN FORM -->
            <form id="login-form" class="flex flex-col gap-4">
                <div class="space-y-1">
                    <label class="text-xs text-gray-400 ml-1">Correo Electrónico</label>
                    <input type="email" id="login-email" class="input-field w-full rounded-lg px-4 py-3 text-white" placeholder="tu@correo.com" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-gray-400 ml-1">Contraseña</label>
                    <input type="password" id="login-password" class="input-field w-full rounded-lg px-4 py-3 text-white" placeholder="••••••••" required>
                </div>
                <button type="submit" id="btn-login-submit" class="btn-primary w-full py-3 rounded-lg font-bold text-white mt-2 shadow-lg shadow-orange-500/20 flex justify-center items-center gap-2">
                    <span>Entrar</span>
                </button>
                <p id="login-error" class="text-red-400 text-xs text-center mt-2 hidden bg-red-900/20 p-2 rounded border border-red-500/30"></p>
            </form>

            <!-- REGISTER FORM (Step 1) -->
            <form id="register-step-1" class="flex flex-col gap-4 hidden-step" style="display: none;">
                <p class="text-sm text-gray-300 text-center mb-2">Paso 1: Tu Identidad</p>
                <div class="space-y-1">
                    <label class="text-xs text-gray-400 ml-1">Nombre de Usuario</label>
                    <input type="text" id="reg-name" class="input-field w-full rounded-lg px-4 py-3 text-white" placeholder="Como quieres que te llamen" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-gray-400 ml-1">Edad</label>
                    <input type="number" id="reg-age" class="input-field w-full rounded-lg px-4 py-3 text-white" placeholder="Tu edad real" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-gray-400 ml-1">Foto de Perfil</label>
                    <div class="relative w-full">
                        <input type="file" id="file-upload-auth" accept="image/*" class="hidden" onchange="handleAuthFileUpload(event)">
                        <label for="file-upload-auth" class="flex items-center gap-3 w-full input-field rounded-lg px-4 py-3 cursor-pointer hover:bg-white/5 transition group">
                            <div class="w-10 h-10 rounded-full bg-gray-700 overflow-hidden flex-shrink-0 border border-gray-500 group-hover:border-orange-500 transition">
                                <img id="auth-preview-img" src="https://placehold.co/100x100/333/fff?text=Foto" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1">
                                <span class="text-sm text-gray-300 block font-medium">Subir imagen</span>
                                <span class="text-[10px] text-gray-500 block" id="upload-status">Max 5MB</span>
                            </div>
                            <i class="fas fa-camera text-gray-400 group-hover:text-orange-500 transition"></i>
                        </label>
                    </div>
                    <input type="hidden" id="reg-photo-url">
                </div>
                <button type="button" id="btn-step-1" onclick="validateAuthStep1()" class="btn-primary w-full py-3 rounded-lg font-bold text-white mt-2 flex justify-center items-center gap-2">
                    <span>Continuar</span> <i class="fas fa-arrow-right ml-1"></i>
                </button>
                <p id="step1-error" class="text-red-400 text-xs text-center mt-2 hidden"></p>
            </form>

            <!-- REGISTER FORM (Step 2) -->
            <form id="register-step-2" class="flex flex-col gap-4 hidden-step" style="display: none;">
                <div class="flex items-center gap-3 bg-green-900/30 p-3 rounded-lg border border-green-500/30 mb-2">
                    <div class="bg-green-500 rounded-full p-1"><i class="fas fa-check text-white text-xs"></i></div>
                    <p class="text-sm text-green-200">Datos verificados.</p>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-gray-400 ml-1">Correo Electrónico</label>
                    <input type="email" id="reg-email" class="input-field w-full rounded-lg px-4 py-3 text-white" placeholder="tu@correo.com" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-gray-400 ml-1">Contraseña</label>
                    <input type="password" id="reg-password" class="input-field w-full rounded-lg px-4 py-3 text-white" placeholder="Mínimo 6 caracteres" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-gray-400 ml-1">Confirmar Contraseña</label>
                    <input type="password" id="reg-confirm-password" class="input-field w-full rounded-lg px-4 py-3 text-white" placeholder="Repite tu contraseña" required>
                </div>
                <div class="flex gap-2 mt-2">
                    <button type="button" onclick="authBackToStep1()" class="w-1/3 py-3 rounded-lg font-semibold text-gray-400 border border-gray-600 hover:bg-gray-800">Atrás</button>
                    <button type="submit" id="btn-register-final" class="btn-primary w-2/3 py-3 rounded-lg font-bold text-white shadow-lg shadow-orange-500/20 flex justify-center items-center gap-2">
                        <span>Finalizar</span>
                    </button>
                </div>
                <p id="reg-error" class="text-red-400 text-xs text-center mt-2 hidden bg-red-900/20 p-2 rounded border border-red-500/30"></p>
            </form>
        </div>
    </div>

    <!-- Modal Edad -->
    <div id="age-alert-modal" class="fixed inset-0 z-[10000] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm" style="display: none;">
        <div class="bg-gray-900 border border-red-500/50 rounded-2xl p-6 max-w-sm w-full text-center shadow-[0_0_30px_rgba(239,68,68,0.3)]">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4 animate-pulse"></i>
            <h3 class="text-xl font-bold text-white mb-2">Acceso Restringido</h3>
            <p class="text-gray-300 mb-6">Esta plataforma es para mayores de 18 años. No puedes registrarte si eres menor.</p>
            <button onclick="document.getElementById('age-alert-modal').style.display='none'" class="w-full py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg font-semibold transition">Entendido</button>
        </div>
    </div>

    <!-- 3. CONTENIDO PRINCIPAL (Oculto por defecto) -->
    <div id="app-content">
        <!-- Header -->
        <header class="sticky top-0 z-40 bg-black/80 backdrop-blur-md border-b border-white/5 px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <img src="https://files.catbox.moe/ap1lh0.png" alt="Logo" class="h-8 w-auto">
                <span class="font-bold text-lg tracking-tight font-[Poppins] text-orange-500">Social</span>
            </div>
            <a href="profile.html" class="w-9 h-9 rounded-full overflow-hidden border border-gray-600 block relative touch-feedback">
                <img id="current-user-avatar" src="https://placehold.co/100x100/333/fff?text=U" class="w-full h-full object-cover">
            </a>
        </header>

        <main class="container mx-auto max-w-lg px-2 sm:px-4 py-4">
            <!-- Upload Section -->
            <div class="feed-card upload-card p-4 rounded-2xl mb-6">
                <div class="flex gap-3 items-center mb-2">
                    <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-700 flex-shrink-0 self-start mt-1">
                        <img id="post-avatar" src="https://placehold.co/100x100/333/fff?text=U" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 relative">
                        <textarea id="post-text" rows="1" class="w-full bg-transparent text-white placeholder-gray-500 resize-none focus:outline-none text-sm py-2 min-h-[40px]" placeholder="¿Qué quieres compartir?" onfocus="expandPostArea()" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    </div>
                    <label class="flex items-center justify-center text-orange-500 cursor-pointer active:scale-90 transition p-2 rounded-full bg-gray-800 hover:bg-gray-700 border border-gray-700">
                        <i class="fas fa-image text-lg"></i>
                        <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileSelect(event); expandPostArea()">
                    </label>
                </div>
                <div id="preview-container" class="relative hidden mt-3 rounded-xl overflow-hidden border border-gray-700 group">
                    <img id="image-preview" src="" class="w-full h-auto max-h-64 object-contain bg-black">
                    <button onclick="clearSelection()" class="absolute top-2 right-2 bg-black/60 text-white rounded-full p-2 w-8 h-8 flex items-center justify-center active:scale-90 transition z-10"><i class="fas fa-times"></i></button>
                </div>
                <div id="extra-fields">
                    <div class="flex flex-col gap-3">
                        <input type="text" id="post-title" placeholder="Título de tu obra (Opcional)" class="custom-input font-bold bg-black/20 border-gray-700">
                        <div class="flex gap-2">
                            <input type="text" id="post-tags" placeholder="Tags: anime, arte..." class="custom-input flex-1 bg-black/20 border-gray-700">
                            <div class="relative w-2/5">
                                <div class="absolute left-3 top-1/2 -translate-y-1/2 text-orange-500 pointer-events-none"><i class="fas fa-list text-sm"></i></div>
                                <select id="post-category" class="custom-input bg-black/20 border-gray-700 appearance-none pl-9 text-xs">
                                    <option value="" disabled selected>Categoría</option>
                                    <option value="anime">Anime</option>
                                    <option value="furry">Furry</option>
                                    <option value="realismo">Realismo</option>
                                    <option value="mecas">Mecas</option>
                                    <option value="devils">Devils</option>
                                    <option value="colors">ColorFull</option>
                                    <option value="amateur">Amateur</option>
                                    <option value="tvgames">TV/Games</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-2 pt-2 border-t border-white/5">
                            <button onclick="collapsePostArea()" class="flex-1 py-2 rounded-full text-gray-400 text-sm font-semibold hover:text-white hover:bg-gray-800 transition">Cancelar</button>
                            <button id="publish-btn" onclick="uploadPost()" class="bg-orange-600 active:scale-95 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg shadow-orange-500/20 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2 justify-center flex-[2]"><span>Publicar</span> <i class="fas fa-paper-plane text-xs"></i></button>
                        </div>
                    </div>
                </div>
                <div id="upload-progress" class="hidden w-full bg-gray-800 rounded-full h-1 mt-3 overflow-hidden"><div class="bg-orange-500 h-1 rounded-full w-1/3 animate-pulse"></div></div>
            </div>

            <!-- Toggles -->
            <div class="flex justify-center gap-4 mb-6 bg-gray-900/50 p-1 rounded-lg mx-auto w-fit border border-gray-800">
                <button onclick="switchView('feed')" id="btn-view-feed" class="toggle-btn active px-4 py-2 rounded-md text-sm font-semibold transition-all flex items-center gap-2 active:scale-95"><i class="fas fa-stream"></i> Feed</button>
                <button onclick="switchView('grid')" id="btn-view-grid" class="toggle-btn px-4 py-2 rounded-md text-sm font-semibold transition-all flex items-center gap-2 active:scale-95"><i class="fas fa-th"></i> Grid</button>
            </div>

            <div id="feed-list-container" class="flex flex-col gap-4 pb-20">
                <div class="feed-card p-4 animate-pulse">
                    <div class="flex items-center gap-3 mb-4"><div class="w-10 h-10 bg-gray-700 rounded-full"></div><div class="flex-1 space-y-2"><div class="h-4 bg-gray-700 rounded w-1/3"></div></div></div><div class="h-48 bg-gray-800 rounded-lg mb-3"></div>
                </div>
            </div>
            <div id="grid-view-container" class="grid-mode-container hidden pb-20"></div>
        </main>

        <!-- Modals -->
        <div id="modal" class="modal-backdrop">
            <button id="close-modal" class="absolute top-4 right-4 z-[2010] h-12 w-12 flex items-center justify-center rounded-full bg-gray-800/80 text-white active:scale-90 transition backdrop-blur-md"><i class="fas fa-times text-xl"></i></button>
            <div class="h-full w-full flex items-center justify-center p-4">
                <div class="w-full max-w-4xl flex flex-col items-center max-h-[90vh]">
                    <div class="relative w-full flex-1 flex items-center justify-center bg-black/50 rounded-xl overflow-hidden">
                        <img id="modal-image" src="" class="max-w-full max-h-[80vh] object-contain shadow-2xl">
                    </div>
                    <div class="mt-4 text-center p-4 bg-black/80 rounded-xl backdrop-blur-md border border-white/10 w-full max-w-2xl">
                        <h3 id="modal-title" class="text-orange-400 font-bold text-xl font-[Poppins]"></h3>
                        <div class="flex justify-center gap-2 my-2 flex-wrap" id="modal-tags"></div>
                        <p id="modal-desc" class="text-gray-300 text-sm"></p>
                        <div class="flex items-center justify-center gap-2 mt-3 pt-3 border-t border-gray-700 cursor-pointer active:opacity-50 transition" id="modal-user-link">
                            <img id="modal-user-pic" src="" class="w-8 h-8 rounded-full object-cover">
                            <span id="modal-user-name" class="text-sm text-gray-400 font-semibold"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="edit-modal" class="modal-backdrop">
            <div class="bg-[#1a1a1c] w-full max-w-md rounded-2xl p-6 m-4 border border-gray-700 shadow-2xl">
                <h3 class="text-xl font-bold text-white mb-4">Editar Publicación</h3>
                <input type="hidden" id="edit-post-id">
                <label class="block text-xs text-gray-400 mb-1">Título</label><input type="text" id="edit-title" class="custom-input mb-3">
                <label class="block text-xs text-gray-400 mb-1">Texto</label><textarea id="edit-text" rows="3" class="custom-input mb-3 resize-none"></textarea>
                <div class="flex gap-2 mb-3">
                    <div class="flex-1"><label class="block text-xs text-gray-400 mb-1">Tags</label><input type="text" id="edit-tags" class="custom-input"></div>
                    <div class="w-2/5"><label class="block text-xs text-gray-400 mb-1">Categoría</label><select id="edit-category" class="custom-input bg-[#1a1a1c]"><option value="anime">Anime</option><option value="furry">Furry</option><option value="realismo">Real</option><option value="mecas">Mecas</option><option value="devils">Devils</option><option value="colors">Color</option><option value="amateur">Amateur</option><option value="tvgames">Games</option></select></div>
                </div>
                <div class="flex gap-3 mt-6"><button onclick="closeEditModal()" class="flex-1 py-3 rounded-xl border border-gray-600 text-gray-300 active:bg-gray-800 font-semibold">Cancelar</button><button onclick="saveEditPost()" class="flex-1 py-3 rounded-xl bg-orange-600 text-white font-bold active:bg-orange-500">Guardar</button></div>
            </div>
        </div>

        <nav class="bottom-nav fixed bottom-0 left-0 right-0 z-[100] flex h-20 justify-around items-center px-2">
            <a href="index.html" class="nav-item flex flex-col items-center justify-center text-center p-2 w-1/3"><i class="fas fa-th-large text-xl mb-1"></i><span class="text-[10px] font-semibold">Galería</span></a>
            <a href="feed.html" class="nav-item active flex flex-col items-center justify-center text-center p-2 w-1/3"><i class="fas fa-globe-americas text-xl mb-1"></i><span class="text-[10px] font-semibold">Social</span></a>
            <a href="profile.html" class="nav-item flex flex-col items-center justify-center text-center p-2 w-1/3"><i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-semibold">Perfil</span></a>
        </nav>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8", authDomain: "exene-53e6b.firebaseapp.com", databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com", projectId: "exene-53e6b", storageBucket: "exene-53e6b.appspot.com", messagingSenderId: "481369419867", appId: "1:481369419867:web:ac5db24c436344262c8f7e" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const CATBOX_USERHASH = "341adb9d3c2d09d0485aa908c";

        let currentUser = null;
        let selectedFile = null;
        const userProfileCache = {};
        let userDataCache = {};
        let isUploadingAuth = false;

        let deviceID = localStorage.getItem('deviceID');
        if (!deviceID) { deviceID = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); localStorage.setItem('deviceID', deviceID); }

        // --- LÓGICA ANTI-FLASHASO ---
        auth.onAuthStateChanged(user => {
            const loader = document.getElementById('initial-loader');
            const authOverlay = document.getElementById('auth-overlay');
            const appContent = document.getElementById('app-content');

            if (user && !user.isAnonymous) {
                // 1. USUARIO LOGUEADO -> Mostrar APP
                currentUser = user;
                appContent.style.display = 'block'; // Mostramos app
                authOverlay.style.display = 'none'; // Aseguramos que el login esté oculto
                
                db.ref('users/' + user.uid).on('value', snap => {
                    const data = snap.val();
                    if(data && data.profilePic) {
                        document.getElementById('current-user-avatar').src = data.profilePic;
                        document.getElementById('post-avatar').src = data.profilePic;
                    }
                });
            } else {
                // 2. SIN SESIÓN -> Mostrar LOGIN
                currentUser = null;
                appContent.style.display = 'none'; // Ocultamos app
                authOverlay.style.display = 'flex'; // Mostramos login
            }
            
            // 3. Ocultar el Loader FINALMENTE (Transición suave opcional)
            loader.style.opacity = '0';
            setTimeout(() => { loader.style.display = 'none'; }, 500);
            
            loadFeed();
        });

        // --- AUTH UI LOGIC ---
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('login-form'); const regStep1 = document.getElementById('register-step-1'); const regStep2 = document.getElementById('register-step-2');
            const tabLogin = document.getElementById('tab-login'); const tabRegister = document.getElementById('tab-register');
            document.getElementById('login-error').classList.add('hidden'); document.getElementById('reg-error').classList.add('hidden'); document.getElementById('step1-error').classList.add('hidden');
            if (tab === 'login') {
                loginForm.style.display = 'flex'; regStep1.style.display = 'none'; regStep2.style.display = 'none';
                tabLogin.className = "text-orange-500 border-b-2 border-orange-500 pb-1 transition-colors"; tabRegister.className = "text-gray-400 pb-1 hover:text-white transition-colors";
            } else {
                loginForm.style.display = 'none'; regStep1.style.display = 'flex'; regStep2.style.display = 'none';
                tabLogin.className = "text-gray-400 pb-1 hover:text-white transition-colors"; tabRegister.className = "text-orange-500 border-b-2 border-orange-500 pb-1 transition-colors";
            }
        }

        async function handleAuthFileUpload(event) {
            const file = event.target.files[0]; if (!file || file.size > 5 * 1024 * 1024) { alert("Máx 5MB"); return; }
            const statusEl = document.getElementById('upload-status'); const previewImg = document.getElementById('auth-preview-img'); const btn = document.getElementById('btn-step-1');
            isUploadingAuth = true; btn.disabled = true; btn.classList.add('opacity-50');
            statusEl.innerHTML = '<i class="fas fa-spinner upload-spinner text-orange-500"></i> Subiendo...'; previewImg.src = URL.createObjectURL(file);
            try {
                const formData = new FormData(); formData.append('reqtype', 'fileupload'); formData.append('userhash', CATBOX_USERHASH); formData.append('fileToUpload', file);
                const res = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", { method: 'POST', body: formData });
                if (!res.ok) throw new Error("Error red"); const url = await res.text();
                if (url.includes('catbox.moe')) { document.getElementById('reg-photo-url').value = url.trim(); statusEl.innerHTML = '<span class="text-green-400"><i class="fas fa-check"></i> Listo</span>'; } else throw new Error("Error API");
            } catch (e) { console.error(e); statusEl.innerHTML = '<span class="text-red-400">Error</span>'; } finally { isUploadingAuth = false; btn.disabled = false; btn.classList.remove('opacity-50'); }
        }

        async function validateAuthStep1() {
            const name = document.getElementById('reg-name').value.trim(); const age = parseInt(document.getElementById('reg-age').value); const photoUrl = document.getElementById('reg-photo-url').value;
            const errorEl = document.getElementById('step1-error'); const btn = document.getElementById('btn-step-1');
            errorEl.classList.add('hidden');
            if (!name || !age) { errorEl.textContent = "Completa todos los campos."; errorEl.classList.remove('hidden'); return; }
            if (!photoUrl && !isUploadingAuth) { errorEl.textContent = "Sube foto de perfil."; errorEl.classList.remove('hidden'); return; }
            if (isUploadingAuth) return;
            if (age < 18) { document.getElementById('age-alert-modal').style.display = 'flex'; return; }
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner upload-spinner"></i>';
            const snap = await db.ref('users').orderByChild('username').equalTo(name).once('value');
            if (snap.exists()) { errorEl.textContent = "Nombre de usuario ocupado."; errorEl.classList.remove('hidden'); btn.disabled = false; btn.innerHTML = 'Continuar <i class="fas fa-arrow-right ml-1"></i>'; return; }
            userDataCache = { name, age, photo: photoUrl };
            document.getElementById('register-step-1').style.display = 'none'; document.getElementById('register-step-2').style.display = 'flex'; btn.disabled = false;
        }

        function authBackToStep1() { document.getElementById('register-step-2').style.display = 'none'; document.getElementById('register-step-1').style.display = 'flex'; }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value; const pass = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error'); const btn = document.getElementById('btn-login-submit');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner upload-spinner"></i>'; errorEl.classList.add('hidden');
            auth.signInWithEmailAndPassword(email, pass).catch(err => { btn.disabled = false; btn.innerHTML = '<span>Entrar</span>'; errorEl.textContent = "Error: " + err.message; errorEl.classList.remove('hidden'); });
        });

        document.getElementById('register-step-2').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value; const pass = document.getElementById('reg-password').value; const confirm = document.getElementById('reg-confirm-password').value;
            const errorEl = document.getElementById('reg-error'); const btn = document.getElementById('btn-register-final');
            if (pass !== confirm) { errorEl.textContent = "Contraseñas no coinciden"; errorEl.classList.remove('hidden'); return; }
            if (pass.length < 6) { errorEl.textContent = "Mínimo 6 caracteres"; errorEl.classList.remove('hidden'); return; }
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner upload-spinner"></i>';
            auth.createUserWithEmailAndPassword(email, pass).then((cred) => {
                return db.ref('users/' + cred.user.uid).set({ username: userDataCache.name, age: userDataCache.age, profilePic: userDataCache.photo, email: email, slogan: "Bienvenido a mi espacio en exen-E." });
            }).catch(err => { btn.disabled = false; btn.innerHTML = '<span>Finalizar</span>'; errorEl.textContent = err.message; errorEl.classList.remove('hidden'); });
        });

        // --- FUNCIONES FEED ---
        function expandPostArea() { const area = document.getElementById('extra-fields'); const text = document.getElementById('post-text'); if (!area.classList.contains('expanded')) { area.classList.add('expanded'); text.rows = 3; } }
        function collapsePostArea() { const area = document.getElementById('extra-fields'); const text = document.getElementById('post-text'); if (!text.value && !document.getElementById('post-title').value && !selectedFile) { area.classList.remove('expanded'); text.rows = 1; } else { if(confirm("¿Descartar?")) { clearSelection(); text.value = ''; document.getElementById('post-title').value=''; document.getElementById('post-tags').value=''; document.getElementById('post-category').selectedIndex=0; area.classList.remove('expanded'); text.rows=1; } } }
        function handleFileSelect(event) { const file = event.target.files[0]; if (file) { if (file.size > 5*1024*1024) { alert("Máx 5MB"); return; } selectedFile = file; document.getElementById('image-preview').src = URL.createObjectURL(file); document.getElementById('preview-container').classList.remove('hidden'); } }
        function clearSelection() { selectedFile = null; document.getElementById('file-input').value = ""; document.getElementById('preview-container').classList.add('hidden'); document.getElementById('image-preview').src = ""; }

        async function uploadPost() {
            const text = document.getElementById('post-text').value.trim(); const title = document.getElementById('post-title').value.trim(); const tags = document.getElementById('post-tags').value.trim(); const category = document.getElementById('post-category').value;
            const btn = document.getElementById('publish-btn'); const progress = document.getElementById('upload-progress');
            if ((!text && !selectedFile)) { alert("Escribe algo o sube una foto."); return; }
            if (selectedFile && (!title || !tags || !category)) { alert("Para imágenes: Título, Tags y Categoría requeridos."); return; }
            btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`; progress.classList.remove('hidden');
            try {
                let imageUrl = null;
                if (selectedFile) {
                    const formData = new FormData(); formData.append('reqtype', 'fileupload'); formData.append('userhash', CATBOX_USERHASH); formData.append('fileToUpload', selectedFile);
                    const response = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", { method: 'POST', body: formData });
                    if (!response.ok) throw new Error("Error subiendo"); const txt = await response.text(); if (txt.includes('catbox.moe')) imageUrl = txt.trim(); else throw new Error("Error servidor img");
                }
                const userData = currentUser ? (await db.ref('users/' + currentUser.uid).once('value')).val() : null;
                const newPost = { text: text, imageUrl: imageUrl || null, title: title || null, tags: tags || null, category: category || null, userId: currentUser ? currentUser.uid : 'anon', userName: userData ? userData.username : 'Anónimo', userAvatar: userData ? userData.profilePic : 'https://placehold.co/100x100/333/fff?text=A', timestamp: firebase.database.ServerValue.TIMESTAMP, likes: 0 };
                await db.ref('feed_posts').push(newPost);
                document.getElementById('post-text').value = ''; document.getElementById('post-title').value = ''; document.getElementById('post-tags').value = ''; document.getElementById('post-category').selectedIndex = 0; clearSelection();
                document.getElementById('extra-fields').classList.remove('expanded'); document.getElementById('post-text').rows = 1;
            } catch (error) { alert("Error: " + error.message); } finally { btn.disabled = false; btn.innerHTML = `<span>Publicar</span> <i class="fas fa-paper-plane text-xs"></i>`; progress.classList.add('hidden'); }
        }

        function toggleOptionsMenu(postId) { const menu = document.getElementById(`options-menu-${postId}`); document.querySelectorAll('.options-menu').forEach(m => { if (m.id !== `options-menu-${postId}`) m.classList.remove('show'); }); menu.classList.toggle('show'); }
        document.addEventListener('click', (e) => { if (!e.target.closest('.options-trigger')) { document.querySelectorAll('.options-menu').forEach(m => m.classList.remove('show')); } });
        function deletePost(postId) { if (confirm("¿Eliminar publicación?")) { db.ref('feed_posts/' + postId).remove(); db.ref('feed_comments/' + postId).remove(); db.ref('feed_likes/' + postId).remove(); } }
        function openEditModal(postId, title, text, tags, category) { document.getElementById('edit-post-id').value = postId; document.getElementById('edit-title').value = title === 'null' ? '' : title; document.getElementById('edit-text').value = text; document.getElementById('edit-tags').value = tags === 'null' ? '' : tags; const catSelect = document.getElementById('edit-category'); if (category && category !== 'null') catSelect.value = category; else catSelect.selectedIndex = 0; document.getElementById('edit-modal').classList.add('visible'); }
        function closeEditModal() { document.getElementById('edit-modal').classList.remove('visible'); }
        function saveEditPost() { const postId = document.getElementById('edit-post-id').value; if (!postId) return; const updates = { title: document.getElementById('edit-title').value.trim() || null, text: document.getElementById('edit-text').value.trim() || null, tags: document.getElementById('edit-tags').value.trim() || null, category: document.getElementById('edit-category').value || null }; db.ref('feed_posts/' + postId).update(updates).then(() => closeEditModal()); }
        function switchView(mode) { const feedContainer = document.getElementById('feed-list-container'); const gridContainer = document.getElementById('grid-view-container'); const btnFeed = document.getElementById('btn-view-feed'); const btnGrid = document.getElementById('btn-view-grid'); if (mode === 'feed') { feedContainer.classList.remove('hidden'); gridContainer.classList.add('hidden'); btnFeed.classList.add('active'); btnGrid.classList.remove('active'); } else { feedContainer.classList.add('hidden'); gridContainer.classList.remove('hidden'); btnFeed.classList.remove('active'); btnGrid.classList.add('active'); } }
        
        function loadFeed() {
            const feedContainer = document.getElementById('feed-list-container'); const gridContainer = document.getElementById('grid-view-container');
            db.ref('feed_posts').orderByChild('timestamp').limitToLast(50).on('value', snapshot => {
                feedContainer.innerHTML = ''; gridContainer.innerHTML = '';
                if(!snapshot.exists()) { feedContainer.innerHTML = `<div class="text-center text-gray-500 py-10">Sé el primero.</div>`; return; }
                const posts = []; snapshot.forEach(child => { posts.push({ id: child.key, ...child.val() }); });
                posts.reverse().forEach(post => { feedContainer.appendChild(createPostCard(post)); if (post.imageUrl) gridContainer.appendChild(createGridItem(post)); updateUserAvatarInUI(post.userId); });
            });
        }

        function updateUserAvatarInUI(userId) { if (userProfileCache[userId]) applyAvatarToDOM(userId, userProfileCache[userId]); else db.ref('users/' + userId + '/profilePic').once('value').then(snap => { const pic = snap.val() || 'https://placehold.co/100x100/333/fff?text=A'; userProfileCache[userId] = pic; applyAvatarToDOM(userId, pic); }); }
        function applyAvatarToDOM(userId, picUrl) { document.querySelectorAll(`.user-avatar-${userId}`).forEach(img => { if(img.src !== picUrl) img.src = picUrl; }); }

        function createPostCard(post) {
            const div = document.createElement('div'); div.className = "feed-card opacity-0 animate-[fadeIn_0.5s_ease-out_forwards]";
            let metaChips = ''; if (post.category) metaChips += `<span class="text-[10px] bg-orange-900/50 text-orange-300 px-2 py-0.5 rounded border border-orange-500/30">${post.category}</span>`;
            if (post.title) metaChips += `<span class="text-[10px] font-bold text-white ml-2 truncate max-w-[120px] inline-block align-bottom">${post.title}</span>`;
            const isOwner = currentUser && currentUser.uid === post.userId;
            let optionsBtn = '';
            if (isOwner) { const safeTitle = (post.title||'').replace(/'/g,"\\'"); const safeText = (post.text||'').replace(/'/g,"\\'"); const safeTags = (post.tags||'').replace(/'/g,"\\'"); optionsBtn = `<button onclick="toggleOptionsMenu('${post.id}')" class="options-trigger text-gray-400 active:text-white p-2 px-3"><i class="fas fa-ellipsis-v options-trigger"></i></button><div id="options-menu-${post.id}" class="options-menu"><div class="options-item" onclick="openEditModal('${post.id}', '${safeTitle}', '${safeText}', '${safeTags}', '${post.category||''}')"><i class="fas fa-edit"></i> Editar</div><div class="options-item delete" onclick="deletePost('${post.id}')"><i class="fas fa-trash"></i> Eliminar</div></div>`; }
            const hasImage = post.imageUrl ? `<div class="mt-2 -mx-4 bg-black relative cursor-pointer" onclick="openViewer('${post.imageUrl}', '${(post.title||'').replace(/'/g,"\\'")}', '${(post.text||'').replace(/'/g,"\\'")}', '${post.userName}', '${(post.tags||'').replace(/'/g,"\\'")}', '${post.userAvatar}', '${post.userId}')"><img src="${post.imageUrl}" class="w-full h-auto max-h-[500px] object-contain" loading="lazy"></div>` : '';
            const textContent = post.text ? `<p class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap mt-1">${post.text}</p>` : '';
            div.innerHTML = `<div class="p-4"><div class="flex justify-between items-start mb-2 relative"><div class="flex gap-3 items-center"><a href="profile.html?uid=${post.userId}"><img src="${post.userAvatar}" class="w-10 h-10 rounded-full object-cover border border-gray-700 user-avatar-${post.userId} active:scale-95 transition"></a><div><a href="profile.html?uid=${post.userId}" class="font-bold text-gray-200 text-sm active:text-orange-400 transition block">${post.userName}</a><span class="text-xs text-gray-500 block">${timeAgo(post.timestamp)}</span></div></div><div class="flex items-center gap-3">${metaChips}${optionsBtn}</div></div>${textContent}</div>${hasImage}<div class="px-4 py-3 flex items-center justify-between border-t border-white/5 mt-1"><div class="flex gap-6"><button id="like-btn-${post.id}" onclick="toggleLike('${post.id}')" class="flex items-center gap-2 text-gray-400 active:text-red-500 transition group"><i class="far fa-heart text-lg group-active:scale-125 transition-transform"></i><span class="text-xs font-bold" id="likes-count-${post.id}">${post.likes || 0}</span></button><button onclick="toggleComments('${post.id}')" class="flex items-center gap-2 text-gray-400 active:text-blue-400 transition"><i class="far fa-comment text-lg"></i><span class="text-xs font-bold">Comentar</span></button></div></div><div id="comments-${post.id}" class="hidden px-4 py-3 bg-[#0f0f10] border-t border-white/5"><div id="comments-list-${post.id}" class="flex flex-col gap-3 mb-3 max-h-60 overflow-y-auto"></div><form onsubmit="postComment(event, '${post.id}')" class="flex gap-2 relative"><input type="text" id="comment-input-${post.id}" class="w-full bg-gray-800 rounded-full px-4 py-2 text-sm text-white focus:outline-none focus:ring-1 focus:ring-orange-500" placeholder="Comentario..." required autocomplete="off"><button type="submit" class="absolute right-1 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center bg-orange-600 rounded-full text-white active:scale-90 transition"><i class="fas fa-paper-plane text-xs"></i></button></form></div>`;
            checkLikeStatus(post.id); return div;
        }

        function createGridItem(post) {
            const div = document.createElement('div'); div.className = 'grid-item group'; div.onclick = () => openViewer(post.imageUrl, post.title, post.text, post.userName, post.tags, post.userAvatar, post.userId);
            div.innerHTML = `<img src="${post.imageUrl}" loading="lazy"><div class="grid-overlay"><div class="w-full"><div class="flex justify-between text-white text-[10px] font-bold drop-shadow-md"><span><i class="fas fa-heart text-xs text-red-500"></i> ${post.likes || 0}</span></div></div></div>`; return div;
        }

        function openViewer(url, title, desc, user, tags, avatar, uid) {
            document.getElementById('modal-image').src = url; document.getElementById('modal-title').textContent = title || ''; document.getElementById('modal-desc').textContent = desc || '';
            document.getElementById('modal-user-name').textContent = user; document.getElementById('modal-user-pic').src = avatar; document.getElementById('modal-user-link').onclick = () => window.location.href = `profile.html?uid=${uid}`;
            const tagsContainer = document.getElementById('modal-tags'); tagsContainer.innerHTML = ''; if (tags && tags !== 'null') { tags.split(',').forEach(tag => { const span = document.createElement('span'); span.className = "text-[10px] bg-gray-800 text-gray-300 px-2 py-1 rounded-full border border-gray-700"; span.textContent = '#' + tag.trim(); tagsContainer.appendChild(span); }); }
            document.getElementById('modal').classList.add('visible'); document.body.style.overflow = 'hidden';
        }
        document.getElementById('close-modal').addEventListener('click', () => { document.getElementById('modal').classList.remove('visible'); document.body.style.overflow = 'auto'; });

        function toggleComments(postId) { const section = document.getElementById(`comments-${postId}`); if (section.classList.contains('hidden')) { section.classList.remove('hidden'); loadComments(postId, document.getElementById(`comments-list-${postId}`)); } else { section.classList.add('hidden'); db.ref(`feed_comments/${postId}`).off(); } }
        function postComment(event, postId) { event.preventDefault(); const input = document.getElementById(`comment-input-${postId}`); const text = input.value.trim(); if (!text) return; const uid = currentUser ? currentUser.uid : 'anon'; db.ref(`users/${uid}`).once('value').then(snap => { const dbUser = snap.val(); const newComment = { text: text, userId: uid, userName: dbUser ? dbUser.username : 'Anónimo', userAvatar: dbUser ? dbUser.profilePic : 'https://placehold.co/100x100/333/fff?text=A', timestamp: firebase.database.ServerValue.TIMESTAMP }; db.ref(`feed_comments/${postId}`).push(newComment); input.value = ''; }); }
        function loadComments(postId, container) { db.ref(`feed_comments/${postId}`).orderByChild('timestamp').on('value', snap => { container.innerHTML = ''; if (!snap.exists()) { container.innerHTML = '<p class="text-xs text-gray-600 text-center py-2">Sé el primero en comentar</p>'; return; } snap.forEach(child => { const c = child.val(); const div = document.createElement('div'); div.className = "flex gap-2 items-start"; div.innerHTML = `<img src="${c.userAvatar}" class="w-6 h-6 rounded-full object-cover mt-1"><div class="bg-gray-800 rounded-lg rounded-tl-none px-3 py-2 flex-1"><p class="text-xs font-bold text-gray-300">${c.userName}</p><p class="text-xs text-gray-400 break-words">${c.text}</p></div>`; container.appendChild(div); }); container.scrollTop = container.scrollHeight; }); }
        function toggleLike(postId) { const userId = currentUser ? currentUser.uid : deviceID; const likeRef = db.ref(`feed_likes/${postId}/${userId}`); const postRef = db.ref(`feed_posts/${postId}/likes`); likeRef.once('value', snap => { if (snap.exists()) { likeRef.remove(); postRef.transaction(c => (c || 1) - 1); } else { likeRef.set(true); postRef.transaction(c => (c || 0) + 1); } }); }
        function checkLikeStatus(postId) { const userId = currentUser ? currentUser.uid : deviceID; db.ref(`feed_likes/${postId}/${userId}`).on('value', snap => updateLikeBtnUI(postId, snap.exists())); }
        function updateLikeBtnUI(postId, isLiked) { const btn = document.getElementById(`like-btn-${postId}`); if(!btn) return; const icon = btn.querySelector('i'); if (isLiked) { icon.className = 'fas fa-heart text-lg text-red-500 like-anim'; btn.classList.add('text-red-500'); } else { icon.className = 'far fa-heart text-lg group-active:scale-125 transition-transform'; btn.classList.remove('text-red-500'); } }
        function timeAgo(timestamp) { const seconds = Math.floor((new Date() - timestamp) / 1000); if (seconds < 60) return "Hace un momento"; const m = Math.floor(seconds / 60); if (m < 60) return `${m} min`; const h = Math.floor(m / 60); if (h < 24) return `${h} h`; return Math.floor(h / 24) + " d"; }
        const style = document.createElement('style'); style.innerHTML = `@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }`; document.head.appendChild(style);
    </script>
</body>
</html>