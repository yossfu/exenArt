<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>exen-E | Comunidad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --accent: #f97316; 
            --body-font: 'Inter', sans-serif;
        }
        body { 
            font-family: var(--body-font); 
            background-color: #0c0c0c;
            color: #f3f4f6;
            padding-bottom: 90px;
            min-height: 100vh;
        }
        .feed-card {
            background-color: #161618;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .upload-card {
            background: linear-gradient(145deg, #1a1a1c, #111112);
            border: 1px solid rgba(249, 115, 22, 0.2);
        }
        .bottom-nav {
            background-color: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-item.active { color: var(--accent); }
        .like-anim { animation: likeBounce 0.3s; }
        @keyframes likeBounce { 50% { transform: scale(1.3); } }
        
        /* Estilos Comentarios */
        .comment-item { font-size: 0.9rem; margin-bottom: 0.5rem; }
        .comment-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }
        .hidden-comment { display: none; }
        
        /* Modal */
        #modal { display: none; z-index: 3000; }
        #modal.visible { display: flex; }
        .viewer-frame { max-height: 85vh; max-width: 100%; object-fit: contain; }
    </style>
</head>
<body class="antialiased">

    <header class="sticky top-0 z-40 bg-black/90 backdrop-blur-md border-b border-white/10 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <img src="https://files.catbox.moe/ap1lh0.png" alt="Logo" class="h-8 w-auto">
            <span class="font-bold text-lg text-orange-500 font-[Poppins]">Social</span>
        </div>
        <a href="profile.html" class="w-8 h-8 rounded-full overflow-hidden border border-gray-600">
            <img id="current-user-avatar" src="https://placehold.co/100x100/333/fff?text=U" class="w-full h-full object-cover">
        </a>
    </header>

    <main class="container mx-auto max-w-lg px-2 sm:px-4 py-4">
        <!-- Upload -->
        <div class="feed-card upload-card p-4 rounded-2xl mb-6">
            <div class="flex gap-3 mb-3">
                <img id="post-avatar" src="https://placehold.co/100x100/333/fff?text=U" class="w-10 h-10 rounded-full object-cover">
                <textarea id="post-text" rows="2" placeholder="¿Qué estás pensando?" class="w-full bg-transparent text-white placeholder-gray-500 resize-none focus:outline-none text-sm py-2"></textarea>
            </div>
            <div id="preview-container" class="relative hidden mb-3">
                <img id="image-preview" src="" class="w-full h-48 object-cover rounded-lg">
                <button onclick="clearSelection()" class="absolute top-2 right-2 bg-black/60 text-white rounded-full w-6 h-6 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex justify-between items-center border-t border-white/10 pt-3">
                <label class="text-orange-500 cursor-pointer flex items-center gap-2 text-sm font-bold">
                    <i class="fas fa-image text-lg"></i> Foto
                    <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                </label>
                <button id="publish-btn" onclick="uploadPost()" class="bg-orange-600 text-white px-5 py-1.5 rounded-full text-sm font-bold disabled:opacity-50">Publicar</button>
            </div>
            <div id="upload-status" class="hidden mt-2 text-xs text-orange-400 text-center"><i class="fas fa-spinner fa-spin"></i> Subiendo...</div>
        </div>

        <!-- Feed -->
        <div id="feed-container" class="flex flex-col gap-4 pb-20"></div>
        
        <div id="load-more-btn" class="text-center hidden pb-24">
            <button onclick="loadMorePosts()" class="text-orange-500 text-sm font-bold">Cargar más posts</button>
        </div>
    </main>

    <!-- Modal Viewer -->
    <div id="modal" class="fixed inset-0 bg-black/90 flex items-center justify-center p-2 opacity-0 transition-opacity duration-300">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-white text-2xl z-50"><i class="fas fa-times"></i></button>
        <div class="w-full max-w-md h-full flex flex-col bg-[#111] rounded-xl overflow-hidden">
            <div class="flex-1 flex items-center justify-center bg-black relative">
                <img id="modal-img" class="viewer-frame">
                <button id="modal-delete-btn" class="absolute top-4 right-4 bg-red-600 p-2 rounded-full text-white hidden" title="Borrar"><i class="fas fa-trash"></i></button>
            </div>
            <div class="p-4 bg-[#161618] border-t border-white/10 flex flex-col h-1/2">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 id="modal-user" class="font-bold text-orange-500"></h3>
                        <p id="modal-desc" class="text-sm text-gray-300 line-clamp-2"></p>
                    </div>
                    <div class="flex gap-4 text-xl">
                        <button id="modal-like-btn"><i class="far fa-heart"></i></button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto mb-2" id="modal-comments-list"></div>
                <form onsubmit="submitModalComment(event)" class="flex gap-2">
                    <input id="modal-comment-input" type="text" class="flex-1 bg-gray-800 rounded-full px-4 py-2 text-sm text-white focus:outline-none border border-gray-700" placeholder="Escribe un comentario..." autocomplete="off">
                    <button type="submit" class="text-orange-500"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>

    <nav class="bottom-nav fixed bottom-0 w-full h-16 flex justify-around items-center z-50">
        <a href="index.html" class="nav-item text-gray-400 flex flex-col items-center"><i class="fas fa-th-large text-xl"></i><span class="text-[10px]">Galería</span></a>
        <a href="feed.html" class="nav-item active flex flex-col items-center"><i class="fas fa-globe-americas text-xl"></i><span class="text-[10px]">Social</span></a>
        <a href="profile.html" class="nav-item text-gray-400 flex flex-col items-center"><i class="fas fa-user text-xl"></i><span class="text-[10px]">Perfil</span></a>
    </nav>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8", authDomain: "exene-53e6b.firebaseapp.com", databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com", projectId: "exene-53e6b", storageBucket: "exene-53e6b.appspot.com", messagingSenderId: "481369419867", appId: "1:481369419867:web:ac5db24c436344262c8f7e" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentUser = null;
        let selectedFile = null;
        const CATBOX_USERHASH = "341adb9d3c2d09d0485aa908c";
        let lastKey = null;
        let activeCommentListeners = {};

        // Auth
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                if(!user.isAnonymous) {
                    db.ref('users/' + user.uid).once('value').then(snap => {
                        const d = snap.val();
                        if(d && d.profilePic) {
                            document.getElementById('current-user-avatar').src = d.profilePic;
                            document.getElementById('post-avatar').src = d.profilePic;
                        }
                    });
                }
                loadFeed();
            } else {
                firebase.auth().signInAnonymously();
            }
        });

        // Carga del Feed
        function loadFeed() {
            db.ref('feed_posts').orderByChild('timestamp').limitToLast(10).on('child_added', snapshot => {
                const post = { id: snapshot.key, ...snapshot.val() };
                renderPost(post, true); // true = prepend
                if(!lastKey) lastKey = post.timestamp;
                if(post.timestamp < lastKey) lastKey = post.timestamp;
            });
            document.getElementById('load-more-btn').classList.remove('hidden');
        }

        function loadMorePosts() {
            // Implementación simple de paginación manual si se requiere
            // Por ahora el child_added maneja el stream principal
            alert("Funcionalidad de historial completo en proceso.");
        }

        function renderPost(post, prepend) {
            if(document.getElementById(`post-${post.id}`)) return; // Evitar duplicados

            const div = document.createElement('div');
            div.id = `post-${post.id}`;
            div.className = "feed-card p-4";
            
            const isOwner = currentUser && currentUser.uid === post.userId;
            const deleteHtml = isOwner ? `<button onclick="deletePost('${post.id}')" class="text-gray-600 hover:text-red-500"><i class="fas fa-trash"></i></button>` : '';
            
            let mediaHtml = '';
            if(post.imageUrl) {
                mediaHtml = `<div class="mt-3 -mx-4 bg-black cursor-pointer" onclick="openModal('${post.id}')">
                    <img src="${post.imageUrl}" class="w-full max-h-[500px] object-contain mx-auto">
                </div>`;
            }

            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex gap-3">
                        <img src="${post.userAvatar || 'https://placehold.co/50'}" class="w-10 h-10 rounded-full object-cover">
                        <div>
                            <h4 class="font-bold text-white text-sm">${post.userName}</h4>
                            <span class="text-xs text-gray-500">${new Date(post.timestamp).toLocaleDateString()}</span>
                        </div>
                    </div>
                    ${deleteHtml}
                </div>
                <p class="text-gray-200 text-sm mt-2 whitespace-pre-wrap">${post.text || ''}</p>
                ${mediaHtml}
                
                <div class="flex items-center gap-6 mt-3 pt-3 border-t border-white/5">
                    <button id="btn-like-${post.id}" onclick="toggleLike('${post.id}')" class="flex items-center gap-2 text-gray-400 hover:text-red-500 transition">
                        <i class="far fa-heart text-lg"></i> <span id="count-like-${post.id}" class="text-xs font-bold">${post.likes || 0}</span>
                    </button>
                    <button onclick="toggleComments('${post.id}')" class="flex items-center gap-2 text-gray-400 hover:text-blue-400 transition">
                        <i class="far fa-comment text-lg"></i> <span id="count-comment-${post.id}" class="text-xs font-bold">${post.commentCount || 0}</span>
                    </button>
                </div>

                <!-- Sección Comentarios -->
                <div id="comments-area-${post.id}" class="hidden mt-3 bg-[#000000] rounded-lg p-3">
                    <div id="list-comments-${post.id}" class="flex flex-col gap-2 mb-3"></div>
                    <button id="btn-more-comments-${post.id}" onclick="expandComments('${post.id}')" class="hidden w-full text-center text-xs text-orange-500 font-bold py-1 hover:underline">Ver todos los comentarios</button>
                    
                    <form onsubmit="submitComment(event, '${post.id}')" class="flex gap-2 mt-2">
                        <input id="input-comment-${post.id}" type="text" class="w-full bg-gray-800 border border-gray-700 rounded-full px-3 py-1.5 text-xs text-white focus:border-orange-500 focus:outline-none" placeholder="Escribe algo..." autocomplete="off">
                        <button type="submit" class="text-orange-500 px-2"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            `;

            const container = document.getElementById('feed-container');
            if(prepend) container.prepend(div); else container.appendChild(div);
            
            checkLikeStatus(post.id);
        }

        // --- SISTEMA DE COMENTARIOS NUEVO ---
        function toggleComments(postId) {
            const area = document.getElementById(`comments-area-${postId}`);
            const list = document.getElementById(`list-comments-${postId}`);
            
            if (area.classList.contains('hidden')) {
                area.classList.remove('hidden');
                // Activar Listener
                if (!activeCommentListeners[postId]) {
                    activeCommentListeners[postId] = true;
                    list.innerHTML = '<div class="text-center text-xs text-gray-500"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>';
                    
                    db.ref(`feed_comments/${postId}`).on('value', snap => {
                        list.innerHTML = '';
                        const comments = [];
                        snap.forEach(c => comments.push(c.val()));
                        
                        // Autocorrección de contador
                        document.getElementById(`count-comment-${postId}`).innerText = comments.length;
                        
                        if(comments.length === 0) {
                            list.innerHTML = '<p class="text-center text-xs text-gray-500 italic">Sin comentarios aún.</p>';
                            document.getElementById(`btn-more-comments-${postId}`).classList.add('hidden');
                        } else {
                            // Mostrar solo los últimos 3 por defecto
                            renderCommentList(postId, comments, false);
                        }
                    });
                }
            } else {
                area.classList.add('hidden');
                // Opcional: db.ref(`feed_comments/${postId}`).off(); para ahorrar recursos
            }
        }

        function renderCommentList(postId, comments, showAll) {
            const list = document.getElementById(`list-comments-${postId}`);
            const btnMore = document.getElementById(`btn-more-comments-${postId}`);
            list.innerHTML = '';

            const toShow = showAll ? comments : comments.slice(-3); // Últimos 3
            
            toShow.forEach(c => {
                const div = document.createElement('div');
                div.className = "flex gap-2 items-start animate-[fadeIn_0.2s]";
                div.innerHTML = `
                    <img src="${c.userAvatar}" class="w-6 h-6 rounded-full object-cover mt-1">
                    <div class="bg-gray-800 rounded-lg px-3 py-1.5 text-xs text-gray-200">
                        <span class="font-bold text-orange-400 block">${c.userName}</span>
                        ${c.text}
                    </div>
                `;
                list.appendChild(div);
            });

            if (!showAll && comments.length > 3) {
                btnMore.classList.remove('hidden');
                btnMore.innerText = `Ver ${comments.length - 3} comentarios más...`;
            } else {
                btnMore.classList.add('hidden');
            }
        }

        function expandComments(postId) {
            db.ref(`feed_comments/${postId}`).once('value', snap => {
                const comments = [];
                snap.forEach(c => comments.push(c.val()));
                renderCommentList(postId, comments, true);
            });
        }

        function submitComment(e, postId) {
            e.preventDefault();
            const input = document.getElementById(`input-comment-${postId}`);
            const text = input.value.trim();
            if (!text) return;

            const uid = currentUser ? currentUser.uid : 'anon';
            
            // Obtener datos del usuario actual antes de enviar
            db.ref(`users/${uid}`).once('value').then(snap => {
                const uData = snap.val() || {};
                const commentData = {
                    text: text,
                    userId: uid,
                    userName: uData.username || 'Anónimo',
                    userAvatar: uData.profilePic || 'https://placehold.co/50',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                input.value = ''; // Limpiar input inmediatamente
                
                // Guardar comentario
                db.ref(`feed_comments/${postId}`).push(commentData);
                
                // Actualizar contador global del post
                db.ref(`feed_posts/${postId}/commentCount`).transaction(c => (c || 0) + 1);
                
                // Asegurar que la sección esté abierta para ver el nuevo comentario
                const area = document.getElementById(`comments-area-${postId}`);
                if(area.classList.contains('hidden')) toggleComments(postId);
                else expandComments(postId); // Si ya está abierta, forzar expansión para ver el nuevo al final
            });
        }

        // --- SUBIDA ---
        function handleFileSelect(e) {
            const f = e.target.files[0];
            if(f) {
                if(f.size > 5*1024*1024) { alert("Máx 5MB"); return; }
                selectedFile = f;
                document.getElementById('image-preview').src = URL.createObjectURL(f);
                document.getElementById('preview-container').classList.remove('hidden');
            }
        }
        function clearSelection() {
            selectedFile = null;
            document.getElementById('file-input').value = '';
            document.getElementById('preview-container').classList.add('hidden');
        }
        
        async function uploadPost() {
            const text = document.getElementById('post-text').value.trim();
            const btn = document.getElementById('publish-btn');
            if(!text && !selectedFile) return;

            btn.disabled = true;
            btn.innerText = "Publicando...";
            document.getElementById('upload-status').classList.remove('hidden');

            try {
                let imgUrl = null;
                if(selectedFile) {
                    const fd = new FormData();
                    fd.append('reqtype', 'fileupload');
                    fd.append('userhash', CATBOX_USERHASH);
                    fd.append('fileToUpload', selectedFile);
                    const res = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", {method:'POST', body:fd});
                    const txt = await res.text();
                    if(txt.includes('catbox.moe')) imgUrl = txt.trim();
                    else throw new Error("Error subida");
                }

                const uid = currentUser ? currentUser.uid : 'anon';
                const uData = (await db.ref('users/'+uid).once('value')).val() || {};

                const newPost = {
                    text: text,
                    imageUrl: imgUrl,
                    userId: uid,
                    userName: uData.username || 'Anónimo',
                    userAvatar: uData.profilePic || 'https://placehold.co/50',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    likes: 0,
                    commentCount: 0
                };

                await db.ref('feed_posts').push(newPost);
                
                // Reset
                document.getElementById('post-text').value = '';
                clearSelection();

            } catch(e) {
                alert("Error: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Publicar";
                document.getElementById('upload-status').classList.add('hidden');
            }
        }

        // --- LIKES ---
        function toggleLike(postId) {
            const uid = currentUser ? currentUser.uid : 'anon';
            const likeRef = db.ref(`feed_likes/${postId}/${uid}`);
            likeRef.once('value', snap => {
                if(snap.exists()) {
                    likeRef.remove();
                    db.ref(`feed_posts/${postId}/likes`).transaction(c => (c||1)-1);
                } else {
                    likeRef.set(true);
                    db.ref(`feed_posts/${postId}/likes`).transaction(c => (c||0)+1);
                }
            });
        }
        function checkLikeStatus(postId) {
            const uid = currentUser ? currentUser.uid : 'anon';
            db.ref(`feed_likes/${postId}/${uid}`).on('value', s => {
                const btn = document.getElementById(`btn-like-${postId}`);
                const icon = btn.querySelector('i');
                if(s.exists()) {
                    btn.classList.add('text-red-500');
                    icon.className = "fas fa-heart like-anim";
                } else {
                    btn.classList.remove('text-red-500');
                    icon.className = "far fa-heart";
                }
            });
            db.ref(`feed_posts/${postId}/likes`).on('value', s => {
                document.getElementById(`count-like-${postId}`).innerText = s.val() || 0;
            });
        }

        // --- BORRAR ---
        function deletePost(postId) {
            if(confirm("¿Eliminar publicación?")) {
                db.ref(`feed_posts/${postId}`).remove();
                db.ref(`feed_comments/${postId}`).remove();
                db.ref(`feed_likes/${postId}`).remove();
                const el = document.getElementById(`post-${postId}`);
                if(el) el.remove();
                closeModal();
            }
        }

        // --- MODAL ---
        let currentModalPostId = null;
        function openModal(postId) {
            currentModalPostId = postId;
            const modal = document.getElementById('modal');
            modal.classList.add('visible');
            setTimeout(()=> modal.classList.remove('opacity-0'), 10);

            db.ref(`feed_posts/${postId}`).once('value', s => {
                const p = s.val();
                document.getElementById('modal-img').src = p.imageUrl;
                document.getElementById('modal-user').innerText = p.userName;
                document.getElementById('modal-desc').innerText = p.text;
                
                if(currentUser && currentUser.uid === p.userId) {
                    const btn = document.getElementById('modal-delete-btn');
                    btn.classList.remove('hidden');
                    btn.onclick = () => deletePost(postId);
                }
            });

            // Cargar comentarios del modal (TODOS)
            const list = document.getElementById('modal-comments-list');
            list.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i></div>';
            db.ref(`feed_comments/${postId}`).on('value', snap => {
                list.innerHTML = '';
                snap.forEach(c => {
                    const v = c.val();
                    list.innerHTML += `
                        <div class="flex gap-2 mb-2">
                            <img src="${v.userAvatar}" class="w-6 h-6 rounded-full">
                            <div class="bg-gray-800 rounded p-2 text-xs">
                                <span class="text-orange-500 font-bold">${v.userName}</span> 
                                <span class="text-gray-300">${v.text}</span>
                            </div>
                        </div>`;
                });
            });
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('opacity-0');
            setTimeout(()=> modal.classList.remove('visible'), 300);
            if(currentModalPostId) {
                db.ref(`feed_comments/${currentModalPostId}`).off(); // Dejar de escuchar al cerrar modal
            }
            currentModalPostId = null;
        }

        function submitModalComment(e) {
            e.preventDefault();
            const input = document.getElementById('modal-comment-input');
            const text = input.value.trim();
            if(!text || !currentModalPostId) return;
            
            const uid = currentUser ? currentUser.uid : 'anon';
            db.ref(`users/${uid}`).once('value').then(s => {
               const u = s.val() || {};
               db.ref(`feed_comments/${currentModalPostId}`).push({
                   text: text, userId: uid, userName: u.username || 'Anon', userAvatar: u.profilePic || 'https://placehold.co/50', timestamp: firebase.database.ServerValue.TIMESTAMP
               });
               db.ref(`feed_posts/${currentModalPostId}/commentCount`).transaction(c => (c||0)+1);
               input.value = '';
            });
        }
    </script>
</body>
</html>