<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exen-E | Encuesta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/alpinejs@3.13.10/dist/cdn.min.js" defer></script>
    <style>
        :root { 
            --accent: #f97316; 
            --accent-neon: #fb923c; 
            --title-font: 'Poppins', sans-serif;
            --body-font: 'Inter', sans-serif;
        }
        
        /* Configuración global de fuentes y fondo */
        .dark {
            color-scheme: dark;
        }

        body {
            font-family: var(--body-font);
            background-color: #111827; /* gray-900 */
            color: #f3f4f6; /* gray-100 */
        }

        /* Estilos para el encabezado con fuente de título */
        .title-text {
            font-family: var(--title-font);
            color: var(--accent-neon);
            text-shadow: 0 0 10px rgba(251, 146, 60, 0.4); /* Neon effect */
        }

        /* Estilo para los botones principales */
        .primary-btn {
            background: linear-gradient(to right, #f97316, #f59e0b);
            color: white;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.2), 0 2px 4px -2px rgba(249, 115, 22, 0.2);
        }

        .primary-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Estilo para el input de formulario */
        .form-input {
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            color: #f3f4f6;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }

        /* Estilos específicos para la encuesta */
        .poll-card {
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        .poll-answer {
            background-color: #374151; /* gray-700 */
            border-radius: 0.5rem;
        }
        
        /* Estilos para asegurar que la barra de navegación fija no sea cubierta por otros elementos. */
        #bottom-nav {
            z-index: 999 !important; /* Valor alto para asegurar clicabilidad */
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Encabezado Fijo -->
    <header class="fixed top-0 inset-x-0 z-40 bg-gray-900/95 backdrop-blur-sm border-b border-gray-700 shadow-lg shadow-black/20">
        <div class="container mx-auto px-4 md:max-w-4xl py-3 flex justify-between items-center">
            <h1 class="title-text text-2xl font-extrabold tracking-tight">exen-E</h1>
            <a href="index.html" class="primary-btn px-3 py-1.5 rounded-full text-sm font-semibold flex items-center gap-2">
                <i class="fas fa-home"></i> Inicio
            </a>
        </div>
    </header>

    <!-- Contenido Principal -->
    <div id="main-content" class="container mx-auto p-4 pt-16 pb-20 md:max-w-4xl min-h-screen">
        <h2 class="text-3xl font-bold mb-6 text-gray-100 border-b border-orange-500 pb-2">Encuesta Temática</h2>

        <div id="poll-container" class="space-y-6">
            <!-- La pregunta de la encuesta se cargará aquí -->
            <div id="current-poll" class="poll-card p-6 flex flex-col items-center justify-center text-center h-48">
                <i class="fas fa-spinner fa-spin text-4xl text-orange-500"></i>
                <p class="mt-4 text-lg">Cargando encuesta...</p>
            </div>

            <!-- Formulario de Respuesta -->
            <div class="poll-card p-6">
                <h3 class="text-xl font-bold mb-4 text-orange-400">Tu Respuesta</h3>
                <form id="poll-form" onsubmit="handlePollSubmit(event)">
                    <input type="text" id="poll-name-input" placeholder="Tu Nombre (Opcional)" class="form-input w-full mb-3" maxlength="50">
                    <textarea id="poll-answer-input" placeholder="Escribe tu respuesta/opinión aquí..." class="form-input w-full resize-none" rows="3" required></textarea>
                    <button type="submit" class="primary-btn w-full mt-3 py-2 rounded-lg font-bold">
                        Enviar Respuesta
                    </button>
                </form>
            </div>

            <!-- Lista de Respuestas -->
            <div class="space-y-4">
                <h3 class="text-xl font-bold text-gray-200 border-b border-gray-700 pb-2">Respuestas de la Comunidad</h3>
                <div id="poll-answers-container" class="space-y-4">
                    <!-- Las respuestas se cargarán aquí -->
                    <p class="text-center text-gray-500">Sé el primero en responder.</p>
                </div>
            </div>
        </div>

    </div>

    <!-- NAV/FOOTER Corregido con z-[999] -->
    <nav id="bottom-nav" class="fixed inset-x-0 bottom-0 z-[999] bg-gray-900 border-t border-gray-700 md:hidden shadow-2xl shadow-black">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
            <a href="index.html" class="flex flex-col items-center text-gray-400 hover:text-orange-400 transition-colors">
                <i class="fas fa-image text-xl"></i>
                <span class="text-xs mt-1">Imágenes</span>
            </a>
            <a href="videos.html" class="flex flex-col items-center text-gray-400 hover:text-orange-400 transition-colors">
                <i class="fas fa-music text-xl"></i>
                <span class="text-xs mt-1">Música</span>
            </a>
            <!-- Icono Central (Batalla) - Más Prominente -->
            <a href="batalla.html" class="flex flex-col items-center -mt-6">
                <div class="bg-orange-500 p-3 rounded-full shadow-lg shadow-orange-500/50 hover:bg-orange-400 transition-colors duration-200">
                    <i class="fas fa-fire text-white text-2xl"></i>
                </div>
                <span class="text-xs mt-1 text-orange-400 font-semibold">Batalla</span>
            </a>
            <a href="categoria.html" class="flex flex-col items-center text-gray-400 hover:text-orange-400 transition-colors">
                <i class="fas fa-th-large text-xl"></i>
                <span class="text-xs mt-1">Categorías</span>
            </a>
            <a href="encuesta.html" class="flex flex-col items-center text-orange-500 transition-colors">
                <i class="fas fa-poll text-xl"></i>
                <span class="text-xs mt-1 font-semibold">Encuesta</span>
            </a>
        </div>
    </nav>

    <script>
        // CONFIGURACIÓN DE FIREBASE
        const firebaseConfig = {
            // Reemplaza con tu configuración real de Firebase
            apiKey: "AIzaSy...",
            authDomain: "exenart-pro.firebaseapp.com",
            databaseURL: "https://exenart-pro-default-rtdb.firebaseio.com",
            projectId: "exenart-pro",
            storageBucket: "exenart-pro.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:a1b2c3d4e5f6g7h8i9j0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let deviceID = localStorage.getItem('deviceID');
        if (!deviceID) {
            deviceID = 'device_' + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('deviceID', deviceID);
        }

        let activePoll = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadActivePoll();
        });

        function loadActivePoll() {
            // Cargar la encuesta más reciente (asumiendo que tiene la clave más grande)
            db.ref('polls').orderByKey().limitToLast(1).on('value', snap => {
                if (!snap.exists()) {
                    document.getElementById('current-poll').innerHTML = '<p class="text-center text-lg text-gray-400">No hay encuestas activas en este momento.</p>';
                    return;
                }
                snap.forEach(child => {
                    const questionId = child.key;
                    activePoll = { ...child.val(), questionId: questionId };
                    renderPollQuestion(activePoll);
                    loadPollAnswers(questionId);
                    // Comprobar si el usuario ya ha votado
                    db.ref(`poll_votes/${deviceID}/${questionId}`).once('value', voteSnap => {
                        const form = document.getElementById('poll-form');
                        if (voteSnap.exists()) {
                            // Usuario ya votó, deshabilitar form
                            form.classList.add('opacity-50', 'pointer-events-none');
                            form.querySelector('button').textContent = 'Ya has enviado tu respuesta';
                            form.querySelector('button').classList.remove('primary-btn');
                            form.querySelector('button').classList.add('bg-gray-600', 'cursor-not-allowed');
                        } else {
                            form.classList.remove('opacity-50', 'pointer-events-none');
                            form.querySelector('button').textContent = 'Enviar Respuesta';
                            form.querySelector('button').classList.add('primary-btn');
                            form.querySelector('button').classList.remove('bg-gray-600', 'cursor-not-allowed');
                        }
                    });
                });
            });
        }

        function renderPollQuestion(poll) {
            const container = document.getElementById('current-poll');
            container.classList.remove('h-48'); // Quitar la altura del placeholder
            container.innerHTML = `
                <h3 class="text-2xl font-extrabold text-orange-500 mb-2">${poll.title}</h3>
                <p class="text-xl text-center text-gray-200">${poll.question}</p>
            `;
        }

        function loadPollAnswers(questionId) {
            const container = document.getElementById('poll-answers-container');
            container.innerHTML = '<p class="text-center text-gray-500">Cargando respuestas...</p>';

            db.ref(`poll_answers/${questionId}`).orderByChild('timestamp').on('value', snap => {
                if (!snap.exists()) {
                    container.innerHTML = '<p class="text-center text-gray-500">Sé el primero en responder.</p>';
                    return;
                }
                
                const answers = [];
                snap.forEach(child => {
                    const answer = child.val();
                    answers.push({ ...answer, answerId: child.key });
                });
                
                // Ordenar por número de likes (descendente)
                answers.sort((a, b) => (Object.keys(b.likes || {}).length) - (Object.keys(a.likes || {}).length));

                container.innerHTML = ''; // Limpiar el contenedor antes de renderizar
                answers.forEach(answer => {
                    const likeCount = Object.keys(answer.likes || {}).length;
                    const likedByMe = answer.likes && answer.likes[deviceID];
                    const div = document.createElement('div');
                    div.className = 'poll-answer p-4 shadow-md flex items-start gap-4';
                    
                    const avatarBg = ['bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-purple-500', 'bg-yellow-500'][Math.floor(Math.random() * 5)];
                    const initial = answer.name ? answer.name.charAt(0).toUpperCase() : 'A';

                    div.innerHTML = `
                        <div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full ${avatarBg} font-bold text-white">${initial}</div>
                        <div class="flex-grow">
                            <p class="font-bold text-orange-400">${answer.name || 'Anónimo'}</p>
                            <p class="text-gray-200 whitespace-pre-wrap break-words mt-1">${answer.text || ''}</p>
                            <small class="text-xs text-gray-500 mt-2 block">${new Date(answer.timestamp).toLocaleString()}</small>
                        </div>
                        <button class="poll-like-btn flex-shrink-0 flex flex-col items-center justify-center transition-transform transform ${likedByMe ? 'text-red-500 scale-110' : 'text-gray-400 hover:text-red-400'}"
                                data-answer-id="${answer.answerId}">
                            <i class="fas fa-heart text-xl"></i>
                            <span class="text-sm font-bold">${likeCount}</span>
                        </button>`;
                    container.appendChild(div);
                });

                document.querySelectorAll('.poll-like-btn').forEach(btn => { 
                    btn.addEventListener('click', () => { 
                        if (!activePoll) return; 
                        likePollAnswer(activePoll.questionId, btn.dataset.answerId); 
                    }); 
                });
            });
        }

        function likePollAnswer(questionId, answerId) {
            if (!deviceID) return;
            const likeRef = db.ref(`poll_answers/${questionId}/${answerId}/likes/${deviceID}`);
            likeRef.once('value', snap => { snap.exists() ? likeRef.remove() : likeRef.set(true); });
        }

        function handlePollSubmit(e) {
            e.preventDefault(); if (!activePoll) return;
            const text = document.getElementById('poll-answer-input').value.trim();
            const name = document.getElementById('poll-name-input').value.trim();
            if (!text) return;
            const answerData = { text: text, name: name || 'Anónimo', deviceID: deviceID, timestamp: Date.now() };
            db.ref(`poll_answers/${activePoll.questionId}`).push(answerData);
            db.ref(`poll_votes/${deviceID}/${activePoll.questionId}`).set(true);
            e.target.reset();
        }
    </script>
</body>
</html>
