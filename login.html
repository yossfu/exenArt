<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exen-E | Acceso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase (Compat libraries) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --accent: #f97316; 
            --title-font: 'Poppins', sans-serif;
            --body-font: 'Inter', sans-serif;
        }
        body { 
            font-family: var(--body-font); 
            background-color: #0c0c0c;
            background-image: radial-gradient(circle at 50% 50%, rgba(249, 115, 22, 0.1) 0%, transparent 50%);
            color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .form-card {
            background: rgba(20, 20, 25, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }
        .input-field {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #f97316, #ea580c);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); }
        
        /* Google Button Style */
        .btn-google {
            background: white;
            color: #333;
            transition: all 0.2s ease;
        }
        .btn-google:hover {
            background: #f1f1f1;
        }
        .btn-google:active { transform: scale(0.98); }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            color: #6b7280;
            font-size: 0.8rem;
            margin: 1.5rem 0;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .divider::before { margin-right: .5em; }
        .divider::after { margin-left: .5em; }
    </style>
</head>
<body>

    <div class="w-full max-w-md form-card rounded-2xl p-8 relative overflow-hidden">
        
        <!-- Header -->
        <div class="text-center mb-6">
            <img src="https://files.catbox.moe/ap1lh0.png" alt="Logo" class="h-16 mx-auto mb-4 drop-shadow-[0_0_10px_rgba(249,115,22,0.5)]">
            <h2 class="text-2xl font-bold font-[Poppins] text-white">Iniciar Sesión</h2>
            <p class="text-gray-400 text-sm mt-2">Accede para continuar a la galería</p>
        </div>

        <!-- Botón Google -->
        <button onclick="loginWithGoogle()" class="btn-google w-full py-3 rounded-lg font-bold shadow-lg flex justify-center items-center gap-3 mb-2 active:scale-95 transition-transform">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
            <span>Continuar con Google</span>
        </button>

        <!-- Divider -->
        <div class="divider">O usa tu correo (Usuarios antiguos)</div>

        <!-- LOGIN FORM (Legacy Email) -->
        <form id="login-form" class="flex flex-col gap-4">
            <div class="space-y-1">
                <label class="text-xs text-gray-400 ml-1">Correo Electrónico</label>
                <input type="email" id="login-email" class="input-field w-full rounded-lg px-4 py-3 text-white" placeholder="tu@correo.com" required>
            </div>
            <div class="space-y-1">
                <label class="text-xs text-gray-400 ml-1">Contraseña</label>
                <input type="password" id="login-password" class="input-field w-full rounded-lg px-4 py-3 text-white" placeholder="••••••••" required>
            </div>
            <button type="submit" id="btn-login-submit" class="btn-primary w-full py-3 rounded-lg font-bold text-white mt-2 shadow-lg shadow-orange-500/20 flex justify-center items-center gap-2">
                <span>Entrar con Correo</span>
            </button>
            <p id="login-error" class="text-red-400 text-xs text-center mt-2 hidden bg-red-900/20 p-2 rounded border border-red-500/30"></p>
        </form>

        <div class="mt-6 text-center border-b border-white/5 pb-6">
            <p class="text-xs text-gray-500">¿No tienes cuenta? Usa Google para registrarte automáticamente.</p>
            <a href="index.html" class="block mt-4 text-xs text-orange-500 hover:text-orange-400 underline font-semibold transition-colors">Volver a inicio (Solo ver)</a>
        </div>

        <!-- Links Legales -->
        <div class="mt-4 text-center">
            <p class="text-[10px] text-gray-500 mb-2">Al continuar, aceptas nuestros</p>
            <div class="flex justify-center gap-3 text-xs font-medium">
                <a href="terms.html" class="text-gray-400 hover:text-orange-500 transition-colors duration-200">Términos</a>
                <span class="text-gray-700">•</span>
                <a href="privacy.html" class="text-gray-400 hover:text-orange-500 transition-colors duration-200">Privacidad</a>
            </div>
        </div>

    </div>

    <!-- Modal de Carga Global -->
    <div id="loading-overlay" class="fixed inset-0 z-50 bg-black/90 hidden items-center justify-center flex-col backdrop-blur-sm">
        <i class="fas fa-circle-notch fa-spin text-orange-500 text-4xl mb-4"></i>
        <p class="text-white font-semibold animate-pulse">Autenticando...</p>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8",
            authDomain: "exene-53e6b.firebaseapp.com",
            databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com",
            projectId: "exene-53e6b",
            storageBucket: "exene-53e6b.appspot.com",
            messagingSenderId: "481369419867",
            appId: "1:481369419867:web:ac5db24c436344262c8f7e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // 1. Configurar Proveedor de Google
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.setCustomParameters({ prompt: 'select_account' });

        // 2. Función de Login con Google
        function loginWithGoogle() {
            showLoading(true);
            auth.signInWithPopup(googleProvider)
                .then(async (result) => {
                    const user = result.user;
                    const isNewUser = result.additionalUserInfo?.isNewUser;
                    
                    if (isNewUser) {
                        await db.ref('users/' + user.uid).set({
                            username: user.displayName || 'Usuario Google',
                            email: user.email,
                            profilePic: user.photoURL,
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            authMethod: 'google'
                        });
                    } else {
                        const snap = await db.ref('users/' + user.uid).once('value');
                        if (!snap.exists()) {
                            await db.ref('users/' + user.uid).set({
                                username: user.displayName,
                                email: user.email,
                                profilePic: user.photoURL
                            });
                        }
                    }
                    // La redirección ocurrirá automáticamente por onAuthStateChanged
                })
                .catch((error) => {
                    showLoading(false);
                    console.error("Error Google:", error);
                    let msg = "Error al iniciar con Google.";
                    if (error.code === 'auth/account-exists-with-different-credential') {
                        msg = "Ya existe una cuenta con este correo usando otro método.";
                    }
                    showError(msg + " (" + error.message + ")");
                });
        }

        // 3. Login Legacy (Correo)
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            
            showLoading(true);
            document.getElementById('login-error').classList.add('hidden');

            auth.signInWithEmailAndPassword(email, pass)
                .catch((error) => {
                    showLoading(false);
                    let msg = "Error al iniciar sesión.";
                    if (error.code === 'auth/user-not-found') msg = "Usuario no encontrado.";
                    else if (error.code === 'auth/wrong-password') msg = "Contraseña incorrecta.";
                    else if (error.code === 'auth/invalid-email') msg = "Correo inválido.";
                    showError(msg);
                });
        });

        // Utils
        function showLoading(show) {
            const el = document.getElementById('loading-overlay');
            if(show) el.style.display = 'flex';
            else el.style.display = 'none';
        }

        function showError(msg) {
            const el = document.getElementById('login-error');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        // VERIFICACIÓN DE SESIÓN (Redirección Automática)
        auth.onAuthStateChanged(user => {
            if (user) {
                // Si el usuario ya está logueado, redirigir inmediatamente a index
                // Usamos replace() para que no pueda volver atrás al login
                window.location.replace('index.html');
            }
        });

    </script>
</body>
</html>