<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exen-E | M√∫sica</title>

    <meta property="og:title" content="exen-E | Galer√≠a de M√∫sica" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://files.catbox.moe/4ubhtv.jpg" />
    <meta property="og:image:alt" content="Logo de exen-E Galer√≠a de M√∫sica" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --accent: #f97316;
            --accent-neon: #fb923c;
            --bg-image: url('');
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a; /* Un negro m√°s profundo */
            color: #f3f4f6;
            overflow-x: hidden;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr; /* Sidebar un poco m√°s ancha */
            gap: 1.5rem;
            height: calc(100vh - 80px); /* Full height minus header */
        }
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 300px 1fr;
            }
        }
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                height: auto;
            }
        }

        .nav-link:hover { background-color: rgba(251, 146, 60, 0.1); color: #fff; }
        .nav-link-active {
            background-color: var(--accent); color: #fff !important;
            box-shadow: 0 0 15px rgba(251, 146, 60, 0.4);
        }

        .playlist-item.playing {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* --- Player Background --- */
        #player-section {
            position: relative;
            z-index: 1;
        }
        #player-section::before {
            content: '';
            position: absolute;
            top: -20px; left: -20px; right: -20px; bottom: -20px;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            filter: blur(50px) brightness(0.3);
            z-index: -1;
            transition: background-image 0.7s ease-in-out;
            opacity: 0.7;
        }
        
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .skeleton {
            background-color: #27272a;
            background-image: linear-gradient(to right, #27272a 0%, #3f3f46 20%, #27272a 40%, #27272a 100%);
            background-repeat: no-repeat;
            background-size: 2000px 100%;
            animation: shimmer 1.5s linear infinite;
        }

        .punch-animation { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 5rem; text-shadow: 0 4px 15px rgba(0,0,0,0.4); animation: punch 0.5s ease-out forwards; pointer-events: none; z-index: 50; }
        @keyframes punch { 0% { opacity: 1; transform: translate(-50%,-50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%,-50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%,-50%) scale(1.5); } }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
    </style>
</head>
<body class="antialiased">

    <header class="sticky top-0 z-[100] bg-gray-900/80 p-4 backdrop-blur-lg border-b border-gray-800 h-[80px]">
        <div class="container mx-auto flex items-center justify-center">
            <nav>
                <ul class="flex items-center gap-1 sm:gap-2 text-sm sm:text-base">
                    <li><a href="index.html" id="nav-index" class="nav-link font-semibold text-gray-300 transition-all duration-300 px-3 py-2 rounded-lg">Galer√≠a</a></li>
                    <li><a href="batalla.html" id="nav-batalla" class="nav-link font-semibold text-gray-300 transition-all duration-300 px-3 py-2 rounded-lg">Batalla</a></li>
                    <li><a href="encuesta.html" id="nav-encuesta" class="nav-link font-semibold text-gray-300 transition-all duration-300 px-3 py-2 rounded-lg">Encuesta</a></li>
                    <li><a href="videos.html" id="nav-videos" class="nav-link font-semibold text-gray-300 transition-all duration-300 px-3 py-2 rounded-lg">M√∫sica</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 main-grid">
        <!-- Columna Izquierda: Cola de Reproducci√≥n y B√∫squeda -->
        <aside class="flex flex-col bg-black/30 rounded-lg overflow-hidden h-full border border-gray-800">
            <div class="p-4 border-b border-gray-800">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    <input type="text" id="search-input" placeholder="Filtrar..." class="w-full bg-gray-800 border-2 border-transparent rounded-full py-2 pl-10 pr-4 text-white focus:outline-none focus:border-orange-500 transition">
                </div>
            </div>
            <div id="playlist" class="flex-grow overflow-y-auto p-4 grid grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Las car√°tulas cuadradas se cargar√°n aqu√≠ -->
            </div>
        </aside>

        <!-- Columna Derecha: Reproductor Principal -->
        <section id="player-section" class="flex flex-col h-full rounded-lg overflow-hidden">
             <div id="player-content" class="h-full flex items-center justify-center">
                <!-- El contenido del reproductor se cargar√° aqu√≠ -->
            </div>
        </section>
    </main>

    <script>
        "use strict";
        const firebaseConfig = {
            apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8",
            authDomain: "exene-53e6b.firebaseapp.com",
            databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com",
            projectId: "exene-53e6b",
            storageBucket: "exene-53e6b.appspot.com",
            messagingSenderId: "481369419867",
            appId: "1:481369419867:web:ac5db24c436344262c8f7e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        firebase.auth().signInAnonymously().catch(console.error);

        let allVideos = [];
        let currentVideoId = null;
        let deviceID = localStorage.getItem('deviceID');
        if (!deviceID) {
            deviceID = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            localStorage.setItem('deviceID', deviceID);
        }

        document.addEventListener('DOMContentLoaded', () => {
            setActiveNavLink();
            initializeApp();
            setupEventListeners();
        });

        function setActiveNavLink() {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('nav-link-active'));
            document.getElementById('nav-videos')?.classList.add('nav-link-active');
        }

        async function initializeApp() {
            showSkeletons();
            try {
                const snapshot = await db.ref('videos').orderByChild('timestamp').once('value');
                if (!snapshot.exists()) {
                    document.getElementById('playlist').innerHTML = '<p class="p-4 text-center text-gray-500 col-span-full">No hay m√∫sica disponible.</p>';
                    document.getElementById('player-content').innerHTML = '';
                    return;
                }
                snapshot.forEach(child => { allVideos.push({ id: child.key, ...child.val() }); });
                allVideos.reverse(); // Mostrar los m√°s recientes primero
                
                renderPlaylist(allVideos);

                const urlParams = new URLSearchParams(window.location.search);
                const videoIdFromUrl = urlParams.get('id');
                const videoToPlay = allVideos.find(v => v.id === videoIdFromUrl) || allVideos[0];
                
                if(videoToPlay) {
                    playVideo(videoToPlay.id);
                }

            } catch(error) {
                console.error("Error al inicializar la app:", error);
                 document.getElementById('playlist').innerHTML = `<p class="p-4 text-center text-red-400 col-span-full">Error al cargar la m√∫sica: ${error.message}</p>`;
            }
        }
        
        function showSkeletons() {
            const playlistContainer = document.getElementById('playlist');
            playlistContainer.innerHTML = Array(9).fill('').map(() => `
                <div class="flex flex-col gap-2">
                    <div class="aspect-square w-full skeleton rounded-lg"></div>
                    <div class="h-4 w-3/4 skeleton rounded"></div>
                </div>`).join('');

            const playerContainer = document.getElementById('player-content');
            playerContainer.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin text-4xl text-gray-500"></i><p class="mt-4 text-gray-500">Cargando m√∫sica...</p></div>`;
        }
        
        function renderPlaylist(videos) {
            const playlistContainer = document.getElementById('playlist');
            if (videos.length === 0) {
                playlistContainer.innerHTML = '<p class="p-4 text-center text-gray-500 col-span-full">No se encontraron videos.</p>';
                return;
            }
            playlistContainer.innerHTML = videos.map(video => `
                 <div id="playlist-item-${video.id}" class="playlist-item group cursor-pointer rounded-lg transition-all duration-300" onclick="playVideo('${video.id}')">
                    <div class="relative aspect-square w-full overflow-hidden rounded-lg shadow-lg">
                        <img src="${video.thumbnailUrl}" alt="${video.title}" loading="lazy" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                        <div class="absolute inset-0 bg-black/20 group-hover:bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fas fa-play text-4xl text-white drop-shadow-lg"></i>
                        </div>
                    </div>
                    <p class="text-white font-semibold truncate mt-2 text-sm">${video.title}</p>
                    <p class="text-xs text-gray-400">Exen-E Music</p>
                </div>
            `).join('');
        }

        function playVideo(id) {
            if (currentVideoId === id && document.getElementById('video-player-container')) return; 
            currentVideoId = id;
            const video = allVideos.find(v => v.id === id);
            if (!video) return;

            // --- Set background image ---
            const playerSection = document.getElementById('player-section');
            playerSection.style.setProperty('--bg-image', `url('${video.thumbnailUrl}')`);

            const playerContainer = document.getElementById('player-content');
            playerContainer.innerHTML = ''; // Clear previous content

            const youtubeId = getYoutubeId(video.url);
            let videoPlayerHTML = '';
            if (video.type === 'youtube' && youtubeId) {
                videoPlayerHTML = `<iframe class="w-full aspect-video rounded-lg shadow-2xl" src="https://www.youtube.com/embed/${youtubeId}?autoplay=1&rel=0&iv_load_policy=3&modestbranding=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            } else if (video.type === 'mp4') {
                videoPlayerHTML = `<video class="w-full aspect-video rounded-lg shadow-2xl" src="${video.url}" controls autoplay playsinline></video>`;
            } else {
                videoPlayerHTML = `<div class="w-full aspect-video rounded-lg bg-black flex items-center justify-center"><p class="text-red-400">Error: Formato de video no soportado.</p></div>`;
            }

            playerContainer.innerHTML = `
                <div class="relative z-10 w-full h-full flex flex-col justify-between p-4 md:p-8 overflow-y-auto">
                    <div id="video-player-container" class="w-full max-w-3xl mx-auto mb-6">${videoPlayerHTML}</div>
                    
                    <div class="flex-grow flex flex-col justify-end">
                         <div class="w-full max-w-3xl mx-auto bg-black/30 backdrop-blur-md rounded-lg p-4 flex items-center gap-4 mb-6 border border-gray-800">
                            <img src="${video.thumbnailUrl}" alt="${video.title}" class="w-16 h-16 rounded-md object-cover flex-shrink-0">
                            <div class="min-w-0">
                                <h2 class="text-2xl font-bold text-white truncate">${video.title}</h2>
                                <p class="text-gray-300 truncate">${video.desc || 'Disfruta de la mejor m√∫sica.'}</p>
                            </div>
                        </div>

                        <div class="flex flex-col items-center justify-center gap-4">
                            <div id="reaction-buttons" class="flex items-center gap-6">
                                <span class="reaction-btn cursor-pointer text-4xl transition hover:scale-125" data-type="like">‚ù§Ô∏è</span>
                                <span class="reaction-btn cursor-pointer text-4xl transition hover:scale-125" data-type="hot">üî•</span>
                                <span class="reaction-btn cursor-pointer text-4xl transition hover:scale-125" data-type="wow">üòØ</span>
                                <span class="reaction-btn cursor-pointer text-4xl transition hover:scale-125" data-type="laugh">üòÇ</span>
                            </div>
                            <div id="reaction-counts-container" class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2 rounded-full bg-black/30 px-4 py-2 text-lg"></div>
                        </div>
                    </div>
                </div>
            `;
            
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + id;
            // window.history.pushState({path:newUrl}, '', newUrl); // Comentado para evitar errores en el entorno de ejecuci√≥n

            document.querySelectorAll('.playlist-item').forEach(item => item.classList.remove('playing'));
            document.getElementById(`playlist-item-${id}`)?.classList.add('playing');

            loadReactions(id);
            document.querySelectorAll('.reaction-btn').forEach(reaction => {
                reaction.addEventListener('click', e => handleReactionClick(e, id));
            });
        }
        
        function handleReactionClick(e, videoId) {
            e.stopPropagation();
            const type = e.currentTarget.dataset.type;
            animateReactionOnPlayer(type);
            const reactionsRef = db.ref(`video_reactions/${videoId}/${deviceID}`);
            reactionsRef.once('value', snap => {
                (snap.val() === type) ? reactionsRef.remove() : reactionsRef.set(type);
            });
        }
        
        function setupEventListeners() {
            document.getElementById('search-input').addEventListener('input', e => {
                const query = e.target.value.toLowerCase().trim();
                const filteredVideos = allVideos.filter(video => 
                    video.title.toLowerCase().includes(query)
                );
                renderPlaylist(filteredVideos);
                if (currentVideoId) {
                     document.getElementById(`playlist-item-${currentVideoId}`)?.classList.add('playing');
                }
            });
        }

        function getYoutubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function loadReactions(id) {
            const reactionCountsContainer = document.getElementById('reaction-counts-container');
            if (!reactionCountsContainer) return;

            db.ref(`video_reactions/${id}`).on('value', snap => {
                const reactions = snap.val() || {};
                const counts = { hot: 0, like: 0, wow: 0, laugh: 0 };
                Object.values(reactions).forEach(type => { if(counts[type] !== undefined) counts[type]++; });
                if (reactionCountsContainer) {
                    reactionCountsContainer.innerHTML = Object.entries(counts)
                        .map(([type, count]) => `<span class="flex items-center gap-1">${{like:'‚ù§Ô∏è',hot:'üî•',wow:'üòØ',laugh:'üòÇ'}[type]} <span class="font-bold">${count}</span></span>`)
                        .join('');
                }
            });
        }

        function animateReactionOnPlayer(type) {
            const icons = { hot: 'üî•', like: '‚ù§Ô∏è', wow: 'üòØ', laugh: 'üòÇ' };
            const icon = icons[type]; if (!icon) return;
            const container = document.getElementById('video-player-container');
            if (!container) return;
            const existingAnimation = container.querySelector('.punch-animation');
            if (existingAnimation) existingAnimation.remove();
            
            const animationEl = document.createElement('div');
            animationEl.className = 'punch-animation';
            animationEl.textContent = icon;
            container.appendChild(animationEl);
            setTimeout(() => animationEl.remove(), 500);
        }

    </script>
</body>
</html>

