<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exene</title>
    
    <!-- Librer√≠as Externas (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/viewerjs@1.11.1/dist/viewer.min.css">
    <script src="https://cdn.jsdelivr.net/npm/viewerjs@1.11.1/dist/viewer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos CSS Integrados -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        #authOverlay {
            background-image: url('https://files.catbox.moe/1zl86j.jpg');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            min-height: 100vh; 
            align-items: center;
            justify-content: center;
        }
        .glass-container {
            background: rgba(17, 24, 39, 0.5);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border-radius: 1.5rem;
            padding: 2.5rem 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .modal-container {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.8);
            z-index: 70; display: flex; align-items: center; justify-content: center;
            padding: 1rem; opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none;
        }
        .modal-container:not(.hidden) { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: #1f2937; padding: 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 100%; max-width: 24rem;
            transform: scale(0.95); transition: transform 0.3s ease-in-out;
        }
        .modal-container:not(.hidden) .modal-content { transform: scale(1); }
        .notifications-panel {
            position: absolute; top: calc(100% + 0.5rem); right: 0;
            width: 90vw; max-width: 360px; background-color: #1f2937;
            border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #374151; z-index: 50; opacity: 0;
            transform: translateY(-10px) scale(0.95); transform-origin: top right;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
            pointer-events: none; overflow: hidden;
        }
        .notifications-panel.active { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .notifications-panel-header { padding: 0.75rem 1rem; border-bottom: 1px solid #374151; }
        .view {
            transition: opacity 0.2s ease-in-out;
        }
        .view.hidden {
            display: none;
            opacity: 0;
        }
        .view.active {
            opacity: 1;
        }
        .view.slide-up { transform: translateY(100%); transition: transform 0.3s ease-in-out; }
        .view.slide-up.active { transform: translateY(0%); }
        .like-btn.liked i, .favorite-btn.favorited i { font-weight: 900; }
        .like-btn.liked i { color: #ec4899; }
        .favorite-btn.favorited i { color: #facc15; }
        .profile-tab {
            border-color: transparent; color: #9ca3af; white-space: nowrap;
            padding: 0.75rem 1rem; border-bottom-width: 2px; font-weight: 500; font-size: 0.875rem;
            transition: all 0.2s; flex: 1; text-align: center;
        }
        .profile-tab:hover { color: #ffffff; border-color: #4b5563; }
        .profile-tab.tab-active { color: #e5e7eb; }
        .viewer-container { background-color: rgba(0, 0, 0, 0.85); }
        .viewer-close:before { font-family: "Font Awesome 6 Free"; font-weight: 900; content: "\f00d"; font-size: 24px; color: white; }
        .portrait-aspect { position: relative; width: 100%; padding-bottom: 150%; }
        .portrait-aspect img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .portrait-aspect .card-author-overlay {
            position: absolute; top: 0; left: 0; right: 0;
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
        }
        .portrait-aspect .card-author-overlay img {
            position: static;
            width: 1.5rem; height: 1.5rem;
            border-radius: 9999px;
            border: 1px solid rgba(255,255,255,0.5);
        }
        #toast { transition: opacity 0.3s, transform 0.3s; }
        #toast.show { opacity: 1; transform: translate(-50%, 0); }
        .comment-item { display: flex; align-items: flex-start; gap: 0.75rem; }
        .comment-content { flex: 1; display: flex; flex-direction: column; }
        .comment-body { background-color: rgba(55, 65, 81, 0.5); border-radius: 0.75rem; padding: 0.5rem 0.75rem; }
        .comment-actions { display: flex; align-items: center; gap: 0.75rem; font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem; padding-left: 0.5rem; }
        .replying-to-text { font-size: 0.75rem; color: #9ca3af; margin-bottom: 0.25rem; }
        .replying-to-text strong { color: #a5b4fc; font-weight: 500; }
        .replies-container { margin-left: calc(2rem + 0.75rem); padding-left: 1rem; border-left: 2px solid #374151; margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .most-voted-item { position: relative; border-radius: 0.5rem; overflow: hidden; border: 2px solid transparent; }
        .most-voted-item .post-image { width: 100%; height: 100%; object-fit: cover; aspect-ratio: 9 / 16; }
        .most-voted-item .rank-badge { position: absolute; top: 0.5rem; left: 0.5rem; background-color: rgba(0, 0, 0, 0.7); color: white; border-radius: 9999px; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.125rem; border: 1px solid rgba(255, 255, 255, 0.5); z-index: 2; }
        .most-voted-item .author-overlay { position: absolute; bottom: 0; left: 0; right: 0; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); z-index: 2; }
        .most-voted-item .author-overlay img { width: 1.5rem; height: 1.5rem; border-radius: 9999px; object-fit: cover; background-color: #374151; }
        .most-voted-item .author-overlay span { font-size: 0.75rem; font-weight: 600; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .most-voted-item.rank-1 { border-color: #facc15; }
        .most-voted-item.rank-2 { border-color: #d1d5db; }
        .most-voted-item.rank-3 { border-color: #d97706; }
        .admin-delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; background-color: rgba(220, 38, 38, 0.7); color: white; width: 2rem; height: 2rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; z-index: 3; opacity: 0; transition: opacity 0.2s; }
        .group:hover .admin-delete-btn { opacity: 1; }
        .admin-delete-btn:hover { background-color: rgba(185, 28, 28, 1); }
        .admin-delete-comment-btn { color: #9ca3af; }
        .admin-delete-comment-btn:hover { color: #ef4444; }
        .profile-header {
            padding-bottom: 4rem;
            border-radius: 0 0 1.5rem 1.5rem;
            position: relative;
            background-size: cover;
            background-position: center;
            transition: background-color 0.3s ease;
        }
        .profile-header-content { position: relative; z-index: 1; }
        .profile-header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to top, rgba(17, 24, 39, 0.85), rgba(17, 24, 39, 0.2));
            border-radius: inherit;
        }
        .profile-avatar-container { margin-top: -3rem; position: relative; }
        .social-icon-link { color: #9ca3af; transition: color 0.2s ease-in-out; }
        .social-icon-link:hover { color: #e5e7eb; }
        .achievement-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: #374151;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: #d1d5db;
            border: 1px solid #4b5563;
        }
        .achievement-badge .fa-trophy { color: #facc15; }
        .achievement-badge .fa-star { color: #facc15; }
        
        /* Estilos de App M√≥vil */
        .main-nav {
            background-color: #111827;
            border-top: 1px solid #374151;
        }
        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            transition: color 0.2s ease-in-out;
            padding: 0.5rem 0;
        }
        .nav-btn i {
            font-size: 1.5rem; /* Iconos m√°s grandes */
            margin-bottom: 0.125rem;
        }
        .nav-btn span {
            font-size: 0.65rem;
            font-weight: 500;
        }
        .nav-btn.active {
            color: #818cf8; /* Indigo-400 */
        }
        #createPostBtnContainer {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 1.5rem; /* Sube el bot√≥n */
            z-index: 50;
        }
        #createPostBtn {
            width: 4rem;
            height: 4rem;
            border-radius: 9999px;
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-in-out;
        }
        #createPostBtn:hover {
            transform: scale(1.05);
            background-color: #4338ca; /* Indigo-700 */
        }
        #createPostBtn i {
            font-size: 1.75rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <!-- ========== MODAL DE VERIFICACI√ìN DE EDAD ========== -->
    <div id="ageVerificationModal" class="modal-container hidden">
        <div class="modal-content text-center">
            <i class="fas fa-exclamation-triangle text-yellow-400 text-4xl mb-4"></i>
            <h2 class="text-2xl font-bold mb-2 text-white">Contenido para Adultos (18+)</h2>
            <p class="text-gray-400 text-sm mb-4">
                Este sitio contiene material expl√≠cito para adultos. Debes tener 18 a√±os o m√°s para entrar.
            </p>
            <p class="text-gray-500 text-xs mb-6">
                Exene no se hace responsable por el contenido publicado por los usuarios. Al continuar, confirmas que eres mayor de edad y aceptas nuestros <a href="#" id="ageModalTermsLink" class="underline hover:text-indigo-400">T√©rminos de Servicio</a>.
            </p>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="confirmAgeBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">S√≠, tengo 18 a√±os o m√°s</button>
                <button id="exitBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Salir</button>
            </div>
        </div>
    </div>

    <!-- ========== PANTALLA DE BIENVENIDA Y BOTONES DE AUTH ========== -->
    <div id="authOverlay" class="fixed inset-0 bg-gray-900 z-50 flex p-4 transition-opacity duration-300">
        <div id="welcomeContainer" class="m-auto text-center">
            <div class="glass-container">
                <img src="https://files.catbox.moe/n86yjv.png" alt="Exene" class="h-16 mx-auto mb-4" onerror="this.style.display='none'">
                <h1 class="text-4xl font-bold text-white">Bienvenido a Exene</h1>
                <p class="text-gray-300 mt-2">√önete a la comunidad y comparte tu visi√≥n.</p>
                <div class="flex flex-col sm:flex-row gap-4 mt-8 w-full max-w-xs mx-auto">
                    <button id="showLoginModalBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-transform hover:scale-105">Iniciar Sesi√≥n</button>
                    <button id="showRegisterModalBtn" class="w-full bg-white/10 hover:bg-white/20 text-white font-bold py-3 px-4 rounded-lg transition-colors">Crear Cuenta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODALES DE AUTH ========== -->
    <div id="loginModal" class="modal-container hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-center text-white">Iniciar Sesi√≥n</h2>
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="Correo electr√≥nico" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="loginPassword" placeholder="Contrase√±a" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Entrar</button>
                 <div class="text-center mt-4">
                    <button type="button" id="showForgotPasswordModalBtn" class="text-sm text-indigo-400 hover:underline">¬øOlvidaste tu contrase√±a?</button>
                </div>
                <button type="button" class="mt-2 w-full text-gray-400 hover:text-white transition-colors py-2 close-modal-btn">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="registerModal" class="modal-container hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-center text-white">Crear Cuenta</h2>
            <form id="registerForm">
                <input type="text" id="registerUsername" placeholder="Elige un nombre de usuario" required maxlength="20" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="email" id="registerEmail" placeholder="Correo electr√≥nico" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="registerPassword" placeholder="Crea una contrase√±a (m√≠n. 6 caracteres)" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="registerPasswordConfirm" placeholder="Confirmar contrase√±a" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <p class="text-xs text-gray-500 text-center mb-4">
                    Al registrarte, aceptas nuestros <a href="#" id="registerTermsLink" class="underline hover:text-indigo-400">T√©rminos de Servicio</a> y <a href="#" id="registerPrivacyLink" class="underline hover:text-indigo-400">Pol√≠tica de Privacidad</a>.
                </p>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Registrarse</button>
                <button type="button" class="mt-2 w-full text-gray-400 hover:text-white transition-colors py-2 close-modal-btn">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="forgotPasswordModal" class="modal-container hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-center text-white">Restablecer Contrase√±a</h2>
            <p class="text-gray-400 text-sm mb-4 text-center">Ingresa tu correo electr√≥nico y te enviaremos un enlace para restablecer tu contrase√±a.</p>
            <form id="forgotPasswordForm">
                <input type="email" id="forgotPasswordEmail" placeholder="Correo electr√≥nico" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Enviar Correo</button>
                <button type="button" class="mt-2 w-full text-gray-400 hover:text-white transition-colors py-2 close-modal-btn">Cancelar</button>
            </form>
        </div>
    </div>
    
    <!-- ========== CONTENIDO PRINCIPAL DE LA APP ========== -->
    <div id="appContent" class="hidden">
        <!-- MODALES DE LA APP -->
        <div id="avatarModal" class="modal-container hidden">
            <div class="modal-content">
                <h3 class="text-lg font-bold text-white mb-4">Elige tu Avatar</h3>
                <div id="avatarSelection" class="grid grid-cols-4 gap-4"></div>
                <div class="mt-6 border-t border-gray-700 pt-4">
                    <h4 class="text-sm font-medium text-gray-400 mb-2">O pega una URL de imagen</h4>
                    <form id="avatarUrlForm" class="flex items-center gap-2">
                        <input type="url" id="avatarUrlInput" placeholder="https://..." required maxlength="500" class="flex-1 w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Usar</button>
                    </form>
                </div>
                <button class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors close-modal-btn">Cerrar</button>
            </div>
        </div>
        
        <div id="createPostModal" class="modal-container hidden">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4 text-center text-white">Nueva Publicaci√≥n</h2>
                <form id="createPostForm" class="space-y-4">
                    <div>
                        <label for="postImageUrl" class="block text-sm font-medium text-gray-400 mb-1">URL de la Imagen</label>
                        <input type="url" id="postImageUrl" name="postImageUrl" placeholder="https://..." required maxlength="500" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-2">Sube tus fotos en <a href="https://catbox.moe/" target="_blank" rel="noopener noreferrer" class="text-indigo-400 hover:underline">catbox.moe</a> y pega la URL aqu√≠.</p>
                    </div>
                    <div>
                        <label for="postTitle" class="block text-sm font-medium text-gray-400 mb-1">T√≠tulo</label>
                        <input type="text" id="postTitle" name="postTitle" placeholder="Un t√≠tulo para tu imagen" required maxlength="80" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="postDescription" class="block text-sm font-medium text-gray-400 mb-1">Descripci√≥n (opcional)</label>
                        <textarea id="postDescription" name="postDescription" placeholder="Describe tu imagen... puedes a√±adir enlaces." rows="3" maxlength="500" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <div>
                        <label for="postTags" class="block text-sm font-medium text-gray-400 mb-1">Etiquetas (separadas por comas)</label>
                        <input type="text" id="postTags" name="postTags" placeholder="ej: arte, paisaje, retrato" maxlength="150" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <p class="text-xs text-gray-500 text-center !mt-6">
                        Al publicar, aceptas nuestros <a href="#" id="createPostTermsLink" class="underline hover:text-indigo-400">T√©rminos</a> y <a href="#" id="createPostPrivacyLink" class="underline hover:text-indigo-400">Pol√≠tica de Privacidad</a>.
                    </p>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Publicar</button>
                    <button type="button" class="mt-2 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors close-modal-btn">Cancelar</button>
                </form>
            </div>
        </div>
        
        <div id="adminAddCuratedModal" class="modal-container hidden">
            <div class="modal-content max-w-lg">
                <h2 class="text-xl font-bold mb-4 text-center text-white">A√±adir Contenido Oficial (Admin)</h2>
                <form id="adminAddCuratedForm" class="space-y-4">
                    <div>
                        <label for="adminPostUrl" class="block text-sm font-medium text-gray-400 mb-1">URL Imagen</label>
                        <input type="url" id="adminPostUrl" placeholder="https://..." required maxlength="500" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="adminPostTitle" class="block text-sm font-medium text-gray-400 mb-1">T√≠tulo</label>
                        <input type="text" id="adminPostTitle" placeholder="T√≠tulo para la imagen" required maxlength="80" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="adminPostDescription" class="block text-sm font-medium text-gray-400 mb-1">Descripci√≥n</label>
                        <textarea id="adminPostDescription" placeholder="Descripci√≥n de la imagen..." rows="3" maxlength="500" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <div>
                        <label for="adminPostTags" class="block text-sm font-medium text-gray-400 mb-1">Etiquetas (separadas por comas)</label>
                        <input type="text" id="adminPostTags" placeholder="ej: arte, paisaje, retrato" maxlength="150" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Generar JSON</button>
                    <div id="generatedJsonContainer" class="hidden mt-4">
                        <label class="block text-sm font-medium text-gray-400 mb-1">JSON Generado (copia y pega en <code>imagenes.json</code>)</label>
                        <textarea id="generatedJsonOutput" readonly rows="8" class="w-full bg-gray-800 text-gray-300 text-xs font-mono p-2 rounded-md border border-gray-600"></textarea>
                        <button type="button" id="copyJsonBtn" class="mt-2 w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition-colors">Copiar al portapapeles</button>
                    </div>
                    <button type="button" class="mt-2 w-full text-gray-400 hover:text-white transition-colors py-2 close-modal-btn">Cancelar</button>
                </form>
            </div>
        </div>

        <!-- MODALES LEGALES -->
        <div id="termsModal" class="modal-container hidden">
            <div class="modal-content max-w-2xl h-4/5 flex flex-col">
                <h2 class="text-xl font-bold mb-4 text-center text-white">T√©rminos y Condiciones</h2>
                <div class="text-gray-300 text-sm space-y-3 overflow-y-auto pr-2">
                    <p><strong>√öltima actualizaci√≥n:</strong> 30 de Junio de 2025</p>
                    <p>Bienvenido a Exene. Estos t√©rminos y condiciones describen las reglas y regulaciones para el uso del sitio web de Exene.</p>
                    <h3 class="font-bold text-white pt-2">Cuentas y Contenido</h3>
                    <p>Eres responsable de tu cuenta y de todo el contenido que publiques. No se permite contenido ilegal, acoso, spam o cualquier actividad que viole nuestras normas comunitarias. Nos reservamos el derecho de eliminar contenido y suspender cuentas que infrinjan estos t√©rminos.</p>
                    <h3 class="font-bold text-white pt-2">Descargo de Responsabilidad</h3>
                    <p>El contenido en Exene es generado por los usuarios. No nos hacemos responsables por el material publicado por terceros. Cada usuario es el √∫nico responsable de sus publicaciones.</p>
                </div>
                <button type="button" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors close-modal-btn flex-shrink-0">Cerrar</button>
            </div>
        </div>

        <div id="privacyModal" class="modal-container hidden">
            <div class="modal-content max-w-2xl h-4/5 flex flex-col">
                <h2 class="text-xl font-bold mb-4 text-center text-white">Pol√≠tica de Privacidad</h2>
                <div class="text-gray-300 text-sm space-y-3 overflow-y-auto pr-2">
                     <p><strong>√öltima actualizaci√≥n:</strong> 30 de Junio de 2025</p>
                     <p>Recopilamos la informaci√≥n que nos proporcionas (correo, nombre de usuario) y datos de tu actividad (publicaciones, likes) para operar y mejorar el servicio. No compartimos tu informaci√≥n personal con terceros, excepto para cumplir con la ley.</p>
                </div>
                <button type="button" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors close-modal-btn flex-shrink-0">Cerrar</button>
            </div>
        </div>

        <!-- MODAL DE CONFIRMACI√ìN -->
        <div id="confirmationModal" class="modal-container hidden">
            <div class="modal-content text-center">
                <h2 id="confirmationTitle" class="text-xl font-bold mb-4 text-white">¬øEst√°s seguro?</h2>
                <p id="confirmationMessage" class="text-gray-300 mb-6">Esta acci√≥n no se puede deshacer.</p>
                <div class="flex gap-4">
                    <button id="confirmActionBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Confirmar</button>
                    <button id="cancelActionBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- VISTAS PRINCIPALES -->
        <main id="galleryView" class="view pb-20 active">
            <header class="p-4 flex justify-between items-center bg-gray-900/80 backdrop-blur-sm sticky top-0 z-40">
                <img src="https://files.catbox.moe/n86yjv.png" alt="Exene" class="h-8" onerror="this.style.display='none'">
                <h2 class="text-lg font-bold text-white">Para ti</h2>
                <div class="relative">
                    <button id="navNotificationsBtn" class="text-gray-400 hover:text-white text-xl p-2 relative">
                        <i class="fas fa-bell"></i>
                        <span id="navNotificationsBadge" class="absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-gray-900 hidden"></span>
                    </button>
                    <div id="notificationsWindow" class="notifications-panel">
                        <div class="notifications-panel-header">
                            <h3 class="text-lg font-bold text-white">Notificaciones</h3>
                        </div>
                        <div id="notificationsList" class="space-y-1 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
            </header>
            
            <section id="most-voted-section" class="px-4 mt-6">
                <h3 class="text-xl font-bold text-white mb-3">üî• Lo m√°s Votado</h3>
                <div id="leaderboard" class="grid grid-cols-3 gap-2 md:gap-4 mt-4">
                    <!-- Las publicaciones m√°s votadas se inyectar√°n aqu√≠ -->
                </div>
            </section>

            <h3 class="px-4 text-xl font-bold text-white mt-6 mb-2">Contenido Oficial</h3>
            <div id="gallery" class="p-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
            <div id="curated-sentinel" class="h-10"></div>
            <div id="galleryLoader" class="text-center p-8 hidden">
                <i class="fas fa-spinner fa-spin text-3xl text-indigo-400"></i>
            </div>
        </main>

        <main id="feedView" class="view pb-20 hidden">
            <header class="p-4 flex justify-center items-center bg-gray-900/80 backdrop-blur-sm sticky top-0 z-10">
                <h2 class="text-lg font-bold text-white">Comunidad</h2>
            </header>
            <div id="feedGrid" class="p-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
            <div id="feed-sentinel" class="h-10"></div>
             <div id="feedLoader" class="text-center p-8 hidden">
                <i class="fas fa-spinner fa-spin text-3xl text-indigo-400"></i>
            </div>
        </main>

        <main id="followingView" class="view pb-20 hidden">
            <header class="p-4 flex justify-center items-center bg-gray-900/80 backdrop-blur-sm sticky top-0 z-10">
                <h2 class="text-lg font-bold text-white">Siguiendo</h2>
            </header>
            <div id="followingGrid" class="p-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
            <div id="following-sentinel" class="h-10"></div>
             <div id="followingLoader" class="text-center p-8 hidden">
                <i class="fas fa-spinner fa-spin text-3xl text-indigo-400"></i>
            </div>
        </main>
        
        <main id="popularView" class="view pb-20 hidden">
            <header class="p-4 flex justify-center items-center bg-gray-900/80 backdrop-blur-sm sticky top-0 z-10">
                <h2 class="text-lg font-bold text-white">Populares üî•</h2>
            </header>
            <div id="popularGallery" class="p-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
        </main>

        <main id="profileView" class="view pb-20 hidden">
            <!-- El contenido del perfil se genera din√°micamente -->
        </main>
        
        <main id="userProfileView" class="view hidden fixed inset-0 bg-gray-900 z-50 flex flex-col slide-up">
            <!-- El contenido del perfil de otros usuarios se genera din√°micamente -->
        </main>

        <main id="detailView" class="view hidden fixed inset-0 bg-gray-900 z-50 flex flex-col slide-up">
            <header class="p-4 flex justify-between items-center bg-gray-900/80 backdrop-blur-sm z-10 flex-shrink-0">
                <button id="detailBackBtn" class="text-xl text-gray-400 hover:text-white transition-colors w-10 h-10 flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>
                <div id="detailAuthorInfo" class="flex items-center gap-3 cursor-pointer group flex-1 justify-center min-w-0">
                    <img id="detailAuthorAvatar" src="" class="w-9 h-9 rounded-full object-cover border-2 border-gray-700 group-hover:border-indigo-500 transition-colors">
                    <div class="flex items-center gap-2">
                      <h3 class="font-bold text-lg text-white group-hover:underline truncate" id="detailAuthorUsername"></h3>
                      <span id="detailAuthorVerifiedBadge"></span>
                    </div>
                </div>
                <div class="w-10"></div>
            </header>
            <main class="flex-1 overflow-y-auto pb-20">
                <div id="imageViewer" class="bg-black cursor-zoom-in"></div>
                <div class="p-4 space-y-4">
                    <div><h1 id="detailTitle" class="text-white font-bold text-xl"></h1><p id="detailDescription" class="text-gray-300 mt-1 text-sm leading-relaxed"></p></div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-6 text-2xl text-gray-400">
                            <button id="detailLikeBtn" class="like-btn flex items-center space-x-2 group"><i class="far fa-heart group-hover:text-pink-500 transition-transform transform active:scale-125"></i></button>
                            <button id="focusCommentBtn" class="comment-btn flex items-center space-x-2 group"><i class="far fa-comment group-hover:text-indigo-400 transition-colors"></i></button>
                            <button id="detailFavoriteBtn" class="favorite-btn flex items-center space-x-2 group"><i class="far fa-bookmark group-hover:text-yellow-400 transition-transform transform active:scale-125"></i></button>
                        </div>
                        <div class="text-sm text-gray-400"><span id="detailLikeCount" class="font-semibold text-white">0 Me gusta</span><span class="text-gray-500 mx-1">‚Ä¢</span><span id="detailViewCount" class="">0 Vistas</span></div>
                    </div>
                    <button id="adminDeletePostBtn" class="hidden w-full bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors"><i class="fas fa-trash-alt mr-2"></i>Eliminar Publicaci√≥n (Admin)</button>
                </div>
                <section class="p-4 pt-2 border-t border-gray-800/60">
                    <h2 class="font-bold text-white mb-4">Comentarios</h2>
                    <div id="comment-container" class="my-4">
                        <div id="replyingToBanner" class="hidden bg-gray-700 p-2 text-sm flex justify-between items-center rounded-t-md">
                            <span class="text-gray-300">Respondiendo a <strong id="replyingToUsername" class="text-white"></strong></span>
                            <button id="cancelReplyBtn" class="text-xs text-gray-400 hover:text-white font-bold">&times; Cancelar</button>
                        </div>
                        <form id="commentForm" class="bg-gray-800 p-2 flex items-center space-x-2">
                            <img id="commentFormAvatar" src="" class="w-8 h-8 rounded-full object-cover">
                            <input type="text" id="commentText" placeholder="Escribe un comentario..." maxlength="300" class="flex-1 bg-gray-700 text-white rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button type="submit" class="text-indigo-400 hover:text-indigo-300 text-xl p-2"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                    <ul id="commentsList" class="space-y-4"></ul>
                </section>
                <section id="similar-section" class="p-4 pt-6 border-t border-gray-800/60 hidden"><h2 class="font-bold text-white mb-4">Im√°genes Similares</h2><div id="similar-images-grid" class="grid grid-cols-3 gap-2"></div></section>
            </main>
        </main>

        <main id="searchView" class="view hidden p-4 pt-4 pb-20 overflow-y-auto">
            <header class="p-4 flex justify-center items-center bg-gray-900/80 backdrop-blur-sm sticky top-0 z-10">
                <form id="searchForm" class="relative w-full max-w-lg">
                    <input type="search" id="searchInput" placeholder="Buscar usuarios, t√≠tulos o etiquetas..." class="w-full bg-gray-800 text-white border border-gray-700 rounded-full pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                </form>
            </header>
            <p id="searchResultCount" class="text-sm text-gray-400 mt-4 px-2"></p>
            <div id="searchResultsContainer" class="mt-2 px-2 space-y-6">
                <section id="userResultsSection" class="hidden">
                    <h2 class="text-lg font-bold text-white mb-3">Usuarios</h2>
                    <div id="userResults" class="space-y-2"></div>
                </section>
                <section id="postResultsSection" class="hidden">
                    <h2 class="text-lg font-bold text-white mb-3">Publicaciones</h2>
                    <div id="postResults" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
                </section>
                <div id="noResultsMessage" class="text-center text-gray-500 py-8 hidden">
                    <p>No se encontraron resultados para tu b√∫squeda.</p>
                </div>
            </div>
        </main>
        
        <div id="toast" class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-700 text-white px-4 py-2 rounded-lg shadow-lg z-[100] transition-all duration-300 opacity-0 transform translate-y-4">
            <p id="toastMessage"></p>
        </div>

        <footer class="fixed bottom-0 left-0 right-0 z-40">
            <div id="createPostBtnContainer">
                 <button id="createPostBtn" aria-label="Crear Publicaci√≥n"><i class="fas fa-plus"></i></button>
            </div>
            <nav class="main-nav flex justify-around items-center h-16">
                <button data-view="galleryView" class="nav-btn active" aria-label="Inicio">
                    <i class="fas fa-home"></i>
                    <span class="nav-text">Inicio</span>
                </button>
                <button data-view="feedView" class="nav-btn" aria-label="Comunidad">
                    <i class="fas fa-users"></i>
                    <span class="nav-text">Comunidad</span>
                </button>
                <div class="w-16 h-16"></div> <!-- Espacio para el bot√≥n flotante -->
                <button data-view="followingView" class="nav-btn" aria-label="Siguiendo">
                    <i class="fas fa-user-friends"></i>
                    <span class="nav-text">Siguiendo</span>
                </button>
                <button data-view="profileView" id="navProfileBtn" class="nav-btn" aria-label="Mi Perfil">
                    <img id="navProfileAvatar" src="" class="w-8 h-8 rounded-full object-cover border-2 border-transparent transition-colors">
                </button>
            </nav>
        </footer>
    </div>

    <!-- Script Principal Integrado -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            sendPasswordResetEmail, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            onValue, 
            set, 
            push, 
            serverTimestamp, 
            get, 
            query, 
            orderByChild,
            equalTo,
            remove,
            update
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        document.addEventListener('DOMContentLoaded', () => {
            // Configuraci√≥n de Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8",
                authDomain: "exene-53e6b.firebaseapp.com",
                databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com",
                projectId: "exene-53e6b",
                storageBucket: "exene-53e6b.firebasestorage.app",
                messagingSenderId: "481369419867",
                appId: "1:481369419867:web:ac5db24c436344262c8f7e"
            };

            // Inicializaci√≥n de Firebase
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            const auth = getAuth(app);
            
            // --- CONSTANTES Y VARIABLES GLOBALES ---
            const USERNAME_MAX_LENGTH = 20;
            const BIO_MAX_LENGTH = 200;
            const INTEREST_LIMIT = 10;
            const POST_TITLE_MAX_LENGTH = 80;
            const POST_DESC_MAX_LENGTH = 500;
            const POST_TAGS_MAX_LENGTH = 150;
            const COMMENT_MAX_LENGTH = 300;
            const URL_MAX_LENGTH = 500;
            const SOCIAL_URL_MAX_LENGTH = 255;

            let allImages = [], allPosts = [], sortedCuratedContent = [];
            let loadedCuratedCount = 0, loadedFeedCount = 0, loadedFollowingCount = 0;
            const itemsPerLoad = 12;
            let currentUser = null, currentUserData = {};
            let isCurrentUserAdmin = false;
            let globalAdminUID = null;
            const ADMIN_EMAIL = 'admin@exene.com';
            const ADMIN_USERNAME = 'Exen';
            let usersCache = {};
            let currentViewer = null;
            let lastView = 'galleryView';
            let isGalleryLoading = false, isFeedLoading = false, isFollowingLoading = false;
            let toastTimeout;
            let appInitialized = false;
            let activeDetailListeners = {};

            // Definici√≥n de logros
            const ACHIEVEMENTS = {
                'first-post': { icon: 'fa-paper-plane', title: 'Primeros Pasos', description: 'Creaste tu primera publicaci√≥n.' },
                'popular-post': { icon: 'fa-fire', title: 'En Racha', description: 'Una de tus publicaciones alcanz√≥ 10 Me Gusta.' },
                'five-posts': { icon: 'fa-images', title: 'Creador Constante', description: 'Has creado 5 publicaciones.' },
                'first-comment': { icon: 'fa-comment-dots', title: 'Rompiendo el Hielo', description: 'Escribiste tu primer comentario.' },
                'prolific-commenter': { icon: 'fa-comments', title: 'Socialit√©', description: 'Has realizado 25 comentarios.' },
                'first-favorite': { icon: 'fa-bookmark', title: 'Digno de Guardar', description: 'Guardaste tu primera imagen en favoritos.' },
                'admin-favorite': { icon: 'fa-star', title: 'Selecci√≥n del Editor', description: 'Un administrador guard√≥ tu publicaci√≥n en favoritos.' }
            };

            // --- FUNCIONES AUXILIARES ---
            const showModal = (modalId) => document.getElementById(modalId).classList.remove('hidden');
            const hideModal = (modalId) => document.getElementById(modalId).classList.add('hidden');
            const showLoader = (loaderId, show) => document.getElementById(loaderId).classList.toggle('hidden', !show);
            const showToast = (message) => {
                const toast = document.getElementById('toast');
                if (toastTimeout) clearTimeout(toastTimeout);
                document.getElementById('toastMessage').textContent = message;
                toast.classList.add('show');
                toastTimeout = setTimeout(() => toast.classList.remove('show'), 3000);
            };
             const getFirebaseErrorMessage = (error) => {
                switch (error.code) {
                    case 'auth/invalid-email': return 'El formato del correo es inv√°lido.';
                    case 'auth/user-not-found': return 'No se encontr√≥ ning√∫n usuario con este correo.';
                    case 'auth/wrong-password': return 'Correo o contrase√±a incorrectos.';
                    case 'auth/email-already-in-use': return 'Este correo ya est√° registrado.';
                    case 'auth/weak-password': return 'La contrase√±a debe tener al menos 6 caracteres.';
                    default: console.error(error); return 'Ha ocurrido un error inesperado.';
                }
            };
            const closeSlideUpView = (viewId) => {
                const view = document.getElementById(viewId);
                view.classList.remove('active');
                if (viewId === 'detailView') detachDetailViewListeners();
                setTimeout(() => triggerView(lastView || 'galleryView'), 300);
            };
            const cancelReply = () => {
                const form = document.getElementById('commentForm');
                delete form.dataset.replyToPath;
                delete form.dataset.authorName;
                document.getElementById('replyingToBanner').classList.add('hidden');
                document.getElementById('commentText').placeholder = 'Escribe un comentario...';
            };
            const initiateReply = (commentElement) => {
                const form = document.getElementById('commentForm');
                form.dataset.replyToPath = commentElement.dataset.commentPath;
                form.dataset.authorName = commentElement.dataset.authorName;
                document.getElementById('replyingToUsername').textContent = commentElement.dataset.authorName;
                document.getElementById('replyingToBanner').classList.remove('hidden');
                document.getElementById('commentText').focus();
            };
            const linkify = (text) => {
                if (!text) return '';
                const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
                return text.replace(urlRegex, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-indigo-400 hover:underline">${url}</a>`);
            };
            
            // --- L√ìGICA DE DATOS ---
            const detachDetailViewListeners = () => {
                if (activeDetailListeners.likes) activeDetailListeners.likes.unsubscribe();
                if (activeDetailListeners.views) activeDetailListeners.views.unsubscribe();
                if (activeDetailListeners.comments) activeDetailListeners.comments.unsubscribe();
                activeDetailListeners = {};
            };

            const getAuthorData = async (uid) => {
                if (!uid) return { username: 'An√≥nimo', profile: {} };
                if (usersCache[uid]) return usersCache[uid];
                const snapshot = await get(ref(db, `users/${uid}`));
                if (snapshot.exists()) {
                    usersCache[uid] = snapshot.val();
                    return usersCache[uid];
                }
                return { username: 'An√≥nimo', profile: {} };
            };

            async function loadCuratedImages() {
                if (!globalAdminUID) {
                    console.error("Error al cargar im√°genes curadas: UID de admin no establecido.");
                    return;
                }
                try {
                    const response = await fetch('imagenes.json');
                    if (!response.ok) throw new Error('Network response was not ok');
                    const images = await response.json();
                    allImages = images.map(img => ({ ...img, isPost: false, authorUid: globalAdminUID }));
                    let allTagsSet = new Set();
                    allImages.forEach(img => (img.tags || []).forEach(tag => allTagsSet.add(tag.trim().toLowerCase())));
                    window.allTags = Array.from(allTagsSet);
                } catch (error) { console.error("Fallo al cargar imagenes.json:", error); showToast("No se pudieron cargar las im√°genes oficiales."); }
            }

            function setupPostsListener() {
                const postsRef = query(ref(db, 'posts'), orderByChild('timestamp'));
                onValue(postsRef, snapshot => {
                    const posts = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            posts.push({ ...childSnapshot.val(), id: childSnapshot.key, isPost: true });
                        });
                    }
                    allPosts = posts.reverse();
                    
                    if (appInitialized) {
                        const currentVisibleView = document.querySelector('.view:not(.hidden)');
                        if (currentVisibleView?.id === 'feedView') renderUserFeed(true);
                        if (currentVisibleView?.id === 'followingView') renderFollowingFeed(true);
                        if (currentVisibleView?.id === 'profileView' || currentVisibleView?.id === 'userProfileView') {
                            const visibleProfileId = currentVisibleView.dataset.userId;
                            if (visibleProfileId) {
                                populateProfileView(visibleProfileId);
                            }
                        }
                    }
                });
            }

            function setupUsersListener() {
                const usersRef = ref(db, 'users');
                onValue(usersRef, (snapshot) => {
                    if (snapshot.exists()) {
                        usersCache = snapshot.val();
                    }
                });
            }

            // --- NAVEGACI√ìN Y RENDERIZADO ---
            function navigateTo(viewId) {
                document.querySelectorAll('.view').forEach(v => {
                    v.classList.add('hidden');
                    v.classList.remove('active');
                });
                const targetView = document.getElementById(viewId);
                if (!targetView) return;

                targetView.classList.remove('hidden');
                setTimeout(() => targetView.classList.add('active'), 10); // Para la transici√≥n de opacidad

                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === viewId);
                });
                document.getElementById('navProfileAvatar').closest('.nav-btn').classList.toggle('active', viewId === 'profileView');
                
                if (targetView.classList.contains('slide-up')) {
                    setTimeout(() => targetView.classList.add('active'), 10);
                }
            }
            
            function triggerView(viewId) {
                switch(viewId) {
                    case 'galleryView': navigateTo(viewId); break;
                    case 'feedView': renderUserFeed(true); navigateTo(viewId); break;
                    case 'followingView': renderFollowingFeed(true); navigateTo(viewId); break;
                    case 'popularView': renderPopularGallery(); navigateTo(viewId); break;
                    case 'profileView': populateProfileView(currentUser.uid); break; 
                    case 'searchView': 
                        navigateTo(viewId); 
                        document.getElementById('searchInput').focus(); 
                        renderSearchResults(document.getElementById('searchInput').value);
                        break;
                }
            }

            async function appendToImageGrid(container, itemsToRender) {
                for (const item of itemsToRender) {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 rounded-lg overflow-hidden cursor-pointer group portrait-aspect';
                    const imageUrl = item.isPost ? item.imageUrl : item.url;
                    
                    let authorOverlay = '';
                    let adminControls = '';
                    
                    const authorData = await getAuthorData(item.authorUid);
                    const isVerified = item.authorUid === globalAdminUID;

                    authorOverlay = `
                        <div class="card-author-overlay">
                            <img src="${authorData.profile?.avatar || ''}" alt="${authorData.username}" class="bg-gray-700">
                            <span class="text-white text-sm font-semibold truncate">${authorData.username}</span>
                            ${isVerified ? '<i class="fas fa-check-circle text-blue-400 text-sm ml-1"></i>' : ''}
                        </div>
                    `;
                    
                    if (isCurrentUserAdmin && item.isPost) {
                        adminControls = `<button class="admin-delete-btn" data-post-id="${item.id}" title="Eliminar publicaci√≥n"><i class="fas fa-trash-alt"></i></button>`;
                    }

                    card.innerHTML = `${authorOverlay}${adminControls}<img src="${imageUrl}" alt="${item.title}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/400x600/1f2937/a7a7a7?text=Error';" class="transition-transform duration-300 group-hover:scale-105"><div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div><h3 class="absolute bottom-0 left-0 p-2 text-white font-semibold text-sm truncate w-full">${item.title}</h3>`;
                    
                    card.addEventListener('click', (e) => {
                        if (e.target.closest('.admin-delete-btn')) return;
                        showDetailView(item.id, item.isPost);
                    });
                    
                    container.appendChild(card);
                }
            }

            function sortCuratedFeed() {
                const userInterests = new Set(currentUserData.profile?.interests || []);
                sortedCuratedContent = [...allImages].sort((a, b) => {
                   const scoreA = (a.tags || []).reduce((s, tag) => s + (userInterests.has(tag) ? 5 : 0), 0) + Math.random();
                   const scoreB = (b.tags || []).reduce((s, tag) => s + (userInterests.has(tag) ? 5 : 0), 0) + Math.random();
                   return scoreB - scoreA;
                });
            }

            function renderCuratedFeed(reset = false) {
                if (isGalleryLoading) return;
                isGalleryLoading = true;
                showLoader('galleryLoader', true);
                const galleryContainer = document.getElementById('gallery');
                if (reset) { galleryContainer.innerHTML = ''; loadedCuratedCount = 0; }
                const nextItems = sortedCuratedContent.slice(loadedCuratedCount, loadedCuratedCount + itemsPerLoad);
                if (nextItems.length > 0) {
                    appendToImageGrid(galleryContainer, nextItems);
                    loadedCuratedCount += nextItems.length;
                } else if (reset && sortedCuratedContent.length === 0) {
                    galleryContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 py-8">No hay contenido oficial para mostrar.</p>`;
                }
                showLoader('galleryLoader', false);
                isGalleryLoading = false;
            }

            function renderUserFeed(reset = false) {
                if (isFeedLoading) return;
                isFeedLoading = true;
                showLoader('feedLoader', true);
                const feedContainer = document.getElementById('feedGrid');
                if (reset) { feedContainer.innerHTML = ''; loadedFeedCount = 0; }
                const nextItems = allPosts.slice(loadedFeedCount, loadedFeedCount + itemsPerLoad);
                if (nextItems.length > 0) {
                    appendToImageGrid(feedContainer, nextItems);
                    loadedFeedCount += nextItems.length;
                } else if (reset && allPosts.length === 0) {
                    feedContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 py-8">A√∫n no hay publicaciones de la comunidad. ¬°S√© el primero!</p>`;
                }
                showLoader('feedLoader', false);
                isFeedLoading = false;
            }

            async function renderFollowingFeed(reset = false) {
                if (isFollowingLoading) return;
                isFollowingLoading = true;
                showLoader('followingLoader', true);
                const followingContainer = document.getElementById('followingGrid');
                if (reset) { followingContainer.innerHTML = ''; loadedFollowingCount = 0; }
                
                const followingSnapshot = await get(ref(db, `following/${currentUser.uid}`));
                const followingIds = Object.keys(followingSnapshot.val() || {});

                if (followingIds.length === 0) {
                    followingContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 py-8">A√∫n no sigues a nadie. ¬°Explora la comunidad!</p>`;
                    showLoader('followingLoader', false);
                    isFollowingLoading = false;
                    return;
                }

                const postsFromFollowing = allPosts.filter(post => followingIds.includes(post.authorUid));
                
                const nextItems = postsFromFollowing.slice(loadedFollowingCount, loadedFollowingCount + itemsPerLoad);

                if (nextItems.length > 0) {
                    appendToImageGrid(followingContainer, nextItems);
                    loadedFollowingCount += nextItems.length;
                } else if (reset && postsFromFollowing.length === 0) {
                    followingContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 py-8">Las personas que sigues no han publicado nada nuevo.</p>`;
                }
                showLoader('followingLoader', false);
                isFollowingLoading = false;
            }

            // --- EVENT LISTENERS ---
            function setupAuthEventListeners() {
                document.getElementById('showLoginModalBtn').addEventListener('click', () => showModal('loginModal'));
                document.getElementById('showRegisterModalBtn').addEventListener('click', () => showModal('registerModal'));
                document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal-container');
                    if (modal) modal.classList.add('hidden');
                }));
                document.getElementById('showForgotPasswordModalBtn').addEventListener('click', () => { hideModal('loginModal'); showModal('forgotPasswordModal'); });
                
                document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('forgotPasswordEmail').value;
                    try {
                        await sendPasswordResetEmail(auth, email);
                        showToast('Correo de restablecimiento enviado. Revisa tu bandeja de entrada.');
                        hideModal('forgotPasswordModal');
                    } catch (error) { showToast(getFirebaseErrorMessage(error)); }
                });

                document.getElementById('registerForm').addEventListener('submit', async e => {
                    e.preventDefault();
                    const usernameInput = e.target.registerUsername.value.trim();
                    if (usernameInput.length > USERNAME_MAX_LENGTH) return showToast(`El nombre de usuario no puede exceder los ${USERNAME_MAX_LENGTH} caracteres.`);
                    
                    const email = e.target.registerEmail.value.trim();
                    const password = e.target.registerPassword.value;
                    if (password !== e.target.registerPasswordConfirm.value) return showToast("Las contrase√±as no coinciden.");
                    
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        
                        let profileData;
                        const defaultAvatar = `https://api.dicebear.com/8.x/bottts-neutral/svg?seed=${encodeURIComponent(usernameInput || 'user')}`;

                        if (email === ADMIN_EMAIL) {
                            profileData = {
                                username: ADMIN_USERNAME,
                                profile: { 
                                    avatar: 'https://files.catbox.moe/n86yjv.png', 
                                    bio: 'Administrador de Exene.', 
                                    interests: [],
                                    profileColor: '#1e40af',
                                    bannerUrl: '',
                                    socials: {},
                                    commentCount: 0
                                }
                            };
                        } else {
                            profileData = {
                                username: usernameInput,
                                profile: { 
                                    avatar: defaultAvatar, 
                                    bio: '', 
                                    interests: [],
                                    profileColor: '#4f46e5',
                                    bannerUrl: '',
                                    socials: {},
                                    commentCount: 0
                                }
                            };
                        }
                        
                        await set(ref(db, `users/${userCredential.user.uid}`), profileData);
                        hideModal('registerModal');
                    } catch (error) { showToast(getFirebaseErrorMessage(error)); }
                });

                document.getElementById('loginForm').addEventListener('submit', async e => {
                    e.preventDefault();
                    try {
                        await signInWithEmailAndPassword(auth, e.target.loginEmail.value, e.target.loginPassword.value);
                        hideModal('loginModal');
                    } catch (error) { showToast(getFirebaseErrorMessage(error)); }
                });
            }

            function setupAppEventListeners() {
                if(document.body.dataset.appListenersAttached === 'true') return;
                
                document.querySelectorAll('.nav-btn[data-view]').forEach(btn => {
                    btn.addEventListener('click', () => triggerView(btn.dataset.view));
                });
                document.getElementById('createPostBtn').addEventListener('click', () => showModal('createPostModal'));
                document.getElementById('adminAddCuratedBtn')?.addEventListener('click', () => showModal('adminAddCuratedModal'));
                document.getElementById('avatarUrlForm').addEventListener('submit', e => {
                    e.preventDefault();
                    const input = document.getElementById('avatarUrlInput');
                    if (input.value) updateAvatar(input.value.trim());
                    input.value = '';
                });

                const notificationsBtn = document.getElementById('navNotificationsBtn');
                const notificationsPanel = document.getElementById('notificationsWindow');
                notificationsBtn.addEventListener('click', (e) => { e.stopPropagation(); notificationsPanel.classList.toggle('active'); });
                document.addEventListener('click', (e) => {
                    if (!notificationsPanel.contains(e.target) && !notificationsBtn.contains(e.target)) {
                        notificationsPanel.classList.remove('active');
                    }
                });
                new IntersectionObserver(entries => { if (entries[0].isIntersecting && !isGalleryLoading && document.getElementById('galleryView').offsetParent !== null) renderCuratedFeed(false); }, { threshold: 0.1 }).observe(document.getElementById('curated-sentinel'));
                new IntersectionObserver(entries => { if (entries[0].isIntersecting && !isFeedLoading && document.getElementById('feedView').offsetParent !== null) renderUserFeed(false); }, { threshold: 0.1 }).observe(document.getElementById('feed-sentinel'));
                new IntersectionObserver(entries => { if (entries[0].isIntersecting && !isFollowingLoading && document.getElementById('followingView').offsetParent !== null) renderFollowingFeed(false); }, { threshold: 0.1 }).observe(document.getElementById('following-sentinel'));
                
                setupDetailViewEventListeners();
                setupCreatePostForm();
                setupAdminToolListeners();
                setupLegalModalsListeners();
                
                document.getElementById('searchForm').addEventListener('submit', e => e.preventDefault());
                document.getElementById('searchInput').addEventListener('input', e => renderSearchResults(e.target.value));
                
                document.body.dataset.appListenersAttached = 'true';
            }
            
            function setupDetailViewEventListeners() {
                document.getElementById('detailBackBtn').addEventListener('click', () => closeSlideUpView('detailView'));
                
                document.getElementById('detailLikeBtn').addEventListener('click', async function() {
                    if (!this.dataset.id || !currentUser) return;
                    const likeRef = ref(db, `likes/${this.dataset.id}/${currentUser.uid}`);
                    const snap = await get(likeRef);
                    set(likeRef, snap.exists() ? null : true);
                });

                document.getElementById('detailFavoriteBtn').addEventListener('click', async function() {
                    if (!this.dataset.id || !currentUser) return;
                    const dbId = this.dataset.id;
                    const favRef = ref(db, `favorites/${currentUser.uid}/${dbId}`);
                    const snap = await get(favRef);

                    if (snap.exists()) {
                        set(favRef, null); // Unfavoriting
                    } else {
                        // Favoriting
                        await set(favRef, true);
                        await set(ref(db, `users/${currentUser.uid}/profile/achievements/first-favorite`), true);
                        if (isCurrentUserAdmin) {
                            const item = [...allPosts, ...allImages].find(i => String(i.id) === String(dbId));
                            if (item && item.authorUid !== currentUser.uid) {
                                await set(ref(db, `users/${item.authorUid}/profile/achievements/admin-favorite`), true);
                                const notificationRef = push(ref(db, `notifications/${item.authorUid}`));
                                await set(notificationRef, {
                                    message: `¬°A ${currentUserData.username} le ha encantado tu publicaci√≥n! Has ganado un logro.`,
                                    imageId: item.id,
                                    timestamp: serverTimestamp(),
                                    read: false
                                });
                            }
                        }
                    }
                });

                document.getElementById('commentForm').addEventListener('submit', handleCommentSubmit);
                document.getElementById('focusCommentBtn').addEventListener('click', () => document.getElementById('commentText').focus());
                document.getElementById('cancelReplyBtn').addEventListener('click', cancelReply);
                document.getElementById('adminDeletePostBtn').addEventListener('click', function() {
                    handleDeletePost(this.dataset.postId);
                });
            }
            
            function setupCreatePostForm() {
                document.getElementById('createPostForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const imageUrl = document.getElementById('postImageUrl').value.trim();
                    const title = document.getElementById('postTitle').value.trim();
                    const description = document.getElementById('postDescription').value.trim();
                    const tagsInput = document.getElementById('postTags').value.trim();

                    if (!imageUrl || !title) return showToast("La URL y el t√≠tulo son obligatorios.");
                    if (imageUrl.length > URL_MAX_LENGTH) return showToast(`La URL de la imagen no puede exceder los ${URL_MAX_LENGTH} caracteres.`);
                    if (title.length > POST_TITLE_MAX_LENGTH) return showToast(`El t√≠tulo no puede exceder los ${POST_TITLE_MAX_LENGTH} caracteres.`);
                    if (description.length > POST_DESC_MAX_LENGTH) return showToast(`La descripci√≥n no puede exceder los ${POST_DESC_MAX_LENGTH} caracteres.`);
                    if (tagsInput.length > POST_TAGS_MAX_LENGTH) return showToast(`Las etiquetas no pueden exceder los ${POST_TAGS_MAX_LENGTH} caracteres.`);

                    const tags = tagsInput.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag !== '');
                    
                    const newPostRef = push(ref(db, 'posts'));
                    try {
                        await set(newPostRef, {
                            id: newPostRef.key, imageUrl, title, description, tags,
                            authorUid: currentUser.uid,
                            timestamp: serverTimestamp()
                        });
                        
                        await set(ref(db, `users/${currentUser.uid}/profile/achievements/first-post`), true);

                        const userPostsQuery = query(ref(db, 'posts'), orderByChild('authorUid'), equalTo(currentUser.uid));
                        const userPostsSnapshot = await get(userPostsQuery);
                        if (userPostsSnapshot.exists() && Object.keys(userPostsSnapshot.val()).length >= 5) {
                            await set(ref(db, `users/${currentUser.uid}/profile/achievements/five-posts`), true);
                        }

                        document.getElementById('createPostForm').reset();
                        hideModal('createPostModal');
                        showToast("Publicaci√≥n creada con √©xito");
                        triggerView('feedView');
                    } catch (error) { console.error("Error creando post:", error); showToast("No se pudo crear la publicaci√≥n."); }
                });
            }

            // --- VISTAS DETALLADAS Y L√ìGICA DE VISUALIZACI√ìN ---
            async function showDetailView(id, isPost = false) {
                detachDetailViewListeners();
                navigateTo('detailView');
                document.querySelector('#detailView > main').scrollTop = 0;
                const item = isPost ? allPosts.find(p => String(p.id) === String(id)) : allImages.find(i => String(i.id) === String(id));
                if (!item) { showToast('Contenido no encontrado.'); closeSlideUpView('detailView'); return; };
                
                const dbId = String(item.id);
                const authorData = await getAuthorData(item.authorUid);
                const isVerified = item.authorUid === globalAdminUID;
                
                document.getElementById('detailAuthorUsername').textContent = authorData.username;
                document.getElementById('detailAuthorAvatar').src = authorData.profile?.avatar || `https://api.dicebear.com/8.x/initials/svg?seed=${authorData.username}`;
                document.getElementById('detailAuthorVerifiedBadge').innerHTML = isVerified ? '<i class="fas fa-check-circle text-blue-400"></i>' : '';
                document.getElementById('detailAuthorInfo').onclick = () => { 
                    if (item.authorUid === currentUser.uid) {
                        triggerView('profileView');
                    } else {
                        showUserProfile(item.authorUid);
                    }
                };
                document.getElementById('detailTitle').textContent = item.title;
                
                const descriptionEl = document.getElementById('detailDescription');
                descriptionEl.innerHTML = linkify(item.description);
                
                if (currentViewer) currentViewer.destroy();
                const imageViewer = document.getElementById('imageViewer');
                imageViewer.innerHTML = `<img src="${item.isPost ? item.imageUrl : item.url}" alt="${item.title}" onerror="this.parentElement.innerHTML='<p class=\\'p-4 text-red-400\\'>Error al cargar imagen.</p>';">`;
                currentViewer = new Viewer(imageViewer, { navbar: false, toolbar: false, button: true, title: false });
                
                document.getElementById('detailLikeBtn').dataset.id = dbId;
                document.getElementById('detailFavoriteBtn').dataset.id = dbId;
                document.getElementById('commentForm').dataset.imageId = dbId;
                delete document.getElementById('commentForm').dataset.replyToPath;
                
                const adminDeleteBtn = document.getElementById('adminDeletePostBtn');
                if (isCurrentUserAdmin && isPost) {
                    adminDeleteBtn.classList.remove('hidden');
                    adminDeleteBtn.dataset.postId = dbId;
                } else {
                    adminDeleteBtn.classList.add('hidden');
                }

                listenToLikesAndViews(dbId, item.authorUid);
                listenToComments(dbId);
                if (!isPost) renderSimilarImages(item);
                else document.getElementById('similar-section').classList.add('hidden');
                
                set(ref(db, `views/${dbId}/${currentUser.uid}`), true);
            }
            
            async function populateProfileView(userId) {
                const isOwnProfile = userId === currentUser.uid;
                const viewId = isOwnProfile ? 'profileView' : 'userProfileView';
                const viewContainer = document.getElementById(viewId);
                
                if (!isOwnProfile) {
                    navigateTo(viewId);
                } else {
                    navigateTo('profileView');
                }
                viewContainer.dataset.userId = userId;

                const userData = await getAuthorData(userId);
                const profile = userData.profile || {};
                const accentColor = profile.profileColor || '#4f46e5';
                const bannerStyle = profile.bannerUrl 
                    ? `background-image: url('${profile.bannerUrl}')` 
                    : `background-color: ${accentColor}`;

                viewContainer.innerHTML = `
                    <header class="p-4 flex justify-between items-center bg-gray-900/80 backdrop-blur-sm sticky top-0 z-10">
                        ${isOwnProfile ? '<div class="w-10"></div>' : '<button id="userProfileBackBtn" class="text-xl text-gray-400 hover:text-white transition-colors w-10 h-10 flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>'}
                        <h2 class="text-lg font-bold text-white mx-auto">${isOwnProfile ? 'Mi Perfil' : `Perfil de ${userData.username}`}</h2>
                        ${isOwnProfile ? '<button id="logoutBtn" class="text-gray-400 hover:text-white transition-colors w-10 text-xl" title="Cerrar sesi√≥n"><i class="fas fa-sign-out-alt"></i></button>' : '<div class="w-10"></div>'}
                    </header>
                    <div class="overflow-y-auto pb-20">
                        <div class="profile-header" style="${bannerStyle}"></div>
                        <div class="p-4">
                            <div class="profile-avatar-container flex flex-col items-center space-y-2">
                                <div class="relative">
                                    <img src="${profile.avatar || ''}" alt="Avatar" class="w-24 h-24 rounded-full border-4 object-cover bg-gray-700" style="border-color: ${accentColor};">
                                    ${isOwnProfile ? '<button id="changeAvatarBtn" class="absolute bottom-0 right-0 bg-gray-700 hover:bg-gray-600 text-white w-8 h-8 rounded-full flex items-center justify-center border-2 border-gray-900"><i class="fas fa-pen text-xs"></i></button>' : ''}
                                </div>
                                <div class="text-center">
                                    <h3 class="text-2xl font-bold text-white">${userData.username}</h3>
                                    <div class="flex justify-center items-center gap-4 mt-2 text-sm text-gray-400">
                                        <span id="followerCount"><strong>0</strong> Seguidores</span>
                                        <span id="followingCount"><strong>0</strong> Siguiendo</span>
                                    </div>
                                </div>
                                <p class="text-gray-400 text-center text-sm max-w-md pt-2">${profile.bio || 'Sin biograf√≠a.'}</p>
                                <div id="profileSocials" class="flex items-center gap-4 text-xl mt-2"></div>
                                ${!isOwnProfile ? `<button id="followBtn" data-user-id="${userId}" class="mt-4 px-6 py-2 text-sm font-bold rounded-full transition-colors"></button>` : ''}
                            </div>

                            <div class="mt-6 bg-gray-800/50 p-4 rounded-lg shadow-md">
                                <h4 class="text-sm font-bold text-gray-400 mb-3 text-center uppercase tracking-wider">Logros</h4>
                                <div id="profileAchievements" class="flex flex-wrap justify-center gap-3"></div>
                            </div>
                            
                            <div class="mt-6 border-b border-gray-700">
                                <nav class="-mb-px flex space-x-2 sm:space-x-6" aria-label="Tabs">
                                    <button data-tab="posts" class="profile-tab tab-active" style="border-color: ${accentColor}; color: white;">Publicaciones</button>
                                    <button data-tab="favorites" class="profile-tab">Favoritos</button>
                                    ${isOwnProfile ? '<button data-tab="settings" class="profile-tab">Ajustes</button>' : ''}
                                </nav>
                            </div>

                            <div data-content="posts" class="profile-tab-content mt-4"><div id="userPostsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div><p id="no-posts-message" class="text-center text-gray-500 hidden py-8">No hay publicaciones.</p></div>
                            <div data-content="favorites" class="profile-tab-content mt-4 hidden"><div id="favoritesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div><p id="no-favorites-message" class="text-center text-gray-500 hidden py-8">No ha guardado ninguna imagen.</p></div>
                            ${isOwnProfile ? `
                            <div data-content="settings" class="profile-tab-content mt-4 hidden space-y-6">
                                <div>
                                    <h4 class="text-lg font-bold text-white mb-2">Personalizaci√≥n</h4>
                                    <label for="profileBannerUrl" class="block text-sm font-medium text-gray-400 mb-1">URL del Banner de Perfil</label>
                                    <input type="url" id="profileBannerUrl" value="${profile.bannerUrl || ''}" placeholder="https://..." maxlength="${URL_MAX_LENGTH}" class="w-full bg-gray-800 text-white rounded-md p-2 border border-gray-700 focus:ring-indigo-500 focus:border-indigo-500">
                                    <label for="profileColorPicker" class="block text-sm font-medium text-gray-400 mt-3 mb-1">Color de Acento</label>
                                    <input type="color" id="profileColorPicker" value="${accentColor}" class="w-full h-10 p-1 bg-gray-800 border border-gray-700 rounded-md cursor-pointer">
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-white mb-2">Redes Sociales</h4>
                                    <div class="space-y-3">
                                        <div><label for="socialTwitter" class="block text-sm font-medium text-gray-400 mb-1">Twitter (URL)</label><input type="url" id="socialTwitter" value="${profile.socials?.twitter || ''}" placeholder="https://twitter.com/usuario" maxlength="${SOCIAL_URL_MAX_LENGTH}" class="w-full bg-gray-800 text-white rounded-md p-2 border border-gray-700"></div>
                                        <div><label for="socialInstagram" class="block text-sm font-medium text-gray-400 mb-1">Instagram (URL)</label><input type="url" id="socialInstagram" value="${profile.socials?.instagram || ''}" placeholder="https://instagram.com/usuario" maxlength="${SOCIAL_URL_MAX_LENGTH}" class="w-full bg-gray-800 text-white rounded-md p-2 border border-gray-700"></div>
                                        <div><label for="socialWebsite" class="block text-sm font-medium text-gray-400 mb-1">Sitio Web (URL)</label><input type="url" id="socialWebsite" value="${profile.socials?.website || ''}" placeholder="https://mi-pagina.com" maxlength="${SOCIAL_URL_MAX_LENGTH}" class="w-full bg-gray-800 text-white rounded-md p-2 border border-gray-700"></div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-white mb-2">Intereses</h4>
                                    <div class="flex justify-between items-center mb-2"><p class="text-sm font-medium text-gray-400">Tus intereses</p><p id="interestCounter" class="text-sm text-gray-500">0/10</p></div>
                                    <div class="relative mb-2"><input id="interestSearchInput" type="search" placeholder="Buscar intereses..." class="w-full bg-gray-800 text-white rounded-full pl-10 pr-4 py-2 border border-gray-700"><i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i></div>
                                    <div id="profileInterests" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto"></div>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-white mb-2">Biograf√≠a</h4>
                                    <textarea id="profileBioInput" rows="3" maxlength="${BIO_MAX_LENGTH}" class="w-full bg-gray-800 text-white rounded-md p-2 border border-gray-700" placeholder="Describe algo sobre ti...">${profile.bio || ''}</textarea>
                                </div>
                                <button id="saveProfileBtn" class="w-full text-white font-bold py-3 px-4 rounded-md transition-colors mt-4" style="background-color: ${accentColor};">Guardar Cambios</button>
                            </div>` : ''}
                        </div>
                    </div>
                `;
                
                updateFollowCounts(userId);
                renderUserPosts(userId, 'userPostsGrid', 'no-posts-message');
                renderPublicFavorites(userId, 'favoritesGrid', 'no-favorites-message');
                renderSocials(profile.socials, 'profileSocials');
                checkAndRenderAchievements(userId, 'profileAchievements');

                if (isOwnProfile) {
                    renderProfileInterests();
                    document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
                    document.getElementById('changeAvatarBtn').addEventListener('click', () => showModal('avatarModal'));
                    document.getElementById('saveProfileBtn').addEventListener('click', saveProfileChanges);
                    document.getElementById('interestSearchInput').addEventListener('input', e => {
                        const query = e.target.value.toLowerCase();
                        document.querySelectorAll('#profileInterests button').forEach(btn => {
                            btn.style.display = btn.textContent.toLowerCase().includes(query) ? '' : 'none';
                        });
                    });
                } else {
                    document.getElementById('userProfileBackBtn').addEventListener('click', () => closeSlideUpView('userProfileView'));
                    const followBtn = document.getElementById('followBtn');
                    followBtn.addEventListener('click', () => toggleFollow(userId));
                    updateFollowButton(userId);
                }

                viewContainer.querySelectorAll('.profile-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const activeTab = e.currentTarget;
                        viewContainer.querySelectorAll('.profile-tab').forEach(item => {
                            item.classList.remove('tab-active');
                            item.style.borderColor = 'transparent';
                            item.style.color = '#9ca3af';
                        });
                        activeTab.classList.add('tab-active');
                        activeTab.style.borderColor = accentColor;
                        activeTab.style.color = 'white';
                        viewContainer.querySelectorAll('.profile-tab-content').forEach(content => {
                            content.classList.toggle('hidden', content.dataset.content !== activeTab.dataset.tab);
                        });
                    });
                });
            }

            async function showUserProfile(userId) {
                await populateProfileView(userId);
            }

            function listenToLikesAndViews(id, authorUid) {
                const likesRef = ref(db, `likes/${id}`);
                const viewsRef = ref(db, `views/${id}`);
                
                const likesUnsubscribe = onValue(likesRef, snap => {
                    const data = snap.val() || {};
                    const likeCount = Object.keys(data).length;
                    
                    const likeCountEl = document.getElementById('detailLikeCount');
                    if (likeCountEl) likeCountEl.textContent = `${likeCount} Me gusta`;
                    
                    const detailLikeBtn = document.getElementById('detailLikeBtn');
                    if(detailLikeBtn) detailLikeBtn.classList.toggle('liked', !!(currentUser && data[currentUser.uid]));

                    if (likeCount >= 10) {
                        set(ref(db, `users/${authorUid}/profile/achievements/popular-post`), true);
                    }
                });
                
                const viewsUnsubscribe = onValue(viewsRef, snap => {
                    const viewCountEl = document.getElementById('detailViewCount');
                    if (viewCountEl) viewCountEl.textContent = `${Object.keys(snap.val() || {}).length} Vistas`;
                });
                
                activeDetailListeners.likes = { unsubscribe: likesUnsubscribe };
                activeDetailListeners.views = { unsubscribe: viewsUnsubscribe };
            }
            
            function listenToComments(imageId) {
                const commentsQuery = query(ref(db, `comments/${imageId}`), orderByChild('timestamp'));
                
                const commentsUnsubscribe = onValue(commentsQuery, snapshot => {
                    const list = document.getElementById('commentsList');
                    if (!list) return;
                    list.innerHTML = '';
                    if (!snapshot.exists()) {
                        list.innerHTML = `<p class="text-gray-500 text-center text-sm py-4">S√© el primero en comentar.</p>`;
                        return;
                    }
                    
                    snapshot.forEach(parentCommentSnapshot => {
                        const parentData = { id: parentCommentSnapshot.key, ...parentCommentSnapshot.val() };
                        const parentPath = `comments/${imageId}/${parentData.id}`;
                        const parentElement = createCommentElement(parentData, parentPath);

                        if (parentCommentSnapshot.hasChild('replies')) {
                            const repliesContainer = document.createElement('div');
                            repliesContainer.className = 'replies-container';

                            const replies = Object.entries(parentCommentSnapshot.child('replies').val()).map(([key, value]) => ({...value, id: key}));
                            replies.sort((a, b) => a.timestamp - b.timestamp);

                            replies.forEach(replyData => {
                                const replyPath = `${parentPath}/replies/${replyData.id}`;
                                const replyElement = createCommentElement(replyData, replyPath);
                                repliesContainer.appendChild(replyElement);
                            });
                            
                            parentElement.querySelector('.comment-content').appendChild(repliesContainer);
                        }
                        
                        list.appendChild(parentElement);
                    });
                });
                
                activeDetailListeners.comments = { unsubscribe: commentsUnsubscribe };
            }
            
            function createCommentElement(commentData, path) {
                const li = document.createElement('li');
                li.className = 'comment-item';
                li.dataset.commentPath = path;
                li.dataset.authorName = commentData.username;
                const isVerified = commentData.authorUid === globalAdminUID;

                const adminDeleteButton = isCurrentUserAdmin ? `<button class="admin-delete-comment-btn" title="Eliminar comentario"><i class="fas fa-trash-alt"></i></button>` : '';
                
                const replyingToHTML = commentData.replyToUsername 
                    ? `<p class="replying-to-text">Respondiendo a <strong>@${commentData.replyToUsername}</strong></p>`
                    : '';

                li.innerHTML = `
                    <img src="${commentData.userAvatar || ''}" class="w-8 h-8 rounded-full flex-shrink-0 object-cover bg-gray-700 cursor-pointer" data-userid="${commentData.authorUid}">
                    <div class="comment-content">
                        <div class="comment-body">
                            <span class="font-bold text-sm text-white cursor-pointer hover:underline flex items-center gap-2" data-userid="${commentData.authorUid}">${commentData.username}${isVerified ? '<i class="fas fa-check-circle text-blue-400 text-xs ml-1"></i>' : ''}</span>
                            ${replyingToHTML}
                            <p class="text-gray-300 mt-1 break-words">${linkify(commentData.text)}</p>
                        </div>
                        <div class="comment-actions">
                            <button class="hover:underline reply-btn">Responder</button>
                            ${adminDeleteButton}
                        </div>
                    </div>`;
                
                li.querySelector('.reply-btn').addEventListener('click', e => initiateReply(e.currentTarget.closest('li')));
                
                const adminBtn = li.querySelector('.admin-delete-comment-btn');
                if (adminBtn) adminBtn.addEventListener('click', (e) => { e.stopPropagation(); handleDeleteComment(path); });

                li.querySelectorAll('[data-userid]').forEach(el => {
                    el.addEventListener('click', e => {
                        e.stopPropagation();
                        if (el.dataset.userid === currentUser.uid) { 
                            const activeSlideUp = document.querySelector('.view.slide-up.active');
                            if(activeSlideUp) closeSlideUpView(activeSlideUp.id); 
                            setTimeout(() => triggerView('profileView'), 300); 
                        }
                        else { showUserProfile(el.dataset.userid); }
                    });
                });

                return li;
            }
            
            async function handleCommentSubmit(e) {
                e.preventDefault();
                const textInput = document.getElementById('commentText');
                const text = textInput.value.trim();
                const imageId = document.getElementById('commentForm').dataset.imageId;
                
                if (!text || !imageId) return;
                if (text.length > COMMENT_MAX_LENGTH) return showToast(`El comentario no puede exceder los ${COMMENT_MAX_LENGTH} caracteres.`);
                
                const replyToPath = document.getElementById('commentForm').dataset.replyToPath;
                const authorName = document.getElementById('commentForm').dataset.authorName;
                
                const commentData = { 
                    text, 
                    timestamp: serverTimestamp(), 
                    username: currentUserData.username, 
                    authorUid: currentUser.uid, 
                    userAvatar: currentUserData.profile.avatar 
                };

                if (replyToPath && authorName) {
                    commentData.replyToUsername = authorName;
                }

                try {
                    const refPath = replyToPath ? `${replyToPath}/replies` : `comments/${imageId}`;
                    await set(push(ref(db, refPath)), commentData);

                    const userRef = ref(db, `users/${currentUser.uid}/profile`);
                    const newCount = (currentUserData.profile.commentCount || 0) + 1;
                    
                    const updates = {};
                    updates.commentCount = newCount;
                    if (!currentUserData.profile?.achievements?.['first-comment']) {
                        updates['achievements/first-comment'] = true;
                    }
                    if (newCount >= 25) {
                        updates['achievements/prolific-commenter'] = true;
                    }
                    await update(userRef, updates);

                    cancelReply();
                    textInput.value = '';
                } catch (error) { console.error(error); showToast("No se pudo enviar el comentario."); }
            }
            
            function listenToNotifications() {
                if (!currentUser) return;
                const notificationsRef = ref(db, `notifications/${currentUser.uid}`);
                onValue(notificationsRef, snapshot => {
                    const list = document.getElementById('notificationsList');
                    const badge = document.getElementById('navNotificationsBadge');
                    const panel = document.getElementById('notificationsWindow');
                    list.innerHTML = '';
                    if(!snapshot.exists()) {
                        badge.classList.add('hidden');
                        return list.innerHTML = `<p class="p-4 text-center text-gray-500">No tienes notificaciones.</p>`;
                    }
                    const notifications = Object.entries(snapshot.val()).map(([id, data]) => ({id, ...data}));
                    badge.classList.toggle('hidden', notifications.filter(n => !n.read).length === 0);
                    notifications.reverse().forEach(n => {
                        const el = document.createElement('div');
                        el.className = `px-4 py-3 hover:bg-gray-700 cursor-pointer ${n.read ? 'opacity-60' : 'font-semibold'}`;
                        el.innerHTML = `<p>${n.message || 'Nueva notificaci√≥n'}</p><p class="text-xs text-gray-500 mt-1 font-normal">${new Date(n.timestamp).toLocaleString()}</p>`;
                        el.onclick = () => {
                            panel.classList.remove('active');
                            const isPost = allPosts.some(p => p.id === n.imageId);
                            showDetailView(n.imageId, isPost);
                            set(ref(db, `notifications/${currentUser.uid}/${n.id}/read`), true);
                        };
                        list.appendChild(el);
                    });
                });
            }

            // --- FUNCIONES DE PERFIL Y B√öSQUEDA ---
            function renderUserPosts(userId, gridId, messageId) {
                const container = document.getElementById(gridId);
                const message = document.getElementById(messageId);
                if(!container || !message) return;
                container.innerHTML = '';
                const userPosts = allPosts.filter(p => p.authorUid === userId);
                message.classList.toggle('hidden', userPosts.length > 0);
                if(userPosts.length > 0) appendToImageGrid(container, userPosts); 
            }
            
            function renderPublicFavorites(userId, gridId, messageId) {
                listenToUserFavorites(userId, (favoriteItems) => {
                    const container = document.getElementById(gridId);
                    const message = document.getElementById(messageId);
                    if(!container || !message) return;
                    container.innerHTML = '';
                    message.classList.toggle('hidden', favoriteItems.length > 0);
                    if(favoriteItems.length > 0) appendToImageGrid(container, favoriteItems.reverse());
                });
            }
            
            function listenToUserFavorites(userId, callback) {
                if(!userId) return;
                onValue(ref(db, `favorites/${userId}`), snap => {
                    const favoriteIds = Object.keys(snap.val() || {});
                    const favoriteItems = [...allImages, ...allPosts].filter(item => favoriteIds.includes(String(item.id)));
                    if(callback) callback(favoriteItems);
                });
            }

            async function updateAvatar(url) {
                if (url.length > URL_MAX_LENGTH) return showToast(`La URL del avatar no puede exceder los ${URL_MAX_LENGTH} caracteres.`);
                try {
                    const validUrl = /^(https?:\/\/[^\s$.?#].[^\s]*)$/i.test(url);
                    if (!validUrl) throw new Error("URL no v√°lida");
                    
                    await update(ref(db, `users/${currentUser.uid}/profile`), { avatar: url });
                    currentUserData.profile.avatar = url;
                    updateAllAvatars(url);
                    hideModal('avatarModal');
                    showToast("Avatar actualizado");
                } catch (error) { showToast("La URL de la imagen no parece ser v√°lida."); }
            }
            
            function updateAllAvatars(url) {
                const profileAvatar = document.querySelector('#profileView img, #userProfileView img');
                if (profileAvatar) profileAvatar.src = url;
                document.getElementById('navProfileAvatar').src = url;
                document.getElementById('commentFormAvatar').src = url;
            }
            
            function renderSearchResults(query) {
                query = query.toLowerCase().trim();
                const postResultsContainer = document.getElementById('postResults');
                const userResultsContainer = document.getElementById('userResults');
                const countEl = document.getElementById('searchResultCount');
                const userSection = document.getElementById('userResultsSection');
                const postSection = document.getElementById('postResultsSection');
                const noResultsMsg = document.getElementById('noResultsMessage');

                postResultsContainer.innerHTML = '';
                userResultsContainer.innerHTML = '';

                if (!query) {
                    countEl.textContent = '';
                    userSection.classList.add('hidden');
                    postSection.classList.add('hidden');
                    noResultsMsg.classList.add('hidden');
                    return;
                }

                const postResults = [...allImages, ...allPosts].filter(item => {
                    const titleMatch = item.title.toLowerCase().includes(query);
                    const tagMatch = (item.tags || []).some(tag => tag.toLowerCase().includes(query));
                    return titleMatch || tagMatch;
                });

                const userResults = Object.entries(usersCache)
                    .map(([uid, data]) => ({ uid, ...data }))
                    .filter(user => user.username.toLowerCase().includes(query));

                const totalResults = postResults.length + userResults.length;
                countEl.textContent = `${totalResults} resultado(s) encontrado(s).`;

                if (userResults.length > 0) {
                    userSection.classList.remove('hidden');
                    userResults.forEach(user => {
                        const userCard = document.createElement('div');
                        userCard.className = 'flex items-center p-2 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors';
                        userCard.innerHTML = `
                            <img src="${user.profile?.avatar || ''}" alt="${user.username}" class="w-10 h-10 rounded-full object-cover mr-3 bg-gray-700">
                            <span class="font-semibold text-white">${user.username}</span>
                            <i class="fas fa-chevron-right text-gray-500 ml-auto"></i>
                        `;
                        userCard.addEventListener('click', () => showUserProfile(user.uid));
                        userResultsContainer.appendChild(userCard);
                    });
                } else {
                    userSection.classList.add('hidden');
                }

                if (postResults.length > 0) {
                    postSection.classList.remove('hidden');
                    appendToImageGrid(postResultsContainer, postResults);
                } else {
                    postSection.classList.add('hidden');
                }

                noResultsMsg.classList.toggle('hidden', totalResults > 0);
            }

            function renderProfileInterests() {
                const container = document.getElementById('profileInterests');
                const counterEl = document.getElementById('interestCounter');
                if(!container || !counterEl) return;

                container.innerHTML = '';
                const userInterests = new Set(currentUserData.profile?.interests || []);
                (window.allTags || []).forEach(tag => {
                    const isSelected = userInterests.has(tag);
                    const tagEl = document.createElement('button');
                    tagEl.textContent = tag;
                    tagEl.dataset.tag = tag;
                    tagEl.className = `px-3 py-1 text-sm rounded-full cursor-pointer transition-colors ${isSelected ? 'bg-indigo-600 text-white' : 'bg-gray-700 text-gray-300'}`;
                    tagEl.addEventListener('click', () => {
                        const selectedCount = container.querySelectorAll('.bg-indigo-600').length;
                        if (!tagEl.classList.contains('bg-indigo-600') && selectedCount >= INTEREST_LIMIT) {
                            showToast(`Puedes elegir hasta ${INTEREST_LIMIT} intereses.`);
                            return;
                        }
                        tagEl.classList.toggle('bg-indigo-600');
                        tagEl.classList.toggle('text-white');
                        tagEl.classList.toggle('bg-gray-700');
                        tagEl.classList.toggle('text-gray-300');
                        updateInterestCounter();
                    });
                    container.appendChild(tagEl);
                });
                updateInterestCounter();
            }
            
            function updateInterestCounter() {
                const container = document.getElementById('profileInterests');
                const counterEl = document.getElementById('interestCounter');
                if(!container || !counterEl) return;
                const count = container.querySelectorAll('.bg-indigo-600').length;
                counterEl.textContent = `${count}/${INTEREST_LIMIT}`;
                counterEl.classList.toggle('text-red-500', count >= INTEREST_LIMIT);
            }

            function renderSocials(socials, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                if (!socials) return;

                const socialMap = {
                    twitter: { icon: 'fab fa-twitter', color: 'text-blue-400' },
                    instagram: { icon: 'fab fa-instagram', color: 'text-pink-500' },
                    website: { icon: 'fas fa-globe', color: 'text-gray-400' }
                };

                for (const [key, url] of Object.entries(socials)) {
                    if (url && socialMap[key]) {
                        const link = document.createElement('a');
                        link.href = url;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.className = `social-icon-link hover:${socialMap[key].color}`;
                        link.innerHTML = `<i class="${socialMap[key].icon}"></i>`;
                        container.appendChild(link);
                    }
                }
            }

            async function checkAndRenderAchievements(userId, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const userAchievementsSnapshot = await get(ref(db, `users/${userId}/profile/achievements`));
                const userAchievements = userAchievementsSnapshot.val() || {};
                
                let earnedAchievements = [];
                for (const key in userAchievements) {
                    if (userAchievements[key] && ACHIEVEMENTS[key]) {
                        earnedAchievements.push(ACHIEVEMENTS[key]);
                    }
                }
                
                container.innerHTML = '';
                if (earnedAchievements.length > 0) {
                    earnedAchievements.forEach(ach => {
                        const badge = document.createElement('div');
                        badge.className = 'achievement-badge';
                        badge.title = ach.description;
                        badge.innerHTML = `<i class="fas ${ach.icon}"></i> <span>${ach.title}</span>`;
                        container.appendChild(badge);
                    });
                } else {
                    container.innerHTML = `<p class="text-gray-500 text-xs">No hay logros a√∫n.</p>`;
                }
            }

            async function saveProfileChanges() {
                const bio = document.getElementById('profileBioInput').value;
                const bannerUrl = document.getElementById('profileBannerUrl').value.trim();
                const socials = {
                    twitter: document.getElementById('socialTwitter').value.trim(),
                    instagram: document.getElementById('socialInstagram').value.trim(),
                    website: document.getElementById('socialWebsite').value.trim()
                };

                if (bio.length > BIO_MAX_LENGTH) return showToast(`La biograf√≠a no puede exceder los ${BIO_MAX_LENGTH} caracteres.`);
                if (bannerUrl.length > URL_MAX_LENGTH) return showToast(`La URL del banner no puede exceder los ${URL_MAX_LENGTH} caracteres.`);
                if (socials.twitter.length > SOCIAL_URL_MAX_LENGTH) return showToast(`La URL de Twitter no puede exceder los ${SOCIAL_URL_MAX_LENGTH} caracteres.`);
                if (socials.instagram.length > SOCIAL_URL_MAX_LENGTH) return showToast(`La URL de Instagram no puede exceder los ${SOCIAL_URL_MAX_LENGTH} caracteres.`);
                if (socials.website.length > SOCIAL_URL_MAX_LENGTH) return showToast(`La URL del sitio web no puede exceder los ${SOCIAL_URL_MAX_LENGTH} caracteres.`);

                const interests = Array.from(document.querySelectorAll('#profileInterests .bg-indigo-600')).map(el => el.dataset.tag);
                const profileColor = document.getElementById('profileColorPicker').value;
                
                try {
                    const profileUpdates = { bio, interests, profileColor, bannerUrl, socials };
                    await update(ref(db, `users/${currentUser.uid}/profile`), profileUpdates);
                    
                    currentUserData.profile = { ...currentUserData.profile, ...profileUpdates };
                    
                    showToast('Perfil guardado');
                    populateProfileView(currentUser.uid);
                } catch (error) { 
                    console.error("Error al guardar el perfil:", error); 
                    showToast("Error al guardar el perfil."); 
                }
            }
            
            async function renderPopularGallery() {
                const container = document.getElementById('popularGallery');
                container.innerHTML = `<div class="col-span-full text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-indigo-400"></i></div>`;
                
                const likesSnapshot = await get(ref(db, 'likes'));
                const allLikes = likesSnapshot.val() || {};

                const combinedContent = [...allImages, ...allPosts];
                const popularContent = combinedContent
                    .map(item => ({ ...item, score: allLikes[item.id] ? Object.keys(allLikes[item.id]).length : 0 }))
                    .sort((a, b) => b.score - a.score);
                
                container.innerHTML = '';
                appendToImageGrid(container, popularContent.slice(0, 24));
            }
            
            function renderSimilarImages(currentImage) {
                const section = document.getElementById('similar-section');
                const container = document.getElementById('similar-images-grid');
                container.innerHTML = '';
                const currentTags = new Set(currentImage.tags || []);
                if (currentTags.size === 0) { section.classList.add('hidden'); return; }
                const similarImages = allImages
                    .filter(img => String(img.id) !== String(currentImage.id))
                    .map(img => ({ ...img, score: (img.tags || []).filter(tag => currentTags.has(tag)).length }))
                    .filter(img => img.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 6);
                if (similarImages.length > 0) {
                    section.classList.remove('hidden');
                    appendToImageGrid(container, similarImages);
                } else {
                    section.classList.add('hidden');
                }
            }

            function renderMostVotedSection() {
                const likesRef = ref(db, 'likes');
                onValue(likesRef, async (snapshot) => {
                    const allLikes = snapshot.val() || {};
                    const container = document.getElementById('leaderboard');
                    container.innerHTML = '';

                    if (!allPosts || allPosts.length === 0) {
                         container.innerHTML = `<p class="text-center text-gray-500 text-sm col-span-3">A√∫n no hay publicaciones para mostrar.</p>`;
                         return;
                    }

                    const rankedPosts = allPosts
                        .map(post => ({
                            ...post,
                            likeCount: allLikes[post.id] ? Object.keys(allLikes[post.id]).length : 0
                        }))
                        .sort((a, b) => b.likeCount - a.likeCount);

                    const uniquePosts = [];
                    const seenImageUrls = new Set();
                    for (const post of rankedPosts) {
                        if (!seenImageUrls.has(post.imageUrl)) {
                            uniquePosts.push(post);
                            seenImageUrls.add(post.imageUrl);
                        }
                    }

                    const topPosts = uniquePosts.slice(0, 3);

                    if (topPosts.length === 0 || topPosts[0].likeCount === 0) {
                        container.innerHTML = `<p class="text-center text-gray-500 text-sm col-span-3">A√∫n no hay publicaciones populares. ¬°Vota por tus favoritas!</p>`;
                        return;
                    }

                    for (let i = 0; i < topPosts.length; i++) {
                        const post = topPosts[i];
                        const rank = i + 1;
                        const authorInfo = await getAuthorData(post.authorUid);

                        const item = document.createElement('div');
                        item.className = `most-voted-item rank-${rank} cursor-pointer group`;
                        item.innerHTML = `
                            <img src="${post.imageUrl}" alt="${post.title}" class="post-image transition-transform duration-300 group-hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/300x500/1f2937/a7a7a7?text=Error';">
                            <div class="rank-badge">${rank}</div>
                            <div class="author-overlay">
                                <img src="${authorInfo.profile?.avatar || ''}" alt="${authorInfo.username}">
                                <span class="truncate">${authorInfo.username}</span>
                            </div>
                        `;
                        item.addEventListener('click', () => showDetailView(post.id, true));
                        container.appendChild(item);
                    }
                });
            }

            // --- L√ìGICA DE SEGUIMIENTO (FOLLOW) ---
            async function toggleFollow(userIdToFollow) {
                const followingRef = ref(db, `following/${currentUser.uid}/${userIdToFollow}`);
                const followerRef = ref(db, `followers/${userIdToFollow}/${currentUser.uid}`);
                const snapshot = await get(followingRef);

                if (snapshot.exists()) {
                    await remove(followingRef);
                    await remove(followerRef);
                } else {
                    await set(followingRef, true);
                    await set(followerRef, true);
                }
                updateFollowButton(userIdToFollow);
                updateFollowCounts(userIdToFollow);
            }

            async function updateFollowButton(userId) {
                const followBtn = document.getElementById('followBtn');
                if (!followBtn || followBtn.dataset.userId !== userId) return;

                const followingRef = ref(db, `following/${currentUser.uid}/${userId}`);
                const snapshot = await get(followingRef);
                if (snapshot.exists()) {
                    followBtn.textContent = 'Siguiendo';
                    followBtn.className = 'mt-4 px-6 py-2 text-sm font-bold rounded-full transition-colors bg-gray-700 text-white hover:bg-gray-600';
                } else {
                    followBtn.textContent = 'Seguir';
                    followBtn.className = 'mt-4 px-6 py-2 text-sm font-bold rounded-full transition-colors bg-indigo-600 text-white hover:bg-indigo-500';
                }
            }

            function updateFollowCounts(userId) {
                const followersRef = ref(db, `followers/${userId}`);
                const followingRef = ref(db, `following/${userId}`);

                onValue(followersRef, (snap) => {
                    const count = snap.exists() ? Object.keys(snap.val()).length : 0;
                    const el = document.getElementById('followerCount');
                    if(el) el.innerHTML = `<strong>${count}</strong> Seguidores`;
                });
                onValue(followingRef, (snap) => {
                    const count = snap.exists() ? Object.keys(snap.val()).length : 0;
                    const el = document.getElementById('followingCount');
                    if(el) el.innerHTML = `<strong>${count}</strong> Siguiendo`;
                });
            }


            // --- L√ìGICA DE ADVERTENCIAS Y LEGALES ---
            function setupLegalModalsListeners() {
                const links = [
                    { id: 'ageModalTermsLink', modal: 'termsModal' },
                    { id: 'registerTermsLink', modal: 'termsModal' },
                    { id: 'registerPrivacyLink', modal: 'privacyModal' },
                    { id: 'createPostTermsLink', modal: 'termsModal' },
                    { id: 'createPostPrivacyLink', modal: 'privacyModal' },
                ];
                links.forEach(link => {
                    document.getElementById(link.id).addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showModal(link.modal);
                    });
                });
            }

            function handleAgeVerification() {
                if (localStorage.getItem('ageVerified') === 'true') {
                    return true;
                }

                showModal('ageVerificationModal');

                document.getElementById('confirmAgeBtn').addEventListener('click', () => {
                    localStorage.setItem('ageVerified', 'true');
                    hideModal('ageVerificationModal');
                    onAuthStateChanged(auth, authStateObserver);
                });

                document.getElementById('exitBtn').addEventListener('click', () => {
                    document.body.innerHTML = `<div class="w-screen h-screen bg-gray-900 flex items-center justify-center text-white text-xl p-4 text-center">Debes ser mayor de edad para acceder a este sitio.</div>`;
                    document.body.className = 'bg-gray-900';
                });
                return false;
            }

            // --- L√ìGICA DE ADMINISTRACI√ìN ---
            function setupAdminToolListeners() {
                const form = document.getElementById('adminAddCuratedForm');
                if(!form) return;
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const url = document.getElementById('adminPostUrl').value.trim();
                    const title = document.getElementById('adminPostTitle').value.trim();
                    const description = document.getElementById('adminPostDescription').value.trim();
                    const tagsInput = document.getElementById('adminPostTags').value.trim();
                    
                    if (!url || !title) return showToast("URL y T√≠tulo son obligatorios.");

                    const id = BigInt(Date.now()) * BigInt(100000) + BigInt(Math.floor(Math.random() * 100000));

                    const newImageObject = {
                        id: id.toString(),
                        title: title,
                        description: description,
                        url: url,
                        tags: tagsInput.split(',').map(tag => tag.trim().toLowerCase()).filter(Boolean)
                    };

                    const jsonOutput = document.getElementById('generatedJsonOutput');
                    jsonOutput.value = JSON.stringify(newImageObject, null, 2);
                    document.getElementById('generatedJsonContainer').classList.remove('hidden');
                });

                document.getElementById('copyJsonBtn').addEventListener('click', () => {
                    const jsonOutput = document.getElementById('generatedJsonOutput');
                    jsonOutput.select();
                    document.execCommand('copy');
                    showToast('JSON copiado al portapapeles');
                });
            }

            function showConfirmationModal(title, message, onConfirm) {
                document.getElementById('confirmationTitle').textContent = title;
                document.getElementById('confirmationMessage').textContent = message;
                showModal('confirmationModal');

                const confirmBtn = document.getElementById('confirmActionBtn');
                const cancelBtn = document.getElementById('cancelActionBtn');

                const confirmHandler = () => { onConfirm(); hideModal('confirmationModal'); cleanup(); };
                const cancelHandler = () => { hideModal('confirmationModal'); cleanup(); };
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                };
                
                confirmBtn.addEventListener('click', confirmHandler);
                cancelBtn.addEventListener('click', cancelHandler);
            }

            async function handleDeletePost(postId) {
                showConfirmationModal('Eliminar Publicaci√≥n', '¬øSeguro que quieres eliminar esta publicaci√≥n y todos sus datos?', async () => {
                    try {
                        await remove(ref(db, `posts/${postId}`));
                        await remove(ref(db, `likes/${postId}`));
                        await remove(ref(db, `comments/${postId}`));
                        await remove(ref(db, `views/${postId}`));
                        
                        showToast('Publicaci√≥n eliminada con √©xito.');
                        const detailView = document.getElementById('detailView');
                        if (!detailView.classList.contains('hidden')) {
                            closeSlideUpView('detailView');
                        }
                    } catch (error) {
                        console.error("Error eliminando la publicaci√≥n:", error);
                        showToast('No se pudo eliminar la publicaci√≥n.');
                    }
                });
            }

            async function handleDeleteComment(commentPath) {
                showConfirmationModal('Eliminar Comentario', '¬øSeguro que quieres eliminar este comentario?', async () => {
                    try {
                        await remove(ref(db, commentPath));
                        showToast('Comentario eliminado.');
                    } catch (error) {
                        console.error("Error eliminando el comentario:", error);
                        showToast('No se pudo eliminar el comentario.');
                    }
                });
            }

            // --- INICIALIZACI√ìN DE LA APP ---
            async function initializeAppForUser(user) {
                showLoader('galleryLoader', true);
                
                isCurrentUserAdmin = user.email === ADMIN_EMAIL;
                const adminBtn = document.getElementById('adminAddCuratedBtn');
                if (adminBtn) adminBtn.classList.toggle('hidden', !isCurrentUserAdmin);

                const userData = await getAuthorData(user.uid);
                currentUserData = userData || { username: user.email.split('@')[0], profile: {} };
                const defaultAvatar = `https://api.dicebear.com/8.x/bottts-neutral/svg?seed=${encodeURIComponent(currentUserData.username || 'user')}`;
                currentUserData.profile.avatar = currentUserData.profile.avatar || defaultAvatar;
                updateAllAvatars(currentUserData.profile.avatar);

                try {
                    const usersRef = ref(db, 'users');
                    const q = query(usersRef, orderByChild('username'), equalTo(ADMIN_USERNAME));
                    const adminSnapshot = await get(q);

                    if (adminSnapshot.exists()) {
                        globalAdminUID = Object.keys(adminSnapshot.val())[0];
                    } else {
                        throw new Error("La cuenta del administrador ('Exen') no se encontr√≥ en la base de datos.");
                    }
                } catch (error) {
                    console.error("Error cr√≠tico al buscar al admin:", error);
                    showToast("Error: No se pudo cargar el contenido oficial.");
                }

                // Cargar datos iniciales y luego configurar listeners
                const initialPostsSnapshot = await get(query(ref(db, 'posts'), orderByChild('timestamp')));
                const posts = [];
                if (initialPostsSnapshot.exists()) {
                    initialPostsSnapshot.forEach(childSnapshot => {
                        posts.push({ ...childSnapshot.val(), id: childSnapshot.key, isPost: true });
                    });
                }
                allPosts = posts.reverse();

                await loadCuratedImages();
                setupPostsListener();
                setupUsersListener(); 
                
                sortCuratedFeed();
                renderCuratedFeed(true);
                listenToNotifications();
                renderMostVotedSection();

                appInitialized = true;
                showLoader('galleryLoader', false);
                triggerView('galleryView');
            }

            async function authStateObserver(user) {
                const authOverlay = document.getElementById('authOverlay');
                const appContent = document.getElementById('appContent');
                
                if (user) {
                    currentUser = user;
                    authOverlay.classList.add('opacity-0', 'pointer-events-none');
                    appContent.classList.remove('hidden');

                    if (!appInitialized) {
                        setupAppEventListeners();
                        await initializeAppForUser(user);
                    }
                } else {
                    currentUser = null;
                    currentUserData = {};
                    isCurrentUserAdmin = false;
                    globalAdminUID = null;
                    appInitialized = false;
                    
                    authOverlay.classList.remove('opacity-0', 'pointer-events-none');
                    appContent.classList.add('hidden');
                    document.querySelectorAll('.modal-container, .notifications-panel').forEach(m => {
                        m.classList.add('hidden');
                        m.classList.remove('active');
                    });
                }
            }
            
            // --- PUNTO DE ENTRADA PRINCIPAL ---
            setupAuthEventListeners();

            if (handleAgeVerification()) {
                onAuthStateChanged(auth, authStateObserver);
            }
        });
    </script>
</body>
</html>

