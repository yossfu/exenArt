<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>exen-E | Galería</title>
    <meta property="og:title" content="exen-E | Galería" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://yossfu.github.io/exenArt/index.html" />
    <meta property="og:image" content="https://files.catbox.moe/ta0lv8.png" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --accent: #f97316; 
            --accent-glow: rgba(251, 146, 60, 0.6);
            --title-font: 'Poppins', sans-serif;
            --body-font: 'Inter', sans-serif;
            --bg-dark: #09090b;
            --bg-card: #121214;
        }
        html { scroll-behavior: smooth; }
        body { 
            font-family: var(--body-font); 
            background-color: #0c0c0c;
            background-image: radial-gradient(circle at 25% 25%, rgba(249, 115, 22, 0.05) 0%, transparent 40%), 
                              radial-gradient(circle at 75% 75%, rgba(139, 92, 246, 0.05) 0%, transparent 40%);
            color: #f3f4f6;
            padding-bottom: 80px;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- PANTALLA DE CARGA INICIAL --- */
        #initial-loader {
            position: fixed; inset: 0; z-index: 10000;
            background-color: #0c0c0c;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .loader-logo { width: 80px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 10px var(--accent)); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        /* --- ESTILOS GENERALES --- */
        .image-card {
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            will-change: transform;
        }
        .image-card:hover { transform: scale(1.03); box-shadow: 0 0 25px -5px var(--accent-glow); }
        .touch-feedback { transition: transform 0.15s cubic-bezier(0.22, 1, 0.36, 1); }
        .touch-feedback:active { transform: scale(0.95); }

        /* NAV */
        .bottom-nav { background-color: rgba(10, 10, 10, 0.9); backdrop-filter: blur(12px); border-top: 1px solid rgba(55, 65, 81, 0.3); }
        .nav-item { color: #9ca3af; transition: color 0.25s ease, transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .nav-item.active { color: var(--accent); transform: translateY(-4px); }
        .nav-item.active span { font-weight: 700; }

        /* --- NOTIFICACIONES --- */
        .notif-btn { position: relative; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #ccc; transition: all 0.2s; }
        .notif-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .notif-badge { position: absolute; top: 0px; right: 0px; width: 10px; height: 10px; background-color: var(--accent); border-radius: 50%; border: 2px solid var(--bg-dark); box-shadow: 0 0 5px rgba(249, 115, 22, 0.8); }
        
        .notification-dropdown { position: fixed; top: 60px; right: 10px; left: 10px; max-width: 400px; margin: 0 auto; background: #1c1c1f; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; z-index: 5000; box-shadow: 0 10px 40px rgba(0,0,0,0.8); max-height: 0; overflow: hidden; opacity: 0; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); transform-origin: top right; transform: scale(0.95); }
        .notification-dropdown.visible { max-height: 400px; opacity: 1; transform: scale(1); }
        
        .notif-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; cursor: pointer; transition: background 0.2s; background: transparent; }
        .notif-item:active { background: rgba(255,255,255,0.1) !important; }
        .notif-item.unread { background: rgba(249, 115, 22, 0.08); border-left: 3px solid var(--accent); }
        .notif-item.read { opacity: 0.7; }

        /* --- MENÚ PERFIL DESPLEGABLE --- */
        .profile-menu-dropdown {
            position: absolute; top: 60px; left: 10px; width: 220px;
            background: #1c1c1f; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; z-index: 5000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            transform-origin: top left; transform: scale(0.9); opacity: 0; pointer-events: none;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .profile-menu-dropdown.visible { transform: scale(1); opacity: 1; pointer-events: auto; }
        .profile-menu-item { padding: 12px 16px; display: flex; align-items: center; gap: 12px; color: #e5e7eb; font-size: 0.9rem; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .profile-menu-item:last-child { border-bottom: none; }
        .profile-menu-item:active { background: rgba(255,255,255,0.1); }
        .profile-menu-item.logout { color: #ef4444; }

        /* --- VISOR MODAL --- */
        .modal-backdrop { 
            display: none; 
            position: fixed; inset: 0; 
            background-color: #000000; 
            z-index: 5000; 
        } 
        .modal-backdrop.visible { display: block; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Similar Slider Styles */
        .similar-card {
            min-width: 90px; width: 90px; aspect-ratio: 1/1;
            border-radius: 0.5rem; overflow: hidden; position: relative;
            flex-shrink: 0; scroll-snap-align: start;
            border: 1px solid rgba(255,255,255,0.1); transition: transform 0.2s;
            background-color: #1a1a1c;
        }
        .similar-card:active { transform: scale(0.95); border-color: var(--accent); }
        .similar-card img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Scrollbars */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .like-anim { animation: likeBounce 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes likeBounce { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%); z-index: 20;
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); border-radius: 50%;
            color: white; border: 1px solid rgba(255,255,255,0.15); cursor: pointer; transition: all 0.2s;
        }
        .nav-arrow:active { background: var(--accent); }
        .nav-prev { left: 15px; } .nav-next { right: 15px; }

        .fullscreen-mode .info-panel { display: none !important; }
        .fullscreen-mode .image-area { width: 100% !important; height: 100vh !important; flex: none !important; }

        /* --- FEEDBACK CARD CAMUFLADA --- */
        .feedback-card {
            background: linear-gradient(135deg, #222, #111);
            border: 1px solid rgba(249, 115, 22, 0.4);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 1.5rem;
            position: relative; overflow: hidden;
            aspect-ratio: 2/3; cursor: pointer;
        }
        .feedback-card::before {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(circle at center, rgba(249, 115, 22, 0.1) 0%, transparent 70%);
        }
        .feedback-pulse { animation: softPulse 3s infinite; }
        @keyframes softPulse { 0%, 100% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 10px rgba(249, 115, 22, 0.5); } }

        /* --- HERO OPTIMIZADO --- */
        .hero-wrapper {
            position: relative; width: 100%; height: 300px; border-radius: 1rem; overflow: hidden;
            margin-bottom: 2rem; box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.5); display: none; 
            background-color: #0a0a0a; border: 1px solid rgba(255,255,255,0.05);
        }
        @media (min-width: 640px) { .hero-wrapper { height: 360px; } }
        
        .hero-slide { position: absolute; inset: 0; opacity: 0; transition: opacity 0.8s ease-in-out; z-index: 1; overflow: hidden; will-change: opacity; }
        .hero-slide.active { opacity: 1; z-index: 10; }
        
        .hero-bg-img {
            width: 100%; height: 100%; object-fit: cover; transform: scale(1); filter: brightness(0.5) blur(2px);
            will-change: transform;
        }
        .hero-slide.active .hero-bg-img { animation: slowZoom 20s linear infinite alternate; }
        @keyframes slowZoom { 0% { transform: scale(1); } 100% { transform: scale(1.2); } }
        
        .hero-overlay {
            position: absolute; inset: 0; z-index: 20; display: flex; align-items: center; padding-left: 1.5rem;
            background: linear-gradient(90deg, rgba(12, 12, 12, 0.95) 0%, rgba(12, 12, 12, 0.6) 60%, transparent 100%);
        }
        .hero-floating-card {
            position: absolute; top: 15%; bottom: 15%; right: 5%; width: 35%; max-width: 180px; z-index: 25;
            border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.2);
            transform: rotate(-3deg); background: #1a1a1a;
        }
        .hero-floating-img { width: 100%; display: block; }
        .hero-indicators { position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.4rem; z-index: 40; }
        .hero-dot { width: 5px; height: 5px; border-radius: 50%; background-color: rgba(255,255,255,0.3); transition: all 0.3s; }
        .hero-dot.active { background-color: var(--accent); width: 16px; border-radius: 3px; }

        #config-modal { display: none; position: fixed; inset: 0; z-index: 6000; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .config-card { background: #1a1a1a; border: 1px solid #333; border-radius: 16px; padding: 1.5rem; width: 90%; max-width: 350px; }
        
        #scrollToTopBtn { opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.3s; }
        #scrollToTopBtn.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        .skeleton { background-color: #374151; background-image: linear-gradient(to right, #374151 0%, #4b5563 20%, #374151 40%, #374151 100%); background-repeat: no-repeat; background-size: 2000px 100%; animation: shimmer 1.5s linear infinite; border-radius: 1rem; aspect-ratio: 2 / 3; }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
    </style>
</head>
<body class="antialiased">

    <div id="initial-loader">
        <img src="https://files.catbox.moe/ap1lh0.png" class="loader-logo">
        <i class="fas fa-spinner fa-spin text-orange-500 text-2xl"></i>
    </div>

    <div id="app-content" style="display: block;">
        
        <main class="container mx-auto px-2 sm:px-4">
            
            <header class="pt-4 pb-2 flex justify-between items-center relative z-40">
                <div class="relative">
                    <div id="user-profile-btn" class="w-[45px] h-[45px] rounded-full overflow-hidden border-2 border-orange-500 cursor-pointer active:scale-95 transition shadow-[0_0_10px_rgba(249,115,22,0.3)]" onclick="toggleProfileMenu()">
                        <img id="header-user-img" src="https://placehold.co/100x100/333/fff?text=U" class="w-full h-full object-cover">
                    </div>
                    <div id="profile-menu" class="profile-menu-dropdown">
                        <div class="p-3 border-b border-white/5 bg-[#18181b] rounded-t-2xl">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Mi Cuenta</span>
                        </div>
                        <div class="profile-menu-item" onclick="if(requireLogin()) openConfigModal()">
                            <i class="fas fa-cog text-gray-400"></i> Configurar Perfil
                        </div>
                        <div class="profile-menu-item" onclick="window.location.href='profile.html'">
                            <i class="fas fa-user text-gray-400"></i> Ver Perfil
                        </div>
                        <div class="profile-menu-item logout" onclick="logoutUser()">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-3 bg-gray-900/80 border border-gray-700/50 px-5 py-1.5 rounded-full shadow-lg backdrop-blur-md">
                    <img src="https://files.catbox.moe/ap1lh0.png" alt="exen-E Logo" class="h-9 w-auto drop-shadow-[0_0_3px_rgba(249,115,22,0.8)]">
                    <div class="h-4 w-[1px] bg-gray-700"></div>
                    <span class="text-xs font-bold tracking-widest text-gray-400" style="font-family: var(--title-font);">GALLERY</span>
                </div>
                
                <div class="relative">
                    <button onclick="toggleNotifications()" class="notif-btn">
                        <i class="far fa-bell text-lg"></i>
                        <div id="notif-badge" class="notif-badge hidden"></div>
                    </button>
                    <div id="notification-dropdown" class="notification-dropdown custom-scrollbar">
                        <div class="p-3 border-b border-white/5 flex justify-between items-center bg-[#18181b]">
                            <span class="text-sm font-bold text-white">Notificaciones</span>
                            <span class="text-[10px] text-gray-500">Recientes</span>
                        </div>
                        <div id="notif-list" class="flex flex-col max-h-[300px] overflow-y-auto">
                            <div class="p-8 text-center text-gray-500 text-xs italic"><i class="fas fa-spinner fa-spin mr-2"></i> Cargando...</div>
                        </div>
                    </div>
                </div>
            </header>

            <div id="hero-wrapper" class="hero-wrapper">
                <div id="hero-slides-container" class="w-full h-full relative"></div>
                <div id="hero-indicators" class="hero-indicators"></div>
                <div class="hero-bottom-gradient"></div>
                <form id="search-form" class="absolute bottom-0 left-0 w-full flex justify-center pb-4 z-50 px-4">
                    <div class="relative w-full max-w-xl">
                        <input type="text" id="search-input" placeholder="Buscar usuarios o arte..." class="w-full rounded-full border-2 border-white/20 bg-black/50 backdrop-blur-md py-3 pl-5 pr-24 text-white transition placeholder:text-gray-300 focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500/50 text-sm">
                        <button type="button" id="clear-search-btn" class="absolute inset-y-0 right-12 hidden items-center justify-center w-10 text-gray-400 hover:text-white transition"><i class="fas fa-times"></i></button>
                        <button type="submit" class="absolute inset-y-0 right-0 flex items-center justify-center w-12 text-orange-500 hover:text-orange-400"><i class="fas fa-search text-xl"></i></button>
                    </div>
                </form>
            </div>

            <div id="search-results-container" class="hidden">
                <div id="search-results-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 md:gap-4"></div>
                <div id="search-pagination" class="mt-8 flex items-center justify-center gap-4"></div>
            </div>

            <div id="main-content-sections">
                
                <section id="for-you-section" class="mb-10">
                    <h3 class="font-[Poppins] text-lg font-bold text-white mb-4 tracking-wide border-l-4 border-orange-500 pl-3">PARA TI</h3>
                    <div id="for-you-grid" class="grid grid-cols-3 gap-3 md:gap-4"></div>
                </section>
                
                <section id="community-section" class="mb-12">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-[Poppins] text-lg font-bold text-white tracking-wide border-l-4 border-orange-500 pl-3">COMUNIDAD (Top)</h3>
                        <a href="feed.html" class="text-xs text-orange-500 hover:text-orange-300 font-semibold transition bg-orange-500/10 px-3 py-1 rounded-full">Ver todo <i class="fas fa-arrow-right ml-1"></i></a>
                    </div>
                    
                    <div id="community-grid" class="flex gap-4 overflow-x-auto pb-4 scrollbar-hide snap-x snap-mandatory"></div>
                </section>

                <div class="pt-2">
                    <h3 class="font-[Poppins] text-lg font-bold text-white mb-6 tracking-wide border-l-4 border-orange-500 pl-3">GALERÍA</h3>
                </div>
            </div>

            <section id="gallery">
                <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 md:gap-4"></div>
                
                <div id="gallery-register-gate" class="mt-10" style="display:none;">
                    <div class="max-w-md mx-auto bg-[#1a1a1c] border border-orange-500/30 rounded-2xl p-6 shadow-2xl relative overflow-hidden text-center">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-600 to-orange-400"></div>
                        <i class="fas fa-lock text-4xl text-orange-500 mb-3"></i>
                        <h3 class="text-xl font-bold text-white mb-2">¡Descubre más!</h3>
                        <p class="text-gray-400 text-sm mb-4">Regístrate gratis para ver la galería completa.</p>
                        <button onclick="window.location.href='login.html'" class="w-full py-3 rounded-full bg-gradient-to-r from-orange-600 to-orange-500 text-white font-bold shadow-lg hover:scale-105 transition transform">Crear Cuenta</button>
                    </div>
                </div>

                <div id="loader" class="py-12 grid grid-cols-2 sm:grid-cols-3 gap-3 md:gap-4" style="display: none;"></div>
                <div id="load-more-trigger" class="h-10"></div>
            </section>
            
        </main>
        
        <div id="modal" class="modal-backdrop" onclick="if(event.target === this) closeModal()">
            <button id="close-modal" onclick="closeModal()" class="fixed top-4 right-4 z-[5010] h-10 w-10 flex items-center justify-center rounded-full bg-black/60 text-white backdrop-blur-sm border border-white/10 active:scale-90 transition shadow-lg"><i class="fas fa-times text-lg"></i></button>

            <div id="modal-inner-container" class="w-full h-full flex flex-col lg:flex-row bg-black transition-all duration-300">
                
                <div id="modal-image-area" class="image-area relative flex-1 bg-black flex items-center justify-center overflow-hidden h-[55vh] lg:h-full">
                    <img id="modal-image" src="" class="max-w-full max-h-full object-contain w-auto h-auto transition-transform duration-300">
                    <button onclick="toggleFullScreen()" class="absolute bottom-4 right-4 z-20 bg-zinc-800/80 text-white p-2.5 rounded-xl backdrop-blur-md border border-white/10 active:scale-90 transition shadow-lg"><i class="fas fa-expand text-sm"></i></button>
                    <button id="prev-image" class="nav-arrow nav-prev"><i class="fas fa-chevron-left"></i></button>
                    <button id="next-image" class="nav-arrow nav-next"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div class="info-panel w-full lg:w-[400px] lg:h-full bg-[#121214] border-l border-zinc-800 flex flex-col h-[45vh] z-30 relative shadow-[-10px_0_30px_rgba(0,0,0,0.5)]">
                    
                    <div class="p-4 border-b border-zinc-800 flex items-center justify-between bg-[#18181b] flex-shrink-0">
                        <div class="flex items-center gap-3">
                            <img id="modal-user-avatar" src="https://placehold.co/100x100" class="w-10 h-10 rounded-full object-cover border border-zinc-600 bg-zinc-700">
                            <div class="leading-tight">
                                <h4 id="modal-image-title" class="font-bold text-white text-sm line-clamp-1">Título</h4>
                                <span id="modal-user-name" class="text-[10px] text-gray-500 cursor-pointer hover:text-orange-400 transition">Autor</span>
                            </div>
                        </div>
                        <button id="modal-like-btn" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-zinc-800 border border-zinc-700 hover:bg-zinc-700 transition group active:scale-95">
                            <i class="far fa-heart text-lg group-active:scale-125 transition-transform text-gray-400"></i>
                            <span id="modal-like-count" class="text-xs font-bold text-white">0</span>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-5 custom-scrollbar bg-[#121214]">
                        <div class="mb-5">
                            <h3 id="modal-title-display" class="hidden"></h3> <div id="modal-character-tag" class="hidden inline-flex items-center gap-1.5 bg-orange-500/10 border border-orange-500/20 text-orange-400 px-2.5 py-1 rounded-md text-[11px] font-bold uppercase tracking-wider mb-2">
                                <i class="fas fa-user-tag text-[10px]"></i> <span id="modal-character-name"></span>
                            </div>
                            <p id="modal-desc" class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap font-light"></p>
                        </div>

                        <div class="mb-6 border-b border-zinc-800 pb-4">
                            <button onclick="toggleTags()" id="tags-toggle-btn" class="text-[11px] font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2 hover:text-orange-500 transition-colors mb-2">
                                <span>Ver etiquetas</span> <i class="fas fa-chevron-down"></i>
                            </button>
                            <div id="modal-tags" class="hidden flex flex-wrap gap-2 mt-3"></div>
                        </div>
                        
                        <div class="mb-6 border-b border-zinc-800 pb-4">
                            <h4 class="text-[11px] font-bold text-gray-500 uppercase mb-3 tracking-widest flex items-center gap-2"><i class="fas fa-th-large"></i> Similares</h4>
                            <div id="similar-grid" class="flex gap-3 overflow-x-auto pb-3 snap-x no-scrollbar"></div>
                        </div>

                        <div>
                            <h4 class="text-[11px] font-bold text-gray-500 uppercase mb-4 tracking-widest flex items-center gap-2"><i class="fas fa-comments"></i> Comentarios</h4>
                            <div id="comments" class="flex flex-col gap-3 pb-4"></div>
                        </div>
                    </div>

                    <div class="p-3 bg-[#18181b] border-t border-zinc-800 flex-shrink-0 safe-bottom">
                        <form id="comment-form" class="flex gap-2 relative">
                            <input type="text" id="comment-input" class="w-full bg-zinc-900 border border-zinc-700 rounded-full px-4 py-3 text-sm text-white focus:border-orange-500 focus:outline-none pr-12 transition-colors" placeholder="Escribe un comentario..." autocomplete="off">
                            <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-orange-500 hover:text-orange-400 p-2 transition transform active:scale-90"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="config-modal">
            <div class="config-card p-6 flex flex-col gap-4">
                <h3 class="text-xl font-bold text-white mb-2 border-b border-gray-700 pb-2">Editar Foto</h3>
                <div class="flex flex-col items-center gap-4">
                    <div class="relative w-24 h-24 group cursor-pointer">
                        <img id="config-preview-img" src="https://placehold.co/100x100/333/fff?text=Foto" class="w-full h-full rounded-full object-cover border-2 border-gray-600 group-hover:border-orange-500 transition">
                        <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i class="fas fa-camera text-white text-xl"></i></div>
                        <input type="file" id="config-file-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleConfigImageSelect(event)">
                    </div>
                    <p id="config-upload-status" class="text-xs text-gray-400">Toca para cambiar imagen</p>
                </div>
                <div class="flex gap-2 mt-4"><button id="btn-save-config" onclick="saveNewProfilePic()" class="w-full bg-orange-600 hover:bg-orange-500 text-white rounded py-2 font-bold transition">Guardar</button><button onclick="closeConfigModal()" class="w-full bg-gray-700 hover:bg-gray-600 text-white rounded py-2 transition">Cancelar</button></div>
            </div>
        </div>
        
        <button id="scrollToTopBtn" class="fixed bottom-[90px] right-5 h-12 w-12 rounded-full bg-orange-600/80 text-white shadow-lg backdrop-blur-sm z-[100]" title="Ir arriba"><i class="fas fa-arrow-up"></i></button>
        <footer class="mt-12 py-8 text-center text-gray-500"><p class="mt-2 text-sm">&copy; 2025 exen-E. Todos los derechos reservados.</p></footer>

        <nav class="bottom-nav fixed bottom-0 left-0 right-0 z-[100] flex h-20 justify-around items-center px-2">
            <a href="index.html" class="nav-item active flex flex-col items-center justify-center text-center px-2 w-1/3 touch-feedback"><i class="fas fa-th-large text-xl mb-1"></i><span class="text-[10px] font-semibold">Galería</span></a>
            <a href="feed.html" onclick="return requireLogin(event)" class="nav-item flex flex-col items-center justify-center text-center px-2 w-1/3 touch-feedback"><i class="fas fa-globe-americas text-xl mb-1"></i><span class="text-[10px] font-semibold">Social</span></a>
            <a href="profile.html" onclick="return requireLogin(event)" class="nav-item flex flex-col items-center justify-center text-center px-2 w-1/3 touch-feedback"><i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-semibold">Perfil</span></a>
        </nav>
    </div>

    <script>
        "use strict";
        const firebaseConfig = { apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8", authDomain: "exene-53e6b.firebaseapp.com", databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com", projectId: "exene-53e6b", storageBucket: "exene-53e6b.appspot.com", messagingSenderId: "481369419867", appId: "1:481369419867:web:ac5db24c436344262c8f7e" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const CATBOX_USERHASH = "341adb9d3c2d09d0485aa908c";

        let currentUser = null; 
        let deviceID = localStorage.getItem('deviceID'); 
        if (!deviceID) { deviceID = Math.random().toString(36).substring(2) + Date.now().toString(36); localStorage.setItem('deviceID', deviceID); }
        
        let userDataCache = {};
        
        const imagesPerLoad = 21; 
        let allImages = []; 
        let fullGalleryCache = []; 
        let usersCache = []; 
        let feedCache = [];  
        let unifiedGalleryData = []; 
        let isLoading = false; 
        let noMoreImages = false; 
        let scrollLoadCount = 0;
        const MAX_GUEST_LOADS = 1;

        let currentImageId = ''; 
        let currentContext = 'gallery';
        let currentPlaylist = []; 
        let currentIndex = -1;
        
        let userReactions = {}; 
        let allReactionCounts = {}; 
        let currentSearchResults = []; 
        let searchCurrentPage = 1; 
        const searchResultsPerPage = 21; 
        let touchStartX = 0, touchEndX = 0, touchStartY = 0, touchEndY = 0; 
        const swipeThreshold = 50;
        let adminUserId = null;

        window.forYouList = [];
        window.communityList = [];

        auth.onAuthStateChanged(user => {
            const loader = document.getElementById('initial-loader');
            const appContent = document.getElementById('app-content');

            if (user && !user.isAnonymous) {
                currentUser = user;
                appContent.style.display = 'block';
                loadUserProfile(user.uid);
                document.getElementById('gallery-register-gate').style.display = 'none';
                initNotificationSystem(user.uid); // INICIAR NOTIFICACIONES
            } else {
                currentUser = null;
                appContent.style.display = 'block';
            }

            if (loader) { loader.style.opacity = '0'; setTimeout(() => { loader.style.display = 'none'; }, 500); }
            if(feedCache.length > 0) renderCommunitySection();
            if(user) fetchUserReactions().then(() => loadForYouImages());
        });

        async function initializeApp() {
            await cacheAllDataForSearch(); 
            await Promise.all([ fetchUserReactions(), cacheAllReactionCounts() ]);
            loadHeroBanner(); 
            loadInitialImages();
            loadForYouImages(); 
            renderCommunitySection(); 
            setupEventListeners();
        }
        document.addEventListener('DOMContentLoaded', initializeApp);

        async function cacheAllDataForSearch() { 
            const snapshot = await db.ref('images').once('value'); 
            if (snapshot.exists()) { 
                const allData = []; 
                snapshot.forEach(child => { allData.push({ id: child.key, type: 'gallery', ...child.val() }); }); 
                fullGalleryCache = allData; 
            } 
            
            const userSnap = await db.ref('users').once('value');
            const userMap = {}; 
            
            if (userSnap.exists()) {
                const uData = [];
                userSnap.forEach(child => { 
                    const userData = child.val();
                    const uid = child.key;
                    uData.push({ id: uid, type: 'user', ...userData }); 
                    userMap[uid] = userData; 
                    if (userData.email === 'ezequiel@exen.com') adminUserId = uid;
                });
                usersCache = uData;
            }

            const feedSnap = await db.ref('feed_posts').once('value');
            if (feedSnap.exists()) {
                const fData = [];
                feedSnap.forEach(child => { 
                    const post = child.val();
                    if (post.imageUrl) { 
                        const author = userMap[post.userId];
                        const currentAvatar = author ? author.profilePic : (post.userAvatar || 'https://placehold.co/100x100/333/fff?text=U');
                        const currentName = author ? author.username : (post.userName || 'Usuario');
                        
                        fData.push({ 
                            id: child.key, 
                            type: 'feed', 
                            url: post.imageUrl, 
                            thumbnailUrl: post.imageUrl,
                            title: post.title || 'Sin título', 
                            desc: post.text, 
                            tags: post.tags ? post.tags.split(',').map(t=>t.trim()) : [],
                            category: post.category, 
                            characterName: post.characterName || '',
                            user: { name: currentName, avatar: currentAvatar, id: post.userId },
                            userId: post.userId, 
                            timestamp: post.timestamp, 
                            likes: post.likes || 0 
                        }); 
                    }
                });
                feedCache = fData;
            }
            unifiedGalleryData = [...fullGalleryCache, ...feedCache].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            // Actualizar caches
            fullGalleryCache = unifiedGalleryData; 
        }
        
        async function fetchUserReactions() { 
            const userId = currentUser && !currentUser.isAnonymous ? currentUser.uid : deviceID;
            const [reactionsSnap, feedLikesSnap] = await Promise.all([
                 db.ref('reactions').once('value'),
                 db.ref('feed_likes').once('value')
            ]);

            const allReactions = reactionsSnap.val() || {}; 
            const allFeedLikes = feedLikesSnap.val() || {};
            userReactions = {}; 
            Object.keys(allReactions).forEach(imgId => { if(allReactions[imgId][userId]) userReactions[imgId] = 'like'; });
            Object.keys(allFeedLikes).forEach(postId => { if(allFeedLikes[postId][userId]) userReactions[postId] = 'like'; });
        }

        async function cacheAllReactionCounts() { 
            const reactionsSnap = await db.ref('reactions').once('value'); 
            const reactions = reactionsSnap.val() || {}; 
            const counts = {}; 
            Object.entries(reactions).forEach(([imgId, users]) => { counts[imgId] = Object.keys(users).length; }); 
            allReactionCounts = counts; 
        }

        function renderCommunitySection() {
            const container = document.getElementById('community-grid');
            container.innerHTML = '';
            
            // Mostrar los más populares del FEED
            let sortedFeed = [...feedCache].sort((a, b) => (b.likes || 0) - (a.likes || 0));
            let filteredFeed = sortedFeed.slice(0, 20); // Top 20

            window.communityList = filteredFeed;

            filteredFeed.forEach(post => {
                const card = document.createElement('div');
                card.className = "relative min-w-[140px] w-[140px] h-[190px] rounded-xl overflow-hidden flex-shrink-0 snap-start cursor-pointer group border border-gray-800 hover:border-orange-500/50 transition-all";
                card.onclick = (e) => { e.stopPropagation(); if(requireLogin(e)) openModal(post.id, 'community'); };
                const likeBadge = post.likes > 0 ? `<div class="absolute top-2 right-2 bg-black/60 backdrop-blur-md px-2 py-0.5 rounded-full flex items-center gap-1 text-[10px] text-white"><i class="fas fa-heart text-xs text-red-500"></i> ${post.likes}</div>` : '';

                card.innerHTML = `<img src="${post.thumbnailUrl}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" loading="lazy"><div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-80"></div>${likeBadge}<div class="absolute bottom-2 left-2 right-2"><div class="flex items-center gap-1.5"><img src="${post.user.avatar || 'https://placehold.co/50'}" class="w-6 h-6 rounded-full border border-orange-500 object-cover"><div class="overflow-hidden"><p class="text-white text-[10px] font-bold truncate">${post.user.name}</p></div></div></div>`;
                container.appendChild(card);
            });
        }

        async function loadForYouImages() {
            const grid = document.getElementById('for-you-grid');
            generateSkeletons(grid, 6);
            
            // Algoritmo basado en Tags
            let tagScores = {};
            unifiedGalleryData.forEach(img => {
                if (userReactions[img.id] === 'like') {
                    if (img.tags && Array.isArray(img.tags)) {
                        img.tags.forEach(tag => { const normTag = normalize(tag); tagScores[normTag] = (tagScores[normTag] || 0) + 1; });
                    }
                }
            });

            let scoredImages = unifiedGalleryData
                .filter(img => userReactions[img.id] !== 'like') 
                .map(img => {
                    let score = 0;
                    if (img.tags && Array.isArray(img.tags)) { img.tags.forEach(tag => { const normTag = normalize(tag); if (tagScores[normTag]) score += tagScores[normTag]; }); }
                    score += Math.random() * 2; // Factor aleatorio
                    return { img, score };
                });

            scoredImages.sort((a, b) => b.score - a.score);
            const finalSelection = scoredImages.slice(0, 6).map(item => item.img);
            
            window.forYouList = finalSelection;
            displaySearchResults(finalSelection, 'for-you-grid', false, 'foryou');
        }

        function loadInitialImages() { 
            if (isLoading) return; isLoading = true; 
            const grid = document.getElementById('grid'); generateSkeletons(grid, imagesPerLoad); 
            allImages = unifiedGalleryData.slice(0, imagesPerLoad); 
            if (allImages.length > 0) displaySearchResults(allImages, 'grid', false, 'main'); else grid.innerHTML = ''; 
            isLoading = false; 
        }

        function loadMoreImages() { 
            if (isLoading || noMoreImages) return; 
            if (!currentUser && scrollLoadCount >= MAX_GUEST_LOADS) { document.getElementById('loader').style.display = 'none'; document.getElementById('gallery-register-gate').style.display = 'block'; noMoreImages = true; return; }
            isLoading = true; 
            const loaderContainer = document.getElementById('loader'); loaderContainer.style.display = 'grid'; generateSkeletons(loaderContainer, 3); 
            const currentLoadedCount = allImages.length; 
            const newImages = unifiedGalleryData.slice(currentLoadedCount, currentLoadedCount + imagesPerLoad); 
            if (newImages.length === 0) { noMoreImages = true; } 
            else { allImages = allImages.concat(newImages); displaySearchResults(newImages, 'grid', true, 'main'); scrollLoadCount++; } 
            loaderContainer.style.display = 'none'; isLoading = false; 
        }

        function loadHeroBanner() {
            // El banner muestra imágenes ALEATORIAS de USUARIOS (no solo admin)
            const userImages = unifiedGalleryData.filter(img => img.type === 'feed');
            if (userImages.length === 0) return;
            
            // Mezclar
            let shuffled = [...userImages].sort(() => 0.5 - Math.random());
            const heroImages = shuffled.slice(0, 5);

            const container = document.getElementById('hero-slides-container');
            const indicatorsContainer = document.getElementById('hero-indicators');
            const heroWrapper = document.getElementById('hero-wrapper');
            heroWrapper.style.display = 'block'; container.innerHTML = ''; indicatorsContainer.innerHTML = '';
            
            heroImages.forEach((img, index) => {
                const slide = document.createElement('div');
                slide.className = `hero-slide ${index === 0 ? 'active' : ''}`;
                slide.setAttribute('onclick', `if(requireLogin(event)) openModal('${img.id}', 'main')`);
                const displayUrl = img.thumbnailUrl || img.url; 
                slide.innerHTML = `<img src="${displayUrl}" class="hero-bg-img"><div class="hero-overlay"><div class="hero-content"><span class="text-orange-500 font-bold tracking-wider uppercase mb-1 text-[10px] sm:text-xs block">COMUNIDAD</span><h2 class="text-2xl sm:text-3xl font-extrabold text-white leading-tight mb-2 uppercase drop-shadow-lg truncate max-w-xs">${img.title}</h2><p class="text-gray-300 text-xs sm:text-sm line-clamp-1 mb-4 drop-shadow-md">Por: ${img.user.name}</p><div class="flex gap-3"><button class="px-4 py-1.5 bg-white text-black rounded-full font-bold hover:bg-gray-200 transition-all text-xs">Ver Arte</button></div></div></div><div class="hero-floating-card"><img src="${displayUrl}" class="hero-floating-img"></div>`;
                container.appendChild(slide);
                const dot = document.createElement('div'); dot.className = `hero-dot ${index === 0 ? 'active' : ''}`;
                dot.addEventListener('click', (e) => { e.stopPropagation(); manualSlide(index); });
                indicatorsContainer.appendChild(dot);
            });
            startHeroInterval();
        }
        let heroInterval;
        function startHeroInterval() { if (heroInterval) clearInterval(heroInterval); heroInterval = setInterval(() => { const slides = document.querySelectorAll('.hero-slide'); if(slides.length === 0) return; let current = 0; slides.forEach((s, i) => { if(s.classList.contains('active')) current = i; }); const next = (current + 1) % slides.length; manualSlide(next); }, 6000); }
        function manualSlide(index) { const slides = document.querySelectorAll('.hero-slide'); const dots = document.querySelectorAll('.hero-dot'); if (!slides.length) return; slides.forEach(s => s.classList.remove('active')); dots.forEach(d => d.classList.remove('active')); slides[index].classList.add('active'); dots[index].classList.add('active'); }

        function displaySearchResults(items, containerId, append = false, sourceContext = 'search') { 
            const grid = document.getElementById(containerId); 
            if (!append) grid.innerHTML = ''; 
            if (items.length === 0 && !append) { grid.innerHTML = `<div class="col-span-full w-full text-center py-8 text-gray-400">No hay contenido disponible.</div>`; return; } 
            
            items.forEach((item, index) => { 
                if (!item) return;

                // --- INYECCIÓN DE TARJETA DE FEEDBACK (Solo en galería principal y en la 5ta posición aprox) ---
                if (sourceContext === 'main' && !append && index === 4) {
                    const feedbackCard = document.createElement('div');
                    feedbackCard.className = "image-card feedback-card group";
                    feedbackCard.onclick = () => window.location.href = 'fadeback.html';
                    feedbackCard.innerHTML = `<div class="w-12 h-12 rounded-full bg-orange-500/20 flex items-center justify-center mb-2 group-hover:scale-110 transition"><i class="fas fa-lightbulb text-orange-500 text-xl"></i></div><h4 class="text-white font-bold text-sm mb-1 feedback-pulse">Feedback</h4><p class="text-gray-400 text-[10px] leading-tight px-2">Ayúdanos a mejorar exen-E con tus ideas.</p>`;
                    grid.appendChild(feedbackCard);
                }

                if (item.type === 'user') { /* Render usuario (búsqueda) */ return; }
                if (!item.url) return;
                
                const div = document.createElement('div'); 
                div.className = 'image-card group relative aspect-[2/3] overflow-hidden cursor-pointer bg-[#1a1a1c]'; 
                div.setAttribute('onclick', `if(requireLogin(event)) openModal('${item.id}', '${sourceContext}')`); 
                
                // Conteo Likes Correcto
                let reactionCount = 0;
                if (item.type === 'feed') reactionCount = item.likes || 0;
                else reactionCount = allReactionCounts[item.id] || 0;

                const isLiked = userReactions[item.id] === 'like';
                const isVerified = (item.type === 'gallery');

                div.innerHTML = `
                    <img src="${item.thumbnailUrl || item.url}" loading="lazy" class="h-full w-full object-cover transition duration-300 group-hover:scale-105">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-60"></div>
                    ${isVerified ? '<div class="absolute top-2 left-2 z-10 bg-orange-500/90 text-white text-[10px] px-1.5 py-0.5 rounded shadow-md font-bold">OFICIAL</div>' : ''}
                    <div class="absolute bottom-0 left-0 p-3 w-full">
                         <h4 class="truncate font-bold text-white text-xs mb-0.5">${item.title}</h4>
                         ${!isVerified ? `<p class="text-[10px] text-gray-400 truncate">${item.user.name}</p>` : ''}
                    </div>
                    <div class="absolute top-2 right-2 flex items-center gap-1 bg-black/50 px-1.5 py-0.5 rounded-full backdrop-blur-sm">
                        <i class="fas fa-heart text-[10px] ${isLiked ? 'text-red-500' : 'text-white'}"></i>
                        <span class="text-[10px] text-white font-bold">${reactionCount}</span>
                    </div>
                `; 
                grid.appendChild(div); 
            }); 
        }

        // --- SISTEMA DE MENÚ Y NOTIFICACIONES (Igual a Feed) ---
        function toggleProfileMenu() {
            const menu = document.getElementById('profile-menu');
            const notifDropdown = document.getElementById('notification-dropdown');
            notifDropdown.classList.remove('visible'); // Cerrar notificaciones si están abiertas
            menu.classList.toggle('visible');
        }
        
        // Cerrar menús al hacer clic fuera
        window.addEventListener('click', (e) => {
            if (!e.target.closest('#user-profile-btn') && !e.target.closest('#profile-menu')) {
                document.getElementById('profile-menu').classList.remove('visible');
            }
            if (!e.target.closest('.notif-btn') && !e.target.closest('#notification-dropdown')) {
                document.getElementById('notification-dropdown').classList.remove('visible');
            }
        });

        function initNotificationSystem(uid) {
            const badge = document.getElementById('notif-badge');
            db.ref('notifications/' + uid).orderByKey().limitToLast(1).on('child_added', snap => {
                if(!snap.exists()) return;
                const lastNotif = snap.val();
                const lastSeenTimestamp = localStorage.getItem('lastSeenNotif_' + uid) || 0;
                if (lastNotif.timestamp > lastSeenTimestamp) badge.classList.remove('hidden');
                else badge.classList.add('hidden');
            });
        }

        function toggleNotifications() {
            const dd = document.getElementById('notification-dropdown');
            const menu = document.getElementById('profile-menu');
            menu.classList.remove('visible'); // Cerrar menú de perfil
            
            if (dd.classList.contains('visible')) {
                dd.classList.remove('visible');
            } else {
                dd.classList.add('visible');
                document.getElementById('notif-badge').classList.add('hidden');
                if(currentUser) localStorage.setItem('lastSeenNotif_' + currentUser.uid, Date.now());
                loadNotifications();
            }
        }

        function loadNotifications() {
            const list = document.getElementById('notif-list');
            db.ref(`notifications/${currentUser.uid}`).orderByChild('timestamp').limitToLast(20).once('value', snap => {
                list.innerHTML = '';
                if (!snap.exists()) {
                    list.innerHTML = '<div class="p-6 text-center text-gray-500 text-xs">No tienes notificaciones.</div>';
                    return;
                }
                const notifs = [];
                snap.forEach(c => notifs.push({key: c.key, ...c.val()}));
                notifs.reverse().forEach(n => {
                    const item = document.createElement('div');
                    const isUnread = !n.read; 
                    item.className = `notif-item ${isUnread ? 'unread' : 'read'}`;
                    let icon = 'fas fa-bell'; let text = 'Nueva interacción';
                    if (n.type === 'like') { icon = 'fas fa-heart text-red-500'; text = `A <b>${n.fromUserName}</b> le gusta tu arte.`; }
                    else if (n.type === 'comment') { icon = 'fas fa-comment text-blue-400'; text = `<b>${n.fromUserName}</b> comentó tu arte.`; }
                    else if (n.type === 'follow') { icon = 'fas fa-user-plus text-green-400'; text = `<b>${n.fromUserName}</b> te sigue.`; }

                    item.innerHTML = `<div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center border border-zinc-700 flex-shrink-0"><i class="${icon}"></i></div><div class="flex-1 text-sm text-gray-300 leading-tight">${text} <br><span class="text-[10px] text-gray-500">${timeAgo(n.timestamp)}</span></div>`;
                    item.onclick = () => { markAsRead(n.key, item); if(n.postId) openModal(n.postId, 'main'); };
                    list.appendChild(item);
                });
            });
        }
        function markAsRead(key, element) { db.ref(`notifications/${currentUser.uid}/${key}/read`).set(true); element.classList.remove('unread'); element.classList.add('read'); }

        // --- VISOR MODAL ---
        async function openModal(id, context) {
            if(!requireLogin()) return;
            if(context === 'main') currentPlaylist = unifiedGalleryData; 
            else if(context === 'foryou') currentPlaylist = window.forYouList;
            else if(context === 'community') currentPlaylist = window.communityList;
            else currentPlaylist = unifiedGalleryData; 
            
            currentIndex = currentPlaylist.findIndex(i => i.id === id);
            if(currentIndex === -1) { currentPlaylist = unifiedGalleryData; currentIndex = currentPlaylist.findIndex(i => i.id === id); }
            if(currentIndex === -1) return; 

            let img = currentPlaylist[currentIndex];
            currentImageId = id; currentContext = img.type;
            updateModalContent(img);
            document.getElementById('modal').classList.add('visible'); document.getElementById('modal').classList.remove('fullscreen-mode'); document.body.style.overflow = 'hidden';
        }

        function updateModalContent(img) {
            document.getElementById('modal-image-title').textContent = img.title;
            document.getElementById('modal-desc').textContent = img.desc || 'Sin descripción.';
            const avatarEl = document.getElementById('modal-user-avatar');
            const nameEl = document.getElementById('modal-user-name');
            const modalImg = document.getElementById('modal-image');
            
            modalImg.src = img.thumbnailUrl || img.url;
            if (img.thumbnailUrl && img.thumbnailUrl !== img.url) {
                const highRes = new Image();
                highRes.src = img.url;
                highRes.onload = () => { if (currentImageId === img.id) modalImg.src = img.url; };
            }

            if (img.type === 'gallery') {
                nameEl.textContent = "Galería Oficial"; avatarEl.src = "https://files.catbox.moe/ap1lh0.png";
                nameEl.onclick = null; avatarEl.onclick = null;
            } else {
                nameEl.textContent = img.user.name; avatarEl.src = img.user.avatar;
                const goToProfile = () => window.location.href = `profile.html?uid=${img.userId}`;
                nameEl.onclick = goToProfile; avatarEl.onclick = goToProfile;
            }

            const charTag = document.getElementById('modal-character-tag');
            if (img.characterName) {
                charTag.classList.remove('hidden'); document.getElementById('modal-character-name').textContent = img.characterName;
            } else { charTag.classList.add('hidden'); }

            const tagsDiv = document.getElementById('modal-tags'); const tagsBtn = document.getElementById('tags-toggle-btn');
            tagsDiv.classList.add('hidden'); tagsBtn.innerHTML = '<span>Ver etiquetas</span> <i class="fas fa-chevron-down"></i>'; tagsDiv.innerHTML = '';
            
            if (img.tags && img.tags.length > 0) {
                tagsBtn.style.display = 'flex';
                img.tags.forEach(t => { if(t.trim()) tagsDiv.innerHTML += `<span class="text-[10px] bg-zinc-800 border border-zinc-700 px-2 py-1 rounded-full cursor-pointer hover:border-orange-500 transition text-gray-300">#${t.trim()}</span>`; });
            } else { tagsBtn.style.display = 'none'; }

            const modalLikeBtn = document.getElementById('modal-like-btn');
            modalLikeBtn.onclick = () => toggleReactionInModal(img.id);
            updateModalLikeUI(img.id);
            loadComments(img.id, currentContext);
            loadSimilarImagesInSlider(img.tags || [], img.id, img.characterName);

            document.getElementById('prev-image').style.display = currentIndex > 0 ? 'flex' : 'none';
            document.getElementById('next-image').style.display = currentIndex < currentPlaylist.length - 1 ? 'flex' : 'none';
        }

        // SIMILARES CON PESO (Igual a Feed)
        function loadSimilarImagesInSlider(tags, currentId, currentCharacterName) {
            const container = document.getElementById('similar-grid');
            container.innerHTML = '';
            
            const candidates = unifiedGalleryData.filter(p => p.id !== currentId && p.url);
            let finalResults = [];
            let addedIds = new Set();
            const normCharName = normalize(currentCharacterName);

            // Regla: Personaje > Tags
            if (normCharName) {
                const charMatches = candidates.filter(p => p.characterName && normalize(p.characterName) === normCharName).slice(0, 5);
                charMatches.forEach(p => { finalResults.push(p); addedIds.add(p.id); });
            }

            if (tags && tags.length > 0) {
                const tagMatches = candidates
                    .filter(p => !addedIds.has(p.id)) 
                    .map(p => {
                        const pTags = Array.isArray(p.tags) ? p.tags.map(t=>normalize(t)) : [];
                        const common = pTags.filter(t => tags.map(tt=>normalize(tt)).includes(t));
                        return { post: p, score: common.length };
                    })
                    .filter(item => item.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .map(item => item.post);
                finalResults = finalResults.concat(tagMatches);
            }

            if (finalResults.length === 0) { container.innerHTML = '<span class="text-xs text-gray-500 italic px-2 self-center">No hay similares.</span>'; return; }
            finalResults.slice(0, 10).forEach(post => {
                const div = document.createElement('div'); div.className = "similar-card cursor-pointer group"; div.onclick = () => updateModalContent(post);
                div.innerHTML = `<img src="${post.thumbnailUrl || post.url}" loading="lazy"><div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition"></div>`;
                container.appendChild(div);
            });
        }
        
        function toggleTags() { const div = document.getElementById('modal-tags'); const btn = document.getElementById('tags-toggle-btn'); if (div.classList.contains('hidden')) { div.classList.remove('hidden'); btn.innerHTML = '<span>Ocultar etiquetas</span> <i class="fas fa-chevron-up"></i>'; } else { div.classList.add('hidden'); btn.innerHTML = '<span>Ver etiquetas</span> <i class="fas fa-chevron-down"></i>'; } }
        function navigateToNext() { if(currentIndex < currentPlaylist.length - 1) { currentIndex++; updateModalContent(currentPlaylist[currentIndex]); } }
        function navigateToPrevious() { if(currentIndex > 0) { currentIndex--; updateModalContent(currentPlaylist[currentIndex]); } }
        const imageArea = document.getElementById('modal-image-area'); 
        imageArea.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: true});
        imageArea.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; touchEndY = e.changedTouches[0].screenY; handleSwipe(); }, {passive: true});
        function handleSwipe() { const deltaX = touchEndX - touchStartX; const deltaY = touchEndY - touchStartY; if (Math.abs(deltaX) > swipeThreshold && Math.abs(deltaX) > Math.abs(deltaY)) { if (deltaX < 0) navigateToNext(); else navigateToPrevious(); } else if (Math.abs(deltaY) > swipeThreshold && Math.abs(deltaY) > Math.abs(deltaX)) { if (deltaY > 0) closeModal(); } }
        function toggleFullScreen() { document.getElementById('modal').classList.toggle('fullscreen-mode'); }
        
        // --- FUNCIÓN CLOSE MODAL CORREGIDA Y MEJORADA ---
        function closeModal() { 
            const modal = document.getElementById('modal');
            modal.classList.remove('visible'); 
            
            // Esperar animación y resetear vista (salir de fullscreen y limpiar imagen)
            setTimeout(() => {
                modal.classList.remove('fullscreen-mode');
                document.getElementById('modal-image').src = ''; 
            }, 300);
            
            document.body.style.overflow = 'auto'; 
        }

        // --- LÓGICA DE LIKES (Unificada) ---
        function toggleReactionInModal(id) {
            const userId = currentUser && !currentUser.isAnonymous ? currentUser.uid : deviceID;
            const ref = db.ref(currentContext === 'feed' ? `feed_likes/${id}/${userId}` : `reactions/${id}/${userId}`);
            
            ref.once('value', s => {
                if(s.exists()) { 
                    if(currentContext === 'feed') { ref.remove(); db.ref(`feed_posts/${id}/likes`).transaction(c => (c||1)-1); } else { ref.remove(); }
                    userReactions[id] = null;
                } else { 
                    if(currentContext === 'feed') { ref.set(true); db.ref(`feed_posts/${id}/likes`).transaction(c => (c||0)+1); } else { ref.set('like'); }
                    userReactions[id] = 'like';
                }
            });
        }
        function updateModalLikeUI(id) {
            const userId = currentUser && !currentUser.isAnonymous ? currentUser.uid : deviceID;
            const modalLikeBtn = document.getElementById('modal-like-btn');
            const modalLikeCount = document.getElementById('modal-like-count');
            
            db.ref(currentContext === 'feed' ? `feed_likes/${id}/${userId}` : `reactions/${id}/${userId}`).on('value', s => {
                 if((currentContext === 'feed' && s.exists()) || (currentContext !== 'feed' && s.val() === 'like')) {
                     modalLikeBtn.classList.add('text-red-500', 'border-red-500/50', 'bg-red-500/10'); modalLikeBtn.querySelector('i').className = "fas fa-heart text-lg text-red-500 like-anim";
                 } else {
                     modalLikeBtn.classList.remove('text-red-500', 'border-red-500/50', 'bg-red-500/10'); modalLikeBtn.querySelector('i').className = "far fa-heart text-lg text-gray-400";
                 }
            });

            const pathCount = currentContext === 'feed' ? `feed_posts/${id}/likes` : `reactions/${id}`;
            db.ref(pathCount).on('value', s => {
                 let count = 0;
                 if(currentContext === 'feed') count = s.val() || 0;
                 else if(s.val()) Object.values(s.val()).forEach(v => { if(v === 'like') count++; });
                 modalLikeCount.innerText = count; 
            });
        }

        // --- COMENTARIOS ---
        function loadComments(id, context) { 
            let path = context === 'feed' ? `feed_comments/${id}` : `comments/${id}`; 
            const container = document.getElementById('comments'); 
            db.ref(path).off(); 
            db.ref(path).orderByChild('timestamp').on('value', snap => { 
                container.innerHTML = !snap.exists() ? '<p class="text-center text-gray-500 text-xs py-4">Sé el primero en comentar.</p>' : ''; 
                const comments = []; snap.forEach(child => comments.push(child.val())); 
                comments.reverse().forEach(c => { 
                    const div = document.createElement('div'); div.className = "flex gap-2 items-start text-sm animate-enter";
                    div.innerHTML = `<img src="${c.userAvatar || 'https://placehold.co/50'}" class="w-8 h-8 rounded-full mt-1 border border-gray-700 object-cover"><div class="bg-[#222] p-3 rounded-2xl rounded-tl-none border border-white/5 w-full"><span class="font-bold text-gray-300 block text-xs mb-1">${c.userName || c.name || 'Anónimo'}</span><span class="text-gray-200 leading-snug block break-words">${c.text || ''}</span></div>`; 
                    container.appendChild(div); 
                }); 
            }); 
        }
        document.getElementById('comment-form').addEventListener('submit', (e) => {
             e.preventDefault(); const input = document.getElementById('comment-input'); const text = input.value.trim(); if(!text) return;
             const path = currentContext === 'feed' ? `feed_comments/${currentImageId}` : `comments/${currentImageId}`;
             const finalUserName = (currentUser && userDataCache.username) ? userDataCache.username : (currentUser?.displayName || 'Anónimo');
             const finalUserAvatar = (currentUser && userDataCache.profilePic) ? userDataCache.profilePic : 'https://placehold.co/100x100';
             db.ref(path).push({ text: text, userId: currentUser ? currentUser.uid : 'anon', userName: finalUserName, name: finalUserName, userAvatar: finalUserAvatar, timestamp: Date.now() }); input.value = '';
        });

        // --- UTILS ---
        function executeSearch(query) { 
            document.getElementById('main-content-sections').classList.add('hidden'); document.getElementById('gallery').classList.add('hidden'); document.getElementById('search-results-container').classList.remove('hidden'); 
            document.getElementById('clear-search-btn').classList.remove('hidden'); document.getElementById('clear-search-btn').classList.add('flex');
            const matchedUsers = usersCache.filter(u => (u.username && normalize(u.username).includes(query))); 
            const matchedGallery = unifiedGalleryData.filter(i => (i.title && normalize(i.title).includes(query)) || (i.tags && i.tags.some(t => normalize(t).includes(query))) || (i.user && i.user.name && normalize(i.user.name).includes(query))); 
            currentSearchResults = [...matchedUsers, ...matchedGallery]; displaySearchResultsPage(1); 
        }
        function displaySearchResultsPage(page) { searchCurrentPage = page; const start = (page - 1) * searchResultsPerPage; const items = currentSearchResults.slice(start, start + searchResultsPerPage); displaySearchResults(items, 'search-results-grid', false, 'search'); renderPaginationControls(); }
        function renderPaginationControls(){ const container = document.getElementById('search-pagination'); const total = Math.ceil(currentSearchResults.length / searchResultsPerPage); container.innerHTML = ''; if (total <= 1) return; container.innerHTML = `<button onclick="displaySearchResultsPage(${searchCurrentPage - 1})" class="px-4 py-2 bg-gray-700 rounded-md" ${searchCurrentPage === 1 ? 'disabled' : ''}>Anterior</button><span>Página ${searchCurrentPage} de ${total}</span><button onclick="displaySearchResultsPage(${searchCurrentPage + 1})" class="px-4 py-2 bg-gray-700 rounded-md" ${searchCurrentPage === total ? 'disabled' : ''}>Siguiente</button>`; }
        function resetSearchView(){ document.getElementById('search-input').value = ''; document.getElementById('search-results-container').classList.add('hidden'); document.getElementById('main-content-sections').classList.remove('hidden'); document.getElementById('gallery').classList.remove('hidden'); const clearBtn = document.getElementById('clear-search-btn'); clearBtn.classList.add('hidden'); clearBtn.classList.remove('flex'); }
        
        function setupEventListeners() { 
            document.getElementById('search-form').addEventListener('submit', e => { e.preventDefault(); executeSearch(normalize(document.getElementById('search-input').value)); });
            document.getElementById('clear-search-btn').addEventListener('click', resetSearchView);
            const obs = new IntersectionObserver(e => { if(e[0].isIntersecting) loadMoreImages(); }); obs.observe(document.getElementById('load-more-trigger'));
            document.getElementById('next-image').onclick = navigateToNext; document.getElementById('prev-image').onclick = navigateToPrevious;
            
            // Evento Tecla ESCAPE para cerrar
            document.addEventListener('keydown', e => { if(e.key === 'Escape') closeModal(); });
        }

        function generateSkeletons(container, count) { container.innerHTML = ''; for (let i = 0; i < count; i++) { container.appendChild(document.createElement('div')).className = 'skeleton'; } }
        function normalize(text) { return text ? text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim() : ''; }
        function timeAgo(ts) { if(!ts) return ''; const s = Math.floor((Date.now()-ts)/1000); if(s<60) return 'Hace un momento'; if(s<3600) return Math.floor(s/60)+'m'; if(s<86400) return Math.floor(s/3600)+'h'; return Math.floor(s/86400)+'d'; }
        
        function requireLogin(event) { if (!currentUser) { if(event) { event.preventDefault(); event.stopPropagation(); } window.location.href = 'login.html'; return false; } return true; }
        
        function loadUserProfile(uid) { db.ref('users/' + uid).once('value', snap => { if (snap.exists()) { const data = snap.val(); document.getElementById('header-user-img').src = data.profilePic || 'https://placehold.co/100x100/333/fff?text=U'; userDataCache = data; } }); }
        
        let newProfileFile = null;
        function openConfigModal() { document.getElementById('profile-menu').classList.remove('visible'); document.getElementById('config-modal').style.display = 'flex'; document.getElementById('config-preview-img').src = document.getElementById('header-user-img').src; document.getElementById('config-upload-status').innerHTML = 'Toca para cambiar imagen'; document.getElementById('btn-save-config').disabled = false; document.getElementById('btn-save-config').innerHTML = 'Guardar'; newProfileFile = null; }
        function closeConfigModal() { document.getElementById('config-modal').style.display = 'none'; }
        async function handleConfigImageSelect(event) { const file = event.target.files[0]; if (!file) return; if (file.size > 5 * 1024 * 1024) { alert("Máx 5MB"); return; } newProfileFile = file; document.getElementById('config-preview-img').src = URL.createObjectURL(file); document.getElementById('config-upload-status').innerHTML = '<span class="text-orange-400 font-bold">Imagen seleccionada (No guardada aún)</span>'; }
        async function saveNewProfilePic() { if (!newProfileFile) { closeConfigModal(); return; } const btn = document.getElementById('btn-save-config'); const status = document.getElementById('config-upload-status'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...'; status.innerHTML = 'Subiendo a Catbox...'; try { const formData = new FormData(); formData.append('reqtype', 'fileupload'); formData.append('userhash', CATBOX_USERHASH); formData.append('fileToUpload', newProfileFile); const res = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", { method: 'POST', body: formData }); if (!res.ok) throw new Error("Error de red"); const url = await res.text(); if (url.includes('catbox.moe')) { const finalUrl = url.trim(); if (currentUser) { await db.ref('users/' + currentUser.uid).update({ profilePic: finalUrl }); alert('Foto actualizada correctamente'); closeConfigModal(); window.location.reload(); } } else { throw new Error("Error Catbox API"); } } catch (e) { console.error(e); status.innerHTML = '<span class="text-red-500">Error al subir imagen</span>'; btn.disabled = false; btn.innerHTML = 'Reintentar'; } }
        function logoutUser() { auth.signOut().then(() => { window.location.reload(); }); }
    </script>
</body>
</html>