<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exen-E | Galería Premium v2</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Estilos Personalizados y Mejoras -->
    <style>
        :root {
            --accent: #e65100;
            --accent-neon: #ffab00;
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0a09; /* stone-950 */
            color: #f3f4f6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .masonry-grid {
            column-count: 2;
            column-gap: 0.75rem; /* gap-3 */
        }
        @media (min-width: 640px) { .masonry-grid { column-count: 3; } }
        @media (min-width: 1024px) { .masonry-grid { column-count: 4; } }
        @media (min-width: 1280px) { .masonry-grid { column-count: 5; } }

        .masonry-item {
            break-inside: avoid;
            margin-bottom: 0.75rem; /* gap-3 */
            display: inline-block;
            width: 100%;
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .skeleton {
            background-color: #292524; /* stone-800 */
            background-image: linear-gradient(to right, #292524 0%, #44403c 20%, #292524 40%, #292524 100%);
            background-repeat: no-repeat;
            background-size: 2000px 100%;
            animation: shimmer 2s linear infinite;
            border-radius: 0.75rem; /* rounded-xl */
        }
        .skeleton:nth-child(3n+1) { height: 24rem; }
        .skeleton:nth-child(3n+2) { height: 32rem; }
        .skeleton:nth-child(3n+3) { height: 28rem; }


        .tab-btn.active {
            background-color: var(--accent);
            color: #ffffff;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1c1917; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-neon); }
        
        #scrollToTopBtn {
            position: fixed;
            bottom: -100px;
            right: 20px;
            z-index: 100;
            transition: bottom 0.4s ease-in-out;
        }
        #scrollToTopBtn.visible { bottom: 20px; }
        .winning { box-shadow: 0 0 20px 5px #00ff00; }
        .losing { box-shadow: 0 0 20px 5px #ff0000; }

        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-100px) scale(1.2); } }
        .reaction-animation { position: absolute; font-size: 2rem; pointer-events: none; animation: floatUp 1.5s ease forwards; z-index: 10; text-shadow: 0 0 5px rgba(0,0,0,0.5); }

        /* Estilos para el nuevo botón de reacción */
        #reaction-circle-container.open .reaction-circle-item {
            opacity: 1;
            transform: scale(1) var(--transform-pos);
        }
        #reaction-circle-container.open #reaction-bg {
            transform: scale(1);
        }
        .reaction-circle-item {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform: scale(0);
            opacity: 0;
        }
    </style>
</head>
<body class="antialiased">

    <!-- ========== OVERLAYS ========== -->
    <div id="warning-overlay" class="fixed inset-0 z-[2000] flex-col items-center justify-center bg-black/90 p-4 text-center backdrop-blur-sm" style="display: none;">
        <h1 class="mb-6 text-3xl font-bold text-orange-500 flex items-center gap-3 animate-pulse"><i class="fas fa-exclamation-triangle"></i> Contenido +18</h1>
        <p class="mb-8 max-w-md text-lg text-gray-300">Esta galería contiene material sensible. Debes tener al menos 18 años para continuar.</p>
        <div class="flex flex-col sm:flex-row gap-4">
            <button class="w-full rounded-full bg-orange-600 px-8 py-3 font-semibold text-white transition hover:bg-orange-500 hover:scale-105" onclick="acceptWarning()"><i class="fas fa-check mr-2"></i> Sí, Soy Mayor de Edad</button>
            <button class="w-full rounded-full bg-gray-700 px-8 py-3 font-semibold text-white transition hover:bg-gray-600 hover:scale-105" onclick="rejectWarning()"><i class="fas fa-times mr-2"></i> No, salir</button>
        </div>
    </div>
    <div id="disclaimer" class="fixed inset-0 z-[2000] items-center justify-center bg-black/90 p-4 backdrop-blur-sm" style="display: none;">
        <div class="w-full max-w-lg rounded-2xl border border-orange-500/50 bg-stone-900/80 p-8 shadow-2xl">
            <p class="mb-6 text-gray-300">Este sitio presenta fan arts creados mediante IA con fines artísticos y de entretenimiento, sin fines de lucro. Los derechos de autor pertenecen a sus creadores originales de cada personaje representado.</p>
            <button id="disclaimer-close" class="w-full rounded-full bg-gradient-to-r from-orange-500 to-yellow-500 px-6 py-3 font-bold text-gray-900 transition hover:scale-105">Entendido</button>
        </div>
    </div>

    <!-- ========== HEADER ========== -->
    <header class="sticky top-0 z-[100] flex items-center justify-between bg-stone-950/80 p-4 backdrop-blur-lg border-b border-stone-800">
        <h1 class="flex items-center gap-3 text-2xl font-bold">
            <svg class="h-10 w-10" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="var(--accent)"/>
                <path d="M30 70 L50 30 L70 70" stroke="#111827" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="10" fill="var(--accent-neon)"/>
            </svg>
            <span class="bg-gradient-to-r from-stone-200 to-stone-400 bg-clip-text text-transparent">exen-E</span>
        </h1>
        <div id="user-profile" class="flex items-center gap-2 rounded-full bg-stone-800/80 px-4 py-2 text-sm font-semibold text-stone-200"></div>
    </header>

    <main class="container mx-auto px-4">
        <!-- ========== BARRA DE BÚSQUEDA Y FILTROS ========== -->
        <div class="my-6">
            <div class="relative">
                <input type="text" id="search" placeholder="Buscar entre miles de imágenes..." class="w-full rounded-full border-2 border-stone-700 bg-stone-900 pl-12 pr-5 py-3 text-white transition placeholder:text-stone-500 focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500/50">
                <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-stone-500"></i>
            </div>
        </div>

        <!-- ========== NAVEGACIÓN POR PESTAÑAS ========== -->
        <nav class="my-8 flex items-center justify-center rounded-full bg-stone-900 p-1.5 border border-stone-800">
            <button data-tab="recent" class="tab-btn active flex-1 rounded-full px-4 py-2 text-sm sm:text-base font-bold text-stone-300 transition hover:bg-stone-800"><i class="fas fa-clock mr-2"></i> Recientes</button>
            <button data-tab="popular" class="tab-btn flex-1 rounded-full px-4 py-2 text-sm sm:text-base font-bold text-stone-300 transition hover:bg-stone-800"><i class="fas fa-fire mr-2"></i> Populares</button>
            <button data-tab="battle" class="tab-btn flex-1 rounded-full px-4 py-2 text-sm sm:text-base font-bold text-stone-300 transition hover:bg-stone-800"><i class="fas fa-gavel mr-2"></i> Batalla</button>
        </nav>
        
        <!-- ========== CONTENEDORES DE PESTAÑAS ========== -->
        <div id="gallery-content">
            <div id="recent-content" class="tab-content active"><div id="recent-grid" class="masonry-grid"></div></div>
            <div id="popular-content" class="tab-content"><div id="popular-grid" class="masonry-grid"></div></div>
            <div id="battle-content" class="tab-content"></div>
            <div id="search-content" class="tab-content">
                <div id="search-grid" class="masonry-grid"></div>
                <p id="search-empty" class="text-center text-stone-500 py-12" style="display: none;">No se encontraron resultados para tu búsqueda.</p>
            </div>
            <div id="loader" class="py-8 text-center text-stone-400" style="display: none;"><i class="fas fa-spinner fa-spin text-2xl"></i> Cargando más...</div>
        </div>
    </main>

    <!-- ========== MODAL ========== -->
    <div id="modal" class="fixed inset-0 z-[1000] bg-black/80 backdrop-blur-md" style="display: none;">
        <div id="modal-content" class="h-full w-full overflow-y-auto">
            <div class="container mx-auto flex max-w-4xl flex-col gap-4 p-2 sm:p-4">
                <header id="modal-header" class="flex items-center justify-between">
                    <h2 id="title" class="bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-2xl sm:text-4xl font-black text-transparent"></h2>
                    <button id="close-modal" class="flex h-12 w-12 items-center justify-center rounded-full bg-stone-800/80 text-stone-400 transition hover:bg-stone-700 hover:text-white hover:rotate-90">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </header>
                <div class="flex flex-col items-center gap-4">
                    <div id="image-container" class="relative w-full">
                        <img id="full-img" src="" alt="" class="h-auto max-h-[75vh] w-full object-contain transition-transform duration-300 rounded-lg">
                    </div>

                    <!-- BOTÓN DE REACCIÓN INTEGRADO -->
                    <div id="reaction-circle-container" class="relative z-20">
                        <div class="relative flex items-center justify-center">
                            <div id="reaction-bg" class="absolute inset-[-30px] rounded-full bg-stone-900/50 backdrop-blur-sm transition-transform duration-300 scale-0 -z-10"></div>
                            <div class="reaction-circle-item absolute" style="--transform-pos: translateX(-65px) translateY(-10px);"><span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="like">❤️</span></div>
                            <div class="reaction-circle-item absolute" style="--transform-pos: translateX(-45px) translateY(-55px);"><span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="hot">🔥</span></div>
                            <div class="reaction-circle-item absolute" style="--transform-pos: translateX(0px) translateY(-70px);"><span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="wow">😯</span></div>
                            <div class="reaction-circle-item absolute" style="--transform-pos: translateX(45px) translateY(-55px);"><span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="laugh">😂</span></div>
                            <div class="reaction-circle-item absolute" style="--transform-pos: translateX(65px) translateY(-10px);"><span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="sad">😢</span></div>
                             <div class="reaction-circle-item absolute" style="--transform-pos: translateX(0px) translateY(55px);"><span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="sexy">🫦</span></div>
                            <button id="like-btn" class="relative z-10 flex h-14 w-14 items-center justify-center rounded-full bg-gradient-to-r from-orange-500 to-yellow-500 text-gray-900 shadow-lg transition-transform duration-300 hover:scale-110">
                                <i class="fas fa-heart text-2xl"></i>
                            </button>
                        </div>
                    </div>

                    <div id="reaction-counts-container" class="flex flex-wrap items-center justify-center gap-4 rounded-full bg-stone-800/80 px-4 py-2 text-lg"></div>
                    <p id="desc" class="rounded-xl border border-orange-500/30 bg-stone-900/50 p-4 text-center text-stone-300 w-full"></p>
                    <section id="comments-section" class="mt-4 w-full">
                        <form id="comment-form" class="mb-6 flex flex-col gap-3 rounded-xl bg-stone-900/50 p-4 sm:flex-row">
                            <input type="text" id="name-input" placeholder="Nombre (opcional)" class="w-full rounded-lg border-2 border-stone-700 bg-stone-800 px-4 py-2 text-white transition focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500/50 sm:w-1/4">
                            <input type="text" id="comment-input" placeholder="Escribe un comentario..." class="flex-grow rounded-lg border-2 border-stone-700 bg-stone-800 px-4 py-2 text-white transition focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500/50">
                            <button type="submit" id="comment-btn" class="group flex-shrink-0 rounded-lg bg-orange-600 px-5 py-2 font-semibold text-white transition hover:bg-orange-500">
                                <i class="fas fa-paper-plane transition group-hover:rotate-12"></i> Enviar
                            </button>
                        </form>
                        <div id="comments" class="flex flex-col gap-4"></div>
                    </section>
                </div>
            </div>
        </div>
    </div>
    
    <button id="scrollToTopBtn" title="Ir arriba" class="h-12 w-12 rounded-full bg-orange-600/80 text-white shadow-lg backdrop-blur-sm transition hover:bg-orange-500 hover:scale-110">
        <i class="fas fa-arrow-up"></i>
    </button>
    
    <footer class="mt-12 py-8 text-center text-stone-500">
        <span id="disclaimer-link" class="cursor-pointer text-orange-500 hover:underline">Descargo de Responsabilidades</span>
        <p class="mt-2 text-sm">&copy; 2025 exen-E. Todos los derechos reservados.</p>
    </footer>

    <script>
        // --- SCRIPT BLOCK v2 (CORREGIDO) ---
        "use strict";
        const firebaseConfig = {
            apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8",
            authDomain: "exene-53e6b.firebaseapp.com",
            databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com",
            projectId: "exene-53e6b",
            storageBucket: "exene-53e6b.appspot.com",
            messagingSenderId: "481369419867",
            appId: "1:481369419867:web:ac5db24c436344262c8f7e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        firebase.auth().signInAnonymously().catch(error => console.error('Authentication error:', error));

        const imagesPerLoad = 20;
        let allImageKeys = [], searchableImages = [], currentImagePage = 0;
        let isLoading = false, activeTab = 'recent', currentImageId = '', viewStartTime = null;

        let deviceID = localStorage.getItem('deviceID') || (() => {
            const id = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            localStorage.setItem('deviceID', id);
            return id;
        })();
        let username = localStorage.getItem('username') || '';

        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('adultConsent')) {
                document.getElementById('warning-overlay').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            } else {
                initializeApp();
            }
            setupEventListeners();
            updateUserProfile();
        });

        async function initializeApp() {
            generateSkeletons(document.getElementById('recent-grid'), imagesPerLoad);
            try {
                // <-- CORRECCIÓN: Se elimina orderByChild para evitar error de índice. El orden se hará en el cliente.
                const snapshot = await db.ref('images').get();
                if (!snapshot.exists()) { showError('No se encontraron imágenes.'); return; }
                
                const imagesData = snapshot.val();
                
                // <-- CORRECCIÓN: Convertir el objeto a un array, ordenar por timestamp en el cliente y luego obtener los datos.
                const imagesArray = Object.keys(imagesData).map(key => ({
                    id: key,
                    ...imagesData[key]
                }));
                
                imagesArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); // Orden descendente

                allImageKeys = imagesArray.map(img => img.id);
                searchableImages = imagesArray;
                
                loadRecentImages();
            } catch(error) {
                console.error("Initialization error:", error);
                showError('No se pudo conectar a la base de datos.');
            }
        }

        function loadRecentImages(isInitial = true) {
            if (isLoading) return;
            isLoading = true;
            if(!isInitial) document.getElementById('loader').style.display = 'block';
            const startIndex = currentImagePage * imagesPerLoad;
            const keysToLoad = allImageKeys.slice(startIndex, startIndex + imagesPerLoad);
            if (keysToLoad.length === 0) {
                isLoading = false;
                document.getElementById('loader').style.display = 'none';
                return;
            }
            const imagesToDisplay = keysToLoad.map(key => searchableImages.find(img => img.id === key));
            displayImages(imagesToDisplay, !isInitial);
            currentImagePage++;
            isLoading = false;
            if(!isInitial) document.getElementById('loader').style.display = 'none';
        }

        async function loadPopularImages() {
            const grid = document.getElementById('popular-grid');
            if (grid.innerHTML.trim() !== '') return;
            generateSkeletons(grid, 15);
            try {
                const reactionsSnap = await db.ref('reactions').get();
                const reactions = reactionsSnap.val() || {};
                const scoredImages = searchableImages.map(img => ({ ...img, score: reactions[img.id] ? Object.keys(reactions[img.id]).length : 0 }));
                scoredImages.sort((a, b) => b.score - a.score);
                displayImages(scoredImages.slice(0, 50), false, 'popular-grid');
            } catch (error) { console.error("Error loading popular images:", error); grid.innerHTML = '<p class="text-center text-red-400">Error al cargar esta sección.</p>'; }
        }
        
        async function loadBattleSection() {
             const battleContainer = document.getElementById('battle-content');
             if(battleContainer.innerHTML.trim() !== '') return;
             battleContainer.innerHTML = `<section id="battle-section" class="max-w-4xl mx-auto"><h3 class="mb-6 flex items-center justify-center gap-3 text-center text-3xl font-black bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent"><i class="fas fa-gavel"></i> Batalla de la Semana</h3><div id="battle-grid" class="flex items-center justify-center gap-2 sm:gap-4"><div class="w-full h-96 skeleton rounded-xl"></div><span class="text-4xl font-black text-orange-500">VS</span><div class="w-full h-96 skeleton rounded-xl"></div></div><div id="battle-timer" class="mt-4 text-center font-semibold text-stone-400"></div></section>`;
             initBattleSection(); 
        }

        function setupEventListeners() {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');
            window.addEventListener('scroll', () => {
                window.scrollY > 500 ? scrollToTopBtn.classList.add('visible') : scrollToTopBtn.classList.remove('visible');
                if (activeTab === 'recent' && (window.innerHeight + window.scrollY >= document.body.offsetHeight - 800)) {
                    loadRecentImages(false);
                }
            });
            scrollToTopBtn.addEventListener('click', () => window.scrollTo({top: 0, behavior: 'smooth'}));
            document.getElementById('search').addEventListener('input', handleSearch);
            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.getElementById('modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
            document.getElementById('comment-form').addEventListener('submit', handleCommentSubmit);
            document.getElementById('disclaimer-close').addEventListener('click', () => {
                document.getElementById('disclaimer').style.display = 'none';
                document.body.style.overflow = 'auto';
                localStorage.setItem('disclaimerShown', 'true');
            });
            document.getElementById('disclaimer-link').addEventListener('click', () => {
                document.getElementById('disclaimer').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            });
            // Reaction button listeners
            document.getElementById('like-btn').addEventListener('click', e => {
                e.stopPropagation();
                document.getElementById('reaction-circle-container').classList.toggle('open');
            });
            document.querySelectorAll('.reaction').forEach(reaction => {
                reaction.addEventListener('click', handleReactionClick);
            });
            document.addEventListener('click', () => document.getElementById('reaction-circle-container').classList.remove('open'));
        }
        
        let searchTimeout;
        function handleSearch(e) {
            const query = e.target.value.trim().toLowerCase();
            clearTimeout(searchTimeout);
            if (!query) { switchTab(activeTab === 'search' ? 'recent' : activeTab); return; }
            if (activeTab !== 'search') {
                document.querySelectorAll('.tab-btn.active').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content.active').forEach(c => c.classList.remove('active'));
                document.getElementById('search-content').classList.add('active');
            }
            activeTab = 'search';
            const searchGrid = document.getElementById('search-grid');
            searchGrid.innerHTML = '';
            document.getElementById('search-empty').style.display = 'none';
            generateSkeletons(searchGrid, 10);
            searchTimeout = setTimeout(() => {
                const results = searchableImages.filter(img => img.title.toLowerCase().includes(query) || (img.tags && img.tags.some(tag => tag.toLowerCase().includes(query))));
                if (results.length > 0) { displayImages(results, false, 'search-grid'); } 
                else { searchGrid.innerHTML = ''; document.getElementById('search-empty').style.display = 'block'; }
            }, 300);
        }

        function switchTab(tabId) {
            if (document.getElementById('search').value !== '') { document.getElementById('search').value = ''; }
            activeTab = tabId;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `${tabId}-content`));
            if (tabId === 'popular') loadPopularImages();
            if (tabId === 'battle') loadBattleSection();
        }

        function displayImages(images, append = false, gridId = 'recent-grid') {
            const grid = document.getElementById(gridId);
            if (!append) grid.innerHTML = '';
            images.forEach((img, index) => {
                if (!img || !img.url) return;
                const div = document.createElement('div');
                div.className = 'masonry-item group relative cursor-pointer overflow-hidden rounded-xl shadow-lg bg-stone-800';
                div.style.opacity = 0;
                div.style.animation = `fadeIn 0.5s ease ${index * 0.05}s forwards`;
                div.setAttribute('onclick', `openModal('${img.id}')`);
                div.innerHTML = `<img src="${img.url}" alt="${img.title}" loading="lazy" class="h-full w-full object-cover transition duration-500 ease-in-out group-hover:scale-110" onerror="this.src='https://placehold.co/600x800/1c1917/44403c?text=Error'"><div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div><div class="absolute bottom-0 left-0 p-4 w-full translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300"><h4 class="font-bold text-white text-lg truncate">${img.title}</h4></div>`;
                grid.appendChild(div);
            });
        }
        
        function generateSkeletons(container, count) {
            container.innerHTML = '';
            for (let i = 0; i < count; i++) { container.innerHTML += '<div class="masonry-item skeleton"></div>'; }
        }
        
        function showError(message) { document.getElementById('recent-grid').innerHTML = `<p class="col-span-full text-center py-12 text-red-400 font-semibold">${message}</p>`; }
        
        async function openModal(id) {
            const img = searchableImages.find(i => i.id === id);
            if (!img) { console.error("Image not found"); return; }
            currentImageId = id;
            document.getElementById('full-img').src = img.url || '';
            document.getElementById('title').textContent = img.title || '';
            document.getElementById('desc').textContent = img.desc || '';
            loadLikes(id);
            loadComments(id);
            document.getElementById('modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            viewStartTime = Date.now();
            setTimeout(() => document.getElementById('modal-content').scrollTop = 0, 50);
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentImageId = '';
        }

        function handleReactionClick(e) {
            e.stopPropagation();
            if (!currentImageId) return;
            const type = e.currentTarget.dataset.type;
            const reactionsRef = db.ref(`reactions/${currentImageId}/${deviceID}`);
            reactionsRef.once('value', snap => {
                if (snap.val() === type) { reactionsRef.remove(); }
                else {
                    reactionsRef.set(type);
                    showReactionAnimation(type, document.getElementById('image-container'));
                }
            });
            document.getElementById('reaction-circle-container').classList.remove('open');
        }

        function showReactionAnimation(type, container) {
            const icons = {'like':'❤️', 'hot':'🔥', 'wow':'😯', 'laugh':'😂', 'sad':'😢', 'sexy':'🫦'};
            if (!icons[type]) return;
            const reaction = document.createElement('span');
            reaction.className = 'reaction-animation';
            reaction.textContent = icons[type];
            reaction.style.left = `${Math.random() * 80 + 10}%`;
            reaction.style.bottom = '20px';
            container.appendChild(reaction);
            setTimeout(() => reaction.remove(), 1500);
        }

        function loadLikes(id) {
            db.ref(`reactions/${id}`).on('value', snap => {
                const reactions = snap.val() || {};
                const counts = Object.values(reactions).reduce((acc, type) => { acc[type] = (acc[type] || 0) + 1; return acc; }, {});
                const icons = {'like':'❤️', 'hot':'🔥', 'wow':'😯', 'laugh':'😂', 'sad':'😢', 'sexy':'🫦'};
                document.getElementById('reaction-counts-container').innerHTML = Object.entries(icons).map(([type, icon]) => `<span class="flex items-center gap-1">${icon} <span class="font-bold">${counts[type] || 0}</span></span>`).join('');
                const userReaction = reactions[deviceID];
                const btnIcon = document.querySelector('#like-btn i');
                const iconMap = { hot: 'fa-fire-alt', like: 'fa-heart', wow: 'fa-surprise', laugh: 'fa-laugh-beam', sad: 'fa-sad-tear', sexy: 'fa-kiss-wink-heart' };
                btnIcon.className = `fas ${iconMap[userReaction] || 'fa-heart'} text-2xl`;
            });
        }

        function loadComments(id) {
            db.ref(`comments/${id}`).orderByChild('timestamp').on('value', snap => {
                const commentsContainer = document.getElementById('comments');
                commentsContainer.innerHTML = '';
                if (!snap.exists()) { commentsContainer.innerHTML = '<p class="text-stone-500 text-center">Sé el primero en comentar.</p>'; return; }
                const comments = [];
                snap.forEach(child => { comments.push(child.val()); });
                comments.reverse().forEach(comment => commentsContainer.appendChild(renderComment(comment)));
            });
        }

        function renderComment(comment) {
            const div = document.createElement('div');
            const initial = comment.name ? comment.name.charAt(0).toUpperCase() : 'A';
            div.innerHTML = `<div class="flex gap-3"><div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-gradient-to-br from-orange-500 to-yellow-500 text-gray-900 font-bold">${initial}</div><div class="flex-grow min-w-0"><div class="rounded-lg rounded-tl-none bg-stone-800 p-3"><p class="font-bold text-orange-400">${comment.name || 'Anónimo'}</p><p class="text-stone-300 whitespace-pre-wrap break-words">${comment.text || ''}</p></div><small class="text-xs text-stone-500 pl-2 pt-1">${new Date(comment.timestamp).toLocaleString()}</small></div></div>`;
            return div;
        }

        function handleCommentSubmit(e) {
            e.preventDefault();
            const nameInput = document.getElementById('name-input'), commentInput = document.getElementById('comment-input');
            const comment = commentInput.value.trim();
            if (!comment || !currentImageId) return;
            if (nameInput.value.trim() && !username) {
                username = nameInput.value.trim();
                localStorage.setItem('username', username);
                updateUserProfile();
            }
            const commentData = { name: username || 'Anónimo', text: comment, timestamp: Date.now() };
            db.ref(`comments/${currentImageId}`).push(commentData).then(() => { commentInput.value = ''; }).catch(error => console.error('Error adding comment:', error));
        }

        async function initBattleSection() {
            const snap = await db.ref('battle').once('value');
            const battle = snap.val() || {};
            const now = Date.now();
            if (!battle.images || !battle.expiry || battle.expiry < now) {
                let [img1, img2] = await Promise.all([getRandomImage(), getRandomImage()]);
                while(!img1 || !img2 || img1.id === img2.id) { img2 = await getRandomImage(); }
                const newBattle = { images: [img1.id, img2.id], votes: { [img1.id]: 0, [img2.id]: 0 }, expiry: now + (7*24*60*60*1000), users: {} };
                db.ref('battle').set(newBattle);
                displayBattle([img1, img2]);
            } else {
                const images = await Promise.all(battle.images.map(id => searchableImages.find(img => img.id === id)));
                displayBattle(images);
            }
        }
        
        function displayBattle(images) {
            const [img1, img2] = images;
            const battleGrid = document.getElementById('battle-grid');
            const timerEl = document.getElementById('battle-timer');
            if(!img1 || !img2) { battleGrid.innerHTML = `<p class="text-red-500">Error al cargar imágenes de batalla.</p>`; return; }
            const renderItem = (img) => `<div id="battle-item-${img.id}" class="battle-item relative w-full group"><div class="aspect-[3/4] rounded-xl overflow-hidden shadow-lg transition duration-300 transform group-hover:scale-105 relative"><img src="${img.url}" alt="${img.title}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div><div class="absolute top-2 right-2 bg-black/60 rounded-full px-3 py-1 text-sm font-bold" id="vote-count-${img.id}">0</div><button class="battle-vote-btn absolute bottom-4 left-1/2 -translate-x-1/2 w-4/5 rounded-full bg-gradient-to-r from-orange-500 to-yellow-500 px-4 py-2 font-bold text-gray-900 transition hover:scale-105" onclick="voteBattle('${img.id}')">Votar</button></div></div>`;
            battleGrid.innerHTML = `${renderItem(img1)}<span class="text-4xl font-black text-orange-500 self-center">VS</span>${renderItem(img2)}`;
            db.ref('battle').on('value', snap => {
                const data = snap.val();
                if (!data || !data.votes) return;
                const votes1 = data.votes[img1.id] || 0, votes2 = data.votes[img2.id] || 0;
                document.getElementById(`vote-count-${img1.id}`).textContent = votes1;
                document.getElementById(`vote-count-${img2.id}`).textContent = votes2;
                const item1 = document.getElementById(`battle-item-${img1.id}`), item2 = document.getElementById(`battle-item-${img2.id}`);
                item1.classList.remove('winning', 'losing'); item2.classList.remove('winning', 'losing');
                if (votes1 > votes2) { item1.classList.add('winning'); item2.classList.add('losing'); }
                else if (votes2 > votes1) { item2.classList.add('winning'); item1.classList.add('losing'); }
                if (data.users && data.users[deviceID]) { document.querySelectorAll('.battle-vote-btn').forEach(b => b.style.display = 'none'); }
                const timeLeft = data.expiry - Date.now();
                if (timeLeft <= 0) {
                    clearInterval(window.battleTimerInterval);
                    timerEl.textContent = "La batalla ha terminado.";
                }
            });
            if(window.battleTimerInterval) clearInterval(window.battleTimerInterval);
            window.battleTimerInterval = setInterval(() => {
                db.ref('battle/expiry').once('value', expirySnap => {
                    const timeLeft = expirySnap.val() - Date.now();
                    if(timeLeft <= 0) { clearInterval(window.battleTimerInterval); initBattleSection(); return; }
                    const d = Math.floor(timeLeft/(1000*60*60*24)), h = Math.floor(timeLeft/(1000*60*60))%24, m = Math.floor(timeLeft/1000/60)%60;
                    timerEl.textContent = `Tiempo restante: ${d}d ${h}h ${m}m`;
                });
            }, 1000);
        }

        async function getRandomImage() {
            const randomIndex = Math.floor(Math.random() * allImageKeys.length);
            return searchableImages.find(img => img.id === allImageKeys[randomIndex]);
        }

        function voteBattle(imageId) {
            db.ref(`battle/users/${deviceID}`).once('value', snap => {
                if(snap.exists()) return;
                db.ref(`battle/users/${deviceID}`).set(imageId);
                db.ref(`battle/votes/${imageId}`).transaction(c => (c||0)+1);
            });
        }
        
        function updateUserProfile() {
            document.getElementById('user-profile').innerHTML = `<i class="fas fa-user-circle text-xl text-orange-400"></i> ${username || 'Anónimo'}`;
            document.getElementById('name-input').style.display = username ? 'none' : 'block';
        }
        function acceptWarning() { localStorage.setItem('adultConsent', 'true'); document.getElementById('warning-overlay').style.display = 'none'; document.body.style.overflow = 'auto'; initializeApp(); }
        function rejectWarning() { window.location.href = 'https://google.com'; }
    </script>
</body>
</html>

