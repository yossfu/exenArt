<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exen-E</title>
    <!-- Librerías gratuitas -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-primary: #212121;
            --bg-secondary: #2d2d2d;
            --text-primary: #f5f5f5;
            --text-secondary: #b0bec5;
            --accent: #e65100;
            --accent-secondary: #01579b;
            --accent-neon: #ffab00;
            --border: #424242;
            --shadow: 0 6px 24px rgba(0, 0, 0, 0.6);
            --translucent: rgba(45, 45, 45, 0.9);
            --divider: linear-gradient(to right, transparent, #424242, transparent);
            --diamond: #b9f2ff;
            --gold: #ffd700;
            --silver: #c0c0c0;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
        }
        /* Divisores */
        .section-divider {
            height: 1px;
            background: var(--divider);
            margin: 2rem 0;
        }
        /* Advertencia +18 */
        #warning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            text-align: center;
            padding: 2rem;
        }
        #warning-overlay h1 {
            font-size: 2.2rem;
            margin-bottom: 1.5rem;
            color: var(--accent);
            animation: animate__pulse 1s infinite;
        }
        #warning-overlay p {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            color: var(--text-secondary);
        }
        .warning-btn {
            padding: 0.8rem 1.5rem;
            margin: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .warning-btn:hover {
            background: linear-gradient(135deg, var(--accent), var(--accent-neon));
            transform: scale(1.05);
            box-shadow: 0 0 10px var(--accent-neon);
        }
        .warning-btn.yes {
            background: var(--accent);
            border-color: var(--accent);
        }
        .warning-btn.yes:hover {
            background: linear-gradient(135deg, var(--accent), var(--accent-neon));
        }
        /* Descargo de Responsabilidades */
        #disclaimer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            text-align: center;
            padding: 2rem;
        }
        #disclaimer.show {
            display: flex;
        }
        #disclaimer-content {
            background: var(--translucent);
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            backdrop-filter: blur(8px);
            border: 2px solid var(--accent-neon);
        }
        #disclaimer-content p {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }
        #disclaimer-close {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-neon));
            color: var(--bg-primary);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #disclaimer-close:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px var(--accent-neon);
        }
        #disclaimer-link {
            color: var(--accent-neon);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 1rem;
            display: inline-block;
        }
        #disclaimer-link:hover {
            color: var(--accent);
        }
        /* Header */
        header {
            background: var(--translucent);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(12px);
        }
        header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .logo {
            width: 40px;
            height: 40px;
        }
        #user-profile {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--translucent);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        #user-profile svg {
            width: 24px;
            height: 24px;
            fill: var(--accent-neon);
        }
        /* Búsqueda */
        #search-container {
            padding: 1.5rem;
            text-align: center;
            background: var(--translucent);
            backdrop-filter: blur(12px);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }
        #search {
            width: 100%;
            max-width: 550px;
            padding: 0.8rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 50px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        #search::placeholder {
            color: var(--text-secondary);
        }
        #search:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(230, 81, 0, 0.2);
        }
        #search-btn {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-neon));
            color: var(--bg-primary);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #search-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px var(--accent-neon);
        }
        /* Resultados de Búsqueda */
        #search-results {
            display: none;
            flex-wrap: wrap;
            gap: 1.2rem;
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
            justify-content: center;
        }
        #search-results.show {
            display: flex;
        }
        .search-result-item {
            width: calc(33.33% - 0.8rem);
            aspect-ratio: 2/3;
            max-height: 400px;
            background: var(--bg-secondary);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.4s ease, box-shadow 0.4s ease;
            cursor: pointer;
            position: relative;
            opacity: 0;
            transform: scale(0.95);
            animation: loadImage 0.4s ease forwards;
        }
        .search-result-item:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
            border: 2px solid var(--accent-neon);
        }
        .search-result-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            border: 4px solid var(--bg-primary);
            border-radius: 12px;
        }
        /* Top Liked Section */
        #top-liked-section {
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        #top-liked-section h3 {
            text-align: center;
            font-size: 1.4rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        #top-liked-grid {
            display: flex;
            gap: 1rem;
            justify-content: center;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            padding-bottom: 1rem;
        }
        .top-liked-item {
            width: calc(16.66% - 0.8rem);
            aspect-ratio: 2/3;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
            scroll-snap-align: start;
        }
        .top-liked-item.top-1 {
            border: 3px solid var(--diamond);
            box-shadow: 0 0 10px var(--diamond);
        }
        .top-liked-item.top-2 {
            border: 3px solid var(--gold);
            box-shadow: 0 0 10px var(--gold);
        }
        .top-liked-item.top-3 {
            border: 3px solid var(--silver);
            box-shadow: 0 0 10px var(--silver);
        }
        .top-liked-item:not(.top-1):not(.top-2):not(.top-3) {
            border: 4px solid var(--bg-primary);
        }
        .top-liked-item:hover {
            transform: scale(1.05);
        }
        .top-liked-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        /* For You Section */
        #for-you-section {
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        #for-you-section h3 {
            text-align: center;
            font-size: 1.4rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        #for-you-grid {
            display: flex;
            gap: 1rem;
            justify-content: center;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            padding-bottom: 1rem;
        }
        .for-you-item {
            width: calc(16.66% - 0.8rem);
            aspect-ratio: 2/3;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
            scroll-snap-align: start;
            border: 4px solid var(--bg-primary);
        }
        .for-you-item:hover {
            transform: scale(1.05);
            border: 2px solid var(--accent-neon);
        }
        .for-you-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        /* Grid */
        #grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1.2rem;
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
            justify-content: center;
        }
        .image-item {
            width: calc(33.33% - 0.8rem);
            aspect-ratio: 2/3;
            max-height: 400px;
            background: var(--bg-secondary);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.4s ease, box-shadow 0.4s ease;
            cursor: pointer;
            position: relative;
            opacity: 0;
            transform: scale(0.95);
            animation: loadImage 0.4s ease forwards;
        }
        .image-item:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
            border: 2px solid var(--accent-neon);
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            border: 4px solid var(--bg-primary);
            border-radius: 12px;
        }
        .reaction-count {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: var(--text-primary);
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .tags {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        @keyframes loadImage {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        /* Modal Full-Screen */
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-primary);
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
        }
        #modal-content {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: linear-gradient(180deg, var(--translucent), var(--bg-primary));
            backdrop-filter: blur(12px);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            opacity: 0;
            transform: translateY(100px);
            animation: slideIn 0.4s ease forwards;
        }
        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        #modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #title {
            font-size: 2.4rem;
            font-weight: 700;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.4);
        }
        #close-modal {
            background: var(--translucent);
            border: none;
            color: var(--text-secondary);
            font-size: 1.8rem;
            cursor: pointer;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        #close-modal:hover {
            color: var(--accent);
            background: var(--bg-primary);
            transform: rotate(90deg);
        }
        #image-container {
            overflow: auto;
            max-width: 100%;
            position: relative;
            max-height: 80vh;
            user-select: none;
        }
        #full-img {
            width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 16px;
            margin: 0 auto;
            background: var(--translucent);
            padding: 0.8rem;
            border: 4px solid var(--bg-primary);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease;
            cursor: zoom-in;
        }
        #full-img.zoomed {
            transform-origin: center;
            cursor: grab;
        }
        #full-img.zoomed.dragging {
            cursor: grabbing;
        }
        #desc {
            font-size: 1.2rem;
            color: var(--text-secondary);
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            background: var(--translucent);
            border: 2px solid var(--accent-neon);
            border-radius: 12px;
            backdrop-filter: blur(8px);
        }
        #reaction-counts-container {
            display: flex;
            justify-content: center;
            gap: 0.8rem;
            font-size: 1.1rem;
            padding: 0.8rem;
            background: var(--translucent);
            border-radius: 12px;
            backdrop-filter: blur(8px);
        }
        #likes {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            font-size: 1.1rem;
            padding: 0.8rem;
            background: var(--translucent);
            border-radius: 12px;
            backdrop-filter: blur(8px);
        }
        #like-btn {
            background: linear-gradient(135deg, var(--accent), var(--accent-neon));
            border: none;
            color: var(--bg-primary);
            padding: 0.5rem 1.2rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        #like-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 12px var(--accent-neon);
        }
        #like-btn.liked {
            background: var(--accent);
            animation: pop 0.3s ease;
        }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .reactions {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--translucent);
            border-radius: 12px;
            padding: 0.5rem;
            box-shadow: var(--shadow);
            gap: 0.5rem;
            animation: slideUp 0.3s ease;
            z-index: 1000;
        }
        .reactions.show {
            display: flex;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(10px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .reaction {
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .reaction:hover {
            transform: scale(1.3);
        }
        #similar-section {
            margin-top: 2rem;
        }
        #similar-section h3 {
            text-align: center;
            font-size: 1.4rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        #similar-grid {
            display: flex;
            gap: 1rem;
            justify-content: center;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            padding-bottom: 1rem;
        }
        .similar-item {
            width: calc(16.66% - 0.8rem);
            aspect-ratio: 2/3;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
            scroll-snap-align: start;
            border: 4px solid var(--bg-primary);
        }
        .similar-item:hover {
            transform: scale(1.05);
            border: 2px solid var(--accent-neon);
        }
        .similar-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        #comments {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        .comment {
            display: flex;
            gap: 0.8rem;
            background: var(--translucent);
            padding: 1rem;
            border-radius: 12px;
            backdrop-filter: blur(8px);
            align-items: flex-start;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeComment 0.4s ease forwards;
        }
        .comment:hover {
            background: rgba(45, 45, 45, 0.95);
            transform: translateY(-2px);
        }
        .reply {
            margin-left: 2rem;
            border-left: 2px solid var(--accent);
            padding-left: 1rem;
        }
        @keyframes fadeComment {
            to {
                opacity: 1;
            }
        }
        .comment-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--accent-neon));
            color: var(--bg-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            transition: opacity 0.3s ease;
        }
        .comment-content {
            flex: 1;
        }
        .comment strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        .comment p {
            margin: 0.2rem 0;
            color: var(--text-secondary);
        }
        .comment small {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .reply-btn {
            background: none;
            border: none;
            color: var(--accent-neon);
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: color 0.3s ease;
        }
        .reply-btn:hover {
            color: var(--accent);
        }
        .reply-form {
            display: none;
            margin-top: 0.5rem;
            background: var(--translucent);
            padding: 1rem;
            border-radius: 8px;
            gap: 0.8rem;
            flex-wrap: wrap;
        }
        .reply-form.show {
            display: flex;
        }
        .reply-input {
            flex: 1;
            min-width: 150px;
            padding: 0.8rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
        }
        .reply-submit {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-neon));
            color: var(--bg-primary);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .reply-submit:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px var(--accent-neon);
        }
        #comment-form {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            background: var(--translucent);
            padding: 1rem;
            border-radius: 12px;
            backdrop-filter: blur(8px);
        }
        #name-input {
            flex: 1;
            min-width: 150px;
            padding: 0.8rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
        }
        #name-input.hidden {
            display: none;
        }
        #comment-input {
            flex: 1;
            min-width: 150px;
            padding: 0.8rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            min-height: 50px;
        }
        #comment-btn {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-neon));
            color: var(--bg-primary);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #comment-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px var(--accent-neon);
        }
        #comment-btn i {
            transition: transform 0.3s ease;
        }
        #comment-btn:hover i {
            transform: rotate(20deg);
        }
        /* Loader */
        #loader {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            display: none;
        }
        /* Error */
        #error-message {
            text-align: center;
            padding: 2rem;
            color: var(--accent);
            display: none;
        }
        /* Footer */
        footer {
            background: var(--translucent);
            padding: 2rem;
            text-align: center;
            color: var(--text-secondary);
            margin-top: 2rem;
            backdrop-filter: blur(12px);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        /* Responsive */
        @media (max-width: 768px) {
            #grid, #search-results {
                gap: 1rem;
            }
            .image-item, .search-result-item {
                width: calc(33.33% - 0.67rem);
                max-height: 350px;
            }
            #modal-content {
                margin: 1rem;
                padding: 1rem;
            }
            #similar-grid, #top-liked-grid, #for-you-grid {
                gap: 0.5rem;
            }
            .similar-item, .top-liked-item, .for-you-item {
                width: calc(33.33% - 0.33rem);
            }
            #comment-form, .reply-form {
                flex-direction: column;
            }
            #name-input, #comment-input, .reply-input {
                min-width: 100%;
            }
            .comment-avatar {
                width: 48px;
                height: 48px;
            }
            .reactions {
                bottom: 110%;
            }
            #user-profile {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
            #user-profile svg {
                width: 20px;
                height: 20px;
            }
            #disclaimer-content {
                margin: 1rem;
            }
            #search-container {
                flex-direction: column;
                gap: 1rem;
            }
            #search {
                max-width: 100%;
            }
        }
        @media (max-width: 480px) {
            #grid, #search-results {
                gap: 0.75rem;
            }
            .image-item, .search-result-item {
                width: calc(33.33% - 0.5rem);
                max-height: 300px;
            }
            #modal-content {
                margin: 0;
                padding: 1rem;
            }
            #full-img {
                max-height: 60vh;
            }
            .similar-item, .top-liked-item, .for-you-item {
                width: calc(33.33% - 0.33rem);
            }
        }
    </style>
</head>
<body>
    <!-- Advertencia +18 -->
    <div id="warning-overlay">
        <h1><i class="fas fa-exclamation-triangle"></i> Contenido +18</h1>
        <p>Esta galería contiene contenido para adultos. Debes tener al menos 18 años para continuar. Si no estás de acuerdo, serás redirigido.</p>
        <button class="warning-btn yes" onclick="acceptWarning()"><i class="fas fa-check"></i> Sí, Soy Mayor de Edad</button>
        <button class="warning-btn" onclick="rejectWarning()"><i class="fas fa-times"></i> No</button>
    </div>

    <!-- Descargo de Responsabilidades -->
    <div id="disclaimer">
        <div id="disclaimer-content">
            <p>Este sitio presenta fan arts y representaciones visuales de personajes existentes y registrados, creados mediante inteligencia artificial. Todo el contenido se comparte sin fines de lucro y con propósitos exclusivamente artísticos y de entretenimiento. No buscamos ofender, apropiarnos ni lucrar con las obras o personajes representados. Los derechos de autor pertenecen a sus respectivos creadores originales. Si ves contenido que te pertenece y deseas que se retire, contáctanos.</p>
            <button id="disclaimer-close">Aceptar</button>
        </div>
    </div>

    <!-- Header -->
    <header>
        <h1>
            <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="#e65100"/>
                <path d="M30 70 L50 30 L70 70" stroke="#000" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="10" fill="#ffab00"/>
            </svg>
            exen-E
        </h1>
        <div id="user-profile"></div>
    </header>

    <div class="section-divider"></div>

    <!-- Búsqueda -->
    <div id="search-container">
        <input type="text" id="search" placeholder="Buscar por título o tags...">
        <button id="search-btn"><i class="fas fa-search"></i> Buscar</button>
    </div>

    <div class="section-divider"></div>

    <!-- Resultados de Búsqueda -->
    <div id="search-results"></div>

    <!-- Top Liked Section -->
    <div id="top-liked-section">
        <h3><i class="fas fa-trophy"></i> Más Gustadas</h3>
        <div id="top-liked-grid"></div>
    </div>

    <div class="section-divider"></div>

    <!-- For You Section -->
    <div id="for-you-section">
        <h3><i class="fas fa-star"></i> Para Ti</h3>
        <div id="for-you-grid"></div>
    </div>

    <div class="section-divider"></div>

    <!-- Galería -->
    <div id="gallery">
        <div id="error-message">Error al cargar imágenes. Verifica tu conexión o la configuración de Firebase.</div>
        <div id="grid"></div>
        <div id="loader"><i class="fas fa-spinner fa-spin"></i> Cargando más imágenes...</div>
    </div>

    <div class="section-divider"></div>

    <!-- Modal Full-Screen -->
    <div id="modal">
        <div id="modal-content">
            <div id="modal-header">
                <h2 id="title"></h2>
                <button id="close-modal"><i class="fas fa-times"></i></button>
            </div>
            <div id="image-container">
                <img id="full-img" src="" alt="" data-zoom="1">
            </div>
            <p id="desc"></p>
            <div id="reaction-counts-container"></div>
            <div id="likes">
                <button id="like-btn">
                    <i class="fas fa-heart"></i>
                    <div class="reactions">
                        <span class="reaction" data-type="hot">🔥</span>
                        <span class="reaction" data-type="like">❤️</span>
                        <span class="reaction" data-type="wow">😯</span>
                        <span class="reaction" data-type="sexy">🫦</span>
                    </div>
                </button>
            </div>
            <div id="similar-section">
                <h3><i class="fas fa-th-large"></i> Imágenes Similares</h3>
                <div id="similar-grid"></div>
            </div>
            <div id="comments"></div>
            <form id="comment-form">
                <input type="text" id="name-input" placeholder="Nombre (opcional)">
                <input type="text" id="comment-input" placeholder="Escribe un comentario...">
                <button type="submit" id="comment-btn"><i class="fas fa-paper-plane"></i> Enviar</button>
            </form>
        </div>
    </div>

    <div class="section-divider"></div>

    <!-- Footer -->
    <footer>
        <span id="disclaimer-link">Ver Descargo de Responsabilidades</span>
        <p>&copy; 2025 exen-E. Diseñado con pasión.</p>
    </footer>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8",
            authDomain: "exene-53e6b.firebaseapp.com",
            databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com",
            projectId: "exene-53e6b",
            storageBucket: "exene-53e6b.appspot.com",
            messagingSenderId: "481369419867",
            appId: "1:481369419867:web:ac5db24c436344262c8f7e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Variables globales
        const imagesPerLoad = 12;
        let allImages = [];
        let displayedImages = [];
        let lastImageKey = null;
        let isLoading = false;
        let currentImageId = '';
        let viewStartTime = null;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;

        // Íconos de perfil (Heroicons)
        const profileIcons = [
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>',
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a5 5 0 0 0-5 5c0 2.76 2.24 5 5 5s5-2.24 5-5a5 5 0 0 0-5-5zm0 12c-4.42 0-8 1.79-8 4v2h16v-2c0-2.21-3.58-4-8-4z"/></svg>',
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08s5.97 1.09 6 3.08c-1.29 1.94-3.5 3.22-6 3.22z"/></svg>',
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 0 0-10 10c0 5.52 4.48 10 10 10s10-4.48 10-10A10 10 0 0 0 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08s5.97 1.09 6 3.08c-1.29 1.94-3.5 3.22-6 3.22z"/></svg>',
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 4c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0 14c-2.03 0-4.43-.82-6.14-2.88C7.55 15.8 9.68 15 12 15s4.45.8 6.14 2.12C16.43 19.18 14.03 20 12 20z"/></svg>',
        ];

        // Advertencia +18
        function acceptWarning() {
            localStorage.setItem('adultConsent', 'true');
            document.getElementById('warning-overlay').style.display = 'none';
            document.body.style.overflow = 'auto';
            showDisclaimer();
            loadInitialImages();
        }

        function rejectWarning() {
            window.location.href = 'https://es.wikipedia.org/wiki/Arte';
        }

        if (!localStorage.getItem('adultConsent')) {
            document.getElementById('warning-overlay').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        } else {
            document.getElementById('warning-overlay').style.display = 'none';
            showDisclaimer();
            loadInitialImages();
        }

        // Descargo de Responsabilidades
        function showDisclaimer() {
            if (!localStorage.getItem('disclaimerShown')) {
                document.getElementById('disclaimer').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        document.getElementById('disclaimer-close').addEventListener('click', () => {
            document.getElementById('disclaimer').style.display = 'none';
            document.body.style.overflow = 'auto';
            localStorage.setItem('disclaimerShown', 'true');
        });

        document.getElementById('disclaimer-link').addEventListener('click', () => {
            document.getElementById('disclaimer').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        });

        // Generar o obtener Device ID y perfil
        let deviceID = localStorage.getItem('deviceID');
        let username = localStorage.getItem('username') || '';
        let profileIcon = localStorage.getItem('profileIcon') || '';
        if (!deviceID) {
            deviceID = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            localStorage.setItem('deviceID', deviceID);
        }
        if (!profileIcon) {
            profileIcon = profileIcons[Math.floor(Math.random() * profileIcons.length)];
            localStorage.setItem('profileIcon', profileIcon);
        }
        updateUserProfile();

        // Actualizar perfil de usuario
        function updateUserProfile() {
            const userProfile = document.getElementById('user-profile');
            if (username) {
                userProfile.innerHTML = `${profileIcon} ${username}`;
                document.getElementById('name-input').classList.add('hidden');
            } else {
                userProfile.innerHTML = `${profileIcon} Anónimo`;
                document.getElementById('name-input').classList.remove('hidden');
            }
        }

        // Función para mostrar error
        function showError(message) {
            console.error('Error:', message);
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Rastrear interacciones del usuario
        function trackUserInteractions(type, data) {
            let interactions = JSON.parse(localStorage.getItem('userInteractions')) || {
                likes: [],
                viewTimes: {},
                searches: [],
                tags: []
            };
            if (type === 'like') {
                if (!interactions.likes.includes(data)) {
                    interactions.likes.push(data);
                }
            } else if (type === 'view') {
                const { imageId, time } = data;
                interactions.viewTimes[imageId] = (interactions.viewTimes[imageId] || 0) + time;
            } else if (type === 'search') {
                interactions.searches.push(data);
            } else if (type === 'tag') {
                if (!interactions.tags.includes(data)) {
                    interactions.tags.push(data);
                }
            }
            localStorage.setItem('userInteractions', JSON.stringify(interactions));
        }

        // Cargar imágenes iniciales
        function loadInitialImages() {
            console.log('Cargando imágenes iniciales...');
            document.getElementById('loader').style.display = 'block';
            db.ref('images').once('value', (snapshot) => {
                document.getElementById('loader').style.display = 'none';
                if (!snapshot.exists()) {
                    showError('No se encontraron imágenes en Firebase. Verifica la ruta "images".');
                    return;
                }
                const images = [];
                snapshot.forEach((child) => {
                    const data = child.val();
                    if (data.url && data.title) {
                        images.push({ id: child.key, ...data });
                        lastImageKey = child.key;
                    }
                });
                if (images.length === 0) {
                    showError('No se encontraron imágenes válidas en Firebase.');
                    return;
                }
                console.log('Imágenes cargadas:', images);
                allImages = images;
                displayedImages = [...images];
                displayImages(displayedImages);
                loadTopLikedImages();
                loadForYouImages();
            }).catch((error) => {
                document.getElementById('loader').style.display = 'none';
                showError('Error al conectar con Firebase: ' + error.message);
            });
        }

        // Cargar imágenes más gustadas
        function loadTopLikedImages() {
            db.ref('reactions').once('value', (snap) => {
                const reactions = snap.val() || {};
                const imageLikes = {};
                Object.entries(reactions).forEach(([imageId, likes]) => {
                    imageLikes[imageId] = Object.keys(likes).length;
                });
                const sortedImages = allImages
                    .map(img => ({
                        ...img,
                        likeCount: imageLikes[img.id] || 0
                    }))
                    .sort((a, b) => b.likeCount - a.likeCount)
                    .slice(0, 6);
                const grid = document.getElementById('top-liked-grid');
                grid.innerHTML = '';
                sortedImages.forEach((img, index) => {
                    const div = document.createElement('div');
                    div.className = `top-liked-item ${index === 0 ? 'top-1' : index === 1 ? 'top-2' : index === 2 ? 'top-3' : ''}`;
                    div.onclick = () => openModal(img.id);
                    div.innerHTML = `<img src="${img.url}" alt="${img.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2NjYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIGltYWdlPC90ZXh0Pjwvc3ZnPg=='">`;
                    grid.appendChild(div);
                });
            }).catch((error) => {
                console.error('Error loading top liked images:', error);
            });
        }

        // Cargar imágenes "Para Ti"
        function loadForYouImages() {
            const interactions = JSON.parse(localStorage.getItem('userInteractions')) || {
                likes: [],
                viewTimes: {},
                searches: [],
                tags: []
            };
            const relevantImages = allImages
                .map(img => {
                    let score = 0;
                    if (interactions.likes.includes(img.id)) score += 10;
                    if (interactions.viewTimes[img.id]) score += interactions.viewTimes[img.id] / 1000;
                    if (img.tags) {
                        img.tags.forEach(tag => {
                            if (interactions.tags.includes(tag)) score += 5;
                            if (interactions.searches.some(s => normalize(s).includes(normalize(tag)))) score += 3;
                        });
                    }
                    return { ...img, score };
                })
                .sort((a, b) => b.score - a.score)
                .slice(0, 6);
            const grid = document.getElementById('for-you-grid');
            grid.innerHTML = '';
            relevantImages.forEach(img => {
                const div = document.createElement('div');
                div.className = 'for-you-item';
                div.onclick = () => openModal(img.id);
                div.innerHTML = `<img src="${img.url}" alt="${img.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2NjYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIGltYWdlPC90ZXh0Pjwvc3ZnPg=='">`;
                grid.appendChild(div);
            });
        }

        // Cargar más imágenes
        function loadMoreImages() {
            if (!lastImageKey || isLoading || allImages.length < imagesPerLoad) return;
            isLoading = true;
            console.log('Cargando más imágenes desde:', lastImageKey);
            document.getElementById('loader').style.display = 'block';
            db.ref('images').orderByKey().startAfter(lastImageKey).limitToFirst(imagesPerLoad).once('value', (snapshot) => {
                const newImages = [];
                snapshot.forEach((child) => {
                    const data = child.val();
                    if (data.url && data.title) {
                        newImages.push({ id: child.key, ...data });
                        lastImageKey = child.key;
                    }
                });
                console.log('Nuevas imágenes cargadas:', newImages);
                if (newImages.length > 0) {
                    allImages = [...allImages, ...newImages];
                    displayedImages = [...displayedImages, ...newImages];
                    displayImages(displayedImages);
                }
                document.getElementById('loader').style.display = 'none';
                isLoading = false;
            }).catch((error) => {
                document.getElementById('loader').style.display = 'none';
                showError('Error al cargar más imágenes: ' + error.message);
                isLoading = false;
            });
        }

        // Debounce para scroll
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200 && document.getElementById('search-results').classList.contains('show') === false) {
                    loadMoreImages();
                }
            }, 100);
        });

        // Normalizar texto para búsqueda
        function normalize(text) {
            return text ? text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase() : '';
        }

        // Búsqueda fuzzy
        function fuzzySearch(query, items) {
            if (!query) return items;
            const normQuery = normalize(query);
            trackUserInteractions('search', query);
            if (items[0].tags) {
                items.forEach(item => item.tags.forEach(tag => trackUserInteractions('tag', tag)));
            }
            return items.filter(item => 
                normalize(item.title).includes(normQuery) ||
                (item.tags && item.tags.some(tag => normalize(tag).includes(normQuery)))
            );
        }

        // Mostrar imágenes en grid principal
        function displayImages(images) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            document.getElementById('error-message').style.display = 'none';
            if (images.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No hay imágenes disponibles.</div>';
                return;
            }
            images.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'image-item';
                div.style.animationDelay = `${index * 0.1}s`;
                div.innerHTML = `
                    <img src="${img.url || ''}" alt="${img.title || ''}" onclick="openModal('${img.id}')" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2NjYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIGltYWdlPC90ZXh0Pjwvc3ZnPg=='">
                    <div class="reaction-count"><i class="fas fa-heart"></i> <span id="reaction-total-${img.id}">0</span></div>
                    <div class="tags">${img.title || ''}</div>
                `;
                grid.appendChild(div);
                // Cargar conteo total de reacciones
                db.ref(`reactions/${img.id}`).once('value', (snap) => {
                    const reactions = snap.val() || {};
                    const total = Object.values(reactions).length;
                    document.getElementById(`reaction-total-${img.id}`).textContent = total;
                }).catch((error) => {
                    console.error(`Error loading reactions for ${img.id}:`, error);
                });
            });
        }

        // Mostrar resultados de búsqueda
        function displaySearchResults(images) {
            const searchResults = document.getElementById('search-results');
            const grid = document.getElementById('grid');
            const topLikedSection = document.getElementById('top-liked-section');
            const forYouSection = document.getElementById('for-you-section');
            searchResults.innerHTML = '';
            document.getElementById('error-message').style.display = 'none';
            if (images.length === 0) {
                searchResults.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No se encontraron resultados.</div>';
                searchResults.classList.add('show');
                grid.style.display = 'none';
                topLikedSection.style.display = 'none';
                forYouSection.style.display = 'none';
                return;
            }
            images.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.style.animationDelay = `${index * 0.1}s`;
                div.innerHTML = `
                    <img src="${img.url || ''}" alt="${img.title || ''}" onclick="openModal('${img.id}')" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2NjYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIGltYWdlPC90ZXh0Pjwvc3ZnPg=='">
                    <div class="reaction-count"><i class="fas fa-heart"></i> <span id="reaction-total-search-${img.id}">0</span></div>
                    <div class="tags">${img.title || ''}</div>
                `;
                searchResults.appendChild(div);
                // Cargar conteo total de reacciones
                db.ref(`reactions/${img.id}`).once('value', (snap) => {
                    const reactions = snap.val() || {};
                    const total = Object.values(reactions).length;
                    document.getElementById(`reaction-total-search-${img.id}`).textContent = total;
                }).catch((error) => {
                    console.error(`Error loading reactions for ${img.id}:`, error);
                });
            });
            searchResults.classList.add('show');
            grid.style.display = 'none';
            topLikedSection.style.display = 'none';
            forYouSection.style.display = 'none';
        }

        // Búsqueda al hacer clic
        document.getElementById('search-btn').addEventListener('click', () => {
            const query = document.getElementById('search').value;
            const filtered = fuzzySearch(query, allImages);
            if (!query) {
                document.getElementById('search-results').classList.remove('show');
                document.getElementById('grid').style.display = 'flex';
                document.getElementById('top-liked-section').style.display = 'block';
                document.getElementById('for-you-section').style.display = 'block';
                displayImages(displayedImages);
            } else {
                displaySearchResults(filtered);
            }
        });

        // Restaurar secciones al limpiar búsqueda
        document.getElementById('search').addEventListener('input', (e) => {
            if (!e.target.value) {
                document.getElementById('search-results').classList.remove('show');
                document.getElementById('grid').style.display = 'flex';
                document.getElementById('top-liked-section').style.display = 'block';
                document.getElementById('for-you-section').style.display = 'block';
                displayImages(displayedImages);
            }
        });

        // Abrir modal
        function openModal(id) {
            const img = allImages.find(i => i.id === id);
            if (!img) return;
            currentImageId = id;
            const fullImg = document.getElementById('full-img');
            fullImg.src = img.url || '';
            document.getElementById('title').textContent = img.title || '';
            document.getElementById('desc').textContent = img.desc || '';
            fullImg.setAttribute('data-zoom', '1');
            fullImg.classList.remove('zoomed');
            fullImg.style.transform = 'none';
            translateX = 0;
            translateY = 0;
            document.querySelector('.reactions').classList.remove('show');
            loadLikes(id);
            loadComments(id);
            loadSimilarImages(img.tags);
            document.getElementById('modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            // Registrar tiempo de visualización
            viewStartTime = Date.now();
            // Desplazar al inicio de la imagen principal
            setTimeout(() => {
                document.getElementById('full-img').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // Cerrar modal
        document.getElementById('close-modal').addEventListener('click', () => {
            document.getElementById('modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.querySelector('.reactions').classList.remove('show');
            // Registrar tiempo de visualización
            if (viewStartTime && currentImageId) {
                const timeSpent = Date.now() - viewStartTime;
                trackUserInteractions('view', { imageId: currentImageId, time: timeSpent });
                loadForYouImages();
            }
        });
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modal')) {
                document.getElementById('modal').style.display = 'none';
                document.body.style.overflow = 'auto';
                document.querySelector('.reactions').classList.remove('show');
                // Registrar tiempo de visualización
                if (viewStartTime && currentImageId) {
                    const timeSpent = Date.now() - viewStartTime;
                    trackUserInteractions('view', { imageId: currentImageId, time: timeSpent });
                    loadForYouImages();
                }
            }
        });

        // Zoom y arrastre en imagen
        const fullImg = document.getElementById('full-img');
        fullImg.addEventListener('click', (e) => {
            if (isDragging) return;
            const zoom = fullImg.getAttribute('data-zoom');
            if (zoom === '1') {
                fullImg.setAttribute('data-zoom', '2');
                fullImg.classList.add('zoomed');
                fullImg.style.transform = `scale(2) translate(${translateX}px, ${translateY}px)`;
            } else {
                fullImg.setAttribute('data-zoom', '1');
                fullImg.classList.remove('zoomed');
                fullImg.style.transform = 'none';
                translateX = 0;
                translateY = 0;
            }
        });

        fullImg.addEventListener('mousedown', (e) => {
            if (fullImg.getAttribute('data-zoom') === '2') {
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                fullImg.classList.add('dragging');
                e.preventDefault();
            }
        });

        fullImg.addEventListener('mousemove', (e) => {
            if (isDragging) {
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                fullImg.style.transform = `scale(2) translate(${translateX}px, ${translateY}px)`;
            }
        });

        fullImg.addEventListener('mouseup', () => {
            isDragging = false;
            fullImg.classList.remove('dragging');
        });

        fullImg.addEventListener('mouseleave', () => {
            isDragging = false;
            fullImg.classList.remove('dragging');
        });

        // Cargar imágenes similares
        function loadSimilarImages(tags) {
            if (!tags || tags.length === 0) {
                document.getElementById('similar-grid').innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay imágenes similares.</p>';
                return;
            }
            let similar = allImages.filter(i => i.id !== currentImageId && i.tags && i.tags.some(t => tags.includes(t)));
            db.ref('reactions').once('value').then(snap => {
                const userLikes = snap.val() || {};
                similar.sort((a, b) => {
                    const aLiked = userLikes[a.id] ? 1 : 0;
                    const bLiked = userLikes[b.id] ? 1 : 0;
                    return bLiked - aLiked;
                });
                similar = similar.slice(0, 6);
                const grid = document.getElementById('similar-grid');
                grid.innerHTML = '';
                similar.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'similar-item';
                    div.onclick = () => openModal(s.id);
                    div.innerHTML = `<img src="${s.url}" alt="${s.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2NjYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIGltYWdlPC90ZXh0Pjwvc3ZnPg=='">`;
                    grid.appendChild(div);
                });
            }).catch((error) => {
                console.error('Error loading similar images:', error);
            });
        }

        // Likes y Reacciones
        function loadLikes(id) {
            db.ref(`reactions/${id}`).once('value', (snap) => {
                const reactions = snap.val() || {};
                const counts = { hot: 0, like: 0, wow: 0, sexy: 0 };
                Object.values(reactions).forEach(type => {
                    if (counts[type] !== undefined) counts[type]++;
                });
                const countsDiv = document.getElementById('reaction-counts-container');
                countsDiv.innerHTML = `
                    🔥 ${counts.hot} ❤️ ${counts.like} 😯 ${counts.wow} 🫦 ${counts.sexy}
                `;
                const btn = document.getElementById('like-btn');
                if (reactions[deviceID]) {
                    btn.classList.add('liked');
                    trackUserInteractions('like', id);
                    const iconMap = {
                        hot: 'fire-alt',
                        like: 'heart',
                        wow: 'surprise',
                        sexy: 'kiss-wink-heart'
                    };
                    btn.querySelector('i').className = `fas fa-${iconMap[reactions[deviceID]]}`;
                } else {
                    btn.classList.remove('liked');
                    btn.querySelector('i').className = 'fas fa-heart';
                }
                loadTopLikedImages();
                loadForYouImages();
            }).catch((error) => {
                console.error('Error loading reactions:', error);
            });
        }

        document.getElementById('like-btn').addEventListener('click', (e) => {
            const reactions = document.querySelector('.reactions');
            reactions.classList.toggle('show');
            e.stopPropagation();
        });

        document.querySelector('.reactions').addEventListener('click', (e) => {
            if (e.target.classList.contains('reaction')) {
                const id = currentImageId;
                if (!id) return;
                const type = e.target.dataset.type;
                const reactionsRef = db.ref(`reactions/${id}/${deviceID}`);
                reactionsRef.once('value').then((snap) => {
                    if (snap.val() === type) {
                        reactionsRef.remove();
                    } else {
                        reactionsRef.set(type);
                    }
                    loadLikes(id);
                    document.querySelector('.reactions').classList.remove('show');
                }).catch((error) => {
                    console.error('Error updating reaction:', error);
                });
            }
        });

        // Cerrar reacciones al hacer clic fuera
        document.addEventListener('click', (e) => {
            const reactions = document.querySelector('.reactions');
            if (!e.target.closest('#like-btn') && !e.target.closest('.reactions')) {
                reactions.classList.remove('show');
            }
        });

        // Comentarios y Respuestas
        function loadComments(id) {
            db.ref(`comments/${id}`).once('value', (snap) => {
                const commentsObj = snap.val() || {};
                const comments = Object.entries(commentsObj).map(([commentId, c]) => ({ id: commentId, ...c }));
                const div = document.getElementById('comments');
                div.innerHTML = comments.map(c => {
                    const initial = c.name ? c.name.charAt(0).toUpperCase() : 'A';
                    const replies = c.replies ? Object.values(c.replies).map(r => {
                        const replyInitial = r.name ? r.name.charAt(0).toUpperCase() : 'A';
                        return `
                            <div class="comment reply">
                                <div class="comment-avatar">${replyInitial}</div>
                                <div class="comment-content">
                                    <strong>${r.name || 'Anónimo'}</strong>
                                    <p>${r.text || ''}</p>
                                    <small>${r.timestamp ? new Date(r.timestamp).toLocaleString() : ''}</small>
                                </div>
                            </div>
                        `;
                    }).join('') : '';
                    return `
                        <div class="comment" id="comment-${c.id}">
                            <div class="comment-avatar">${initial}</div>
                            <div class="comment-content">
                                <strong>${c.name || 'Anónimo'}</strong>
                                <p>${c.text || ''}</p>
                                <small>${c.timestamp ? new Date(c.timestamp).toLocaleString() : ''}</small>
                                <button class="reply-btn" onclick="toggleReplyForm('${c.id}')">Responder</button>
                                <form class="reply-form" id="reply-form-${c.id}">
                                    <input type="text" class="reply-input" id="reply-input-${c.id}" placeholder="Escribe una respuesta...">
                                    <button type="submit" class="reply-submit"><i class="fas fa-paper-plane"></i> Enviar</button>
                                </form>
                            </div>
                        </div>
                        ${replies}
                    `;
                }).join('');
                // Añadir eventos para formularios de respuesta
                comments.forEach(c => {
                    document.getElementById(`reply-form-${c.id}`).addEventListener('submit', (e) => {
                        e.preventDefault();
                        const text = document.getElementById(`reply-input-${c.id}`).value;
                        if (!text.trim()) return;
                        db.ref(`comments/${id}/${c.id}/replies`).push({
                            name: username || 'Anónimo',
                            text,
                            timestamp: Date.now()
                        }).then(() => {
                            document.getElementById(`reply-form-${c.id}`).classList.remove('show');
                            document.getElementById(`reply-input-${c.id}`).value = '';
                            loadComments(id);
                        }).catch((error) => {
                            console.error('Error adding reply:', error);
                        });
                    });
                });
            }).catch((error) => {
                console.error('Error loading comments:', error);
            });
        }

        // Alternar formulario de respuesta
        function toggleReplyForm(commentId) {
            const form = document.getElementById(`reply-form-${commentId}`);
            form.classList.toggle('show');
        }

        // Enviar comentario
        document.getElementById('comment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('name-input');
            const commentInput = document.getElementById('comment-input');
            const text = commentInput.value;
            if (!text.trim()) return;
            if (!username && nameInput.value.trim()) {
                username = nameInput.value.trim();
                localStorage.setItem('username', username);
                updateUserProfile();
            }
            db.ref(`comments/${currentImageId}`).push({
                name: username || 'Anónimo',
                text,
                timestamp: Date.now()
            }).then(() => {
                commentInput.value = '';
                nameInput.value = '';
                loadComments(currentImageId);
            }).catch((error) => {
                console.error('Error adding comment:', error);
            });
        });
    </script>
</body>
</html>