<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Exene</title>
    
    <!-- Librerías Externas (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/viewerjs@1.11.1/dist/viewer.min.css">
    <script src="https://cdn.jsdelivr.net/npm/viewerjs@1.11.1/dist/viewer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Estilos CSS Integrados -->
    <style>
        :root {
            --background: #020617; /* slate-950 */
            --card-bg: #1e293b; /* slate-800 */
            --border-color: #334155; /* slate-700 */
            --primary-text: #f1f5f9; /* slate-100 */
            --secondary-text: #94a3b8; /* slate-400 */
            --accent: #818cf8; /* indigo-400 */
            --accent-dark: #4f46e5; /* indigo-600 */
        }
        html {
            overscroll-behavior: none;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--primary-text);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
            height: 100vh;
            overflow: hidden;
        }
        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #authOverlay {
            background-image: url('https://files.catbox.moe/1zl86j.jpg');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
        }
        .glass-container {
            background: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 1.5rem;
            padding: 2.5rem 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .modal-container {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.8);
            z-index: 70; display: flex; align-items: center; justify-content: center;
            padding: 1rem; opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none;
        }
        .modal-container:not(.hidden) { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: var(--card-bg); padding: 1.5rem; border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); width: 100%; max-width: 26rem;
            transform: translateY(20px) scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease-in-out;
        }
        .modal-container:not(.hidden) .modal-content { transform: translateY(0) scale(1); }
        .notifications-panel {
            position: absolute; top: calc(100% + 0.5rem); right: 0;
            width: 90vw; max-width: 360px; background-color: var(--card-bg);
            border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color); z-index: 50; opacity: 0;
            transform: translateY(-10px) scale(0.95); transform-origin: top right;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
            pointer-events: none; overflow: hidden;
        }
        .notifications-panel.active { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .view {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 5rem; /* Space for nav bar */
        }
        .view:not(.active) { display: none; }
        .view.active { opacity: 1; }
        .view.slide-up { transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
        .view.slide-up.active { transform: translateY(0%); }
        .like-btn.liked i, .favorite-btn.favorited i { font-weight: 900; }
        .like-btn.liked i { color: #ec4899; }
        .favorite-btn.favorited i { color: #facc15; }
        .portrait-aspect {
            position: relative;
            width: 100%;
            padding-bottom: 150%; /* 2:3 aspect ratio */
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        .portrait-aspect img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.3s ease;
        }
        .group:hover .portrait-aspect img { transform: scale(1.05); }
        #toast { transition: opacity 0.3s, transform 0.3s; }
        #toast.show { opacity: 1; transform: translate(-50%, 0); }
        .comment-item {
            display: flex; align-items: flex-start; gap: 0.75rem;
            padding: 0.75rem;
            background-color: rgba(30, 41, 59, 0.5);
            border-radius: 0.75rem;
        }
        .comment-body { background-color: transparent; border-radius: 0; padding: 0; }
        .profile-header {
            padding-bottom: 4.5rem;
            position: relative;
            background-size: cover;
            background-position: center;
        }
        .profile-header::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(to top, var(--background) 10%, rgba(15, 23, 42, 0.5) 50%, rgba(15, 23, 42, 0.2) 100%);
        }
        .profile-avatar-container { margin-top: -4rem; }
        .main-nav {
            background-color: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-color);
        }
        .nav-btn {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--secondary-text); transition: color 0.2s ease-in-out; padding: 0.5rem 0;
        }
        .nav-btn i { font-size: 1.25rem; margin-bottom: 0.125rem; }
        .nav-btn span { font-size: 0.65rem; font-weight: 500; }
        .nav-btn.active { color: var(--accent); }
        .collection-card-name { text-shadow: 1px 1px 5px rgba(0,0,0,0.7); }

        /* Story-like leaderboard */
        #leaderboard-container {
            overflow-x: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        #leaderboard-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        .story-item {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
        }
        .story-avatar-wrapper {
            position: relative;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            padding: 3px;
        }
        .story-avatar-wrapper.rank-1 { background: linear-gradient(45deg, #ffd700, #f0b90b); }
        .story-avatar-wrapper.rank-2 { background: linear-gradient(45deg, #c0c0c0, #a9a9a9); }
        .story-avatar-wrapper.rank-3 { background: linear-gradient(45deg, #cd7f32, #a0522d); }
        .story-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--background);
        }
        .story-trophy {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: var(--card-bg);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border: 1px solid var(--border-color);
        }
        .story-trophy.rank-1 { color: #ffd700; }
        .story-trophy.rank-2 { color: #c0c0c0; }
        .story-trophy.rank-3 { color: #cd7f32; }
        .story-username {
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.25rem;
            color: var(--secondary-text);
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans antialiased">

    <!-- ========== MODAL DE VERIFICACIÓN DE EDAD ========== -->
    <div id="ageVerificationModal" class="modal-container hidden">
        <div class="modal-content text-center">
            <i class="fas fa-exclamation-triangle text-yellow-400 text-4xl mb-4"></i>
            <h2 class="text-2xl font-bold mb-2 text-white">Contenido para Adultos (18+)</h2>
            <p class="text-gray-400 text-sm mb-4">
                Este sitio contiene material explícito para adultos. Debes tener 18 años o más para entrar.
            </p>
            <p class="text-gray-500 text-xs mb-6">
                Exene no se hace responsable por el contenido publicado por los usuarios. Al continuar, confirmas que eres mayor de edad y aceptas nuestros <a href="#" id="ageModalTermsLink" class="underline hover:text-indigo-400">Términos de Servicio</a>.
            </p>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="confirmAgeBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Sí, tengo 18 años o más</button>
                <button id="exitBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Salir</button>
            </div>
        </div>
    </div>

    <!-- ========== PANTALLA DE BIENVENIDA Y BOTONES DE AUTH ========== -->
    <div id="authOverlay" class="fixed inset-0 bg-gray-900 z-50 flex p-4 transition-opacity duration-300">
        <div id="welcomeContainer" class="m-auto text-center">
            <div class="glass-container">
                <img src="https://files.catbox.moe/n86yjv.png" alt="Exene" class="h-16 w-16 mx-auto mb-4 rounded-full object-cover" onerror="this.style.display='none'">
                <h1 class="text-4xl font-bold text-white">Bienvenido a Exene</h1>
                <p class="text-gray-300 mt-2">Únete a la comunidad y comparte tu visión.</p>
                <div class="flex flex-col sm:flex-row gap-4 mt-8 w-full max-w-xs mx-auto">
                    <button id="showLoginModalBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-transform hover:scale-105">Iniciar Sesión</button>
                    <button id="showRegisterModalBtn" class="w-full bg-white/10 hover:bg-white/20 text-white font-bold py-3 px-4 rounded-lg transition-colors">Crear Cuenta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODALES DE AUTH ========== -->
    <div id="loginModal" class="modal-container hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-center text-white">Iniciar Sesión</h2>
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="Correo electrónico" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="loginPassword" placeholder="Contraseña" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Entrar</button>
                 <div class="text-center mt-4">
                    <button type="button" id="showForgotPasswordModalBtn" class="text-sm text-indigo-400 hover:underline">¿Olvidaste tu contraseña?</button>
                </div>
                <button type="button" class="mt-2 w-full text-gray-400 hover:text-white transition-colors py-2 close-modal-btn">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="registerModal" class="modal-container hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-center text-white">Crear Cuenta</h2>
            <form id="registerForm">
                <input type="text" id="registerUsername" placeholder="Elige un nombre de usuario" required maxlength="20" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="email" id="registerEmail" placeholder="Correo electrónico" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="registerPassword" placeholder="Crea una contraseña (mín. 6 caracteres)" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="registerPasswordConfirm" placeholder="Confirmar contraseña" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <p class="text-xs text-gray-500 text-center mb-4">
                    Al registrarte, aceptas nuestros <a href="#" id="registerTermsLink" class="underline hover:text-indigo-400">Términos de Servicio</a> y <a href="#" id="registerPrivacyLink" class="underline hover:text-indigo-400">Política de Privacidad</a>.
                </p>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Registrarse</button>
                <button type="button" class="mt-2 w-full text-gray-400 hover:text-white transition-colors py-2 close-modal-btn">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="forgotPasswordModal" class="modal-container hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-center text-white">Restablecer Contraseña</h2>
            <p class="text-gray-400 text-sm mb-4 text-center">Ingresa tu correo electrónico y te enviaremos un enlace para restablecer tu contraseña.</p>
            <form id="forgotPasswordForm">
                <input type="email" id="forgotPasswordEmail" placeholder="Correo electrónico" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Enviar Correo</button>
                <button type="button" class="mt-2 w-full text-gray-400 hover:text-white transition-colors py-2 close-modal-btn">Cancelar</button>
            </form>
        </div>
    </div>
    
    <!-- ========== CONTENIDO PRINCIPAL DE LA APP ========== -->
    <div id="appContent" class="hidden app-container">
        <!-- MODALES DE LA APP -->
        <div id="avatarModal" class="modal-container hidden">
            <div class="modal-content">
                <h3 class="text-lg font-bold text-white mb-4">Elige tu Avatar</h3>
                <div id="avatarSelection" class="grid grid-cols-4 gap-4"></div>
                <div class="mt-6 border-t border-gray-700 pt-4">
                    <h4 class="text-sm font-medium text-gray-400 mb-2">O pega una URL de imagen</h4>
                    <form id="avatarUrlForm" class="flex items-center gap-2">
                        <input type="url" id="avatarUrlInput" placeholder="https://..." required maxlength="500" class="flex-1 w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Usar</button>
                    </form>
                </div>
                <button class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors close-modal-btn">Cerrar</button>
            </div>
        </div>
        
        <div id="createPostModal" class="modal-container hidden">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4 text-center text-white">Nueva Publicación</h2>
                <form id="createPostForm" class="space-y-4">
                    <div>
                        <label for="postImageUrl" class="block text-sm font-medium text-gray-400 mb-1">URL de la Imagen</label>
                        <input type="url" id="postImageUrl" name="postImageUrl" placeholder="https://..." required maxlength="500" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-2">Sube tus fotos en <a href="https://catbox.moe/" target="_blank" rel="noopener noreferrer" class="text-indigo-400 hover:underline">catbox.moe</a> y pega la URL aquí.</p>
                    </div>
                    <div>
                        <label for="postTitle" class="block text-sm font-medium text-gray-400 mb-1">Título</label>
                        <input type="text" id="postTitle" name="postTitle" placeholder="Un título para tu imagen" required maxlength="80" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="postDescription" class="block text-sm font-medium text-gray-400 mb-1">Descripción (opcional)</label>
                        <textarea id="postDescription" name="postDescription" placeholder="Describe tu imagen... puedes añadir enlaces." rows="3" maxlength="500" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <div>
                        <label for="postTags" class="block text-sm font-medium text-gray-400 mb-1">Etiquetas (separadas por comas)</label>
                        <input type="text" id="postTags" name="postTags" placeholder="ej: arte, paisaje, retrato" maxlength="150" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="!mt-5">
                        <label for="includePromptCheckbox" class="flex items-center space-x-2 cursor-pointer text-sm text-gray-400">
                            <input type="checkbox" id="includePromptCheckbox" name="includePromptCheckbox" class="rounded bg-gray-600 border-gray-500 text-indigo-500 focus:ring-indigo-600">
                            <span>Incluir prompt de IA</span>
                        </label>
                    </div>
                    <div id="promptContainer" class="hidden !mt-3">
                        <label for="postPrompt" class="block text-sm font-medium text-gray-400 mb-1">Prompt de IA (opcional)</label>
                        <textarea id="postPrompt" name="postPrompt" placeholder="El prompt que usaste para generar la imagen..." rows="4" maxlength="1000" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <p class="text-xs text-gray-500 text-center !mt-6">
                        Al publicar, aceptas nuestros <a href="#" id="createPostTermsLink" class="underline hover:text-indigo-400">Términos</a> y <a href="#" id="createPostPrivacyLink" class="underline hover:text-indigo-400">Política de Privacidad</a>.
                    </p>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Publicar</button>
                    <button type="button" class="mt-2 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors close-modal-btn">Cancelar</button>
                </form>
            </div>
        </div>
        
        <div id="adminAddCuratedModal" class="modal-container hidden">
            <div class="modal-content max-w-lg">
                <h2 class="text-xl font-bold mb-4 text-center text-white">Añadir Contenido Oficial (Admin)</h2>
                <form id="adminAddCuratedForm" class="space-y-4">
                    <div>
                        <label for="adminPostUrl" class="block text-sm font-medium text-gray-400 mb-1">URL Imagen</label>
                        <input type="url" id="adminPostUrl" placeholder="https://..." required maxlength="500" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="adminPostTitle" class="block text-sm font-medium text-gray-400 mb-1">Título</label>
                        <input type="text" id="adminPostTitle" placeholder="Título para la imagen" required maxlength="80" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="adminPostDescription" class="block text-sm font-medium text-gray-400 mb-1">Descripción</label>
                        <textarea id="adminPostDescription" placeholder="Descripción de la imagen..." rows="3" maxlength="500" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <div>
                        <label for="adminPostTags" class="block text-sm font-medium text-gray-400 mb-1">Etiquetas (separadas por comas)</label>
                        <input type="text" id="adminPostTags" placeholder="ej: arte, paisaje, retrato" maxlength="150" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Generar JSON</button>
                    <div id="generatedJsonContainer" class="hidden mt-4">
                        <label class="block text-sm font-medium text-gray-400 mb-1">JSON Generado (copia y pega en <code>imagenes.json</code>)</label>
                        <textarea id="generatedJsonOutput" readonly rows="8" class="w-full bg-gray-800 text-gray-300 text-xs font-mono p-2 rounded-md border border-gray-600"></textarea>
                        <button type="button" id="copyJsonBtn" class="mt-2 w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition-colors">Copiar al portapapeles</button>
                    </div>
                    <button type="button" class="mt-2 w-full text-gray-400 hover:text-white transition-colors py-2 close-modal-btn">Cancelar</button>
                </form>
            </div>
        </div>

        <!-- MODAL PARA GUARDAR EN COLECCIÓN -->
        <div id="saveToCollectionModal" class="modal-container hidden">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4 text-white">Guardar en Colección</h2>
                <div id="userCollectionsList" class="space-y-2 max-h-48 overflow-y-auto mb-4 pr-2">
                    <!-- Lista de colecciones del usuario -->
                </div>
                <div class="border-t border-gray-700 pt-4">
                     <h3 class="text-lg font-semibold mb-2 text-white">Crear nueva colección</h3>
                     <form id="newCollectionForm" class="flex items-center gap-2">
                         <input type="text" id="newCollectionName" placeholder="Nombre de la colección" required maxlength="50" class="flex-1 w-full bg-gray-800 text-white border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                         <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-md transition-colors">Crear y Añadir</button>
                     </form>
                </div>
                 <button type="button" class="mt-4 w-full text-gray-400 hover:text-white transition-colors py-2 close-modal-btn">Cancelar</button>
            </div>
        </div>

        <!-- MODALES LEGALES -->
        <div id="termsModal" class="modal-container hidden">
            <div class="modal-content max-w-2xl h-4/5 flex flex-col">
                <h2 class="text-xl font-bold mb-4 text-center text-white">Términos y Condiciones</h2>
                <div class="text-gray-300 text-sm space-y-3 overflow-y-auto pr-2">
                    <p><strong>Última actualización:</strong> 1 de Julio de 2025</p>
                    <p>Bienvenido a Exene. Estos términos y condiciones describen las reglas y regulaciones para el uso del sitio web de Exene.</p>
                    <h3 class="font-bold text-white pt-2">Cuentas y Contenido</h3>
                    <p>Eres responsable de tu cuenta y de todo el contenido que publiques. No se permite contenido ilegal, acoso, spam o cualquier actividad que viole nuestras normas comunitarias. Nos reservamos el derecho de eliminar contenido y suspender cuentas que infrinjan estos términos.</p>
                    <h3 class="font-bold text-white pt-2">Descargo de Responsabilidad</h3>
                    <p>El contenido en Exene es generado por los usuarios. No nos hacemos responsables por el material publicado por terceros. Cada usuario es el único responsable de sus publicaciones.</p>
                </div>
                <button type="button" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors close-modal-btn flex-shrink-0">Cerrar</button>
            </div>
        </div>

        <div id="privacyModal" class="modal-container hidden">
            <div class="modal-content max-w-2xl h-4/5 flex flex-col">
                <h2 class="text-xl font-bold mb-4 text-center text-white">Política de Privacidad</h2>
                <div class="text-gray-300 text-sm space-y-3 overflow-y-auto pr-2">
                     <p><strong>Última actualización:</strong> 1 de Julio de 2025</p>
                     <p>Recopilamos la información que nos proporcionas (correo, nombre de usuario) y datos de tu actividad (publicaciones, likes) para operar y mejorar el servicio. No compartimos tu información personal con terceros, excepto para cumplir con la ley.</p>
                </div>
                <button type="button" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors close-modal-btn flex-shrink-0">Cerrar</button>
            </div>
        </div>

        <!-- MODAL DE CONFIRMACIÓN -->
        <div id="confirmationModal" class="modal-container hidden">
            <div class="modal-content text-center">
                <h2 id="confirmationTitle" class="text-xl font-bold mb-4 text-white">¿Estás seguro?</h2>
                <p id="confirmationMessage" class="text-gray-300 mb-6">Esta acción no se puede deshacer.</p>
                <div class="flex gap-4">
                    <button id="confirmActionBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Confirmar</button>
                    <button id="cancelActionBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Cancelar</button>
                </div>
            </div>
        </div>
        
        <div class="relative flex-1 overflow-hidden">
            <!-- VISTAS PRINCIPALES -->
            <main id="galleryView" class="view active">
                <header class="p-4 flex justify-between items-center bg-slate-950/80 backdrop-blur-sm sticky top-0 z-40">
                    <img src="https://files.catbox.moe/n86yjv.png" alt="Exene" class="h-8 w-8 rounded-full object-cover" onerror="this.style.display='none'">
                    <h1 class="text-lg font-bold text-white">Exene</h1>
                    <div class="flex items-center gap-2">
                        <button id="createPostBtn" class="text-slate-400 hover:text-white text-xl p-2"><i class="fas fa-plus"></i></button>
                        <div class="relative">
                            <button id="navNotificationsBtn" class="text-slate-400 hover:text-white text-xl p-2 relative">
                                <i class="fas fa-bell"></i>
                                <span id="navNotificationsBadge" class="absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-slate-900 hidden"></span>
                            </button>
                            <div id="notificationsWindow" class="notifications-panel">
                                <div class="notifications-panel-header">
                                    <h3 class="text-lg font-bold text-white">Notificaciones</h3>
                                </div>
                                <div id="notificationsList" class="space-y-1 max-h-80 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                </header>
                
                <section id="most-voted-section" class="py-4">
                    <h2 class="px-4 text-sm font-bold uppercase tracking-wider text-slate-400 mb-3">Destacados de la Semana</h2>
                    <div id="leaderboard-container" class="flex gap-4 px-4">
                        <!-- Las historias de los más votados se inyectarán aquí -->
                    </div>
                </section>

                <h2 class="px-4 text-sm font-bold uppercase tracking-wider text-slate-400 mt-4 mb-2">Contenido Oficial</h2>
                <div id="gallery" class="p-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
                <div id="curated-sentinel" class="h-10"></div>
                <div id="galleryLoader" class="text-center p-8 hidden">
                    <i class="fas fa-spinner fa-spin text-3xl text-indigo-400"></i>
                </div>
            </main>

            <main id="feedView" class="view">
                <header class="p-4 flex justify-center items-center bg-slate-950/80 backdrop-blur-sm sticky top-0 z-10">
                    <h1 class="text-lg font-bold text-white">Comunidad</h1>
                </header>
                <div id="feedGrid" class="p-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
                <div id="feed-sentinel" class="h-10"></div>
                 <div id="feedLoader" class="text-center p-8 hidden">
                    <i class="fas fa-spinner fa-spin text-3xl text-indigo-400"></i>
                </div>
            </main>

            <main id="followingView" class="view">
                <header class="p-4 flex justify-center items-center bg-slate-950/80 backdrop-blur-sm sticky top-0 z-10">
                    <h1 class="text-lg font-bold text-white">Siguiendo</h1>
                </header>
                <div id="followingGrid" class="p-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
                <div id="following-sentinel" class="h-10"></div>
                 <div id="followingLoader" class="text-center p-8 hidden">
                    <i class="fas fa-spinner fa-spin text-3xl text-indigo-400"></i>
                </div>
            </main>
            
            <main id="profileView" class="view">
                <!-- El contenido del perfil se genera dinámicamente -->
            </main>
            
            <main id="userProfileView" class="view slide-up">
                <!-- El contenido del perfil de otros usuarios se genera dinámicamente -->
            </main>

            <main id="detailView" class="view slide-up">
                <header class="p-4 flex justify-between items-center bg-slate-950/80 backdrop-blur-sm z-10 flex-shrink-0 sticky top-0">
                    <button id="detailBackBtn" class="text-xl text-slate-400 hover:text-white transition-colors w-10 h-10 flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>
                    <div id="detailAuthorInfo" class="flex items-center gap-3 cursor-pointer group flex-1 justify-center min-w-0">
                        <img id="detailAuthorAvatar" src="" class="w-9 h-9 rounded-full object-cover border-2 border-slate-700 group-hover:border-indigo-500 transition-colors">
                        <div class="flex items-center gap-2">
                          <h3 class="font-bold text-lg text-white group-hover:underline truncate" id="detailAuthorUsername"></h3>
                          <span id="detailAuthorVerifiedBadge"></span>
                        </div>
                    </div>
                    <div class="w-10 flex justify-end">
                        <button id="detailFollowBtn" data-user-id="" class="hidden px-4 py-1.5 text-sm font-bold rounded-full transition-colors"></button>
                    </div>
                </header>
                <main class="flex-1 overflow-y-auto pb-20">
                    <div id="imageViewer" class="bg-black cursor-zoom-in"></div>
                    <div class="p-4 space-y-4">
                        <div><h1 id="detailTitle" class="text-white font-bold text-xl"></h1><p id="detailDescription" class="text-gray-300 mt-1 text-sm leading-relaxed"></p></div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-6 text-2xl text-gray-400">
                                <button id="detailLikeBtn" class="like-btn flex items-center space-x-2 group"><i class="far fa-heart group-hover:text-pink-500 transition-transform transform active:scale-125"></i></button>
                                <button id="focusCommentBtn" class="comment-btn flex items-center space-x-2 group"><i class="far fa-comment group-hover:text-indigo-400 transition-colors"></i></button>
                                <button id="detailFavoriteBtn" class="favorite-btn flex items-center space-x-2 group"><i class="far fa-bookmark group-hover:text-yellow-400 transition-transform transform active:scale-125"></i></button>
                                <button id="saveToCollectionBtn" class="flex items-center space-x-2 group" title="Guardar en Colección"><i class="fa-solid fa-layer-group group-hover:text-green-400 transition-colors"></i></button>
                            </div>
                            <div class="text-sm text-gray-400"><span id="detailLikeCount" class="font-semibold text-white">0 Me gusta</span><span class="text-gray-500 mx-1">•</span><span id="detailViewCount" class="">0 Vistas</span></div>
                        </div>
                        <button id="adminDeletePostBtn" class="hidden w-full bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors"><i class="fas fa-trash-alt mr-2"></i>Eliminar Publicación (Admin)</button>
                        
                        <div id="detailPromptContainer" class="hidden space-y-2 pt-4 border-t border-gray-800/60">
                            <h2 class="font-bold text-white text-base">Prompt de IA</h2>
                            <div class="relative bg-gray-800 rounded-lg p-3">
                                <pre id="detailPromptText" class="text-gray-300 text-sm whitespace-pre-wrap font-sans"></pre>
                                <button id="copyPromptBtn" class="absolute top-2 right-2 text-gray-400 hover:text-white" title="Copiar prompt">
                                    <i class="far fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <section class="p-4 pt-2 border-t border-gray-800/60">
                        <h2 class="font-bold text-white mb-4">Comentarios</h2>
                        <div id="comment-container" class="my-4">
                            <div id="replyingToBanner" class="hidden bg-gray-700 p-2 text-sm flex justify-between items-center rounded-t-md">
                                <span class="text-gray-300">Respondiendo a <strong id="replyingToUsername" class="text-white"></strong></span>
                                <button id="cancelReplyBtn" class="text-xs text-gray-400 hover:text-white font-bold">&times; Cancelar</button>
                            </div>
                            <form id="commentForm" class="bg-gray-800 p-2 flex items-center space-x-2">
                                <img id="commentFormAvatar" src="" class="w-8 h-8 rounded-full object-cover">
                                <input type="text" id="commentText" placeholder="Escribe un comentario..." maxlength="300" class="flex-1 bg-gray-700 text-white rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <button type="submit" class="text-indigo-400 hover:text-indigo-300 text-xl p-2"><i class="fas fa-paper-plane"></i></button>
                            </form>
                        </div>
                        <ul id="commentsList" class="space-y-4"></ul>
                    </section>
                    <section id="similar-section" class="p-4 pt-6 border-t border-gray-800/60 hidden"><h2 class="font-bold text-white mb-4">Imágenes Similares</h2><div id="similar-images-grid" class="grid grid-cols-3 gap-2"></div></section>
                </main>
            </main>

            <main id="searchView" class="view">
                 <header class="p-4 flex justify-center items-center bg-slate-950/80 backdrop-blur-sm sticky top-0 z-10">
                     <form id="searchForm" class="relative w-full max-w-lg">
                         <input type="search" id="searchInput" placeholder="Buscar usuarios, títulos o etiquetas..." class="w-full bg-gray-800 text-white border border-gray-700 rounded-full pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                         <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                     </form>
                 </header>
                 <div class="overflow-y-auto p-4">
                    <p id="searchResultCount" class="text-sm text-gray-400 mb-4 px-2"></p>
                    <div id="searchResultsContainer" class="px-2 space-y-6">
                        <section id="userResultsSection" class="hidden">
                            <h2 class="text-lg font-bold text-white mb-3">Usuarios</h2>
                            <div id="userResults" class="space-y-2"></div>
                        </section>
                        <section id="postResultsSection" class="hidden">
                            <h2 class="text-lg font-bold text-white mb-3">Publicaciones</h2>
                            <div id="postResults" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
                        </section>
                        <div id="noResultsMessage" class="text-center text-gray-500 py-8 hidden">
                            <p>No se encontraron resultados para tu búsqueda.</p>
                        </div>
                    </div>
                </div>
            </main>

            <!-- VISTA DE COLECCIÓN INDIVIDUAL -->
            <main id="collectionView" class="view slide-up">
                <header class="p-4 flex justify-between items-center bg-slate-950/80 backdrop-blur-sm z-10 flex-shrink-0 sticky top-0">
                    <button id="collectionBackBtn" class="text-xl text-slate-400 hover:text-white transition-colors w-10 h-10 flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>
                    <h2 id="collectionNameHeader" class="text-lg font-bold text-white truncate">Colección</h2>
                    <div class="w-10"></div>
                </header>
                <div class="overflow-y-auto pb-20">
                    <div id="collectionImageGrid" class="p-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
                    <div id="no-collection-posts-message" class="text-center text-gray-500 hidden py-8">
                        <p>Esta colección está vacía.</p>
                    </div>
                </div>
            </main>
        </div>
        
        <div id="toast" class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-700 text-white px-4 py-2 rounded-lg shadow-lg z-[100] transition-all duration-300 opacity-0 transform translate-y-4">
            <p id="toastMessage"></p>
        </div>

        <footer class="relative z-50">
            <nav class="main-nav flex justify-around items-center h-16">
                <button data-view="galleryView" class="nav-btn active" aria-label="Inicio">
                    <i class="fas fa-home"></i>
                    <span class="nav-text">Inicio</span>
                </button>
                <button data-view="feedView" class="nav-btn" aria-label="Comunidad">
                    <i class="fas fa-users"></i>
                    <span class="nav-text">Comunidad</span>
                </button>
                <button data-view="searchView" class="nav-btn" aria-label="Buscar">
                    <i class="fas fa-search"></i>
                    <span class="nav-text">Buscar</span>
                </button>
                <button data-view="followingView" class="nav-btn" aria-label="Siguiendo">
                    <i class="fas fa-user-friends"></i>
                    <span class="nav-text">Siguiendo</span>
                </button>
                <button data-view="profileView" id="navProfileBtn" class="nav-btn" aria-label="Mi Perfil">
                    <img id="navProfileAvatar" src="" class="w-8 h-8 rounded-full object-cover border-2 border-transparent transition-colors">
                </button>
            </nav>
        </footer>
    </div>

    <!-- Script Principal Integrado -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            sendPasswordResetEmail, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            onValue, 
            set, 
            push, 
            serverTimestamp, 
            get, 
            query, 
            orderByChild,
            equalTo,
            remove,
            update
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        document.addEventListener('DOMContentLoaded', () => {
            // Configuración de Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8",
                authDomain: "exene-53e6b.firebaseapp.com",
                databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com",
                projectId: "exene-53e6b",
                storageBucket: "exene-53e6b.appspot.com",
                messagingSenderId: "481369419867",
                appId: "1:481369419867:web:ac5db24c436344262c8f7e"
            };

            // Inicialización de Firebase
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            const auth = getAuth(app);
            
            // --- CONSTANTES Y VARIABLES GLOBALES ---
            const USERNAME_MAX_LENGTH = 20;
            const BIO_MAX_LENGTH = 200;
            const INTEREST_LIMIT = 10;
            const POST_TITLE_MAX_LENGTH = 80;
            const POST_DESC_MAX_LENGTH = 500;
            const POST_TAGS_MAX_LENGTH = 150;
            const POST_PROMPT_MAX_LENGTH = 1000;
            const COMMENT_MAX_LENGTH = 300;
            const URL_MAX_LENGTH = 500;
            const SOCIAL_URL_MAX_LENGTH = 255;
            const COLLECTION_NAME_MAX_LENGTH = 50;

            let allImages = [], allPosts = [], sortedCuratedContent = [];
            let loadedCuratedCount = 0, loadedFeedCount = 0, loadedFollowingCount = 0;
            const itemsPerLoad = 12;
            let currentUser = null, currentUserData = {};
            let isCurrentUserAdmin = false;
            let globalAdminUID = null;
            const ADMIN_EMAIL = 'admin@exene.com';
            const ADMIN_USERNAME = 'Exen';
            let usersCache = {};
            let currentViewer = null;
            let lastView = 'galleryView';
            let isGalleryLoading = false, isFeedLoading = false, isFollowingLoading = false;
            let toastTimeout;
            let appInitialized = false;
            let activeDetailListeners = {};

            // Definición de logros
            const ACHIEVEMENTS = {
                'first-post': { icon: 'fa-paper-plane', title: 'Primeros Pasos', description: 'Creaste tu primera publicación.' },
                'popular-post': { icon: 'fa-fire', title: 'En Racha', description: 'Una de tus publicaciones alcanzó 10 Me Gusta.' },
                'five-posts': { icon: 'fa-images', title: 'Creador Constante', description: 'Has creado 5 publicaciones.' },
                'first-comment': { icon: 'fa-comment-dots', title: 'Rompiendo el Hielo', description: 'Escribiste tu primer comentario.' },
                'prolific-commenter': { icon: 'fa-comments', title: 'Socialité', description: 'Has realizado 25 comentarios.' },
                'first-favorite': { icon: 'fa-bookmark', title: 'Digno de Guardar', description: 'Guardaste tu primera imagen en favoritos.' },
                'admin-favorite': { icon: 'fa-star', title: 'Selección del Editor', description: 'Un administrador guardó tu publicación en favoritos.' }
            };

            // --- FUNCIONES AUXILIARES ---
            const showModal = (modalId) => document.getElementById(modalId).classList.remove('hidden');
            const hideModal = (modalId) => document.getElementById(modalId).classList.add('hidden');
            const showLoader = (loaderId, show) => document.getElementById(loaderId).classList.toggle('hidden', !show);
            const showToast = (message) => {
                const toast = document.getElementById('toast');
                if (toastTimeout) clearTimeout(toastTimeout);
                document.getElementById('toastMessage').textContent = message;
                toast.classList.add('show');
                toastTimeout = setTimeout(() => toast.classList.remove('show'), 3000);
            };
             const getFirebaseErrorMessage = (error) => {
                 switch (error.code) {
                     case 'auth/invalid-email': return 'El formato del correo es inválido.';
                     case 'auth/user-not-found': return 'No se encontró ningún usuario con este correo.';
                     case 'auth/wrong-password': return 'Correo o contraseña incorrectos.';
                     case 'auth/email-already-in-use': return 'Este correo ya está registrado.';
                     case 'auth/weak-password': return 'La contraseña debe tener al menos 6 caracteres.';
                     default: console.error(error); return 'Ha ocurrido un error inesperado.';
                 }
            };
            const closeSlideUpView = (viewId, onClosedCallback) => {
                const view = document.getElementById(viewId);
                if (!view) return;
                view.classList.remove('active');
                if (viewId === 'detailView') {
                    detachDetailViewListeners();
                    document.getElementById('detailFollowBtn').classList.add('hidden');
                }
                setTimeout(() => {
                    view.classList.add('hidden');
                    if (onClosedCallback) {
                        onClosedCallback();
                    } else {
                        // Default back action if no callback is provided
                        triggerView(lastView || 'galleryView');
                    }
                }, 350); // Must match CSS transition duration
            };
            const cancelReply = () => {
                const form = document.getElementById('commentForm');
                delete form.dataset.replyToPath;
                delete form.dataset.authorName;
                document.getElementById('replyingToBanner').classList.add('hidden');
                document.getElementById('commentText').placeholder = 'Escribe un comentario...';
            };
            const initiateReply = (commentElement) => {
                const form = document.getElementById('commentForm');
                form.dataset.replyToPath = commentElement.dataset.commentPath;
                form.dataset.authorName = commentElement.dataset.authorName;
                document.getElementById('replyingToUsername').textContent = commentElement.dataset.authorName;
                document.getElementById('replyingToBanner').classList.remove('hidden');
                document.getElementById('commentText').focus();
            };
            const linkify = (text) => {
                if (!text) return '';
                const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
                return text.replace(urlRegex, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-indigo-400 hover:underline">${url}</a>`);
            };
            
            // --- LÓGICA DE DATOS ---
            const detachDetailViewListeners = () => {
                if (activeDetailListeners.likes) activeDetailListeners.likes.unsubscribe();
                if (activeDetailListeners.views) activeDetailListeners.views.unsubscribe();
                if (activeDetailListeners.comments) activeDetailListeners.comments.unsubscribe();
                activeDetailListeners = {};
            };

            const getAuthorData = async (uid) => {
                if (!uid) return { username: 'Anónimo', profile: {} };
                if (usersCache[uid]) return usersCache[uid];
                const snapshot = await get(ref(db, `users/${uid}`));
                if (snapshot.exists()) {
                    usersCache[uid] = snapshot.val();
                    return usersCache[uid];
                }
                return { username: 'Anónimo', profile: {} };
            };

            async function loadCuratedImages() {
                if (!globalAdminUID) {
                    console.error("Error al cargar imágenes curadas: UID de admin no establecido.");
                    return;
                }
                try {
                    const response = await fetch('https://files.catbox.moe/1zzq0n.json');
                    if (!response.ok) throw new Error('Network response was not ok');
                    const images = await response.json();
                    allImages = images.map(img => ({ ...img, isPost: false, authorUid: globalAdminUID }));
                    let allTagsSet = new Set();
                    allImages.forEach(img => (img.tags || []).forEach(tag => allTagsSet.add(tag.trim().toLowerCase())));
                    window.allTags = Array.from(allTagsSet);
                } catch (error) { console.error("Fallo al cargar imagenes.json:", error); showToast("No se pudieron cargar las imágenes oficiales."); }
            }

            function setupPostsListener() {
                const postsRef = query(ref(db, 'posts'), orderByChild('timestamp'));
                onValue(postsRef, snapshot => {
                    const posts = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            posts.push({ ...childSnapshot.val(), id: childSnapshot.key, isPost: true });
                        });
                    }
                    allPosts = posts.reverse();
                    
                    // Re-render any visible post grids when post data changes.
                    if (appInitialized) {
                        const currentVisibleView = document.querySelector('.view.active');
                        if (!currentVisibleView) return;

                        if (currentVisibleView.id === 'feedView') renderUserFeed(true);
                        if (currentVisibleView.id === 'followingView') renderFollowingFeed(true);

                        if (currentVisibleView.id === 'profileView' || currentVisibleView.id === 'userProfileView') {
                            const visibleProfileId = currentVisibleView.dataset.userId;
                            if (visibleProfileId) {
                                const prefix = currentVisibleView.id === 'profileView' ? 'my-profile-' : 'user-profile-';
                                renderUserPosts(visibleProfileId, `${prefix}userPostsGrid`, `${prefix}no-posts-message`);
                            }
                        }
                    }
                });
            }

            function setupUsersListener() {
                const usersRef = ref(db, 'users');
                onValue(usersRef, (snapshot) => {
                    if (snapshot.exists()) {
                        usersCache = snapshot.val();
                    }
                });
            }

            // --- NAVEGACIÓN Y RENDERIZADO ---
            function navigateTo(viewId) {
                document.querySelectorAll('.view').forEach(v => {
                    if (v.id !== viewId) {
                        v.classList.add('hidden');
                        v.classList.remove('active');
                    }
                });

                const targetView = document.getElementById(viewId);
                if (!targetView) return;

                targetView.classList.remove('hidden');
                setTimeout(() => targetView.classList.add('active'), 10);

                if (!targetView.classList.contains('slide-up')) {
                    lastView = viewId;
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.view === viewId);
                    });
                    document.getElementById('navProfileAvatar').closest('.nav-btn').classList.toggle('active', viewId === 'profileView');
                }
            }
            
            function triggerView(viewId) {
                switch(viewId) {
                    case 'galleryView': navigateTo(viewId); break;
                    case 'feedView': renderUserFeed(true); navigateTo(viewId); break;
                    case 'followingView': renderFollowingFeed(true); navigateTo(viewId); break;
                    case 'popularView': renderPopularGallery(); navigateTo(viewId); break;
                    case 'profileView': populateProfileView(currentUser.uid); break; 
                    case 'searchView': 
                        navigateTo(viewId); 
                        document.getElementById('searchInput').focus(); 
                        renderSearchResults(document.getElementById('searchInput').value);
                        break;
                }
            }

            async function appendToImageGrid(container, itemsToRender) {
                for (const item of itemsToRender) {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 rounded-lg overflow-hidden cursor-pointer group portrait-aspect';
                    const imageUrl = item.isPost ? item.imageUrl : item.url;
                    
                    let authorOverlay = '';
                    let adminControls = '';
                    
                    const authorData = await getAuthorData(item.authorUid);
                    const isVerified = item.authorUid === globalAdminUID;

                    authorOverlay = `
                        <div class="card-author-overlay">
                            <img src="${authorData.profile?.avatar || ''}" alt="${authorData.username}" class="bg-gray-700">
                            <span class="text-white text-sm font-semibold truncate">${authorData.username}</span>
                            ${isVerified ? '<i class="fas fa-check-circle text-blue-400 text-sm ml-1"></i>' : ''}
                        </div>
                    `;
                    
                    if (isCurrentUserAdmin && item.isPost) {
                        adminControls = `<button class="admin-delete-btn" data-post-id="${item.id}" title="Eliminar publicación"><i class="fas fa-trash-alt"></i></button>`;
                    }

                    card.innerHTML = `${authorOverlay}${adminControls}<img src="${imageUrl}" alt="${item.title}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/400x600/1f2937/a7a7a7?text=Error';" class="transition-transform duration-300 group-hover:scale-105"><div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div><h3 class="absolute bottom-0 left-0 p-2 text-white font-semibold text-sm truncate w-full">${item.title}</h3>`;
                    
                    card.addEventListener('click', (e) => {
                        if (e.target.closest('.admin-delete-btn')) return;
                        showDetailView(item.id, item.isPost);
                    });
                    
                    container.appendChild(card);
                }
            }

            function sortCuratedFeed() {
                const userInterests = new Set(currentUserData.profile?.interests || []);
                sortedCuratedContent = [...allImages].sort((a, b) => {
                   const scoreA = (a.tags || []).reduce((s, tag) => s + (userInterests.has(tag) ? 5 : 0), 0) + Math.random();
                   const scoreB = (b.tags || []).reduce((s, tag) => s + (userInterests.has(tag) ? 5 : 0), 0) + Math.random();
                   return scoreB - scoreA;
                });
            }

            function renderCuratedFeed(reset = false) {
                if (isGalleryLoading) return;
                isGalleryLoading = true;
                showLoader('galleryLoader', true);
                const galleryContainer = document.getElementById('gallery');
                if (reset) { galleryContainer.innerHTML = ''; loadedCuratedCount = 0; }
                const nextItems = sortedCuratedContent.slice(loadedCuratedCount, loadedCuratedCount + itemsPerLoad);
                if (nextItems.length > 0) {
                    appendToImageGrid(galleryContainer, nextItems);
                    loadedCuratedCount += nextItems.length;
                } else if (reset && sortedCuratedContent.length === 0) {
                    galleryContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 py-8">No hay contenido oficial para mostrar.</p>`;
                }
                showLoader('galleryLoader', false);
                isGalleryLoading = false;
            }

            function renderUserFeed(reset = false) {
                if (isFeedLoading) return;
                isFeedLoading = true;
                showLoader('feedLoader', true);
                const feedContainer = document.getElementById('feedGrid');
                if (reset) { feedContainer.innerHTML = ''; loadedFeedCount = 0; }
                const nextItems = allPosts.slice(loadedFeedCount, loadedFeedCount + itemsPerLoad);
                if (nextItems.length > 0) {
                    appendToImageGrid(feedContainer, nextItems);
                    loadedFeedCount += nextItems.length;
                } else if (reset && allPosts.length === 0) {
                    feedContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 py-8">Aún no hay publicaciones de la comunidad. ¡Sé el primero!</p>`;
                }
                showLoader('feedLoader', false);
                isFeedLoading = false;
            }

            function renderFollowingFeed(reset = false) {
                if (isFollowingLoading) return;
                isFollowingLoading = true;
                showLoader('followingLoader', true);
                const followingContainer = document.getElementById('followingGrid');
                if (reset) { followingContainer.innerHTML = ''; loadedFollowingCount = 0; }
                
                const followingIds = Object.keys(currentUserData.following || {});

                if (followingIds.length === 0) {
                    followingContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 py-8">Aún no sigues a nadie. ¡Explora la comunidad!</p>`;
                    showLoader('followingLoader', false);
                    isFollowingLoading = false;
                    return;
                }

                const postsFromFollowing = allPosts.filter(post => followingIds.includes(post.authorUid));
                
                const nextItems = postsFromFollowing.slice(loadedFollowingCount, loadedFollowingCount + itemsPerLoad);

                if (nextItems.length > 0) {
                    appendToImageGrid(followingContainer, nextItems);
                    loadedFollowingCount += nextItems.length;
                } else if (reset && postsFromFollowing.length === 0) {
                    followingContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 py-8">Las personas que sigues no han publicado nada nuevo.</p>`;
                }
                showLoader('followingLoader', false);
                isFollowingLoading = false;
            }

            // --- EVENT LISTENERS ---
            function setupAuthEventListeners() {
                document.getElementById('showLoginModalBtn').addEventListener('click', () => showModal('loginModal'));
                document.getElementById('showRegisterModalBtn').addEventListener('click', () => showModal('registerModal'));
                document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal-container');
                    if (modal) modal.classList.add('hidden');
                }));
                document.getElementById('showForgotPasswordModalBtn').addEventListener('click', () => { hideModal('loginModal'); showModal('forgotPasswordModal'); });
                
                document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('forgotPasswordEmail').value;
                    try {
                        await sendPasswordResetEmail(auth, email);
                        showToast('Correo de restablecimiento enviado. Revisa tu bandeja de entrada.');
                        hideModal('forgotPasswordModal');
                    } catch (error) { showToast(getFirebaseErrorMessage(error)); }
                });

                document.getElementById('registerForm').addEventListener('submit', async e => {
                    e.preventDefault();
                    const usernameInput = e.target.registerUsername.value.trim();
                    if (usernameInput.length > USERNAME_MAX_LENGTH) return showToast(`El nombre de usuario no puede exceder los ${USERNAME_MAX_LENGTH} caracteres.`);
                    
                    const email = e.target.registerEmail.value.trim();
                    const password = e.target.registerPassword.value;
                    if (password !== e.target.registerPasswordConfirm.value) return showToast("Las contraseñas no coinciden.");
                    
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        
                        let profileData;
                        const defaultAvatar = `https://api.dicebear.com/8.x/bottts-neutral/svg?seed=${encodeURIComponent(usernameInput || 'user')}`;

                        if (email === ADMIN_EMAIL) {
                            profileData = {
                                username: ADMIN_USERNAME,
                                profile: { 
                                    avatar: 'https://files.catbox.moe/n86yjv.png', 
                                    bio: 'Administrador de Exene.', 
                                    interests: [],
                                    profileColor: '#1e40af',
                                    bannerUrl: '',
                                    socials: {},
                                    commentCount: 0,
                                    isAdmin: true
                                }
                            };
                        } else {
                            profileData = {
                                username: usernameInput,
                                profile: { 
                                    avatar: defaultAvatar, 
                                    bio: '', 
                                    interests: [],
                                    profileColor: '#4f46e5',
                                    bannerUrl: '',
                                    socials: {},
                                    commentCount: 0
                                }
                            };
                        }
                        
                        await set(ref(db, `users/${userCredential.user.uid}`), profileData);
                        hideModal('registerModal');
                    } catch (error) { showToast(getFirebaseErrorMessage(error)); }
                });

                document.getElementById('loginForm').addEventListener('submit', async e => {
                    e.preventDefault();
                    try {
                        await signInWithEmailAndPassword(auth, e.target.loginEmail.value, e.target.loginPassword.value);
                        hideModal('loginModal');
                    } catch (error) { showToast(getFirebaseErrorMessage(error)); }
                });
            }

            function setupAppEventListeners() {
                if(document.body.dataset.appListenersAttached === 'true') return;
                
                document.querySelectorAll('.nav-btn[data-view]').forEach(btn => {
                    btn.addEventListener('click', () => triggerView(btn.dataset.view));
                });
                document.getElementById('createPostBtn').addEventListener('click', () => showModal('createPostModal'));
                
                const adminBtn = document.getElementById('adminAddCuratedBtn');
                if(adminBtn) adminBtn.addEventListener('click', () => showModal('adminAddCuratedBtn'));

                document.getElementById('avatarUrlForm').addEventListener('submit', e => {
                    e.preventDefault();
                    const input = document.getElementById('avatarUrlInput');
                    if (input.value) updateAvatar(input.value.trim());
                    input.value = '';
                });

                document.getElementById('includePromptCheckbox').addEventListener('change', (e) => {
                    document.getElementById('promptContainer').classList.toggle('hidden', !e.target.checked);
                });

                const notificationsBtn = document.getElementById('navNotificationsBtn');
                const notificationsPanel = document.getElementById('notificationsWindow');
                notificationsBtn.addEventListener('click', (e) => { e.stopPropagation(); notificationsPanel.classList.toggle('active'); });
                document.addEventListener('click', (e) => {
                    if (!notificationsPanel.contains(e.target) && !notificationsBtn.contains(e.target)) {
                        notificationsPanel.classList.remove('active');
                    }
                });
                new IntersectionObserver(entries => { if (entries[0].isIntersecting && !isGalleryLoading && document.getElementById('galleryView').offsetParent !== null) renderCuratedFeed(false); }, { threshold: 0.1 }).observe(document.getElementById('curated-sentinel'));
                new IntersectionObserver(entries => { if (entries[0].isIntersecting && !isFeedLoading && document.getElementById('feedView').offsetParent !== null) renderUserFeed(false); }, { threshold: 0.1 }).observe(document.getElementById('feed-sentinel'));
                new IntersectionObserver(entries => { if (entries[0].isIntersecting && !isFollowingLoading && document.getElementById('followingView').offsetParent !== null) renderFollowingFeed(false); }, { threshold: 0.1 }).observe(document.getElementById('following-sentinel'));
                
                setupDetailViewEventListeners();
                setupCreatePostForm();
                setupAdminToolListeners();
                setupLegalModalsListeners();
                setupCollectionEventListeners();
                
                document.getElementById('searchForm').addEventListener('submit', e => e.preventDefault());
                document.getElementById('searchInput').addEventListener('input', e => renderSearchResults(e.target.value));
                
                document.body.dataset.appListenersAttached = 'true';
            }
            
            function setupDetailViewEventListeners() {
                document.getElementById('detailBackBtn').addEventListener('click', () => closeSlideUpView('detailView'));
                
                document.getElementById('detailLikeBtn').addEventListener('click', async function() {
                    if (!this.dataset.id || !currentUser) return;
                    const likeRef = ref(db, `likes/${this.dataset.id}/${currentUser.uid}`);
                    const snap = await get(likeRef);
                    set(likeRef, snap.exists() ? null : true);
                });

                document.getElementById('detailFavoriteBtn').addEventListener('click', async function() {
                    if (!this.dataset.id || !currentUser) return;
                    const dbId = this.dataset.id;
                    const favRef = ref(db, `favorites/${currentUser.uid}/${dbId}`);
                    const snap = await get(favRef);

                    if (snap.exists()) {
                        set(favRef, null); // Unfavoriting
                    } else {
                        // Favoriting
                        await set(favRef, true);
                        await set(ref(db, `users/${currentUser.uid}/profile/achievements/first-favorite`), true);
                        if (isCurrentUserAdmin) {
                            const item = [...allPosts, ...allImages].find(i => String(i.id) === String(dbId));
                            if (item && item.authorUid !== currentUser.uid) {
                                await set(ref(db, `users/${item.authorUid}/profile/achievements/admin-favorite`), true);
                                const notificationRef = push(ref(db, `notifications/${item.authorUid}`));
                                await set(notificationRef, {
                                    message: `¡A ${currentUserData.username} le ha encantado tu publicación! Has ganado un logro.`,
                                    imageId: item.id,
                                    timestamp: serverTimestamp(),
                                    read: false
                                });
                            }
                        }
                    }
                });

                document.getElementById('commentForm').addEventListener('submit', handleCommentSubmit);
                document.getElementById('focusCommentBtn').addEventListener('click', () => document.getElementById('commentText').focus());
                document.getElementById('cancelReplyBtn').addEventListener('click', cancelReply);
                document.getElementById('adminDeletePostBtn').addEventListener('click', function() {
                    handleDeletePost(this.dataset.postId);
                });
                document.getElementById('saveToCollectionBtn').addEventListener('click', function() {
                    if (this.dataset.id) {
                        openCollectionModal(this.dataset.id, this.dataset.isPost === 'true');
                    }
                });
            }
            
            function setupCreatePostForm() {
                document.getElementById('createPostForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const imageUrl = document.getElementById('postImageUrl').value.trim();
                    const title = document.getElementById('postTitle').value.trim();
                    const description = document.getElementById('postDescription').value.trim();
                    const tagsInput = document.getElementById('postTags').value.trim();
                    
                    const includePrompt = document.getElementById('includePromptCheckbox').checked;
                    const prompt = document.getElementById('postPrompt').value.trim();

                    if (!imageUrl || !title) return showToast("La URL y el título son obligatorios.");
                    if (imageUrl.length > URL_MAX_LENGTH) return showToast(`La URL de la imagen no puede exceder los ${URL_MAX_LENGTH} caracteres.`);
                    if (title.length > POST_TITLE_MAX_LENGTH) return showToast(`El título no puede exceder los ${POST_TITLE_MAX_LENGTH} caracteres.`);
                    if (description.length > POST_DESC_MAX_LENGTH) return showToast(`La descripción no puede exceder los ${POST_DESC_MAX_LENGTH} caracteres.`);
                    if (tagsInput.length > POST_TAGS_MAX_LENGTH) return showToast(`Las etiquetas no pueden exceder los ${POST_TAGS_MAX_LENGTH} caracteres.`);
                    if (prompt.length > POST_PROMPT_MAX_LENGTH) return showToast(`El prompt no puede exceder los ${POST_PROMPT_MAX_LENGTH} caracteres.`);

                    const tags = tagsInput.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag !== '');
                    
                    const newPostRef = push(ref(db, 'posts'));
                    try {
                        const newPostData = {
                            id: newPostRef.key, imageUrl, title, description, tags,
                            authorUid: currentUser.uid,
                            timestamp: serverTimestamp()
                        };

                        if (includePrompt && prompt) {
                            newPostData.prompt = prompt;
                        }

                        await set(newPostRef, newPostData);
                        
                        await set(ref(db, `users/${currentUser.uid}/profile/achievements/first-post`), true);

                        const userPostsQuery = query(ref(db, 'posts'), orderByChild('authorUid'), equalTo(currentUser.uid));
                        const userPostsSnapshot = await get(userPostsQuery);
                        if (userPostsSnapshot.exists() && Object.keys(userPostsSnapshot.val()).length >= 5) {
                            await set(ref(db, `users/${currentUser.uid}/profile/achievements/five-posts`), true);
                        }

                        document.getElementById('createPostForm').reset();
                        document.getElementById('promptContainer').classList.add('hidden'); // Ocultar campo de prompt
                        hideModal('createPostModal');
                        showToast("Publicación creada con éxito");
                        triggerView('feedView');
                    } catch (error) { console.error("Error creando post:", error); showToast("No se pudo crear la publicación."); }
                });
            }

            // --- VISTAS DETALLADAS Y LÓGICA DE VISUALIZACIÓN ---
            async function showDetailView(id, isPost = false) {
                detachDetailViewListeners();
                navigateTo('detailView');
                document.querySelector('#detailView > main').scrollTop = 0;
                const item = isPost ? allPosts.find(p => String(p.id) === String(id)) : allImages.find(i => String(i.id) === String(id));
                if (!item) { showToast('Contenido no encontrado.'); closeSlideUpView('detailView'); return; };
                
                const dbId = String(item.id);
                const authorData = await getAuthorData(item.authorUid);
                const isVerified = item.authorUid === globalAdminUID;
                
                const detailFollowBtn = document.getElementById('detailFollowBtn');
                if (item.isPost && item.authorUid !== currentUser.uid) {
                    detailFollowBtn.classList.remove('hidden');
                    detailFollowBtn.dataset.userId = item.authorUid;
                    updateDetailFollowButton(item.authorUid);
                    detailFollowBtn.onclick = () => toggleFollow(item.authorUid);
                } else {
                    detailFollowBtn.classList.add('hidden');
                    detailFollowBtn.onclick = null;
                }

                document.getElementById('detailAuthorUsername').textContent = authorData.username;
                document.getElementById('detailAuthorAvatar').src = authorData.profile?.avatar || `https://api.dicebear.com/8.x/initials/svg?seed=${authorData.username}`;
                document.getElementById('detailAuthorVerifiedBadge').innerHTML = isVerified ? '<i class="fas fa-check-circle text-blue-400"></i>' : '';
                
                document.getElementById('detailAuthorInfo').onclick = () => {
                    const targetUserId = item.authorUid;
                    closeSlideUpView('detailView', () => {
                        if (targetUserId === currentUser.uid) {
                            triggerView('profileView');
                        } else {
                            populateProfileView(targetUserId);
                        }
                    });
                };
                
                document.getElementById('detailTitle').textContent = item.title;
                
                const descriptionEl = document.getElementById('detailDescription');
                descriptionEl.innerHTML = linkify(item.description);
                
                const promptContainer = document.getElementById('detailPromptContainer');
                if (item.prompt) {
                    promptContainer.classList.remove('hidden');
                    const promptTextEl = document.getElementById('detailPromptText');
                    promptTextEl.textContent = item.prompt;
                    document.getElementById('copyPromptBtn').onclick = () => {
                        const textArea = document.createElement("textarea");
                        textArea.value = promptTextEl.textContent;
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            showToast('Prompt copiado al portapapeles');
                        } catch (err) {
                            console.error('Error al copiar:', err);
                            showToast('No se pudo copiar el prompt.');
                        }
                        document.body.removeChild(textArea);
                    };
                } else {
                    promptContainer.classList.add('hidden');
                }

                if (currentViewer) currentViewer.destroy();
                const imageViewer = document.getElementById('imageViewer');
                imageViewer.innerHTML = `<img src="${item.isPost ? item.imageUrl : item.url}" alt="${item.title}" onerror="this.parentElement.innerHTML='<p class=\\'p-4 text-red-400\\'>Error al cargar imagen.</p>';">`;
                currentViewer = new Viewer(imageViewer, { navbar: false, toolbar: false, button: true, title: false });
                
                document.getElementById('detailLikeBtn').dataset.id = dbId;
                document.getElementById('detailFavoriteBtn').dataset.id = dbId;
                document.getElementById('saveToCollectionBtn').dataset.id = dbId;
                document.getElementById('saveToCollectionBtn').dataset.isPost = isPost;
                document.getElementById('commentForm').dataset.imageId = dbId;
                delete document.getElementById('commentForm').dataset.replyToPath;
                
                const adminDeleteBtn = document.getElementById('adminDeletePostBtn');
                if (isCurrentUserAdmin && isPost) {
                    adminDeleteBtn.classList.remove('hidden');
                    adminDeleteBtn.dataset.postId = dbId;
                } else {
                    adminDeleteBtn.classList.add('hidden');
                }

                listenToLikesAndViews(dbId, item.authorUid);
                listenToComments(dbId);
                if (!isPost) renderSimilarImages(item);
                else document.getElementById('similar-section').classList.add('hidden');
                
                set(ref(db, `views/${dbId}/${currentUser.uid}`), true);
            }
            
            async function populateProfileView(userId) {
                const isOwnProfile = userId === currentUser.uid;
                const viewId = isOwnProfile ? 'profileView' : 'userProfileView';
                const viewContainer = document.getElementById(viewId);
                const prefix = isOwnProfile ? 'my-profile-' : 'user-profile-';
                
                navigateTo(viewId);
                viewContainer.dataset.userId = userId;

                const userData = await getAuthorData(userId);
                const profile = userData.profile || {};
                const accentColor = profile.profileColor || '#4f46e5';
                const bannerStyle = profile.bannerUrl 
                    ? `background-image: url('${profile.bannerUrl}')` 
                    : `background-color: ${accentColor}`;

                viewContainer.innerHTML = `
                    <header class="p-4 flex justify-between items-center bg-slate-950/80 backdrop-blur-sm sticky top-0 z-10">
                        ${isOwnProfile ? '<div class="w-10"></div>' : `<button id="${prefix}backBtn" class="text-xl text-slate-400 hover:text-white transition-colors w-10 h-10 flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>`}
                        <h2 class="text-lg font-bold text-white mx-auto">${isOwnProfile ? 'Mi Perfil' : `Perfil de ${userData.username}`}</h2>
                        ${isOwnProfile ? `<button id="${prefix}logoutBtn" class="text-slate-400 hover:text-white transition-colors w-10 text-xl" title="Cerrar sesión"><i class="fas fa-sign-out-alt"></i></button>` : '<div class="w-10"></div>'}
                    </header>
                    <div class="overflow-y-auto pb-20">
                        <div class="profile-header" style="${bannerStyle}"></div>
                        <div class="p-4">
                            <div class="profile-avatar-container flex flex-col items-center space-y-2">
                                <div class="relative">
                                    <img src="${profile.avatar || ''}" alt="Avatar" class="w-24 h-24 rounded-full border-4 object-cover bg-gray-700" style="border-color: ${accentColor};">
                                    ${isOwnProfile ? `<button id="${prefix}changeAvatarBtn" class="absolute bottom-0 right-0 bg-gray-700 hover:bg-gray-600 text-white w-8 h-8 rounded-full flex items-center justify-center border-2 border-gray-900"><i class="fas fa-pen text-xs"></i></button>` : ''}
                                </div>
                                <div class="text-center">
                                    <h3 class="text-2xl font-bold text-white">${userData.username}</h3>
                                    <div class="flex justify-center items-center gap-4 mt-2 text-sm text-gray-400">
                                        <span id="${prefix}followerCount"><strong>0</strong> Seguidores</span>
                                        <span id="${prefix}followingCount"><strong>0</strong> Siguiendo</span>
                                    </div>
                                </div>
                                <p class="text-gray-400 text-center text-sm max-w-md pt-2">${profile.bio || 'Sin biografía.'}</p>
                                <div id="${prefix}profileSocials" class="flex items-center gap-4 text-xl mt-2"></div>
                                ${!isOwnProfile ? `<button id="${prefix}followBtn" data-user-id="${userId}" class="mt-4 px-6 py-2 text-sm font-bold rounded-full transition-colors"></button>` : ''}
                            </div>
                            <div class="mt-6 bg-gray-800/50 p-4 rounded-lg shadow-md">
                                <h4 class="text-sm font-bold text-gray-400 mb-3 text-center uppercase tracking-wider">Logros</h4>
                                <div id="${prefix}profileAchievements" class="flex flex-wrap justify-center gap-3"></div>
                            </div>
                            <div class="mt-6 border-b border-gray-700">
                                <nav class="profile-tabs-container -mb-px flex" aria-label="Tabs">
                                    <button data-tab="posts" class="profile-tab tab-active" style="border-color: ${accentColor}; color: white;">Publicaciones</button>
                                    <button data-tab="collections" class="profile-tab">Colecciones</button>
                                    <button data-tab="favorites" class="profile-tab">Favoritos</button>
                                    ${isOwnProfile ? '<button data-tab="settings" class="profile-tab">Ajustes</button>' : ''}
                                </nav>
                            </div>
                            <div data-content="posts" class="profile-tab-content mt-4"><div id="${prefix}userPostsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div><p id="${prefix}no-posts-message" class="text-center text-gray-500 hidden py-8">No hay publicaciones.</p></div>
                            <div data-content="collections" class="profile-tab-content mt-4 hidden"><div id="${prefix}collectionsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div><p id="${prefix}no-collections-message" class="text-center text-gray-500 hidden py-8">No hay colecciones.</p></div>
                            <div data-content="favorites" class="profile-tab-content mt-4 hidden"><div id="${prefix}favoritesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div><p id="${prefix}no-favorites-message" class="text-center text-gray-500 hidden py-8">No ha guardado ninguna imagen.</p></div>
                            ${isOwnProfile ? `
                            <div data-content="settings" class="profile-tab-content mt-4 hidden space-y-6">
                                <div><h4 class="text-lg font-bold text-white mb-2">Personalización</h4><label for="profileBannerUrl" class="block text-sm font-medium text-gray-400 mb-1">URL del Banner de Perfil</label><input type="url" id="profileBannerUrl" value="${profile.bannerUrl || ''}" placeholder="https://..." maxlength="${URL_MAX_LENGTH}" class="w-full bg-gray-800 text-white rounded-md p-2 border border-gray-700 focus:ring-indigo-500 focus:border-indigo-500"><label for="profileColorPicker" class="block text-sm font-medium text-gray-400 mt-3 mb-1">Color de Acento</label><input type="color" id="profileColorPicker" value="${accentColor}" class="w-full h-10 p-1 bg-gray-800 border border-gray-700 rounded-md cursor-pointer"></div>
                                <div><h4 class="text-lg font-bold text-white mb-2">Redes Sociales</h4><div class="space-y-3"><div><label for="socialTwitter" class="block text-sm font-medium text-gray-400 mb-1">Twitter (URL)</label><input type="url" id="socialTwitter" value="${profile.socials?.twitter || ''}" placeholder="https://twitter.com/usuario" maxlength="${SOCIAL_URL_MAX_LENGTH}" class="w-full bg-gray-800 text-white rounded-md p-2 border border-gray-700"></div><div><label for="socialInstagram" class="block text-sm font-medium text-gray-400 mb-1">Instagram (URL)</label><input type="url" id="socialInstagram" value="${profile.socials?.instagram || ''}" placeholder="https://instagram.com/usuario" maxlength="${SOCIAL_URL_MAX_LENGTH}" class="w-full bg-gray-800 text-white rounded-md p-2 border border-gray-700"></div><div><label for="socialWebsite" class="block text-sm font-medium text-gray-400 mb-1">Sitio Web (URL)</label><input type="url" id="socialWebsite" value="${profile.socials?.website || ''}" placeholder="https://mi-pagina.com" maxlength="${SOCIAL_URL_MAX_LENGTH}" class="w-full bg-gray-800 text-white rounded-md p-2 border border-gray-700"></div></div></div>
                                <div><h4 class="text-lg font-bold text-white mb-2">Intereses</h4><div class="flex justify-between items-center mb-2"><p class="text-sm font-medium text-gray-400">Tus intereses</p><p id="interestCounter" class="text-sm text-gray-500">0/10</p></div><div class="relative mb-2"><input id="interestSearchInput" type="search" placeholder="Buscar intereses..." class="w-full bg-gray-800 text-white rounded-full pl-10 pr-4 py-2 border border-gray-700"><i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i></div><div id="profileInterests" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto"></div></div>
                                <div><h4 class="text-lg font-bold text-white mb-2">Biografía</h4><textarea id="profileBioInput" rows="3" maxlength="${BIO_MAX_LENGTH}" class="w-full bg-gray-800 text-white rounded-md p-2 border border-gray-700" placeholder="Describe algo sobre ti...">${profile.bio || ''}</textarea></div>
                                <button id="saveProfileBtn" class="w-full text-white font-bold py-3 px-4 rounded-md transition-colors mt-4" style="background-color: ${accentColor};">Guardar Cambios</button>
                            </div>` : ''}
                        </div>
                    </div>
                `;
                
                updateFollowCounts(userId, prefix);
                renderUserPosts(userId, `${prefix}userPostsGrid`, `${prefix}no-posts-message`);
                renderUserCollections(userId, prefix);
                renderPublicFavorites(userId, `${prefix}favoritesGrid`, `${prefix}no-favorites-message`);
                renderSocials(profile.socials, `${prefix}profileSocials`);
                checkAndRenderAchievements(userId, `${prefix}profileAchievements`);

                if (isOwnProfile) {
                    renderProfileInterests();
                    document.getElementById(`${prefix}logoutBtn`).addEventListener('click', () => signOut(auth));
                    document.getElementById(`${prefix}changeAvatarBtn`).addEventListener('click', () => showModal('avatarModal'));
                    document.getElementById('saveProfileBtn').addEventListener('click', saveProfileChanges);
                    document.getElementById('interestSearchInput').addEventListener('input', e => {
                        const query = e.target.value.toLowerCase();
                        document.querySelectorAll('#profileInterests button').forEach(btn => {
                            btn.style.display = btn.textContent.toLowerCase().includes(query) ? '' : 'none';
                        });
                    });
                } else {
                    document.getElementById(`${prefix}backBtn`).addEventListener('click', () => closeSlideUpView(viewId));
                    const followBtn = document.getElementById(`${prefix}followBtn`);
                    followBtn.addEventListener('click', () => toggleFollow(userId));
                    updateFollowButton(userId, prefix);
                }

                viewContainer.querySelectorAll('.profile-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const activeTab = e.currentTarget;
                        viewContainer.querySelectorAll('.profile-tab').forEach(item => {
                            item.classList.remove('tab-active');
                            item.style.borderColor = 'transparent';
                            item.style.color = '#9ca3af';
                        });
                        activeTab.classList.add('tab-active');
                        activeTab.style.borderColor = accentColor;
                        activeTab.style.color = 'white';
                        viewContainer.querySelectorAll('.profile-tab-content').forEach(content => {
                            content.classList.toggle('hidden', content.dataset.content !== activeTab.dataset.tab);
                        });
                    });
                });
            }

            async function showUserProfile(userId) {
                await populateProfileView(userId);
            }

            function listenToLikesAndViews(id, authorUid) {
                const likesRef = ref(db, `likes/${id}`);
                const viewsRef = ref(db, `views/${id}`);
                
                const likesUnsubscribe = onValue(likesRef, snap => {
                    const data = snap.val() || {};
                    const likeCount = Object.keys(data).length;
                    
                    const likeCountEl = document.getElementById('detailLikeCount');
                    if (likeCountEl) likeCountEl.textContent = `${likeCount} Me gusta`;
                    
                    const detailLikeBtn = document.getElementById('detailLikeBtn');
                    if(detailLikeBtn) detailLikeBtn.classList.toggle('liked', !!(currentUser && data[currentUser.uid]));

                    if (likeCount >= 10) {
                        set(ref(db, `users/${authorUid}/profile/achievements/popular-post`), true);
                    }
                });
                
                const viewsUnsubscribe = onValue(viewsRef, snap => {
                    const viewCountEl = document.getElementById('detailViewCount');
                    if (viewCountEl) viewCountEl.textContent = `${Object.keys(snap.val() || {}).length} Vistas`;
                });
                
                activeDetailListeners.likes = { unsubscribe: likesUnsubscribe };
                activeDetailListeners.views = { unsubscribe: viewsUnsubscribe };
            }
            
            async function listenToComments(imageId) {
                const commentsQuery = query(ref(db, `comments/${imageId}`), orderByChild('timestamp'));
                
                const commentsUnsubscribe = onValue(commentsQuery, async (snapshot) => {
                    const list = document.getElementById('commentsList');
                    if (!list) return;
                    list.innerHTML = '';
                    if (!snapshot.exists()) {
                        list.innerHTML = `<p class="text-gray-500 text-center text-sm py-4">Sé el primero en comentar.</p>`;
                        return;
                    }
                    
                    const commentPromises = [];
                    snapshot.forEach(parentCommentSnapshot => {
                        commentPromises.push(createCommentElement(parentCommentSnapshot, imageId));
                    });

                    const commentElements = await Promise.all(commentPromises);
                    commentElements.sort((a,b) => b.dataset.timestamp - a.dataset.timestamp).forEach(el => list.appendChild(el));
                });
                
                activeDetailListeners.comments = { unsubscribe: commentsUnsubscribe };
            }
            
            async function createCommentElement(commentSnapshot, imageId) {
                const commentData = { id: commentSnapshot.key, ...commentSnapshot.val() };
                const path = `comments/${imageId}/${commentData.id}`;
                const li = document.createElement('li');
                li.className = 'comment-item';
                li.dataset.commentPath = path;
                li.dataset.authorName = commentData.username;
                li.dataset.timestamp = commentData.timestamp;

                const author = await getAuthorData(commentData.authorUid);
                const isVerified = author.profile?.isAdmin;

                const adminDeleteButton = isCurrentUserAdmin ? `<button class="admin-delete-comment-btn" title="Eliminar comentario"><i class="fas fa-trash-alt"></i></button>` : '';
                
                const replyingToHTML = commentData.replyToUsername 
                    ? `<p class="replying-to-text">Respondiendo a <strong>@${commentData.replyToUsername}</strong></p>`
                    : '';

                li.innerHTML = `
                    <img src="${commentData.userAvatar || ''}" class="w-8 h-8 rounded-full flex-shrink-0 object-cover bg-gray-700 cursor-pointer" data-userid="${commentData.authorUid}">
                    <div class="comment-content">
                        <div class="comment-body">
                            <span class="font-bold text-sm text-white cursor-pointer hover:underline flex items-center gap-2" data-userid="${commentData.authorUid}">${commentData.username}${isVerified ? '<i class="fas fa-check-circle text-blue-400 text-xs ml-1"></i>' : ''}</span>
                            ${replyingToHTML}
                            <p class="text-gray-300 mt-1 break-words">${linkify(commentData.text)}</p>
                        </div>
                        <div class="comment-actions">
                            <button class="hover:underline reply-btn">Responder</button>
                            ${adminDeleteButton}
                        </div>
                    </div>`;

                if (commentSnapshot.hasChild('replies')) {
                    const repliesContainer = document.createElement('div');
                    repliesContainer.className = 'replies-container';
                    const replyPromises = [];
                    commentSnapshot.child('replies').forEach(replySnapshot => {
                        replyPromises.push(createCommentElement(replySnapshot, imageId));
                    });
                    const replyElements = await Promise.all(replyPromises);
                    replyElements.sort((a,b) => a.dataset.timestamp - b.dataset.timestamp).forEach(el => repliesContainer.appendChild(el));
                    li.querySelector('.comment-content').appendChild(repliesContainer);
                }
                
                li.querySelector('.reply-btn').addEventListener('click', e => initiateReply(e.currentTarget.closest('li')));
                
                const adminBtn = li.querySelector('.admin-delete-comment-btn');
                if (adminBtn) adminBtn.addEventListener('click', (e) => { e.stopPropagation(); handleDeleteComment(path); });

                li.querySelectorAll('[data-userid]').forEach(el => {
                    el.addEventListener('click', e => {
                        e.stopPropagation();
                        const targetUserId = el.dataset.userid;
                        const activeSlideUp = document.querySelector('.view.slide-up.active');
                        if (activeSlideUp) {
                            closeSlideUpView(activeSlideUp.id, () => {
                                if (targetUserId === currentUser.uid) {
                                    triggerView('profileView');
                                } else {
                                    populateProfileView(targetUserId);
                                }
                            });
                        }
                    });
                });

                return li;
            }
            
            async function handleCommentSubmit(e) {
                e.preventDefault();
                const textInput = document.getElementById('commentText');
                const text = textInput.value.trim();
                const imageId = document.getElementById('commentForm').dataset.imageId;
                
                if (!text || !imageId) return;
                if (text.length > COMMENT_MAX_LENGTH) return showToast(`El comentario no puede exceder los ${COMMENT_MAX_LENGTH} caracteres.`);
                
                const replyToPath = document.getElementById('commentForm').dataset.replyToPath;
                const replyingToUsername = document.getElementById('commentForm').dataset.authorName;
                
                const commentData = { 
                    text, 
                    timestamp: serverTimestamp(), 
                    username: currentUserData.username, 
                    authorUid: currentUser.uid, 
                    userAvatar: currentUserData.profile.avatar 
                };

                if (replyToPath && replyingToUsername) {
                    commentData.replyToUsername = replyingToUsername;
                }

                try {
                    const refPath = replyToPath ? `${replyToPath}/replies` : `comments/${imageId}`;
                    await set(push(ref(db, refPath)), commentData);

                    // --- START NOTIFICATION LOGIC ---
                    let recipientUid;
                    let message;
                    const post = allPosts.find(p => p.id === imageId);

                    if (replyToPath) {
                        // It's a reply
                        const parentCommentSnapshot = await get(ref(db, replyToPath));
                        if(parentCommentSnapshot.exists()) {
                            recipientUid = parentCommentSnapshot.val().authorUid;
                            message = `${currentUserData.username} respondió a tu comentario.`;
                        }
                    } else if (post) {
                        // It's a top-level comment
                        recipientUid = post.authorUid;
                        message = `${currentUserData.username} comentó en tu publicación: "${post.title}"`;
                    }
                    
                    if (recipientUid && recipientUid !== currentUser.uid) {
                        const notificationRef = push(ref(db, `notifications/${recipientUid}`));
                        await set(notificationRef, {
                            message,
                            imageId,
                            timestamp: serverTimestamp(),
                            read: false
                        });
                    }
                    // --- END NOTIFICATION LOGIC ---

                    const userRef = ref(db, `users/${currentUser.uid}/profile`);
                    const newCount = (currentUserData.profile.commentCount || 0) + 1;
                    
                    const updates = {};
                    updates.commentCount = newCount;
                    if (!currentUserData.profile?.achievements?.['first-comment']) {
                        updates['achievements/first-comment'] = true;
                    }
                    if (newCount >= 25) {
                        updates['achievements/prolific-commenter'] = true;
                    }
                    await update(userRef, updates);

                    cancelReply();
                    textInput.value = '';
                } catch (error) { console.error(error); showToast("No se pudo enviar el comentario."); }
            }
            
            function listenToNotifications() {
                if (!currentUser) return;
                const notificationsRef = ref(db, `notifications/${currentUser.uid}`);
                onValue(notificationsRef, snapshot => {
                    const list = document.getElementById('notificationsList');
                    const badge = document.getElementById('navNotificationsBadge');
                    const panel = document.getElementById('notificationsWindow');
                    list.innerHTML = '';
                    if(!snapshot.exists()) {
                        badge.classList.add('hidden');
                        return list.innerHTML = `<p class="p-4 text-center text-gray-500">No tienes notificaciones.</p>`;
                    }
                    const notifications = Object.entries(snapshot.val()).map(([id, data]) => ({id, ...data}));
                    badge.classList.toggle('hidden', notifications.filter(n => !n.read).length === 0);
                    notifications.reverse().forEach(n => {
                        const el = document.createElement('div');
                        el.className = `px-4 py-3 hover:bg-gray-700 cursor-pointer ${n.read ? 'opacity-60' : 'font-semibold'}`;
                        el.innerHTML = `<p>${n.message || 'Nueva notificación'}</p><p class="text-xs text-gray-500 mt-1 font-normal">${new Date(n.timestamp).toLocaleString()}</p>`;
                        el.onclick = () => {
                            panel.classList.remove('active');
                            const isPost = allPosts.some(p => p.id === n.imageId);
                            showDetailView(n.imageId, isPost);
                            set(ref(db, `notifications/${currentUser.uid}/${n.id}/read`), true);
                        };
                        list.appendChild(el);
                    });
                });
            }

            // --- FUNCIONES DE PERFIL Y BÚSQUEDA ---
            function renderUserPosts(userId, gridId, messageId) {
                const container = document.getElementById(gridId);
                const message = document.getElementById(messageId);
                if(!container || !message) return;
                container.innerHTML = '';
                const userPosts = allPosts.filter(p => p.authorUid === userId);
                message.classList.toggle('hidden', userPosts.length > 0);
                if(userPosts.length > 0) appendToImageGrid(container, userPosts); 
            }
            
            function renderPublicFavorites(userId, gridId, messageId) {
                listenToUserFavorites(userId, (favoriteItems) => {
                    const container = document.getElementById(gridId);
                    const message = document.getElementById(messageId);
                    if(!container || !message) return;
                    container.innerHTML = '';
                    message.classList.toggle('hidden', favoriteItems.length > 0);
                    if(favoriteItems.length > 0) appendToImageGrid(container, favoriteItems.reverse());
                });
            }
            
            function listenToUserFavorites(userId, callback) {
                if(!userId) return;
                onValue(ref(db, `favorites/${userId}`), snap => {
                    const favoriteIds = Object.keys(snap.val() || {});
                    const favoriteItems = [...allImages, ...allPosts].filter(item => favoriteIds.includes(String(item.id)));
                    if(callback) callback(favoriteItems);
                });
            }

            async function updateAvatar(url) {
                if (url.length > URL_MAX_LENGTH) return showToast(`La URL del avatar no puede exceder los ${URL_MAX_LENGTH} caracteres.`);
                try {
                    const validUrl = /^(https?:\/\/[^\s$.?#].[^\s]*)$/i.test(url);
                    if (!validUrl) throw new Error("URL no válida");
                    
                    await update(ref(db, `users/${currentUser.uid}/profile`), { avatar: url });
                    currentUserData.profile.avatar = url;
                    updateAllAvatars(url);
                    hideModal('avatarModal');
                    showToast("Avatar actualizado");
                } catch (error) { showToast("La URL de la imagen no parece ser válida."); }
            }
            
            function updateAllAvatars(url) {
                const profileAvatarInView = document.querySelector('#profileView img[alt="Avatar"], #userProfileView img[alt="Avatar"]');
                if (profileAvatarInView) profileAvatarInView.src = url;
                document.getElementById('navProfileAvatar').src = url;
                document.getElementById('commentFormAvatar').src = url;
            }
            
            function renderSearchResults(query) {
                query = query.toLowerCase().trim();
                const postResultsContainer = document.getElementById('postResults');
                const userResultsContainer = document.getElementById('userResults');
                const countEl = document.getElementById('searchResultCount');
                const userSection = document.getElementById('userResultsSection');
                const postSection = document.getElementById('postResultsSection');
                const noResultsMsg = document.getElementById('noResultsMessage');

                postResultsContainer.innerHTML = '';
                userResultsContainer.innerHTML = '';

                if (!query) {
                    countEl.textContent = '';
                    userSection.classList.add('hidden');
                    postSection.classList.add('hidden');
                    noResultsMsg.classList.add('hidden');
                    return;
                }

                const postResults = [...allImages, ...allPosts].filter(item => {
                    const titleMatch = item.title.toLowerCase().includes(query);
                    const tagMatch = (item.tags || []).some(tag => tag.toLowerCase().includes(query));
                    return titleMatch || tagMatch;
                });

                const userResults = Object.entries(usersCache)
                    .map(([uid, data]) => ({ uid, ...data }))
                    .filter(user => user.username.toLowerCase().includes(query));

                const totalResults = postResults.length + userResults.length;
                countEl.textContent = `${totalResults} resultado(s) encontrado(s).`;

                if (userResults.length > 0) {
                    userSection.classList.remove('hidden');
                    userResults.forEach(user => {
                        const userCard = document.createElement('div');
                        userCard.className = 'flex items-center p-2 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors';
                        userCard.innerHTML = `
                            <img src="${user.profile?.avatar || ''}" alt="${user.username}" class="w-10 h-10 rounded-full object-cover mr-3 bg-gray-700">
                            <span class="font-semibold text-white">${user.username}</span>
                            <i class="fas fa-chevron-right text-gray-500 ml-auto"></i>
                        `;
                        userCard.addEventListener('click', () => showUserProfile(user.uid));
                        userResultsContainer.appendChild(userCard);
                    });
                } else {
                    userSection.classList.add('hidden');
                }

                if (postResults.length > 0) {
                    postSection.classList.remove('hidden');
                    appendToImageGrid(postResultsContainer, postResults);
                } else {
                    postSection.classList.add('hidden');
                }

                noResultsMsg.classList.toggle('hidden', totalResults > 0);
            }

            function renderProfileInterests() {
                const container = document.getElementById('profileInterests');
                const counterEl = document.getElementById('interestCounter');
                if(!container || !counterEl) return;

                container.innerHTML = '';
                const userInterests = new Set(currentUserData.profile?.interests || []);
                (window.allTags || []).forEach(tag => {
                    const isSelected = userInterests.has(tag);
                    const tagEl = document.createElement('button');
                    tagEl.textContent = tag;
                    tagEl.dataset.tag = tag;
                    tagEl.className = `px-3 py-1 text-sm rounded-full cursor-pointer transition-colors ${isSelected ? 'bg-indigo-600 text-white' : 'bg-gray-700 text-gray-300'}`;
                    tagEl.addEventListener('click', () => {
                        const selectedCount = container.querySelectorAll('.bg-indigo-600').length;
                        if (!tagEl.classList.contains('bg-indigo-600') && selectedCount >= INTEREST_LIMIT) {
                            showToast(`Puedes elegir hasta ${INTEREST_LIMIT} intereses.`);
                            return;
                        }
                        tagEl.classList.toggle('bg-indigo-600');
                        tagEl.classList.toggle('text-white');
                        tagEl.classList.toggle('bg-gray-700');
                        tagEl.classList.toggle('text-gray-300');
                        updateInterestCounter();
                    });
                    container.appendChild(tagEl);
                });
                updateInterestCounter();
            }
            
            function updateInterestCounter() {
                const container = document.getElementById('profileInterests');
                const counterEl = document.getElementById('interestCounter');
                if(!container || !counterEl) return;
                const count = container.querySelectorAll('.bg-indigo-600').length;
                counterEl.textContent = `${count}/${INTEREST_LIMIT}`;
                counterEl.classList.toggle('text-red-500', count >= INTEREST_LIMIT);
            }

            function renderSocials(socials, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                if (!socials) return;

                const socialMap = {
                    twitter: { icon: 'fab fa-twitter', color: 'text-blue-400' },
                    instagram: { icon: 'fab fa-instagram', color: 'text-pink-500' },
                    website: { icon: 'fas fa-globe', color: 'text-gray-400' }
                };

                for (const [key, url] of Object.entries(socials)) {
                    if (url && socialMap[key]) {
                        const link = document.createElement('a');
                        link.href = url;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.className = `social-icon-link hover:${socialMap[key].color}`;
                        link.innerHTML = `<i class="${socialMap[key].icon}"></i>`;
                        container.appendChild(link);
                    }
                }
            }

            async function checkAndRenderAchievements(userId, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const userAchievementsSnapshot = await get(ref(db, `users/${userId}/profile/achievements`));
                const userAchievements = userAchievementsSnapshot.val() || {};
                
                let earnedAchievements = [];
                for (const key in userAchievements) {
                    if (userAchievements[key] && ACHIEVEMENTS[key]) {
                        earnedAchievements.push(ACHIEVEMENTS[key]);
                    }
                }
                
                container.innerHTML = '';
                if (earnedAchievements.length > 0) {
                    earnedAchievements.forEach(ach => {
                        const badge = document.createElement('div');
                        badge.className = 'achievement-badge';
                        badge.title = ach.description;
                        badge.innerHTML = `<i class="fas ${ach.icon}"></i> <span>${ach.title}</span>`;
                        container.appendChild(badge);
                    });
                } else {
                    container.innerHTML = `<p class="text-gray-500 text-xs">No hay logros aún.</p>`;
                }
            }

            async function saveProfileChanges() {
                const bio = document.getElementById('profileBioInput').value;
                const bannerUrl = document.getElementById('profileBannerUrl').value.trim();
                const socials = {
                    twitter: document.getElementById('socialTwitter').value.trim(),
                    instagram: document.getElementById('socialInstagram').value.trim(),
                    website: document.getElementById('socialWebsite').value.trim()
                };

                if (bio.length > BIO_MAX_LENGTH) return showToast(`La biografía no puede exceder los ${BIO_MAX_LENGTH} caracteres.`);
                if (bannerUrl.length > URL_MAX_LENGTH) return showToast(`La URL del banner no puede exceder los ${URL_MAX_LENGTH} caracteres.`);
                if (socials.twitter.length > SOCIAL_URL_MAX_LENGTH) return showToast(`La URL de Twitter no puede exceder los ${SOCIAL_URL_MAX_LENGTH} caracteres.`);
                if (socials.instagram.length > SOCIAL_URL_MAX_LENGTH) return showToast(`La URL de Instagram no puede exceder los ${SOCIAL_URL_MAX_LENGTH} caracteres.`);
                if (socials.website.length > SOCIAL_URL_MAX_LENGTH) return showToast(`La URL del sitio web no puede exceder los ${SOCIAL_URL_MAX_LENGTH} caracteres.`);

                const interests = Array.from(document.querySelectorAll('#profileInterests .bg-indigo-600')).map(el => el.dataset.tag);
                const profileColor = document.getElementById('profileColorPicker').value;
                
                try {
                    const profileUpdates = { bio, interests, profileColor, bannerUrl, socials };
                    await update(ref(db, `users/${currentUser.uid}/profile`), profileUpdates);
                    
                    currentUserData.profile = { ...currentUserData.profile, ...profileUpdates };
                    
                    showToast('Perfil guardado');
                    populateProfileView(currentUser.uid);
                } catch (error) { 
                    console.error("Error al guardar el perfil:", error); 
                    showToast("Error al guardar el perfil."); 
                }
            }
            
            async function renderPopularGallery() {
                const container = document.getElementById('popularGallery');
                container.innerHTML = `<div class="col-span-full text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-indigo-400"></i></div>`;
                
                const likesSnapshot = await get(ref(db, 'likes'));
                const allLikes = likesSnapshot.val() || {};

                const combinedContent = [...allImages, ...allPosts];
                const popularContent = combinedContent
                    .map(item => ({ ...item, score: allLikes[item.id] ? Object.keys(allLikes[item.id]).length : 0 }))
                    .sort((a, b) => b.score - a.score);
                
                container.innerHTML = '';
                appendToImageGrid(container, popularContent.slice(0, 24));
            }
            
            function renderSimilarImages(currentImage) {
                const section = document.getElementById('similar-section');
                const container = document.getElementById('similar-images-grid');
                container.innerHTML = '';
                const currentTags = new Set(currentImage.tags || []);
                if (currentTags.size === 0) { section.classList.add('hidden'); return; }
                const similarImages = allImages
                    .filter(img => String(img.id) !== String(currentImage.id))
                    .map(img => ({ ...img, score: (img.tags || []).filter(tag => currentTags.has(tag)).length }))
                    .filter(img => img.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 6);
                if (similarImages.length > 0) {
                    section.classList.remove('hidden');
                    appendToImageGrid(container, similarImages);
                } else {
                    section.classList.add('hidden');
                }
            }

            function renderMostVotedSection() {
                const likesRef = ref(db, 'likes');
                onValue(likesRef, async (snapshot) => {
                    const allLikes = snapshot.val() || {};
                    const container = document.getElementById('leaderboard-container');
                    container.innerHTML = '';

                    if (!allPosts || allPosts.length === 0) {
                         container.innerHTML = `<p class="text-center text-slate-500 text-sm px-4">Aún no hay publicaciones para mostrar.</p>`;
                         return;
                    }

                    const rankedPosts = allPosts
                        .map(post => ({
                            ...post,
                            likeCount: allLikes[post.id] ? Object.keys(allLikes[post.id]).length : 0
                        }))
                        .sort((a, b) => b.likeCount - a.likeCount);

                    const uniquePosts = [];
                    const seenImageUrls = new Set();
                    for (const post of rankedPosts) {
                        if (!seenImageUrls.has(post.imageUrl)) {
                            uniquePosts.push(post);
                            seenImageUrls.add(post.imageUrl);
                        }
                    }

                    const topPosts = uniquePosts.slice(0, 10);

                    if (topPosts.length === 0 || topPosts[0].likeCount === 0) {
                        container.innerHTML = `<p class="text-center text-slate-500 text-sm px-4">Aún no hay publicaciones populares. ¡Vota por tus favoritas!</p>`;
                        return;
                    }

                    for (let i = 0; i < topPosts.length; i++) {
                        const post = topPosts[i];
                        const rank = i + 1;
                        const authorInfo = await getAuthorData(post.authorUid);

                        const item = document.createElement('div');
                        item.className = 'story-item cursor-pointer';
                        item.innerHTML = `
                            <div class="story-avatar-wrapper rank-${rank}">
                                <img src="${post.imageUrl}" class="story-avatar" onerror="this.src='https://placehold.co/64x64/1e293b/94a3b8?text=??'"/>
                                <div class="story-trophy rank-${rank}"><i class="fas fa-trophy"></i></div>
                            </div>
                            <span class="story-username">${authorInfo.username}</span>
                        `;
                        item.addEventListener('click', () => showDetailView(post.id, true));
                        container.appendChild(item);
                    }
                });
            }

            // --- LÓGICA DE SEGUIMIENTO (FOLLOW) ---
            async function toggleFollow(userIdToFollow) {
                const followingUserRef = ref(db, `users/${currentUser.uid}/following/${userIdToFollow}`);
                const followedUserFollowerRef = ref(db, `followers/${userIdToFollow}/${currentUser.uid}`);
                
                const isCurrentlyFollowing = !!(currentUserData.following && currentUserData.following[userIdToFollow]);

                try {
                    if (isCurrentlyFollowing) {
                        // Unfollow
                        await remove(followingUserRef);
                        await remove(followedUserFollowerRef);
                        if (currentUserData.following) {
                            delete currentUserData.following[userIdToFollow];
                        }
                    } else {
                        // Follow
                        await set(followingUserRef, true);
                        await set(followedUserFollowerRef, true);
                        if (!currentUserData.following) {
                            currentUserData.following = {};
                        }
                        currentUserData.following[userIdToFollow] = true;
                    }

                    const prefix = document.getElementById('userProfileView').dataset.userId === userIdToFollow ? 'user-profile-' : 'my-profile-';
                    updateFollowButton(userIdToFollow, prefix);
                    updateDetailFollowButton(userIdToFollow);
                    updateFollowCounts(userIdToFollow, prefix);
                } catch (error) {
                    console.error("Error toggling follow:", error);
                    showToast("No se pudo realizar la acción.");
                }
            }

            function updateFollowButton(userId, prefix) {
                const followBtn = document.getElementById(`${prefix}followBtn`);
                if (!followBtn || followBtn.dataset.userId !== userId) return;

                const isFollowing = !!(currentUserData.following && currentUserData.following[userId]);

                if (isFollowing) {
                    followBtn.textContent = 'Siguiendo';
                    followBtn.className = 'mt-4 px-6 py-2 text-sm font-bold rounded-full transition-colors bg-gray-700 text-white hover:bg-gray-600';
                } else {
                    followBtn.textContent = 'Seguir';
                    followBtn.className = 'mt-4 px-6 py-2 text-sm font-bold rounded-full transition-colors bg-indigo-600 text-white hover:bg-indigo-500';
                }
            }
            
            function updateDetailFollowButton(userId) {
                const followBtn = document.getElementById('detailFollowBtn');
                if (!followBtn || followBtn.dataset.userId !== userId) return;

                const isFollowing = !!(currentUserData.following && currentUserData.following[userId]);
                
                const baseClasses = 'px-4 py-1.5 text-sm font-bold rounded-full transition-colors';
                if (isFollowing) {
                    followBtn.textContent = 'Siguiendo';
                    followBtn.className = `${baseClasses} bg-gray-700 text-white hover:bg-gray-600`;
                } else {
                    followBtn.textContent = 'Seguir';
                    followBtn.className = `${baseClasses} bg-indigo-600 text-white hover:bg-indigo-500`;
                }
                followBtn.classList.remove('hidden');
            }


            function updateFollowCounts(userId, prefix) {
                const followersRef = ref(db, `followers/${userId}`);
                const followingRef = ref(db, `users/${userId}/following`);

                onValue(followersRef, (snap) => {
                    const count = snap.exists() ? Object.keys(snap.val()).length : 0;
                    const el = document.getElementById(`${prefix}followerCount`);
                    if(el) el.innerHTML = `<strong>${count}</strong> Seguidores`;
                });
                onValue(followingRef, (snap) => {
                    const count = snap.exists() ? Object.keys(snap.val()).length : 0;
                    const el = document.getElementById(`${prefix}followingCount`);
                    if(el) el.innerHTML = `<strong>${count}</strong> Siguiendo`;
                });
            }

            // --- LÓGICA DE COLECCIONES ---
            function setupCollectionEventListeners() {
                document.getElementById('collectionBackBtn').addEventListener('click', () => closeSlideUpView('collectionView'));
            }

            async function openCollectionModal(postId, isPost) {
                const modal = document.getElementById('saveToCollectionModal');
                const listContainer = modal.querySelector('#userCollectionsList');
                const form = modal.querySelector('#newCollectionForm');

                listContainer.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin text-indigo-400"></i></div>`;
                showModal('saveToCollectionModal');

                const collectionsRef = ref(db, `collections/${currentUser.uid}`);
                const snapshot = await get(collectionsRef);
                const collections = snapshot.val() || {};

                listContainer.innerHTML = '';
                if (Object.keys(collections).length === 0) {
                    listContainer.innerHTML = `<p class="text-center text-gray-500 text-sm">No tienes colecciones.</p>`;
                } else {
                    for (const [id, data] of Object.entries(collections)) {
                        const item = document.createElement('button');
                        item.className = 'w-full text-left p-2 rounded-md hover:bg-gray-700 transition-colors';
                        item.textContent = data.name;
                        item.onclick = () => addPostToCollection(postId, isPost, id);
                        listContainer.appendChild(item);
                    }
                }

                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const nameInput = document.getElementById('newCollectionName');
                    const name = nameInput.value.trim();
                    if (!name) return;
                    if (name.length > COLLECTION_NAME_MAX_LENGTH) {
                        return showToast(`El nombre no puede exceder los ${COLLECTION_NAME_MAX_LENGTH} caracteres.`);
                    }

                    const newCollectionRef = push(collectionsRef);
                    await set(newCollectionRef, {
                        name: name,
                        createdAt: serverTimestamp(),
                        owner: currentUser.uid
                    });
                    
                    await addPostToCollection(postId, isPost, newCollectionRef.key);
                    nameInput.value = '';
                };
            }

            async function addPostToCollection(postId, isPost, collectionId) {
                const item = (isPost ? allPosts : allImages).find(p => String(p.id) === String(postId));
                if (!item) return showToast("Error: no se encontró la imagen.");

                const collectionPostRef = ref(db, `collection_posts/${collectionId}/${postId}`);
                await set(collectionPostRef, true);
                
                const collectionRef = ref(db, `collections/${currentUser.uid}/${collectionId}`);
                await update(collectionRef, { coverImageUrl: isPost ? item.imageUrl : item.url });

                hideModal('saveToCollectionModal');
                showToast("Guardado en la colección.");
            }

            function renderUserCollections(userId, prefix) {
                const container = document.getElementById(`${prefix}collectionsGrid`);
                const message = document.getElementById(`${prefix}no-collections-message`);
                if (!container || !message) return;

                const collectionsRef = ref(db, `collections/${userId}`);
                onValue(collectionsRef, (snapshot) => {
                    container.innerHTML = '';
                    const collections = snapshot.val() || {};
                    const collectionEntries = Object.entries(collections);

                    message.classList.toggle('hidden', collectionEntries.length > 0);

                    if (collectionEntries.length > 0) {
                        collectionEntries.forEach(([id, data]) => {
                            const card = document.createElement('div');
                            card.className = 'collection-card';
                            
                            const coverImg = data.coverImageUrl 
                                ? `<img src="${data.coverImageUrl}" class="collection-card-bg" onerror="this.style.display='none'">`
                                : '';

                            card.innerHTML = `
                                ${coverImg}
                                <div class="collection-card-overlay">
                                    <span class="collection-card-name">${data.name}</span>
                                </div>
                            `;
                            card.addEventListener('click', () => showCollectionView(id, data.name));
                            container.appendChild(card);
                        });
                    }
                });
            }

            async function showCollectionView(collectionId, collectionName) {
                navigateTo('collectionView');
                const view = document.getElementById('collectionView');
                const grid = view.querySelector('#collectionImageGrid');
                const message = view.querySelector('#no-collection-posts-message');
                const header = view.querySelector('#collectionNameHeader');

                header.textContent = collectionName;
                grid.innerHTML = `<div class="col-span-full text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-indigo-400"></i></div>`;
                message.classList.add('hidden');

                const postsRef = ref(db, `collection_posts/${collectionId}`);
                const snapshot = await get(postsRef);
                const postIds = Object.keys(snapshot.val() || {});

                grid.innerHTML = '';
                if (postIds.length === 0) {
                    message.classList.remove('hidden');
                    return;
                }

                const itemsInCollection = [...allPosts, ...allImages].filter(item => postIds.includes(String(item.id)));
                appendToImageGrid(grid, itemsInCollection.reverse());
            }

            // --- LÓGICA DE ADVERTENCIAS Y LEGALES ---
            function setupLegalModalsListeners() {
                const links = [
                    { id: 'ageModalTermsLink', modal: 'termsModal' },
                    { id: 'registerTermsLink', modal: 'termsModal' },
                    { id: 'registerPrivacyLink', modal: 'privacyModal' },
                    { id: 'createPostTermsLink', modal: 'termsModal' },
                    { id: 'createPostPrivacyLink', modal: 'privacyModal' },
                ];
                links.forEach(link => {
                    document.getElementById(link.id).addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showModal(link.modal);
                    });
                });
            }

            function handleAgeVerification() {
                if (localStorage.getItem('ageVerified') === 'true') {
                    return true;
                }

                showModal('ageVerificationModal');

                document.getElementById('confirmAgeBtn').addEventListener('click', () => {
                    localStorage.setItem('ageVerified', 'true');
                    hideModal('ageVerificationModal');
                    onAuthStateChanged(auth, authStateObserver);
                });

                document.getElementById('exitBtn').addEventListener('click', () => {
                    document.body.innerHTML = `<div class="w-screen h-screen bg-gray-900 flex items-center justify-center text-white text-xl p-4 text-center">Debes ser mayor de edad para acceder a este sitio.</div>`;
                    document.body.className = 'bg-gray-900';
                });
                return false;
            }

            // --- LÓGICA DE ADMINISTRACIÓN ---
            function setupAdminToolListeners() {
                const form = document.getElementById('adminAddCuratedForm');
                if(!form) return;
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const url = document.getElementById('adminPostUrl').value.trim();
                    const title = document.getElementById('adminPostTitle').value.trim();
                    const description = document.getElementById('adminPostDescription').value.trim();
                    const tagsInput = document.getElementById('adminPostTags').value.trim();
                    
                    if (!url || !title) return showToast("URL y Título son obligatorios.");

                    const id = BigInt(Date.now()) * BigInt(100000) + BigInt(Math.floor(Math.random() * 100000));

                    const newImageObject = {
                        id: id.toString(),
                        title: title,
                        description: description,
                        url: url,
                        tags: tagsInput.split(',').map(tag => tag.trim().toLowerCase()).filter(Boolean)
                    };

                    const jsonOutput = document.getElementById('generatedJsonOutput');
                    jsonOutput.value = JSON.stringify(newImageObject, null, 2);
                    document.getElementById('generatedJsonContainer').classList.remove('hidden');
                });

                document.getElementById('copyJsonBtn').addEventListener('click', () => {
                    const jsonOutput = document.getElementById('generatedJsonOutput');
                    jsonOutput.select();
                    document.execCommand('copy');
                    showToast('JSON copiado al portapapeles');
                });
            }

            function showConfirmationModal(title, message, onConfirm) {
                document.getElementById('confirmationTitle').textContent = title;
                document.getElementById('confirmationMessage').textContent = message;
                showModal('confirmationModal');

                const confirmBtn = document.getElementById('confirmActionBtn');
                const cancelBtn = document.getElementById('cancelActionBtn');

                const confirmHandler = () => { onConfirm(); hideModal('confirmationModal'); cleanup(); };
                const cancelHandler = () => { hideModal('confirmationModal'); cleanup(); };
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                };
                
                confirmBtn.addEventListener('click', confirmHandler);
                cancelBtn.addEventListener('click', cancelHandler);
            }

            async function handleDeletePost(postId) {
                showConfirmationModal('Eliminar Publicación', '¿Seguro que quieres eliminar esta publicación y todos sus datos?', async () => {
                    try {
                        await remove(ref(db, `posts/${postId}`));
                        await remove(ref(db, `likes/${postId}`));
                        await remove(ref(db, `comments/${postId}`));
                        await remove(ref(db, `views/${postId}`));
                        
                        showToast('Publicación eliminada con éxito.');
                        const detailView = document.getElementById('detailView');
                        if (!detailView.classList.contains('hidden')) {
                            closeSlideUpView('detailView');
                        }
                    } catch (error) {
                        console.error("Error eliminando la publicación:", error);
                        showToast('No se pudo eliminar la publicación.');
                    }
                });
            }

            async function handleDeleteComment(commentPath) {
                showConfirmationModal('Eliminar Comentario', '¿Seguro que quieres eliminar este comentario?', async () => {
                    try {
                        await remove(ref(db, commentPath));
                        showToast('Comentario eliminado.');
                    } catch (error) {
                        console.error("Error eliminando el comentario:", error);
                        showToast('No se pudo eliminar el comentario.');
                    }
                });
            }

            // --- INICIALIZACIÓN DE LA APP ---
            async function initializeAppForUser(user) {
                showLoader('galleryLoader', true);
                
                const userDataSnapshot = await get(ref(db, `users/${user.uid}`));
                currentUserData = userDataSnapshot.val() || { username: user.email.split('@')[0], profile: {} };
                if (!currentUserData.following) {
                    currentUserData.following = {};
                }
                isCurrentUserAdmin = !!currentUserData.profile?.isAdmin;

                const adminBtn = document.getElementById('adminAddCuratedBtn');
                if (adminBtn) adminBtn.classList.toggle('hidden', !isCurrentUserAdmin);

                const defaultAvatar = `https://api.dicebear.com/8.x/bottts-neutral/svg?seed=${encodeURIComponent(currentUserData.username || 'user')}`;
                currentUserData.profile.avatar = currentUserData.profile.avatar || defaultAvatar;
                updateAllAvatars(currentUserData.profile.avatar);

                try {
                    const usersRef = ref(db, 'users');
                    const q = query(usersRef, orderByChild('username'), equalTo(ADMIN_USERNAME));
                    const adminSnapshot = await get(q);

                    if (adminSnapshot.exists()) {
                        globalAdminUID = Object.keys(adminSnapshot.val())[0];
                    } else {
                        throw new Error("La cuenta del administrador ('Exen') no se encontró en la base de datos.");
                    }
                } catch (error) {
                    console.error("Error crítico al buscar al admin:", error);
                    showToast("Error: No se pudo cargar el contenido oficial.");
                }

                // Cargar datos iniciales y luego configurar listeners
                const initialPostsSnapshot = await get(query(ref(db, 'posts'), orderByChild('timestamp')));
                const posts = [];
                if (initialPostsSnapshot.exists()) {
                    initialPostsSnapshot.forEach(childSnapshot => {
                        posts.push({ ...childSnapshot.val(), id: childSnapshot.key, isPost: true });
                    });
                }
                allPosts = posts.reverse();

                await loadCuratedImages();
                setupPostsListener();
                setupUsersListener(); 
                
                sortCuratedFeed();
                renderCuratedFeed(true);
                listenToNotifications();
                renderMostVotedSection();

                appInitialized = true;
                showLoader('galleryLoader', false);
                triggerView('galleryView');
            }

            async function authStateObserver(user) {
                const authOverlay = document.getElementById('authOverlay');
                const appContent = document.getElementById('appContent');
                
                if (user) {
                    currentUser = user;
                    authOverlay.classList.add('opacity-0', 'pointer-events-none');
                    appContent.classList.remove('hidden');

                    if (!appInitialized) {
                        setupAppEventListeners();
                        await initializeAppForUser(user);
                    }
                } else {
                    currentUser = null;
                    currentUserData = {};
                    isCurrentUserAdmin = false;
                    globalAdminUID = null;
                    appInitialized = false;
                    
                    authOverlay.classList.remove('opacity-0', 'pointer-events-none');
                    appContent.classList.add('hidden');
                    document.querySelectorAll('.modal-container, .notifications-panel').forEach(m => {
                        m.classList.add('hidden');
                        m.classList.remove('active');
                    });
                }
            }
            
            // --- PUNTO DE ENTRADA PRINCIPAL ---
            setupAuthEventListeners();

            if (handleAgeVerification()) {
                onAuthStateChanged(auth, authStateObserver);
            }
        });
    </script>
</body>
</html>
