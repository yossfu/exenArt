<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exen-E | Galería Premium</title>

    <!-- 
    ======================================================================
    === ETIQUETAS OPEN GRAPH PARA VISTA PREVIA EN REDES SOCIALES (COMO FACEBOOK) ===
    ======================================================================
    -->

    <!-- Título que aparecerá en la vista previa -->
    <meta property="og:title" content="exen-E | Galería Premium" />

    <!-- Tipo de contenido, para una página web estándar se usa "website" -->
    <meta property="og:type" content="website" />

    <!-- La URL completa de tu página web (cámbiala cuando subas tu página a un servidor) -->
    <meta property="og:url" content="https://yossfu.github.io/exenArt/index.html" />

    <!-- 
      AQUÍ VA LA IMAGEN QUE QUIERES MOSTRAR
      - Reemplaza la URL de abajo con el enlace directo a la imagen que deseas mostrar.
      - La imagen debe estar en un servidor público para que Facebook pueda acceder a ella.
      - Se recomienda un tamaño de 1200x630 píxeles.
    -->
    <meta property="og:image" content="https://files.catbox.moe/byk24s.jpg" />
    <meta property="og:image:alt" content="Logo de exen-E Galería Premium" />


    <!-- Una breve descripción que aparecerá debajo del título en la vista previa -->
    <meta property="og:description" content="Descubre una colección premium de imágenes en la galería de exen-E." />

    <!-- 
    ======================================================================
    === FIN DE LAS ETIQUETAS OPEN GRAPH ===================================
    ======================================================================
    -->


    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Estilos Personalizados y Mejoras -->
    <style>
        :root {
            --accent: #e65100;
            --accent-neon: #ffab00;
            --diamond: #b9f2ff;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --halo-green: #00ff00;
            --halo-red: #ff0000;
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* bg-slate-900 */
            background-image: radial-gradient(circle at top right, rgba(234, 88, 12, 0.1), transparent 40%),
                              radial-gradient(circle at bottom left, rgba(20, 83, 163, 0.1), transparent 50%);
            color: #f3f4f6; /* text-gray-200 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Skeleton Loader Animation */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .skeleton {
            background-color: #374151;
            background-image: linear-gradient(to right, #374151 0%, #4b5563 20%, #374151 40%, #374151 100%);
            background-repeat: no-repeat;
            background-size: 2000px 100%;
            animation: shimmer 1.5s linear infinite;
            border-radius: 0.75rem;
            aspect-ratio: 2 / 3;
        }

        /* Estilos de Batalla y Top */
        .winning { box-shadow: 0 0 20px 5px var(--halo-green); }
        .losing { box-shadow: 0 0 20px 5px var(--halo-red); }
        .top-1 { border-color: var(--diamond); box-shadow: 0 0 15px var(--diamond); }
        .top-2 { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }
        .top-3 { border-color: var(--silver); box-shadow: 0 0 15px var(--silver); }

        @keyframes loadImage { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .image-item-animation { animation: loadImage 0.5s ease-out forwards; }

        /* Animación de reacción sobre la imagen (Restaurada) */
        @keyframes punch { 0% { opacity: 1; transform: translate(-50%,-50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%,-50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%,-50%) scale(1.5); } }
        .punch-animation { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 5rem; text-shadow: 0 4px 15px rgba(0,0,0,0.4); animation: punch 0.5s ease-out forwards; pointer-events: none; z-index: 50; }

        /* Animación para el "rain effect" (Restaurada) */
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-100px) scale(1.2); } }
        .reaction-animation { position: absolute; font-size: 2rem; pointer-events: none; animation: floatUp 1.5s ease forwards; z-index: 10; text-shadow: 0 0 5px rgba(0,0,0,0.5); }

        /* Círculo de reacciones */
        #reaction-circle-container.open .reaction-circle-item {
            opacity: 1;
            transform: scale(1) var(--transform-pos);
        }
        #reaction-circle-container.open #reaction-bg { transform: scale(1); }
        .reaction-circle-item {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform: scale(0); opacity: 0;
        }

        #scrollToTopBtn {
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
            opacity: 0; visibility: hidden; transform: translateY(20px);
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
        }
        #scrollToTopBtn.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        
        .image-card-hover { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .image-card-hover:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        /* Estilos de Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-neon); }
        
        /* Helper para ocultar scrollbar en sliders */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="antialiased">

    <!-- ========== OVERLAYS ========== -->
    <div id="warning-overlay" class="fixed inset-0 z-[2000] flex-col items-center justify-center bg-gray-950/90 p-4 text-center backdrop-blur-sm" style="display: none;">
        <h1 class="mb-6 text-3xl font-bold text-orange-500 flex items-center gap-3 animate-pulse"><i class="fas fa-exclamation-triangle"></i> Contenido +18</h1>
        <p class="mb-8 max-w-md text-lg text-gray-300">Esta galería contiene material sensible. Debes tener al menos 18 años para continuar.</p>
        <div class="flex flex-col sm:flex-row gap-4">
            <button class="w-full rounded-full bg-orange-600 px-8 py-3 font-semibold text-white transition hover:bg-orange-500 hover:scale-105" onclick="acceptWarning()"><i class="fas fa-check mr-2"></i> Sí, Soy Mayor de Edad</button>
            <button class="w-full rounded-full bg-gray-700 px-8 py-3 font-semibold text-white transition hover:bg-gray-600 hover:scale-105" onclick="rejectWarning()"><i class="fas fa-times mr-2"></i> No, salir</button>
        </div>
    </div>

    <!-- ========== HEADER ========== -->
    <header class="sticky top-0 z-[100] flex items-center justify-between bg-slate-900/80 p-4 backdrop-blur-lg shadow-lg">
        <h1 class="flex items-center gap-3 text-2xl font-bold">
            <svg class="h-10 w-10" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="var(--accent)"/>
                <path d="M30 70 L50 30 L70 70" stroke="#111827" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="10" fill="var(--accent-neon)"/>
            </svg>
            <span>exen-E</span>
        </h1>
        <div id="user-profile" class="flex items-center gap-2 rounded-full bg-gray-800/80 px-4 py-2 text-sm font-semibold text-gray-200"></div>
    </header>

    <main class="container mx-auto px-2 sm:px-4">
        <!-- ========== SEARCH ========== -->
        <div id="search-container" class="my-6 flex flex-col items-center gap-4 sm:flex-row">
            <input type="text" id="search" placeholder="Buscar en toda la galería..." class="w-full max-w-xl rounded-full border-2 border-gray-700 bg-gray-800 px-5 py-3 text-white transition placeholder:text-gray-500 focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500/50">
        </div>

        <div id="search-results" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4" style="display: none;"></div>
        
        <div id="main-content-sections">
            <!-- SECTIONS BATTLE, TOP, FOR YOU... -->
             <section id="battle-section" class="mb-12">
                <h3 class="mb-6 flex items-center justify-center gap-3 text-center text-3xl font-extrabold tracking-tight"><i class="fas fa-gavel text-orange-400"></i> Batalla de la Semana</h3>
                <div id="battle-grid" class="flex items-center justify-center gap-2 sm:gap-4">
                    <!-- Battle items will be populated here -->
                </div>
                <div id="battle-timer" class="mt-4 text-center font-semibold text-gray-400"></div>
                <div id="battle-winner-container" class="mt-8" style="display: none;">
                     <h4 class="mb-4 text-center text-xl font-bold text-yellow-400">Ganador Anterior</h4>
                    <div id="battle-winner" class="relative mx-auto max-w-sm"></div>
                </div>
            </section>
            
            <div class="my-8 h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent"></div>
            
            <section id="top-liked-section" class="mb-12">
                <h3 class="mb-4 flex items-center gap-3 text-2xl font-bold tracking-tight text-gray-200"><i class="fas fa-trophy text-yellow-400"></i> Más Gustadas</h3>
                <div id="top-liked-grid" class="flex gap-4 pb-4 overflow-x-auto scrollbar-hide">
                    <!-- Slider images will be populated here -->
                </div>
            </section>
            
            <div class="my-8 h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent"></div>
            
            <section id="for-you-section" class="mb-12">
                <h3 class="mb-4 flex items-center gap-3 text-2xl font-bold tracking-tight text-gray-200"><i class="fas fa-star text-purple-400"></i> Para Ti</h3>
                <div id="for-you-grid" class="flex gap-4 pb-4 overflow-x-auto scrollbar-hide">
                    <!-- Slider images will be populated here -->
                </div>
            </section>
            
            <div class="my-8 h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent"></div>
            
            <h3 class="mb-6 flex items-center justify-center gap-3 text-center text-3xl font-extrabold tracking-tight"><i class="fas fa-images text-blue-400"></i> Galería Completa</h3>
        </div>

        <!-- ========== MAIN GALLERY ========== -->
        <section id="gallery">
            <div id="error-message" class="rounded-lg bg-red-900/50 p-4 text-center text-red-300" style="display: none;"></div>
            <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4"></div>
            <div id="loader" class="py-12" style="display: none;"><div class="skeleton"></div></div>
            <div id="load-more-trigger" class="h-10"></div> <!-- Invisible trigger for IntersectionObserver -->
        </section>
    </main>

    <!-- ========== MODAL ========== -->
    <div id="modal" class="fixed inset-0 z-[1000] bg-gray-950/90 backdrop-blur-md" style="display: none;">
        <div id="modal-content" class="h-full w-full overflow-y-auto">
            <div class="container mx-auto flex max-w-4xl flex-col gap-4 p-2 sm:p-4">

                <header id="modal-header" class="flex items-center justify-between">
                    <h2 id="title" class="bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-2xl sm:text-4xl font-black text-transparent"></h2>
                    <button id="close-modal" class="flex h-12 w-12 items-center justify-center rounded-full bg-gray-800/80 text-gray-400 transition hover:bg-gray-700 hover:text-white hover:rotate-90">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </header>

                <div class="flex flex-col items-center gap-4">
                    <div id="image-container" class="relative -mx-2 sm:mx-0 sm:rounded-xl overflow-hidden w-full">
                        <img id="full-img" src="" alt="" data-zoom="1" class="h-auto max-h-[75vh] w-full object-contain transition-transform duration-300">
                    </div>

                    <div id="reaction-circle-container" class="relative z-20">
                        <div class="relative flex items-center justify-center">
                            <div id="reaction-bg" class="absolute inset-[-30px] rounded-full bg-gray-900/50 backdrop-blur-sm transition-transform duration-300 scale-0 -z-10"></div>
                            <div class="reaction-circle-item absolute" style="--transform-pos: translateX(-65px) translateY(-10px);">
                                <span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="like">❤️</span>
                            </div>
                            <div class="reaction-circle-item absolute" style="--transform-pos: translateX(-45px) translateY(-55px);">
                                <span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="hot">🔥</span>
                            </div>
                            <div class="reaction-circle-item absolute" style="--transform-pos: translateX(0px) translateY(-70px);">
                                <span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="wow">😯</span>
                            </div>
                            <div class="reaction-circle-item absolute" style="--transform-pos: translateX(45px) translateY(-55px);">
                                <span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="laugh">😂</span>
                            </div>
                            <div class="reaction-circle-item absolute" style="--transform-pos: translateX(65px) translateY(-10px);">
                                <span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="sad">😢</span>
                            </div>
                             <div class="reaction-circle-item absolute" style="--transform-pos: translateX(0px) translateY(55px);">
                                <span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="sexy">🫦</span>
                            </div>
                            <button id="like-btn" class="relative z-10 flex h-14 w-14 items-center justify-center rounded-full bg-gradient-to-r from-orange-500 to-yellow-500 text-gray-900 shadow-lg transition-transform duration-300 hover:scale-110">
                                <i class="fas fa-heart text-2xl"></i>
                            </button>
                        </div>
                    </div>

                <div id="reaction-counts-container" class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2 rounded-full bg-gray-800/80 px-4 py-2 text-lg"></div>
                <p id="desc" class="rounded-xl border-2 border-orange-500/30 bg-gray-800/50 p-4 text-center text-gray-300"></p>
                
                <section id="similar-section" class="mt-4 w-full">
                    <h3 class="mb-4 flex items-center justify-center gap-3 text-center text-xl font-bold"><i class="fas fa-th-large text-orange-400"></i> Imágenes Similares</h3>
                    <div id="similar-grid" class="flex gap-4 pb-4 overflow-x-auto scrollbar-hide">
                        <!-- Similar images will be populated here -->
                    </div>
                </section>
                
                <section id="comments-section" class="mt-4 w-full">
                    <form id="comment-form" class="mb-6 flex flex-col gap-3 rounded-xl bg-gray-800/50 p-4 sm:flex-row">
                        <input type="text" id="name-input" placeholder="Nombre (opcional)" class="w-full rounded-lg border-2 border-gray-700 bg-gray-900 px-4 py-2 text-white transition focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500/50 sm:w-1/4">
                        <input type="text" id="comment-input" placeholder="Escribe un comentario..." class="flex-grow rounded-lg border-2 border-gray-700 bg-gray-900 px-4 py-2 text-white transition focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500/50">
                        <button type="submit" id="comment-btn" class="group flex-shrink-0 rounded-lg bg-orange-600 px-5 py-2 font-semibold text-white transition hover:bg-orange-500">
                            <i class="fas fa-paper-plane transition group-hover:rotate-12"></i> Enviar
                        </button>
                    </form>
                    <div id="comments" class="flex flex-col gap-4"></div>
                </section>
            </div>
        </div>
    </div>
    
    <!-- ========== BOTÓN IR ARRIBA ========== -->
    <button id="scrollToTopBtn" title="Ir arriba" class="h-12 w-12 rounded-full bg-orange-600/80 text-white shadow-lg backdrop-blur-sm transition hover:bg-orange-500 hover:scale-110">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- ========== FOOTER ========== -->
    <footer class="mt-12 py-8 text-center text-gray-500">
        <p class="mt-2 text-sm">&copy; 2025 exen-E. Todos los derechos reservados.</p>
    </footer>

    <script>
        "use strict";
        // --- Configuración de Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8",
            authDomain: "exene-53e6b.firebaseapp.com",
            databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com",
            projectId: "exene-53e6b",
            storageBucket: "exene-53e6b.appspot.com",
            messagingSenderId: "481369419867",
            appId: "1:481369419867:web:ac5db24c436344262c8f7e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        firebase.auth().signInAnonymously().catch(error => console.error('Error en autenticación anónima:', error));
        
        // --- Variables Globales ---
        const imagesPerLoad = 20;
        let allImages = []; // Cache para búsqueda y datos del modal
        let lastImageTimestamp = null;
        let lastImageKey = null; // Clave para una paginación precisa
        let isLoading = false;
        let noMoreImages = false;
        let currentImageId = '';
        const sliderAnimationState = {}; // Almacena el estado de las animaciones de los sliders
        let deviceID = localStorage.getItem('deviceID');
        if (!deviceID) {
            deviceID = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            localStorage.setItem('deviceID', deviceID);
        }

        // --- Lógica de Arranque ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('adultConsent')) {
                document.getElementById('warning-overlay').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            } else {
                initializeApp();
            }
        });

        function acceptWarning() {
            localStorage.setItem('adultConsent', 'true');
            document.getElementById('warning-overlay').style.display = 'none';
            document.body.style.overflow = 'auto';
            initializeApp();
        }
        function rejectWarning() { window.location.href = 'https://www.google.com'; }

        function initializeApp() {
            loadInitialImages();
            initBattleSection();
            loadTopLikedImages();
            loadForYouImages();
            setupIntersectionObserver();
        }

        function generateSkeletons(container, count, isSlider = false) {
            container.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const skeleton = document.createElement('div');
                let classList = 'skeleton';
                if(isSlider) {
                    classList += ' flex-shrink-0 w-2/5 sm:w-1/4 md:w-1/5'
                }
                skeleton.className = classList;
                container.appendChild(skeleton);
            }
        }

        // --- Carga Paginada de Imágenes ---
        function loadInitialImages() {
            if (isLoading) return;
            isLoading = true;
            const grid = document.getElementById('grid');
            generateSkeletons(grid, imagesPerLoad);
            
            db.ref('images').orderByChild('timestamp').limitToLast(imagesPerLoad).once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    showError('No se encontraron imágenes.');
                    grid.innerHTML = '';
                    isLoading = false;
                    return;
                }
                const images = [];
                snapshot.forEach(child => {
                    images.push({ id: child.key, ...child.val() });
                });

                if (images.length > 0) {
                    lastImageTimestamp = images[0].timestamp;
                    lastImageKey = images[0].id;
                }
                
                images.reverse();
                allImages = images;
                displayImages(allImages, 'grid'); 
                isLoading = false;
            }).catch(error => {
                showError('Error al conectar con Firebase: ' + error.message);
                grid.innerHTML = '';
                isLoading = false;
            });
        }
        
        function loadMoreImages() {
            if (isLoading || noMoreImages) return;
            isLoading = true;
            const loaderContainer = document.getElementById('loader');
            loaderContainer.style.display = 'block';
            generateSkeletons(loaderContainer, 1);

            db.ref('images').orderByChild('timestamp').endBefore(lastImageTimestamp, lastImageKey).limitToLast(imagesPerLoad).once('value').then(snapshot => {
                loaderContainer.style.display = 'none';
                if (!snapshot.exists() || snapshot.numChildren() === 0) {
                    noMoreImages = true;
                    isLoading = false;
                    return;
                }

                const newImages = [];
                snapshot.forEach(child => {
                   newImages.push({ id: child.key, ...child.val() });
                });
                
                if (newImages.length < imagesPerLoad) { noMoreImages = true; }

                if (newImages.length > 0) {
                    lastImageTimestamp = newImages[0].timestamp;
                    lastImageKey = newImages[0].id;
                    newImages.reverse();
                    allImages = allImages.concat(newImages);
                    displayImages(newImages, 'grid', true);
                }
                
                isLoading = false;
            }).catch(error => {
                console.error("Error loading more images:", error);
                isLoading = false;
                loaderContainer.style.display = 'none';
            });
        }
        
        // --- Lógica de Secciones ---
        async function getRandomImage() {
            const randomKey = db.ref('images').push().key;
            let snapshot = await db.ref('images').orderByKey().startAt(randomKey).limitToFirst(1).once('value');
            if (!snapshot.exists()) {
                snapshot = await db.ref('images').orderByKey().endAt(randomKey).limitToLast(1).once('value');
            }
            if(snapshot.exists()) {
                const key = Object.keys(snapshot.val())[0];
                return { id: key, ...snapshot.val()[key] };
            }
            return null;
        }

        async function initBattleSection() {
            const battleGrid = document.getElementById('battle-grid');
            battleGrid.innerHTML = `<div class="w-full"><div class="skeleton"></div></div><span class="text-3xl font-black text-yellow-400">VS</span><div class="w-full"><div class="skeleton"></div></div>`;

            const snap = await db.ref('battle').once('value');
            const battle = snap.val() || {};
            const now = Date.now();
            
            if (!battle.images || !battle.expiry || battle.expiry < now) {
                let [img1, img2] = await Promise.all([getRandomImage(), getRandomImage()]);
                while(!img1 || !img2 || img1.id === img2.id) { img2 = await getRandomImage(); }
                
                const newExpiry = now + (7 * 24 * 60 * 60 * 1000); // 7 days
                const newBattle = {
                    images: [img1.id, img2.id],
                    votes: { [img1.id]: 0, [img2.id]: 0 },
                    expiry: newExpiry,
                    users: {}
                };
                if(battle.images) { saveBattleWinner(battle); }
                db.ref('battle').set(newBattle)
                    .then(() => displayBattle([img1, img2], newExpiry))
                    .catch(e => console.error('Error initializing battle:', e));
            } else {
                 const snapshots = await Promise.all(battle.images.map(id => db.ref(`images/${id}`).once('value')));
                 const battleImages = snapshots.map(snap => ({id: snap.key, ...snap.val()}));
                 displayBattle(battleImages, battle.expiry);
            }
            loadPreviousBattleWinner();
        }

        async function loadTopLikedImages() {
            const grid = document.getElementById('top-liked-grid');
            generateSkeletons(grid, 10, true);
            
            const reactionsSnap = await db.ref('reactions').once('value');
            const reactions = reactionsSnap.val() || {};
            const likesCount = {};
            Object.entries(reactions).forEach(([imgId, users]) => {
                likesCount[imgId] = Object.keys(users).length;
            });

            const sortedIds = Object.keys(likesCount).sort((a,b) => likesCount[b] - likesCount[a]).slice(0, 10);
            if (sortedIds.length === 0) {
                 grid.innerHTML = '<p class="w-full text-center text-gray-500">Aún no hay imágenes gustadas.</p>';
                 return;
            }

            const imageSnaps = await Promise.all(sortedIds.map(id => db.ref(`images/${id}`).once('value')));
            const images = imageSnaps.map(s => ({id: s.key, ...s.val()}));
            
            displayImages(images, 'top-liked-grid');
            initAutoSlider('top-liked-grid');
        }
        
        async function loadForYouImages() {
            const grid = document.getElementById('for-you-grid');
            generateSkeletons(grid, 10, true);

            let viewedImageIds = [];
            try { viewedImageIds = JSON.parse(localStorage.getItem('viewedImages')) || []; } catch (e) { viewedImageIds = []; }

            const fallbackToRecents = async () => {
                const imageSnap = await db.ref('images').limitToLast(10).once('value');
                if (!imageSnap.exists()) {
                    grid.innerHTML = '<p class="w-full text-center text-gray-500">No hay imágenes para mostrar.</p>';
                    return;
                }
                const images = [];
                imageSnap.forEach(child => { images.push({id: child.key, ...child.val()}); });
                displayImages(images.reverse(), 'for-you-grid');
                initAutoSlider('for-you-grid');
            };

            if (viewedImageIds.length === 0) {
                await fallbackToRecents();
                return;
            }

            const viewedImageSnaps = await Promise.all(viewedImageIds.slice(0, 20).map(id => db.ref(`images/${id}`).once('value')));
            const userTagProfile = {};
            viewedImageSnaps.forEach(snap => {
                if (snap.exists() && Array.isArray(snap.val().tags)) {
                    snap.val().tags.forEach(tag => { userTagProfile[tag] = (userTagProfile[tag] || 0) + 1; });
                }
            });
            
            if (Object.keys(userTagProfile).length === 0) {
                await fallbackToRecents();
                return;
            }

            const candidateSnap = await db.ref('images').limitToLast(200).once('value');
            if (!candidateSnap.exists()) { await fallbackToRecents(); return; }
            
            const candidates = [];
            candidateSnap.forEach(child => {
                const img = { id: child.key, ...child.val() };
                if (img.tags && !viewedImageIds.includes(img.id)) { candidates.push(img); }
            });

            const scoredCandidates = candidates.map(img => {
                let score = 0;
                if (Array.isArray(img.tags)) {
                    img.tags.forEach(tag => { if (userTagProfile[tag]) score += userTagProfile[tag]; });
                }
                return { image: img, score };
            }).filter(item => item.score > 0);

            scoredCandidates.sort((a, b) => b.score - a.score);
            const recommendedImages = scoredCandidates.slice(0, 10).map(item => item.image);

            if (recommendedImages.length > 0) {
                displayImages(recommendedImages, 'for-you-grid');
                initAutoSlider('for-you-grid');
            } else {
                await fallbackToRecents();
            }
        }


        // --- Funciones de Renderizado y UI ---
        function displayImages(images, containerId, append = false) {
            const grid = document.getElementById(containerId);
            if (!append) grid.innerHTML = '';
            
            if (images.length === 0 && !append) {
                grid.innerHTML = `<div class="col-span-full w-full text-center py-8 text-gray-400">No hay imágenes para mostrar.</div>`;
                return;
            }
            
            const isSlider = containerId === 'top-liked-grid' || containerId === 'for-you-grid' || containerId === 'similar-grid';

            images.forEach((img, index) => {
                if (!img.url || !img.title) return; // Skip incomplete data
                const div = document.createElement('div');
                
                let classList = 'image-item-animation group relative aspect-[2/3] cursor-pointer overflow-hidden rounded-xl image-card-hover flex-shrink-0';
                
                if (isSlider) {
                    classList += ' w-2/5 sm:w-1/4 md:w-1/5';
                }
                if (containerId === 'similar-grid') {
                    classList = 'image-item-animation group relative aspect-[2/3] cursor-pointer overflow-hidden rounded-xl image-card-hover flex-shrink-0 w-[45%] sm:w-[30%] md:w-[22%]';
                }

                if (containerId === 'top-liked-grid') {
                    const topClass = index === 0 ? 'top-1' : index === 1 ? 'top-2' : index === 2 ? 'top-3' : '';
                    if (topClass) classList += ` border-2 border-transparent ${topClass}`;
                }

                div.className = classList;
                div.style.animationDelay = `${(index * 0.05)}s`;
                div.setAttribute('onclick', `openModal('${img.id}')`);
                div.innerHTML = `
                    <img src="${img.url}" alt="${img.title}" loading="lazy" class="h-full w-full object-cover transition duration-300 group-hover:scale-105" onerror="this.src='https://placehold.co/400x600/1f2937/374151?text=Error'">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent transition duration-300 group-hover:bg-black/50 pointer-events-none"></div>
                    <div class="absolute bottom-0 left-0 p-3 pointer-events-none">
                        <h4 class="truncate font-bold text-white text-shadow-lg">${img.title}</h4>
                    </div>
                     <div class="absolute top-2 right-2 flex items-center gap-1 rounded-full bg-black/50 px-2 py-1 text-xs text-white pointer-events-none"><i class="fas fa-heart text-red-500"></i><span id="reaction-total-${img.id}">0</span></div>
                `;
                grid.appendChild(div);
                db.ref(`reactions/${img.id}`).once('value').then(snap => {
                    const reactionCountEl = document.getElementById(`reaction-total-${img.id}`);
                    if (reactionCountEl) reactionCountEl.textContent = snap.numChildren();
                });
            });
        }
        
        async function openModal(id) {
            let img = allImages.find(i => i.id === id);
            if (!img) {
                const snapshot = await db.ref(`images/${id}`).once('value');
                if(snapshot.exists()) img = { id: snapshot.key, ...snapshot.val() };
                else { console.error("Image not found"); return; }
            }
            
            currentImageId = id;
            document.getElementById('full-img').src = img.url;
            document.getElementById('title').textContent = img.title;
            document.getElementById('desc').textContent = img.desc;
            
            loadLikes(id);
            loadComments(id);
            loadSimilarImages(img.tags || []);
            triggerReactionRain(id);
            trackImageView(id);

            document.getElementById('scrollToTopBtn').classList.remove('visible'); // CORRECCIÓN: Ocultar botón
            document.getElementById('modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => document.getElementById('modal-content').scrollTop = 0, 50);
        }

        function trackImageView(imageId) {
            if (!imageId) return;
            let viewedImages = [];
            try { viewedImages = JSON.parse(localStorage.getItem('viewedImages')) || []; } catch (e) { viewedImages = []; }
            
            const existingIndex = viewedImages.indexOf(imageId);
            if (existingIndex > -1) { viewedImages.splice(existingIndex, 1); }
            
            viewedImages.unshift(imageId);
            const historyLimit = 50; 
            if (viewedImages.length > historyLimit) { viewedImages = viewedImages.slice(0, historyLimit); }
            
            localStorage.setItem('viewedImages', JSON.stringify(viewedImages));
        }

        function initAutoSlider(containerId) {
            const container = document.getElementById(containerId);
            if (!container || container.children.length < 2) return;

            if (sliderAnimationState[containerId]?.animationFrameId) {
                cancelAnimationFrame(sliderAnimationState[containerId].animationFrameId);
            }

            if (!container.dataset.cloned) {
                const originalChildren = Array.from(container.children);
                originalChildren.forEach(child => {
                    const clone = child.cloneNode(true);
                    clone.setAttribute('aria-hidden', 'true');
                    container.appendChild(clone);
                });
                container.dataset.cloned = 'true';
            }

            const scrollWidth = container.scrollWidth / 2;
            let isPaused = false;

            const scroll = () => {
                if (!isPaused) {
                    container.scrollLeft += 0.5;
                    if (container.scrollLeft >= scrollWidth) {
                        container.scrollLeft = 0;
                    }
                }
                sliderAnimationState[containerId] = { animationFrameId: requestAnimationFrame(scroll) };
            };

            const start = () => { isPaused = false; };
            const stop = () => { isPaused = true; };

            container.addEventListener('mouseenter', stop);
            container.addEventListener('mouseleave', start);
            container.addEventListener('touchstart', stop, { passive: true });
            container.addEventListener('touchend', start, { passive: true });

            scroll();
        }

        async function loadSimilarImages(tags) {
            const grid = document.getElementById('similar-grid');
            
            if (sliderAnimationState['similar-grid']?.animationFrameId) {
                cancelAnimationFrame(sliderAnimationState['similar-grid'].animationFrameId);
            }
            grid.innerHTML = '';
            delete grid.dataset.cloned;

            if (!tags || tags.length === 0) {
                 grid.innerHTML = '<p class="w-full flex-shrink-0 text-center text-gray-500">No hay etiquetas para encontrar similares.</p>';
                return;
            }

            const snap = await db.ref('images').orderByChild('timestamp').limitToLast(200).once('value');
            if(!snap.exists()) return;

            const candidates = [];
            snap.forEach(child => {
                const img = { id: child.key, ...child.val() };
                if (img.id !== currentImageId && Array.isArray(img.tags)) {
                    candidates.push(img);
                }
            });
            
            const scoredImages = candidates.map(img => {
                const commonTags = img.tags.filter(tag => tags.includes(tag));
                return { image: img, score: commonTags.length };
            }).filter(item => item.score > 0);

            scoredImages.sort((a, b) => b.score - a.score);

            const similarImages = scoredImages.slice(0, 10).map(item => item.image);

            if(similarImages.length > 0) {
                displayImages(similarImages, 'similar-grid');
                initAutoSlider('similar-grid');
            } else {
                grid.innerHTML = '<p class="w-full flex-shrink-0 text-center text-gray-500">No se encontraron imágenes con etiquetas similares.</p>';
            }
        }
        
        // --- Event Listeners y Lógica Auxiliar ---
        function setupIntersectionObserver() {
            const trigger = document.getElementById('load-more-trigger');
            const options = { rootMargin: '0px 0px 500px 0px' };
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && document.getElementById('search-results').style.display === 'none') {
                    loadMoreImages();
                }
            }, options);
            observer.observe(trigger);
        }

        const scrollToTopBtn = document.getElementById('scrollToTopBtn');
        window.addEventListener('scroll', () => {
            (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) ?
                scrollToTopBtn.classList.add('visible') : scrollToTopBtn.classList.remove('visible');
        });
        scrollToTopBtn.addEventListener('click', () => window.scrollTo({top: 0, behavior: 'smooth'}));
        
        function normalize(text) { return text ? text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase() : ''; }
        
        document.getElementById('search').addEventListener('input', e => {
            const query = normalize(e.target.value);
            const searchResults = document.getElementById('search-results');
            const mainContent = document.getElementById('main-content-sections');
            const gallery = document.getElementById('gallery');

            if (!query) {
                searchResults.style.display = 'none';
                mainContent.style.display = 'block';
                gallery.style.display = 'block';
                return;
            }
            
            const filtered = allImages.filter(item => 
                normalize(item.title).includes(query) || 
                (item.tags && item.tags.some(tag => normalize(tag).includes(query)))
            );
            
            displayImages(filtered, 'search-results');
            searchResults.style.display = 'grid';
            mainContent.style.display = 'none';
            gallery.style.display = 'none';
        });

        document.getElementById('close-modal').addEventListener('click', () => {
            document.getElementById('modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            if (sliderAnimationState['similar-grid']?.animationFrameId) {
                cancelAnimationFrame(sliderAnimationState['similar-grid'].animationFrameId);
                delete sliderAnimationState['similar-grid'];
            }
            // CORRECCIÓN: Re-evaluar la visibilidad del botón al cerrar el modal
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                scrollToTopBtn.classList.add('visible');
            }
        });
        
        // --- Reacciones ---
        function animateReactionOnImage(type) {
            const icons = { hot: '🔥', like: '❤️', wow: '😯', sexy: '🫦', laugh: '😂', sad: '😢' };
            const icon = icons[type];
            if (!icon) return;

            const container = document.getElementById('image-container');
            const existingAnimation = container.querySelector('.punch-animation');
            if (existingAnimation) {
                existingAnimation.remove();
            }

            const animationEl = document.createElement('div');
            animationEl.className = 'punch-animation';
            animationEl.textContent = icon;
            container.appendChild(animationEl);

            setTimeout(() => {
                if (animationEl) animationEl.remove();
            }, 500); // Duración de la animación es 0.5s
        }

        function showReactionAnimation(type, container) {
            const icons = { hot: '🔥', like: '❤️', wow: '😯', sexy: '🫦', laugh: '😂', sad: '😢' };
            if (!icons[type]) return;
            const reaction = document.createElement('span');
            reaction.className = 'reaction-animation';
            reaction.textContent = icons[type];
            reaction.style.left = `${Math.random() * 80 + 10}%`;
            reaction.style.bottom = '20px';
            container.appendChild(reaction);
            setTimeout(() => reaction.remove(), 1500);
        }

        function triggerReactionRain(id) {
            db.ref(`reactions/${id}`).once('value', snap => {
                const container = document.getElementById('image-container');
                let delay = 0;
                snap.forEach(childSnap => {
                    setTimeout(() => showReactionAnimation(childSnap.val(), container), delay);
                    delay += Math.random() * 200 + 50; // Randomize delay for a more natural feel
                });
            });
        }
        
        function loadLikes(id) {
            db.ref(`reactions/${id}`).on('value', snap => {
                const reactions = snap.val() || {};
                const counts = { hot: 0, like: 0, wow: 0, sexy: 0, laugh: 0, sad: 0 };
                Object.values(reactions).forEach(type => { if(counts[type] !== undefined) counts[type]++; });
                
                document.getElementById('reaction-counts-container').innerHTML = Object.entries(counts)
                    .map(([type, count]) => `<span class="flex items-center gap-1">${{like:'❤️',hot:'🔥',wow:'😯',laugh:'😂',sad:'😢',sexy:'🫦'}[type]} <span class="font-bold">${count}</span></span>`)
                    .join('');

                const total = snap.numChildren();
                const mainGridEl = document.getElementById(`reaction-total-${id}`);
                if (mainGridEl) mainGridEl.textContent = total;
            });
        }

        document.getElementById('like-btn').addEventListener('click', e => {
            e.stopPropagation();
            document.getElementById('reaction-circle-container').classList.toggle('open');
        });
        document.querySelectorAll('.reaction').forEach(reaction => {
            reaction.addEventListener('click', e => {
                e.stopPropagation();
                if (!currentImageId) return;
                const type = e.currentTarget.dataset.type;
                animateReactionOnImage(type);
                const reactionsRef = db.ref(`reactions/${currentImageId}/${deviceID}`);
                reactionsRef.once('value', snap => {
                    (snap.val() === type) ? reactionsRef.remove() : reactionsRef.set(type);
                });
                document.getElementById('reaction-circle-container').classList.remove('open');
            });
        });
        document.addEventListener('click', () => document.getElementById('reaction-circle-container').classList.remove('open'));
        
        // --- Comentarios ---
        function loadComments(id) {
             db.ref(`comments/${id}`).orderByChild('timestamp').on('value', snap => {
                const commentsContainer = document.getElementById('comments');
                commentsContainer.innerHTML = !snap.exists() ? '<p class="text-center text-gray-500">Aún no hay comentarios. ¡Sé el primero!</p>' : '';
                
                const comments = [];
                snap.forEach(child => { comments.push(child.val()); });

                comments.reverse().forEach(comment => {
                    const div = document.createElement('div');
                    const initial = comment.name ? comment.name.charAt(0).toUpperCase() : 'A';
                    const avatarBg = 'bg-gradient-to-br from-orange-500 to-yellow-500 text-gray-900';
                    div.innerHTML = `
                        <div class="flex gap-3">
                            <div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full ${avatarBg} font-bold">${initial}</div>
                            <div class="flex-grow min-w-0">
                                <div class="rounded-lg rounded-tl-none bg-gray-800 p-3">
                                    <p class="font-bold text-orange-400">${comment.name || 'Anónimo'}</p>
                                    <p class="text-gray-300 whitespace-pre-wrap break-words">${comment.text || ''}</p>
                                </div>
                                <small class="pl-2 pt-1 text-xs text-gray-500">${new Date(comment.timestamp).toLocaleString()}</small>
                            </div>
                        </div>`;
                    commentsContainer.appendChild(div);
                });
            });
        }
        document.getElementById('comment-form').addEventListener('submit', e => {
            e.preventDefault();
            const name = document.getElementById('name-input').value.trim();
            const comment = document.getElementById('comment-input').value.trim();
            if (!comment || !currentImageId) return;
            const commentData = { name: name || 'Anónimo', text: comment, timestamp: Date.now() };
            db.ref(`comments/${currentImageId}`).push(commentData)
              .then(() => document.getElementById('comment-input').value = '');
        });

        // --- Batalla ---
        function displayBattle(images, expiry) {
            const [img1, img2] = images;
            const battleGrid = document.getElementById('battle-grid');
            battleGrid.innerHTML = `
                <div class="battle-item relative w-full" id="battle-item-1"></div>
                <span class="text-3xl font-black text-yellow-400" style="text-shadow: 0 0 10px var(--accent);">VS</span>
                <div class="battle-item relative w-full" id="battle-item-2"></div>`;

            const renderItem = (container, img) => {
                container.innerHTML = `
                    <div class="aspect-[2/3] rounded-lg overflow-hidden shadow-lg transition duration-300 transform hover:scale-105 relative">
                        <img src="${img.url}" alt="${img.title}" onclick="openModal('${img.id}')" class="w-full h-full object-cover">
                        <div class="absolute top-2 right-2 bg-black/60 rounded-full px-2 py-1 text-xs font-bold" id="vote-count-${img.id}">0</div>
                        <button class="battle-vote-btn absolute bottom-2 left-1/2 -translate-x-1/2 w-4/5 rounded-full bg-gradient-to-r from-orange-500 to-yellow-500 px-4 py-2 text-sm font-bold text-gray-900 transition hover:scale-105" onclick="voteBattle('${img.id}', event)">Votar</button>
                    </div>`;
            };
            renderItem(document.getElementById('battle-item-1'), img1);
            renderItem(document.getElementById('battle-item-2'), img2);
            
            db.ref('battle').on('value', snap => {
                const battle = snap.val();
                if (!battle || !battle.votes) return;
                document.getElementById(`vote-count-${img1.id}`).textContent = battle.votes[img1.id] || 0;
                document.getElementById(`vote-count-${img2.id}`).textContent = battle.votes[img2.id] || 0;
                if (battle.users && battle.users[deviceID]) {
                    document.querySelectorAll('.battle-vote-btn').forEach(b => b.style.display = 'none');
                }
                updateBattleHalo();
            });

            const timerEl = document.getElementById('battle-timer');
            const timerInterval = setInterval(() => {
                const timeLeft = expiry - Date.now();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerEl.textContent = "La batalla ha terminado. Calculando ganador...";
                    setTimeout(initBattleSection, 5000); // Restart after 5s
                    return;
                }
                const d = Math.floor(timeLeft / 864e5), h = Math.floor(timeLeft / 36e5 % 24), m = Math.floor(timeLeft / 6e4 % 60);
                timerEl.textContent = `Tiempo restante: ${d}d ${h}h ${m}m`;
            }, 1000);
        }

        function voteBattle(imageId, event) {
            event.stopPropagation();
            db.ref(`battle/users/${deviceID}`).once('value', snap => {
                if (snap.exists()) return;
                db.ref(`battle/users/${deviceID}`).set(imageId);
                db.ref(`battle/votes/${imageId}`).transaction(c => (c || 0) + 1);
            });
        }
        
        function updateBattleHalo() {
            db.ref('battle/votes').once('value').then(snap => {
                const votes = snap.val();
                if(!votes) return;
                const [id1, id2] = Object.keys(votes);
                const item1 = document.getElementById('battle-item-1');
                const item2 = document.getElementById('battle-item-2');
                if(!item1 || !item2) return;
                item1.classList.remove('winning', 'losing');
                item2.classList.remove('winning', 'losing');
                if (votes[id1] > votes[id2]) {
                    item1.classList.add('winning'); item2.classList.add('losing');
                } else if (votes[id2] > votes[id1]) {
                    item2.classList.add('winning'); item1.classList.add('losing');
                }
            });
        }
        
        function saveBattleWinner(battle) {
            const votes = battle.votes;
            const [id1, id2] = battle.images;
            const winnerId = (votes[id1] || 0) >= (votes[id2] || 0) ? id1 : id2;
            db.ref('previousBattleWinner').set({ winnerId, timestamp: Date.now() });
        }
        
        async function loadPreviousBattleWinner() {
            const snap = await db.ref('previousBattleWinner').once('value');
            if (!snap.exists()) return;
            const winnerId = snap.val().winnerId;
            const winnerSnap = await db.ref(`images/${winnerId}`).once('value');
            if (!winnerSnap.exists()) return;

            const winner = {id: winnerSnap.key, ...winnerSnap.val()};
            const container = document.getElementById('battle-winner');
            container.innerHTML = `<div class="aspect-[2/3] rounded-lg overflow-hidden shadow-lg border-2 border-yellow-400 relative cursor-pointer" onclick="openModal('${winner.id}')"><img src="${winner.url}" alt="${winner.title}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-4"><h5 class="text-white font-bold">${winner.title}</h5></div></div>`;
            document.getElementById('battle-winner-container').style.display = 'block';
        }

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
    </script>
</body>
</html>
