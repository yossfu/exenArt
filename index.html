<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>exen-E | Galer√≠a</title>
    <!-- Metatags -->
    <meta property="og:title" content="exen-E | Galer√≠a" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://yossfu.github.io/exenArt/index.html" />
    <meta property="og:image" content="https://files.catbox.moe/ta0lv8.png" />
    <meta property="og:image:alt" content="Logo de exen-E Galer√≠a Premium" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- Estilos Personalizados -->
    <style>
        :root { 
            --accent: #f97316; 
            --accent-glow: rgba(251, 146, 60, 0.6);
            --title-font: 'Poppins', sans-serif;
            --body-font: 'Inter', sans-serif;
        }
        html { scroll-behavior: smooth; }
        body { 
            font-family: var(--body-font); 
            background-color: #0c0c0c;
            background-image: radial-gradient(circle at 25% 25%, rgba(249, 115, 22, 0.05) 0%, transparent 40%), 
                              radial-gradient(circle at 75% 75%, rgba(139, 92, 246, 0.05) 0%, transparent 40%);
            color: #f3f4f6;
            padding-bottom: 80px;
        }

        /* --- PANTALLA DE CARGA INICIAL --- */
        #initial-loader {
            position: fixed; inset: 0; z-index: 10000;
            background-color: #0c0c0c;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .loader-logo { width: 80px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 10px var(--accent)); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        /* --- AUTH OVERLAY --- */
        #auth-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background-color: rgba(12, 12, 12, 0.95);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center; justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }
        .form-card {
            background: rgba(20, 20, 25, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            width: 100%; max-width: 400px;
        }
        .input-field {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .input-field:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 10px rgba(249, 115, 22, 0.2); }
        .btn-primary { background: linear-gradient(135deg, #f97316, #ea580c); transition: transform 0.2s; }
        .btn-primary:active { transform: scale(0.98); }
        .hidden-step { display: none; animation: fadeIn 0.5s forwards; }
        .upload-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- ESTILOS GENERALES --- */
        .image-card {
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            will-change: transform;
        }
        .image-card:hover { transform: scale(1.03); box-shadow: 0 0 25px -5px var(--accent-glow); }
        .touch-feedback { transition: transform 0.15s cubic-bezier(0.22, 1, 0.36, 1); }
        .touch-feedback:active { transform: scale(0.95); }

        /* NAV */
        .bottom-nav { background-color: rgba(10, 10, 10, 0.9); backdrop-filter: blur(12px); border-top: 1px solid rgba(55, 65, 81, 0.3); }
        .nav-item { color: #9ca3af; transition: color 0.25s ease, transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .nav-item.active { color: var(--accent); transform: translateY(-4px); }
        .nav-item.active span { font-weight: 700; }

        /* MODAL VISOR */
        #modal { display: none; background-color: #000; z-index: 2000; }
        #modal.visible { display: block; animation: modalFadeIn 0.4s ease-out forwards; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-backdrop-blur {
            position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover;
            filter: blur(15px) brightness(0.5) saturate(1.1); transform: scale(1.1); z-index: 0; pointer-events: none;
        }
        .viewer-frame {
            background-color: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px; box-shadow: 0 30px 60px -10px rgba(0, 0, 0, 0.8); position: relative;
            overflow: hidden; width: 100%; max-width: 100%; backdrop-filter: blur(0px); 
        }

        /* --- UTILS --- */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .skeleton { background-color: #374151; background-image: linear-gradient(to right, #374151 0%, #4b5563 20%, #374151 40%, #374151 100%); background-repeat: no-repeat; background-size: 2000px 100%; animation: shimmer 1.5s linear infinite; border-radius: 1rem; aspect-ratio: 2 / 3; }
        .image-item-animation { animation: loadImage 0.6s ease-out forwards; }
        @keyframes loadImage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- HERO OPTIMIZADO --- */
        .hero-wrapper {
            position: relative; width: 100%; height: 300px; border-radius: 1rem; overflow: hidden;
            margin-bottom: 2rem; box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.5); display: none; 
            background-color: #0a0a0a; border: 1px solid rgba(255,255,255,0.05);
        }
        @media (min-width: 640px) { .hero-wrapper { height: 360px; } }
        
        .hero-slide { position: absolute; inset: 0; opacity: 0; transition: opacity 0.8s ease-in-out; z-index: 1; overflow: hidden; will-change: opacity; }
        .hero-slide.active { opacity: 1; z-index: 10; }
        
        .hero-bg-img {
            width: 100%; height: 100%; object-fit: cover; transform: scale(1); filter: brightness(0.5) blur(2px);
            will-change: transform;
        }
        .hero-slide.active .hero-bg-img { animation: slowZoom 20s linear infinite alternate; }
        @keyframes slowZoom { 0% { transform: scale(1); } 100% { transform: scale(1.2); } }
        
        .hero-overlay {
            position: absolute; inset: 0; z-index: 20; display: flex; align-items: center; padding-left: 1.5rem;
            background: linear-gradient(90deg, rgba(12, 12, 12, 0.95) 0%, rgba(12, 12, 12, 0.6) 60%, transparent 100%);
        }
        .hero-floating-card {
            position: absolute; top: 15%; bottom: 15%; right: 5%; width: 35%; max-width: 180px; z-index: 25;
            border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.2);
            transform: rotate(-3deg); background: #1a1a1a;
        }
        .hero-floating-img { width: 100%; display: block; }
        .hero-indicators { position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.4rem; z-index: 40; }
        .hero-dot { width: 5px; height: 5px; border-radius: 50%; background-color: rgba(255,255,255,0.3); transition: all 0.3s; }
        .hero-dot.active { background-color: var(--accent); width: 16px; border-radius: 3px; }

        /* CATEGOR√çAS */
        .menu-btn {
            padding: 12px 28px; background: linear-gradient(135deg, #f97316, #ea580c); color: white;
            font-family: var(--title-font); font-size: 16px; font-weight: bold; border: none; border-radius: 50px;
            box-shadow: 0 8px 20px rgba(249, 115, 22, 0.3); display: flex; align-items: center; gap: 8px;
        }
        .dropdown { position: relative; display: inline-block; width: 100%; max-width: 400px; }
        .dropdown-content {
            display: none; position: absolute; top: 65px; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 25, 0.95); padding: 20px 15px; border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.8); backdrop-filter: blur(12px);
            border: 1px solid rgba(249, 115, 22, 0.2); width: 90vw; max-width: 500px; z-index: 34;
        }
        .dropdown-content.show { display: block; animation: fadeIn 0.3s ease; }
        .categories-horizontal { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .category-circle {
            width: 90px; height: 90px; min-width: 90px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; color: white; font-weight: 700; font-size: 12px; text-transform: uppercase;
            border: 2px solid rgba(255,255,255,0.2); background-size: cover; background-position: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.9);
        }
        .cat-anime { background-image: linear-gradient(135deg, #ff7eb3, #ff6a8c); }
        .cat-furry { background-image: linear-gradient(135deg, #a8e6cf, #66bb6a); } 
        .cat-realismo { background-image: linear-gradient(135deg, #90caf9, #42a5f5); }
        .cat-mecas { background-image: linear-gradient(135deg, #b39ddb, #7e57c2); }
        .cat-devils { background-image: linear-gradient(135deg, #ef5350, #b71c1c); } 
        .cat-colors { background-image: linear-gradient(135deg, #ffd54f, #ffb300); } 
        .cat-amateur { background-image: linear-gradient(135deg, #ff8a65, #f4511e); } 
        .cat-tvgames { background-image: linear-gradient(135deg, #81d4fa, #29b6f6); }

        /* CTA BANNER (Comunidad) */
        .cta-card {
            min-width: 220px; width: 220px; height: 300px;
            background: linear-gradient(145deg, #1a1a1c, #111);
            border: 1px solid rgba(249, 115, 22, 0.3);
            border-radius: 1rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 1.5rem;
            flex-shrink: 0; scroll-snap-align: start;
        }

        /* REGISTER GATE (Galer√≠a) */
        #gallery-register-gate {
            width: 100%; padding: 2rem 1rem; margin-top: 1rem; margin-bottom: 4rem;
            background: linear-gradient(to bottom, transparent, rgba(249, 115, 22, 0.1));
            border-top: 1px solid rgba(249, 115, 22, 0.2);
            text-align: center; display: none;
        }

        .user-profile-btn {
            position: absolute; left: 10px; top: 10px; width: 45px; height: 45px;
            border-radius: 50%; overflow: hidden; border: 2px solid var(--accent);
            cursor: pointer; z-index: 50; transition: transform 0.2s;
        }
        
        #config-modal { display: none; position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .config-card { background: #1a1a1a; border: 1px solid #333; border-radius: 16px; padding: 1.5rem; width: 90%; max-width: 350px; }
        
        /* REACCIONES */
        #reaction-circle-container.open .reaction-circle-item { opacity: 1; transform: scale(1) var(--transform-pos); }
        .reaction-circle-item { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform: scale(0); opacity: 0; }
        .punch-animation { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 5rem; animation: punch 0.5s ease-out forwards; pointer-events: none; z-index: 50; }
        @keyframes punch { 0% { opacity: 1; transform: translate(-50%,-50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%,-50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%,-50%) scale(1.5); } }
        
        #scrollToTopBtn { opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.3s; }
        #scrollToTopBtn.visible { opacity: 1; visibility: visible; transform: translateY(0); }
    </style>
</head>
<body class="antialiased">

    <!-- PANTALLA DE CARGA -->
    <div id="initial-loader">
        <img src="https://files.catbox.moe/ap1lh0.png" class="loader-logo">
        <i class="fas fa-spinner fa-spin text-orange-500 text-2xl"></i>
    </div>

    <!-- OVERLAY AUTH -->
    <div id="auth-overlay">
        <div class="form-card rounded-2xl p-8 relative overflow-hidden">
            <button onclick="document.getElementById('auth-overlay').style.display='none'" class="absolute top-4 right-4 text-gray-400 hover:text-white z-50 p-2"><i class="fas fa-times text-xl"></i></button>
            <div class="text-center mb-8">
                <img src="https://files.catbox.moe/ap1lh0.png" alt="Logo" class="h-16 mx-auto mb-4 drop-shadow-[0_0_10px_rgba(249,115,22,0.5)]">
                <h2 class="text-2xl font-bold font-[Poppins] text-white">Bienvenido</h2>
                <p class="text-gray-400 text-xs mt-2">Inicia sesi√≥n para interactuar y ver perfiles.</p>
                <div class="flex justify-center gap-4 mt-4 text-sm font-semibold">
                    <button id="tab-login" class="text-orange-500 border-b-2 border-orange-500 pb-1 transition-colors" onclick="switchAuthTab('login')">Iniciar Sesi√≥n</button>
                    <button id="tab-register" class="text-gray-400 pb-1 hover:text-white transition-colors" onclick="switchAuthTab('register')">Registrarse</button>
                </div>
            </div>
            <form id="login-form" class="flex flex-col gap-4">
                <div class="space-y-1"><label class="text-xs text-gray-400 ml-1">Correo</label><input type="email" id="login-email" class="input-field w-full rounded-lg px-4 py-3 text-white" required></div>
                <div class="space-y-1"><label class="text-xs text-gray-400 ml-1">Contrase√±a</label><input type="password" id="login-password" class="input-field w-full rounded-lg px-4 py-3 text-white" required></div>
                <button type="submit" id="btn-login-submit" class="btn-primary w-full py-3 rounded-lg font-bold text-white mt-2 shadow-lg">Entrar</button>
                <p id="login-error" class="text-red-400 text-xs text-center mt-2 hidden"></p>
            </form>
            <form id="register-step-1" class="flex flex-col gap-4 hidden-step" style="display: none;">
                <div class="space-y-1"><label class="text-xs text-gray-400">Usuario</label><input type="text" id="reg-name" class="input-field w-full rounded-lg px-4 py-3 text-white" required></div>
                <div class="space-y-1"><label class="text-xs text-gray-400">Edad</label><input type="number" id="reg-age" class="input-field w-full rounded-lg px-4 py-3 text-white" required></div>
                <div class="space-y-1"><label class="text-xs text-gray-400">Foto</label><div class="relative w-full"><input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleAuthFileUpload(event)"><label for="file-upload" class="flex items-center gap-3 w-full input-field rounded-lg px-4 py-3 cursor-pointer"><div class="w-10 h-10 rounded-full bg-gray-700 overflow-hidden"><img id="auth-preview-img" src="https://placehold.co/100x100/333/fff?text=Foto" class="w-full h-full object-cover"></div><div class="flex-1"><span class="text-sm text-gray-300">Subir imagen</span><span class="text-[10px] text-gray-500 block" id="upload-status">Max 5MB</span></div><i class="fas fa-camera text-gray-400"></i></label></div><input type="hidden" id="reg-photo-url"></div>
                <button type="button" id="btn-step-1" onclick="validateAuthStep1()" class="btn-primary w-full py-3 rounded-lg font-bold text-white mt-2">Continuar</button>
                <p id="step1-error" class="text-red-400 text-xs text-center mt-2 hidden"></p>
            </form>
            <form id="register-step-2" class="flex flex-col gap-4 hidden-step" style="display: none;">
                <div class="space-y-1"><label class="text-xs text-gray-400">Correo</label><input type="email" id="reg-email" class="input-field w-full rounded-lg px-4 py-3 text-white" required></div>
                <div class="space-y-1"><label class="text-xs text-gray-400">Contrase√±a</label><input type="password" id="reg-password" class="input-field w-full rounded-lg px-4 py-3 text-white" required></div>
                <div class="space-y-1"><label class="text-xs text-gray-400">Confirmar</label><input type="password" id="reg-confirm-password" class="input-field w-full rounded-lg px-4 py-3 text-white" required></div>
                <div class="flex gap-2 mt-2"><button type="button" onclick="authBackToStep1()" class="w-1/3 py-3 rounded-lg text-gray-400 border border-gray-600">Atr√°s</button><button type="submit" id="btn-register-final" class="btn-primary w-2/3 py-3 rounded-lg font-bold text-white">Finalizar</button></div>
                <p id="reg-error" class="text-red-400 text-xs text-center mt-2 hidden"></p>
            </form>
        </div>
    </div>

    <!-- Modal Edad -->
    <div id="age-alert-modal" class="fixed inset-0 z-[10000] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm" style="display: none;">
        <div class="bg-gray-900 border border-red-500/50 rounded-2xl p-6 max-w-sm w-full text-center shadow-[0_0_30px_rgba(239,68,68,0.3)]">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4 animate-pulse"></i>
            <h3 class="text-xl font-bold text-white mb-2">Acceso Restringido</h3>
            <p class="text-gray-300 mb-6">Plataforma para mayores de 18 a√±os.</p>
            <button onclick="document.getElementById('age-alert-modal').style.display='none'" class="w-full py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg font-semibold">Entendido</button>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div id="app-content" style="display: block;">
        
        <div id="warning-overlay" class="fixed inset-0 z-[2000] flex flex-col items-center justify-center bg-gray-950/90 p-4 text-center backdrop-blur-sm" style="display: none;">
            <h1 class="mb-6 text-3xl font-bold text-orange-500 flex items-center gap-3 animate-pulse"><i class="fas fa-exclamation-triangle"></i> +18</h1>
            <p class="mb-8 max-w-md text-lg text-gray-300">Contenido sensible. +18 a√±os requerido.</p>
            <div class="flex flex-col sm:flex-row gap-4">
                <button class="w-full rounded-full bg-orange-600 px-8 py-3 font-semibold text-white hover:bg-orange-500" onclick="acceptWarning()">S√≠, soy mayor</button>
                <button class="w-full rounded-full bg-gray-700 px-8 py-3 font-semibold text-white hover:bg-gray-600" onclick="rejectWarning()">Salir</button>
            </div>
        </div>
        
        <main class="container mx-auto px-2 sm:px-4">
            
            <!-- HEADER -->
            <header class="pt-4 pb-2 flex justify-center relative z-40">
                <div id="user-profile-container">
                    <div class="user-profile-btn" onclick="if(requireLogin(event)) openConfigModal()">
                        <img id="header-user-img" src="https://placehold.co/100x100/333/fff?text=U" alt="Perfil">
                    </div>
                </div>
                <div class="flex items-center gap-3 bg-gray-900/80 border border-gray-700/50 px-5 py-1.5 rounded-full shadow-lg backdrop-blur-md">
                    <img src="https://files.catbox.moe/ap1lh0.png" alt="exen-E Logo" class="h-9 w-auto drop-shadow-[0_0_3px_rgba(249,115,22,0.8)]">
                    <div class="h-4 w-[1px] bg-gray-700"></div>
                    <span class="text-xs font-bold tracking-widest text-gray-400" style="font-family: var(--title-font);">ART GALLERY</span>
                </div>
                <div class="absolute top-1 right-2 sm:right-4 flex flex-col items-center justify-center">
                    <div class="status-dot" style="width: 10px; height: 10px; background-color: #22c55e; border-radius: 50%; animation: pulse-green 2s infinite; margin-bottom: 2px;"></div>
                    <span id="visit-count-display" class="text-[10px] font-bold text-gray-400 tracking-wide leading-none">...</span>
                </div>
            </header>

            <!-- HERO BANNER -->
            <div id="hero-wrapper" class="hero-wrapper">
                <div id="hero-slides-container" class="w-full h-full relative"></div>
                <div id="hero-indicators" class="hero-indicators"></div>
                <div class="hero-bottom-gradient"></div>
                <form id="search-form" class="absolute bottom-0 left-0 w-full flex justify-center pb-4 z-50 px-4">
                    <div class="relative w-full max-w-xl">
                        <input type="text" id="search-input" placeholder="Buscar usuarios o arte..." class="w-full rounded-full border-2 border-white/20 bg-black/50 backdrop-blur-md py-3 pl-5 pr-24 text-white transition placeholder:text-gray-300 focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500/50">
                        <button type="button" id="clear-search-btn" class="absolute inset-y-0 right-12 hidden items-center justify-center w-12 text-gray-300 hover:text-orange-500"><i class="fas fa-times text-xl"></i></button>
                        <button type="submit" class="absolute inset-y-0 right-0 flex items-center justify-center w-12 text-orange-500 hover:text-orange-400"><i class="fas fa-search text-xl"></i></button>
                    </div>
                </form>
            </div>

            <!-- CATEGOR√çAS -->
            <div class="flex justify-center mb-8 relative z-30">
                <div class="dropdown">
                    <button class="menu-btn w-full justify-center sm:w-auto" id="categories-toggle">
                        Categor√≠as <i class="fas fa-chevron-down text-xs ml-1 transition-transform duration-300" id="cat-arrow"></i>
                    </button>
                    <div class="dropdown-content" id="categories-dropdown">
                        <div class="categories-horizontal">
                            <a href="categoria.html?cat=anime" class="category-circle cat-anime">Anime</a>
                            <a href="categoria.html?cat=furry" class="category-circle cat-furry">Furry</a>
                            <a href="categoria.html?cat=realismo" class="category-circle cat-realismo">Realismo</a>
                            <a href="categoria.html?cat=mecas" class="category-circle cat-mecas">Mecas</a>
                            <a href="categoria.html?cat=devils" class="category-circle cat-devils">Devils</a>
                            <a href="categoria.html?cat=colors" class="category-circle cat-colors">ColorFull</a>
                            <a href="categoria.html?cat=amateur" class="category-circle cat-amateur">Amateur</a>
                            <a href="categoria.html?cat=tvgames" class="category-circle cat-tvgames">TV & Games</a>
                        </div>
                        <div class="text-center mt-3 text-xs text-gray-400">Desliza para ver m√°s <i class="fas fa-arrow-right ml-1"></i></div>
                    </div>
                </div>
            </div>

            <div id="search-results-container" class="hidden">
                <div id="search-results-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 md:gap-4"></div>
                <div id="search-pagination" class="mt-8 flex items-center justify-center gap-4"></div>
            </div>

            <div id="main-content-sections">
                
                <!-- SECCI√ìN PARA TI (REDUCIDA) -->
                <section id="for-you-section" class="mb-10">
                    <h3 class="font-[Poppins] text-lg font-bold text-white mb-4 tracking-wide">PARA TI</h3>
                    <div id="for-you-grid" class="grid grid-cols-3 gap-3 md:gap-4"></div>
                </section>
                
                <!-- SECCI√ìN COMUNIDAD (REEMPLAZA POPULARES) -->
                <section id="community-section" class="mb-12">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-[Poppins] text-lg font-bold text-white tracking-wide">COMUNIDAD</h3>
                        <a href="feed.html" class="text-xs text-orange-500 hover:text-orange-300 font-semibold transition">Ver todo</a>
                    </div>
                    
                    <!-- Contenedor Horizontal de la comunidad -->
                    <div id="community-grid" class="flex gap-4 overflow-x-auto pb-4 scrollbar-hide snap-x snap-mandatory">
                        <!-- CTA PARA NO LOGUEADOS (Inyectado por JS si aplica) -->
                    </div>
                </section>

                <div class="pt-2">
                    <h3 class="font-[Poppins] text-lg font-bold text-white mb-6 tracking-wide">GALER√çA</h3>
                </div>
            </div>

            <section id="gallery">
                <div id="error-message" class="rounded-lg bg-red-900/50 p-4 text-center text-red-300" style="display: none;"></div>
                <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 md:gap-4"></div>
                
                <!-- GATE DE REGISTRO (SCROLL BLOQUEADO) -->
                <div id="gallery-register-gate">
                    <div class="max-w-md mx-auto bg-[#1a1a1c] border border-orange-500/30 rounded-2xl p-6 shadow-2xl relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-600 to-orange-400"></div>
                        <i class="fas fa-lock text-4xl text-orange-500 mb-3"></i>
                        <h3 class="text-xl font-bold text-white mb-2">¬°Descubre m√°s!</h3>
                        <p class="text-gray-400 text-sm mb-4">Reg√≠strate gratis para desbloquear la galer√≠a completa, dar likes y comentar.</p>
                        <button onclick="document.getElementById('auth-overlay').style.display='flex'; switchAuthTab('register')" class="w-full py-3 rounded-full bg-gradient-to-r from-orange-600 to-orange-500 text-white font-bold shadow-lg hover:scale-105 transition transform">Crear Cuenta</button>
                    </div>
                </div>

                <div id="loader" class="py-12 grid grid-cols-2 sm:grid-cols-3 gap-3 md:gap-4" style="display: none;"></div>
                <div id="load-more-trigger" class="h-10"></div>
            </section>
        </main>
        
        <!-- MODAL VISOR -->
        <div id="modal" class="fixed inset-0">
            <img id="modal-backdrop" src="" class="modal-backdrop-blur" alt="">
            <div class="absolute top-4 right-4 z-[2010] flex gap-3">
                 <button id="close-modal" class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-800/80 text-gray-300 hover:bg-gray-700 hover:text-white transition border border-gray-700 shadow-lg backdrop-blur-md"><i class="fas fa-times text-lg"></i></button>
            </div>
            <button id="prev-image" class="absolute left-2 md:left-8 top-1/2 -translate-y-1/2 z-[2010] h-14 w-14 flex items-center justify-center rounded-full bg-gray-800/50 hover:bg-gray-700 text-white transition backdrop-blur-sm border border-gray-700/50"><i class="fas fa-chevron-left text-xl"></i></button>
            <button id="next-image" class="absolute right-2 md:right-8 top-1/2 -translate-y-1/2 z-[2010] h-14 w-14 flex items-center justify-center rounded-full bg-gray-800/50 hover:bg-gray-700 text-white transition backdrop-blur-sm border border-gray-700/50"><i class="fas fa-chevron-right text-xl"></i></button>

            <div id="modal-content" class="h-full w-full overflow-y-auto bg-black/30 relative z-10 backdrop-blur-none">
                <div class="container mx-auto flex min-h-full max-w-5xl flex-col items-center justify-center px-2 py-12 md:px-6">
                    <div class="w-full text-center mb-4 md:mb-6">
                        <h2 id="title" class="font-bold text-2xl md:text-3xl text-white tracking-tight font-[Poppins] drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)]"></h2>
                        <p id="modal-subtitle" class="text-sm text-orange-400 mt-1 font-semibold hidden"></p>
                    </div>
                    <div id="image-container" class="viewer-frame relative w-full bg-[#111]/50 aspect-[2/3] md:aspect-auto md:min-h-[80vh] flex items-center justify-center rounded-xl border border-white/10 shadow-2xl overflow-hidden backdrop-blur-md"></div>
                    <div class="w-full max-w-3xl mt-8 flex flex-col gap-6">
                        <div class="relative z-20 flex justify-center">
                            <div id="reaction-circle-container" class="relative">
                                <div class="relative flex items-center justify-center">
                                    <div id="reaction-bg" class="absolute inset-[-30px] rounded-full bg-gray-900/90 transition-transform duration-300 scale-0 -z-10 border border-gray-700"></div>
                                    <div class="reaction-circle-item absolute" style="--transform-pos: translateX(-65px) translateY(-10px);"><span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="like">‚ù§Ô∏è</span></div>
                                    <div class="reaction-circle-item absolute" style="--transform-pos: translateX(-45px) translateY(-55px);"><span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="hot">üî•</span></div>
                                    <div class="reaction-circle-item absolute" style="--transform-pos: translateX(0px) translateY(-70px);"><span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="wow">üòØ</span></div>
                                    <div class="reaction-circle-item absolute" style="--transform-pos: translateX(45px) translateY(-55px);"><span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="laugh">üòÇ</span></div>
                                    <div class="reaction-circle-item absolute" style="--transform-pos: translateX(65px) translateY(-10px);"><span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="sad">üò¢</span></div>
                                    <div class="reaction-circle-item absolute" style="--transform-pos: translateX(0px) translateY(55px);"><span class="reaction cursor-pointer text-4xl transition hover:scale-125" data-type="sexy">ü´¶</span></div>
                                    <button id="like-btn" class="relative z-10 flex h-16 w-16 items-center justify-center rounded-full bg-gradient-to-br from-orange-500 to-orange-600 text-white shadow-lg transition-transform active:scale-95"><i class="fas fa-heart text-3xl"></i></button>
                                </div>
                            </div>
                        </div>
                        <div id="reaction-counts-container" class="flex flex-wrap items-center justify-center gap-x-6 gap-y-2 text-gray-200 font-medium drop-shadow-md"></div>
                        <div class="bg-black/60 border border-white/10 rounded-xl p-5 text-center backdrop-blur-md"><p id="desc" class="text-gray-200 leading-relaxed"></p></div>
                        <section id="similar-section" class="w-full pt-4 border-t border-white/10"><h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-images"></i> Relacionados</h3><div id="similar-grid" class="flex gap-4 pb-4 overflow-x-auto scrollbar-hide"></div></section>
                        <section id="comments-section" class="w-full pt-4"><h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-comments"></i> Comentarios</h3><form id="comment-form" class="mb-6 flex flex-col gap-3 rounded-xl bg-black/60 border border-white/10 p-4 sm:flex-row backdrop-blur-md"><input type="text" id="name-input" placeholder="Nombre" class="w-full rounded-lg border border-gray-600 bg-black/50 px-4 py-3 text-white sm:w-1/3 focus:border-orange-500 focus:outline-none"><input type="text" id="comment-input" placeholder="Comentario..." class="flex-grow rounded-lg border border-gray-600 bg-black/50 px-4 py-3 text-white focus:border-orange-500 focus:outline-none"><button type="submit" id="comment-btn" class="rounded-lg bg-orange-600 px-6 py-3 font-semibold text-white hover:bg-orange-500"><i class="fas fa-paper-plane"></i></button></form><div id="comments" class="flex flex-col gap-4"></div></section>
                        <div class="h-20"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL CONFIG -->
        <div id="config-modal">
            <div class="config-card p-6 flex flex-col gap-4">
                <h3 class="text-xl font-bold text-white mb-2 border-b border-gray-700 pb-2">Configuraci√≥n</h3>
                <div class="flex flex-col items-center gap-4">
                    <div class="relative w-24 h-24 group cursor-pointer">
                        <img id="config-preview-img" src="https://placehold.co/100x100/333/fff?text=Foto" class="w-full h-full rounded-full object-cover border-2 border-gray-600 group-hover:border-orange-500 transition">
                        <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i class="fas fa-camera text-white text-xl"></i></div>
                        <input type="file" id="config-file-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleConfigImageSelect(event)">
                    </div>
                    <p id="config-upload-status" class="text-xs text-gray-400">Toca para cambiar imagen</p>
                </div>
                <div class="flex gap-2 mt-4"><button id="btn-save-config" onclick="saveNewProfilePic()" class="w-full bg-orange-600 hover:bg-orange-500 text-white rounded py-2 font-bold transition">Guardar</button><button onclick="closeConfigModal()" class="w-full bg-gray-700 hover:bg-gray-600 text-white rounded py-2 transition">Cancelar</button></div>
                 <button onclick="logoutUser()" class="w-full mt-2 text-red-400 hover:text-red-300 text-sm underline">Cerrar Sesi√≥n</button>
            </div>
        </div>
        
        <button id="scrollToTopBtn" class="fixed bottom-[90px] right-5 h-12 w-12 rounded-full bg-orange-600/80 text-white shadow-lg backdrop-blur-sm z-[100]" title="Ir arriba"><i class="fas fa-arrow-up"></i></button>
        <footer class="mt-12 py-8 text-center text-gray-500"><p class="mt-2 text-sm">&copy; 2025 exen-E. Todos los derechos reservados.</p></footer>

        <nav class="bottom-nav fixed bottom-0 left-0 right-0 z-[100] flex h-20 justify-around items-center px-2">
            <a href="index.html" class="nav-item active flex flex-col items-center justify-center text-center px-2 w-1/3 touch-feedback"><i class="fas fa-th-large text-xl mb-1"></i><span class="text-[10px] font-semibold">Galer√≠a</span></a>
            <a href="feed.html" onclick="return requireLogin(event)" class="nav-item flex flex-col items-center justify-center text-center px-2 w-1/3 touch-feedback"><i class="fas fa-globe-americas text-xl mb-1"></i><span class="text-[10px] font-semibold">Social</span></a>
            <a href="profile.html" onclick="return requireLogin(event)" class="nav-item flex flex-col items-center justify-center text-center px-2 w-1/3 touch-feedback"><i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-semibold">Perfil</span></a>
        </nav>
    </div>

    <script>
        "use strict";
        const firebaseConfig = { apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8", authDomain: "exene-53e6b.firebaseapp.com", databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com", projectId: "exene-53e6b", storageBucket: "exene-53e6b.appspot.com", messagingSenderId: "481369419867", appId: "1:481369419867:web:ac5db24c436344262c8f7e" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const CATBOX_USERHASH = "341adb9d3c2d09d0485aa908c";

        let currentUser = null; 
        let deviceID = localStorage.getItem('deviceID'); 
        if (!deviceID) { deviceID = Math.random().toString(36).substring(2) + Date.now().toString(36); localStorage.setItem('deviceID', deviceID); }
        
        let userDataCache = {};
        let isUploadingAuth = false;
        
        // SCROLL CONTROL VARS
        const imagesPerLoad = 21; 
        let allImages = []; 
        let fullGalleryCache = []; 
        let usersCache = []; 
        let feedCache = [];  
        let unifiedGalleryData = []; 
        let isLoading = false; 
        let noMoreImages = false; 
        
        // Infinite Scroll Logic Vars
        let scrollLoadCount = 0;
        const MAX_GUEST_LOADS = 1; // Cu√°ntas veces carga el invitado antes de bloqueo

        let currentImageId = ''; 
        let currentImageIndex = -1;
        let userReactions = {}; 
        let allReactionCounts = {}; 
        let currentSearchResults = []; 
        let searchCurrentPage = 1; 
        const searchResultsPerPage = 21; 
        let touchStartX = 0; 
        let touchEndX = 0; 
        const swipeThreshold = 50;
        let viewStartTime = 0;
        let currentViewingId = null;
        let currentContext = 'gallery'; 
        let adminUserId = null;

        // --- AUTH & INIT ---
        auth.onAuthStateChanged(user => {
            const loader = document.getElementById('initial-loader');
            const authOverlay = document.getElementById('auth-overlay');
            const appContent = document.getElementById('app-content');

            if (user && !user.isAnonymous) {
                currentUser = user;
                authOverlay.style.display = 'none';
                appContent.style.display = 'block';
                loadUserProfile(user.uid);
                document.getElementById('gallery-register-gate').style.display = 'none';
            } else {
                currentUser = null;
                authOverlay.style.display = 'none'; 
                appContent.style.display = 'block';
            }

            if (loader) { loader.style.opacity = '0'; setTimeout(() => { loader.style.display = 'none'; }, 500); }
            
            if(feedCache.length > 0) renderCommunitySection();
        });

        // *** CORRECCI√ìN CARGA INFINITA DEL LOGO ***
        setTimeout(() => {
            const loader = document.getElementById('initial-loader');
            if (loader && loader.style.display !== 'none') {
                loader.style.opacity = '0';
                setTimeout(() => { loader.style.display = 'none'; }, 500);
            }
        }, 3500); 

        document.addEventListener('DOMContentLoaded', () => { 
            const warningOverlay = document.getElementById('warning-overlay'); 
            if (!localStorage.getItem('adultConsent')) { warningOverlay.style.display = 'flex'; } 
            else { initializeApp(); } 
        });
        function acceptWarning() { localStorage.setItem('adultConsent', 'true'); document.getElementById('warning-overlay').style.display = 'none'; initializeApp(); }
        function rejectWarning() { window.location.href = 'https://www.google.com'; }
        
        async function initializeApp() {
            await cacheAllDataForSearch(); 
            loadHeroBanner(); 
            handleVisitCounter();
            await Promise.all([ fetchUserReactions(), cacheAllReactionCounts(), loadCategoryBanners() ]);
            
            loadInitialImages();
            loadForYouImages(); 
            renderCommunitySection(); 
            
            setupIntersectionObserver();
            setupEventListeners();
        }

        function handleVisitCounter() {
            const visitStatsRef = db.ref('siteStats/totalVisits');
            if (!sessionStorage.getItem('visitCounted')) {
                visitStatsRef.transaction(currentVisits => (currentVisits || 0) + 1);
                sessionStorage.setItem('visitCounted', 'true');
            }
            visitStatsRef.on('value', snapshot => {
                const count = snapshot.val() || 0;
                document.getElementById('visit-count-display').textContent = count >= 1000 ? (count / 1000).toFixed(1) + 'k' : count;
            });
        }

        async function loadCategoryBanners() {
            const bannersSnap = await db.ref('categoryBanners').once('value');
            if (!bannersSnap.exists()) return;
            const banners = bannersSnap.val();
            for (const key in banners) { const element = document.getElementById(`cat-btn-${key}`); if (element && banners[key]) element.style.backgroundImage = `url('${banners[key]}')`; }
        }

        // --- DATA CACHING ---
        async function cacheAllDataForSearch() { 
            // Galer√≠a
            const snapshot = await db.ref('images').once('value'); 
            if (snapshot.exists()) { 
                const allData = []; 
                snapshot.forEach(child => { allData.push({ id: child.key, type: 'gallery', ...child.val() }); }); 
                fullGalleryCache = allData; 
            } 
            // Usuarios
            const userSnap = await db.ref('users').once('value');
            if (userSnap.exists()) {
                const uData = [];
                userSnap.forEach(child => { 
                    const userData = child.val();
                    uData.push({ id: child.key, type: 'user', ...userData }); 
                    if (userData.email === 'ezequiel@exen.com') adminUserId = child.key;
                });
                usersCache = uData;
            }
            // Feed
            const feedSnap = await db.ref('feed_posts').once('value');
            if (feedSnap.exists()) {
                const fData = [];
                feedSnap.forEach(child => { 
                    const post = child.val();
                    if (post.imageUrl) { 
                        fData.push({ 
                            id: child.key, type: 'feed', url: post.imageUrl, thumbnailUrl: post.imageUrl,
                            title: post.title || 'Sin t√≠tulo', desc: post.text, tags: post.tags ? post.tags.split(',').map(t=>t.trim()) : [],
                            category: post.category, user: { name: post.userName, avatar: post.userAvatar, id: post.userId },
                            userId: post.userId, timestamp: post.timestamp
                        }); 
                    }
                });
                feedCache = fData;
            }
            unifiedGalleryData = [...fullGalleryCache, ...feedCache].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            fullGalleryCache.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            feedCache.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        }
        
        async function fetchUserReactions() { 
            const userId = currentUser && !currentUser.isAnonymous ? currentUser.uid : deviceID;
            const snapshot = await db.ref('reactions').once('value'); 
            const allReactions = snapshot.val() || {}; 
            userReactions = {}; 
            Object.keys(allReactions).forEach(imgId => { if(allReactions[imgId][userId]) userReactions[imgId] = allReactions[imgId][userId]; }); 
        }

        async function cacheAllReactionCounts() { 
            const reactionsSnap = await db.ref('reactions').once('value'); 
            const reactions = reactionsSnap.val() || {}; 
            const counts = {}; 
            Object.entries(reactions).forEach(([imgId, users]) => { counts[imgId] = Object.keys(users).length; }); 
            allReactionCounts = counts; 
        }

        // --- RENDERIZADO DE SECCIONES ---

        // 1. COMUNIDAD (Reemplaza Populares)
        function renderCommunitySection() {
            const container = document.getElementById('community-grid');
            container.innerHTML = '';

            if (!currentUser) {
                const cta = document.createElement('div');
                cta.className = "cta-card cursor-pointer group";
                cta.onclick = () => { document.getElementById('auth-overlay').style.display='flex'; switchAuthTab('register'); };
                cta.innerHTML = `
                    <div class="w-14 h-14 rounded-full bg-orange-500/20 flex items-center justify-center mb-3 group-hover:scale-110 transition"><i class="fas fa-user-plus text-2xl text-orange-500"></i></div>
                    <h4 class="text-white font-bold text-lg mb-1">¬°√önete!</h4>
                    <p class="text-gray-400 text-xs mb-4 leading-relaxed">Comparte tu arte, recibe likes y conecta con otros.</p>
                    <span class="text-xs font-bold text-orange-400 bg-orange-900/30 px-4 py-2 rounded-full border border-orange-500/30 group-hover:bg-orange-500 group-hover:text-white transition">Crear Cuenta</span>
                `;
                container.appendChild(cta);
            }

            const recentFeed = feedCache.slice(0, 12);
            recentFeed.forEach(post => {
                const card = document.createElement('div');
                card.className = "relative min-w-[160px] w-[160px] h-[220px] rounded-xl overflow-hidden flex-shrink-0 snap-start cursor-pointer group border border-gray-800 hover:border-orange-500/50 transition-all";
                const profileUrl = `profile.html?uid=${post.userId}`;
                
                // PROTECCI√ìN: CUALQUIER CLICK REQUIERE LOGIN
                card.onclick = (e) => {
                    e.stopPropagation();
                    if(requireLogin(e)) window.location.href = profileUrl;
                };

                card.innerHTML = `
                    <img src="${post.thumbnailUrl}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110 group-hover:opacity-60" loading="lazy">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-80"></div>
                    <div class="absolute bottom-3 left-3 right-3">
                        <div class="flex items-center gap-2 user-link transition hover:opacity-80">
                            <img src="${post.user.avatar || 'https://placehold.co/50'}" class="w-8 h-8 rounded-full border border-orange-500 object-cover">
                            <div class="overflow-hidden"><p class="text-white text-xs font-bold truncate">${post.user.name}</p><p class="text-[10px] text-gray-400 truncate">Ver perfil</p></div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 2. PARA TI (Reducido)
        async function loadForYouImages() {
            const grid = document.getElementById('for-you-grid');
            generateSkeletons(grid, 6);
            let prefs = JSON.parse(localStorage.getItem('exen_user_prefs')) || { tagScores: {} };
            const tagScores = prefs.tagScores || {};
            let scoredImages = fullGalleryCache.map(img => {
                let score = 0;
                if (img.tags) { img.tags.forEach(tag => { const normTag = normalize(tag); if (tagScores[normTag]) score += tagScores[normTag]; }); }
                score += Math.random() * 5; return { img, score };
            });
            scoredImages.sort((a, b) => b.score - a.score);
            let candidates = scoredImages.slice(0, 40).map(item => item.img);
            for (let i = Math.min(candidates.length, 10) - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
            }
            const finalSelection = candidates.slice(0, 6);
            displaySearchResults(finalSelection, 'for-you-grid');
        }

        // 3. GALER√çA & SCROLLING
        function loadInitialImages() { 
            if (isLoading) return; 
            isLoading = true; 
            const grid = document.getElementById('grid'); 
            generateSkeletons(grid, imagesPerLoad); 
            allImages = unifiedGalleryData.slice(0, imagesPerLoad); 
            if (allImages.length > 0) displaySearchResults(allImages, 'grid'); 
            else grid.innerHTML = ''; 
            isLoading = false; 
        }

        function loadMoreImages() { 
            if (isLoading || noMoreImages) return; 
            if (!currentUser) {
                if (scrollLoadCount >= MAX_GUEST_LOADS) {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('gallery-register-gate').style.display = 'block';
                    noMoreImages = true; 
                    return;
                }
            }
            isLoading = true; 
            const loaderContainer = document.getElementById('loader'); 
            loaderContainer.style.display = 'grid'; 
            generateSkeletons(loaderContainer, 3); 
            const currentLoadedCount = allImages.length; 
            const newImages = unifiedGalleryData.slice(currentLoadedCount, currentLoadedCount + imagesPerLoad); 
            if (newImages.length === 0) { noMoreImages = true; } 
            else { allImages = allImages.concat(newImages); displaySearchResults(newImages, 'grid', true); scrollLoadCount++; } 
            loaderContainer.style.display = 'none'; 
            isLoading = false; 
        }

        // --- HERO BANNER LOGIC ---
        function loadHeroBanner() {
            const recentImages = fullGalleryCache.slice(0, 4);
            const container = document.getElementById('hero-slides-container');
            const indicatorsContainer = document.getElementById('hero-indicators');
            const heroWrapper = document.getElementById('hero-wrapper');
            if (recentImages.length === 0) return;
            heroWrapper.style.display = 'block';
            container.innerHTML = '';
            indicatorsContainer.innerHTML = '';
            recentImages.forEach((img, index) => {
                const slide = document.createElement('div');
                slide.className = `hero-slide ${index === 0 ? 'active' : ''}`;
                slide.setAttribute('onclick', `if(requireLogin(event)) openModal('${img.id}')`);
                const displayUrl = img.thumbnailUrl || img.url; 
                const loadMode = index === 0 ? 'eager' : 'lazy';
                slide.innerHTML = `<img src="${displayUrl}" alt="${img.title}" loading="${loadMode}" class="hero-bg-img"><div class="hero-overlay"><div class="hero-content"><span class="text-orange-500 font-bold tracking-wider uppercase mb-1 text-[10px] sm:text-xs block">DESTACADO</span><h2 class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-white leading-tight mb-2 uppercase drop-shadow-lg truncate">${img.title}</h2><p class="text-gray-300 text-xs sm:text-sm line-clamp-2 mb-4 drop-shadow-md max-w-lg leading-relaxed">${img.desc || 'Sin descripci√≥n disponible.'}</p><div class="flex gap-3"><button class="px-4 py-1.5 bg-white text-black rounded-full font-bold hover:bg-gray-200 transition-all text-xs sm:text-sm">Ver Ahora</button></div></div></div><div class="hero-floating-card"><img src="${displayUrl}" class="hero-floating-img"></div>`;
                container.appendChild(slide);
                const dot = document.createElement('div');
                dot.className = `hero-dot ${index === 0 ? 'active' : ''}`;
                dot.addEventListener('click', (e) => { e.stopPropagation(); manualSlide(index); });
                indicatorsContainer.appendChild(dot);
            });
            startHeroInterval();
        }
        
        let heroInterval;
        function startHeroInterval() {
            if (heroInterval) clearInterval(heroInterval);
            heroInterval = setInterval(() => {
                const slides = document.querySelectorAll('.hero-slide');
                if(slides.length === 0) return;
                let current = 0;
                slides.forEach((s, i) => { if(s.classList.contains('active')) current = i; });
                const next = (current + 1) % slides.length;
                manualSlide(next);
            }, 6000);
        }
        function manualSlide(index) {
            const slides = document.querySelectorAll('.hero-slide');
            const dots = document.querySelectorAll('.hero-dot');
            if (!slides.length) return;
            slides.forEach(s => s.classList.remove('active'));
            dots.forEach(d => d.classList.remove('active'));
            slides[index].classList.add('active');
            dots[index].classList.add('active');
        }

        // --- RENDERIZADO GEN√âRICO (Usuarios + Im√°genes) ---
        function displaySearchResults(items, containerId, append = false) { 
            const grid = document.getElementById(containerId); 
            if (!append) grid.innerHTML = ''; 
            if (items.length === 0 && !append) { grid.innerHTML = `<div class="col-span-full w-full text-center py-8 text-gray-400">No se encontraron resultados.</div>`; return; } 
            items.forEach((item, index) => { 
                if (!item) return;
                
                // --- RENDERIZADO DE USUARIO ---
                if (item.type === 'user') {
                    const div = document.createElement('div');
                    div.className = "bg-[#111] border border-gray-800 rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer hover:border-orange-500 transition group aspect-[2/3] relative overflow-hidden";
                    
                    // PROTECCI√ìN: CLICK EN USUARIO REQUIERE LOGIN
                    div.onclick = (e) => { if(requireLogin(e)) window.location.href = `profile.html?uid=${item.id}`; };
                    
                    div.innerHTML = `
                        <div class="absolute top-2 right-2 bg-orange-500/20 text-orange-500 p-1 rounded-md"><i class="fas fa-user"></i></div>
                        <img src="${item.profilePic || 'https://placehold.co/100x100'}" class="w-20 h-20 rounded-full object-cover mb-3 border-2 border-gray-700 group-hover:border-orange-500 transition shadow-lg">
                        <span class="font-bold text-white text-lg truncate w-full text-center">${item.username}</span>
                        <span class="text-xs text-gray-500 uppercase tracking-wider mt-1 bg-gray-900 px-2 py-1 rounded-full">Ver Perfil</span>
                    `;
                    grid.appendChild(div);
                    return;
                }

                // --- RENDERIZADO DE IMAGEN ---
                if (!item.url) return;
                const div = document.createElement('div'); 
                div.className = 'image-item-animation group relative aspect-[2/3] overflow-hidden image-card'; 
                div.setAttribute('onclick', `if(requireLogin(event)) openModal('${item.id}')`); 
                div.style.animationDelay = `${(index * 0.05)}s`; 
                const isLiked = userReactions[item.id] === 'like'; 
                const displayUrl = item.thumbnailUrl || item.url; 
                const reactionCount = allReactionCounts[item.id] || 0; 
                const isVerified = (item.type === 'gallery') || (item.type === 'feed' && item.userId === adminUserId);
                let badgeIcon = isVerified ? `<div class="absolute top-2 left-2 z-10 bg-blue-600/90 text-white text-xs p-1.5 rounded-full shadow-md"><i class="fas fa-check-circle"></i></div>` : `<div class="absolute top-2 left-2 z-10 bg-green-600/90 text-white text-xs p-1.5 rounded-full shadow-md"><i class="fas fa-globe"></i></div>`;
                let bottomInfo = isVerified ? `<h4 class="truncate font-bold text-white text-sm">${item.title}</h4>` : `<h4 class="truncate font-bold text-white text-sm mb-1">${item.title}</h4><div class="flex items-center gap-2"><img src="${item.user.avatar}" class="w-5 h-5 rounded-full border border-white/30 object-cover"><span class="text-[10px] text-gray-300 truncate">${item.user.name}</span></div>`;
                div.innerHTML = `<img src="${displayUrl}" loading="lazy" class="h-full w-full object-cover transition duration-300 group-hover:scale-105"><div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-black/10 pointer-events-none"></div>${badgeIcon}<div class="absolute bottom-0 left-0 p-3 pointer-events-none w-full">${bottomInfo}</div>${item.type === 'gallery' ? `<button id="grid-like-btn-${item.id}" onclick="toggleReactionFromGrid('${item.id}', event)" class="absolute top-2 right-2 flex items-center gap-1.5 rounded-full bg-black/50 px-2 py-1 text-xs text-white backdrop-blur-sm touch-feedback ${isLiked ? 'liked' : ''}"><i class="fas fa-heart text-gray-300"></i><span id="reaction-count-grid-${item.id}">${reactionCount}</span></button>` : ''}`; 
                grid.appendChild(div); 
            }); 
        }

        // --- HELPERS ---
        function generateSkeletons(container, count) { container.innerHTML = ''; for (let i = 0; i < count; i++) { container.appendChild(document.createElement('div')).className = 'skeleton'; } }
        function normalize(text) { return text ? text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim() : ''; }
        function requireLogin(event) { if (!currentUser) { if(event) { event.preventDefault(); event.stopPropagation(); } document.getElementById('auth-overlay').style.display = 'flex'; return false; } return true; }
        function switchAuthTab(tab) { const l = document.getElementById('login-form'), r1 = document.getElementById('register-step-1'), r2 = document.getElementById('register-step-2'); if(tab==='login'){l.style.display='flex';r1.style.display='none';r2.style.display='none';}else{l.style.display='none';r1.style.display='flex';r2.style.display='none';} }
        
        // --- AUTH HANDLERS ---
        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err=>document.getElementById('login-error').textContent=err.message); });
        async function validateAuthStep1() { document.getElementById('register-step-1').style.display='none'; document.getElementById('register-step-2').style.display='flex'; }
        document.getElementById('register-step-2').addEventListener('submit', (e) => { e.preventDefault(); auth.createUserWithEmailAndPassword(document.getElementById('reg-email').value, document.getElementById('reg-password').value).then(c => db.ref('users/'+c.user.uid).set({username:document.getElementById('reg-name').value})).then(()=>location.reload()); });

        // --- MODAL & INTERACTION ---
        async function openModal(id) {
            if(!requireLogin()) return;
            let img = fullGalleryCache.find(i => i.id === id) || feedCache.find(i => i.id === id);
            if (!img) return;
            currentImageId = id; currentContext = img.type;
            document.getElementById('modal-backdrop').src = img.thumbnailUrl || img.url;
            document.getElementById('title').textContent = img.title;
            document.getElementById('desc').textContent = img.desc || 'Sin descripci√≥n.';
            
            // SUBT√çTULO CON LINK A PERFIL PROTEGIDO
            const subTitle = document.getElementById('modal-subtitle');
            const isVerified = (img.type === 'gallery') || (img.type === 'feed' && img.userId === adminUserId);
            if (isVerified) {
                 subTitle.innerHTML = `<div class="flex items-center justify-center gap-2 mt-2 text-blue-400 font-bold text-sm"><i class="fas fa-check-circle"></i> Galer√≠a Oficial</div>`;
                 subTitle.classList.remove('hidden');
                 subTitle.onclick = null;
            } else {
                subTitle.innerHTML = `<div class="flex items-center justify-center gap-2 cursor-pointer bg-gray-800/50 py-1 px-3 rounded-full w-fit mx-auto mt-2 border border-gray-700 hover:border-orange-500 transition"><img src="${img.user.avatar}" class="w-6 h-6 rounded-full object-cover"><span class="text-sm text-gray-300">Por: <span class="text-orange-400 font-bold">${img.user.name}</span></span></div>`;
                subTitle.classList.remove('hidden');
                // Protecci√≥n aqu√≠ tambi√©n
                subTitle.onclick = (e) => { if(requireLogin(e)) window.location.href = `profile.html?uid=${img.user.id}`; };
            }

            document.getElementById('image-container').innerHTML = `<img src="${img.url}" class="max-h-full max-w-full object-contain">`;
            loadLikes(id, currentContext); loadComments(id, currentContext); loadSimilarImages(img.tags || []);
            document.getElementById('modal').classList.add('visible'); document.body.style.overflow = 'hidden';
        }
        function closeModal() { document.getElementById('modal').classList.remove('visible'); document.body.style.overflow = 'auto'; }
        
        function toggleReactionFromGrid(imageId, event) { 
            if(!requireLogin(event)) return;
            event.stopPropagation(); 
            const userId = currentUser && !currentUser.isAnonymous ? currentUser.uid : deviceID;
            const btn = document.getElementById(`grid-like-btn-${imageId}`); 
            const countEl = document.getElementById(`reaction-count-grid-${imageId}`); 
            const reactionsRef = db.ref(`reactions/${imageId}/${userId}`); 
            reactionsRef.once('value', snap => { 
                if (snap.val() === 'like') { reactionsRef.remove(); btn.classList.remove('liked'); delete userReactions[imageId]; const newCount = Math.max(0, (allReactionCounts[imageId] || 1) - 1); allReactionCounts[imageId] = newCount; countEl.textContent = newCount; } 
                else { reactionsRef.set('like'); btn.classList.add('liked'); userReactions[imageId] = 'like'; const newCount = (allReactionCounts[imageId] || 0) + 1; allReactionCounts[imageId] = newCount; countEl.textContent = newCount; } 
            }); 
        }

        // --- FUNCIONES DE LIKES/COMENTARIOS/BUSQUEDA ---
        function loadLikes(id, context) { if(context === 'feed') { db.ref(`feed_likes/${id}`).on('value', snap => { document.getElementById('reaction-counts-container').innerHTML = `<span class="flex items-center gap-1">‚ù§Ô∏è <span class="font-bold">${snap.numChildren()}</span></span>`; }); } else { db.ref(`reactions/${id}`).on('value', snap => { const reactions = snap.val() || {}; const counts = { hot: 0, like: 0, wow: 0, sexy: 0, laugh: 0, sad: 0 }; Object.values(reactions).forEach(type => { if(counts[type] !== undefined) counts[type]++; }); document.getElementById('reaction-counts-container').innerHTML = Object.entries(counts).map(([type, count]) => `<span class="flex items-center gap-1">${{like:'‚ù§Ô∏è',hot:'üî•',wow:'üòØ',laugh:'üòÇ',sad:'üò¢',sexy:'ü´¶'}[type]} <span class="font-bold">${count}</span></span>`).join(''); }); } }
        function loadComments(id, context) { let path = context === 'feed' ? `feed_comments/${id}` : `comments/${id}`; db.ref(path).orderByChild('timestamp').on('value', snap => { const container = document.getElementById('comments'); container.innerHTML = !snap.exists() ? '<p class="text-center text-gray-500">S√© el primero en comentar.</p>' : ''; const comments = []; snap.forEach(child => comments.push(child.val())); comments.reverse().forEach(c => { const div = document.createElement('div'); const initial = c.name ? c.name.charAt(0).toUpperCase() : 'A'; div.innerHTML = `<div class="flex gap-3"><div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-gradient-to-br from-orange-500 to-orange-400 font-bold text-white">${initial}</div><div class="flex-grow min-w-0"><div class="rounded-2xl rounded-tl-none bg-gray-800 p-3"><p class="font-bold text-orange-400">${c.name || 'An√≥nimo'}</p><p class="text-gray-300 break-words">${c.text || ''}</p></div><small class="pl-2 pt-1 text-xs text-gray-500">${new Date(c.timestamp).toLocaleString()}</small></div></div>`; container.appendChild(div); }); }); }
        function loadSimilarImages(tags) { const grid = document.getElementById('similar-grid'); grid.innerHTML = ''; if (!tags || tags.length === 0) return; const candidates = fullGalleryCache.filter(img => img.id !== currentImageId && Array.isArray(img.tags)); const scored = candidates.map(img => { const common = img.tags.filter(tag => tags.includes(tag)); return { image: img, score: common.length }; }).filter(i => i.score > 0); scored.sort((a, b) => b.score - a.score); const similar = scored.slice(0, 10).map(i => i.image); if(similar.length > 0) displaySearchResults(similar, 'similar-grid'); }
        
        // --- BUSQUEDA GLOBAL (Usuarios + Im√°genes) ---
        function executeSearch(query) { 
            document.getElementById('main-content-sections').classList.add('hidden'); 
            document.getElementById('gallery').classList.add('hidden'); 
            document.getElementById('search-results-container').classList.remove('hidden'); 
            
            // 1. Buscar Usuarios
            const matchedUsers = usersCache.filter(u => (u.username && normalize(u.username).includes(query))); 
            
            // 2. Buscar Im√°genes Galer√≠a
            const matchedGallery = fullGalleryCache.filter(i => (i.title && normalize(i.title).includes(query)) || (i.tags && i.tags.some(t => normalize(t).includes(query))) || (i.categories && i.categories.some(c => normalize(c).includes(query)))); 
            
            // 3. Buscar Im√°genes Feed
            const matchedFeed = feedCache.filter(i => (i.title && normalize(i.title).includes(query)) || (i.tags && i.tags.some(t => normalize(t).includes(query))) || (i.category && normalize(i.category).includes(query)) || (i.user && i.user.name && normalize(i.user.name).includes(query))); 
            
            // Combinar: Usuarios primero, luego el resto
            currentSearchResults = [...matchedUsers, ...matchedGallery, ...matchedFeed]; 
            displaySearchResultsPage(1); 
        }
        
        function displaySearchResultsPage(page) { searchCurrentPage = page; const start = (page - 1) * searchResultsPerPage; const items = currentSearchResults.slice(start, start + searchResultsPerPage); displaySearchResults(items, 'search-results-grid'); renderPaginationControls(); }
        function renderPaginationControls(){ const container = document.getElementById('search-pagination'); const total = Math.ceil(currentSearchResults.length / searchResultsPerPage); container.innerHTML = ''; if (total <= 1) return; container.innerHTML = `<button onclick="displaySearchResultsPage(${searchCurrentPage - 1})" class="px-4 py-2 bg-gray-700 rounded-md" ${searchCurrentPage === 1 ? 'disabled' : ''}>Anterior</button><span>P√°gina ${searchCurrentPage} de ${total}</span><button onclick="displaySearchResultsPage(${searchCurrentPage + 1})" class="px-4 py-2 bg-gray-700 rounded-md" ${searchCurrentPage === total ? 'disabled' : ''}>Siguiente</button>`; }
        function resetSearchView(){ document.getElementById('search-input').value = ''; document.getElementById('search-results-container').classList.add('hidden'); document.getElementById('main-content-sections').classList.remove('hidden'); document.getElementById('gallery').classList.remove('hidden'); }
        
        function setupEventListeners() { 
            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.getElementById('search-form').addEventListener('submit', e => { e.preventDefault(); executeSearch(normalize(document.getElementById('search-input').value)); });
            document.getElementById('clear-search-btn').addEventListener('click', resetSearchView);
            const obs = new IntersectionObserver(e => { if(e[0].isIntersecting) loadMoreImages(); });
            obs.observe(document.getElementById('load-more-trigger'));
        }
        function setupIntersectionObserver() {} 

        // Funciones perfil
        function loadUserProfile(uid) { db.ref('users/' + uid).on('value', snap => { if (snap.exists()) { const data = snap.val(); document.getElementById('header-user-img').src = data.profilePic || 'https://placehold.co/100x100/333/fff?text=U'; } }); }
        let newProfileFile = null;
        function openConfigModal() { document.getElementById('config-modal').style.display = 'flex'; document.getElementById('config-preview-img').src = document.getElementById('header-user-img').src; document.getElementById('config-upload-status').innerHTML = 'Toca para cambiar imagen'; document.getElementById('btn-save-config').disabled = false; document.getElementById('btn-save-config').innerHTML = 'Guardar'; newProfileFile = null; }
        function closeConfigModal() { document.getElementById('config-modal').style.display = 'none'; }
        async function handleConfigImageSelect(event) { const file = event.target.files[0]; if (!file) return; if (file.size > 5 * 1024 * 1024) { alert("M√°x 5MB"); return; } newProfileFile = file; document.getElementById('config-preview-img').src = URL.createObjectURL(file); document.getElementById('config-upload-status').innerHTML = '<span class="text-orange-400 font-bold">Imagen seleccionada (No guardada a√∫n)</span>'; }
        async function saveNewProfilePic() { if (!newProfileFile) { closeConfigModal(); return; } const btn = document.getElementById('btn-save-config'); const status = document.getElementById('config-upload-status'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...'; status.innerHTML = 'Subiendo a Catbox...'; try { const formData = new FormData(); formData.append('reqtype', 'fileupload'); formData.append('userhash', CATBOX_USERHASH); formData.append('fileToUpload', newProfileFile); const res = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", { method: 'POST', body: formData }); if (!res.ok) throw new Error("Error de red"); const url = await res.text(); if (url.includes('catbox.moe')) { const finalUrl = url.trim(); if (currentUser) { await db.ref('users/' + currentUser.uid).update({ profilePic: finalUrl }); alert('Foto actualizada correctamente'); closeConfigModal(); } } else { throw new Error("Error Catbox API"); } } catch (e) { console.error(e); status.innerHTML = '<span class="text-red-500">Error al subir imagen</span>'; btn.disabled = false; btn.innerHTML = 'Reintentar'; } }
        function logoutUser() { auth.signOut().then(() => { window.location.reload(); }); }
        async function handleAuthFileUpload(event) { const file = event.target.files[0]; if (!file || file.size > 5*1024*1024) { alert("M√°x 5MB"); return; } const statusEl = document.getElementById('upload-status'); const previewImg = document.getElementById('auth-preview-img'); const btn = document.getElementById('btn-step-1'); isUploadingAuth = true; btn.disabled = true; btn.classList.add('opacity-50'); statusEl.innerHTML = '<i class="fas fa-spinner upload-spinner text-orange-500"></i> Subiendo...'; previewImg.src = URL.createObjectURL(file); try { const formData = new FormData(); formData.append('reqtype', 'fileupload'); formData.append('userhash', CATBOX_USERHASH); formData.append('fileToUpload', file); const res = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", { method: 'POST', body: formData }); if (!res.ok) throw new Error("Error red"); const url = await res.text(); if (url.includes('catbox.moe')) { document.getElementById('reg-photo-url').value = url.trim(); statusEl.innerHTML = '<span class="text-green-400"><i class="fas fa-check"></i> Listo</span>'; } else throw new Error("Error API"); } catch (e) { console.error(e); statusEl.innerHTML = '<span class="text-red-400">Error</span>'; } finally { isUploadingAuth = false; btn.disabled = false; btn.classList.remove('opacity-50'); } }
    </script>
</body>
</html>