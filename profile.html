<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>exen-E | Perfil</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuentes e Iconos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --accent: #f97316; 
            --accent-hover: #ea580c;
            --bg-dark: #09090b;
            --bg-card: #121214;
            --border-color: rgba(255, 255, 255, 0.08);
            --title-font: 'Poppins', sans-serif;
            --body-font: 'Inter', sans-serif;
            --kofi-color: #29abe0;
            --paypal-color: #00457C;
        }
        
        /* Ajustes Globales & MÃ³vil */
        html, body {
            overflow-x: hidden; width: 100%; background-color: var(--bg-dark);
            overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        body { 
            font-family: var(--body-font); 
            background-image: radial-gradient(circle at 50% 0%, rgba(249, 115, 22, 0.06) 0%, transparent 40%);
            color: #f3f4f6; padding-bottom: 90px; min-height: 100vh;
        }
        body.body-lock { overflow: hidden !important; position: fixed; width: 100%; height: 100%; top: 0; left: 0; }

        /* Scrollbars */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* UI Elements */
        #initial-loader { position: fixed; inset: 0; z-index: 10000; background-color: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .loader-logo { width: 80px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 15px rgba(249, 115, 22, 0.4)); animation: pulse 2s infinite; }
        #page-loader { position: fixed; inset: 0; background: var(--bg-dark); z-index: 5000; display: flex; align-items: center; justify-content: center; }

        .form-card { background: #18181b; border: 1px solid var(--border-color); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); width: 100%; max-width: 400px; }
        .input-field { background: rgba(0, 0, 0, 0.4); border: 1px solid var(--border-color); transition: all 0.3s ease; color: white; }
        .input-field:focus { border-color: var(--accent); outline: none; background: rgba(0,0,0,0.6); box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #f97316, #ea580c); box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3); transition: transform 0.2s; }
        .btn-primary:active { transform: scale(0.97); }

        /* Banner & Profile */
        .banner-container { position: relative; width: 100%; height: 180px; background-color: #18181b; overflow: hidden; }
        @media (min-width: 768px) { .banner-container { height: 280px; } }
        .banner-img { width: 100%; height: 100%; object-fit: cover; }
        .banner-overlay { position: absolute; inset: 0; background: linear-gradient(to top, var(--bg-dark) 0%, transparent 90%); pointer-events: none; }
        
        .banner-edit-btn { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; padding: 8px 14px; border-radius: 99px; font-size: 12px; font-weight: 600; cursor: pointer; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.15); z-index: 20; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .banner-edit-btn:active { transform: scale(0.95); background: rgba(0,0,0,0.8); }
        
        .profile-header { position: relative; margin-top: -65px; padding-bottom: 0.5rem; z-index: 10; }
        .avatar-container { position: relative; cursor: pointer; transition: transform 0.2s; -webkit-tap-highlight-color: transparent; }
        .avatar-container:active { transform: scale(0.96); }
        .edit-badge { position: absolute; bottom: 2px; right: 2px; background-color: var(--accent); border: 3px solid var(--bg-dark); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        
        /* Redes Sociales */
        .social-link { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); color: #9ca3af; transition: all 0.2s; font-size: 1.2rem; text-decoration: none; position: relative; overflow: hidden; }
        .social-link:active { transform: scale(0.95); }
        .social-link:hover { color: white; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        .social-facebook { color: #60a5fa; border-color: rgba(96, 165, 250, 0.3); background: rgba(96, 165, 250, 0.05); } .social-facebook:hover { background: #1877f2; border-color: #1877f2; }
        .social-x { color: #fff; border-color: rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.05); } .social-x:hover { background: #000; border-color: #fff; }
        .social-instagram { color: #f472b6; border-color: rgba(244, 114, 182, 0.3); background: rgba(244, 114, 182, 0.05); } .social-instagram:hover { background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); border-color: transparent; }
        .social-youtube { color: #f87171; border-color: rgba(248, 113, 113, 0.3); background: rgba(248, 113, 113, 0.05); } .social-youtube:hover { background: #ff0000; border-color: #ff0000; }
        .social-patreon { color: #fb923c; border-color: rgba(251, 146, 60, 0.3); background: rgba(251, 146, 60, 0.05); } .social-patreon:hover { background: #f96854; border-color: #f96854; }
        .social-whatsapp { color: #4ade80; border-color: rgba(74, 222, 128, 0.3); background: rgba(74, 222, 128, 0.05); } .social-whatsapp:hover { background: #25d366; border-color: #25d366; }
        .social-telegram { color: #38bdf8; border-color: rgba(56, 189, 248, 0.3); background: rgba(56, 189, 248, 0.05); } .social-telegram:hover { background: #24A1DE; border-color: #24A1DE; }
        .social-twitch { color: #c084fc; border-color: rgba(192, 132, 252, 0.3); background: rgba(192, 132, 252, 0.05); } .social-twitch:hover { background: #9146FF; border-color: #9146FF; }
        .social-yodayo { color: #38bdf8; border-color: rgba(56, 189, 248, 0.3); background: rgba(56, 189, 248, 0.05); } .social-yodayo:hover { background: #0ea5e9; border-color: #0ea5e9; }
        .social-pixai { color: #a78bfa; border-color: rgba(167, 139, 250, 0.3); background: rgba(167, 139, 250, 0.05); } .social-pixai:hover { background: #8b5cf6; border-color: #8b5cf6; }

        /* Tabs & Grid */
        .profile-tabs { display: flex; justify-content: center; align-items: center; gap: 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .tab-btn { color: #71717a; padding: 12px 24px; border-bottom: 2px solid transparent; transition: all 0.3s; font-size: 1.1rem; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .grid-item { position: relative; aspect-ratio: 1 / 1; overflow: hidden; background-color: #18181b; cursor: pointer; border-radius: 4px; }
        .grid-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; }
        .grid-item:active .grid-image { transform: scale(0.96); opacity: 0.8; }
        .grid-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 40%); display: flex; align-items: flex-end; padding: 6px; }
        
        /* SELECTION MODE OVERLAY */
        .selection-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10; animation: fadeIn 0.2s; }
        .selection-check { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; }
        .selected .selection-check { background: var(--accent); border-color: var(--accent); }
        .selected .grid-image { transform: scale(0.9); }

        /* Collections */
        .collection-card { position: relative; aspect-ratio: 1 / 1; border-radius: 12px; overflow: hidden; background: #18181b; border: 1px solid var(--border-color); cursor: pointer; transition: transform 0.2s; }
        .collection-card:active { transform: scale(0.96); }
        .collection-cover-grid { display: grid; width: 100%; height: 100%; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); gap: 1px; }
        .collection-cover-grid img { width: 100%; height: 100%; object-fit: cover; }
        .collection-cover-single { width: 100%; height: 100%; object-fit: cover; }
        .collection-info { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.95) 15%, rgba(0,0,0,0) 60%); display: flex; flex-direction: column; justify-content: flex-end; padding: 12px; pointer-events: none; }
        
        /* Post Panel */
        .upload-card { background: linear-gradient(145deg, #18181b, #121212); border: 1px solid rgba(249, 115, 22, 0.15); overflow: visible !important; }
        #extra-fields { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease; }
        #extra-fields.expanded-visible { max-height: 800px; opacity: 1; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); overflow: visible !important; }
        .custom-input { background: rgba(0,0,0,0.25); border: 1px solid var(--border-color); color: white; padding: 12px 14px; border-radius: 10px; font-size: 0.95rem; width: 100%; transition: all 0.3s; }
        .custom-input:focus { outline: none; border-color: var(--accent); background: rgba(0,0,0,0.4); }
        .tags-readonly { background: rgba(0,0,0,0.4); cursor: not-allowed; border-style: dashed; opacity: 0.8; }
        
        #preview-stack { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-top: 12px; margin-bottom: 8px; width: 100%; min-height: 0; }
        .preview-thumb { position: relative; width: 70px; height: 70px; flex-shrink: 0; border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); animation: fadeIn 0.3s ease; background-color: #222; }
        .preview-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .remove-thumb-btn { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; z-index: 10; backdrop-filter: blur(2px); }

        /* Dropdowns */
        .custom-select-container { position: relative; width: 100%; }
        .custom-select-trigger { background: rgba(0, 0, 0, 0.25); border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 12px 14px; border-radius: 10px; color: #9ca3af; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; min-height: 44px; }
        .custom-select-trigger:active, .custom-select-trigger.active { border-color: var(--accent); color: white; background: rgba(0,0,0,0.4); }
        .custom-select-options { position: absolute; top: calc(100% + 8px); left: 0; right: 0; background: #1c1c1f; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; z-index: 50; max-height: 0; overflow: hidden; opacity: 0; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.8); transform-origin: top center; transform: scaleY(0.95); }
        .custom-select-options.show { max-height: 300px; opacity: 1; overflow-y: auto; transform: scaleY(1); }
        .option-item { padding: 14px 16px; cursor: pointer; color: #d1d5db; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.03); display: flex; align-items: center; gap: 10px; }
        .option-item:active { background: rgba(249, 115, 22, 0.2); color: white; }
        
        /* Suggestions */
        .suggestions-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: rgba(24, 24, 27, 0.95); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 10px 10px; z-index: 60; max-height: 200px; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); display: none; }
        .suggestions-dropdown.visible { display: block; animation: fadeIn 0.2s ease-out; }
        .suggestion-item { padding: 10px 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .suggestion-item:active { background: rgba(249, 115, 22, 0.1); }

        /* Viewer */
        .modal-backdrop { display: none; position: fixed; inset: 0; background-color: #000; z-index: 7000; } 
        .modal-backdrop.visible { display: block; animation: fadeIn 0.3s forwards; }
        .fullscreen-mode .info-panel { display: none !important; }
        .fullscreen-mode .image-area { width: 100% !important; height: 100vh !important; flex: none !important; }
        .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); z-index: 20; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); border-radius: 50%; color: white; border: 1px solid rgba(255,255,255,0.15); cursor: pointer; transition: all 0.2s; font-size: 1.2rem; }
        .nav-arrow:active { background: var(--accent); }
        .nav-prev { left: 15px; } .nav-next { right: 15px; }
        
        /* ========================================= */
        /* === NUEVA BARRA DE SELECCIÃ“N (BOTTOM) === */
        /* ========================================= */
        #selection-bar { 
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(9, 9, 11, 0.98); 
            backdrop-filter: blur(16px);
            border-top: 1px solid var(--border-color);
            padding: 12px 20px; 
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            z-index: 4000; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            transform: translateY(100%); 
            transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.7);
        }
        #selection-bar.visible { transform: translateY(0); }
        
        /* BotÃ³n Mover */
        .move-to-album-btn {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white; border: none;
            padding: 10px 24px; border-radius: 99px;
            font-size: 0.9rem; font-weight: 700;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
            transition: all 0.2s;
        }
        .move-to-album-btn:active { transform: scale(0.95); }
        .move-to-album-btn.disabled { opacity: 0.5; filter: grayscale(1); pointer-events: none; box-shadow: none; background: #333; }
        
        /* BotÃ³n Follow */
        .profile-follow-btn {
            padding: 6px 16px; border-radius: 99px; font-size: 12px; font-weight: 700;
            transition: all 0.2s; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
            border: 1px solid transparent; display: flex; items-center; gap: 6px;
        }
        .profile-follow-btn.not-following { background: var(--accent); color: white; box-shadow: 0 2px 10px rgba(249, 115, 22, 0.3); }
        .profile-follow-btn.following { background: transparent; border-color: #444; color: #aaa; }
        .profile-follow-btn.following:hover { border-color: var(--accent); color: white; }

        /* Bottom Nav Standard */
        .bottom-nav { background-color: rgba(9, 9, 11, 0.95); backdrop-filter: blur(16px); border-top: 1px solid var(--border-color); z-index: 3000; padding-bottom: env(safe-area-inset-bottom); transition: transform 0.3s ease; }
        .bottom-nav.hidden-nav { transform: translateY(100%); }
        .nav-item { color: #71717a; transition: all 0.3s ease; }
        .nav-item.active { color: var(--accent); }
        
        /* Filter Bar */
        .filter-bar { display: none; margin-bottom: 1rem; padding: 0 0.5rem; }
        .filter-bar.visible { display: flex; }
        .filter-badge { background: rgba(249, 115, 22, 0.2); color: #fdba74; border: 1px solid rgba(249, 115, 22, 0.4); padding: 4px 12px; border-radius: 99px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }

        .hidden-step { display: none; }
        #app-content { display: none; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); pointer-events: none; }
    </style>
</head>
<body class="antialiased select-none">

    <!-- PANTALLA CARGA -->
    <div id="initial-loader">
        <img src="https://files.catbox.moe/ap1lh0.png" class="loader-logo">
        <i class="fas fa-circle-notch fa-spin text-orange-500 text-3xl"></i>
        <p id="loader-status" class="text-gray-500 text-xs mt-4 animate-pulse">Cargando perfil...</p>
    </div>

    <!-- TOAST & ALERTS -->
    <div id="toast-container" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[9000] pointer-events-none transition-all duration-300 opacity-0 translate-y-4"><div class="bg-zinc-900/95 backdrop-blur-md border border-zinc-700 px-6 py-3 rounded-full text-white font-medium shadow-2xl flex items-center gap-3"><i class="fas fa-check-circle text-green-500 text-lg"></i><span id="toast-message">AcciÃ³n completada</span></div></div>
    <div id="custom-alert" class="hidden fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm items-center justify-center p-4"><div class="bg-[#18181b] border border-zinc-800 rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl"><div class="w-14 h-14 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4 border border-red-500/20"><i class="fas fa-exclamation text-red-500 text-2xl"></i></div><h3 class="text-white font-bold text-xl mb-2">AtenciÃ³n</h3><p id="custom-alert-msg" class="text-gray-400 text-sm mb-6 leading-relaxed">Mensaje</p><button onclick="closeCustomAlert()" class="w-full bg-zinc-800 hover:bg-zinc-700 text-white py-3.5 rounded-xl font-bold transition active:scale-95">Entendido</button></div></div>
    <div id="custom-confirm" class="hidden fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm items-center justify-center p-4"><div class="bg-[#18181b] border border-zinc-800 rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl"><div class="w-14 h-14 rounded-full bg-orange-500/10 flex items-center justify-center mx-auto mb-4 border border-orange-500/20"><i class="fas fa-question text-orange-500 text-2xl"></i></div><h3 id="custom-confirm-title" class="text-white font-bold text-xl mb-2">Â¿EstÃ¡s seguro?</h3><p id="custom-confirm-msg" class="text-gray-400 text-sm mb-6 leading-relaxed">Â¿Continuar?</p><div class="flex gap-3"><button onclick="closeCustomConfirm(false)" class="flex-1 bg-zinc-800 text-gray-300 py-3 rounded-xl font-bold border border-zinc-700 active:scale-95 transition">Cancelar</button><button onclick="closeCustomConfirm(true)" class="flex-1 bg-orange-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">Confirmar</button></div></div></div>

    <!-- APP CONTENT -->
    <div id="app-content">
        <div id="page-loader"><img src="https://files.catbox.moe/ap1lh0.png" class="h-16 w-auto animate-pulse"></div>
        <div class="banner-container group">
            <img id="profile-banner-img" src="https://placehold.co/800x300/18181b/333?text=..." class="banner-img">
            <div class="banner-overlay"></div>
            <label id="banner-edit-btn" class="banner-edit-btn hidden"><i class="fas fa-camera"></i> <span>Cambiar Portada</span><input type="file" id="banner-upload-input" accept="image/*" class="hidden" onchange="handleBannerUpload(event)"></label>
            <div id="banner-loading" class="hidden absolute inset-0 bg-black/60 flex items-center justify-center z-30"><i class="fas fa-circle-notch fa-spin text-orange-500 text-3xl"></i></div>
        </div>

        <header class="profile-header px-5">
            <div class="max-w-xl mx-auto">
                <div class="flex items-end gap-5 mb-5">
                    <div class="avatar-container flex-shrink-0" id="avatar-container">
                        <div class="w-24 h-24 sm:w-28 sm:h-28 rounded-full overflow-hidden border-[5px] border-[#09090b] relative group bg-zinc-800 shadow-xl">
                            <img id="profile-image" src="https://placehold.co/150x150/333/666?text=..." class="w-full h-full object-cover">
                            <div id="avatar-loading" class="absolute inset-0 bg-black/50 hidden flex items-center justify-center"><i class="fas fa-spinner fa-spin text-white"></i></div>
                        </div>
                        <div id="edit-badge" class="edit-badge hidden"><i class="fas fa-camera text-xs"></i></div>
                        <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                    </div>

                    <div class="flex-1 pb-1 min-w-0">
                        <div class="flex flex-col">
                            <h2 id="username-display" class="text-2xl font-bold text-white font-[Poppins] truncate leading-tight">...</h2>
                            <div id="user-status-badge" class="hidden mt-2 self-start"></div>
                        </div>
                        <div class="flex gap-8 mt-3">
                            <div class="stat-box"><span id="posts-count" class="text-xl font-bold text-white leading-none tracking-tight">-</span><span class="text-[11px] text-gray-500 font-bold uppercase tracking-wider mt-1">Posts</span></div>
                            <div class="stat-box"><span id="likes-received-count" class="text-xl font-bold text-white leading-none tracking-tight">-</span><span class="text-[11px] text-gray-500 font-bold uppercase tracking-wider mt-1">Likes</span></div>
                            <div class="stat-box"><span id="followers-count" class="text-xl font-bold text-white leading-none tracking-tight">-</span><span class="text-[11px] text-gray-500 font-bold uppercase tracking-wider mt-1">Seguidores</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-5" id="profile-actions"></div>
                
                <div class="text-sm text-gray-300 relative group">
                    <div id="slogan-display-container" class="flex items-center gap-2 mb-3">
                        <p id="welcome-msg" class="italic text-gray-400 font-light leading-relaxed">...</p>
                        <button id="edit-slogan-btn" class="text-gray-600 hover:text-orange-500 hidden p-2 active:scale-90 transition" onclick="toggleSloganEdit()"><i class="fas fa-pen text-xs"></i></button>
                    </div>
                    <div id="slogan-edit-container" class="hidden mt-2 bg-zinc-900/50 p-3 rounded-xl border border-zinc-800">
                        <input type="text" id="slogan-input" class="w-full bg-black/30 border border-zinc-700 rounded-lg px-3 py-2 text-white text-sm outline-none focus:border-orange-500 mb-2" maxlength="60" placeholder="Escribe un estado...">
                        <div class="flex justify-end gap-3"><button onclick="toggleSloganEdit()" class="text-xs text-gray-400 px-3 py-1.5 font-semibold">Cancelar</button><button onclick="saveSlogan()" class="text-xs bg-orange-600 text-white px-4 py-1.5 rounded-lg font-bold">Guardar</button></div>
                    </div>
                    <div id="social-links-container" class="flex flex-wrap gap-4 mt-2 items-center" style="display: none;"></div>
                </div>
            </div>
        </header>

        <main class="container mx-auto max-w-xl pb-6">
            <div class="profile-tabs sticky top-0 z-40 bg-[#09090b]/95 backdrop-blur-md pt-2">
                <button onclick="switchTab('posts')" id="tab-btn-posts" class="tab-btn active w-1/3 flex justify-center"><i class="fas fa-th-large"></i></button>
                <button onclick="switchTab('collections')" id="tab-btn-collections" class="tab-btn w-1/3 flex justify-center"><i class="fas fa-folder-open"></i></button>
                <!-- BOTÃ“N MODO SELECCIÃ“N -->
                <button onclick="toggleSelectionMode()" id="selection-mode-btn" class="text-gray-500 text-xs font-bold uppercase tracking-wide border border-zinc-700 rounded-full px-3 py-1 ml-2 active:bg-zinc-800 transition">Seleccionar</button>
            </div>
            
            <div id="filter-container" class="filter-bar justify-center">
                 <button onclick="clearCharacterFilter()" class="filter-badge">
                     <i class="fas fa-times-circle"></i> <span id="active-filter-name">Personaje</span>
                 </button>
            </div>

            <div id="posts-view" class="fade-in">
                <div id="profile-grid" class="grid grid-cols-3 gap-1 px-1 sm:gap-2 sm:px-0"></div>
                <div id="no-posts-msg" class="hidden text-center py-20 text-gray-500"><div class="bg-zinc-900 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border border-zinc-800"><i class="fas fa-camera text-3xl opacity-30"></i></div><span class="text-sm font-medium">AÃºn no hay publicaciones.</span></div>
            </div>

            <div id="collections-view" class="hidden fade-in px-3">
                <div id="collections-grid" class="grid grid-cols-2 gap-4"></div>
                <div id="no-collections-msg" class="hidden text-center py-20 text-gray-500"><div class="bg-zinc-900 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border border-zinc-800"><i class="fas fa-folder text-3xl opacity-30"></i></div><span class="text-sm font-medium">Sin colecciones creadas.</span></div>
            </div>
        </main>
    </div>

    <!-- BARRA DE SELECCIÃ“N FLOTANTE INFERIOR -->
    <div id="selection-bar">
        <button onclick="toggleSelectionMode()" class="text-gray-400 font-semibold text-sm px-4 py-2 rounded-full hover:bg-zinc-800 transition">
            Cancelar
        </button>
        
        <span class="text-white text-sm font-bold tracking-wide">
            <span id="selection-count" class="text-orange-500">0</span> seleccionados
        </span>
        
        <button id="move-to-album-btn" onclick="openAddToCollectionModal()" class="move-to-album-btn disabled">
            <i class="fas fa-folder-plus"></i> Mover
        </button>
    </div>

    <!-- ADD TO COLLECTION MODAL -->
    <div id="add-collection-modal" class="hidden fixed inset-0 z-[5000] bg-black/80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-[#18181b] rounded-2xl p-6 w-full max-w-sm border border-zinc-700 shadow-2xl">
            <h3 class="text-white font-bold text-lg mb-4">AÃ±adir a ColecciÃ³n</h3>
            <p class="text-gray-400 text-xs mb-4">Elige un Ã¡lbum para las imÃ¡genes seleccionadas:</p>
            <div id="collection-list-select" class="flex flex-col gap-2 max-h-60 overflow-y-auto custom-scrollbar mb-4"></div>
            <button onclick="document.getElementById('add-collection-modal').classList.add('hidden'); document.getElementById('add-collection-modal').classList.remove('flex')" class="w-full py-3 bg-zinc-800 text-gray-300 rounded-xl font-bold">Cancelar</button>
        </div>
    </div>

    <!-- Collection Detail -->
    <div id="collection-detail-view" class="fixed inset-0 z-[6000] bg-[#09090b] flex flex-col transform translate-x-full transition-transform duration-300">
        <div class="p-4 flex items-center gap-4 bg-zinc-900/80 backdrop-blur-lg border-b border-zinc-800 safe-top">
            <button onclick="closeCollectionDetail()" class="h-10 w-10 flex items-center justify-center rounded-full active:bg-zinc-800 text-white transition"><i class="fas fa-arrow-left"></i></button>
            <h2 id="detail-collection-title" class="text-lg font-bold text-white truncate flex-1">...</h2>
            <button id="delete-collection-btn" class="hidden text-red-400 bg-red-500/10 px-3 py-1.5 rounded-lg border border-red-500/20 text-xs font-bold flex items-center gap-2 active:scale-95 transition" onclick="deleteCurrentCollection()"><i class="fas fa-trash-alt"></i> Eliminar</button>
        </div>
        <div class="flex-1 overflow-y-auto p-1 custom-scrollbar">
            <div id="detail-collection-grid" class="grid grid-cols-3 gap-1"></div>
            <div id="detail-empty-msg" class="hidden h-full flex flex-col items-center justify-center text-gray-500 pb-20"><i class="far fa-folder-open text-4xl mb-3 opacity-30"></i><span class="text-sm">ColecciÃ³n vacÃ­a</span></div>
        </div>
    </div>

    <!-- Edit Modal (OPTIMIZADO) -->
    <div id="details-modal" class="hidden fixed inset-0 z-[4000] bg-black/80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-[#18181b] rounded-2xl p-6 w-full max-w-sm border border-zinc-700 shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
            <h3 class="text-white font-bold text-lg mb-6 flex items-center gap-3 border-b border-zinc-800 pb-4"><i class="fas fa-id-card text-orange-500"></i> Editar Detalles</h3>
            
            <div class="mb-5">
                <label class="text-xs text-gray-400 mb-2 block uppercase font-bold tracking-wider ml-1">Nombre de Usuario</label>
                <div class="relative group"><i class="fas fa-user absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i><input type="text" id="edit-username" placeholder="Tu nombre" class="custom-input pl-10"></div>
            </div>

            <div class="mb-6">
                <label class="text-xs text-gray-400 mb-2 block uppercase font-bold tracking-wider ml-1">Estado del Artista</label>
                <div class="custom-select-container" id="dropdown-status">
                    <input type="hidden" id="artist-status" value="none">
                    <button type="button" class="custom-select-trigger" onclick="toggleCustomSelect('dropdown-status')"><span id="display-status">Oculto</span><i class="fas fa-chevron-down text-xs text-gray-500"></i></button>
                    <div class="custom-select-options custom-scrollbar">
                        <div class="option-item" onclick="selectCustomOption('dropdown-status', 'none', 'Oculto')">Oculto</div>
                        <div class="option-item" onclick="selectCustomOption('dropdown-status', 'open', 'ðŸŸ¢ Comisiones Abiertas')">ðŸŸ¢ Comisiones Abiertas</div>
                        <div class="option-item" onclick="selectCustomOption('dropdown-status', 'closed', 'ðŸ”´ Cerrado')">ðŸ”´ Cerrado</div>
                        <div class="option-item" onclick="selectCustomOption('dropdown-status', 'collab', 'ðŸ”µ Colaboraciones')">ðŸ”µ Colaboraciones</div>
                        <div class="option-item" onclick="selectCustomOption('dropdown-status', 'hiatus', 'âšª Hiatus')">âšª Hiatus</div>
                    </div>
                </div>
            </div>
            
            <p class="text-xs text-gray-400 mb-2 uppercase font-bold tracking-wider ml-1">Apoyo / Donaciones</p>
            <div class="flex gap-3 mb-6">
                <div class="relative group flex-1"><i class="fas fa-coffee absolute left-3 top-1/2 -translate-y-1/2 text-[var(--kofi-color)]"></i><input type="text" id="kofi-id" placeholder="ID Ko-fi" class="custom-input pl-9 text-xs" title="Solo tu usuario de Ko-fi"></div>
                <div class="relative group flex-1"><i class="fab fa-paypal absolute left-3 top-1/2 -translate-y-1/2 text-blue-500"></i><input type="text" id="paypal-id" placeholder="ID PayPal" class="custom-input pl-9 text-xs" title="ID del botÃ³n hospedado (hosted_button_id)"></div>
            </div>

            <p class="text-xs text-gray-400 mb-3 uppercase font-bold tracking-wider ml-1">Redes Sociales</p>
            <!-- CONTENEDOR DINÃMICO DE REDES SOCIALES -->
            <div id="socials-edit-list" class="flex flex-col gap-3 mb-3"></div>
            
            <!-- SELECTOR PARA AÃ‘ADIR REDES -->
            <div class="custom-select-container" id="dropdown-add-social">
                <button type="button" class="custom-select-trigger" onclick="toggleCustomSelect('dropdown-add-social')"><span class="text-orange-500 font-bold"><i class="fas fa-plus-circle mr-2"></i> AÃ±adir Red Social</span><i class="fas fa-chevron-down text-xs"></i></button>
                <div class="custom-select-options custom-scrollbar">
                    <div class="option-item" onclick="addSocialInput('facebook', 'Facebook', 'fab fa-facebook text-blue-500')"><i class="fab fa-facebook text-blue-500"></i> Facebook</div>
                    <div class="option-item" onclick="addSocialInput('x', 'X (Twitter)', 'fab fa-x-twitter text-white')"><i class="fab fa-x-twitter"></i> X (Twitter)</div>
                    <div class="option-item" onclick="addSocialInput('instagram', 'Instagram', 'fab fa-instagram text-pink-500')"><i class="fab fa-instagram text-pink-500"></i> Instagram</div>
                    <div class="option-item" onclick="addSocialInput('youtube', 'YouTube', 'fab fa-youtube text-red-500')"><i class="fab fa-youtube text-red-500"></i> YouTube</div>
                    <div class="option-item" onclick="addSocialInput('twitch', 'Twitch', 'fab fa-twitch text-purple-500')"><i class="fab fa-twitch text-purple-500"></i> Twitch</div>
                    <div class="option-item" onclick="addSocialInput('whatsapp', 'Grupo WhatsApp', 'fab fa-whatsapp text-green-500')"><i class="fab fa-whatsapp text-green-500"></i> WhatsApp</div>
                    <div class="option-item" onclick="addSocialInput('telegram', 'Telegram', 'fab fa-telegram text-cyan-400')"><i class="fab fa-telegram text-cyan-400"></i> Telegram</div>
                    <div class="option-item" onclick="addSocialInput('patreon', 'Patreon', 'fab fa-patreon text-red-400')"><i class="fab fa-patreon text-red-400"></i> Patreon</div>
                    <div class="option-item" onclick="addSocialInput('yodayo', 'Yodayo', 'fas fa-robot text-blue-400')"><i class="fas fa-robot text-blue-400"></i> Yodayo</div>
                    <div class="option-item" onclick="addSocialInput('pixai', 'Pixai.art', 'fas fa-palette text-purple-400')"><i class="fas fa-palette text-purple-400"></i> Pixai</div>
                </div>
            </div>

            <div class="flex gap-3 mt-8 pt-4 border-t border-zinc-800">
                <button onclick="closeEditModal()" class="flex-1 py-3 rounded-xl border border-zinc-700 text-gray-400 font-semibold active:scale-95 transition">Cancelar</button>
                <button onclick="saveDetails()" class="flex-1 py-3 rounded-xl bg-orange-600 text-white font-bold active:scale-95 transition">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="hidden fixed inset-0 z-[4000] bg-black/80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-[#18181b] rounded-2xl p-6 w-full max-w-sm border border-zinc-700 shadow-2xl text-center">
            <h3 class="text-white font-bold text-lg mb-2">Compartir Perfil</h3>
            <div class="flex gap-2 mb-6 bg-black/40 p-1.5 rounded-xl border border-zinc-700">
                <input type="text" id="share-link-input" class="w-full bg-transparent px-3 text-gray-300 text-xs outline-none font-mono" readonly>
                <button onclick="copyLinkFromModal()" class="bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-2 rounded-lg active:scale-95 transition"><i class="fas fa-copy"></i></button>
            </div>
            <button onclick="document.getElementById('share-modal').classList.add('hidden'); document.getElementById('share-modal').classList.remove('flex')" class="w-full py-3 text-gray-400 hover:text-white text-sm font-semibold rounded-xl hover:bg-zinc-800 active:scale-95 transition">Cerrar</button>
        </div>
    </div>

    <!-- VISOR (MODIFICADO CON SCROLL LOCK Y MULTI-IMAGEN) -->
    <div id="modal" class="modal-backdrop overflow-hidden">
        <button id="close-modal" class="fixed top-4 right-4 z-[8000] h-10 w-10 flex items-center justify-center rounded-full bg-black/60 text-white backdrop-blur-md border border-white/10 active:scale-90 transition shadow-lg"><i class="fas fa-times text-lg"></i></button>
        <div id="modal-inner-container" class="w-full h-full flex flex-col lg:flex-row bg-black transition-all duration-300">
            <div class="image-area relative flex-1 bg-black flex items-center justify-center overflow-hidden h-[55vh] lg:h-full" id="modal-image-area">
                <img id="modal-image" src="" class="max-w-full max-h-full object-contain w-auto h-auto transition-transform duration-300" alt="Visor">
                <button id="modal-prev" class="nav-arrow nav-prev" onclick="navigateModal(-1)"><i class="fas fa-chevron-left"></i></button>
                <button id="modal-next" class="nav-arrow nav-next" onclick="navigateModal(1)"><i class="fas fa-chevron-right"></i></button>
                <button onclick="toggleFullScreen()" class="absolute bottom-6 right-6 z-20 bg-zinc-800/80 text-white p-2.5 rounded-xl backdrop-blur-md border border-white/10 active:scale-90 transition shadow-lg"><i class="fas fa-expand text-sm"></i></button>
            </div>
            <div class="info-panel w-full lg:w-[420px] lg:h-full bg-[#121214] border-l border-zinc-800 flex flex-col h-[45vh] z-30 relative shadow-[-10px_0_30px_rgba(0,0,0,0.5)]">
                <div class="p-4 border-b border-zinc-800 flex items-center justify-between bg-[#18181b] flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <img id="modal-user-pic" src="" class="w-10 h-10 rounded-full object-cover border border-zinc-600 bg-zinc-700">
                        <div class="leading-tight"><h4 id="modal-user-name" class="font-bold text-white text-sm">Usuario</h4><span class="text-[10px] text-gray-500 font-medium">Autor</span></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="modal-delete-btn" class="hidden text-red-400 hover:text-red-300 bg-red-500/10 hover:bg-red-500/20 w-9 h-9 flex items-center justify-center rounded-full active:scale-90 transition" title="Eliminar"><i class="fas fa-trash-alt text-sm"></i></button>
                        <button id="modal-like-btn" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-zinc-800 border border-zinc-700 active:scale-95 transition group"><i class="far fa-heart text-lg group-active:scale-125 transition-transform text-gray-400"></i><span id="modal-likes-count" class="text-xs font-bold text-white">0</span></button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-5 custom-scrollbar bg-[#121214]">
                    <div class="mb-5">
                        <h3 id="modal-title" class="text-xl font-bold text-white mb-2 font-[Poppins] leading-snug"></h3>
                        <div id="modal-character-tag" class="hidden inline-flex items-center gap-1.5 bg-orange-500/10 border border-orange-500/20 text-orange-400 px-2.5 py-1 rounded-md text-[11px] font-bold uppercase tracking-wider mb-2 cursor-pointer hover:bg-orange-500/20" onclick="filterByCharacterFromModal()"><i class="fas fa-user-tag text-[10px]"></i> <span id="modal-character-name"></span></div>
                        <p id="modal-desc" class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap font-light"></p>
                    </div>
                    <div class="mb-8 border-b border-zinc-800 pb-5">
                        <button onclick="toggleTags()" id="tags-toggle-btn" class="text-[11px] font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2 hover:text-orange-500 transition-colors mb-2"><span>Ver etiquetas</span> <i class="fas fa-chevron-down"></i></button>
                        <div id="modal-tags" class="hidden flex flex-wrap gap-2 mt-3"></div>
                    </div>
                    <div><h4 class="text-[11px] font-bold text-gray-500 uppercase mb-4 tracking-widest flex items-center gap-2"><i class="fas fa-comments"></i> Comentarios</h4><div id="modal-comments-list" class="flex flex-col gap-4 pb-4"></div></div>
                </div>
                <div class="p-3 bg-[#18181b] border-t border-zinc-800 flex-shrink-0 safe-bottom">
                    <form onsubmit="postCommentInModal(event)" class="flex gap-2 relative">
                        <input type="text" id="modal-comment-input" maxlength="200" class="w-full bg-zinc-900 border border-zinc-700 rounded-full pl-5 pr-12 py-3 text-sm text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="AÃ±ade un comentario..." autocomplete="off">
                        <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-orange-500 p-2 active:scale-90 transition"><i class="fas fa-paper-plane text-lg"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Nav -->
    <nav id="main-nav" class="bottom-nav fixed bottom-0 left-0 right-0 flex h-[70px] justify-around items-center px-2 pb-2">
        <a href="index.html" class="nav-item flex flex-col items-center justify-center w-1/3 p-2 active:scale-95"><i class="fas fa-home text-xl mb-1.5"></i><span class="text-[10px] font-bold tracking-wide">GalerÃ­a</span></a>
        <a href="feed.html" onclick="return requireLogin(event)" class="nav-item flex flex-col items-center justify-center w-1/3 p-2 active:scale-95"><i class="fas fa-globe-americas text-xl mb-1.5"></i><span class="text-[10px] font-bold tracking-wide">Social</span></a>
        <a href="profile.html" onclick="return requireLogin(event)" class="nav-item active flex flex-col items-center justify-center w-1/3 p-2 active:scale-95"><i class="fas fa-user text-xl mb-1.5"></i><span class="text-[10px] font-bold tracking-wide">Perfil</span></a>
    </nav>

    <!-- Scripts -->
    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/+esm";
        const TAGGER_CONFIG = { threshold: 0.5, useSpace: false, useEscape: true, keepConfidences: false, descend: true };
        async function resizeImageForApi(file) {
            if (file.size <= 1024 * 1024) return file;
            return new Promise((resolve) => {
                const img = new Image(); const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX_SIZE = 800;
                img.onload = () => { let w=img.width, h=img.height; if(w>h){if(w>MAX_SIZE){h*=MAX_SIZE/w;w=MAX_SIZE;}}else{if(h>MAX_SIZE){w*=MAX_SIZE/h;h=MAX_SIZE;}} canvas.width=w;canvas.height=h; ctx.drawImage(img,0,0,w,h); canvas.toBlob(resolve,'image/jpeg',0.85); }; img.src = URL.createObjectURL(file);
            });
        }
        window.runAutoTagging = async function(originalFile) {
            const tagInput = document.getElementById('post-tags'); tagInput.value = ""; 
            try {
                const processedFile = await resizeImageForApi(originalFile);
                const client = await Client.connect("Jossle/deepdanbooru_online_Exen");
                const result = await client.predict(0, [processedFile, TAGGER_CONFIG.threshold, TAGGER_CONFIG.useSpace, TAGGER_CONFIG.useEscape, TAGGER_CONFIG.keepConfidences, TAGGER_CONFIG.descend]);
                if (result && result.data && result.data[0]) { tagInput.value = result.data[0]; } else throw new Error("Respuesta vacÃ­a");
            } catch (error) { console.error("Error Tagging:", error); tagInput.value = "tag_error"; }
        }
    </script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBB7y-V0P_gKPWH-shvwrmZxHbdq-ASmj8", authDomain: "exene-53e6b.firebaseapp.com", databaseURL: "https://exene-53e6b-default-rtdb.firebaseio.com", projectId: "exene-53e6b", storageBucket: "exene-53e6b.appspot.com", messagingSenderId: "481369419867", appId: "1:481369419867:web:ac5db24c436344262c8f7e" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(); const auth = firebase.auth();
        const CATBOX_USERHASH = "341adb9d3c2d09d0485aa908c";

        let currentUser = null, currentUserData = null, targetUserId = null, selectedFiles = [];
        let currentViewPosts = [], currentPostIndex = -1, currentCollectionId = null, userDataCache = {};
        let isUploadingAuth = false, touchStartX = 0, touchEndX = 0, confirmCallback = null;
        let isSelectionMode = false, selectedPostIds = []; 
        let allUserPostsCache = [];
        let currentCharacterFilter = null;
        let characterStatsCache = {};
        let amIFollowing = false;

        // --- GLOBAL ERROR & SAFETY ---
        window.onerror = function(msg) { console.error("Global Error:", msg); const loader = document.getElementById('initial-loader'); if(loader && loader.style.display !== 'none') { document.getElementById('loader-status').innerText = "Error. Recarga la pÃ¡gina."; } };
        setTimeout(() => { const l = document.getElementById('initial-loader'); if(l && getComputedStyle(l).display !== 'none' && !currentUser) { document.getElementById('loader-status').innerText = "Â¿Tarda mucho? Revisa tu conexiÃ³n."; } }, 8000);

        // --- UTILS ---
        function showToast(msg) { const t = document.getElementById('toast-container'); if(t) { document.getElementById('toast-message').innerText = msg; t.classList.remove('opacity-0', 'translate-y-4'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-4'), 3000); } }
        function showAlert(msg) { document.getElementById('custom-alert-msg').innerText = msg; const el = document.getElementById('custom-alert'); el.classList.remove('hidden'); el.classList.add('flex'); }
        function closeCustomAlert() { const el = document.getElementById('custom-alert'); el.classList.add('hidden'); el.classList.remove('flex'); }
        function showConfirm(msg, callback, title = "Â¿EstÃ¡s seguro?") { confirmCallback = callback; document.getElementById('custom-confirm-title').innerText = title; document.getElementById('custom-confirm-msg').innerText = msg; document.getElementById('custom-confirm').classList.remove('hidden'); document.getElementById('custom-confirm').classList.add('flex'); }
        function closeCustomConfirm(result) { document.getElementById('custom-confirm').classList.add('hidden'); document.getElementById('custom-confirm').classList.remove('flex'); if(result && confirmCallback) confirmCallback(); confirmCallback = null; }
        
        function toggleCustomSelect(id) { const el = document.getElementById(id); const list = el.querySelector('.custom-select-options'); const trigger = el.querySelector('.custom-select-trigger'); document.querySelectorAll('.custom-select-options.show').forEach(opt => { if(opt !== list) { opt.classList.remove('show'); opt.parentElement.querySelector('.custom-select-trigger').classList.remove('active'); } }); list.classList.toggle('show'); trigger.classList.toggle('active'); }
        function selectCustomOption(containerId, value, displayText) { const container = document.getElementById(containerId); container.querySelector('input[type="hidden"]').value = value; container.querySelector('.custom-select-trigger span').innerHTML = displayText; container.querySelector('.custom-select-trigger').classList.remove('active'); container.querySelector('.custom-select-options').classList.remove('show'); if (containerId === 'dropdown-collection') toggleCollectionInput(); if (containerId === 'dropdown-add-social') toggleCustomSelect('dropdown-add-social'); }
        window.addEventListener('click', function(e) { if (!e.target.closest('.custom-select-container')) { document.querySelectorAll('.custom-select-options.show').forEach(el => { el.classList.remove('show'); el.parentElement.querySelector('.custom-select-trigger').classList.remove('active'); }); } });

        // --- NEW REQUIRE LOGIN ---
        function requireLogin(event) {
            if (!currentUser) {
                if(event) { event.preventDefault(); event.stopPropagation(); }
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // --- AUTH & INIT ---
        auth.onAuthStateChanged(user => {
            const loader = document.getElementById('initial-loader'); const urlParams = new URLSearchParams(window.location.search); const uidParam = urlParams.get('uid'); const collectionParam = urlParams.get('collection');
            
            if (user && !user.isAnonymous) {
                currentUser = user; targetUserId = uidParam || currentUser.uid;
                if (!uidParam) window.history.replaceState(null, '', `?uid=${currentUser.uid}`);
                db.ref('users/' + currentUser.uid).once('value', s => currentUserData = s.val());
                document.getElementById('app-content').style.display = 'block';
                setupUIForTargetUser(); loadUserProfile(); loadUserPosts(); loadUserCollectionsGrid(collectionParam); 
                checkFollowStatus(); loadFollowersCount();
                initCharacterStatsListener();
            } else {
                currentUser = null;
                if (uidParam) {
                    targetUserId = uidParam; 
                    document.getElementById('app-content').style.display = 'block';
                    setupUIForTargetUser(); loadUserProfile(); loadUserPosts(); loadUserCollectionsGrid(collectionParam);
                    loadFollowersCount();
                } else {
                    window.location.href = 'login.html';
                }
            }
            document.getElementById('page-loader').style.display = 'none';
            if(loader) { loader.style.opacity = '0'; setTimeout(() => { loader.style.display = 'none'; }, 500); }
        });

        function initCharacterStatsListener() {
            db.ref('stats/characters').on('value', snapshot => {
                if (snapshot.exists()) { characterStatsCache = snapshot.val(); } else { characterStatsCache = {}; }
            });
        }

        // --- FOLLOW SYSTEM ---
        function checkFollowStatus() {
            if (!currentUser || currentUser.uid === targetUserId) return;
            db.ref(`follows/${currentUser.uid}/${targetUserId}`).on('value', snap => {
                amIFollowing = snap.exists();
                updateFollowButtonUI();
            });
        }

        function loadFollowersCount() {
            db.ref(`followers/${targetUserId}`).on('value', snap => {
                document.getElementById('followers-count').innerText = snap.numChildren() || 0;
            });
        }

        function updateFollowButtonUI() {
            const btn = document.getElementById('profile-follow-btn');
            if(!btn) return;
            if(amIFollowing) {
                btn.classList.remove('not-following'); btn.classList.add('following');
                btn.innerHTML = 'Siguiendo';
            } else {
                btn.classList.remove('following'); btn.classList.add('not-following');
                btn.innerHTML = 'Seguir';
            }
        }

        function toggleFollowProfile() {
            if (!requireLogin()) return;
            if(amIFollowing) {
                db.ref(`follows/${currentUser.uid}/${targetUserId}`).remove();
                db.ref(`followers/${targetUserId}/${currentUser.uid}`).remove();
            } else {
                db.ref(`follows/${currentUser.uid}/${targetUserId}`).set(true);
                db.ref(`followers/${targetUserId}/${currentUser.uid}`).set(true);
                sendNotification(targetUserId, 'follow');
            }
        }
        
        function sendNotification(targetUid, type, postId = null) {
            if (targetUid === currentUser.uid) return;
            const notifRef = db.ref(`notifications/${targetUid}`).push();
            notifRef.set({
                type: type,
                fromUserId: currentUser.uid,
                fromUserName: (currentUserData && currentUserData.username) ? currentUserData.username : 'Alguien',
                postId: postId,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            });
        }


        // --- UI LOGIC ---
        function setupUIForTargetUser() {
            const isMyProfile = currentUser && currentUser.uid === targetUserId;
            const container = document.getElementById('profile-actions');
            const bannerBtn = document.getElementById('banner-edit-btn');
            const avatarContainer = document.getElementById('avatar-container');
            const selBtn = document.getElementById('selection-mode-btn');

            if (isMyProfile) {
                bannerBtn.classList.remove('hidden'); bannerBtn.classList.add('flex');
                document.getElementById('edit-badge').classList.remove('hidden'); 
                document.getElementById('edit-slogan-btn').classList.remove('hidden');
                avatarContainer.onclick = () => document.getElementById('file-input').click();
                if(selBtn) selBtn.classList.remove('hidden');

                container.innerHTML = `
                    <div class="flex justify-between items-center mb-4 px-1">
                         <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Mi Espacio</span>
                         <div class="flex gap-2">
                            <button onclick="openEditModal()" class="text-xs bg-zinc-800 text-gray-200 px-3 h-9 rounded-xl border border-zinc-700 hover:bg-zinc-700 transition flex items-center gap-2 font-semibold active:scale-95"><i class="fas fa-edit text-orange-500"></i> Editar Perfil</button>
                            <button onclick="openShareModal()" class="text-xs bg-zinc-800 text-gray-200 h-9 w-9 rounded-xl border border-zinc-700 hover:bg-zinc-700 flex items-center justify-center active:scale-95 transition"><i class="fas fa-share-alt"></i></button>
                            <button onclick="logout()" class="text-xs bg-red-500/10 text-red-400 px-3 h-9 rounded-xl border border-red-500/20 hover:bg-red-500/20 active:scale-95 transition"><i class="fas fa-sign-out-alt"></i></button>
                         </div>
                    </div>
                    
                    <div class="upload-card p-4 sm:p-5 rounded-2xl relative mb-2">
                        <div class="flex gap-4 items-start mb-2">
                            <div class="w-11 h-11 rounded-full overflow-hidden bg-zinc-700 flex-shrink-0 mt-1 border border-zinc-600 shadow-md">
                                <img id="post-avatar-preview" src="${(currentUserData && currentUserData.profilePic) ? currentUserData.profilePic : 'https://placehold.co/100x100/333/666?text=U'}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1 relative">
                                <textarea id="post-text" rows="1" maxlength="500" class="w-full bg-transparent text-white placeholder-gray-500 resize-none focus:outline-none text-sm py-3 min-h-[48px]" placeholder="Â¿QuÃ© estÃ¡s creando hoy?" onfocus="expandPostArea()" oninput="this.style.height='';this.style.height=this.scrollHeight+'px'"></textarea>
                            </div>
                        </div>
                        <div id="preview-stack" style="display: none;"></div>
                        <div id="extra-fields">
                            <div class="flex flex-col gap-3">
                                <div class="flex items-center gap-3">
                                    <label class="flex items-center justify-center text-orange-500 cursor-pointer p-3 rounded-xl bg-zinc-800/80 hover:bg-zinc-700 border border-zinc-700 w-full transition active:scale-95">
                                        <i class="fas fa-images text-lg mr-2"></i> <span class="text-sm font-semibold text-gray-300">AÃ±adir ImÃ¡genes (Max 3)</span>
                                        <input type="file" id="post-file-input" accept="image/*" class="hidden" multiple onchange="handleFileSelectForPost(event); expandPostArea()">
                                    </label>
                                </div>
                                <input type="text" id="post-title" maxlength="16" placeholder="TÃ­tulo de la obra" class="custom-input font-bold bg-black/20 border-zinc-700">
                                <div class="hidden"><input type="text" id="post-tags" placeholder="Auto-generaciÃ³n..." class="custom-input bg-black/40 border-zinc-700 text-xs pl-8 tags-readonly" readonly></div>
                                
                                <div class="relative w-full">
                                    <input type="text" id="post-character" maxlength="30" placeholder="Nombre del personaje (Opcional)" class="custom-input bg-black/20 border-zinc-700" autocomplete="off">
                                    <div id="character-suggestions" class="suggestions-dropdown custom-scrollbar"></div>
                                </div>

                                <div class="flex flex-col sm:flex-row gap-3">
                                    <div class="custom-select-container w-full" id="dropdown-category">
                                        <input type="hidden" id="post-category" value="">
                                        <button type="button" class="custom-select-trigger" onclick="toggleCustomSelect('dropdown-category')"><span><i class="fas fa-tag mr-2 text-xs text-orange-500"></i> CategorÃ­a</span><i class="fas fa-chevron-down text-xs"></i></button>
                                        <div class="custom-select-options custom-scrollbar">
                                            <div class="option-item" onclick="selectCustomOption('dropdown-category', 'anime', 'Anime')">Anime</div>
                                            <div class="option-item" onclick="selectCustomOption('dropdown-category', 'furry', 'Furry')">Furry</div>
                                            <div class="option-item" onclick="selectCustomOption('dropdown-category', 'realismo', 'Realismo')">Realismo</div>
                                            <div class="option-item" onclick="selectCustomOption('dropdown-category', 'mecas', 'Mecas')">Mecas</div>
                                            <div class="option-item" onclick="selectCustomOption('dropdown-category', 'devils', 'Devils')">Devils</div>
                                            <div class="option-item" onclick="selectCustomOption('dropdown-category', 'colors', 'ColorFull')">ColorFull</div>
                                            <div class="option-item" onclick="selectCustomOption('dropdown-category', 'amateur', 'Amateur')">Amateur</div>
                                            <div class="option-item" onclick="selectCustomOption('dropdown-category', 'tvgames', 'TV/Games')">TV/Games</div>
                                        </div>
                                    </div>
                                    <div class="custom-select-container w-full" id="dropdown-collection">
                                        <input type="hidden" id="post-collection" value="">
                                        <button type="button" class="custom-select-trigger" onclick="toggleCustomSelect('dropdown-collection')"><span id="display-collection"><i class="fas fa-folder mr-2 text-xs text-orange-500"></i> NingÃºn Ãlbum</span><i class="fas fa-chevron-down text-xs"></i></button>
                                        <div id="collection-options-list" class="custom-select-options custom-scrollbar"></div>
                                    </div>
                                </div>
                                <div id="new-collection-container" class="hidden animate-enter"><input type="text" id="new-collection-name" maxlength="10" placeholder="Nombre de la nueva colecciÃ³n..." class="custom-input bg-orange-900/10 border-orange-500/30 text-sm"></div>
                                
                                <div class="flex gap-3 mt-4 pt-3 border-t border-white/5">
                                    <button onclick="collapsePostArea()" class="flex-1 py-3 rounded-xl text-gray-400 text-sm font-semibold hover:bg-zinc-800 transition active:scale-95">Cancelar</button>
                                    <button id="publish-btn" onclick="uploadPost()" class="bg-gradient-to-r from-orange-600 to-orange-500 text-white px-6 py-3 rounded-xl text-sm font-bold flex-[2] flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95"><span>Publicar</span> <i class="fas fa-paper-plane text-xs"></i></button>
                                </div>
                            </div>
                        </div>
                        <div id="upload-progress" class="hidden w-full bg-zinc-800 rounded-full h-1 mt-4 overflow-hidden"><div class="bg-orange-500 h-1 rounded-full w-1/3 animate-pulse"></div></div>
                    </div>`;
                db.ref('users/' + currentUser.uid + '/profilePic').once('value').then(s => { if(s.val()) document.getElementById('post-avatar-preview').src = s.val(); });
                loadUserCollectionsSelect();
                setupCharacterSuggestions();
            } else {
                bannerBtn.classList.add('hidden'); bannerBtn.classList.remove('flex');
                document.getElementById('edit-badge').classList.add('hidden'); 
                document.getElementById('edit-slogan-btn').classList.add('hidden');
                avatarContainer.onclick = null; avatarContainer.style.cursor = 'default';
                if(selBtn) selBtn.classList.add('hidden');
                
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-3 px-1">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Perfil PÃºblico</span>
                        <div class="flex gap-2 items-center" id="visitor-actions">
                            <button id="profile-follow-btn" onclick="toggleFollowProfile()" class="profile-follow-btn not-following">Seguir</button>
                            <button onclick="openShareModal()" class="text-xs bg-zinc-800 text-gray-300 h-9 w-9 rounded-xl border border-zinc-700 hover:bg-zinc-700 flex items-center justify-center transition active:scale-95"><i class="fas fa-share-alt"></i></button>
                        </div>
                    </div>`;
            }
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0]; if (!file) return;
            const loader = document.getElementById('avatar-loading'); loader.classList.remove('hidden'); loader.classList.add('flex');
            try {
                const fileToUpload = await compressImage(file);
                const fd = new FormData(); fd.append('reqtype', 'fileupload'); fd.append('userhash', CATBOX_USERHASH); fd.append('fileToUpload', fileToUpload);
                const res = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", {method:'POST', body:fd});
                const urlText = await res.text(); if (!urlText.includes('catbox.moe')) throw new Error("Error en subida de imagen");
                const finalUrl = urlText.trim();
                await db.ref('users/' + currentUser.uid).update({ profilePic: finalUrl });
                document.getElementById('profile-image').src = finalUrl; const postPreview = document.getElementById('post-avatar-preview'); if(postPreview) postPreview.src = finalUrl;
                showToast("Actualizando publicaciones antiguas...");
                const postsSnap = await db.ref('feed_posts').orderByChild('userId').equalTo(currentUser.uid).once('value');
                if (postsSnap.exists()) { const updates = {}; postsSnap.forEach(child => { updates[`feed_posts/${child.key}/userAvatar`] = finalUrl; }); await db.ref().update(updates); }
                showToast("Foto de perfil actualizada exitosamente");
            } catch (error) { console.error(error); showAlert("Error al actualizar la foto: " + error.message); } finally { loader.classList.add('hidden'); loader.classList.remove('flex'); }
        }

        function switchTab(tab) {
            if (tab === 'posts') {
                document.getElementById('tab-btn-posts').classList.add('active'); document.getElementById('tab-btn-collections').classList.remove('active');
                document.getElementById('posts-view').classList.remove('hidden'); document.getElementById('collections-view').classList.add('hidden');
            } else {
                document.getElementById('tab-btn-collections').classList.add('active'); document.getElementById('tab-btn-posts').classList.remove('active');
                document.getElementById('collections-view').classList.remove('hidden'); document.getElementById('posts-view').classList.add('hidden');
            }
        }

        // --- SELECTION MODE LOGIC ---
        function toggleSelectionMode() {
            if(!currentUser || currentUser.uid !== targetUserId) return;
            isSelectionMode = !isSelectionMode;
            
            const btn = document.getElementById('selection-mode-btn');
            const bar = document.getElementById('selection-bar');
            const mainNav = document.getElementById('main-nav');
            
            if(isSelectionMode) {
                btn.classList.add('bg-zinc-800', 'text-orange-500', 'border-orange-500');
                btn.innerText = "Cancelar";
                bar.classList.add('visible'); 
                mainNav.classList.add('hidden-nav'); 
            } else {
                btn.classList.remove('bg-zinc-800', 'text-orange-500', 'border-orange-500');
                btn.innerText = "Seleccionar";
                bar.classList.remove('visible'); 
                mainNav.classList.remove('hidden-nav'); 
                selectedPostIds = []; 
                updateSelectionUI();
            }
        }

        function togglePostSelection(postId, element) {
            if(selectedPostIds.includes(postId)) {
                selectedPostIds = selectedPostIds.filter(id => id !== postId);
                element.classList.remove('selected');
            } else {
                selectedPostIds.push(postId);
                element.classList.add('selected');
            }
            document.getElementById('selection-count').innerText = selectedPostIds.length;
            const moveBtn = document.getElementById('move-to-album-btn');
            if(selectedPostIds.length > 0) moveBtn.classList.remove('disabled'); else moveBtn.classList.add('disabled');
        }

        function updateSelectionUI() {
            document.querySelectorAll('.grid-item').forEach(el => el.classList.remove('selected'));
            document.getElementById('selection-count').innerText = "0";
            document.getElementById('move-to-album-btn').classList.add('disabled');
        }

        function openAddToCollectionModal() {
            if(selectedPostIds.length === 0) return showToast("Selecciona al menos una imagen");
            const list = document.getElementById('collection-list-select');
            list.innerHTML = '<div class="text-center p-2"><i class="fas fa-spinner fa-spin"></i> Cargando Ã¡lbumes...</div>';
            document.getElementById('add-collection-modal').classList.remove('hidden');
            document.getElementById('add-collection-modal').classList.add('flex');

            db.ref('collections/' + currentUser.uid).once('value', snap => {
                list.innerHTML = '';
                if(!snap.exists()) { list.innerHTML = '<p class="text-center text-gray-500 text-xs">No tienes Ã¡lbumes creados.</p>'; return; }
                snap.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left px-4 py-3 bg-zinc-900 hover:bg-zinc-800 rounded-xl text-sm text-white flex items-center gap-3 transition";
                    btn.innerHTML = `<i class="fas fa-folder text-orange-500"></i> ${c.val().name}`;
                    btn.onclick = () => addSelectedToCollection(c.key, c.val().name);
                    list.appendChild(btn);
                });
            });
        }

        async function addSelectedToCollection(colId, colName) {
            if(!colId || selectedPostIds.length === 0) return;
            const updates = {};
            selectedPostIds.forEach(pid => {
                updates[`feed_posts/${pid}/collectionId`] = colId;
                updates[`feed_posts/${pid}/collectionName`] = colName;
            });
            
            try {
                await db.ref().update(updates);
                const firstPostId = selectedPostIds[0];
                const snap = await db.ref(`feed_posts/${firstPostId}`).once('value');
                if(snap.exists()) {
                    const p = snap.val();
                    const img = (p.imageUrls && p.imageUrls.length > 0) ? p.imageUrls[0] : p.imageUrl;
                    if(img) await updateCollectionPreviews(currentUser.uid, colId, img);
                }
                showToast(`Â¡${selectedPostIds.length} imÃ¡genes movidas a ${colName}!`);
                document.getElementById('add-collection-modal').classList.add('hidden');
                document.getElementById('add-collection-modal').classList.remove('flex');
                toggleSelectionMode(); 
                loadUserCollectionsGrid(); 
            } catch(e) { showAlert("Error moviendo imÃ¡genes: " + e.message); }
        }

        // --- POSTING ---
        function expandPostArea() { 
            const el = document.getElementById('extra-fields'); el.classList.add('expanded'); document.getElementById('post-text').rows = 3;
            setTimeout(() => { if(el.classList.contains('expanded')) el.classList.add('expanded-visible'); }, 450);
        }
        
        function collapsePostArea(force = false) { 
            const reset = () => {
                const el = document.getElementById('extra-fields'); el.classList.remove('expanded-visible'); void el.offsetWidth; el.classList.remove('expanded');
                selectedFiles = []; renderPreviewStack();
                document.getElementById('post-text').value = ''; document.getElementById('post-title').value=''; document.getElementById('post-tags').value=''; document.getElementById('post-character').value='';
                document.getElementById('publish-btn').disabled = false; document.getElementById('publish-btn').classList.remove('btn-disabled');
                selectCustomOption('dropdown-category', '', '<i class="fas fa-tag mr-2 text-xs text-orange-500"></i> CategorÃ­a');
                selectCustomOption('dropdown-collection', '', '<i class="fas fa-folder mr-2 text-xs text-orange-500"></i> NingÃºn Ãlbum');
                document.getElementById('new-collection-name').value = ''; document.getElementById('post-text').rows=1;
            };
            if(force) reset(); else if(document.getElementById('post-text').value || selectedFiles.length > 0) showConfirm("Â¿Descartar cambios?", () => reset()); else reset();
        }

        function handleFileSelectForPost(e) { 
            const newFiles = Array.from(e.target.files);
            if (!newFiles.length) return;
            newFiles.forEach(file => { if (selectedFiles.length < 3) selectedFiles.push(file); });
            if (selectedFiles.length === 3) showToast("MÃ¡ximo 3 imÃ¡genes alcanzado");
            renderPreviewStack();
            if (selectedFiles.length > 0 && window.runAutoTagging) { try { window.runAutoTagging(selectedFiles[selectedFiles.length - 1]); } catch(e) {} }
            e.target.value = ""; 
        }

        function renderPreviewStack() {
            const container = document.getElementById('preview-stack'); container.innerHTML = '';
            if (selectedFiles.length === 0) { container.style.display = 'none'; return; }
            container.style.display = 'flex';
            selectedFiles.forEach((file, index) => {
                const url = URL.createObjectURL(file);
                const thumb = document.createElement('div'); thumb.className = 'preview-thumb';
                thumb.innerHTML = `<img src="${url}"><div class="remove-thumb-btn" onclick="removeFile(${index})"><i class="fas fa-times"></i></div>`;
                container.appendChild(thumb);
            });
        }
        function removeFile(index) { selectedFiles.splice(index, 1); renderPreviewStack(); }

        async function updateCollectionPreviews(userId, colId, newImgUrl) {
            if (!colId || colId === 'new' || !newImgUrl) return;
            const ref = db.ref(`collections/${userId}/${colId}/previews`);
            await ref.transaction((currentPreviews) => { let list = currentPreviews || []; if (!Array.isArray(list)) list = []; list.unshift(newImgUrl); return list.slice(0, 4); });
            db.ref(`collections/${userId}/${colId}/cover`).set(newImgUrl);
        }

        async function uploadPost() {
            const text = document.getElementById('post-text').value.trim();
            const title = document.getElementById('post-title').value.trim();
            const tags = document.getElementById('post-tags').value.trim();
            const characterName = document.getElementById('post-character').value.trim();
            const category = document.getElementById('post-category').value;
            let colId = document.getElementById('post-collection').value;
            const newColName = document.getElementById('new-collection-name').value.trim();

            if (!text && selectedFiles.length === 0) return showAlert("AÃ±ade contenido.");
            if (selectedFiles.length > 0 && (!title || !category)) return showAlert("Faltan datos (tÃ­tulo/categorÃ­a).");
            if (colId === 'new' && !newColName) return showAlert("Nombre de colecciÃ³n requerido.");

            const btn = document.getElementById('publish-btn'); btn.disabled = true; btn.classList.add('btn-disabled');
            document.getElementById('upload-progress').classList.remove('hidden');

            try {
                let colName = null, uploadedUrls = [];
                if (colId === 'new') {
                    const ref = db.ref('collections/' + currentUser.uid).push();
                    colId = ref.key; colName = newColName;
                    await ref.set({ name: newColName, createdAt: firebase.database.ServerValue.TIMESTAMP, cover: 'pending', previews: [] });
                } else if (colId) { const snap = await db.ref(`collections/${currentUser.uid}/${colId}/name`).once('value'); colName = snap.val(); }

                if (selectedFiles.length > 0) {
                    for (const file of selectedFiles) {
                        let processedFile = await compressImage(file);
                        const formData = new FormData(); formData.append('reqtype','fileupload'); formData.append('userhash',CATBOX_USERHASH); formData.append('fileToUpload', processedFile);
                        const r = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", { method:'POST', body: formData });
                        const txt = await r.text(); if(txt.includes('catbox.moe')) uploadedUrls.push(txt.trim());
                    }
                }

                const userSnap = await db.ref('users/' + currentUser.uid).once('value');
                const userData = userSnap.val() || {};
                const safeAvatar = userData.profilePic || 'https://placehold.co/150x150/333/666?text=U';
                const safeName = userData.username || 'Anon';

                await db.ref('feed_posts').push({
                    text, title, tags, category, characterName,
                    imageUrl: uploadedUrls.length > 0 ? uploadedUrls[0] : null,
                    imageUrls: uploadedUrls,
                    userId: currentUser.uid, userName: safeName, userAvatar: safeAvatar,
                    timestamp: firebase.database.ServerValue.TIMESTAMP, likes: 0,
                    collectionId: colId || null, collectionName: colName || null
                });

                if (characterName) {
                    const normalizedChar = characterName.toLowerCase().replace(/[.#$\[\]]/g, ""); 
                    const charRef = db.ref(`stats/characters/${normalizedChar}`);
                    charRef.transaction((currentData) => {
                        return { count: (currentData ? currentData.count : 0) + 1, displayName: characterName };
                    });
                }

                if (colId && uploadedUrls.length > 0) { await updateCollectionPreviews(currentUser.uid, colId, uploadedUrls[0]); }
                collapsePostArea(true); loadUserPosts(); loadUserCollectionsGrid(); showToast("Publicado");
            } catch (e) { showAlert(e.message); } 
            finally { btn.disabled = false; btn.classList.remove('btn-disabled'); document.getElementById('upload-progress').classList.add('hidden'); }
        }

        // --- FETCHERS (ONCE) ---
        function loadUserPosts() {
            const grid = document.getElementById('profile-grid'), noMsg = document.getElementById('no-posts-msg');
            db.ref('feed_posts').orderByChild('userId').equalTo(targetUserId).limitToLast(100).once('value', snap => {
                grid.innerHTML = '';
                if (!snap.exists()) { noMsg.classList.remove('hidden'); allUserPostsCache = []; return; }
                noMsg.classList.add('hidden');
                
                let posts = [], likes = 0;
                snap.forEach(c => { const p = c.val(); p.id = c.key; posts.push(p); likes += (p.likes||0); });
                document.getElementById('posts-count').innerText = posts.length;
                document.getElementById('likes-received-count').innerText = likes;
                
                posts.sort((a,b) => b.timestamp - a.timestamp);
                allUserPostsCache = posts;
                renderProfileGrid(posts);
            });
        }
        
        function renderProfileGrid(posts) {
            const grid = document.getElementById('profile-grid');
            grid.innerHTML = '';
            
            // Filtrado por personaje
            let displayPosts = posts;
            if (currentCharacterFilter) {
                displayPosts = posts.filter(p => p.characterName && p.characterName.toLowerCase() === currentCharacterFilter.toLowerCase());
                document.getElementById('filter-container').classList.add('visible');
                document.getElementById('active-filter-name').innerText = currentCharacterFilter;
            } else {
                document.getElementById('filter-container').classList.remove('visible');
            }

            displayPosts.forEach((post, postIdx) => {
                const images = post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);
                if(images.length === 0) return;
                
                // Muestra CADA imagen como un elemento de la cuadrÃ­cula
                images.forEach((imgUrl, imgIndex) => {
                    const div = document.createElement('div'); div.className = "grid-item group";
                    div.innerHTML = `<img src="${imgUrl}" class="grid-image" loading="lazy">
                    <div class="grid-overlay"><span class="text-white text-xs font-bold drop-shadow-md flex items-center gap-1"><i class="fas fa-heart text-white text-[10px]"></i> ${post.likes||0}</span></div>
                    <div class="selection-overlay hidden"><div class="selection-check"><i class="fas fa-check text-white"></i></div></div>`;
                    
                    div.onclick = function() {
                        if(isSelectionMode) togglePostSelection(post.id, div);
                        else openMainViewer(displayPosts, postIdx, imgIndex); // Pass internal index
                    };
                    grid.appendChild(div);
                });
            });
            
            if (displayPosts.length === 0 && posts.length > 0) {
                 grid.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-10 text-xs">Sin resultados para este filtro.</div>';
            }
        }
        
        function clearCharacterFilter() {
            currentCharacterFilter = null;
            renderProfileGrid(allUserPostsCache);
        }

        function filterByCharacterFromModal() {
            const name = document.getElementById('modal-character-name').innerText;
            document.getElementById('close-modal').click();
            currentCharacterFilter = name;
            renderProfileGrid(allUserPostsCache);
            window.scrollTo({top:0, behavior:'smooth'});
        }
        
        // --- VIEWER ---
        function openMainViewer(postsArray, startIndex, startInternalIndex = 0) {
            currentViewPosts = postsArray; currentPostIndex = startIndex; 
            window.currentInternalIndex = startInternalIndex;
            updateViewerContent();
            const modal = document.getElementById('modal'); modal.classList.add('visible'); modal.classList.remove('fullscreen-mode'); 
            document.body.classList.add('body-lock'); 
        }

        function updateViewerContent() {
            if (currentPostIndex < 0 || currentPostIndex >= currentViewPosts.length) return;
            const post = currentViewPosts[currentPostIndex];
            const images = post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);
            let imgToShow = "";
            
            // ValidaciÃ³n de Ã­ndice interno
            if (typeof window.currentInternalIndex === 'undefined' || window.currentInternalIndex >= images.length) {
                window.currentInternalIndex = 0;
            }
            if (images.length > 0) imgToShow = images[window.currentInternalIndex];

            document.getElementById('modal-image').src = imgToShow;
            document.getElementById('modal-title').textContent = post.title || 'Sin tÃ­tulo';
            document.getElementById('modal-desc').innerHTML = (post.text || '').replace(/#(\w+)/g, '<span class="text-orange-400 font-bold cursor-pointer hover:underline">#$1</span>');
            document.getElementById('modal-user-name').textContent = post.userName || 'Usuario';
            
            const charTag = document.getElementById('modal-character-tag');
            if(post.characterName) { charTag.classList.remove('hidden'); document.getElementById('modal-character-name').textContent = post.characterName; } else { charTag.classList.add('hidden'); }

            const userImgEl = document.getElementById('modal-user-pic');
            userImgEl.src = post.userAvatar || 'https://placehold.co/100x100/333/666?text=U';
            if (post.userId) { db.ref('users/' + post.userId).once('value', snapshot => { const u = snapshot.val(); if (u && u.profilePic) userImgEl.src = u.profilePic; }); }
            
            const delBtn = document.getElementById('modal-delete-btn');
            if (currentUser && currentUser.uid === post.userId) { delBtn.classList.remove('hidden'); delBtn.onclick = () => confirmDeletePost(post.id); } else { delBtn.classList.add('hidden'); delBtn.onclick = null; }

            const tagsDiv = document.getElementById('modal-tags'); const tagsBtn = document.getElementById('tags-toggle-btn');
            tagsDiv.classList.add('hidden'); tagsBtn.innerHTML = '<span>Ver etiquetas</span> <i class="fas fa-chevron-down"></i>'; tagsDiv.innerHTML = '';
            if (post.tags && post.tags.trim().length > 0) { post.tags.split(',').forEach(t => { if(t.trim()) tagsDiv.innerHTML += `<span class="text-[10px] bg-zinc-800 text-gray-300 px-2.5 py-1 rounded-full border border-zinc-700 font-medium">#${t.trim()}</span>`; }); tagsBtn.style.display = 'flex'; } else { tagsBtn.style.display = 'none'; }

            const likeBtn = document.getElementById('modal-like-btn'); const likesCount = document.getElementById('modal-likes-count');
            likeBtn.onclick = () => toggleLikeInViewer(post.id);
            const uid = currentUser ? currentUser.uid : 'anon';
            db.ref(`feed_likes/${post.id}`).off(); db.ref(`feed_posts/${post.id}/likes`).off();
            db.ref(`feed_likes/${post.id}/${uid}`).on('value', s => { if(s.exists()) { likeBtn.classList.add('text-red-500', 'bg-red-500/10', 'border-red-500/30'); likeBtn.querySelector('i').className = "fas fa-heart text-lg text-red-500 transition-transform duration-200 transform scale-110"; } else { likeBtn.classList.remove('text-red-500', 'bg-red-500/10', 'border-red-500/30'); likeBtn.querySelector('i').className = "far fa-heart text-lg text-gray-400"; } });
            db.ref(`feed_posts/${post.id}/likes`).on('value', s => likesCount.innerText = s.val() || 0);

            const commentsList = document.getElementById('modal-comments-list'); commentsList.innerHTML = '';
            db.ref(`feed_comments/${post.id}`).off();
            db.ref(`feed_comments/${post.id}`).on('child_added', s => { const c = s.val(); const div = document.createElement('div'); div.className = "flex gap-3 items-start text-sm animate-enter"; div.innerHTML = `<img src="${c.userAvatar}" class="w-8 h-8 rounded-full mt-1 border border-zinc-700 object-cover flex-shrink-0"><div class="bg-zinc-800/50 p-3 rounded-2xl rounded-tl-none border border-zinc-700/50 w-full"><span class="font-bold text-gray-300 block text-xs mb-1">${c.userName}</span><span class="text-gray-200 leading-snug block break-words font-light">${c.text}</span></div>`; commentsList.appendChild(div); });
            
            // Navigation Buttons Visibility
            const isLastImg = window.currentInternalIndex === images.length - 1; 
            const isLastPost = currentPostIndex === currentViewPosts.length - 1; 
            const isFirstImg = window.currentInternalIndex === 0; 
            const isFirstPost = currentPostIndex === 0;
            
            document.getElementById('modal-prev').style.display = (!isFirstImg || !isFirstPost) ? 'flex' : 'none';
            document.getElementById('modal-next').style.display = (!isLastImg || !isLastPost) ? 'flex' : 'none';
        }
        
        function navigateModal(dir) {
            const post = currentViewPosts[currentPostIndex]; 
            const images = post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);
            
            if (dir === 1) { // NEXT
                if (window.currentInternalIndex < images.length - 1) {
                    window.currentInternalIndex++;
                } else {
                    if (currentPostIndex < currentViewPosts.length - 1) {
                        currentPostIndex++;
                        window.currentInternalIndex = 0;
                    }
                }
            } else { // PREV
                if (window.currentInternalIndex > 0) {
                    window.currentInternalIndex--;
                } else {
                    if (currentPostIndex > 0) {
                        currentPostIndex--;
                        // Set to last image of previous post
                        const prevPost = currentViewPosts[currentPostIndex];
                        const prevImages = prevPost.imageUrls || (prevPost.imageUrl ? [prevPost.imageUrl] : []);
                        window.currentInternalIndex = prevImages.length - 1;
                    }
                }
            }
            updateViewerContent();
        }

        // Swipe Gestures for Viewer
        const modalEl = document.getElementById('modal-image-area');
        modalEl.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX, {passive:true});
        modalEl.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            if (Math.abs(touchEndX - touchStartX) > 50) { if (touchEndX < touchStartX) navigateModal(1); else navigateModal(-1); }
        }, {passive:true});

        document.getElementById('close-modal').onclick = () => { const post = currentViewPosts[currentPostIndex]; if(post) { db.ref(`feed_likes/${post.id}`).off(); db.ref(`feed_posts/${post.id}/likes`).off(); db.ref(`feed_comments/${post.id}`).off(); } document.getElementById('modal').classList.remove('visible'); document.body.classList.remove('body-lock'); };

        // --- USER PROFILE & SOCIALS LOGIC ---
        function loadUserProfile() {
            db.ref('users/' + targetUserId).on('value', snap => {
                const d = snap.val(); if(!d) return;
                document.getElementById('username-display').innerText = d.username || 'Usuario';
                document.getElementById('profile-image').src = d.profilePic || 'https://placehold.co/150x150/333/666?text=U';
                document.getElementById('welcome-msg').innerText = d.slogan || "Sin descripciÃ³n...";
                if(d.bannerUrl) document.getElementById('profile-banner-img').src = d.bannerUrl;
                
                // --- MOSTRAR ESTADO DE ARTISTA (CORREGIDO) ---
                const statusMap = {
                    'open': { text: 'ðŸŸ¢ Comisiones Abiertas', class: 'bg-green-500/10 text-green-400 border-green-500/20' },
                    'closed': { text: 'ðŸ”´ Cerrado', class: 'bg-red-500/10 text-red-400 border-red-500/20' },
                    'collab': { text: 'ðŸ”µ Colaboraciones', class: 'bg-blue-500/10 text-blue-400 border-blue-500/20' },
                    'hiatus': { text: 'âšª Hiatus', class: 'bg-zinc-500/10 text-gray-400 border-zinc-500/20' }
                };
                const statusData = statusMap[d.artistStatus];
                const badge = document.getElementById('user-status-badge');
                if (statusData) {
                    badge.className = `inline-flex items-center px-3 py-1 rounded-full text-xs font-bold border ${statusData.class} mt-2`;
                    badge.innerText = statusData.text;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
                
                const box = document.getElementById('social-links-container'); box.innerHTML = '';
                const soc = d.socials || {}; let has=false;
                const list = [
                    {k:'facebook',i:'fab fa-facebook',c:'social-facebook'},
                    {k:'x',i:'fab fa-x-twitter',c:'social-x'},
                    {k:'instagram',i:'fab fa-instagram',c:'social-instagram'},
                    {k:'youtube',i:'fab fa-youtube',c:'social-youtube'},
                    {k:'twitch',i:'fab fa-twitch',c:'social-twitch'}, 
                    {k:'whatsapp',i:'fab fa-whatsapp',c:'social-whatsapp'}, 
                    {k:'telegram',i:'fab fa-telegram',c:'social-telegram'}, 
                    {k:'patreon',i:'fab fa-patreon',c:'social-patreon'},
                    {k:'yodayo',i:'fas fa-robot',c:'social-yodayo'},
                    {k:'pixai',i:'fas fa-palette',c:'social-pixai'}
                ];
                list.forEach(p => { if(soc[p.k]) { has=true; box.innerHTML += `<a href="${soc[p.k]}" target="_blank" class="social-link ${p.c}"><i class="${p.i}"></i></a>`; } });
                box.style.display = has?'flex':'none';

                if(currentUser && currentUser.uid === targetUserId) {
                    if(d.artistStatus) selectCustomOption('dropdown-status', d.artistStatus, 'Estado actual');
                    if(d.username) document.getElementById('edit-username').value = d.username;
                    if(d.kofiId) document.getElementById('kofi-id').value = d.kofiId;
                    if(d.paypalId) document.getElementById('paypal-id').value = d.paypalId;
                    
                    const editContainer = document.getElementById('socials-edit-list');
                    editContainer.innerHTML = '';
                    list.forEach(item => {
                        if(soc[item.k]) {
                            addSocialInput(item.k, item.k.charAt(0).toUpperCase() + item.k.slice(1), item.i + " " + item.c.replace('social-','text-').replace('text-white','text-gray-200'));
                            const inp = document.getElementById('social-' + item.k);
                            if(inp) inp.value = soc[item.k];
                        }
                    });
                }
            });
        }

        // --- SUGGESTIONS (COPIED FROM FEED) ---
        function setupCharacterSuggestions() {
            const charInput = document.getElementById('post-character');
            const suggestionsBox = document.getElementById('character-suggestions');
            charInput.addEventListener('input', (e) => {
                const val = e.target.value.trim().toLowerCase();
                if (!val) { suggestionsBox.classList.remove('visible'); return; }
                const allChars = Object.entries(characterStatsCache).map(([key, data]) => ({ id: key, name: data.displayName, count: data.count || 0 }));
                const matches = allChars.filter(c => c.name.toLowerCase().includes(val)).sort((a, b) => b.count - a.count).slice(0, 3);
                if (matches.length > 0) { renderSuggestions(matches); suggestionsBox.classList.add('visible'); } else { suggestionsBox.classList.remove('visible'); }
            });
            document.addEventListener('click', (e) => { if (!charInput.contains(e.target) && !suggestionsBox.contains(e.target)) { suggestionsBox.classList.remove('visible'); } });
        }
        
        function renderSuggestions(matches) {
            const suggestionsBox = document.getElementById('character-suggestions');
            suggestionsBox.innerHTML = '';
            matches.forEach((match, index) => {
                const isTop = index === 0; 
                const countDisplay = (match.count >= 1000) ? (match.count / 1000).toFixed(1) + 'k' : match.count;
                const div = document.createElement('div'); div.className = 'suggestion-item'; div.onclick = () => selectSuggestion(match.name);
                div.innerHTML = `<span class="suggestion-name flex items-center gap-2 text-white">${match.name}${isTop && match.count > 0 ? '<i class="fas fa-check-circle verified-badge text-green-400 text-xs"></i>' : ''}</span><span class="text-xs text-gray-500">${countDisplay} usos</span>`;
                suggestionsBox.appendChild(div);
            });
        }
        function selectSuggestion(name) { document.getElementById('post-character').value = name; document.getElementById('character-suggestions').classList.remove('visible'); }

        function addSocialInput(key, label, iconClass) {
            const container = document.getElementById('socials-edit-list');
            if(document.getElementById('social-' + key)) return;
            const div = document.createElement('div');
            div.className = "relative group animate-enter";
            div.innerHTML = `<i class="${iconClass} absolute left-3 top-1/2 -translate-y-1/2"></i><input type="url" id="social-${key}" placeholder="${label} Link" class="custom-input pl-10 social-input-field" data-key="${key}">`;
            container.appendChild(div);
            const dd = document.querySelector('#dropdown-add-social .custom-select-options');
            if(dd) { dd.classList.remove('show'); dd.parentElement.querySelector('.custom-select-trigger').classList.remove('active'); }
        }

        async function saveDetails() {
            const status = document.getElementById('artist-status').value;
            const kofiId = document.getElementById('kofi-id').value.trim();
            const paypalId = document.getElementById('paypal-id').value.trim();
            const newUsername = document.getElementById('edit-username').value.trim();
            const socials = {};
            document.querySelectorAll('.social-input-field').forEach(input => {
                if(input.value.trim()) socials[input.dataset.key] = input.value.trim();
            });
            
            try {
                await db.ref('users/'+currentUser.uid).update({ socials, artistStatus:status, kofiId, paypalId, username: newUsername || currentUserData.username });
                if (newUsername && newUsername !== currentUserData.username) {
                    const postsSnap = await db.ref('feed_posts').orderByChild('userId').equalTo(currentUser.uid).once('value');
                    if (postsSnap.exists()) { const updates = {}; postsSnap.forEach(child => { updates[`feed_posts/${child.key}/userName`] = newUsername; }); await db.ref().update(updates); }
                }
                closeEditModal(); showToast("Perfil actualizado");
            } catch(e) { showAlert("Error al guardar: " + e.message); }
        }

        function openEditModal() { document.getElementById('details-modal').classList.remove('hidden'); document.getElementById('details-modal').classList.add('flex'); document.body.classList.add('body-lock'); }
        function closeEditModal() { document.getElementById('details-modal').classList.add('hidden'); document.getElementById('details-modal').classList.remove('flex'); document.body.classList.remove('body-lock'); }

        function saveSlogan() { const s = document.getElementById('slogan-input').value.trim(); db.ref('users/'+currentUser.uid).update({slogan:s}).then(()=>toggleSloganEdit()); }
        function toggleSloganEdit() { const d=document.getElementById('slogan-display-container'), e=document.getElementById('slogan-edit-container'); if(e.classList.contains('hidden')){d.classList.add('hidden');e.classList.remove('hidden');}else{d.classList.remove('hidden');e.classList.add('hidden');} }

        // --- COMMON UPLOADS ---
        async function handleBannerUpload(e) { const f = e.target.files[0]; if(!f) return; document.getElementById('banner-loading').classList.remove('hidden'); try { const fileToUpload = await compressImage(f); const fd = new FormData(); fd.append('reqtype', 'fileupload'); fd.append('userhash', CATBOX_USERHASH); fd.append('fileToUpload', fileToUpload); const res = await fetch("https://corsproxy.io/?https://catbox.moe/user/api.php", {method:'POST', body:fd}); const txt = await res.text(); if(txt.includes('catbox.moe')) { db.ref('users/'+currentUser.uid).update({bannerUrl:txt.trim()}); showToast("Portada actualizada"); } } catch(err){ showAlert("Error banner."); } finally{document.getElementById('banner-loading').classList.add('hidden');} }
        function loadUserCollectionsSelect() { if (!currentUser) return; db.ref('collections/' + currentUser.uid).on('value', snap => { let html = `<div class="option-item" onclick="selectCustomOption('dropdown-collection', '', '<i class=\\'fas fa-folder mr-2 text-xs text-orange-500\\'></i> NingÃºn Ãlbum')">NingÃºn Ãlbum</div><div class="option-item special-option" onclick="selectCustomOption('dropdown-collection', 'new', 'âž• Crear Nueva ColecciÃ³n...')">âž• Crear Nueva ColecciÃ³n...</div>`; snap.forEach(child => { html += `<div class="option-item" onclick="selectCustomOption('dropdown-collection', '${child.key}', 'ðŸ“ ${child.val().name}')">ðŸ“ ${child.val().name}</div>`; }); const el = document.getElementById('collection-options-list'); if(el) el.innerHTML = html; }); }
        function toggleCollectionInput() { const val = document.getElementById('post-collection').value; const c = document.getElementById('new-collection-container'); if(val === 'new') c.classList.remove('hidden'); else c.classList.add('hidden'); }
        function loadUserCollectionsGrid(autoOpenColId) { const grid = document.getElementById('collections-grid'), noMsg = document.getElementById('no-collections-msg'); db.ref('collections/' + targetUserId).on('value', snap => { grid.innerHTML = ''; if (!snap.exists()) { noMsg.classList.remove('hidden'); return; } noMsg.classList.add('hidden'); snap.forEach(c => { const col = c.val(); const colId = c.key; let coverHtml = ''; if (col.previews && Array.isArray(col.previews) && col.previews.length > 0) { if (col.previews.length === 1) coverHtml = `<img src="${col.previews[0]}" class="collection-cover-single transition duration-700 group-hover:scale-110">`; else { let imgs = ''; col.previews.slice(0, 4).forEach(url => { imgs += `<img src="${url}">`; }); coverHtml = `<div class="collection-cover-grid transition duration-700 group-hover:scale-105">${imgs}</div>`; } } else { const cover = (col.cover && col.cover !== 'pending') ? col.cover : 'https://placehold.co/300x300/18181b/333?text=...'; coverHtml = `<img src="${cover}" class="collection-cover-single transition duration-700 group-hover:scale-110">`; } const card = document.createElement('div'); card.className = 'collection-card group'; card.onclick = () => openCollectionDetail(colId, col.name); grid.appendChild(card); }); if(autoOpenColId) { switchTab('collections'); openCollectionDetail(autoOpenColId, "Cargando..."); db.ref(`collections/${targetUserId}/${autoOpenColId}/name`).once('value', s=> { if(s.exists()) document.getElementById('detail-collection-title').innerText = s.val(); }); } }); }
        function openCollectionDetail(colId, colName) { currentCollectionId = colId; document.getElementById('detail-collection-title').innerText = colName; document.getElementById('collection-detail-view').classList.remove('translate-x-full'); document.body.classList.add('body-lock'); const delBtn = document.getElementById('delete-collection-btn'); if(currentUser && currentUser.uid === targetUserId) delBtn.classList.remove('hidden'); else delBtn.classList.add('hidden'); loadCollectionPosts(colId); }
        function closeCollectionDetail() { document.getElementById('collection-detail-view').classList.add('translate-x-full'); document.body.classList.remove('body-lock'); currentCollectionId = null; }
        function loadCollectionPosts(colId) { const grid = document.getElementById('detail-collection-grid'), emptyMsg = document.getElementById('detail-empty-msg'); grid.innerHTML = '<div class="col-span-3 text-center py-10"><i class="fas fa-circle-notch fa-spin text-orange-500"></i></div>'; db.ref('feed_posts').orderByChild('userId').equalTo(targetUserId).limitToLast(200).once('value', snap => { grid.innerHTML = ''; let colPosts = []; if(snap.exists()){ snap.forEach(c => { const p = c.val(); if(p.collectionId === colId && (p.imageUrl || (p.imageUrls && p.imageUrls.length > 0))) { p.id = c.key; colPosts.push(p); } }); } if (colPosts.length === 0) { emptyMsg.classList.remove('hidden'); return; } emptyMsg.classList.add('hidden'); colPosts.sort((a,b) => b.timestamp - a.timestamp); colPosts.forEach((post, idx) => { const images = post.imageUrls || (post.imageUrl ? [post.imageUrl] : []); images.forEach((imgUrl, imgIdx) => { const div = document.createElement('div'); div.className = "grid-item"; div.onclick = () => openMainViewer(colPosts, idx, imgIdx); div.innerHTML = `<img src="${imgUrl}" class="grid-image" loading="lazy">`; grid.appendChild(div); }); }); }); }
        function deleteCurrentCollection() { showConfirm("Â¿Eliminar colecciÃ³n?", () => { db.ref(`collections/${currentUser.uid}/${currentCollectionId}`).remove(); closeCollectionDetail(); showToast("Eliminado"); }, "Eliminar Ãlbum"); }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const maxSizeKB = 150; if (file.size / 1024 <= maxSizeKB) { resolve(file); return; }
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = function(event) {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, img.width, img.height);
                        let quality = 0.9, attempts = 0;
                        const tryCompress = () => { canvas.toBlob((blob) => { if (!blob) { reject(new Error("Error")); return; } if ((blob.size / 1024) <= maxSizeKB || quality <= 0.1 || attempts >= 20) { resolve(new File([blob], file.name.replace(/\.[^/.]+$/, ".jpg"), { type: "image/jpeg", lastModified: Date.now() })); } else { quality -= 0.05; attempts++; tryCompress(); } }, 'image/jpeg', quality); }; tryCompress();
                    }; img.onerror = error => reject(error);
                }; reader.onerror = error => reject(error);
            });
        }
        function toggleTags() { const div = document.getElementById('modal-tags'); const btn = document.getElementById('tags-toggle-btn'); if (div.classList.contains('hidden')) { div.classList.remove('hidden'); btn.innerHTML = '<span>Ocultar etiquetas</span> <i class="fas fa-chevron-up"></i>'; } else { div.classList.add('hidden'); btn.innerHTML = '<span>Ver etiquetas</span> <i class="fas fa-chevron-down"></i>'; } }
        function toggleFullScreen() { document.getElementById('modal').classList.toggle('fullscreen-mode'); }
        function confirmDeletePost(postId) { showConfirm("Â¿Borrar permanentemente?", () => executeDelete(postId), "Eliminar obra"); }
        function executeDelete(postId) { db.ref('feed_posts/' + postId).remove().then(() => { db.ref('feed_likes/' + postId).remove(); db.ref('feed_comments/' + postId).remove(); document.getElementById('modal').classList.remove('visible'); document.body.classList.remove('body-lock'); showToast("Eliminado"); loadUserPosts(); if(currentCollectionId) loadCollectionPosts(currentCollectionId); }).catch(error => { console.error(error); showAlert("Error al eliminar."); }); }
        function toggleLikeInViewer(postId) { if(!currentUser) { showAlert("Inicia sesiÃ³n."); return; } const ref = db.ref(`feed_likes/${postId}/${currentUser.uid}`); ref.once('value', s => { if(s.exists()) { ref.remove(); db.ref(`feed_posts/${postId}/likes`).transaction(c => (c||1)-1); } else { ref.set(true); db.ref(`feed_posts/${postId}/likes`).transaction(c => (c||0)+1); } }); }
        function postCommentInModal(e) { e.preventDefault(); const input = document.getElementById('modal-comment-input'); const post = currentViewPosts[currentPostIndex]; if(!input.value.trim() || !post) return; if(!currentUser) { showAlert("Inicia sesiÃ³n."); return; } const c = { text: input.value, userId: currentUser.uid, userName: (currentUserData && currentUserData.username) ? currentUserData.username : (currentUser.displayName || 'Anon'), userAvatar: (currentUserData && currentUserData.profilePic) ? currentUserData.profilePic : 'https://placehold.co/100x100/333/666?text=U', timestamp: Date.now() }; db.ref(`feed_comments/${post.id}`).push(c); input.value = ''; }
        function openShareModal() { const u = new URL(window.location.href); u.searchParams.set('uid', targetUserId); document.getElementById('share-link-input').value = u.toString(); document.getElementById('share-modal').classList.remove('hidden'); document.getElementById('share-modal').classList.add('flex'); }
        function copyLinkFromModal() { const i = document.getElementById('share-link-input'); i.select(); i.setSelectionRange(0, 99999); navigator.clipboard.writeText(i.value).then(()=>{ document.getElementById('share-modal').classList.add('hidden'); document.getElementById('share-modal').classList.remove('flex'); showToast("Copiado"); }); }
        
        // --- ACTION 3: LOGOUT REDIRECT ---
        function logout() { 
            auth.signOut().then(() => { 
                window.location.href = 'login.html'; 
            }); 
        }
    </script>
</body>
</html>