<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>Genexenart v3</title>
    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Cargar Material Icons (Outlined) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <!-- Cargar Gradio (para Tagger) -->
    <script type="module" src="https://gradio.s3-us-west-2.amazonaws.com/5.29.0/gradio.js"></script>

    <style>
        /* Estilos base inspirados en Material Design 3 (Dark) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-dark-primary: #121212;
            --bg-dark-surface-1: #1E1E1E;
            --bg-dark-surface-2: #2C2C2C;
            --text-primary: #E0E0E0;
            --text-secondary: #BDBDBD;
            --accent-primary: #82b1ff; /* Azul Material */
            --accent-secondary: #448aff;
            --accent-danger: #ff5252;
        }

        /* (NUEVO) Scroll suave */
        html {
            scroll-behavior: smooth;
        }

        body, html {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            height: 100%;
            background-color: var(--bg-dark-primary);
            color: var(--text-primary);
            overscroll-behavior: none; /* Evitar rebote */
        }
        
        /* Ocultar elementos por defecto */
        #app-container { display: none; }
        
        #app-main-content {
            padding-bottom: 120px; /* Espacio para el botón de generar fijo */
        }

        /* HEADER/NAV ESTILO ANDROID */
        .app-header {
            background-color: var(--bg-dark-surface-1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            position: sticky; top: 0; z-index: 20;
        }
        .tab-nav-container {
            display: flex;
            align-items: center;
            overflow-x: auto;
            white-space: nowrap;
            border-bottom: 1px solid var(--bg-dark-surface-2);
            /* Ocultar scrollbar */
            -ms-overflow-style: none;  /* IE y Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .tab-nav-container::-webkit-scrollbar { display: none; } /* Chrome, Safari y Opera */

        .tab-btn {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 2px;
            flex: 1 0 auto; /* No encoger, base automática */
            padding: 10px 16px;
            font-weight: 600; font-size: 0.75rem;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            text-align: center;
            transition: all 0.3s ease;
            min-width: 80px; /* Ancho mínimo por pestaña */
        }
        .tab-btn .material-icons-outlined {
            font-size: 22px;
        }
        .tab-btn.active {
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        
        /* Ocultar paneles inactivos */
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Tarjeta de Contenido */
        .content-card {
            background-color: var(--bg-dark-surface-1);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        /* Tarjeta colapsable */
        .collapsible-card details summary {
            cursor: pointer;
            font-size: 1.25rem; font-weight: 700;
            list-style: none; /* Ocultar flecha por defecto */
        }
        .collapsible-card summary::before {
            content: 'expand_more'; /* Icono Material */
            font-family: 'Material Icons Outlined';
            font-size: 24px;
            margin-right: 8px;
            display: inline-block;
            transition: transform 0.2s ease;
        }
        .collapsible-card details[open] summary::before {
            transform: rotate(180deg);
        }

        /* Campos de formulario - Estilo App */
        .input-base {
            display: block; width: 100%; padding: 12px 14px;
            background-color: var(--bg-dark-surface-2); 
            border: 2px solid #424242; 
            border-radius: 12px;
            color: var(--text-primary); placeholder-color: #757575;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-base:focus {
            outline: none; border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-primary);
        }
        .input-base:disabled {
            opacity: 0.5;
            background-color: #3a3a3a;
        }
        select.input-base {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='http://www.w3.org/2000/svg'%3e%3cpath stroke='%23BDBDBD' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        textarea.input-base { resize: vertical; }
        .label-base {
            display: block; text-transform: uppercase;
            font-size: 0.75rem; font-weight: 600;
            color: var(--text-secondary); margin-bottom: 0.5rem;
        }

        /* Grupo de botones de UI */
        .btn-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Botón de UI (Icono) */
        .btn-ui {
            background-color: var(--bg-dark-surface-2);
            border: 2px solid #424242;
            color: var(--text-primary);
            padding: 8px;
            border-radius: 12px;
            transition: background-color 0.2s, border-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .btn-ui:hover { background-color: #424242; border-color: #616161; }
        .btn-ui:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-ui .material-icons-outlined { font-size: 20px; }
        
        /* Botón de UI (Principal) */
        .btn-ui-primary {
            background-color: var(--accent-secondary);
            border-color: var(--accent-secondary);
            color: white;
            padding: 10px 16px;
            font-weight: 600;
            gap: 0.5rem;
        }
        .btn-ui-primary:hover { background-color: var(--accent-primary); }

        /* Botón de Generar Fijo (Floating Action Button - FAB) */
        #footer-fab-container {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            padding: 1rem;
            background: linear-gradient(180deg, rgba(18, 18, 18, 0) 0%, var(--bg-dark-primary) 80%);
            z-index: 30;
        }
        .generate-btn {
            width: 100%;
            background-color: var(--accent-primary);
            color: var(--bg-dark-primary);
            font-weight: 700; font-size: 1rem;
            padding: 16px 24px; border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .generate-btn .material-icons-outlined { font-size: 24px; }
        .generate-btn:hover { background-color: #a9c7ff; }
        .generate-btn:disabled { 
            background-color: #424242;
            color: #757575;
            cursor: not-allowed; 
        }
        
        /* Botón de Interrumpir */
        .interrupt-btn {
            background-color: var(--accent-danger);
            color: white;
            border-color: var(--accent-danger);
            padding: 8px 12px;
            font-weight: 600;
            gap: 0.5rem;
        }

        /* Layout */
        .main-grid {
            display: grid; grid-template-columns: 1fr; gap: 1.5rem;
        }
        @media (min-width: 768px) {
            .main-grid {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        /* Imagen de Salida */
        #output-image {
            object-fit: contain; width: 100%; height: auto;
            max-height: 100%; border-radius: 12px;
            cursor: pointer; /* (NUEVO) Cursor para indicar que es clickeable */
        }
        #image-container {
            min-height: 300px; aspect-ratio: 1 / 1;
        }
        
        /* Vista previa de imagen (para i2i, ControlNet, Extras) */
        .image-preview-box {
            background-color: var(--bg-dark-primary);
            border: 2px dashed #424242;
            border-radius: 12px;
            min-height: 128px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            position: relative;
        }
        .image-preview-box img {
            max-height: 200px;
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            display: none; /* Oculta por defecto */
        }
        .image-preview-box span { /* Placeholder */
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        .image-preview-box img.active { display: block; }
        .image-preview-box span.hidden { display: none; }
        
        /* Estilos para Gradio App */
        gradio-app {
            background-color: var(--bg-dark-surface-1) !important;
            border: none !important;
            border-radius: 16px;
        }
        
        /* (NUEVO) Estilos del Visor Modal de Imagen */
        #image-viewer-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: none; /* Oculto por defecto */
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        #image-viewer-modal.active {
            display: flex;
        }
        #modal-image {
            max-width: 95vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #modal-close-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background-color: rgba(30, 30, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 99px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #modal-close-btn:hover {
            background-color: rgba(50, 50, 50, 0.9);
        }

    </style>
</head>
<body class="h-full">

    <!-- ======================= -->
    <!-- PANTALLA INICIAL DE CONEXIÓN -->
    <!-- ======================= -->
    <div id="splash-screen" class="fixed inset-0 bg-gray-900 flex items-center justify-center p-4 z-50">
        <div class="w-full max-w-sm bg-gray-800 shadow-2xl rounded-xl p-6 text-white">
            <h1 class="text-2xl font-bold text-center mb-6 text-blue-400">Genexenart v3</h1>
            
            <label for="gradio-url" class="block text-sm font-medium text-gray-400 mb-2">URL de Gradio (https://)</label>
            <input type="text" id="gradio-url" class="input-base" placeholder="Ej: https://xxxxxxxxx.gradio.app">
            
            <button id="connect-btn" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-200 ease-in-out flex items-center justify-center">
                Conectar
            </button>

            <div id="initial-status-message" class="text-center text-gray-500 mt-4 text-sm">Ingresa la URL y presiona conectar.</div>
        </div>
    </div>


    <!-- ======================= -->
    <!-- APLICACIÓN PRINCIPAL -->
    <!-- ======================= -->
    <div id="app-container" class="min-h-full">
        
        <!-- HEADER / NAVEGACIÓN TIPO APP -->
        <header class="app-header">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <!-- Tabs Deslizables -->
                <nav id="main-ui" class="tab-nav-container flex-1">
                    <button id="tab-btn-txt2img" class="tab-btn active">
                        <span class="material-icons-outlined">text_fields</span>
                        Txt2Img
                    </button>
                    <button id="tab-btn-img2img" class="tab-btn">
                        <span class="material-icons-outlined">image</span>
                        Img2Img
                    </button>
                    <button id="tab-btn-extras" class="tab-btn">
                        <span class="material-icons-outlined">add_photo_alternate</span>
                        Extras
                    </button>
                    <button id="tab-btn-tagger" class="tab-btn">
                        <span class="material-icons-outlined">label</span>
                        Tagger
                    </button>
                    <button id="tab-btn-config" class="tab-btn">
                        <span class="material-icons-outlined">settings</span>
                        Config
                    </button>
                </nav>
                <!-- Botón de Refrescar -->
                <button id="refresh-resources-btn" class="btn-ui p-3 m-2" title="Refrescar Recursos">
                    <span class="material-icons-outlined">refresh</span>
                </button>
            </div>
        </header>

        <!-- CONTENIDO PRINCIPAL -->
        <main id="app-main-content" class="max-w-7xl mx-auto p-4 md:p-6">
            <div class="main-grid">

                <!-- COLUMNA 1: CONFIGURACIÓN -->
                <div class="h-fit">
                    
                    <!-- ======================= -->
                    <!-- Panel Txt2Img -->
                    <!-- ======================= -->
                    <div id="panel-txt2img" class="tab-panel active">
                        <!-- Prompts -->
                        <div class="content-card">
                            <h2 class="text-xl font-bold mb-4 text-white">Prompts</h2>
                            <div class="space-y-4">
                                <!-- Prompt Positivo -->
                                <div class="relative">
                                    <div class="flex justify-between items-center mb-2">
                                        <label for="prompt-t2i" class="label-base" style="margin-bottom: 0;">Prompt Positivo</label>
                                        <button class="btn-ui auto-prompt-btn" data-target="prompt-t2i" title="Generar Prompt Aleatorio">
                                            <span class="material-icons-outlined" style="font-size: 20px;">auto_awesome</span>
                                        </button>
                                    </div>
                                    <textarea id="prompt-t2i" rows="4" class="input-base" placeholder="best quality, 1girl, ..."></textarea>
                                </div>
                                <!-- Prompt Negativo -->
                                <div>
                                    <label for="negative-prompt-t2i" class="label-base">Prompt Negativo</label>
                                    <textarea id="negative-prompt-t2i" rows="4" class="input-base" placeholder="worst quality, ...">worst quality, low quality, lowres, (deformed, distorted, disfigured:1.3), bad anatomy, bad hands, (missing fingers), (extra fingers), (fused fingers), (extra limbs), (fused limbs), (missing limbs), (extra digit), (fused digit), (mutated hands:1.3), (poorly drawn hands:1.3), (poorly drawn face:1.3), (long neck:1.3), (extra legs)</textarea>
                                </div>
                                <!-- Estilos -->
                                <div>
                                    <label for="styles-t2i" class="label-base">Estilos</label>
                                    <select id="styles-t2i" class="input-base"></select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Parámetros T2I -->
                        <div class="content-card">
                            <h2 class="text-xl font-bold mb-4 text-white">Parámetros</h2>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="model-t2i" class="label-base">Modelo (Checkpoint)</label>
                                        <select id="model-t2i" class="input-base"></select>
                                    </div>
                                    <div>
                                        <label for="vae-t2i" class="label-base">VAE</label>
                                        <select id="vae-t2i" class="input-base"></select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="sampler-t2i" class="label-base">Sampler</label>
                                        <select id="sampler-t2i" class="input-base"></select>
                                    </div>
                                    <div>
                                        <label for="scheduler-t2i" class="label-base">Scheduler</label>
                                        <select id="scheduler-t2i" class="input-base"></select>
                                    </div>
                                </div>
                                <div class="flex gap-4 items-end">
                                    <div class="flex-grow">
                                        <label for="lora-t2i" class="label-base">Loras</label>
                                        <select id="lora-t2i" class="input-base"></select>
                                    </div>
                                    <button class="btn-ui add-lora-btn flex-shrink-0" data-target="prompt-t2i" title="Añadir Lora">
                                        <span class="material-icons-outlined">add</span>
                                    </button>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="width-t2i" class="label-base">Ancho</label>
                                        <input type="number" id="width-t2i" step="64" value="1024" class="input-base">
                                    </div>
                                    <div>
                                        <label for="height-t2i" class="label-base">Alto</label>
                                        <input type="number" id="height-t2i" step="64" value="1024" class="input-base">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="steps-t2i" class="label-base">Pasos</label>
                                        <input type="number" id="steps-t2i" value="20" class="input-base">
                                    </div>
                                    <div>
                                        <label for="cfg-t2i" class="label-base">CFG Scale</label>
                                        <input type="number" id="cfg-t2i" step="0.5" value="7.0" class="input-base">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="batch-count-t2i" class="label-base">Cant. Lotes</label>
                                        <input type="number" id="batch-count-t2i" value="1" class="input-base">
                                    </div>
                                    <div>
                                        <label for="seed-t2i" class="label-base">Semilla (Seed)</label>
                                        <div class="flex gap-2">
                                            <input type="number" id="seed-t2i" value="-1" class="input-base">
                                            <button id="random-seed-t2i" class="btn-ui flex-shrink-0" title="Semilla Aleatoria">
                                                <span class="material-icons-outlined">casino</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Restaurar Caras Dropdown -->
                                <div>
                                    <label for="face-restorer-t2i" class="label-base">Restaurar Caras</label>
                                    <select id="face-restorer-t2i" class="input-base"></select>
                                </div>
                            </div>
                        </div>

                        <!-- Hires. Fix -->
                        <div class="content-card collapsible-card">
                            <details id="hr-details-t2i">
                                <summary>Hires. Fix</summary>
                                <div id="hr-options-t2i" class="space-y-4 pt-4">
                                    <div>
                                        <label for="hr-upscaler-t2i" class="label-base">Upscaler</label>
                                        <select id="hr-upscaler-t2i" class="input-base"></select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="hr-scale-t2i" class="label-base">Escala</label>
                                            <input type="number" id="hr-scale-t2i" step="0.1" value="2.0" class="input-base">
                                        </div>
                                        <div>
                                            <label for="hr-steps-t2i" class="label-base">Pasos Hires</label>
                                            <input type="number" id="hr-steps-t2i" value="10" class="input-base">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="hr-denoising-t2i" class="label-base">Denoising Strength</label>
                                        <input type="number" id="hr-denoising-t2i" step="0.05" min="0" max="1" value="0.7" class="input-base">
                                    </div>
                                </div>
                            </details>
                        </div>
                        
                        <!-- ControlNet -->
                        <div class="content-card collapsible-card">
                            <details id="controlnet-details-t2i">
                                <summary>ControlNet</summary>
                                <div id="controlnet-options-t2i" class="space-y-4 pt-4">
                                    <label for="controlnet-image-upload-t2i" class="label-base">Imagen de ControlNet</label>
                                    <input type="file" id="controlnet-image-upload-t2i" accept="image/png, image/jpeg" class="block w-full text-sm text-gray-400 file:mr-4 file:px-4 file:py-2 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-600 file:text-gray-100 hover:file:bg-gray-500 cursor-pointer">
                                    <div class="image-preview-box">
                                        <img id="controlnet-image-preview-t2i" src="" alt="Vista previa ControlNet">
                                        <span id="controlnet-image-placeholder-t2i">Vista previa de ControlNet</span>
                                    </div>
                                    <div>
                                        <label for="controlnet-module-t2i" class="label-base">Pre-procesador</label>
                                        <select id="controlnet-module-t2i" class="input-base"></select>
                                    </div>
                                    <div>
                                        <label for="controlnet-model-t2i" class="label-base">Modelo</label>
                                        <select id="controlnet-model-t2i" class="input-base"></select>
                                    </div>
                                    <div>
                                        <label for="controlnet-weight-t2i" class="label-base">Peso (Weight)</label>
                                        <input type="number" id="controlnet-weight-t2i" step="0.1" value="1.0" class="input-base">
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>
                    
                    <!-- ======================= -->
                    <!-- Panel Img2Img -->
                    <!-- ======================= -->
                    <div id="panel-img2img" class="tab-panel">
                        <div class="content-card">
                            <h2 class="text-xl font-bold mb-4 text-white">Imagen de Origen</h2>
                            <div class="space-y-4">
                                <label for="image-upload-i2i" class="label-base">Subir Imagen</label>
                                <input type="file" id="image-upload-i2i" accept="image/png, image/jpeg" class="block w-full text-sm text-gray-400 file:mr-4 file:px-4 file:py-2 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-600 file:text-gray-100 hover:file:bg-gray-500 cursor-pointer">
                                <div class="image-preview-box">
                                    <img id="image-preview-i2i" src="" alt="Vista previa" class="active">
                                    <span id="image-preview-placeholder-i2i">Vista previa de la imagen</span>
                                </div>
                                <!-- Botones de Interrogar y PNG Info -->
                                <div class="btn-group">
                                    <button id="interrogate-btn-i2i" class="btn-ui flex-1 gap-2" title="Interrogar Imagen (CLIP)">
                                        <span class="material-icons-outlined">help_outline</span>
                                        Interrogar
                                    </button>
                                    <button id="pnginfo-btn-i2i" class="btn-ui flex-1 gap-2" title="Leer Parámetros (PNG Info)">
                                        <span class="material-icons-outlined">info</span>
                                        PNG Info
                                    </button>
                                </div>
                                <div>
                                    <label for="denoising-i2i" class="label-base">Denoising Strength</label>
                                    <input type="number" id="denoising-i2i" step="0.05" min="0" max="1" value="0.75" class="input-base">
                                </div>
                            </div>
                        </div>

                        <div class="content-card">
                            <h2 class="text-xl font-bold mb-4 text-white">Prompts</h2>
                            <div class="space-y-4">
                                <div class="relative">
                                    <div class="flex justify-between items-center mb-2">
                                        <label for="prompt-i2i" class="label-base" style="margin-bottom: 0;">Prompt Positivo</label>
                                        <button class="btn-ui auto-prompt-btn" data-target="prompt-i2i" title="Generar Prompt Aleatorio">
                                            <span class="material-icons-outlined" style="font-size: 20px;">auto_awesome</span>
                                        </button>
                                    </div>
                                    <textarea id="prompt-i2i" rows="4" class="input-base" placeholder="best quality, 1girl, ..."></textarea>
                                </div>
                                <div>
                                    <label for="negative-prompt-i2i" class="label-base">Prompt Negativo</label>
                                    <textarea id="negative-prompt-i2i" rows="4" class="input-base" placeholder="worst quality, ...">worst quality, low quality, lowres, (deformed, distorted, disfigured:1.3), bad anatomy, bad hands, (missing fingers), (extra fingers), (fused fingers), (extra limbs), (fused limbs), (missing limbs), (extra digit), (fused digit), (mutated hands:1.3), (poorly drawn hands:1.3), (poorly drawn face:1.3), (long neck:1.3), (extra legs)</textarea>
                                </div>
                                <div>
                                    <label for="styles-i2i" class="label-base">Estilos</label>
                                    <select id="styles-i2i" class="input-base"></select>
                                </div>
                            </div>
                        </div>

                        <!-- Parámetros I2I -->
                        <div class="content-card">
                             <h2 class="text-xl font-bold mb-4 text-white">Parámetros</h2>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="model-i2i" class="label-base">Modelo (Checkpoint)</label>
                                        <select id="model-i2i" class="input-base"></select>
                                    </div>
                                    <div>
                                        <label for="vae-i2i" class="label-base">VAE</label>
                                        <select id="vae-i2i" class="input-base"></select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="sampler-i2i" class="label-base">Sampler</label>
                                        <select id="sampler-i2i" class="input-base"></select>
                                    </div>
                                    <div>
                                        <label for="scheduler-i2i" class="label-base">Scheduler</label>
                                        <select id="scheduler-i2i" class="input-base"></select>
                                    </div>
                                </div>
                                <div class="flex gap-4 items-end">
                                    <div class="flex-grow">
                                        <label for="lora-i2i" class="label-base">Loras</label>
                                        <select id="lora-i2i" class="input-base"></select>
                                    </div>
                                    <button class="btn-ui add-lora-btn flex-shrink-0" data-target="prompt-i2i" title="Añadir Lora">
                                        <span class="material-icons-outlined">add</span>
                                    </button>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="width-i2i" class="label-base">Ancho Salida</label>
                                        <input type="number" id="width-i2i" step="64" value="1024" class="input-base">
                                    </div>
                                    <div>
                                        <label for="height-i2i" class="label-base">Alto Salida</label>
                                        <input type="number" id="height-i2i" step="64" value="1024" class="input-base">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="steps-i2i" class="label-base">Pasos</label>
                                        <input type="number" id="steps-i2i" value="20" class="input-base">
                                    </div>
                                    <div>
                                        <label for="cfg-i2i" class="label-base">CFG Scale</label>
                                        <input type="number" id="cfg-i2i" step="0.5" value="7.0" class="input-base">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="batch-count-i2i" class="label-base">Cant. Lotes</label>
                                        <input type="number" id="batch-count-i2i" value="1" class="input-base">
                                    </div>
                                    <div>
                                        <label for="seed-i2i" class="label-base">Semilla (Seed)</label>
                                        <div class="flex gap-2">
                                            <input type="number" id="seed-i2i" value="-1" class="input-base">
                                            <button id="random-seed-i2i" class="btn-ui flex-shrink-0" title="Semilla Aleatoria">
                                                <span class="material-icons-outlined">casino</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="face-restorer-i2i" class="label-base">Restaurar Caras</label>
                                    <select id="face-restorer-i2i" class="input-base"></select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ControlNet -->
                        <div class="content-card collapsible-card">
                            <details id="controlnet-details-i2i">
                                <summary>ControlNet</summary>
                                <div id="controlnet-options-i2i" class="space-y-4 pt-4">
                                    <label for="controlnet-image-upload-i2i" class="label-base">Imagen de ControlNet</label>
                                    <input type="file" id="controlnet-image-upload-i2i" accept="image/png, image/jpeg" class="block w-full text-sm text-gray-400 file:mr-4 file:px-4 file:py-2 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-600 file:text-gray-100 hover:file:bg-gray-500 cursor-pointer">
                                    <div class="image-preview-box">
                                        <img id="controlnet-image-preview-i2i" src="" alt="Vista previa ControlNet">
                                        <span id="controlnet-image-placeholder-i2i">Vista previa de ControlNet</span>
                                    </div>
                                    <div>
                                        <label for="controlnet-module-i2i" class="label-base">Pre-procesador</label>
                                        <select id="controlnet-module-i2i" class="input-base"></select>
                                    </div>
                                    <div>
                                        <label for="controlnet-model-i2i" class="label-base">Modelo</label>
                                        <select id="controlnet-model-i2i" class="input-base"></select>
                                    </div>
                                    <div>
                                        <label for="controlnet-weight-i2i" class="label-base">Peso (Weight)</label>
                                        <input type="number" id="controlnet-weight-i2i" step="0.1" value="1.0" class="input-base">
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>

                    <!-- ======================= -->
                    <!-- Panel Extras -->
                    <!-- ======================= -->
                    <div id="panel-extras" class="tab-panel">
                        <div class="content-card">
                            <h2 class="text-xl font-bold mb-4 text-white">Subir Imagen para Escalar</h2>
                            <div class="space-y-4">
                                <label for="image-upload-extras" class="label-base">Subir Imagen</label>
                                <input type="file" id="image-upload-extras" accept="image/png, image/jpeg" class="block w-full text-sm text-gray-400 file:mr-4 file:px-4 file:py-2 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-600 file:text-gray-100 hover:file:bg-gray-500 cursor-pointer">
                                <div class="image-preview-box">
                                    <img id="image-preview-extras" src="" alt="Vista previa" class="active">
                                    <span id="image-preview-placeholder-extras">Vista previa de la imagen</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="content-card">
                            <h2 class="text-xl font-bold mb-4 text-white">Parámetros de Escalado</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="extras-upscaler-1" class="label-base">Upscaler 1</label>
                                    <select id="extras-upscaler-1" class="input-base"></select>
                                </div>
                                <div>
                                    <label for="extras-upscaler-2" class="label-base">Upscaler 2 (Opcional)</label>
                                    <select id="extras-upscaler-2" class="input-base"></select>
                                </div>
                                <div>
                                    <label for="extras-upscaler-2-visibility" class="label-base">Visibilidad Upscaler 2</label>
                                    <input type="number" id="extras-upscaler-2-visibility" step="0.1" min="0" max="1" value="0.5" class="input-base">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="extras-resize-mode" class="label-base">Modo de Escalado</label>
                                        <select id="extras-resize-mode" class="input-base">
                                            <option value="0">Por Factor</option>
                                            <option value="1">A Resolución</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="extras-scale-factor" class="label-base">Factor de Escalado</label>
                                        <input type="number" id="extras-scale-factor" step="0.1" value="2.0" class="input-base">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="extras-width" class="label-base">Ancho (Modo 1)</label>
                                        <input type="number" id="extras-width" step="64" value="1024" class="input-base">
                                    </div>
                                    <div>
                                        <label for="extras-height" class="label-base">Alto (Modo 1)</label>
                                        <input type="number" id="extras-height" step="64" value="1024" class="input-base">
                                    </div>
                                </div>
                                <div>
                                    <label for="face-restorer-extras" class="label-base">Restaurar Caras</label>
                                    <select id="face-restorer-extras" class="input-base"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ======================= -->
                    <!-- Panel Tagger -->
                    <!-- ======================= -->
                    <div id="panel-tagger" class="tab-panel">
                        <div class="content-card">
                            <h2 class="text-xl font-bold mb-4 text-white">Generador de Tags (Tagger)</h2>
                            <p class="text-sm text-gray-400 mb-4">Sube una imagen para obtener tags recomendados (usa el modelo WD-Tagger).</p>
                            <gradio-app src="https://smilingwolf-wd-tagger.hf.space"></gradio-app>
                        </div>
                    </div>
                    
                    <!-- ======================= -->
                    <!-- Panel Config -->
                    <!-- ======================= -->
                    <div id="panel-config" class="tab-panel">
                        <div class="content-card">
                            <h2 class="text-xl font-bold mb-4 text-white">Sistema</h2>
                            <button id="get-memory-btn" class="btn-ui w-full gap-2 font-medium py-3">
                                <span class="material-icons-outlined">memory</span>
                                Consultar Memoria (VRAM/RAM)
                            </button>
                            <pre id="memory-display" class="text-xs text-gray-300 mt-4 p-4 bg-gray-900 rounded-lg" style="display: none;"></pre>
                        </div>
                        
                        <!-- (¡¡NUEVO!!) Tarjeta de Configuración de Previews -->
                        <div class="content-card">
                            <h2 class="text-xl font-bold mb-4 text-white">Configuración de Previews</h2>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <label for="live-previews-enable" class="label-base mb-0 text-white">Habilitar Previews en Vivo</label>
                                    <input type="checkbox" id="live-previews-enable" checked class="h-6 w-6 rounded-lg text-blue-500 bg-gray-700 border-gray-600 focus:ring-blue-600">
                                </div>
                                <div>
                                    <label for="show-progress-every-n-steps" class="label-base">Actualizar preview cada N pasos</label>
                                    <input type="number" id="show-progress-every-n-steps" value="5" class="input-base">
                                </div>
                                <div>
                                    <label for="show-progress-type" class="label-base">Tipo de Preview</label>
                                    <select id="show-progress-type" class="input-base">
                                        <option value="Approx NN">Approx NN (Rápido)</option>
                                        <option value="Approx cheap">Approx cheap (Más Rápido)</option>
                                        <option value="Full">Full (Lento, Preciso)</option>
                                    </select>
                                </div>
                                <button id="save-preview-config-btn" class="btn-ui btn-ui-primary w-full gap-2 font-medium py-3">
                                    <span class="material-icons-outlined">save</span>
                                    Guardar Config. de Preview
                                </button>
                            </div>
                        </div>
                        <!-- Fin de la nueva tarjeta -->
                        
                    </div>

                </div>

                <!-- COLUMNA 2: RESULTADO -->
                <!-- (NUEVO) ID añadido para el scroll -->
                <div id="results-card" class="h-fit sticky top-[70px]">
                    <div class="content-card">
                        <h2 class="text-xl font-bold mb-4 text-white">Resultado</h2>
                        
                        <!-- Mensaje de Estado -->
                        <div id="status-message" class="text-center text-gray-400 mb-4">Listo para generar.</div>

                        <!-- Barra de Progreso -->
                        <div id="progress-container" class="mb-4" style="display: none;">
                            <div class="w-full bg-[#2C2C2C] rounded-full h-2.5">
                                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                            <span id="progress-label" class="text-xs text-gray-400 mt-1 block"></span>
                        </div>

                        <!-- Botones de Interrumpir/Saltar -->
                        <div id="generation-controls" class="btn-group mb-4" style="display: none;">
                            <button id="interrupt-btn" class="btn-ui interrupt-btn flex-1">
                                <span class="material-icons-outlined">stop_circle</span>
                                Interrumpir
                            </button>
                            <button id="skip-btn" class="btn-ui flex-1">
                                <span class="material-icons-outlined">skip_next</span>
                                Saltar
                            </button>
                        </div>
                        
                        <!-- Área de Resultado (Mobile-friendly) -->
                        <div id="image-container" class="mt-4 bg-[#121212] rounded-lg border border-[#2c2c2c] flex items-center justify-center p-2 relative">
                            <img id="output-image" src="" alt="Imagen generada" class="max-w-full rounded-lg hidden shadow-md">
                            <div id="placeholder" class="text-gray-500">La imagen generada aparecerá aquí</div>
                        </div>
                        
                        <!-- Controles de Resultado -->
                        <div class="flex flex-col sm:flex-row gap-4 mt-4">
                            <button id="download-btn" class="flex-1 btn-ui font-medium py-3 gap-2" style="display: none;">
                                <span class="material-icons-outlined">download</span>
                                Descargar
                            </button>
                            <button id="copy-metadata-btn" class="flex-1 btn-ui font-medium py-3 gap-2" style="display: none; background-color: var(--accent-secondary); border-color: var(--accent-secondary);">
                                <span class="material-icons-outlined">receipt_long</span>
                                Copiar Metadatos
                            </button>
                        </div>

                        <!-- Metadatos -->
                        <div id="metadata-display" class="text-xs text-gray-300 hidden whitespace-pre-wrap bg-gray-900 p-4 rounded-lg mt-4"></div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- BOTÓN DE GENERAR FIJO (FAB) -->
        <div id="footer-fab-container">
            <button id="generate-btn-txt2img" class="generate-btn">
                <span class="material-icons-outlined">auto_fix_high</span>
                Generar
            </button>
            <button id="generate-btn-img2img" class="generate-btn" style="display: none;">
                <span class="material-icons-outlined">auto_fix_high</span>
                Generar
            </button>
            <button id="generate-btn-extras" class="generate-btn" style="display: none;">
                <span class="material-icons-outlined">auto_fix_high</span>
                Escalar
            </button>
        </div>
    </div>

    <!-- ======================= -->
    <!-- (NUEVO) VISOR DE IMAGEN MODAL -->
    <!-- ======================= -->
    <div id="image-viewer-modal">
        <button id="modal-close-btn" title="Cerrar">
            <span class="material-icons-outlined">close</span>
        </button>
        <img id="modal-image" src="" alt="Visor de imagen a pantalla completa">
    </div>


    <script>
        // --- (NUEVO) Generador de Prompts de ownerid.html ---
        const AUTO_PROMPT_GENERATOR = {
            tags: {
                obligatorioCompleto: " (man:4) (male focus), ((1boy)), solo, (full body:1.2), masterpiece, <lora:Penis Bulge Slider_alpha1.0_rank4_noxattn_last:2> <lora:lightingSlider:-2> <lora:DetailerILv2:4> <lora:add-detail-xl:4> masterpiece, best quality, ultra-detailed, 8k resolution, high dynamic range, absurdres, stunningly beautiful, intricate details, sharp focus, cinematic color grading, high-resolution texture",
                clothingOptions: {
                    nude: ["(big penis:1.2)", "(erect penis:1.2)", "(flaccid penis:1.2)", "(penis:1.1)", "testicles", "nude", "uncensored", "(male pubic hair:1.2)", "foreskin", "dripping", "animal penis", "precum", "dog penis", "extreme big penis", "(big penis:1.2)", "(erect penis:1.2)", "(flaccid penis:1.2)", "(penis:1.1)", "testicles", "nude", "uncensored", "(male pubic hair:1.2)", "foreskin", "dripping", "animal penis", "precum", "dog penis", "extreme big penis", "(huge penis:1.3)", "(veiny penis:1.2)", "(circumcised penis:1.1)", "(uncircumcised penis:1.1)", "scrotum", "cumshot", "ejaculating", "semen", "(thick penis:1.2)", "(long penis:1.2)", "horse penis", "knot penis", "sheath", "pubic hair", "sweaty penis", "(pulsing penis:1.2)", "(bulbous glans:1.1)", "urethra", "penis bulge", "(erection:1.2)", "soft penis", "hard penis", "penis veins", "testicle hair", "animal genitalia", "zoo penis", "furry penis", "(massive penis:1.3)", "(hyper penis:1.4)", "dripping precum", "sticky penis", "glistening penis", "(curved penis:1.1)", "(straight penis:1.1)", "(red penis:1.1)", "wolf penis", "cat penis", "dragon penis"],
                    underwear: ["(brief underwear:1.2)", "(thong:1.2)", "sexy bodysuit", "(jockstrap:1.2)", "(boxer briefs:1.2)", "harness", "chest harness", "socks", "white socks", "black male underwear", "white male underwear", "fundoshi", "(bulge:1.2)", "erection under clothes", "male swimwear", "see-through", "clothes pull", "pulled by self", "gloves", "fingerless gloves", "black gloves", "(athletic shorts:1.2)", "gym shorts", "running tights", "(compression shorts:1.2)", "(bike shorts:1.2)", "yoga pants", "leggings", "tights", "pantyhose", "stockings", "fishnet stockings", "garter belt", "suspenders", "corset", "bustier", "leather harness", "full body harness", "collar", "choker", "leash", "leather gloves", "latex gloves", "arm warmers", "leg warmers", "fingerless gloves", "red gloves", "white gloves", "knee socks", "thigh highs", "ankle socks", "crew socks", "no show socks", "striped socks", "argyle socks", "wool socks", "compression socks", "toe socks", "boots", "combat boots", "leather boots", "high heels", "platform shoes", "sneakers", "loafers", "sandals", "flip flops", "vest", "crop top", "tank top", "muscle shirt", "spandex bodysuit", "lycra suit", "wrestling singlet", "speedo", "trunks", "(boxers:1.2)", "loose boxers", "silk boxers", "cotton briefs", "low rise briefs", "high cut briefs", "lace underwear", "mesh underwear", "sheer underwear", "crotchless underwear", "see-through swimwear", "wet swimwear", "tight swimwear", "mankini", "posing pouch", "banana hammock", "c-string", "micro thong", "g-string", "satin thong", "leather thong", "wet clothes", "ripped clothes", "torn underwear", "shirt lift", "pants down", "undressing", "half dressed", "clothed male", "semi-nude", "transparent clothes", "clingy clothes", "form-fitting clothes", "bodycon outfit", "latex suit", "rubber harness", "chain harness", "metal collar", "spiked collar", "bow tie", "necktie", "cummerbund", "belt", "buckle"],
                    outfits: ["socks", "sexy", ""]
                },
                kinkAndToys: ["", "anal", "dildo", "sex toy", "anal object insertion", "object insertion", "rating_explicit, solo yaoi, white tank top, sweating, blushing, heavy breathing, open mouth, laying on wood floor, legs spread open, parting buttcheeks, bottomless, creampied anus, cum trail, after-sex, male pubic hair, flaccid penis, testicles, wet clothes, blurry indoors room, anus facing viewer, oversized cropped off legs", "shibari bound arms behind back, gag ball, gag mouth, shibari bound, pubic hair, penis, flaccid, drip cum, cowboy shot", "genitals, male, bodily fluids, foreskin, penis, shiny skin, anal fingering, disembodied hands, on front, completely nude, spread anus, on bed", "(laying on back, legs over head, piledrive), open mouth, eating own cum, bent over, anus, cum in mouth, (ejaculating on face), completely naked, penis, testicles, bedroom, (male masturbation, ) side view, undercut, athletic, chest hair, armpit hair, extremely hairy chest, thick chest hair, thick armpit hair, vibrator in anus", "pain, scared, crying, male milking machine, pumps, ball gag, lactation, bdsm, milking machine, bound, kneeling", "red sweater, aran sweater, shirt lift, nipples, leaning, embarrassed, moaning, testicles, (cum in ass, excessive cum), yaoi, anal, 2boys, open mouth, rough sex, penis, sex, trembling, motion lines, size difference, nude larger man. larger man fucking boy, hardcore, faceless larger male, deep in ass, heavily excessive flooding cum, indoors, (lactation), stomach bulge", "muscular body shape, blushing smirk, open clothes, sweat soaking clothes, office suit, tie, white shirt, trousers, heavy sweating, (steaming: 1.3), visible_breath, visible cock, public_hair, crotch bulge, solo, BREAK, sitting, leg up, leg_crossed, feet closeup, man spreading, leaning on chair, BREAK, white socks, perfect feet, steamy_feet, sweaty_feet, BREAK, looking-at-viewer, looking at camera, long shot, side_view, BREAK, office background, office room", "1boy, male focus, soap on body, press the ass against the glass, press the balls against the glass, anus open, huge penis, large testicles, looking at viewer, indoors, shower, sho werroom, bathroom, muscular, cum shot, hairy anus, ass hair", "solo, (fully unzipped:1.4), (nipples:1.3), navel, (wolf onesie:1.4), (fluffy:1.2), (hood with ears:1.3), (tail:1.2), (paws:1.0), cozy, playful, luxury apartment, bedroom, white silk sheets, cosy, inviting, (looking at viewer:1.4), leaning back, reclined, male pubic hair, penis, erection, lying down on back, face up, supline, arms up, arm pits, hands behind head, flirty, smirk, tease, playful expression, smiling, laughing", "halo, multiple boys, angel, male focus, testicles, anus, horns, penis, wings, red eyes, green eyes, yaoi, 2boys, angel wings, cum, uncensored, open mouth, dark skin, feathered wings, ass, demon boy, looking back, dark-skinned male, blush, after sex, chain, gaping, pointy ears, brown hair, after anal, sweat, demon horns, cum in ass, sex, angel and devil, large penis, bare shoulders, veins, multiple penises, foreskin, smile, veiny penis, cumdrip, teeth, interracial", "naked chocolate, chocolate on penis, chocolate on body, chocolate on breasts, food on body, chocolate, nude, nipples, bed, on bed, on back, cowboy shot, dutch angle, ashamed, seductive pose, blush, smirk, cowboy shot", "male focus, blush, moaning, (hands bound), nude, nipples, tiny penis, anus, cumdrip, indoors, bed, top- down_bottom-up, bed room, on bed, kneeling, dutch angle, BREAK, (disembodied hands, male masturbation, dildo masturbation, grabbing dildo, anal masturbation, ) motion blur, motion lines, cumming, cum shot, (from below, ) from behind", "bed, naked, condom_on_penis, wearing_condom, solo, manly, low-angle, dutch_angle, dim light, condom_filling, close-up, lying_on_back, cum_in_condom, filled condom on penis, green condom, exhausted, panting, out of breath, gasping for air, satisfied", "open mouth, tongue, penis over eyes, penis on face, penis in front of eyes, upper body, close up, hand on anothers head, BREAK dark- skinned male, huge size difference, very dark skin, interracial, huge penis, extremely detailed penis, veiny penis, huge testicles","nude, low angle, dark, nighttime, dark room, BREAK 2boys, solo focus, adult, smug, naked, shiny skin, blushing, pov buttjob, ass, cumming, ass grab, long penis", "a topless young guy swimming in an inflatable toy by palm tree, male focus, shota, 1boy, penis, goggles, testicles, solo, goggles on head, innertube, on back, feet, looking at viewer, erection, from below, anus, penis focus", "male focus, solo, penis, balls, cock ring, flaccid, anus, ass, back, low angle, sweat, foreskin, ripped boxers, squatting, socks", "solo, t-shirt, (sleepy), standing, open mouth, no pants, (toothbrush, ) brushing teeth, holding toothbrush, bathroom, penis, foreskin, erection, precum, supported with one hand, bottomless", "rough sex, torso grab, yaoi, gay, (full nelson, anus penetrated, penis in anus, anal penetrated), male focus, naked, (man penetrated by gigantic (orc)), stomach bulge, (penis, erected, precum dripping), BREAK nude, drooling, saliva, saliva trail, bashful, blush lines, intense blushing, aroused face, angry, mad, nervous, heavy breathing, steamy, wet, excessive sweaty, motion lines, motion blur, speed lines", "solo, invert triangle body shape, penis tuck, excessive precum, pubic hair, (precum:1.2), dropping precum, testicles, masturbate, open mouth, (heavy breathing:1.1), blushing, angry, indoor, bedroom, from back, looking at viewer, back on bed, close- up, up close, sitting on floor carpet, (naked), clothes are on the floor, on front, anus, muscular back, male focus, indoors, motion lines, motion blur, speed lines", "in a trap, chained, chain on neck, BREAK, sex machine, fuck machine, anal penetration, sticking out tongue, floating hearts, mind control, pleasure, legs raised, focus on feet, soles", "nude, penis, veiny dick, testicles, pleasure expression, eyes looking up, BREAK pink thick tentacles, tentacles wraps around his asscheeks, tentacles spreading his legs, trapped, tight, BREAK dynamic angle, showing anus, (tentacle in anus, tentacle insertion, tentacles in anus, anal penetrated:1.4), ejaculating while penetrated, motion blur, motion lines, BREAK cumming, excessive cum, cum drip, overflow, excessive sweaty, wet, bashful, blush lines, intense blushing, aroused face, heavy breathing, steamy, angry, mad, ahegao, orgsam, climax, (double penetration, )", "solo, yaoi, pubic hair, armpit hair, blush, nude, navel, looking behind, from below, bondage, (spanking ass, body invasion:1.4), cum dripping, veiny penis, testicles, (very long scrotum skin:1.4), home, lying on sofa, back", "white shirt, short sleeves, collared shirt, pants, undressing. pubes. penis. uncut penis. foreskin. (supporting both hands). BREAK. ass, masturbating, (finger in anus, (anal fingering)). looking back. looking at viewer, saliva, penis, precum, testicles, dynamic pose, hand with 5 fingers, night. night time. indoors. classroom, \(place\). sweatdrop, smug.", "shirtless, swim trunks, beach, armpit hair, bent, open pants, flaccid, precum, from below, solo, all fours, :p, tongue out, open mouth, grin, from behind, upside down, penis, penis focus, pants down, anus, very hairy ass", "submissive, nude, (orgasm), penis, testicles, (handjob, disembodied hands), close-up, hands behind head, spread legs, (cum), ejaculation, screaming, looking away, (sound effects:1), moaning, tank top, (anal beads)", "baseball uniform, socks, Changing Room, Lockers, On Floor, Backs to Viewer, Hips Raised, Completely Naked, Sweaty, Object Insertion, Anal Insertion, Baseball ball, Shaking, penis, flaccid, Motion Lines, from behind, from below, close up, squatting", "uncensored, outdoors, night, against wall, graffiti, from below, 1boy, solo, toned, looking down at viewer, mouth mask, black hoodie, standing, pants pull, penis, erection, foreskin", "2boys, yaoi, furry, submissive man, in forest, sex from behind, deep penetration, sex with pain, pain sex tears, scared, recisiting sex, erect penis, testicles, overflowing semen, sex slave, slave collar, scars, BREAK, (1werewolf, black fur, black hair, ) grabbing pectorals, licking the cheek, hard fuking man", "gay, solo penis, flaccid, male, detailed background, crouched, squatting, arched_back, muscular male, masculine, anal_insertion, dildo_insertion, red dildo, riding dildo, back to viewer, lowered view, blushing, expressive face, cum, cumming, cum explosion, medieval background, dark room, warehouse", "man sitting naked on gaming chair, (fake livestream screenshot, livestream, livestream chat interface), penis, ballsack, spreading legs, anus, (holding nintendo switch), gaping anus, creampie, ejaculating, cumdrip, hairy anus, (excessive cum on body, excessive cum on face), blush, smile, shaking, yaoi, looking at viewer", "uncensored, totally naked, male focus, solo, penis, uncut, flaccid penis, nude, toned_male, pubic hair, white skin, tachi-e, standing, facing_viewer, full body, transparent_background, sprite sheet, multiple_views, front view, back view, persistent character, sprite sheet", "day, natural lighting, sweating, sweatdrop, male-anus focus, on all fours, looking back, moaning, presenting, heavy breathing, blushing, open mouth, closed eyes, completely nude, male pubic hair, flaccid veiny penis, testicles, brown anus, wet anus, hairy anus, leaking anal fluids, excessive anal fluids, legs apart, thick thighs, manly, solo, 1boy, simple plain red background, from below, dutch angle, (anal beads)", "solo, nsfw, yaoi, male focus, solo, light skin, santa hat, smirk, house, winter sky, christmas, giant gift box, relaxing, naked, body wrapped in ribbons, red ribbons, melted chocolate on body, holding hot cocoa, lying on sofa, night sky, penis, dripping_precum, cowboy shot", "solo, precum, sit on floor, feet focus, nipples, nude, sweating, ((lower view)), ((from below)), penis, shy, nipples, showing feet, feets, soles, feet focus, dirty socks, baseball cap, dirty body, gym room", "yellow duck onesie, open onese, bare chest, bedroom, Dark room, Cocky, Eyebags, sitting on bed, close up, erection under clothes", "solo, undershirt, long_sleeve_undershirt, (boxers down to knee, ) blush, lying on side, baseball field, best angle, feet, (anal fingering, penis, erection, pre-cum, ) motion blur, motion lines, fast speed lines, ass, saliva, open legs, spread legs, tree shadow, black-red baseball uniform, baseball black-red socks, baseball cap, no pants", "night, dark, naked, abs, torso, male nipples, navel, hands with five fingers, smal penis, tiny penis, testicles, erection, precum, pubic hair, hand behind head, standing, looking at viewer, annoyed, bored, bear hood, hood up, bear hoodie, after waking up, bad mood, holding water bottle", "//Base Prompt//, (pov, smartphone, smartphone border, recording, viewfinder, cellphone photo, phone interface, )", "sweating, blush, pectroals, nipples, public, completely naked, sweat drop, (fishnet thong), see-through fishnet thong, pubic peek, beach, smug, shiny skin, pubic hair, coconut tress, ocean, surfboard, toned_male, lewd, seductive_pose, cowboy shot", "closeup, front view, cowboy shot, low angle, from below, clutter, glossy skin, white shirt, blue tie, bottomless, excessive pubic hair, hairy legs, legs spread, flaccid penis, foreskin, teasing, looking at viewer, cocky grin, blush, black socks, sitting in office chair, visible anus, corporate office, precum string", "2boys, solo focus, aroused, blush, a face flushed with desire, humid, fog, half closed eyes, nude, face focus, close- up, penis, precum, sagging testicles, erection, penis on head, looking at another, drooling, in back alley, dark, night, testicle sucking, tongue out, portrait, motion line, grab head, side view", "solo, male_focus, nude, penis, testicles, hand on another's chin, looking at viewer, eye contact, angry, anger_vein, open mouth, cum in mouth, tongue out, from above, after oral sex, cum on face", "nude, topless, nsfw, large pecs, [spiral eyes], open mouth, head tilt, spoken questionmark, expressionless, mind control, hypnosis, (mind control app, hypnosis app, spiral, phone, ) indoors, modern, faceless man, BREAK, looking up, looking at viewer, (black dog ears, animal collar, choker, black dog tail, ) sitting, indoors, male pubic hair, penis, flaccid, precum, blush, 2 boys, yaoi, squatting cowgirl position, cowgirl position, white man fuck man, anal sex, boy on top, BREAK, pow pose, blush, happy face, heart bubble, heart pupil, spoken heart, ), background is (bedroom, on bed, ), motion blur, motion lines, fast speed lines, thrusting", "nude, topless, nsfw, large pecs, [spiral eyes], open mouth, head tilt, spoken questionmark, expressionless, mind control, hypnosis, (mind control app, hypnosis app, spiral, phone, ) indoors, modern, faceless man, BREAK, looking up, looking at viewer, dog ears, animal collar, choker, dog tail, indoors, male pubic hair, penis, flaccid, precum, blush, cumming, moaning, top-down_bottom-up, anal sex, fluids, yaoi, (faceless man, dark-skinned man, dark-skinned man off screen), huge cock, male pubic hair, hairy legs, fast speed lines, motion blur, side view", "solo, nude, restrained by a metal sex machine, man on top of a huge wooden stick with a base and a metal sex machine connected to a huge wooden stick, arms up, bound wrists, bound ankles, bound stomach, bound thighs, bound legs, stationary restraints, anal object insertion and standing, (sex machine, ) small penis, testicles, viewfinder, ejaculation, precum drip, lots of cum, hairy legs, cum on legs, from below, (fast speed lines, motion blur, motion lines, ) cowboy shot", "solo, sweat, lying on stomach, on sand, testicles, feet, ass, soles, nude, smile, anus, looking back, lying, foot focus, long penis, precum, barefoot, looking at viewer, beach, sand, sea shells, sand on body, seafoam, foreshortening", "pov, pleasure face, blush, nude, male pubic hair, dark penis, (foreskin:1.2), veiny penis, licking penis, twitching penis, precum, testicles, saliva on penis, wet penis, handjob, fast speed lines, motion blur, leg hair, grab head", "farm barn, blush, sweat, eyes half closed, milkup, kneeling, male pubic hair, penis, cum on one hand, cupping hand, cum on hair, cum on chest, ejaculation, cum in bucket, milk pails in background, handjob, motion lines on hand, cum in mouth, nude, cowboy shot, BREAK, animal, 1horse, horse penis, testicles), licking penis", "solo, looking back, spoken questionmark, medium bulge, (penis bulge), camo tank top, camo jockstrap, perineum, sweaty, feet, stinky, musk, ass, anus, on stomach, on bed, one leg bent, feets, closed mouth, dot mouth, holding cellphone", "solo, collared white shirt, open shirt, black pants, (torn shirt, torn pants, torn clothes), sweat, shiny skin, bruise, injury, cuts, angry, pubic hair, penis peek, blood, looking at viewer, musk, convenient censoring, bound, tape bondage, body wrapped in caution tape, arms behind head, pecs, tape gag, BREAK simple white background, caution tape, shade, shadow, (surrounded by multiple caution tape:1.2), BREAK dynamic pose, dramatic lighting, depth of field, blurry foreground, bloom, chiaroscuro, upper body", "blush, moaning, anus, 2boys, yaoi, bestiality, brown fur, brown hair, minotaur, nude, ass, (horse penis, erection, dripping precum), testicles, imminent_anal, looking at viewer, hug, posing, motion lines, barn, upright straddle, upright cowgirl position, excited, ^^^, looking at viewer, shocked expression, awkward face", "solo focus, blush, oversized hoodie, dark-gray hoodie, hood up, long sleeves, small penis, erection, foreskin, sagging testicles, cock ring, seductive smile, parted lips, teeth, (lift own clothes, pecs, nipples, ) looking at viewer, blushing, from below, sit on couch, tiles, dripping precum, nipple rings, nipple chain, (disembodied hand, (caressing_testicles))", "solo, abs, blush, dark skin, topless, tribal necklace, scratching head, small penis, dog penis:1.3, cock ring, (knotted penis), pubic hair, navel hair, chest hair, legs hair, sagging testicles, precum, armpit, perspective, wink, grin, sweat, erect nipples, wristband, tribal clothing, fur gauntlets, rope belt, armband, thigh strap, fingerless gloves, choker, shirtless, tribal tattoo, scar, wolf ears, wolf tail, outdoors, hand on hips", "nude, partially submerged, pubic hair, penis, flaccid, lying, testicles, armpit hair peek, wet skin, shiny skin, contemplating, looking away, parted lips, BREAK lake, sacred, mysterious, dreamlike, fantastic, moonlight, water, blue flowers, vibrant flowers, glowing butterflies, flower effects, water reflections, refraction, too many butterflies, too many flowers, moonlight, starry sky, bioluminescence, BREAK cinematic, dynamic pose, dynamic angle, natural lighting, smooth shading, glossy surfaces, subtle, high contrast, dark depth, real background, colorful depth, colorful lighting, dutch angle, beautiful atmosphere, muted colors, cinematic composition, heavily textured impasto oil painting, dark, violet theme, erotic, sexy pose", "closed eyes, saliva, blush, moaning, bondage, restrained, (hands bound), nude, nipples, penis, anus, ejaculation, projectile cum, feets, soles, legs bound, indoors, bed, top- down_bottom-up, bedroom, on bed, open legs, (on one knee), dutch angle, BREAK, disembodied hands, anal object insertion, grabbing dildo, anal masturbation, motion blur, motion lines, dripping cum from ass, cum on testicles, (from below, ) from behind", "sharp teeth, smile, happy, solo, at the crossroads, BREAK, mummy halloween costume, bandaged body, bandages on torso, bandages on arms, bandages on legs, penis, partially bandaged penis, jack-o- lanterns by feet, naked bandage, zombie, colored skin, stitches, grey skin, stitched face, zombie pose, halloween, halloween costume, night, moon, graveyard, tombstone, grave, open mouth, looking at viewer. sit on tombstone, precum drip"],
                characterTypes: ["", "demon", "angel", "gnome", "monster", "elf", "orc", "vampire", "werewolf", "cyborg", "android", "alien", "fairy", "goblin", "dwarf", "centaur", "minotaur", "ghost", "zombie", "elemental", "satyr", "robot", "harpy", "nephilim", "construct", "demon boy", "mature male", "dark-skinned male", "wolf boy", "furry", "furry male", "androide man"],
                bodyAndPose: ["", "(muscular:1.2)", "(bara:1.1)", "toned", "large pectorals", "abs", "(thighs:1.1)", "thick thighs", "ass", "back", "chest hair", "facial hair", "beard", "hairy", "veins", "scar", "shiny skin", "wet", "armpits", "collarbone", "navel", "standing", "sitting", "lying", "on stomach", "on back", "spread legs", "looking at viewer", "looking back", "from behind", "cowboy shot", "arm up", "arms up", "undressing", "ass focus", "feet", "toes", "barefoot", "smile", "blue eyes", "red eyes", "white hair", "thick eyebrows", "hands on own hips", "from below", "one eye covered", "solo, mojang"],            
                sceneAndDetails: ["", "indoors", "outdoors", "poolside", "water", "simple background", "white background", "red background", "yellow background", "chair", "bed", "on bed", "pillow", "day", "shadow", "tentacles", "horns", "wings", "tail", "wolf ears", "animal ears", "wolf tail", "tattoo", "arm tattoo", "jewelry", "earrings", "restrained", "bound", "short hair", "long hair", "medium hair", "undercut", "ponytail", "black hair", "brown hair", "blush", "artist name", "signature", "bandages", "mask", "eyepatch"],
                eras: ["", "1400s", "1500s", "1700s", "90s", "archaic", "chenla", "fantastic realism", "joseon dynasty", "yoruba", "renaissance", "baroque", "victorian era", "edwardian era", "art nouveau", "art deco", "cyberpunk era", "stone age", "bronze age", "roman empire"],
                textures: ["", "3d fractals", "animal prints", "blistered", "blotchy", "brittle", "brushed", "bumpy", "chalky", "chipped", "chiseled", "coarse", "corded", "corky", "corroded", "cracked", "creased", "crinkled", "crumbly", "crusty", "elastic", "embossed", "embroidered", "feathery", "fibrous", "flaky", "fluffy", "frosted", "furrowed", "fuzzy", "glistening", "glittering", "glossy", "glowing", "granular", "gritty", "honeycombed", "iridescent", "jagged", "knitted", "leathery", "lustrous", "marbled", "matte", "metallic", "gelatinous", "powdery", "woven", "mossy", "pitted", "plush", "polished", "porous", "prickly", "ribbed", "rough", "rusted", "sandy", "scaly", "shining", "shiny", "silky", "slick", "slimy", "smooth", "sparkling", "spongy", "stained", "suede-like", "veined", "velvety", "viscous", "wavy", "weathered", "(gloss skin:2.5), (skin texture:1.4), (husband:1.1), (dynamic pose:2), high angle, real color tones, natural beauty, real life, photo, normal photo, camera, shadow, (pronounced bukeh effect:2), real, in love, detailed skin, ultra high quality hair, ultra detailed hair, ultra high quality nails,, (Street Art:1), graffiti tags, urban wall, spray texture, (Banksy aesthetic:1), (Vaporwave Aesthetic AI:2.5), (pastel gradients), (neon outlines:1.2), classical marble statues, (retro 80s arcade feel:2), tropical plants, hazy lighting, nostalgic digital art, (VHS filter), (geometric forms:1), SmoothNoob_Quality", "photorealistic, cinematic lighting, atmospheric, highly detailed, masterpiece,<LoRA:Cute_Emerald-V3:1.3>,<LoRA:MJ52:0.8>, (gloss skin:2.5), (skin texture:1.4), (husband:1.1),(character sketch:2.5), (multiple poses:4), (white background:2), (concept art:1.8), (dynamic poses:1.7), (line art:1.8), (character design:2), (full body views:1.5), (front side back:1.7), (clean lines:1.8), (minimalist:1.5), (highly detailed:2), (8k resolution:1.8), (same character:5)", "(cubist painting:2.5), (geometric shapes:2), (abstract forms:1.8), (Picasso style:2), (surrealist:2), (dream-like elements:1.7), (strange juxtapositions:1.5), (impressionist painting:2), (soft brush strokes:1.8), (vibrant colors:2), (glowing tones:1.5), (pop art:2.5), (bold colors:2), (iconic imagery:1.8), (geometric forms:1.7), (art nouveau:2), (flowing lines:1.8), (floral motifs:2), (elegant curves:1.5), (organic lines:1.7)", "(skin texture:1.4), (husband:3.6), (dynamic pose:2),(Enhanced stunning erotic beauty:3), (digitally enhanced:3), digital makeup, (beauty filters:4), Photoshop, masterpiece, best quality, ultra-detailed, 8k, cinematic, (hyperrealistic ethereal porcelain:2), (subsurface scattering:1), (ambient occlusion:3.1), (global illumination:3.1), (volumetric lighting:3.1), dynamic lighting, realistic materials, photorealism, soft (cinematic glow:2), (ultra detail glossy:2), enhance texture, (post-reallife realism:2.3), (perfect artificial creation:2.1), (virtualization reality:2), (motion graphics:1.1), Art Deco, geometric elegance, gold chrome, (1920s luxury style:3), (Drip Painting:1.1), paint splatter, (Jackson Pollock inspired chaos:4), (energetic brushwork:3.5), expressive texture, (Unreal Engine Render:1.3), (hyper-realistic 3D:3.4), (cinematic lighting:3.4), (game engine aesthetic:2), detailed textures, (physically based rendering (PBR):1), (atmospheric effects:3.3), (high polygon count:2), realistic subsurface scattering, (polished render:2.5), (dramatic shadows:3)", "(anime style render:2.4), Street Art, graffiti tags, urban wall, spray texture, (Banksy aesthetic:3), (Hyperrealistic Surrealism:4.1), impossibly sharp focus, dreamlike elements, distorted reality, uncanny valley, detailed textures, (bizarre juxtapositions:2.5), vibrant yet unsettling colors, (psychologically charged scene:3), (fine art realism with a twist:5), (steampunk:3.3)", "Photorealism, hyper-detailed painting, lifelike shadows, crisp realism, studio lighting, (Digital Impressionism:2), painterly brushstrokes, vibrant color fields, soft edges, ethereal light, digital paint texture, modern interpretation of light and atmosphere, atmospheric perspective, expressive brushwork, blurred forms", "moody atmosphere:1.4, standing in a rain-soaked alley with wet cobblestones, leaning against a brick wall, cigarette in hand, (genitalia bulge:1.5), (prominent genitalia bulge:1.4), ( etailed male crotch:1.3), low angle shot, dynamic composition, volumetric fog, <lora:lightingSlider:-1.4>, score_9, score_8_up, score_7_up"],
                colors: ["ablaze colors", "apricot color", "aqua colors", "ash gray", "auburn color", "baby blue", "baby pink", "beaming colors", "beige colors", "black and white", "bleached colors", "blood red", "blue violet", "bold colors", "bright colors", "bronze colors", "brown", "burgundy colors", "burnt sienna", "canary yellow", "candy colors", "cerulean blue", "chartreuse color", "chestnut color", "cobalt blue", "cold colors", "colorful", "colorless", "cool colors", "coral color", "crimson red", "cyan", "danish pastel colors", "dark colors", "deep colors", "desaturated", "dim colors", "earth tones", "electric blue", "electric colors", "fiery colors", "fluorescent colors", "forest green", "golden yellow", "gradient colors", "hot pink", "hunter green", "indigo", "ivory", "monochromatic", "triadic colors", "analogous colors", "complementary colors", "viridian", "celadon", "vermilion", "lavender blush", "light colors", "lime colors", "magenta color", "mahogany", "maroon", "mauve", "midnight blue", "mint color", "mocha", "muted colors", "navy blue", "neon colors", "neutral colors", "olive color", "orange red", "pale colors", "pastel colors", "peach color", "pink color", "platinum color", "prismatic colors", "prussian blue", "radiant colors", "red", "retro colors", "rich colors", "rose color", "royal blue", "sepia colors", "silver colors", "sky blue", "slate gray", "smoky black", "spectrum colors", "spring green", "tan color", "taupe", "teal", "technicolor", "tropical colors", "turquoise color", "vantablack", "vibrant colors", "vintage colors", "violet", "vivid colors", "warm colors", "washed out colors"],
                themes: ["", "academicism", "acid pixie", "acidwave", "adventurecore", "afrofuturism", "agropunk", "anachronism", "astropunk", "atompunk", "autumn", "biopunk", "bloomcore", "bohemian", "bronzepunk", "byzantine", "chaotic", "contemporary realism", "cosmic horror", "crusaderpunk", "crustpunk", "cybergoth", "dark fantasy", "dark nautical", "decopunk", "dieselpunk", "dreamy", "emo", "ethereal", "evil-theme", "extraterrestrial", "fairytale", "fantasy", "farmcore", "flowercore", "futuristic", "goblincore", "gothic", "hallyu", "happycore", "haunting", "hikecore", "lo-fi", "magic-realism", "mannerism", "mythology", "orientalism", "prehistoricore", "rainbowcore", "retro", "retrofuturism", "robotic", "romanticism", "solarpunk", "minimalism", "maximalism", "bioluminescent", "slimepunk", "socialist realism", "space opera", "sparklecore", "spring", "steampunk", "summer", "synthwave", "tiki", "tribal art", "tropical", "urbancore", "vaporwave", "winter", "witchcore", "wonderland"],
                compositions: ["", "full body character design", "wide shot", "game assets", "album cover", "book cover", "brand identity", "character sheet", "coloring book page", "comic strip", "commercial ad", "diagram", "enamel pin", "fashion mockup", "flowchart", "game UI", "house plan", "icon set", "infographic", "interior design", "jewelry design", "knolling", "logo design", "magazine cover", "menu design", "mood board", "poster", "propaganda poster", "seamless pattern", "golden ratio", "rule of thirds", "isometric view", "blueprint schematic", "architectural drawing", "technical illustration", "concept art", "storyboard"],
                extra: ["ultra detail", "ultra realism", "cinematic", "photorealistic", "no reflection", "perfect details", "volumetric lighting", "depth of field", "caustics", "god rays", "soft lighting", "hard lighting", "dramatic lighting", "subsurface scattering", "realistic"],
            },
            getRandomElement: function(arr) {
                return arr[Math.floor(Math.random() * arr.length)];
            },
            generatePrompt: function() {
                const promptParts = [];
                promptParts.push(this.tags.obligatorioCompleto);
                const clothingChoice = Math.random();
                if (clothingChoice < 0.4) {
                    const primaryNudeTag = this.getRandomElement(this.tags.clothingOptions.nude);
                    promptParts.push(primaryNudeTag);
                    if (Math.random() < 0.5) {
                        let secondaryNudeTag;
                        do {
                            secondaryNudeTag = this.getRandomElement(this.tags.clothingOptions.nude);
                        } while (secondaryNudeTag === primaryNudeTag);
                        promptParts.push(secondaryNudeTag);
                    }
                } else if (clothingChoice < 0.8) {
                    promptParts.push(this.getRandomElement(this.tags.clothingOptions.underwear));
                } else {
                    promptParts.push(this.getRandomElement(this.tags.clothingOptions.outfits));
                }
                const selectedCharacterType = this.getRandomElement(this.tags.characterTypes); 
                const selectedKinkAndToys = this.getRandomElement(this.tags.kinkAndToys);
                const selectedBodyAndPose = this.getRandomElement(this.tags.bodyAndPose);
                const selectedSceneAndDetails = this.getRandomElement(this.tags.sceneAndDetails);
                const selectedTexture = this.getRandomElement(this.tags.textures);
                const selectedColor = this.getRandomElement(this.tags.colors);
                const selectedTheme = this.getRandomElement(this.tags.themes);
                const selectedComposition = this.getRandomElement(this.tags.compositions);
                const selectedExtra = this.getRandomElement(this.tags.extra);
                const selectedEra = this.getRandomElement(this.tags.eras);
                if (selectedCharacterType) promptParts.push(selectedCharacterType);
                if (selectedKinkAndToys && Math.random() < 0.25) {
                    promptParts.push(selectedKinkAndToys);
                }
                if (selectedBodyAndPose) promptParts.push(selectedBodyAndPose);
                if (selectedSceneAndDetails) promptParts.push(selectedSceneAndDetails);
                if (selectedTexture) promptParts.push(`${selectedTexture} texture`);
                if (selectedColor) promptParts.push(`${selectedColor} palette`);
                if (selectedTheme) promptParts.push(`${selectedTheme} ambient`);
                if (selectedComposition) promptParts.push(`${selectedComposition} style`);
                if (selectedExtra) promptParts.push(selectedExtra);
                if (selectedEra) promptParts.push(selectedEra);
                return promptParts.join(', ');
            }
        };

        // --- Estado Global ---
        const G_STATE = {
            gradioUrl: '',
            samplers: [], models: [], vaes: [], schedulers: [], loras: [], upscalers: [],
            styles: [], faceRestorers: [], 
            controlNetModels: [], controlNetModules: [], 
            progressInterval: null,
            isGenerating: false,
            uploadedImageBase64: { 
                i2i: null,
                extras: null,
                controlNetT2I: null,
                controlNetI2I: null
            },
            tagSearchTimeout: null,
            lastMetadata: '',
            currentConfig: {} 
        };

        // --- Elementos de la UI ---
        const splashScreen = document.getElementById('splash-screen');
        const appContainer = document.getElementById('app-container');
        const connectBtn = document.getElementById('connect-btn');
        const urlInput = document.getElementById('gradio-url');
        const initialStatusMessage = document.getElementById('initial-status-message');
        const statusMessage = document.getElementById('status-message');
        const outputImage = document.getElementById('output-image');
        const placeholder = document.getElementById('placeholder');
        const downloadBtn = document.getElementById('download-btn');
        const copyMetadataBtn = document.getElementById('copy-metadata-btn');
        const metadataDisplay = document.getElementById('metadata-display');
        const refreshResourcesBtn = document.getElementById('refresh-resources-btn');
        
        // --- Progreso ---
        const progressContainer = document.getElementById('progress-container');
        const generationControls = document.getElementById('generation-controls');
        const interruptBtn = document.getElementById('interrupt-btn');
        const skipBtn = document.getElementById('skip-btn');
        
        // --- Botones de Generar (FAB) ---
        const generateTxt2ImgBtn = document.getElementById('generate-btn-txt2img');
        const generateImg2ImgBtn = document.getElementById('generate-btn-img2img');
        const generateExtrasBtn = document.getElementById('generate-btn-extras');
        const allGenerateBtns = [generateTxt2ImgBtn, generateImg2ImgBtn, generateExtrasBtn];

        // --- Prompts y Tags ---
        const promptT2I = document.getElementById('prompt-t2i');
        const promptI2I = document.getElementById('prompt-i2i');
        
        // --- (NUEVO) Visor Modal ---
        const modal = document.getElementById('image-viewer-modal');
        const modalImage = document.getElementById('modal-image');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- (NUEVO) Selectores (Dropdowns) ---
        const E_SELECTORS_NODES = {
            model: [document.getElementById('model-t2i'), document.getElementById('model-i2i')],
            vae: [document.getElementById('vae-t2i'), document.getElementById('vae-i2i')],
            sampler: [document.getElementById('sampler-t2i'), document.getElementById('sampler-i2i')],
            scheduler: [document.getElementById('scheduler-t2i'), document.getElementById('scheduler-i2i')],
            lora: [document.getElementById('lora-t2i'), document.getElementById('lora-i2i')],
            styles: [document.getElementById('styles-t2i'), document.getElementById('styles-i2i')],
            faceRestorer: [document.getElementById('face-restorer-t2i'), document.getElementById('face-restorer-i2i'), document.getElementById('face-restorer-extras')],
            hrUpscaler: [document.getElementById('hr-upscaler-t2i')],
            extrasUpscaler1: [document.getElementById('extras-upscaler-1')],
            extrasUpscaler2: [document.getElementById('extras-upscaler-2')],
            controlNetModel: [document.getElementById('controlnet-model-t2i'), document.getElementById('controlnet-model-i2i')],
            controlNetModule: [document.getElementById('controlnet-module-t2i'), document.getElementById('controlnet-module-i2i')],
        };
        
        // --- Helpers de UI ---
        function showInitialStatus(message, isError = false) {
            initialStatusMessage.textContent = message;
            initialStatusMessage.className = isError ? 'text-center text-red-400 mt-4 text-sm' : 'text-center text-gray-500 mt-4 text-sm';
        }

        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'text-center text-red-400 mb-4' : 'text-center text-gray-400 mb-4';
        }

        function showLoading(button) {
            button.disabled = true;
            button.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Cargando...
            `;
        }

        function hideLoading(button, originalText) {
            button.disabled = false;
            button.innerHTML = originalText;
        }

        function setGenerateButtons(disabled) {
            allGenerateBtns.forEach(btn => btn.disabled = disabled);
        }
        
        function showGenerationProgress(button) {
            G_STATE.isGenerating = true;
            setGenerateButtons(true);
            generationControls.style.display = 'flex';
            
            button.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Generando...
            `;
        }

        function hideGenerationProgress(button, originalText) {
            G_STATE.isGenerating = false;
            setGenerateButtons(false);
            generationControls.style.display = 'none';
            button.innerHTML = `
                <span class="material-icons-outlined">auto_fix_high</span>
                ${originalText}
            `;
        }
        
        function toggleAppVisibility(show) {
            splashScreen.style.display = show ? 'none' : 'flex';
            appContainer.style.display = show ? 'block' : 'none';
        }

        // --- Helper de API ---
        async function apiGet(endpoint, params = {}) {
            try {
                const url = new URL(endpoint, G_STATE.gradioUrl);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error al cargar ${endpoint}: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (G_STATE.gradioUrl) {
                    showStatus(`Error de red: ${error.message}`, true);
                }
                throw error;
            }
        }
        
        async function apiPost(endpoint, body) {
            try {
                const url = new URL(endpoint, G_STATE.gradioUrl).href;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error del servidor: ${response.status} ${errorText}`);
                }
                return await response.json();
            } catch (error) {
                showStatus(`Error de red: ${error.message}`, true);
                throw error;
            }
        }
        
        // --- Lógica de Carga de Recursos (¡¡AMPLIADA!!) ---
        async function loadAndPopulateResources(isRefresh = false) {
            showStatus('Cargando recursos (modelos, loras...)...', false);
            try {
                G_STATE.currentConfig = await apiGet('/sdapi/v1/options');

                const [models, samplers, schedulers, vaes, loras, upscalers, styles, faceRestorers, cnModels, cnModules] = await Promise.all([
                    apiGet('/sdapi/v1/sd-models'),
                    apiGet('/sdapi/v1/samplers'),
                    apiGet('/sdapi/v1/schedulers'),
                    apiGet('/sdapi/v1/sd-vae'),
                    apiGet('/sdapi/v1/loras'),
                    apiGet('/sdapi/v1/upscalers'),
                    apiGet('/sdapi/v1/prompt-styles'), 
                    apiGet('/sdapi/v1/face-restorers'), 
                    apiGet('/controlnet/model_list').then(d => d.model_list), 
                    apiGet('/controlnet/module_list').then(d => d.module_list) 
                ]);

                G_STATE.models = models;
                G_STATE.samplers = samplers;
                G_STATE.schedulers = schedulers;
                G_STATE.vaes = vaes;
                G_STATE.loras = loras;
                G_STATE.upscalers = upscalers;
                G_STATE.styles = styles; 
                G_STATE.faceRestorers = faceRestorers; 
                G_STATE.controlNetModels = cnModels; 
                G_STATE.controlNetModules = cnModules; 

                // Rellenar Selectores
                populateSelect(E_SELECTORS_NODES.model, models, 'name', 'title', null, G_STATE.currentConfig.sd_model_checkpoint);
                
                // (NUEVO) Obtener el sampler por defecto de la config
                // Primero intentamos con 'sampler_name', luego con 'sampler_index'
                const defaultSampler = G_STATE.currentConfig.sampler_name || G_STATE.currentConfig.sampler_index || null;
                populateSelect(E_SELECTORS_NODES.sampler, samplers, 'name', 'name', null, defaultSampler);
                
                populateSelect(E_SELECTORS_NODES.scheduler, schedulers, 'name', 'label', null, G_STATE.currentConfig.scheduler);
                populateSelect(E_SELECTORS_NODES.vae, vaes, 'model_name', 'model_name', 'Automatic', G_STATE.currentConfig.sd_vae);
                populateSelect(E_SELECTORS_NODES.lora, loras, 'name', 'name', "None");
                
                populateSelect(E_SELECTORS_NODES.styles, styles, 'name', 'name', "None");
                populateSelect(E_SELECTORS_NODES.faceRestorer, faceRestorers, 'name', 'name', "None", G_STATE.currentConfig.face_restoration_model);
                populateSelect(E_SELECTORS_NODES.hrUpscaler, upscalers, 'name', 'name', null, G_STATE.currentConfig.hr_upscaler);
                populateSelect(E_SELECTORS_NODES.extrasUpscaler1, upscalers, 'name', 'name', "None");
                populateSelect(E_SELECTORS_NODES.extrasUpscaler2, upscalers, 'name', 'name', "None");
                populateSelect(E_SELECTORS_NODES.controlNetModel, cnModels, val => val, val => val, "None");
                populateSelect(E_SELECTORS_NODES.controlNetModule, cnModules, val => val, val => val, "None");
                
                // Rellenar config de previews
                if (G_STATE.currentConfig.live_previews_enable !== undefined) {
                    document.getElementById('live-previews-enable').checked = G_STATE.currentConfig.live_previews_enable;
                }
                if (G_STATE.currentConfig.show_progress_every_n_steps) {
                    document.getElementById('show-progress-every-n-steps').value = G_STATE.currentConfig.show_progress_every_n_steps;
                }
                if (G_STATE.currentConfig.show_progress_type) {
                    document.getElementById('show-progress-type').value = G_STATE.currentConfig.show_progress_type;
                }

                showStatus('Recursos cargados. ¡Listo!', false);
                
            } catch (error) {
                const errorMsg = `Error al cargar recursos: ${error.message}. Asegúrate de que ControlNet está instalado si hay errores con 'controlnet'.`;
                if (appContainer.style.display === 'none') {
                    showInitialStatus(errorMsg, true);
                } else {
                    showStatus(errorMsg, true);
                }
                throw error;
            }
        }
        
        async function refreshResources() {
            if (G_STATE.isGenerating) {
                showStatus('No se puede refrescar mientras se procesa.', true);
                return;
            }

            const originalText = refreshResourcesBtn.innerHTML;
            refreshResourcesBtn.disabled = true;
            refreshResourcesBtn.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            showStatus('Refrescando listas en el servidor...', false);

            try {
                await Promise.all([
                    apiPost('/sdapi/v1/refresh-checkpoints', {}),
                    apiPost('/sdapi/v1/refresh-loras', {}),
                    apiPost('/sdapi/v1/refresh-vae', {})
                ]);
                showStatus('Listas refrescadas. Recargando en la UI...', false);
                await loadAndPopulateResources(true); // true = es un refresco
                showStatus('¡Recursos actualizados!', false);
            } catch (error) {
                showStatus(`Error al refrescar: ${error.message}`, true);
            } finally {
                refreshResourcesBtn.disabled = false;
                refreshResourcesBtn.innerHTML = originalText;
            }
        }

        // --- Lógica Principal de Conexión ---
        connectBtn.addEventListener('click', async () => {
            let url = urlInput.value.trim().replace(/\/$/, '');
            if (!url || !url.startsWith('https://')) {
                showInitialStatus('Por favor, ingresa una URL válida que comience con "https://"', true);
                return;
            }
            G_STATE.gradioUrl = url;
            localStorage.setItem('gradioUrl', url); 
            const originalText = connectBtn.innerHTML;
            showLoading(connectBtn); 
            showInitialStatus('Conectando y cargando recursos...');

            try {
                await loadAndPopulateResources(false); 
                toggleAppVisibility(true);
                showStatus('¡Conectado! Listo para generar.', false);

            } catch (error) {
                showInitialStatus(`Error al conectar. Verifica la URL y la consola.`, true);
            } finally {
                hideLoading(connectBtn, originalText); 
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            const savedUrl = localStorage.getItem('gradioUrl');
            if (savedUrl) {
                urlInput.value = savedUrl;
            }
        });

        refreshResourcesBtn.addEventListener('click', refreshResources);

        // (MODIFICADO) populateSelect ahora acepta funciones para value/text
        function populateSelect(selectElements, items, valueKey, textKey, firstOption, selectedValue) {
            if (!items) return;
            selectElements.forEach(selectElement => {
                if (!selectElement) return;
                const currentValue = selectElement.value; 
                selectElement.innerHTML = '';
                
                if (firstOption) {
                    const option = document.createElement('option');
                    option.value = (firstOption === "None" || firstOption === "Automatic") ? firstOption : "";
                    option.textContent = firstOption;
                    selectElement.appendChild(option);
                }
                
                items.forEach(item => {
                    const option = document.createElement('option');
                    const value = typeof valueKey === 'function' ? valueKey(item) : item[valueKey];
                    const text = typeof textKey === 'function' ? textKey(item) : item[textKey];
                    
                    option.value = value;
                    option.textContent = text || value;
                    selectElement.appendChild(option);
                });

                if (selectedValue && Array.from(selectElement.options).some(o => o.value === selectedValue)) {
                    selectElement.value = selectedValue;
                } else if (currentValue && Array.from(selectElement.options).some(o => o.value === currentValue)) {
                    selectElement.value = currentValue; 
                }
            });
        }

        // --- Lógica de Pestañas (¡¡AMPLIADA!!) ---
        const tabButtons = {
            txt2img: document.getElementById('tab-btn-txt2img'),
            img2img: document.getElementById('tab-btn-img2img'),
            extras: document.getElementById('tab-btn-extras'),
            tagger: document.getElementById('tab-btn-tagger'),
            config: document.getElementById('tab-btn-config'),
        };
        const tabPanels = {
            txt2img: document.getElementById('panel-txt2img'),
            img2img: document.getElementById('panel-img2img'),
            extras: document.getElementById('panel-extras'),
            tagger: document.getElementById('panel-tagger'),
            config: document.getElementById('panel-config'),
        };

        function switchTab(targetTab) {
            Object.keys(tabButtons).forEach(key => {
                tabButtons[key].classList.toggle('active', key === targetTab);
            });
            Object.keys(tabPanels).forEach(key => {
                tabPanels[key].classList.toggle('active', key === targetTab);
            });
            
            // Lógica del FAB
            generateTxt2ImgBtn.style.display = (targetTab === 'txt2img') ? 'flex' : 'none';
            generateImg2ImgBtn.style.display = (targetTab === 'img2img') ? 'flex' : 'none';
            generateExtrasBtn.style.display = (targetTab === 'extras') ? 'flex' : 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            Object.keys(tabButtons).forEach(key => {
                tabButtons[key].addEventListener('click', () => switchTab(key));
            });
            switchTab('txt2img'); // Empezar en Txt2Img

            // Listeners para auto-prompt
            document.querySelectorAll('.auto-prompt-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = e.currentTarget.dataset.target;
                    const targetTextarea = document.getElementById(targetId);
                    if (targetTextarea) {
                        targetTextarea.value = AUTO_PROMPT_GENERATOR.generatePrompt();
                        targetTextarea.scrollTop = targetTextarea.scrollHeight;
                        targetTextarea.focus();
                    }
                });
            });
        });

        // --- Lógica de Seed Aleatoria ---
        document.getElementById('random-seed-t2i').addEventListener('click', () => {
            document.getElementById('seed-t2i').value = -1;
        });
        document.getElementById('random-seed-i2i').addEventListener('click', () => {
            document.getElementById('seed-i2i').value = -1;
        });
        
        // --- Añadir Lora al Prompt ---
        document.querySelectorAll('.add-lora-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.target;
                const promptInput = document.getElementById(targetId);
                const loraSelectId = targetId.replace('prompt', 'lora');
                const selectedLora = document.getElementById(loraSelectId).value;
                if (!selectedLora || selectedLora === "None") return;
                promptInput.value += ` <lora:${selectedLora}:1> `;
                promptInput.focus();
                const newCursorPosition = promptInput.value.length;
                promptInput.setSelectionRange(newCursorPosition, newCursorPosition);
            });
        });
        
        // --- (NUEVO) Manejo de Subida de Imagen (Generalizado) ---
        function handleImageUpload(e, previewId, placeholderId, stateKey) {
            const file = e.target.files[0];
            const previewEl = document.getElementById(previewId);
            const placeholderEl = document.getElementById(placeholderId);
            
            if (!file) {
                G_STATE.uploadedImageBase64[stateKey] = null;
                previewEl.classList.remove('active');
                placeholderEl.classList.remove('hidden');
                return;
            }
            const reader = new FileReader();
            reader.onloadend = () => {
                const dataUrl = reader.result;
                previewEl.src = dataUrl;
                previewEl.classList.add('active');
                placeholderEl.classList.add('hidden');
                G_STATE.uploadedImageBase64[stateKey] = dataUrl; // Guardar con prefijo data:
            };
            reader.readAsDataURL(file);
        }

        // Asignar listeners de subida de imagen
        document.getElementById('image-upload-i2i').addEventListener('change', (e) => handleImageUpload(e, 'image-preview-i2i', 'image-preview-placeholder-i2i', 'i2i'));
        document.getElementById('image-upload-extras').addEventListener('change', (e) => handleImageUpload(e, 'image-preview-extras', 'image-preview-placeholder-extras', 'extras'));
        document.getElementById('controlnet-image-upload-t2i').addEventListener('change', (e) => handleImageUpload(e, 'controlnet-image-preview-t2i', 'controlnet-image-placeholder-t2i', 'controlNetT2I'));
        document.getElementById('controlnet-image-upload-i2i').addEventListener('change', (e) => handleImageUpload(e, 'controlnet-image-preview-i2i', 'controlnet-image-placeholder-i2i', 'controlNetI2I'));

        
        // --- Copiar Metadatos ---
        copyMetadataBtn.addEventListener('click', () => {
            if (G_STATE.lastMetadata) {
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = G_STATE.lastMetadata;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    showStatus('Metadatos copiados al portapapeles.', false);
                } catch (err) {
                    showStatus('Error al copiar metadatos.', true);
                }
                document.body.removeChild(tempTextArea);
            }
        });


        // --- Lógica de Progreso (¡¡ACTUALIZADA con PREVIEWS!!) ---
        function startProgressCheck() {
            if (G_STATE.progressInterval) return;
            progressContainer.style.display = 'block';
            const progressBar = document.getElementById('progress-bar');
            const progressLabel = document.getElementById('progress-label');
            progressBar.style.width = '0%';
            progressLabel.textContent = 'Iniciando...';
            
            // Ocultar botones de descarga/copia durante la generación/preview
            downloadBtn.style.display = 'none';
            copyMetadataBtn.style.display = 'none';

            G_STATE.progressInterval = setInterval(async () => {
                if (!G_STATE.isGenerating) {
                    stopProgressCheck();
                    return;
                }
                try {
                    // Pedir progreso Y la imagen de preview
                    const data = await apiGet('/sdapi/v1/progress?skip_current_image=false');
                    
                    if (data.progress > 0) {
                        const percent = Math.round(data.progress * 100);
                        progressBar.style.width = `${percent}%`;
                        const step = data.state.sampling_step || 0;
                        const steps = data.state.sampling_steps || 0;
                        progressLabel.textContent = `${percent}% (${step}/${steps}) - ETA: ${data.eta_relative.toFixed(1)}s`;
                    }
                    if (data.progress === 0 && data.state.job !== '') {
                         progressBar.style.width = '5%';
                         progressLabel.textContent = 'Esperando en la cola...';
                    }
                    
                    // (¡¡NUEVO!!) Mostrar la imagen de preview
                    if (data.current_image) {
                        outputImage.src = 'data:image/png;base64,' + data.current_image;
                        outputImage.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                    }
                    
                } catch (e) {
                    console.error("Error al consultar progreso:", e.message);
                }
            }, 1000); // Aumentado a 1000ms para no saturar con peticiones de imagen
        }
        
        function stopProgressCheck() {
            clearInterval(G_STATE.progressInterval);
            G_STATE.progressInterval = null;
            setTimeout(() => {
                 progressContainer.style.display = 'none';
            }, 1000);
        }

        // --- (NUEVO) Controles de Generación ---
        async function handleInterrupt() {
            showStatus('Enviando solicitud de interrupción...', false);
            try {
                await apiPost('/sdapi/v1/interrupt', {});
                showStatus('Interrupción solicitada.', false);
            } catch (e) {
                showStatus(`Error al interrumpir: ${e.message}`, true);
            }
        }
        interruptBtn.addEventListener('click', handleInterrupt);
        
        async function handleSkip() {
            showStatus('Enviando solicitud de salto...', false);
            try {
                await apiPost('/sdapi/v1/skip', {});
                showStatus('Salto solicitado.', false);
            } catch (e) {
                showStatus(`Error al saltar: ${e.message}`, true);
            }
        }
        skipBtn.addEventListener('click', handleSkip);

        // --- (NUEVO) Herramientas de Imagen ---
        async function handleInterrogate() {
            if (!G_STATE.uploadedImageBase64.i2i) {
                showStatus('Sube una imagen en Img2Img primero.', true);
                return;
            }
            showStatus('Interrogando imagen (CLIP)...', false);
            try {
                const payload = {
                    "image": G_STATE.uploadedImageBase64.i2i, // Debe incluir "data:image/..."
                    "model": "clip" // Puedes cambiar a "deepbooru" si lo prefieres
                };
                const result = await apiPost('/sdapi/v1/interrogate', payload);
                if (result.caption) {
                    promptI2I.value = result.caption;
                    showStatus('Prompt generado desde la imagen.', false);
                }
            } catch (e) {
                showStatus(`Error al interrogar: ${e.message}`, true);
            }
        }
        document.getElementById('interrogate-btn-i2i').addEventListener('click', handleInterrogate);
        
        async function handlePngInfo() {
            if (!G_STATE.uploadedImageBase64.i2i) {
                showStatus('Sube una imagen generada en Img2Img primero.', true);
                return;
            }
            showStatus('Leyendo metadatos PNG Info...', false);
            try {
                const payload = {
                    "image": G_STATE.uploadedImageBase64.i2i.split(',')[1] // PNG Info requiere base64 puro
                };
                const result = await apiPost('/sdapi/v1/png-info', payload);
                if (result.info) {
                    metadataDisplay.textContent = result.info;
                    metadataDisplay.classList.remove('hidden');
                    G_STATE.lastMetadata = result.info;
                    showStatus('Metadatos leídos con éxito.', false);
                    
                    // (Opcional) Intentar rellenar la UI
                    // Esto es complejo, por ahora solo mostramos la info.
                    if (result.parameters && result.parameters.Prompt) {
                        promptI2I.value = result.parameters.Prompt;
                    }
                    if (result.parameters && result.parameters["Negative prompt"]) {
                        document.getElementById('negative-prompt-i2i').value = result.parameters["Negative prompt"];
                    }
                    // ... etc ...
                    
                }
            } catch (e) {
                showStatus(`Error al leer PNG Info: ${e.message}`, true);
            }
        }
        document.getElementById('pnginfo-btn-i2i').addEventListener('click', handlePngInfo);
        
        // --- (NUEVO) Pestaña de Configuración ---
        async function handleGetMemory() {
            const btn = document.getElementById('get-memory-btn');
            const display = document.getElementById('memory-display');
            btn.disabled = true;
            display.style.display = 'block';
            display.textContent = 'Consultando...';
            
            try {
                const result = await apiGet('/sdapi/v1/memory');
                const ram = result.ram;
                const cuda = result.cuda;
                
                const formatBytes = (bytes) => (bytes / (1024**3)).toFixed(2) + ' GB';
                
                let text = `RAM (Sistema):\n`;
                text += `  Total: ${formatBytes(ram.total)}\n`;
                text += `  Usada: ${formatBytes(ram.used)}\n`;
                text += `  Libre: ${formatBytes(ram.free)}\n\n`;
                
                text += `VRAM (CUDA):\n`;
                text += `  Total: ${formatBytes(cuda.total)}\n`;
                text += `  Usada: ${formatBytes(cuda.used)}\n`;
                text += `  Libre: ${formatBytes(cuda.free)}\n`;
                
                display.textContent = text;
                
            } catch (e) {
                display.textContent = `Error al consultar memoria:\n${e.message}`;
            } finally {
                btn.disabled = false;
            }
        }
        document.getElementById('get-memory-btn').addEventListener('click', handleGetMemory);

        // (¡¡NUEVO!!) Guardar Configuración de Preview
        async function handleSavePreviewConfig() {
            const btn = document.getElementById('save-preview-config-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Guardando...';
            
            try {
                const payload = {
                    "live_previews_enable": document.getElementById('live-previews-enable').checked,
                    "show_progress_every_n_steps": parseInt(document.getElementById('show-progress-every-n-steps').value, 10),
                    "show_progress_type": document.getElementById('show-progress-type').value
                };
                
                await apiPost('/sdapi/v1/options', payload);
                showStatus('Configuración de preview guardada.', false);
                
                // Actualizar config local
                G_STATE.currentConfig.live_previews_enable = payload.live_previews_enable;
                G_STATE.currentConfig.show_progress_every_n_steps = payload.show_progress_every_n_steps;
                G_STATE.currentConfig.show_progress_type = payload.show_progress_type;
                
            } catch (e) {
                showStatus(`Error al guardar config: ${e.message}`, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        document.getElementById('save-preview-config-btn').addEventListener('click', handleSavePreviewConfig);

        // --- (NUEVO) Lógica del Visor Modal ---
        function openModal() {
            if (!G_STATE.isGenerating && outputImage.src && !outputImage.classList.contains('hidden')) {
                modalImage.src = outputImage.src;
                modal.classList.add('active');
            }
        }
        function closeModal() {
            modal.classList.remove('active');
            modalImage.src = '';
        }
        outputImage.addEventListener('click', openModal);
        modalCloseBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) { // Cerrar solo si se hace clic en el fondo
                closeModal();
            }
        });


        // --- Lógica de Generación (¡¡CORREGIDA!!) ---
        async function handleGeneration(mode) {
            if (G_STATE.isGenerating) return;

            // (NUEVO) Scroll al área de resultados
            try {
                document.getElementById('results-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch(e) { console.warn("No se pudo hacer scroll:", e); }

            
            startProgressCheck();
            
            let payload;
            let endpoint;
            let button;
            let buttonText;
            
            // --- Construir Payload Base ---
            const buildBasePayload = (prefix) => {
                const p = {
                    "prompt": document.getElementById(`prompt-${prefix}`).value,
                    "negative_prompt": document.getElementById(`negative-prompt-${prefix}`).value,
                    "styles": [document.getElementById(`styles-${prefix}`).value].filter(s => s && s !== "None"),
                    
                    // (¡¡CORREGIDO!!) sampler_name y scheduler van en el root del payload.
                    "sampler_name": document.getElementById(`sampler-${prefix}`).value,
                    "scheduler": document.getElementById(`scheduler-${prefix}`).value,
                    
                    "steps": parseInt(document.getElementById(`steps-${prefix}`).value, 10),
                    "cfg_scale": parseFloat(document.getElementById(`cfg-${prefix}`).value),
                    "width": parseInt(document.getElementById(`width-${prefix}`).value, 10),
                    "height": parseInt(document.getElementById(`height-${prefix}`).value, 10),
                    "n_iter": parseInt(document.getElementById(`batch-count-${prefix}`).value, 10),
                    "batch_size": 1, 
                    "seed": parseInt(document.getElementById(`seed-${prefix}`).value, 10),
                    "restore_faces": document.getElementById(`face-restorer-${prefix}`).value !== "None",
                    "send_images": true,
                    "save_images": false,
                    "override_settings": {
                        // El modelo y VAE sí van aquí para sobreescribir la config del backend
                        "sd_model_checkpoint": document.getElementById(`model-${prefix}`).value,
                        "sd_vae": document.getElementById(`vae-${prefix}`).value,
                        "face_restoration_model": document.getElementById(`face-restorer-${prefix}`).value
                    },
                    "alwayson_scripts": {}
                };
                return p;
            };
            
            // --- Construir Payload de ControlNet ---
            const buildControlNetPayload = (prefix) => {
                const cnDetails = document.getElementById(`controlnet-details-${prefix}`);
                if (!cnDetails || !cnDetails.open) return null; // No añadir si está cerrado
                
                const image = G_STATE.uploadedImageBase64[prefix === 't2i' ? 'controlNetT2I' : 'controlNetI2I'];
                if (!image) return null; // No añadir si no hay imagen

                return {
                    "args": [
                        {
                            "input_image": image.split(',')[1], // Base64 puro
                            "module": document.getElementById(`controlnet-module-${prefix}`).value,
                            "model": document.getElementById(`controlnet-model-${prefix}`).value,
                            "weight": parseFloat(document.getElementById(`controlnet-weight-${prefix}`).value),
                        }
                    ]
                };
            };

            // --- Seleccionar Modo ---
            if (mode === 'txt2img') {
                button = generateTxt2ImgBtn;
                buttonText = "Generar";
                payload = buildBasePayload('t2i');
                
                // Hires. Fix
                const hrDetails = document.getElementById('hr-details-t2i');
                if (hrDetails && hrDetails.open) {
                    payload.enable_hr = true;
                    payload.hr_scale = parseFloat(document.getElementById('hr-scale-t2i').value);
                    payload.hr_upscaler = document.getElementById('hr-upscaler-t2i').value;
                    payload.hr_second_pass_steps = parseInt(document.getElementById('hr-steps-t2i').value, 10);
                    payload.denoising_strength = parseFloat(document.getElementById('hr-denoising-t2i').value); 
                }
                
                // ControlNet
                const cnPayload = buildControlNetPayload('t2i');
                if (cnPayload) payload.alwayson_scripts.controlnet = cnPayload;
                
                endpoint = '/sdapi/v1/txt2img';
                
            } else if (mode === 'img2img') {
                if (!G_STATE.uploadedImageBase64.i2i) {
                    showStatus('Por favor, sube una imagen de origen primero.', true);
                    stopProgressCheck(); // (NUEVO) Detener progreso si no hay imagen
                    return;
                }
                button = generateImg2ImgBtn;
                buttonText = "Generar";
                payload = buildBasePayload('i2i');
                payload.init_images = [ G_STATE.uploadedImageBase64.i2i ];
                payload.denoising_strength = parseFloat(document.getElementById('denoising-i2i').value);
                
                // ControlNet
                const cnPayload = buildControlNetPayload('i2i');
                if (cnPayload) payload.alwayson_scripts.controlnet = cnPayload;
                
                endpoint = '/sdapi/v1/img2img';

            } else if (mode === 'extras') {
                if (!G_STATE.uploadedImageBase64.extras) {
                    showStatus('Sube una imagen en la pestaña Extras primero.', true);
                    stopProgressCheck(); // (NUEVO) Detener progreso si no hay imagen
                    return;
                }
                button = generateExtrasBtn;
                buttonText = "Escalar";
                payload = {
                    "image": G_STATE.uploadedImageBase64.extras.split(',')[1], // Base64 puro
                    "resize_mode": parseInt(document.getElementById('extras-resize-mode').value, 10),
                    "upscaling_resize": parseFloat(document.getElementById('extras-scale-factor').value),
                    "upscaling_resize_w": parseInt(document.getElementById('extras-width').value, 10),
                    "upscaling_resize_h": parseInt(document.getElementById('extras-height').value, 10),
                    "upscaler_1": document.getElementById('extras-upscaler-1').value,
                    "upscaler_2": document.getElementById('extras-upscaler-2').value,
                    "extras_upscaler_2_visibility": parseFloat(document.getElementById('extras-upscaler-2-visibility').value),
                    "gfpgan_visibility": document.getElementById('face-restorer-extras').value === "GFPGAN" ? 1 : 0,
                    "codeformer_visibility": document.getElementById('face-restorer-extras').value === "CodeFormer" ? 1 : 0,
                    "codeformer_weight": 0.5, // Podrías añadir un slider para esto
                };
                endpoint = '/sdapi/v1/extra-single-image';
            }

            showGenerationProgress(button);
            
            // Ocultar resultados anteriores
            downloadBtn.style.display = 'none';
            copyMetadataBtn.style.display = 'none';
            metadataDisplay.classList.add('hidden');
            // No ocultar la imagen/placeholder, el progress check la actualizará

            try {
                showStatus('Enviando solicitud de generación...');
                const result = await apiPost(endpoint, payload);
                
                let base64Image, info;
                
                // Manejar diferentes formatos de respuesta
                if (mode === 'extras') {
                    base64Image = result.image; // Singular
                    info = result.html_info; // Es un string HTML
                } else {
                    base64Image = result.images[0]; // Plural
                    info = result.info; // Es un JSON string
                }
                
                if (base64Image) {
                    const dataUrl = 'data:image/png;base64,' + base64Image;
                    outputImage.src = dataUrl; // Imagen final
                    outputImage.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    
                    if (info) {
                        let metadataText;
                        if (mode === 'extras') {
                            metadataText = info.replace(/<[^>]*>?/gm, ''); // Limpiar HTML
                        } else {
                             try {
                                const infoParsed = JSON.parse(info);
                                // (NUEVO) Mostrar el sampler y scheduler usados
                                const sampler = infoParsed.sampler_name || (payload.sampler_name || "N/A");
                                const scheduler = infoParsed.scheduler_name || (payload.scheduler || "N/A");

                                metadataText = `**Prompt:** ${infoParsed.prompt}\n**Negative Prompt:** ${infoParsed.negative_prompt}\n---\n**Seed:** ${infoParsed.seed}\n**Steps:** ${infoParsed.steps}\n**CFG Scale:** ${infoParsed.cfg_scale}\n**Sampler:** ${sampler}\n**Scheduler:** ${scheduler}\n**Model:** ${infoParsed.sd_model_name || 'N/A'}\n**VAE:** ${infoParsed.sd_vae_name || 'N/A'}\n**Size:** ${infoParsed.width}x${infoParsed.height}`;
                            } catch (e) {
                                metadataText = `Raw Info: ${info}`;
                            }
                        }
                        metadataDisplay.textContent = metadataText;
                        metadataDisplay.classList.remove('hidden');
                        G_STATE.lastMetadata = metadataText;
                    }

                    downloadBtn.style.display = 'block';
                    copyMetadataBtn.style.display = 'block';
                    downloadBtn.onclick = () => {
                        const link = document.createElement('a');
                        link.href = dataUrl;
                        link.download = `generated_${Date.now()}.png`;
                        link.click();
                    };
                    showStatus('¡Imagen generada con éxito!', false);
                } else {
                    throw new Error('La respuesta de la API no contiene imágenes.');
                }
                
            } catch (error) {
                console.error(error);
                showStatus(`Error: ${error.message}. Verifica tu prompt y conexión.`, true);
            } finally {
                hideGenerationProgress(button, buttonText);
                stopProgressCheck();
            }
        }
        
        // --- Triggers de Generación ---
        generateTxt2ImgBtn.addEventListener('click', () => handleGeneration('txt2img'));
        generateImg2ImgBtn.addEventListener('click', () => handleGeneration('img2img'));
        generateExtrasBtn.addEventListener('click', () => handleGeneration('extras'));

    </script>
</body>
</html>