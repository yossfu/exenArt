<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RPG Pocket Master (Free Edition)</title>
<style>
  @import url("https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@500;700&display=swap");

  :root {
    --primary: #d4a373;
    --secondary: #faedcd;
    --bg-dark: #231b15;
    --panel-bg: rgba(30, 24, 18, 0.98);
    --accent: #e63946;
    --success: #2a9d8f;
    --text-main: #fefae0;
    --font-head: "Press Start 2P", cursive;
    --font-body: "Rajdhani", sans-serif;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0;
    padding: 0;
    background-color: var(--bg-dark);
    color: var(--text-main);
    font-family: var(--font-body);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background-image: url("https://image.pollinations.ai/prompt/dark%20fantasy%20rpg%20background%20texture%20leather%20and%20wood?nologo=true");
    background-size: cover;
    background-position: center;
  }

  /* --- UTILS --- */
  .hidden { display: none !important; }
  .click-feedback { animation: pulse 0.1s; }

  /* --- NOTIFICATIONS --- */
  #notification-area {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    z-index: 3000; display: flex; flex-direction: column; gap: 10px; pointer-events: none;
    width: 90%; max-width: 400px;
  }
  .toast {
    background: var(--panel-bg); border: 1px solid var(--primary);
    padding: 10px 15px; border-radius: 8px; color: white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    animation: slideDown 0.3s ease-out;
    display: flex; align-items: center; gap: 10px;
  }
  .toast-success { border-color: var(--success); color: var(--success); }
  .toast-error { border-color: var(--accent); color: var(--accent); }

  /* --- START SCREEN --- */
  #startScreen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(15, 12, 8, 0.98);
    z-index: 1000;
    display: flex; flex-direction: column;
    padding: 20px; overflow-y: auto;
  }

  .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .settings-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; transition: color 0.3s; }
  .settings-btn:hover { color: var(--primary); }

  .game-title {
    font-family: var(--font-head); color: var(--primary);
    text-align: center; font-size: 20px;
    text-shadow: 0 4px var(--accent); line-height: 1.5;
  }

  .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
  .tab-btn {
    flex: 1; background: #333; border: none; padding: 12px;
    color: #888; font-family: var(--font-head); font-size: 10px;
    cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s;
  }
  .tab-btn.active { background: var(--primary); color: var(--bg-dark); }

  .tab-content {
    background: rgba(40, 30, 25, 0.8);
    padding: 20px; border-radius: 0 0 12px 12px;
    border: 1px solid var(--primary);
    display: none; flex-direction: column; gap: 15px;
    backdrop-filter: blur(5px);
  }
  .tab-content.active { display: flex; }

  label { font-weight: bold; color: var(--primary); font-size: 14px; margin-bottom: 5px; display: block; }
  input, select, textarea {
    width: 100%; padding: 12px; background: rgba(0,0,0,0.4);
    border: 1px solid #555; border-radius: 8px;
    color: white; font-family: var(--font-body); font-size: 16px;
  }
  textarea { resize: vertical; min-height: 80px; }
  input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; background: rgba(0,0,0,0.6); }

  .big-btn {
    background: linear-gradient(180deg, var(--success), #1b635a);
    color: white; font-family: var(--font-head);
    padding: 15px; border: none; border-radius: 10px;
    margin-top: 20px; font-size: 14px; cursor: pointer;
    box-shadow: 0 5px #0f3d37; width: 100%;
    transition: transform 0.1s;
  }
  .big-btn:active { transform: translateY(4px); box-shadow: 0 1px #0f3d37; }

  /* --- AVATAR PREVIEW --- */
  .avatar-preview-container {
    text-align: center; padding: 15px;
    background: rgba(0,0,0,0.4); border-radius: 12px;
    margin-bottom: 20px; border: 1px dashed var(--primary);
  }
  .preview-emoji { font-size: 60px; display: inline-block; filter: drop-shadow(0 0 15px rgba(212, 163, 115, 0.3)); }
  .anim-breath { animation: breath 3s infinite ease-in-out; }

  /* --- GAME HUD --- */
  .hud {
    background: var(--panel-bg); padding: 10px 15px;
    display: flex; align-items: center;
    border-bottom: 3px solid var(--primary);
    box-shadow: 0 5px 20px rgba(0,0,0,0.6); z-index: 10;
  }
  .hud-avatar {
    width: 50px; height: 50px; border-radius: 50%;
    background: #1a1510; display: flex; align-items: center; justify-content: center;
    font-size: 28px; border: 2px solid var(--primary); margin-right: 12px;
    cursor: pointer;
  }
  .hud-stats { flex: 1; }
  .bar-container {
    height: 12px; background: #111; border-radius: 6px;
    margin-bottom: 6px; position: relative; overflow: hidden; border: 1px solid #333;
  }
  .bar-fill { height: 100%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
  .hp-fill { background: linear-gradient(90deg, #e63946, #ff6b6b); }
  .xp-fill { background: linear-gradient(90deg, #2a9d8f, #4ade80); }
  
  .hud-text { font-size: 12px; color: #bbb; display: flex; justify-content: space-between; font-weight: bold; }

  /* --- CHAT AREA --- */
  #gameChat {
    flex: 1; overflow-y: auto; padding: 15px;
    padding-bottom: 180px; display: flex; flex-direction: column;
    gap: 15px; scroll-behavior: smooth;
    background: radial-gradient(circle at center, rgba(0,0,0,0.3), rgba(0,0,0,0.8));
  }
  .msg {
    max-width: 88%; padding: 14px 18px; border-radius: 12px;
    line-height: 1.5; font-size: 16px; position: relative;
    animation: popIn 0.3s ease-out; word-wrap: break-word;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }
  .msg-ai {
    background: var(--panel-bg); border-left: 4px solid var(--primary);
    border-top-left-radius: 2px; margin-right: auto;
  }
  .msg-user {
    align-self: flex-end; background: #3d5a80; color: white;
    border-right: 4px solid #98c1d9; border-top-right-radius: 2px;
    margin-left: auto;
  }
  .msg-img {
    width: 100%; max-width: 400px; border-radius: 8px; margin-top: 10px;
    border: 2px solid #555; display: block; background: #000; min-height: 150px;
    object-fit: cover;
  }
  .typing {
    font-style: italic; color: var(--primary); font-size: 12px;
    margin: 10px 20px; display: none;
    animation: pulse 1.5s infinite;
  }

  /* --- BOTTOM CONTROLS --- */
  .controls-area {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: var(--panel-bg); padding: 12px;
    border-top: 2px solid var(--primary); z-index: 20;
    display: flex; flex-direction: column; gap: 12px;
  }
  .chips-scroll {
    display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px;
    -ms-overflow-style: none; scrollbar-width: none;
  }
  .chips-scroll::-webkit-scrollbar { display: none; }
  .action-chip {
    background: rgba(255,255,255,0.05); border: 1px solid var(--primary);
    color: var(--secondary); padding: 8px 16px; border-radius: 20px;
    white-space: nowrap; font-size: 14px; cursor: pointer;
    transition: background 0.2s;
  }
  .action-chip:active { background: var(--primary); color: #000; }

  .input-group { display: flex; gap: 10px; }
  #playerInput {
    flex: 1; padding: 12px 20px; border-radius: 25px;
    border: 2px solid #555; background: #222; color: white;
  }
  #sendBtn {
    width: 50px; height: 50px; border-radius: 50%; border: none;
    background: var(--primary); color: #222; font-size: 20px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px #8b6b4b; cursor: pointer; flex-shrink: 0;
  }
  #sendBtn:active { transform: translateY(2px); box-shadow: 0 2px #8b6b4b; }

  /* --- MODAL --- */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 2000;
    display: none; align-items: center; justify-content: center;
    padding: 20px; backdrop-filter: blur(5px);
  }
  .modal-overlay.active { display: flex; }
  .modal-box {
    background: #231b15; border: 2px solid var(--primary);
    border-radius: 15px; width: 100%; max-width: 400px;
    max-height: 85vh; display: flex; flex-direction: column;
    box-shadow: 0 10px 40px rgba(0,0,0,1); animation: popIn 0.2s;
  }
  .modal-head {
    padding: 15px; background: var(--primary); color: #1a1510;
    font-family: var(--font-head); font-size: 14px;
    display: flex; justify-content: space-between; align-items: center;
    border-radius: 12px 12px 0 0;
  }
  .modal-body { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }

  .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #444; }
  .inv-item { background: #333; padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 10px; border: 1px solid #444; }

  /* --- ANIMATIONS --- */
  @keyframes breath { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
  @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
  @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
  .shake { animation: shake 0.5s; }

  .api-note {
    font-size: 12px; color: #aaa; background: #333; padding: 10px;
    border-radius: 5px; border-left: 3px solid var(--success); margin-bottom: 10px;
  }
</style>
</head>
<body>

  <!-- NOTIFICACIONES -->
  <div id="notification-area"></div>

  <!-- PANTALLA DE INICIO -->
  <div id="startScreen">
    <div class="header-row">
      <div class="game-title">‚öîÔ∏è RPG POCKET<br>FREE EDITION</div>
      <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
    </div>
    
    <div class="avatar-preview-container">
      <div id="previewEmoji" class="preview-emoji anim-breath">üë§</div>
      <div id="previewText" style="color: #aaa; margin-top: 5px; font-size: 14px;">Viajero Desconocido</div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('hero')">H√âROE</button>
      <button class="tab-btn" onclick="switchTab('lore')">HISTORIA</button>
      <button class="tab-btn" onclick="switchTab('world')">MUNDO</button>
    </div>

    <!-- H√âROE -->
    <div id="tab-hero" class="tab-content active">
      <label>Nombre</label>
      <input type="text" id="charName" placeholder="Ej: Aragorn">
      
      <label>Raza</label>
      <select id="charRace" onchange="checkCustom('charRace', 'customRace'); updatePreview()">
        <option value="human">Humano</option>
        <option value="elf">Elfo</option>
        <option value="dwarf">Enano</option>
        <option value="orc">Orco</option>
        <option value="cyborg">Cyborg</option>
        <option value="alien">Alien</option>
        <option value="catfolk">F√©lido</option>
        <option value="custom">üõ†Ô∏è Personalizada...</option>
      </select>
      <input type="text" id="customRace" placeholder="Escribe tu raza..." style="display:none;" oninput="updatePreview()">

      <label>Clase</label>
      <select id="charClass" onchange="checkCustom('charClass', 'customClass'); updatePreview()">
        <option value="warrior">Guerrero</option>
        <option value="mage">Mago</option>
        <option value="rogue">P√≠caro</option>
        <option value="hacker">Hacker</option>
        <option value="pilot">Piloto</option>
        <option value="monk">Monje</option>
        <option value="custom">üõ†Ô∏è Personalizada...</option>
      </select>
      <input type="text" id="customClass" placeholder="Escribe tu clase..." style="display:none;" oninput="updatePreview()">
    </div>

    <!-- LORE -->
    <div id="tab-lore" class="tab-content">
      <label>Trasfondo (Lore)</label>
      <textarea id="charLore" placeholder="¬øQui√©n eres? ¬øQu√© buscas? Ej: Busco la espada perdida de mi clan..."></textarea>
      
      <label>G√©nero</label>
      <select id="charGender">
        <option value="male">Masculino</option>
        <option value="female">Femenino</option>
        <option value="nb">No Binario</option>
      </select>
    </div>

    <!-- MUNDO -->
    <div id="tab-world" class="tab-content">
      <label>Tem√°tica</label>
      <select id="worldTheme" onchange="checkCustom('worldTheme', 'customTheme')">
        <option value="fantasy">Fantas√≠a Medieval</option>
        <option value="cyberpunk">Cyberpunk / Futuro</option>
        <option value="horror">Horror C√≥smico</option>
        <option value="postapoc">Post-Apocal√≠ptico</option>
        <option value="wildwest">Viejo Oeste</option>
        <option value="custom">üõ†Ô∏è Personalizada...</option>
      </select>
      <input type="text" id="customTheme" placeholder="Ej: Mundo hecho de dulces..." style="display:none;">

      <label>Reglas del Mundo</label>
      <textarea id="worldLore" placeholder="Detalles extra. Ej: La magia est√° prohibida por el Emperador..."></textarea>
    </div>

    <button class="big-btn" onclick="startGame()">¬°COMENZAR AVENTURA! ‚ñ∂</button>
  </div>

  <!-- INTERFAZ JUEGO -->
  <div class="hud">
    <div class="hud-avatar" id="hudAvatar" onclick="openMenu()">üë§</div>
    <div class="hud-stats">
      <div class="bar-container"><div id="hpBar" class="bar-fill hp-fill" style="width: 100%"></div></div>
      <div class="bar-container"><div id="xpBar" class="bar-fill xp-fill" style="width: 0%"></div></div>
      <div class="hud-text">
        <span>HP <b id="hpVal">100</b></span>
        <span>LVL <b id="lvlVal">1</b></span>
      </div>
    </div>
    <button class="settings-btn" style="margin-left: 10px;" onclick="openMenu()">‚ò∞</button>
  </div>

  <div id="gameChat">
    <div class="msg msg-ai">
      Bienvenido. Configura tu personaje para iniciar la simulaci√≥n...
    </div>
  </div>
  <div id="typingIndicator" class="typing">‚ú® Conectando con el Or√°culo (Gratis)...</div>

  <div class="controls-area">
    <div class="chips-scroll">
      <div class="action-chip" onclick="quickAction('Inspeccionar √°rea')">üëÅÔ∏è Mirar</div>
      <div class="action-chip" onclick="quickAction('Abrir inventario')">üéí Inventario</div>
      <div class="action-chip" onclick="quickAction('Atacar enemigo')">‚öîÔ∏è Atacar</div>
      <div class="action-chip" onclick="quickAction('Explorar')">ü¶∂ Explorar</div>
      <div class="action-chip" onclick="quickAction('Hablar con alguien')">üó£Ô∏è Hablar</div>
    </div>
    <div class="input-group">
      <input type="text" id="playerInput" placeholder="¬øQu√© haces?" autocomplete="off">
      <button id="sendBtn" onclick="submitAction()">‚û§</button>
    </div>
  </div>

  <!-- MENU MODAL -->
  <div id="menuModal" class="modal-overlay" onclick="closeMenu(event)">
    <div class="modal-box">
      <div class="modal-head">
        <span>MEN√ö DE PERSONAJE</span>
        <span onclick="toggleModal('menuModal')" style="cursor:pointer; font-size:20px;">‚úñ</span>
      </div>
      <div class="modal-body">
        <h3 style="color:var(--primary); margin:0;">Estad√≠sticas</h3>
        <div class="stat-row"><span>Nombre:</span> <span id="menuName">--</span></div>
        <div class="stat-row"><span>Clase:</span> <span id="menuClass">--</span></div>
        <div class="stat-row"><span>XP:</span> <span id="menuXP">0/100</span></div>
        
        <h3 style="color:var(--primary); margin-top:10px;">Inventario</h3>
        <div id="inventoryList" style="max-height: 150px; overflow-y:auto;">
            <div style="color:#666; font-style:italic;">Vac√≠o...</div>
        </div>

        <h3 style="color:var(--primary); margin-top:10px;">Sistema</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="action-chip" style="text-align:center;" onclick="toggleSound()">üîä <span id="soundStatus">ON</span></button>
            <button class="action-chip" style="text-align:center;" onclick="openSettings()">‚öôÔ∏è Config</button>
            <button class="action-chip" style="text-align:center; border-color:var(--success); color:var(--success);" onclick="saveGame()">üíæ Guardar</button>
            <button class="action-chip" style="text-align:center; border-color:var(--accent); color:var(--accent);" onclick="resetGame()">‚ôª Reiniciar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settingsModal" class="modal-overlay" onclick="closeSettings(event)">
    <div class="modal-box">
      <div class="modal-head">
        <span>CONFIGURACI√ìN</span>
        <span onclick="toggleModal('settingsModal')" style="cursor:pointer; font-size:20px;">‚úñ</span>
      </div>
      <div class="modal-body">
        <div class="api-note">
           <b>Modo Gratuito Activado:</b><br>
           Est√°s usando <b>Pollinations.ai</b>. Una API p√∫blica, gratuita y sin registro para texto e im√°genes.
           <br><br>
           <i>Nota: Al ser p√∫blico, la privacidad no es total y la velocidad depende del tr√°fico global.</i>
        </div>
        
        <label>Estado del Servicio</label>
        <div style="background: #333; padding: 10px; border-radius: 8px; color: var(--success);">
            ‚úÖ API P√∫blica Conectada
        </div>
        
        <button class="big-btn" onclick="toggleModal('settingsModal')">CERRAR</button>
      </div>
    </div>
  </div>

<script>
  /* --- SISTEMA DE SONIDO --- */
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  let audioCtx = new AudioContext();
  let soundEnabled = true;

  function playTone(type) {
    if (!soundEnabled) return;
    if (audioCtx.state === 'suspended') audioCtx.resume().catch(e=>console.log(e));

    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    const now = audioCtx.currentTime;

    if (type === 'click') {
      osc.type = 'sine';
      osc.frequency.setValueAtTime(800, now);
      osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
      gainNode.gain.setValueAtTime(0.05, now);
      gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
      osc.start(now); osc.stop(now + 0.1);
    } 
    else if (type === 'start') {
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(220, now);
      osc.frequency.linearRampToValueAtTime(440, now + 0.2);
      gainNode.gain.setValueAtTime(0.1, now);
      gainNode.gain.linearRampToValueAtTime(0, now + 0.4);
      osc.start(now); osc.stop(now + 0.4);
    }
    else if (type === 'message') {
      osc.type = 'sine';
      osc.frequency.setValueAtTime(600, now);
      gainNode.gain.setValueAtTime(0.02, now);
      gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
      osc.start(now); osc.stop(now + 0.15);
    }
    else if (type === 'hit') {
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(150, now);
      osc.frequency.linearRampToValueAtTime(50, now + 0.2);
      gainNode.gain.setValueAtTime(0.1, now);
      gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
      osc.start(now); osc.stop(now + 0.3);
    }
    else if (type === 'levelup') {
      osc.type = 'square';
      osc.frequency.setValueAtTime(440, now);
      osc.frequency.setValueAtTime(554, now + 0.1);
      osc.frequency.setValueAtTime(659, now + 0.2);
      gainNode.gain.setValueAtTime(0.05, now);
      gainNode.gain.linearRampToValueAtTime(0, now + 0.5);
      osc.start(now); osc.stop(now + 0.5);
    }
  }

  function toggleSound() {
    soundEnabled = !soundEnabled;
    document.getElementById('soundStatus').innerText = soundEnabled ? "ON" : "OFF";
    playTone('click');
  }

  /* --- UI & TOASTS --- */
  function showToast(msg, type = 'success') {
    const area = document.getElementById('notification-area');
    const div = document.createElement('div');
    div.className = `toast toast-${type}`;
    div.innerHTML = `<span>${type==='error'?'‚ö†Ô∏è':'‚úÖ'}</span> <span>${msg}</span>`;
    area.appendChild(div);
    setTimeout(() => { div.style.opacity = '0'; setTimeout(()=>div.remove(), 300); }, 3000);
  }

  function switchTab(tabId) {
    playTone('click');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('tab-' + tabId).classList.add('active');
  }

  function checkCustom(selectId, inputId) {
    const val = document.getElementById(selectId).value;
    document.getElementById(inputId).style.display = val === 'custom' ? 'block' : 'none';
    if(val === 'custom') document.getElementById(inputId).focus();
  }

  const emojiMap = {
    human: "üë±", elf: "üßù", dwarf: "üßî", orc: "üëπ", cyborg: "ü§ñ", alien: "üëΩ", catfolk: "üê±", custom: "üë§",
    warrior: "‚öîÔ∏è", mage: "üîÆ", rogue: "üó°Ô∏è", hacker: "üíª", pilot: "üöÄ", monk: "ü•ã", custom: "‚ú®"
  };

  function updatePreview() {
    const rSelect = document.getElementById('charRace').value;
    const cSelect = document.getElementById('charClass').value;
    const rVal = rSelect === 'custom' ? (document.getElementById('customRace').value || 'Desconocido') : rSelect;
    const cVal = cSelect === 'custom' ? (document.getElementById('customClass').value || 'Aventurero') : cSelect;
    const rEmoji = emojiMap[rSelect] || "üë§";
    const cEmoji = emojiMap[cSelect] || "‚ú®";
    document.getElementById('previewEmoji').innerText = rEmoji + cEmoji;
    
    let rLabel = rSelect;
    let cLabel = cSelect;
    try {
        rLabel = rSelect === 'custom' ? rVal : document.querySelector(`#charRace option[value="${rSelect}"]`).text;
        cLabel = cSelect === 'custom' ? cVal : document.querySelector(`#charClass option[value="${cSelect}"]`).text;
    } catch(e) {}

    document.getElementById('previewText').innerText = `${rLabel} ${cLabel}`;
  }

  /* --- MODALS --- */
  function toggleModal(id) {
    playTone('click');
    const el = document.getElementById(id);
    el.classList.toggle('active');
    if(el.classList.contains('active') && id === 'menuModal') updateMenu();
  }
  
  function openMenu() { toggleModal('menuModal'); }
  function closeMenu(e) { if(e.target.id === 'menuModal') toggleModal('menuModal'); }
  
  function openSettings() { toggleModal('settingsModal'); }
  function closeSettings(e) { if(e.target.id === 'settingsModal') toggleModal('settingsModal'); }

  /* --- GAME LOGIC --- */
  let gameState = {
    name: "", race: "", class: "", gender: "", lore: "",
    theme: "", themeLore: "",
    hp: 100, maxHp: 100, xp: 0, level: 1,
    inventory: [],
    history: []
  };

  async function startGame() {
    // Collect Data
    const name = document.getElementById('charName').value.trim() || "H√©roe";
    const rSelect = document.getElementById('charRace').value;
    const cSelect = document.getElementById('charClass').value;
    const tSelect = document.getElementById('worldTheme').value;
    
    gameState.name = name;
    gameState.race = rSelect === 'custom' ? document.getElementById('customRace').value : document.querySelector(`#charRace option[value="${rSelect}"]`).text;
    gameState.class = cSelect === 'custom' ? document.getElementById('customClass').value : document.querySelector(`#charClass option[value="${cSelect}"]`).text;
    gameState.gender = document.getElementById('charGender').options[document.getElementById('charGender').selectedIndex].text;
    gameState.lore = document.getElementById('charLore').value || "Un viajero misterioso.";
    gameState.theme = tSelect === 'custom' ? document.getElementById('customTheme').value : document.querySelector(`#worldTheme option[value="${tSelect}"]`).text;
    gameState.themeLore = document.getElementById('worldLore').value || "Un mundo lleno de misterios.";

    // HUD Setup
    const rEmoji = emojiMap[rSelect] || "üë§";
    document.getElementById('hudAvatar').innerText = rEmoji;
    gameState.inventory = ["Mapa Viejo", "Raciones (2)"];
    
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('gameChat').innerHTML = "";
    playTone('start');
    
    // Initial Prompt
    const prompt = `INICIO. Personaje: ${gameState.name}, ${gameState.race} ${gameState.class} (${gameState.gender}). Lore: ${gameState.lore}. Mundo: ${gameState.theme}. Detalles Mundo: ${gameState.themeLore}. Inventario: ${gameState.inventory.join(', ')}.
    Genera una intro inmersiva (max 60 palabras). Presenta un conflicto inmediato. Pregunta qu√© hago.`;

    await processTurn(prompt, true, true);
  }

  function addMsg(role, text, img = null) {
    const div = document.createElement('div');
    div.className = `msg msg-${role}`;
    // Format
    let html = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>');
    div.innerHTML = html;
    if(img) {
      const image = document.createElement('img');
      image.src = img;
      image.className = "msg-img";
      image.loading = "lazy";
      image.onerror = function(){ this.style.display='none'; }; 
      div.appendChild(image);
    }
    document.getElementById('gameChat').appendChild(div);
    div.scrollIntoView({ behavior: 'smooth' });
    if(role === 'ai') playTone('message');
  }

  /* --- POLLINATIONS API HANDLER (FREE) --- */
  async function processTurn(userText, isSystemPrompt = false, generateImg = false) {
    const inputField = document.getElementById('playerInput');
    const sendBtn = document.getElementById('sendBtn');
    inputField.disabled = true; sendBtn.disabled = true;
    document.getElementById('typingIndicator').style.display = 'block';

    if(!isSystemPrompt) {
      addMsg('user', userText);
      gameState.history.push({ role: "user", content: userText });
    }

    // SYSTEM PROMPT
    const sysPrompt = `Eres un Game Master de Rol. Idioma: Espa√±ol.
    Reglas:
    1. Respuestas cortas (max 80 palabras).
    2. Usa 2da persona ("Ves...").
    3. Tags al inicio si aplica: [DA√ëO: N] (si pierdo vida), [ITEM: Nombre] (si obtengo algo), [XP: N] (si logro algo).
    4. Contexto: HP ${gameState.hp}/${gameState.maxHp}. Inventario: ${gameState.inventory.join(',')}.
    5. Nunca rompas el personaje.`;

    // Construct Messages for Pollinations (OpenAI style)
    const messages = [
        { role: "system", content: sysPrompt },
        ...gameState.history
    ];
    if(isSystemPrompt) {
        messages.push({ role: "user", content: userText });
        // Don't add system prompt to history to save context space, just the result
    }

    try {
      // 1. TEXT GENERATION (Pollinations.ai)
      // We use a POST request to their text endpoint
      const response = await fetch('https://text.pollinations.ai/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: messages,
          model: 'openai', // Pollinations proxies to best available
          seed: Math.floor(Math.random() * 1000) // Random seed for variety
        })
      });

      if (!response.ok) throw new Error('Pollinations API Busy');
      
      let aiText = await response.text(); // Pollinations often returns raw text
      
      // PROCESS GAME EVENTS
      aiText = parseEvents(aiText);
      gameState.history.push({ role: "assistant", content: aiText });

      // 2. IMAGE GENERATION (Pollinations.ai Image)
      // Pollinations images are generated via URL parameters, no fetch needed for base64
      let imgUrl = null;
      if (generateImg || Math.random() < 0.20) {
          // Clean text for prompt
          const cleanPrompt = aiText.replace(/\[.*?\]/g, '').substring(0, 100);
          const encodedPrompt = encodeURIComponent(`fantasy rpg art, ${gameState.theme} style, ${cleanPrompt}`);
          // Add random seed to avoid caching same image for similar prompts
          const seed = Math.floor(Math.random() * 10000);
          imgUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=512&height=300&nologo=true&seed=${seed}&model=flux`;
      }

      document.getElementById('typingIndicator').style.display = 'none';
      addMsg('ai', aiText, imgUrl);
      updateHUD();

    } catch(e) {
      console.error(e);
      document.getElementById('typingIndicator').style.display = 'none';
      // Retry logic or simple error
      addMsg('ai', `‚ö†Ô∏è <b>El Or√°culo est√° en silencio...</b> (Error de red o servicio saturado). Intenta de nuevo.`);
    }

    inputField.disabled = false; sendBtn.disabled = false;
    inputField.focus();
  }

  function parseEvents(text) {
    let cleanText = text;
    // Damage
    const dmgMatch = text.match(/\[DA√ëO:\s*(\d+)\]/i);
    if(dmgMatch) {
        const dmg = parseInt(dmgMatch[1]);
        gameState.hp = Math.max(0, gameState.hp - dmg);
        playTone('hit');
        document.body.classList.add('shake');
        setTimeout(()=>document.body.classList.remove('shake'), 500);
        cleanText = cleanText.replace(dmgMatch[0], '');
        showToast(`-${dmg} HP`, "error");
    }
    // XP
    const xpMatch = text.match(/\[XP:\s*(\d+)\]/i);
    if(xpMatch) {
        const xpGain = parseInt(xpMatch[1]);
        gameState.xp += xpGain;
        if(gameState.xp >= 100) {
            gameState.level++; gameState.xp = 0; gameState.maxHp += 10; gameState.hp = gameState.maxHp;
            playTone('levelup');
            showToast("¬°SUBIDA DE NIVEL!");
        } else {
            showToast(`+${xpGain} XP`);
        }
        cleanText = cleanText.replace(xpMatch[0], '');
    }
    // Items
    const itemMatch = text.match(/\[ITEM:\s*(.*?)\]/i);
    if(itemMatch) {
        const item = itemMatch[1].trim();
        gameState.inventory.push(item);
        playTone('start');
        cleanText = cleanText.replace(itemMatch[0], '');
        showToast(`Obtenido: ${item}`);
    }
    return cleanText.trim();
  }

  function submitAction() {
    playTone('click');
    const input = document.getElementById('playerInput');
    const val = input.value.trim();
    if(val) { processTurn(val); input.value = ""; }
  }

  function quickAction(act) {
    playTone('click');
    processTurn(act);
  }

  function updateHUD() {
    const hpPct = Math.max(0, (gameState.hp / gameState.maxHp) * 100);
    const xpPct = Math.min(100, (gameState.xp / 100) * 100);
    document.getElementById('hpBar').style.width = hpPct + "%";
    document.getElementById('xpBar').style.width = xpPct + "%";
    document.getElementById('hpVal').innerText = gameState.hp;
    document.getElementById('lvlVal').innerText = gameState.level;
    
    if(gameState.hp <= 0) {
        addMsg('ai', "üíÄ <b>HAS MUERTO.</b> Tu aventura termina aqu√≠.");
        document.getElementById('playerInput').disabled = true;
    }
  }

  function updateMenu() {
    document.getElementById('menuName').innerText = gameState.name;
    document.getElementById('menuClass').innerText = `${gameState.race} ${gameState.class}`;
    document.getElementById('menuXP').innerText = `${gameState.xp}/100`;
    
    const list = document.getElementById('inventoryList');
    list.innerHTML = "";
    if(gameState.inventory.length === 0) {
        list.innerHTML = '<div style="color:#666; font-style:italic; padding:5px;">Mochila vac√≠a</div>';
    } else {
        gameState.inventory.forEach(i => {
            const div = document.createElement('div');
            div.className = "inv-item";
            div.innerHTML = `üì¶ ${i}`;
            list.appendChild(div);
        });
    }
  }

  function saveGame() {
    localStorage.setItem('pocketRpgFree_v1', JSON.stringify(gameState));
    playTone('levelup');
    showToast("Juego Guardado");
    toggleModal('menuModal');
  }

  function resetGame() {
    localStorage.removeItem('pocketRpgFree_v1');
    location.reload();
  }

  window.onload = () => {
    updatePreview();
    const save = localStorage.getItem('pocketRpgFree_v1');
    if(save) {
        try {
            const loaded = JSON.parse(save);
            const btn = document.createElement('button');
            btn.className = 'big-btn';
            btn.style.background = 'var(--secondary)';
            btn.style.color = 'var(--bg-dark)';
            btn.style.marginTop = '10px';
            btn.innerHTML = `CONTINUAR: ${loaded.name} (Lvl ${loaded.level})`;
            btn.onclick = () => {
                gameState = loaded;
                document.getElementById('startScreen').style.display = 'none';
                
                // Restore emoji
                let foundEmoji = "üë§";
                // Simple restore logic
                const rKey = Object.keys(emojiMap).find(k => gameState.race.includes(k) || (emojiMap[k] === document.getElementById('hudAvatar').innerText)); 
                if(rKey) foundEmoji = emojiMap[rKey];
                for (const [key, val] of Object.entries(emojiMap)) {
                     if (gameState.race.toLowerCase().includes(key)) foundEmoji = val;
                }
                document.getElementById('hudAvatar').innerText = foundEmoji;

                updateHUD();
                addMsg('ai', `üìÇ *Bienvenido de vuelta, ${gameState.name}.*`);
            };
            const startBtn = document.querySelector('#startScreen .big-btn');
            startBtn.parentNode.insertBefore(btn, startBtn);
        } catch(e) { console.error("Save corrupted", e); }
    }
  };

  document.getElementById('playerInput').addEventListener("keypress", (e) => {
    if(e.key === "Enter") submitAction();
  });
</script>
</body>
</html>